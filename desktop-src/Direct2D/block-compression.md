---
title: Сжатие блоков
description: Описывает, как работает блочное сжатие и как его использовать в WIC и Direct2D.
ms.assetid: 52AF86A5-16E8-4AC8-BB67-CC2F1A3635B5
ms.topic: article
ms.date: 05/31/2018
ms.custom: seodec18
ms.openlocfilehash: aeb6ba9427a04f7a251a1d59062be508e4249b41
ms.sourcegitcommit: d75fc10b9f0825bbe5ce5045c90d4045e3c53243
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2021
ms.locfileid: "127164232"
---
# <a name="block-compression"></a>Сжатие блоков

начиная с Windows 8.1, Direct2D поддерживает несколько блочных сжатых форматов пикселей. кроме того, Windows 8.1 содержит Windows новый кодек (WIC) DDS, который позволяет загружать и хранить блочные сжатые изображения в формате файлов DDS. Блочное сжатие — это способ уменьшения объема графической памяти, используемой содержимым растрового изображения. С помощью блочного сжатия приложение может сократить потребление памяти и время загрузки для тех же образов разрешения. Или же приложение может использовать более или более высокое изображение разрешения, одновременно используя один и тот же объем памяти GPU.

сжатие блочных приложений было использовано приложениями Direct3D в течение длительного времени, а также с Windows 8.1 доступен для широкого и Direct2D разработчиков приложений.

В этом разделе описывается, как работает блочное сжатие и как его использовать в WIC и Direct2D.

## <a name="about-block-compression"></a>О блочном сжатии

[Блочное сжатие](/windows/desktop/direct3d10/d3d10-graphics-programming-guide-resources-block-compression) (BC) относится к классу методов сжатия для сокращения размеров текстур. Direct3D 11 поддерживает до 7 различных форматов BC в зависимости от уровня компонентов. в Windows 8.1 Direct2D предоставляет поддержку форматов BC1, BC2 и BC3, доступных на всех уровнях компонентов.

### <a name="how-block-compression-works"></a>Как работает блочное сжатие

При использовании блочных сжатых форматов используется одна и та же базовая методика для уменьшения пространства, занятого данными цвета. В этом разделе приведена сводка простейшего алгоритма BC1. Более подробное описание см. в разделе [блочное сжатие](/windows/desktop/direct3d11/texture-block-compression-in-direct3d-11).

Во-первых, изображение делится на блоки с 4 на 4 пикселя. Каждый блок сжимается отдельно.

> [!Note]  
> Это означает, что ширина и высота изображения должны быть кратными 4 пикселям, чтобы блокировать сжатие.

 

В этом примере изображения показан блок 4x4 пикселей в изображении.

![Пример изображения показывает блок пикселей 4x4 в изображении.](images/dds1.png)

Затем в блоке 4 на 4 выбираются два типа "ссылки", которые кодируются как 2 16 разрядных значений (5 бит красного, 6 бит зеленого, 5 бит синего цвета). Возможность выбора этих цветов существенно влияет на качество изображения и является нетривиальной. Два промежуточных цвета рассчитываются с помощью линейной интерполяции между двумя эталонными цветами в цветовом пространстве RGB. В результате получается 4 разных возможных цветов. каждому цвету присваивается значение двух битов индекса. Однако обратите внимание, что при фиксированной интерполяции необходимо сохранить только два цвета конечной точки.

На этом рисунке цвета 0 и 3 выделены как "справочные" цвета блока, а цвета 1 и 2 — с помощью линейной интерполяции.

![Схема, на которой показано вычисление 4 цветовых значений для представления блока.](images/dds2.png)

Наконец, каждый пиксель в блоке сопоставляется с одним из четырех ранее вычисленных цветов, и каждый пиксель кодируется с использованием двух битовых значений индекса.

Общий объем данных, используемых для представления этих 16 пикселей, составляет:

`16 bits [to define a reference color] * 2 + 2 bits * 16 [number of pixels]  = 64 bits`

Это приводит к среднему плотности в 4 бита на пиксель. Для сравнения, общий \_ \_ Формат B8G8R8A8 UNORM пикселей в формате DXGI \_ потребляет 32 бит на пиксель.

На этой схеме показано, что каждый пиксель кодируется как 2-разрядный индекс. Весь блок кодируется в 64 битах.

![Вычисление 4 значений цвета для представления блока.](images/dds3.png)

Существуют разновидности для поддержки альфа-данных и различных чисел цветовых каналов. BC6H и BC7 используют значительно разные алгоритмы для поддержки содержимого в динамическом диапазоне (HDR) и повышения качества изображения соответственно.

### <a name="directdraw-surface-dds-file-format"></a>Формат файла поверхности DirectDraw (DDS)

Блочные сжатые данные обычно хранятся в файлах [поверхности DirectDraw (DDS)](/windows/desktop/direct3ddds/dx-graphics-dds-reference) . Возможно, вы знакомы с файлами DDS, если вы являетесь разработчиком Direct3D. Обратите внимание, что Direct2D поддерживает только определенные функции DDS. Дополнительные сведения см. в разделе [требования к DDS](#dds-requirements).

### <a name="advantages-of-block-compression"></a>Преимущества блочного сжатия

Блокировать сжатые форматы отличаются от распространенных форматов сжатия отраслевых изображений, таких как JPEG в форматах BC, изначально поддерживается современными графическими процессорами. Это означает, что вы можете напрямую загрузить блочный сжатый образ на GPU без декодирования или распаковки. Форматы BC используют от 4 до 8 бит на пиксель в среднем; по сравнению с типичным несжатым точечным рисунком размером 32 бит на пиксель BGRA это приводит к экономии памяти с 75% до 87,5%. Кроме того, поскольку отсутствует шаг декодирования, время загрузки изображения BC значительно сокращается по сравнению с форматами, такими как JPEG.

### <a name="when-to-use-block-compression"></a>Когда следует использовать блочное сжатие

Следует рассмотреть возможность использования блочных сжатых изображений в приложении, а не других форматов, таких как JPEG, если требуется уменьшить использование памяти точечных рисунков или уменьшить время декодирования и загрузки.

Однако блочное сжатие не подходит для всех случаев и требует некоторых компромиссов. Во первых, алгоритмы сжатия блока теряются. Блочное сжатие хорошо работает с естественным фотоизображением, но может добавлять нежелательные визуальные артефакты в изображения с четкими, высококонтрастными границами, такими как снимки экрана, созданные на компьютере. Прежде чем использовать ресурсы блочного образа, убедитесь, что они имеют приемлемое качество изображения.

Во-вторых, блочные сжатые файлы DDS обычно потребляют больше места на диске, чем сравниваемые изображения JPEG. Это, в свою очередь, увеличит размер пакета приложения и требования к пропускной способности сети.

## <a name="using-block-compression"></a>Использование блочного сжатия

В этом разделе объясняется, как создавать и использовать блочные сжатые ресурсы в приложении Direct2D.

### <a name="overview"></a>Общие сведения

Блокировать сжатые файлы DDS — это оптимизированный для среды выполнения формат, что означает, что они оптимизированы для обеспечения хорошей производительности во время выполнения приложения. Рекомендуется продолжать использовать существующий конвейер создания и изменения ресурсов и преобразовывать его в сжатый формат без блокировки при импорте в проект приложения или во время сборки.

### <a name="dds-requirements"></a>Требования к DDS

Формат файлов DDS был разработан для поддержки широкого спектра функций, используемых в Direct3D. Direct2D использует только подмножество этих функций. Поэтому при создании образов DDS для использования с Direct2D необходимо иметь в виду следующие ограничения.

-   Допускаются только следующие значения [**\_ формата DXGI**](/windows/desktop/api/dxgiformat/ne-dxgiformat-dxgi_format) :
    -   \_Формат DXGI \_ BC1 \_ UNORM
    -   \_Формат DXGI \_ BC2 \_ UNORM
    -   \_Формат DXGI \_ BC3 \_ UNORM
-   Необходимо использовать предварительно умноженные альфа-данные. К ним относятся устаревшие файлы DDS с использованием форматов, явно определяющих предварительно умноженные альфа-каналы (DXT1, DXT2, DXT4), а также файлы DDS, которые используют \_ структуру заголовков содержимым DX10 в режиме альфа Alpha, \_ \_ \_ \_ непрозрачные и DDS в \_ режиме альфа Alpha \_ \_ .
-   Размеры X и Y должны быть кратны 4 пикселям.
-   Текстуры тома, кубемапс, MIP-карты или текстурные массивы не допускаются. Следует использовать только исходные изображения с одним кадром.

### <a name="generating-block-compressed-assets"></a>Создание блочных сжатых ресурсов

Существует множество средств разработки DDS, доступных для создания или преобразования блочных сжатых файлов DDS. Примечание. не все средства поддерживают требования к использованию файлов DDS с Direct2D, как описано в предыдущем разделе.

начиная с Visual Studio 2013 можно Visual Studio преобразовать существующие визуальные ресурсы, такие как JPEG и PNG, в правильный сжатый формат блока DDS в качестве автоматической части процесса сборки. Это достигается с помощью этапа настраиваемой сборки задачи содержимого изображения.

Сведения о том, как настроить это для проекта, см. в разделе [как экспортировать текстуру для использования с приложениями Direct2D или JavaScipt](/previous-versions/visualstudio/visual-studio-2013/dn392693(v=vs.120)).

### <a name="direct2d-apis"></a>API-интерфейсы Direct2D

Direct2D обновляется в Windows 8.1 для поддержки следующих форматов пикселей:

-   \_Формат DXGI \_ BC1 \_ UNORM
-   \_Формат DXGI \_ BC2 \_ UNORM
-   \_Формат DXGI \_ BC3 \_ UNORM

Для предыдущих форматов необходимо использовать предварительно умноженный альфа-канал. Кроме того, эти форматы допустимы только для использования в качестве источника, а не для целевого объекта. Например, это означает, что можно создать точечный рисунок Direct2D с помощью BC1, но не контекста устройства.

следующие методы обновляются в Windows 8.1 для поддержки форматов BC:

-   [**ID2D1DeviceContext:: Исдксгиформатсуппортед**](/windows/win32/api/d2d1_1/nf-d2d1_1-id2d1devicecontext-isdxgiformatsupported)
-   [**ID2D1DeviceContext:: Креатебитмап**](/windows/win32/api/d2d1_1/nf-d2d1_1-id2d1devicecontext-createbitmap(d2d1_size_u_constvoid_uint32_constd2d1_bitmap_properties1__id2d1bitmap1))
-   [**ID2D1DeviceContext:: Креатебитмапфромдксгисурфаце**](/windows/desktop/api/d2d1_1/nf-d2d1_1-id2d1devicecontext-createbitmapfromdxgisurface(idxgisurface_constd2d1_bitmap_properties1__id2d1bitmap1))
-   [**ID2D1RenderTarget:: Креатешаредбитмап**](/windows/win32/api/d2d1/nf-d2d1-id2d1rendertarget-createsharedbitmap)
-   [**ID2D1RenderTarget:: Креатебитмапфромвикбитмап**](id2d1rendertarget-createbitmapfromwicbitmap.md)
-   [**ID2D1Bitmap:: Копифроммемори**](/windows/win32/api/d2d1/nf-d2d1-id2d1bitmap-copyfrommemory)
-   [**ID2D1Bitmap:: Копифромбитмап**](/windows/win32/api/d2d1/nf-d2d1-id2d1bitmap-copyfrombitmap)
-   [**ID2D1Bitmap1::**](/windows/win32/api/d2d1_1/nf-d2d1_1-id2d1bitmap1-getsurface)

Обратите внимание, что [**креатебитмапфромвикбитмап**](id2d1devicecontext-createbitmapfromwicbitmap-overload.md) принимает [**IWICBitmapSource**](/windows/desktop/api/wincodec/nn-wincodec-iwicbitmapsource) в качестве интерфейса. однако в Windows 8.1 WIC не поддерживает получение блочных сжатых данных от **IWICBitmapSource**, и отсутствует формат пикселей WIC, соответствующий \_ формату DXGI \_ BC1 \_ UNORM и т. д. Вместо этого **креатебитмапфромвикбитмап** определяет, является ли **IWICBitmapSource** допустимым [**IWICBitmapFrameDecode**](/windows/desktop/api/wincodec/nn-wincodec-iwicbitmapframedecode) DDS, и напрямую загружает сжатые данные блока. Можно либо явно указать формат пикселей в структуре [**D2D1 \_ Bitmap \_ PROPERTIES1**](/windows/desktop/api/D2D1_1/ns-d2d1_1-d2d1_bitmap_properties1) , либо разрешить Direct2D автоматически определить правильный формат.

### <a name="windows-imaging-component-apis"></a>Windows API компонентов работы с образами

компонент Windows imaging (WIC) добавляет новый кодек DDS в Windows 8.1. Кроме того, он добавляет новые интерфейсы, поддерживающие доступ к данным DDS, включая блокирование сжатых данных пикселей.

-   [**ивикддсдекодер**](/windows/desktop/api/wincodec/nn-wincodec-iwicddsdecoder)
-   [**ивикддсенкодер**](/windows/desktop/api/wincodec/nn-wincodec-iwicddsencoder)
-   [**ивикддсфрамедекоде**](/windows/desktop/api/wincodec/nn-wincodec-iwicddsframedecode)

### <a name="block-compressed-wic-pixel-formats"></a>Блокировать сжатые форматы пикселей WIC

В Windows 8.1 нет новых сжатых форматов пикселей с блоком WIC. Вместо этого, если вы получаете [**IWICBitmapFrameDecode**](/windows/desktop/api/wincodec/nn-wincodec-iwicbitmapframedecode) из декодера DDS и вызовите [**CopyPixels**](/windows/desktop/api/wincodec/nf-wincodec-iwicbitmapsource-copypixels), вы получите стандартные несжатые Пиксели, такие как WICPixelFormat32bppPBGRA. [**Ивикддсфрамедекоде:: копиблоккс**](/windows/desktop/api/wincodec/nf-wincodec-iwicddsframedecode-copyblocks) можно использовать для получения необработанных блочных данных в виде буфера памяти из файла DDS.

### <a name="multi-frame-dds-access"></a>Доступ к DDS с несколькими кадрами

Формат файла DDS позволяет хранить несколько связанных образов в одном файле. Например, файл DDS может содержать кубической карты, текстуру тома или массив текстур, каждый из которых может быть мипмаппед. В Direct3D эти несколько образов предоставляются как подресурсы. В WIC несколько изображений предоставляются как кадры ([**IWICBitmapFrameDecode**](/windows/desktop/api/wincodec/nn-wincodec-iwicbitmapframedecode) и [**ивикбитмапфраминкоде**](/windows/desktop/api/wincodec/nn-wincodec-iwicbitmapframeencode)).

WIC поддерживает только понятие одномерного массива кадров, в то время как DDS поддерживает три независимых измерения (хотя в одном файле могут использоваться только два). WIC предоставляет удобные методы для помощи при сопоставлении между подресурсом DDS и фреймом WIC. Для декодирования [**ивикддсдекодер:: noframes**](/windows/desktop/api/wincodec/nf-wincodec-iwicddsdecoder-getframe) позволяет указать индекс массива, MIP уровень и Индекс среза для подресурса и возвращает правильный кадр WIC.

Для кодировки [**ивикддсенкодер:: CreateNewFrame**](/windows/desktop/api/wincodec/nf-wincodec-iwicddsencoder-createnewframe) выполняет вычисление результирующего индекса массива, уровня MIP и индекса среза при создании нового кадра. Чтобы определить параметры файла, относящиеся к DDS, необходимо сначала вызвать метод [**ивикддсенкодер:: SetParameters**](/windows/desktop/api/wincodec/nf-wincodec-iwicddsencoder-setparameters) .

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Практическое руководство. Экспорт текстуры для использования с приложениями Direct2D или Javascipt](/previous-versions/visualstudio/visual-studio-2013/dn392693(v=vs.120))
</dt> <dt>

[Справочник по DDS](/windows/desktop/direct3ddds/dx-graphics-dds-reference)
</dt> <dt>

[Блочное сжатие](/windows/desktop/direct3d10/d3d10-graphics-programming-guide-resources-block-compression)
</dt> </dl>

 

 