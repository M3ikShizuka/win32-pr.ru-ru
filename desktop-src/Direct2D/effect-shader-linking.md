---
title: Связывание шейдеров эффектов
description: Direct2D использует оптимизацию, называемую связыванием шейдера эффектов, которая сочетает визуализацию диаграммы с несколькими эффектыми, передавая один проход.
ms.assetid: 431A5B39-6C84-442D-AC66-0F341E10DF2C
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 608ae0b751840fc32b31e10012eb343c73ec3e0d941a26477a192b576204c247
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119431463"
---
# <a name="effect-shader-linking"></a>Связывание шейдеров эффектов

Direct2D использует оптимизацию, называемую связыванием шейдера эффектов, которая сочетает визуализацию диаграммы с несколькими эффектыми, передавая один проход.

-   [Общие сведения о связывании шейдера эффектов](#overview-of-effect-shader-linking)
-   [Использование связывания шейдера эффектов](#using-effect-shader-linking)
-   [Создание пользовательского действия, совместимого с шейдером](#authoring-a-shader-linking-compatible-custom-effect)
-   [Пример связывания. совместимый шейдер эффектов](#example-linking-compatible-effect-shader)
-   [Компиляция совместимого шейдера связывания](#compiling-a-linking-compatible-shader)
    -   [Шаг 1. компиляция функции экспорта](#step-1-compile-the-export-function)
    -   [Шаг 2. Компиляция полного шейдера и встраивание функции экспорта](#step-2-compile-the-full-shader-and-embed-the-export-function)
-   [Экспорт спецификаций функций](#export-function-specifications)
-   [Связанные темы](#related-topics)

## <a name="overview-of-effect-shader-linking"></a>Общие сведения о связывании шейдера эффектов

Оптимизация связывания с шейдером влияет на компоновку шейдера HLSL, функцию Direct3D 11,2, позволяющую создавать шейдеры пикселей и вершин во время выполнения путем связывания предварительно скомпилированных функций шейдера. На следующих рисунках показано понятие связывания шейдера эффектов в графе эффектов. На первой фигуре показана типичная диаграмма с Direct2Dным результатом с четырьмя преобразованиями отрисовки. Без связывания с шейдером каждое преобразование использует проход отрисовки и требует промежуточной поверхности; в итоге для этого графа требуется 4 прохода и 3 промежуточных уровня.

![Преобразование графа без связывания с шейдером: 4 прохода и 3 промежуточных.](images/shader-transform-graph.png)

На втором рисунке показана та же диаграмма влияния, в которой каждое преобразование отрисовки заменено на версию связываемой функции. Direct2D может связать весь граф и выполнить его за один проход, не требуя каких-либо промежуточных уровней. Это может привести к значительному снижению времени выполнения GPU и уменьшению пикового потребления памяти GPU.

![Преобразование графа с связыванием шейдера: 1 проход, промежуточный уровень 0.](images/shader-linking-graph.png)



 

Связывание шейдера эффектов работает с отдельными преобразованиями в пределах одного действия; Это означает, что даже граф с одним эффектом может выиграть от связывания шейдера, если этот эффект имеет несколько допустимых преобразований.

## <a name="using-effect-shader-linking"></a>Использование связывания шейдера эффектов

Если вы создаете приложение Direct2D, использующее эффекты, вам не нужно ничего делать, чтобы воспользоваться преимуществами связывания с шейдером эффектов. Direct2D автоматически анализирует диаграмму эффектов, чтобы определить наиболее оптимальный способ связывания каждого преобразования.

Авторы эффектов отвечают за реализацию их влияния на способ, который поддерживает связывание шейдера эффектов; Дополнительные сведения см. в разделе [Создание пользовательского действия, совместимого с шейдером](#authoring-a-shader-linking-compatible-custom-effect) , ниже. Все встроенные эффекты поддерживают связывание с шейдером.

Direct2D будет связывать только смежные преобразования отрисовки в ситуациях, где это полезно. При определении необходимости связывания двух преобразований учитывается несколько факторов. Например, связывание шейдера не выполняется, если в одном из преобразований используются вершины или шейдеры вычислений, так как могут быть связаны только шейдеры пикселей. Кроме того, если результат не был создан для совместимости с присоединением шейдера, то окружающие преобразования не будут связаны с ним.

Если такая опасность связи существует, Direct2D не будет связывать никакие преобразования, присмежные к опасности, но при этом будет пытаться связать оставшуюся часть графа.

![Граф преобразования со связью опасности: 2 прохода, 1 промежуточный.](images/shader-linking-graph-hazard.png)

## <a name="authoring-a-shader-linking-compatible-custom-effect"></a>Создание пользовательского действия, совместимого с шейдером

При создании собственного Direct2Dного действия необходимо убедиться, что его преобразования поддерживают связывание шейдеров эффектов. Это требует внесения некоторых незначительных изменений в реализацию предыдущих пользовательских эффектов. Если преобразование внутри пользовательского действия не поддерживает связывание с шейдером, Direct2D не будет связывать его с любыми преобразованиями, расположенными рядом с ним на графе эффектов.

Разработчик пользовательского действия должен иметь представление о нескольких ключевых понятиях и требованиях:

-   **Нет изменений в реализации интерфейса Effect**

    Нет необходимости изменять код, реализующий различные интерфейсы эффектов, например [ID2D1DrawTransform](/windows/win32/api/d2d1effectauthor/nn-d2d1effectauthor-id2d1drawtransform).

-   **Предоставьте полную и экспортируемую версию функции шейдеров**

    Необходимо указать версию функции экспорта для шейдеров эффектов, которые можно связать с помощью Direct2D. Кроме того, необходимо также продолжить предоставлять исходный, полный шейдер. Это обусловлено тем, что Direct2D выбирает в среде выполнения правую версию шейдера в зависимости от того, применяется ли связывание шейдера к определенной ссылке в графе.

    Если преобразование предоставляет только полный большой двоичный объект шейдера пикселей (через [ID2D1EffectContext:: лоадпикселшадер](/windows/win32/api/d2d1effectauthor/nf-d2d1effectauthor-id2d1effectcontext-loadpixelshader)), он не будет связан с смежными преобразованиями.

- **Вспомогательные функции**

    Direct2D предоставляет [вспомогательные функции](hlsl-helpers.md) и макросы HLSL, которые автоматически создают версии функций шейдера Full и Export. Эти вспомогательные методы можно найти в d2d1effecthelpers. hlsli. Кроме того, компилятор HLSL (FXC) позволяет вставить шейдер функции экспорта в закрытое поле в полном шейдере. Таким образом, достаточно создать шейдер только один раз и одновременно передать обе версии в Direct2D. в состав Windows SDK входит как d2d1effecthelpers. hlsli, так и компилятор FXC.

    Вспомогательные функции:

  - [D2DGetInput](d2dgetinput.md)  
  - [D2DSampleInput](d2dsampleinput.md)  
  - [D2DSampleInputAtOffset](d2dsampleinputatoffset.md)  
  - [D2DSampleInputAtPosition](d2dsampleinputatposition.md)  
  - [D2DGetInputCoordinate](d2dgetinputcoordinate.md)  
  - [D2DGetScenePosition](d2dgetsceneposition.md)  
  - [\_Запись D2D PS \_](d2d-ps-entry.md)  

  Можно также вручную создать две версии каждого шейдера и скомпилировать их дважды, при условии соблюдения описанных ниже спецификаций в [спецификациях функций экспорта](#export-function-specifications) .

-   **Только шейдеры пикселей**

    Direct2D не поддерживает связывание вычислений или шейдеров вершин. Однако если в результате используется шейдер вершин и пиксель, выходные данные шейдера пикселей по-прежнему могут быть связаны.

-   **Простая и сложная выборка**

    Связывание функций шейдера работает путем соединения выходных данных одного шейдера пикселей к входу последующего прохода шейдера пикселей. Это возможно только в том случае, если для выполнения вычислений для построителя текстуры требуется только одно входное значение. Обычно это значение будет получено из выборки текстуры ввода в координатах текстуры, порожденной шейдером вершин. Такой построитель текстуры называется простой выборкой.

    ![Преобразование в градациях серого является примером простой выборки. значение определенного выходного пикселя зависит только от значения соответствующего входного пикселя.](images/simple-sampling.png)

    Некоторые шейдеры пикселей, такие как размытие по Гауссу, вычисляют выходные данные из нескольких входных выборок, а не только для одного примера. Такой построитель текстуры называется выполнением сложной выборки.

    

    ![Пример сложной выборки — Размытие по Гауссу. значение центральной точки вывода зависит от нескольких входных пикселей.](images/complex-sampling.png)

    
    Входные данные, предоставляемые другой функцией шейдера, могут быть представлены только функциями шейдера с простыми входными данными. Функции шейдеров со сложными входными данными должны быть предоставлены с текстурой ввода для выборки. Это означает, что Direct2D не будет связывать шейдер со сложными входными данными для его предшественника.

    При использовании [вспомогательных функций DIRECT2D HLSL](hlsl-helpers.md)необходимо указать в HLSL, использует ли шейдер сложные или простые входы.

## <a name="example-linking-compatible-effect-shader"></a>Пример связывания. совместимый шейдер эффектов

С помощью вспомогательных функций D2D следующий фрагмент кода представляет простой совместимый с связыванием шейдер эффектов:

```syntax
#define D2D_INPUT_COUNT 1
#define D2D_INPUT0_SIMPLE
#include “d2d1effecthelpers.hlsli”

D2D_PS_ENTRY(LinkingCompatiblePixelShader)
{
    float4 input = D2DGetInput(0);
    input.rgb *= input.a;
    return input;
}          
```

В этом коротком примере обратите внимание, что не объявлены параметры функции, что число входов и типов каждого входного параметра объявляется перед функцией ввода, входные данные извлекаются путем вызова [D2DGetInput](d2dgetinput.md), а эти директивы препроцессора должны быть определены до включения вспомогательного файла.

Совместимый с связыванием шейдер должен предоставлять как обычный шейдер пикселей с одним проходом, так и функцию шейдера экспорта. Макрос [ \_ \_ записи D2D PS](d2d-ps-entry.md) позволяет создавать их из одного и того же кода при использовании в сочетании с скриптом компиляции шейдера.

При компиляции полного шейдера макросы разворачиваются в следующий код, имеющий входную подпись, совместимую с эффектами D2D.

```syntax
Texture2D<float4> InputTexture0;
SamplerState InputSampler0;

float4 LinkingCompatiblePixelShader(
    float4 pos   : SV_POSITION,
    float4 posScene : SCENE_POSITION,
    float4 uv0  : TEXCOORD0
    ) : SV_Target
    {
        float4 input = InputTexture0.Sample(InputSampler0, uv0.xy);
        input.rgb *= input.a;
        return input;
    }    
```

При компиляции версии функции экспорта одного и того же кода создается следующий код:

```syntax
// Shader function version
export float4 LinkingCompatiblePixelShader_Function(
    float4 input0 : INPUT0)
    {
        input.rgb *= input.a;
        return input;
    }      
```

Обратите внимание, что входные данные текстуры, обычно получаемые с помощью выборки Texture2D, заменены на входные функции (input0).

Чтобы просмотреть полное пошаговое описание действий, которые необходимо выполнить для написания совместимого с связью эффекта, см. [руководство по пользовательским эффектам](custom-effects.md) и [Пример пользовательских изображений Direct2D](https://github.com/microsoft/Windows-universal-samples/tree/master/Samples/D2DCustomEffects).

## <a name="compiling-a-linking-compatible-shader"></a>Компиляция совместимого шейдера связывания

Чтобы обеспечить возможность связи, большой двоичный объект шейдера пикселей, переданный в D2D, должен содержать как полные, так и экспортируемые версии функций шейдера. Это достигается путем встраивания скомпилированной функции экспорта в \_ \_ область частных данных D3D BLOB \_ .

Когда шейдеры создаются с помощью вспомогательных функций D2D, целевой объект компиляции D2D должен быть определен во время компиляции. Целевыми типами компиляции являются \_ полный \_ шейдер D2D и функция D2D \_ .

Компиляция построителя эффектов, совместимых с связыванием, состоит из двух этапов:

-   [Компиляция функции экспорта](#step-1-compile-the-export-function)
-   [Скомпилируйте полный шейдер и внедрите функцию экспорта](#step-2-compile-the-full-shader-and-embed-the-export-function)

> [!Note]  
> при компиляции действия с помощью Visual Studio необходимо создать пакетный файл, выполняющий обе команды FXC, и запустить этот пакетный файл в качестве настраиваемого этапа сборки, запускаемого до этапа компиляции.

 

### <a name="step-1-compile-the-export-function"></a>Шаг 1. компиляция функции экспорта

```syntax
fxc /T <shadermodel> <MyShaderFile>.hlsl /D D2D_FUNCTION /D D2D_ENTRY=<entry> /Fl <MyShaderFile>.fxlib           
```

Чтобы скомпилировать версию функции экспорта шейдера, необходимо передать следующие флаги в FXC.



|    Флаг                            |    Описание                       |
|--------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| /T <ShaderModel>         | Задайте <ShaderModel> соответствующий профиль шейдера пикселей, как определено в [синтаксисе FXC](/windows/desktop/direct3dtools/dx-graphics-tools-fxc-syntax). Это должен быть один из профилей, перечисленных в разделе "Связывание шейдера HLSL". |
| <MyShaderFile>. HLSL      | Задайте <MyShaderFile> для имя файла HLSL.                                                                                                                                                                                                    |
| /D D2D, \_ функция               | Это определение указывает FXC скомпилировать версию функции экспорта шейдера.                                                                                                                                                                       |
| /D \_ запись D2D =<entry>    | Задайте <entry> имя точки входа HLSL, которая была определена в макросе [ \_ \_ записи D2D PS](d2d-ps-entry.md) .                                                                                                                                    |
| /ФЛ <MyShaderFile> . фкслиб | Задайте в качестве значения, <MyShaderfile> где будет храниться версия функции экспорта шейдера. Обратите внимание, что расширение. фкслиб предназначено только для простоты идентификации.                                                                                              |

### <a name="step-2-compile-the-full-shader-and-embed-the-export-function"></a>Шаг 2. Компиляция полного шейдера и встраивание функции экспорта

```syntax
fxc /T ps_<shadermodel> <MyShaderFile>.hlsl /D D2D_FULL_SHADER /D D2D_ENTRY=<entry> /E <entry> /setprivate <MyShaderFile>.fxlib /Fo <MyShader>.cso /Fh <MyShader>.h           
```

Чтобы скомпилировать полную версию шейдера с внедренной версией экспорта, необходимо передать следующие флаги в FXC.



|    Флаг                                    |    Описание                     |
|----------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| /T <ShaderModel>                 | Задайте <ShaderModel> соответствующий профиль шейдера пикселей, как определено в [синтаксисе FXC](/windows/desktop/direct3dtools/dx-graphics-tools-fxc-syntax). Это должен быть профиль шейдера пикселей, соответствующий профилю связывания, указанному на шаге 1. |
| <MyShaderFile>. HLSL              | Задайте <MyShaderFile> для имя файла HLSL.                                                                                                                                                                                                                               |
| /D \_ полный \_ шейдер D2D                   | Это определение указывает FXC скомпилировать полную версию шейдера.                                                                                                                                                                                                             |
| /D \_ запись D2D =<entry>            | Задайте <entry> для параметра имя точки входа HLSL, которая была определена в \_ \_ макросе записи D2D PS ().                                                                                                                                                                                 |
| /E <entry>                       | Задайте <entry> для параметра имя точки входа HLSL, которая была определена в \_ \_ макросе записи D2D PS ().                                                                                                                                                                                 |
| /сетпривате <MyShaderFile> . фкслиб | Этот аргумент указывает FXC внедрить функцию экспорта шейдера, созданную на шаге 1, в \_ \_ область частных данных для BLOB-объекта D3D \_ .                                                                                                                                                          |
| /FO <MyShader> . cso               | Задайте <MyShader> для параметра значение, где нужно сохранить окончательный Объединенный Скомпилированный шейдер.                                                                                                                                                                                                 |
| /ФХ <MyShader> . h                 | Задайте <MyShader> для параметра значение, где вы хотите сохранить окончательный Объединенный заголовок.                                                                                                                                                                                                          |

## <a name="export-function-specifications"></a>Экспорт спецификаций функций

Возможно, не рекомендуется — создать совместимый шейдер эффектов без использования вспомогательных средств, предоставляемых преобразователем D2D. Необходимо соблюдать осторожность, чтобы убедиться, что все входные подписи функции шейдера и экспорта функций соответствуют спецификациям D2D.

спецификации для полных шейдеров те же, что и в предыдущих версиях Windows. Вкратце, входные параметры шейдера пикселей должны быть \_ ПОЛОЖЕНИЕМ SV, \_ позицией сцены и одним текскурд на входные данные.

Для функции экспорта функция должна возвращать float4, а ее входные данные должны быть одного из следующих типов:

-   Простой ввод

    ```syntax
    float4 d2d_inputN : INPUTN         
    ```

    Для простых входных данных D2D вставляет образец функции между текстурой ввода и функцией шейдера, либо входные данные будут предоставлены выходом другой функции шейдера.

-   Сложный ввод

    ```syntax
    float4 d2d_uvN  : TEXCOORDN                
    ```

    для сложных входов D2D будет передавать только координату текстуры, как описано в документации Windows 8.

-   Расположение выходных данных

    ```syntax
    float4 d2d_posScene : SCENE_POSITION                
    ```

    Можно определить только один ввод на одну \_ точку сцены. Этот параметр следует включать только при необходимости, так как только одна функция на связанный шейдер может использовать этот параметр.

Семантика должна быть определена как приведенная выше, так как D2D проверяет семантику, чтобы решить, как связать функции вместе. Если входные данные функции не соответствуют одному из перечисленных выше типов, функция будет отклонена для связывания с шейдером.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Вспомогательные методы HLSL](hlsl-helpers.md)
</dt> <dt>

[Интерфейс ID3D11Linker](/windows/desktop/api/d3d11shader/nn-d3d11shader-id3d11linker)
</dt> <dt>

[Интерфейс ID3D11FunctionLinkingGraph](/windows/desktop/api/d3d11shader/nn-d3d11shader-id3d11functionlinkinggraph)
</dt> </dl>

 

 