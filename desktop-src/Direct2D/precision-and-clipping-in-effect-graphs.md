---
title: Точность и числовое обрезание на диаграммах эффектов
description: Приложения, которые визуализируют эффекты с помощью Direct2D, должны обеспечивать требуемый уровень качества и предсказуемости относительно числовой точности.
ms.assetid: 6fd1d77f-e613-534f-3205-bad11fa24c30
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 24f2af6fdee4561caa60ea22a0c700593f2333727e6c5a63c5346fdc78bbdb40
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118160508"
---
# <a name="precision-and-numerical-clipping-in-effect-graphs"></a>Точность и числовое обрезание на диаграммах эффектов

Приложения, которые визуализируют эффекты с помощью Direct2D, должны обеспечивать требуемый уровень качества и предсказуемости относительно числовой точности. В этом разделе описываются рекомендации и соответствующие параметры в Direct2D, которые полезны в следующих случаях.

-   Диаграмма эффектов зависит от высокой числовой точности или цветов за пределами \[ диапазона 0, 1 \] , и вы хотите убедиться, что они всегда будут доступны.
-   Или диаграмма эффектов полагается на реализацию отрисовки для фиксации промежуточных цветов в \[ диапазоне 0, 1 \] , и вы хотите обеспечить постоянное выполнение этого события.

Direct2D часто делит диаграмму эффектов на разделы и визуализирует каждый раздел на отдельном шаге. Выходные данные некоторых шагов могут храниться в промежуточных текстурах Direct3D, которые по умолчанию имеют ограниченный числовой диапазон и точность. Direct2D не дает никаких гарантий относительно того, где используются эти промежуточные текстуры. это поведение может отличаться в зависимости от возможностей GPU, а также от Windows версий.

в Windows 10 Direct2D использует меньшее количество промежуточных текстур из-за использования связывания шейдеров. таким образом, Direct2D может давать разные результаты с параметрами по умолчанию, чем в предыдущих выпусках Windows. Это, в первую очередь, влияет на сценарии, в которых связывание шейдеров возможно в графе эффектов, и эта диаграмма также содержит эффекты, создающие выходные цвета расширенного диапазона.

## <a name="overview-of-effect-rendering-and-intermediates"></a>Общие сведения о визуализации эффектов и промежуточных уровнях

Чтобы отобразить диаграмму эффектов, Direct2D сначала находит базовый граф "преобразований", где преобразование — это узел графа, используемый в результате. Существуют различные типы преобразований, включая те, которые предоставляют Direct2Dные шейдеры Direct3D для использования.

Например, Direct2D может визуализировать диаграмму эффектов следующим образом:

![Диаграмма эффектов с промежуточными текстурами](images/precision-and-clipping-1.png)

Direct2D ищет возможности для сокращения числа промежуточных текстур, используемых для отрисовки диаграммы эффектов. Эта логика непрозрачна для приложений. Например, на следующем графе можно визуализировать Direct2D, используя один вызов прорисовки Direct3D и без промежуточных текстур:

![Диаграмма эффектов без промежуточных текстур](images/precision-and-clipping-2.png)

до Windows 10 Direct2D всегда использовал промежуточные текстуры, если в одной и той же диаграмме используется несколько пиксельных шейдеров. Большинство встроенных эффектов, которые просто настраивают цветовые значения (например, яркость или насыщенность), делают это с помощью шейдеров пикселей.

в Windows 10 Direct2D теперь может не использовать в таких случаях промежуточные текстуры. Это достигается путем внутренней связи смежных шейдеров пикселей. Пример:

![Диаграмма эффектов Windows 10 с несколькими шейдерами пикселей и без промежуточных текстур](images/precision-and-clipping-3.png)

Обратите внимание, что не все смежные шейдеры пикселей в графе могут быть связаны друг с другом, поэтому только некоторые графы будут давать разные выходные данные на Windows 10. Полные сведения см. в разделе [связывание шейдера эффектов](effect-shader-linking.md). Основные ограничения:

-   Эффект не будет связан с эффектами, использующими его выходные данные, если первый эффект соединен как входные данные для нескольких эффектов.
-   Результат не будет связан с набором эффектов в качестве входных данных, если первый из них выберет входные данные в другую логическую точку, чем результат. Например, Цветовая матрица может быть связана с входными данными, но результат свертки не будет.

## <a name="built-in-effect-behavior"></a>Поведение встроенных эффектов

Многие встроенные эффекты могут создавать цвета за пределами \[ диапазона 0, 1 \] в унпремултиплиед цветовом пространстве, даже если их входные цвета находятся в пределах этого диапазона. В этом случае такие цвета могут подвергаться числовому обрезку. Обратите внимание, что важно учитывать диапазон цветов в унпремултиплиед пространстве, несмотря на то, что встроенные эффекты обычно создают цвета в предварительно умноженном пространстве. Это гарантирует, что цвета останутся в пределах диапазона, даже если другие эффекты впоследствии унпремултипли их.

Некоторые эффекты, которые могут выдавать эти цвета вне диапазона, предлагают свойство "Клампаутпут". приведенные ниже.

-   [Матрица цветов](color-matrix.md)
-   [Арифметическое составное](arithmetic-composite.md)
-   [Convolve](convolve-matrix.md)
-   [Эффекты перемещения](built-in-effects.md)

Установка для свойства Клампаутпут значения TRUE для этих эффектов гарантирует единообразный результат, независимо от таких факторов, как связывание шейдера. Обратите внимание, что фиксация происходит в унпремултиплиед пространстве.

Другие встроенные эффекты также могут выдавать выходные цвета, превышающие \[ 0, 1 \] диапазон в унпремултиплиед пространстве, даже если их цвета пикселов (и свойства Color, если таковые имеются) находятся в пределах этого диапазона. приведенные ниже.

-   [Преобразование и масштабирование эффектов](built-in-effects.md) (если свойство режима интерполяции имеет кубический или высококачественный кубический уровень)
-   [Эффекты освещения](built-in-effects.md)
-   [Обнаружение границ](edge-detection-effect.md) (если свойство оверлея Edges имеет значение true)
-   [Крытия](exposure-effect.md)
-   [Составной](composite.md) (если свойство Mode имеет значение Plus)
-   [Температура и оттенок](temperature-and-tint-effect.md)
-   [Сепия](sepia-effect.md)
-   [Насыщенность](saturation.md)

## <a name="forcing-numerical-clipping-within-an-effect-graph"></a>Принудительное выполнение числовой обрезки в графе эффектов

При использовании описанных выше эффектов, не имеющих свойства Клампаутпут, приложения должны рассмотреть возможность принудительного выполнения числовых фиксаций. Это можно сделать, вставив дополнительный результат на диаграмму, которая замещает пикселы. Можно использовать цветовую матрицу, для которой свойство "Клампаутпут" имеет значение TRUE, а свойство "КолорМатрикс" в качестве значения по умолчанию (сквозной).

Вторым вариантом для достижения согласованных результатов является запрос на Direct2D использования промежуточных текстур, имеющих большую точность. Это действие описано ниже.

## <a name="controlling-precision-of-intermediate-textures"></a>Управление точностью промежуточных текстур

Direct2D предоставляет несколько способов управления точностью графа. Прежде чем использовать форматы высокой точности в Direct2D, приложения должны убедиться, что они поддерживаются GPU. Чтобы проверить это, используйте [**ID2D1DeviceContext:: исбуфферпреЦисионсуппортед**](/windows/win32/api/d2d1_1/nf-d2d1_1-id2d1devicecontext-isbufferprecisionsupported).

Приложения могут создать устройство Direct3D с помощью деформации (Эмуляция программного обеспечения), чтобы гарантировать, что все значения точности буфера поддерживаются независимо от фактического оборудования GPU на устройстве. Это рекомендуется в таких сценариях, как применение эффектов к фотографии при сохранении на диск. Даже если Direct2D поддерживает форматы буферов высокой точности на GPU, в этом сценарии рекомендуется использовать деформацию для графических процессоров уровня Feature 9. X, из-за ограниченной точности арифметических операций шейдера и выборки на некоторых графических процессорах с низким энергопотреблением.

В каждом из следующих случаев запрошенная точность фактически является минимальной точностью, используемой Direct2D. Если промежуточные версии не требуются, можно использовать более высокую точность. Direct2D также может совместно использовать промежуточные текстуры для различных частей одного графика или разных диаграмм. В этом случае Direct2D использует максимальную точность, запрошенную для всех вовлеченных операций.

### <a name="precision-selection-from-id2d1devicecontextsetrenderingcontrols"></a>Выбор точности из ID2D1DeviceContext:: Сетрендерингконтролс

Самым простым способом управления точностью Direct2D's промежуточных текстур является использование [**ID2D1DeviceContext:: сетрендерингконтролс**](/windows/win32/api/d2d1_1/nf-d2d1_1-id2d1devicecontext-setrenderingcontrols(constd2d1_rendering_controls)). Это позволяет управлять точностью всех промежуточных текстур, если точность не задается вручную для эффектов или преобразований напрямую.


```cpp
if (Device->IsBufferPrecisionSupported(D2D1_BUFFER_PRECISION_32BPC_FLOAT))
{
  // Get the current rendering controls
  D2D1_RENDERING_CONTROLS renderingControls = {};
  Context->GetRenderingControls(&renderingControls);

  // Switch the precision within the rendering controls and set it
  renderingControls.bufferPrecision = D2D1_BUFFER_PRECISION_32BPC_FLOAT;
  Context->SetRenderingControls(&renderingControls);
}
              
```



### <a name="precision-selection-from-inputs-and-render-targets"></a>Выбор точности из входных и выходных объектов

Приложения также могут полагаться на точность входных данных на графе эффектов, чтобы управлять точностью промежуточных текстур. Это справедливо, если точность буфера не указана с помощью [**ID2D1DeviceContext:: сетрендерингконтролс**](/windows/win32/api/d2d1_1/nf-d2d1_1-id2d1devicecontext-setrenderingcontrols(constd2d1_rendering_controls))и не задана вручную для эффектов и непосредственного преобразования.

Точность входных данных для эффектов распространяется через граф, чтобы выбрать точность нисходящих промежуточных уровней. При условии, что разные ветви на графе эффектов соответствуют, используется самая большая точность любого входного параметра.

Точность, выбранная на основе точечного рисунка Direct2D, определяется из его формата пикселей. Точность, выбранная для [**ID2D1ImageSource**](/windows/win32/api/d2d1_3/nn-d2d1_3-id2d1imagesource) , определяется из формата пикселей WIC базового IWICBitmapSource, используемого для создания **ID2D1ImageSource**. Обратите внимание, что Direct2D не позволяет создавать источники изображений с помощью источников WIC, используя точность, не поддерживаемую Direct2D и графическим процессором.

Возможно, Direct2D не может присвоить результат точности на основе его входных данных. Это происходит, когда у действия нет входных данных или если используется [**ID2D1CommandList**](/windows/win32/api/d2d1_1/nn-d2d1_1-id2d1commandlist) , для которого не определена точность. В этом случае точность промежуточных текстур определяется на основе набора битовых карт как текущего целевого объекта отрисовки контекста.

### <a name="precision-selection-directly-on-the-effect-and-transforms"></a>Точность выбора точности непосредственно в результате и преобразований

Минимальная точность для промежуточных текстур также может быть задана в явных расположениях на графе эффектов. Это рекомендуется только для сложных сценариев.

Минимальная точность может быть задана с помощью свойства в силе следующим образом:


```cpp
if (Device->IsBufferPrecisionSupported(D2D1_BUFFER_PRECISION_32BPC_FLOAT))
{
  hr = Effect->SetValue(D2D1_PROPERTY_PRECISION, D2D1_BUFFER_PRECISION_32BPC_FLOAT);
}
              
```



В реализации эффектов минимальная точность может быть задана с помощью ID2D1RenderInfo:: СетаутпутпреЦисион следующим образом:


```cpp
if (EffectContext->IsBufferPrecisionSupported(D2D1_BUFFER_PRECISION_32BPC_FLOAT))
{
  hr = RenderInfo->SetOutputBuffer(
  D2D1_BUFFER_PRECISION_32BPC_FLOAT,
  D2D1_CHANNEL_DEPTH_4);
}
              
```



Обратите внимание, что точность, заданная для эффекта, распространяется на нисходящие эффекты в той же диаграмме эффектов, если для этих побочных эффектов не задана другая точность. Точность, заданная для преобразования в пределах влияния, не влияет на точность для подчиненных узлов преобразования.

Ниже приведена полная рекурсивная логика, используемая для определения минимальной точности для промежуточного буфера, в котором хранятся выходные данные заданного узла преобразования.

![Логика минимальной точности промежуточного буфера](images/precision-and-clipping-4.png)

 

 