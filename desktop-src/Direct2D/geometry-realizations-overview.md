---
title: Обзор реализаций геометрии
description: В этом разделе описывается использование реализаций Direct2D Geometry для повышения производительности отрисовки геометрии приложения в определенных сценариях.
ms.assetid: E8C4C4E5-3102-4F53-847E-A4C2D12A6921
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5b903e047ee58a803a7584aaca407281fc803e30
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "105654315"
---
# <a name="geometry-realizations-overview"></a>Обзор реализаций геометрии

В этом разделе описывается использование реализаций [Direct2D](direct2d-portal.md) Geometry для повышения производительности отрисовки геометрии приложения в определенных сценариях.

Он содержит следующие подразделы:

-   [Что такое реализация геометрических объектов?](#what-are-geometry-realizations)
-   [Зачем использовать реализации геометрии?](#why-use-geometry-realizations)
-   [Когда следует использовать реализации геометрии](#when-to-use-geometry-realizations)
-   [Создание реализаций геометрии](#creating-geometry-realizations)
-   [Рисование реализаций геометрических объектов](#drawing-geometry-realizations)
-   [Масштабирование реализаций геометрических объектов](#scaling-geometry-realizations)
    -   [Использование реализаций Geometry в приложениях, которые не масштабируются](#using-geometry-realizations-in-apps-that-do-not-scale)
    -   [Использование реализаций геометрии в приложениях, которые масштабируются на небольшое количество](#using-geometry-realizations-in-apps-that-scale-by-a-small-amount)
    -   [Использование реализаций геометрических объектов в приложениях, масштабируемых по большому объему](#using-geometry-realizations-in-apps-that-scale-by-a-large-amount)
-   [См. также](#related-topics)

## <a name="what-are-geometry-realizations"></a>Что такое реализация геометрических объектов?

Реализации геометрических объектов, появившиеся в Windows 8.1, — это новый тип примитива рисования, который упрощает [Direct2D](direct2d-portal.md) приложений для повышения производительности отрисовки геометрии в определенных случаях. Реализации геометрических объектов представлены интерфейсом [**ID2D1GeometryRealization**](/windows/win32/api/d2d1_2/nn-d2d1_2-id2d1geometryrealization) .

## <a name="why-use-geometry-realizations"></a>Зачем использовать реализации геометрии?

Когда [Direct2D](direct2d-portal.md) визуализирует объект [**ID2D1Geometry**](/windows/win32/api/d2d1/nn-d2d1-id2d1geometry) , он должен преобразовать эту геометрию в форму, которую графическое оборудование понимает в процессе, именуемом тесселяцией. Как правило, Direct2D должен строить геометрию для каждого рисуемого кадра, даже если геометрия не изменяется. Если приложение отображает одинаковую геометрию каждого кадра, повторная тесселяция представляет ненужные вычислительные усилия. Более эффективным является вычисление для кэширования тесселяции или даже полной растрирования геометрии, а также отрисовку этого кэшированного представления каждого кадра вместо повторной тесселяции.

Обычным способом, который разработчики решает эту проблему, является кэширование полной растрирования геометрии. В частности, обычно создается новый точечный рисунок, растрирование геометрии к этому точечному рисунку, а затем при необходимости рисуется изображение в сцене. (Этот подход описан в разделе « [визуализация геометрии](improving-direct2d-performance.md) » статьи повышение производительности приложений Direct2D.) Хотя этот подход очень эффективен, он имеет ряд недостатков:

-   Кэшированный точечный рисунок чувствителен к изменениям в преобразовании, примененном к сцене. Например, масштабирование растрового изображения может привести к заметным артефактам масштабирования. Устранение этих артефактов с высококачественными алгоритмами масштабирования может быть дорогостоящим.
-   Кэшированный точечный рисунок потребляет значительный объем памяти, особенно если он является растровым при высоком разрешении.

Реализации геометрии предоставляют альтернативный способ кэширования геометрии, что позволяет избежать приведенных выше недостатков. Реализации геометрии представлены не в пикселях (как в случае с полной растрирования), а в виде точек на математической плоскости. По этой причине они менее чувствительны, чем полные средства растрирования для масштабирования и других манипуляций, и потребляют значительно меньше памяти.

## <a name="when-to-use-geometry-realizations"></a>Когда следует использовать реализации геометрии

Используйте реализации геометрии, когда приложение визуализирует сложные геометрические объекты, фигуры которых изменяются редко, но могут подвергаться изменениям преобразований.

Например, рассмотрим приложение сопоставления, которое показывает статическую карту, но позволяет пользователю увеличить или уменьшить масштаб. Это приложение может использовать преимущества применения геометрических объектов. Так как создаваемые геометрические объекты остаются статичными, полезно кэшировать их, чтобы сохранить работу тесселяции. Но поскольку карты масштабируются при увеличении масштаба пользователя, кэширование полной растрирования не идеально подходит из-за артефактов масштабирования. Кэширование геометрических объектов позволяет приложению избежать повторной тесселяции, сохраняя высокое качество визуального элемента во время масштабирования.

С другой стороны, рассмотрим приложение калеидоскопе с анимированной геометрией, которая постоянно изменяется. Это приложение, вероятно, не будет выгодно использовать реализации геометрических объектов. Так как фигуры меняются от Frame к кадру, не рекомендуется кэшировать их тесселяции. Лучший подход для этого приложения — нарисовать объекты [**ID2D1Geometry**](/windows/win32/api/d2d1/nn-d2d1-id2d1geometry) напрямую.

## <a name="creating-geometry-realizations"></a>Создание реализаций геометрии

Объект [**ID2D1GeometryRealization**](/windows/win32/api/d2d1_2/nn-d2d1_2-id2d1geometryrealization) должен быть создан из существующего объекта [**ID2D1Geometry**](/windows/win32/api/d2d1/nn-d2d1-id2d1geometry) . Чтобы создать реализацию геометрии, вызовите метод [**креатефилледжеометриреализатион**](/windows/win32/api/d2d1_2/nf-d2d1_2-id2d1devicecontext1-createfilledgeometryrealization) или [**креатестрокеджеометриреализатион**](/windows/win32/api/d2d1_2/nf-d2d1_2-id2d1devicecontext1-createstrokedgeometryrealization) и передайте **ID2D1Geometry** для реализации.

-   [**Креатефилледжеометриреализатион**](/windows/win32/api/d2d1_2/nf-d2d1_2-id2d1devicecontext1-createfilledgeometryrealization) создает реализацию внутренней части фигуры: регион, который будет нарисован вызовом [**филлжеометри**](/windows/win32/api/d2d1/nf-d2d1-id2d1rendertarget-fillgeometry).
-   [**Креатестрокеджеометриреализатион**](/windows/win32/api/d2d1_2/nf-d2d1_2-id2d1devicecontext1-createstrokedgeometryrealization) создает реализацию штриха фигуры: регион, который будет нарисован вызовом [**DrawGeometry**](/windows/win32/api/d2d1/nf-d2d1-id2d1rendertarget-drawgeometry).

Оба вида реализации геометрии представлены интерфейсом [**ID2D1GeometryRealization**](/windows/win32/api/d2d1_2/nn-d2d1_2-id2d1geometryrealization) .

При создании реализации геометрии [Direct2D](direct2d-portal.md) должен свести все кривые в предоставленной геометрии к приближениям к многоугольникам. Необходимо указать параметр отказоустойчивости для метода создания — это указывает максимальное расстояние в аппаратно-независимых пикселях между истинной кривой геометрии и ее аппроксимацией. Чем ниже предоставленная погрешность выравнивания, тем выше степень точности результирующего объекта реализации геометрии. Аналогично, если обеспечить более высокое допустимое отклонение, обеспечивается реализация геометрической геометрии. Обратите внимание, что реализация геометрической геометрии больше затрат на рисование, чем с низким уровнем точности, но их можно масштабировать еще до введения видимых артефактов. Рекомендации по использованию отклонения прозрачности см. в разделе [масштабирование реализаций геометрических объектов](#scaling-geometry-realizations) ниже.

> [!Note]  
> Объекты реализации геометрии связаны с определенным графическим устройством: это ресурсы, зависящие от устройства.

 

## <a name="drawing-geometry-realizations"></a>Рисование реализаций геометрических объектов

Реализация геометрических объектов аналогична рисованию других [Direct2D](direct2d-portal.md) примитивов, таких как точечные рисунки. Для этого вызовите метод [**дравжеометриреализатион**](/windows/win32/api/d2d1_2/nf-d2d1_2-id2d1devicecontext1-drawgeometryrealization) и передайте ему объект реализации Geometry для прорисовки и используемую кисть. Как и в случае с другими методами рисования Direct2D, необходимо вызывать **дравжеометриреализатион** между вызовами [**бегиндрав**](/windows/win32/api/d2d1/nf-d2d1-id2d1rendertarget-begindraw) и [**EndDraw**](/windows/win32/api/d2d1/nf-d2d1-id2d1rendertarget-enddraw).

## <a name="scaling-geometry-realizations"></a>Масштабирование реализаций геометрических объектов

Реализации геометрии, как и другие примитивы [Direct2D](direct2d-portal.md) , учитывают набор преобразований в контексте устройства. Несмотря на то, что преобразования перевода и вращения не влияют на визуальное качество реализаций геометрии, преобразования масштабирования могут создавать визуальные артефакты.

В частности, применение крупного масштаба к любой реализации геометрии может привести к отображению многоугольной аппроксимации истинных кривых. На рисунке ниже показана пара реализаций эллиптических геометрических объектов (заливка и штрих), которые были увеличены слишком далеко. Кривые — прозрачные артефакты видимы.

![пара реализаций эллиптических геометрических объектов (заливка и штрих), которые были увеличены слишком далеко. кривые — прозрачные артефакты видимы.](images/zoomed-in.png)

Приложения, имеющие конфиденциальные данные для визуального качества, должны принимать меры, чтобы убедиться, что это не происходит. Способ масштабирования зависит от потребностей приложения. Ниже приведены несколько рекомендуемых подходов для различных типов приложений.

### <a name="using-geometry-realizations-in-apps-that-do-not-scale"></a>Использование реализаций Geometry в приложениях, которые не масштабируются

Если приложение не выполняет масштабирование для реализаций геометрии, то можно быть уверенным в том, что только один раз создает реализации, используя один допуск для спрямления. (Преобразования без масштабирования не влияют на визуальное качество визуализированных реализаций геометрии.) Используйте функцию [**компутефлаттенингтолеранце**](/previous-versions/windows/desktop/legacy/dn280327(v=vs.85)) , чтобы вычислить соответствующую погрешность СПРЯМЛЕНИЯ для dpi:


```C++
    float dpiX, dpiY;
    deviceContext->GetDpi(&dpiX, &dpiY);

    float flatteningTolerance = D2D1::ComputeFlatteningTolerance(
        D2D1::Matrix3x2F::Identity(),   // apply no additional scaling transform
        dpiX,                           // horizontal DPI
        dpiY                            // vertical DPI
        );
```



### <a name="using-geometry-realizations-in-apps-that-scale-by-a-small-amount"></a>Использование реализаций геометрии в приложениях, которые масштабируются на небольшое количество

Если приложение может масштабировать геометрическую реализацию только по небольшому объему (например, до 2x или 3 раза), то может быть целесообразно создать реализацию геометрии только один раз, пропорционально отклонить погрешность выравнивания по умолчанию. Это создает реализацию более высокого качества, которая может быть значительно увеличена до создания артефактов масштабирования. компромисс заключается в том, что отрисовка реализации более высокого качества требует больше работы.

Например, предположим, что ваше приложение никогда не будет масштабировать реализацию геометрии более чем на 2 раза. Приложение может создать геометрическую форму, используя допуск для спрямления, который равен половине значения по умолчанию и просто масштабировать реализацию по мере необходимости, до 2x. Используйте функцию [**компутефлаттенингтолеранце**](/previous-versions/windows/desktop/legacy/dn280327(v=vs.85)) , чтобы вычислить соответствующую погрешность преобразования, передав 2,0 в качестве параметра *максзумфактор* :


```C++
    float dpiX, dpiY;
    deviceContext->GetDpi(&dpiX, &dpiY);
    
    float flatteningTolerance = D2D1::ComputeFlatteningTolerance(
        D2D1::Matrix3x2F::Identity(),   // apply no additional scaling transform
        dpiX,                           // horizontal DPI
        dpiY,                           // vertical DPI
        2.0f                            // realization can be scaled by an additional 2x
        );
```



### <a name="using-geometry-realizations-in-apps-that-scale-by-a-large-amount"></a>Использование реализаций геометрических объектов в приложениях, масштабируемых по большому объему

Если приложение может масштабировать геометрические объекты с помощью больших объемов (например, 10 раз или более), то обработка масштабирования будет более сложной.

Для большинства из этих приложений рекомендуется воссоздать реализацию геометрии при постепенном понижении отказоустойчивости при масштабировании сцены, чтобы обеспечить точность визуальных элементов и избежать артефактов масштабирования. Аналогично, по мере масштабирования сцены приложение должно повторно создавать реализации геометрических объектов при последовательном увеличении допустимых оттенков, чтобы избежать вастефуллиных сведений о отрисовке. Приложение не должно повторно создавать реализации геометрических объектов при каждом изменении масштаба, так как это не нарушает цель кэширования работы тесселяции. Вместо этого приложение должно повторно создавать реализации геометрии менее часто: например, после каждого увеличения или уменьшения масштаба.

Каждый раз, когда масштабирование изменяется в приложении в ответ на взаимодействие с пользователем, приложение может сравнить новый масштаб с масштабом, в котором они были созданы последними (например, в элементе **m \_ ластскале** ). Если два значения являются близкими (в данном случае — в пределах коэффициента 2), дальнейшие действия не предпринимаются. Но если эти два значения не закрыты, то реализации геометрии будут созданы повторно. Функция [**компутефлаттенингтолеранце**](/previous-versions/windows/desktop/legacy/dn280327(v=vs.85)) используется для расчета допуска прозрачности, соответствующего новому масштабу, а **m \_ ластскале** обновляется до новой шкалы.

Кроме того, приложение всегда создает реализации с меньшим отклонением, чем обычно используется для нового масштаба, передавая значение 2 в качестве параметра *максзумфактор* в [**компутефлаттенингтолеранце**](/previous-versions/windows/desktop/legacy/dn280327(v=vs.85)). Это позволяет масштабировать новые реализации геометрии по дополнительному коэффициенту 2 без дополнительных артефактов масштабирования.

> [!Note]  
> Описанный здесь подход может оказаться непригодным для всех приложений. Например, если приложение позволяет очень быстро масштабировать сцену с помощью очень больших факторов (например, если она содержит ползунок "Масштаб", который можно переместить с 100% на 1 000 000% в диапазоне нескольких кадров), то этот подход может привести к чрезмерной работе путем повторного создания геометрического объекта. В качестве альтернативного подхода можно создать повторное создание геометрии только после завершения каждой манипуляции шкалы сцены (например, после завершения пользователем жеста сжатия).

 

## <a name="related-topics"></a>См. также

[Обзор геометрий](direct2d-geometries-overview.md)

[Повышение производительности приложений Direct2D](improving-direct2d-performance.md)

[Общие рекомендации по визуализации сложного статического содержимого](improving-direct2d-performance.md)

[**ID2D1DeviceContext1**](/windows/win32/api/d2d1_2/nn-d2d1_2-id2d1devicecontext1)

[**ID2D1GeometryRealization**](/windows/win32/api/d2d1_2/nn-d2d1_2-id2d1geometryrealization)

[**Функция Компутефлаттенингтолеранце**](/previous-versions/windows/desktop/legacy/dn280327(v=vs.85))