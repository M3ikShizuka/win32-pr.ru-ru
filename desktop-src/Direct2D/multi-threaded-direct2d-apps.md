---
title: Многопоточные приложения Direct2D
description: Описывает рекомендации по созданию многопоточных приложений Direct2D.
ms.assetid: FDD770D4-817F-44D9-86C4-15DD04D214AE
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6be979b867edd6d36583959c4a595dbd507ca94f
ms.sourcegitcommit: c3243ec4ada05b7faf9d563853cb667ecef825e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/03/2020
ms.locfileid: "103797244"
---
# <a name="multithreaded-direct2d-apps"></a>Многопоточные приложения Direct2D

При разработке приложений [Direct2D](./direct2d-portal.md) может потребоваться доступ к ресурсам Direct2D из нескольких потоков. В других случаях может потребоваться использовать многопоточность для повышения производительности или более эффективного реагирования (например, использование одного потока для отображения экрана и отдельного потока для автономной подготовки).

В этом разделе описаны рекомендации по разработке многопоточных приложений [Direct2D](./direct2d-portal.md) с небольшим числом визуализаций [Direct3D](/windows/desktop/direct3d11/atoc-dx-graphics-direct3d-11) . Проблемы с программным обеспечением, вызванные проблемами параллелизма, могут быть трудно отслеживать, и полезно спланировать политику многопоточности и следовать рекомендациям, описанным здесь.

> [!Note]  
> При доступе к двум [Direct2D](./direct2d-portal.md) ресурсам, созданным из двух различных однопотоковых Direct2D фабрик, они не вызывают конфликтов доступа, если базовые устройства и контексты устройств [Direct3D](/windows/desktop/direct3d11/atoc-dx-graphics-direct3d-11) также отличаются. Обсуждение «доступ к ресурсам Direct2D» в этой статье означает «доступ к ресурсам Direct2D, созданным с того же Direct2D устройства», если не указано иное.

## <a name="developing-thread-safe-apps-that-call-only-direct2d-apis"></a>Разработка Thread-Safe приложений, вызывающих только API Direct2D

Можно создать многопотоковый экземпляр фабрики [Direct2D](./direct2d-portal.md) . Можно использовать и совместно использовать многопотоковую фабрику и все ее ресурсы из нескольких потоков, но доступ к этим ресурсам (через вызовы Direct2D) сериализуется Direct2D, поэтому конфликты доступа не возникают. Если приложение вызывает только API Direct2D, такая защита автоматически выполняется Direct2D на детализированном уровне с минимальными издержками. Код для создания многопоточной фабрики здесь.

```cpp
ID2D1Factory* m_D2DFactory;

// Create a Direct2D factory.
HRESULT hr = D2D1CreateFactory(
    D2D1_FACTORY_TYPE_MULTI_THREADED,
    &m_D2DFactory
);
```

На рисунке показано, как [Direct2D](./direct2d-portal.md) сериализует два потока, которые выполняют вызовы, используя только API Direct2D.

![схема двух сериализованных потоков.](images/multi-thread.png)

## <a name="developing-thread-safe-direct2d-apps-with-minimal-direct3d-or-dxgi-calls"></a>Разработка приложений Thread-Safe Direct2D с минимальными вызовами Direct3D или DXGI

Это более частое, что [Direct2D](./direct2d-portal.md) приложение также делает вызовы [Direct3D](/windows/desktop/direct3d11/atoc-dx-graphics-direct3d-11) или DXGI. Например, поток отображения будет нарисован в Direct2D с помощью [**цепочки подкачки DXGI**](/windows/desktop/api/dxgi/nn-dxgi-idxgiswapchain).

В этом случае обеспечивается более сложная безопасность потоков: некоторые [Direct2D](./direct2d-portal.md) вызовы косвенно обращаются к базовым ресурсам [Direct3D](/windows/desktop/direct3d11/atoc-dx-graphics-direct3d-11) , которые могут быть одновременно доступны другому потоку, который вызывает Direct3D или DXGI. Так как вызовы Direct3D или DXGI не Direct2D's осведомленности и управления, необходимо создать многопоточность Direct2D, но необходимо выполнить Mor, чтобы избежать конфликтов доступа.

На схеме здесь показан конфликт доступа к ресурсам [Direct3D](/windows/desktop/direct3d11/atoc-dx-graphics-direct3d-11) из-за того, что поток T0 доступ к ресурсу опосредованно через вызов [Direct2D](./direct2d-portal.md) и T2 обращается к тому же ресурсу напрямую через вызов Direct3D или DXGI.

> [!Note]  
> Защита потоков, предоставляемая [Direct2D](./direct2d-portal.md) (синяя блокировка в этом изображении), не помогает в этом случае.

 

![Схема защиты потоков.](images/multi-thread2.png)

Чтобы избежать конфликта доступа к ресурсам, мы рекомендуем явно получить блокировку, которую [Direct2D](./direct2d-portal.md) использует для внутренней синхронизации доступа, и применить эту блокировку, когда потоку необходимо сделать вызовы [Direct3D](/windows/desktop/direct3d11/atoc-dx-graphics-direct3d-11) или DXGI, которые могут вызвать конфликт доступа, как показано ниже. В частности, следует уделять особое внимание коду, который использует исключения или систему на ранних этапах, основанную на кодах возврата HRESULT. По этой причине мы рекомендуем использовать шаблон RAII (получение ресурсов — инициализация) для вызова методов [**Enter**](/windows/win32/api/d2d1_1/nf-d2d1_1-id2d1multithread-enter) и [**Leave**](/windows/win32/api/d2d1_1/nf-d2d1_1-id2d1multithread-leave) .

> [!Note]  
> Важно связать вызовы методов [**Enter**](/windows/win32/api/d2d1_1/nf-d2d1_1-id2d1multithread-enter) и Leave, в противном случае ваше приложение может [**привести**](/windows/win32/api/d2d1_1/nf-d2d1_1-id2d1multithread-leave) к взаимоблокировке.

 

В этом примере кода показан пример блокировки и последующего разблокирования вызовов [Direct3D](/windows/desktop/direct3d11/atoc-dx-graphics-direct3d-11) или DXGI.


```C++
void MyApp::DrawFromThread2()
{
    // We are accessing Direct3D resources directly without Direct2D's knowledge, so we
    // must manually acquire and apply the Direct2D factory lock.
    ID2D1Multithread* m_D2DMultithread;
    m_D2DFactory->QueryInterface(IID_PPV_ARGS(&m_D2DMultithread));
    m_D2DMultithread->Enter();
    
    // Now it is safe to make Direct3D/DXGI calls, such as IDXGISwapChain::Present
    MakeDirect3DCalls();

    // It is absolutely critical that the factory lock be released upon
    // exiting this function, or else any consequent Direct2D calls will be blocked.
    m_D2DMultithread->Leave();
}
```



> [!Note]  
> Некоторые вызовы [Direct3D](/windows/desktop/direct3d11/atoc-dx-graphics-direct3d-11) или DXGI (особенно [**идксгисвапчаин::P**](/windows/desktop/api/dxgi/nf-dxgi-idxgiswapchain-present)повторной отправки) могут получать блокировки и (или) вызывать обратные вызовы в код вызывающей функции или метода. Следует помнить об этом и убедиться, что такое поведение не вызывает взаимоблокировок. Дополнительные сведения см. в статье [Обзор DXGI](/windows/desktop/direct3ddxgi/d3d10-graphics-programming-guide-dxgi) .

 

![Схема блокировки потоков Direct2D и Direct3D.](images/multi-thread3.png)

При использовании методов [**Enter**](/windows/win32/api/d2d1_1/nf-d2d1_1-id2d1multithread-enter) и [**Leave**](/windows/win32/api/d2d1_1/nf-d2d1_1-id2d1multithread-leave) вызовы защищаются автоматическим [Direct2D](./direct2d-portal.md) и явной блокировкой, поэтому приложение не получает конфликт доступа.

Существуют и другие подходы для решения этой проблемы. Тем не менее рекомендуется явно защищать вызовы [Direct3D](/windows/desktop/direct3d11/atoc-dx-graphics-direct3d-11) или DXGI с блокировкой [Direct2D](./direct2d-portal.md) , так как обычно обеспечивает лучшую производительность, так как она защищает параллелизм на гораздо более низком уровне и с меньшими затратами в рамках Direct2D'sного покрытия.

## <a name="ensuring-atomicity-of-stateful-operations"></a>Обеспечение атомарности операций с отслеживанием состояния

Хотя функции обеспечения безопасности потоков [DirectX](/previous-versions//ee663301(v=vs.85)) позволяют гарантировать, что никакие два отдельных вызова API не будут выполняться параллельно, необходимо также убедиться, что потоки, выполняющие вызовы API с отслеживанием состояния, не мешают друг другу. Ниже приведен пример.

1.  Есть две строки текста, которые необходимо визуализировать как на экране (потоком 0), так и в режиме «вне экрана» (потоком 1): строка \# 1 имеет значение «а больше», а строка \# 2 — «, чем», то оба они будут выведены с помощью сплошной черной кисти.
2.  Поток 1 рисует первую строку текста.
3.  Поток 0 реагирует на введенные пользователем данные, обновляет обе строки как «B меньше» и «чем» соответственно, и изменяет цвет кисти на сплошной красный для собственного рисования.
4.  Поток 1 продолжит рисование второй строки текста, которая теперь "отличается от", с помощью кисти красного цвета.
5.  Наконец, мы получаем две строки текста на экранной цели: «а больше» — черный, «а» — «красный».

![Схема потоковых потоков на экране.](images/multi-thread4.png)

В верхней строке поток 0 рисуется с текущими текстовыми строками и текущей черной кистью. Поток 1 завершает только прорисовку на экране в верхней половине.

В средней строке поток 0 реагирует на взаимодействие с пользователем, обновляет текстовые строки и кисть, а затем обновляет экран. На этом этапе поток 1 заблокирован. В нижней строке окончательной отрисовкой после завершения потока 1 начинается рисование нижней половины с измененной кистью и измененной текстовой строкой.

Для решения этой проблемы рекомендуется иметь отдельный контекст для каждого потока, чтобы:

-   Следует создать копию контекста устройства, чтобы изменяющиеся ресурсы (т. е. ресурсы, которые могут изменяться при отображении или печати, такие как текстовое содержимое или Кисть сплошного цвета в примере) не изменялись при подготовке к просмотру. В этом примере необходимо сохранить копию этих двух строк текста и цветовую кисть перед началом рисования. Это гарантирует, что каждый поток будет иметь полное и согласованное содержимое для прорисовки и представления.
-   Вы должны предоставлять общий доступ к большим ресурсам (например, точечным рисункам и диаграммам сложных эффектов), которые инициализируются один раз, а затем никогда не изменяются в потоках для повышения производительности.
-   Можно совместно использовать ресурсы с низкой плотностью (например, сплошные цветные кисти и текстовые форматы), которые инициализируются один раз, а затем никогда не изменяются в потоках.

## <a name="summary"></a>Сводка

При разработке многопоточных приложений [Direct2D](./direct2d-portal.md) необходимо создать многопоточную фабрику Direct2D, а затем наследовать все ресурсы Direct2D от этой фабрики. Если поток будет выполнять вызовы [Direct3D](/windows/desktop/direct3d11/atoc-dx-graphics-direct3d-11) или DXGI, необходимо также явно получить и применить блокировку Direct2D, чтобы защитить вызовы Direct3D или DXGI. Кроме того, необходимо обеспечить целостность контекста, используя копию изменяемых ресурсов для каждого потока.
