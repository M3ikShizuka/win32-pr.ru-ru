---
description: При использовании функции автопрокси WinHTTP необходимо учитывать следующие важные моменты.
ms.assetid: 9bae89b7-8f54-42ec-a240-998c97e26d25
title: Проблемы с автопрокси в WinHTTP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: cc07ca7320fee028431ff0d89be78ee0b2dc4bb63e8191386808f0936c8a1518
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119052092"
---
# <a name="autoproxy-issues-in-winhttp"></a>Проблемы с автопрокси в WinHTTP

При использовании функции автопрокси WinHTTP необходимо учитывать следующие важные моменты.

## <a name="only-one-proxy-server-is-currently-supported"></a>В настоящее время поддерживается только один прокси-сервер

В настоящее время WinHTTP не поддерживает конфигурации прокси-серверов, задающих более одного прокси-сервера. Если [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) возвращает структуру [**\_ \_ сведений о прокси-сервере WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info) , содержащую список прокси-серверов, которые затем задаются приложением в обработчике запросов с помощью параметра **\_ \_ прокси-сервера параметра WinHTTP** , WinHTTP использует только первый прокси-сервер из списка. Если этот прокси-сервер недоступен, служба WinHTTP не выполняет отработку отказа на другие прокси-серверы в списке. Чтобы это сделать, в приложении необходимо снова задать параметр **\_ \_ прокси-сервера для параметра WinHTTP** , а затем повторно отправить запрос.

## <a name="security-risk-mitigation"></a>Устранение рисков безопасности

Для обработки файла автоматической конфигурации прокси-сервера требуется выполнение скачанного кода скрипта. Некоторые проблемы безопасности, которые следует учитывать: Если сервер, на котором находится файл PAC, был скомпрометирован, код сценария PAC может быть вредоносным. Таким образом, WinHTTP использует следующие меры предосторожности для защиты клиента:

1.  коду сценария запрещено создавать экземпляры объектов ActiveX. Это блокирует множество потенциально опасных функций, таких как возможность доступа к файлам и выполнения сетевых операций ввода-вывода.
2.  * * Windows Server 2003: * *[**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) делегирует всю обработку WPAD внешней службе, службе автоматического обнаружения веб-прокси WinHTTP, которая выполняется под встроенной учетной записью пользователя локальной службы с низким уровнем привилегий.

3.  **Windows XP с пакетом обновления 2 (SP2) и Windows Server 2003:** Выполнение скрипта PAC не разрешено дольше 60 секунд, после чего выполнение скрипта прерывается.

4.  **Windows XP с пакетом обновления 2 (SP2) и Windows Server 2003:** WinHTTP отклоняет файлы PAC, размер которых превышает 1 МБ. Обычно используется файл PAC, размер которого не превышает нескольких килобайт.

имейте в виду, что обработка кода сценария PAC требует использования COM, так как WinHTTP использует компонент Microsoft JScript для выполнения скрипта. Если служба WinHTTP не может делегировать обработку протокола WPAD во внешнюю службу автоматического обнаружения веб-прокси, [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) загружает среду выполнения COM в рамках процесса приложения на время вызова. Если само приложение уже использует COM, это не должно быть проблемой.

## <a name="performance-considerations"></a>Вопросы производительности

Процесс автоматического обнаружения может выполняться медленно, возможно, до нескольких секунд. Функции [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) и [винхттпдетектаутопроксиконфигурл](/windows/desktop/api/Winhttp/nf-winhttp-winhttpdetectautoproxyconfigurl) блокируют синхронные функции. Это может быть то, что один конкретный механизм автоматического обнаружения (например, DHCP) работает намного медленнее, чем другой (например, DNS). Если для **\_ автоматического обнаружения WinHTTP \_ \_ типа \_ DHCP** и **WinHTTP \_ автоматически \_ обнаруживается \_ тип \_ DNS, \_ то** службы WinHTTP сначала используют DHCP в соответствии со спецификацией WPAD. Если URL-адрес PAC не обнаружен с помощью запроса DHCP, служба WinHTTP пытается найти файл PAC по известному DNS-адресу.

[**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) использует параметр обработки сеанса WinHTTP для кэширования файла PAC и результатов автоматического обнаружения. Лучше использовать один и тот же обработчик сеанса для нескольких вызовов **WinHttpGetProxyForUrl** , если это возможно, чтобы избежать повторного обнаружения URL-адресов PAC и загрузки файлов. Файл PAC кэшируется только в памяти и отбрасывается, когда приложение закрывает обработчик сеанса.

Из-за влияния автопрокси на производительность рекомендуется, чтобы только клиентские приложения или службы настольных компьютеров использовали эту функцию. серверные приложения должны полагаться на администратора сервера с помощью служебной программы "ProxyCfg.exe".

 

 



