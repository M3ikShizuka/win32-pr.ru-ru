---
description: службы Microsoft Windows HTTP (WinHTTP) полностью поддерживают использование Microsoft Passport протокола проверки подлинности на стороне клиента. В этом разделе приводятся общие сведения о транзакциях, участвующих в проверке подлинности паспорта, и способах их решения.
ms.assetid: 395d7aef-4da0-4664-8328-7d31ce58fedd
title: Проверка подлинности Passport в WinHTTP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f69d6aff7f8924c307d4e21efb77bc57ebae2469e50361b57d12dce5b348555e
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118114320"
---
# <a name="passport-authentication-in-winhttp"></a>Проверка подлинности Passport в WinHTTP

службы Microsoft Windows HTTP (WinHTTP) полностью поддерживают использование Microsoft Passport протокола проверки подлинности на стороне клиента. В этом разделе приводятся общие сведения о транзакциях, участвующих в проверке подлинности паспорта, и способах их решения.

> [!Note]  
> В WinHTTP 5,1 Проверка подлинности по паспорту отключена по умолчанию.

 

## <a name="passport-14"></a>Паспорт 1,4

Passport является основным компонентом Microsoft .NET стандартных блочных служб. Она позволяет компаниям разрабатывать и предлагать распределенные веб-службы в широком спектре приложений, а также позволяет своим участникам использовать одно имя входа и пароль на всех участвующих веб-сайтах.

WinHTTP обеспечивает поддержку платформы для Microsoft Passport 1,4, реализуя клиентский протокол для проверки подлинности Passport 1,4. он освобождает приложения от сведений о взаимодействии с инфраструктурой Passport, а также о сохраненных именах пользователей и паролях в Windows XP. Эта абстракция делает использование паспорта не отличается от перспективы разработчика, чем использование традиционных схем проверки подлинности, таких как Basic или Digest.

**Windows XP:** раздел **HKCU \\ Software \\ Microsoft \\ Windows \\ CurrentVersion \\ Internet Параметры \\ Passport \\ нумрегистратионрунс** registry определяет, сколько раз мастер проверки подлинности passport отображается при необходимости проверки подлинности passport. Если для этого параметра задано число больше 5, мастер не отображается.

В следующих разделах описываются транзакции, вовлеченные в проверку подлинности Passport с точки зрения клиентского приложения. Сведения о разработке паспортов на стороне сервера см. в документации по пакету SDK для Passport.

-   [Первоначальный запрос](#initial-request)
-   [Сервер входа Passport](#passport-login-server)
-   [Проверенный запрос](#authenticated-request)

### <a name="initial-request"></a>Первоначальный запрос

Когда клиент запрашивает ресурс на сервере, для которого требуется проверка подлинности Passport, сервер проверяет запрос на наличие [*билетов*](glossary.md). Если с запросом отправляется допустимый *билет* , сервер отвечает запрошенному ресурсу. Если *билет* не существует на клиенте, сервер отвечает кодом состояния 302. Ответ включает заголовок запроса "WWW-Authenticate: Passport 1.4". Клиенты, не использующие Passport, могут следовать перенаправлению на сервер входа Passport. Более сложные клиенты обычно подключаются к своему хранилище Passport, чтобы определить расположение сервера входа Passport.

> [!Note]  
> Центральной частью Microsoft Passport сети является хранилище Passport, которое упрощает синхронизацию узлов- *участников паспорта,* чтобы убедиться в том, что каждый сайт имеет последние сведения о конфигурации сети и других проблемах. Каждый компонент паспорта (Диспетчер паспортов, серверы входа, серверы обновлений и т. д.) периодически обменивается данными с хранилищами для получения сведений, необходимых для поиска и правильной связи с другими компонентами в сети Passport. Эти сведения извлекаются в виде XML-документа, который называется документом конфигурации компонента или ККД.

 

На следующем рисунке показан первоначальный запрос к дочерней службе Passport.

![на рисунке показан первоначальный запрос к дочернему службе Passport.](images/art-passport1.png)

### <a name="passport-login-server"></a>Сервер входа Passport

Сервер входа Passport обрабатывает все запросы на [*билеты*](glossary.md) для любого ресурса в *доменном центре* Passport. Перед проверкой подлинности запроса с помощью Passport клиентское приложение должно обратиться к серверу входа, чтобы получить соответствующие *билеты*.

Когда клиент запрашивает [*билеты*](glossary.md) с сервера входа Passport, сервер входа обычно отвечает на код состояния 401, чтобы указать, что необходимо предоставить учетные данные пользователя. При указании этих учетных данных сервер входа отвечает с *билетами* , необходимыми для доступа к указанному ресурсу на сервере, содержащем изначально запрошенный ресурс. Сервер входа также может перенаправить клиент на другой сервер, который может предоставить запрошенный ресурс.

![на рисунке показан запрос клиентского билета к серверу входа Passport.](images/art-passport2.png)

### <a name="authenticated-request"></a>Проверенный запрос

Если у клиента есть [*билеты*](glossary.md) , соответствующие заданному серверу, эти *билеты* включаются во все запросы к этому серверу. Если эти *билеты* не изменялись с момента получения с сервера входа в систему Passport, а *билеты* действительны для сервера ресурсов, сервер ресурсов отправляет ответ, который содержит как запрошенный ресурс, так и файлы cookie, указывающие, что пользователь прошел проверку подлинности для будущих запросов.

Дополнительные файлы cookie в ответе предназначены для ускорения процесса проверки подлинности. Дополнительные запросы в одном сеансе для ресурсов на серверах в одном и том же домене службы Passport включают эти дополнительные файлы cookie. Учетные данные не нужно отправлять на сервер входа повторно, пока не истечет срок действия файлов cookie.

![на рисунке показан запрос, прошедший проверку подлинности, на сервер входа Passport.](images/art-passport3.png)

## <a name="using-passport-in-winhttp"></a>Использование паспорта в WinHTTP

Проверка подлинности по паспорту в WinHTTP очень похожа на другие схемы проверки подлинности. Общие сведения о проверке подлинности в WinHTTP см. в статье [Проверка подлинности в WinHTTP](authentication-in-winhttp.md) .

В WinHTTP 5,1 Проверка подлинности паспорта отключена по умолчанию и должна быть явно включена с помощью [**винхттпсетоптион**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption) перед использованием.

Служба WinHTTP обрабатывает многие сведения о транзакциях внутренне для проверки подлинности Passport. Во время первоначального запроса сервер возвращает код состояния 302, если требуется проверка подлинности. Код состояния 302 на самом деле указывает на перенаправление и является частью протокола Passport для обеспечения обратной совместимости. Служба WinHTTP скрывает код состояния 302 и обращается к подпапке Passport, а затем к серверу входа. Приложение WinHTTP уведомляет о коде состояния 401, отправленном сервером входа, для запроса учетных данных пользователя. Однако для приложения он выглядит так, как если бы состояние 401 было получено с сервера, с которого был запрошен ресурс. Таким образом, приложение WinHTTP не знает о взаимодействии с другими серверами и может обрабатывать проверку подлинности Passport с помощью того же кода, который обрабатывает другие схемы проверки подлинности.

Как правило, WinHTTP-приложение реагирует на код состояния 401, указав учетные данные для проверки подлинности. Если учетные данные предоставляются с помощью [**винхттпсеткредентиалс**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetcredentials) или [**сеткредентиалс**](iwinhttprequest-setcredentials.md) для проверки подлинности Passport, учетные данные фактически отправляются на сервер входа, а не на сервер, указанный в запросе.

Однако при ответе на код состояния 407 приложение WinHTTP должно использовать [**винхттпсетоптион**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption) для предоставления учетных данных прокси-сервера, а не [**винхттпсеткредентиалс**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetcredentials). Так как **винхттпсетоптион** является менее безопасным способом предоставления учетных данных, его обычно следует избегать.

После извлечения [*билеты*](glossary.md) управляются внутренним образом и автоматически отправляются на соответствующие серверы в будущих запросах.

> [!Note]  
> Служба WinHTTP позволяет отключить автоматическое перенаправление, вызвав функцию [**винхттпсетоптион**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption) для [**параметра WinHTTP отключить флаг \_ \_ \_ функции**](option-flags.md) и указав значение, чтобы [**\_ Отключить \_ перенаправления WinHTTP**](option-flags.md). Отключение перенаправления не мешает перенаправлению, которое обслуживает службы WinHTTP для транзакций Passport.

 

Служба WinHTTP может успешно завершить проверку подлинности Passport, даже если приложение отключает автоматическое перенаправление. Однако после завершения проверки подлинности паспорта неявное перенаправление должно осуществляться с URL-адреса сервера входа Passport обратно на исходный URL-адрес. Это перенаправление не запускается HTTP-ответом 302, но является неявным в протоколе Passport.

WinHTTP обрабатывает это неявное перенаправление специально. Если приложение отключило автоматическое перенаправление, служба WinHTTP требует, чтобы приложение было предоставлено разрешение WinHTTP для автоматического перенаправления в этом специальном случае.

Чтобы служба WinHTTP перенаправлялась обратно на исходный URL-адрес после проверки подлинности, приложение должно зарегистрировать функцию обратного вызова с помощью [**WinHttpSetStatusCallback**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetstatuscallback). Служба WinHTTP может уведомить приложение о \_ состоянии обратного вызова WinHTTP \_ \_ , что позволяет приложению отменить перенаправление. Приложению не требуется предоставлять какие бы то ни было функции в функции обратного вызова. Регистрация обратного вызова достаточно, чтобы служба WinHTTP подследовала этому Специальному перенаправлению.

Сообщение об ошибке "ошибка \_ входа WinHTTP" \_ создается, \_ Если функция обратного вызова не задана приложением.

### <a name="passport-cobranding"></a>Фирменная символика Passport

В отличие от традиционных схем проверки подлинности, поддерживаемых WinHTTP, Passport может быть обширной [*фирменной символикой*](glossary.md). При получении кода состояния 401, указывающего на проблему, приложение может *получить графический рисунок* и текст. Получите URL-адрес для *фирменной символики* , вызвав [**винхттпкуерйоптион**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpqueryoption) с \_ параметром WinHTTP " \_ \_ \_ URL-адрес кофирменной символики Passport". Получите текст *кофирменной символики* , вызвав [**винхттпкуерйоптион**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpqueryoption) , установив флаг WinHTTP для \_ параметра \_ \_ \_ Text. Эти элементы можно использовать для настройки диалогового окна сбора учетных данных.

### <a name="stored-user-names-and-passwords"></a>Сохранение имен пользователей и паролей

Windows В XP появилась концепция сохраненных имен пользователей и паролей. Если учетные данные пользователя Passport сохраняются с помощью **мастера регистрации паспорта** или стандартного **диалогового окна учетных данных**, они сохраняются в сохраненных именах пользователей и паролях. при использовании winhttp в Windows XP или более поздней версии winhttp автоматически использует учетные данные в сохраненных именах пользователей и паролях, если учетные данные не заданы явно. Это похоже на поддержку учетных данных входа по умолчанию для NTLM/Kerberos. Однако использование учетных данных паспорта по умолчанию не подчиняется параметрам политики автоматического входа.

### <a name="disabling-passport-authentication"></a>Отключение проверки подлинности паспорта

Некоторым приложениям может потребоваться возможность отключения проверки подлинности Passport. Например, когда дочерний элемент Passport реагирует на код первоначального состояния 302, может быть предпочтительнее следовать указанному перенаправлению и визуализировать страницу проверки подлинности в формате HTML Passport, а не разрешать внутренней обработке проверки подлинности службой WinHTTP. Проверка подлинности Passport отключена в WinHTTP путем вызова функции [**винхттпсетоптион**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption) с параметром WinHTTP \_ \_ \_ AUTH configure \_ и передачи значения WinHTTP \_ disable \_ Passport \_ AUTH. Позже ее можно будет включить повторно с помощью WINHTTP \_ включить \_ проверку \_ подлинности Passport.

Проверку подлинности Passport нельзя отключить при использовании объекта [**WinHttpRequest**](winhttprequest.md) .

Как отмечалось ранее в этом разделе, проверка подлинности паспорта по умолчанию отключена в WinHTTP 5,1 и должна быть явно включена с помощью [**винхттпсетоптион**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption) перед использованием.

## <a name="passport-configuration-overrides-used-for-testing"></a>Переопределения конфигурации паспорта, используемые для тестирования

Служба WinHTTP полагается на сведения о конфигурации, загружаемые с сервера хранилища Passport для поддержки проверки подлинности Passport 1,4. По умолчанию этот сервер защищен (SSL) — nexus.passport.com, а ресурс конфигурации — RDR/ппрдр. ASP, известный как динамическая конфигурация Passport. Формат данных — это пользовательский заголовок HTTP "Пасспортурлс", за которым следуют пары "атрибут-значение", разделенные запятыми.

Например, " https://nexus.passport.com/rdr/pprdr.asp " возвращает следующие сведения о конфигурации:

``` syntax
PassportURLs: DARealm=Passport.net,
DALogin=login.passport.com/login2.asp,
DAReg=https://register.passport.com/defaultwiz.asp,
Properties=https://memberservices.passport.com/ppsecure/MSRV_EditProfile.asp,
Privacy=https://www.passport.com/consumer/privacypolicy.asp,
GeneralRedir=https://nexusrdr.passport.com/redir.asp,
Help=https://memberservices.passport.com/UI/MSRV_UI_Help.asp,
ConfigVersion=2
\r\n
```

Части, относящиеся к WinHTTP, — это Дареалм, Далогин и Конфигверсион. Из соображений производительности они кэшируются в течение времени существования сеанса WinHTTP. Эти три значения могут быть переопределены приложениями, необходимыми для работы с другой инфраструктурой Passport, отличной от реальной рабочей настройки, изменяя соответствующие параметры реестра в разделе

```
HKEY_LOCAL_MACHINE
   SOFTWARE
      Microsoft
         Windows
            CurrentVersion
               Internet Settings
                  WinHttp
                     Passport Test
```

``` syntax
LoginServerRealm (REG_SZ)    For example: abc.net
LoginServerUrl (REG_SZ)      For example: https://private-login.passport.com/login2.asp
ConfigVersion (REG_DWORD)    For example: 10
```

Если в реестре есть Логинсерверурл, служба WinHTTP не свяжется с сервером хранилища для получения других значений конфигурации. В этом случае Логинсерверреалм и Конфигверсион также должны быть установлены в реестре для исправления значений.

Приложение может потребоваться для тестирования, чтобы загрузить конфигурацию паспорта с закрытого сервера хранилища. Это можно сделать, переопределив два значения реестра в разделе

```
HKEY_LOCAL_MACHINE
   SOFTWARE
      Microsoft
         Windows
            CurrentVersion
               Internet Settings
                  WinHttp
                     Passport Test
```

``` syntax
NexusHost (REG_SZ)    e.g. private-nexus.passport.com
NexusObj(REG_SZ)      e.g. config/passport.asp
```

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Проверка подлинности в WinHTTP](authentication-in-winhttp.md)
</dt> </dl>

 

 



