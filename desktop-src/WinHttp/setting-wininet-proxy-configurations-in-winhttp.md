---
description: Приложениям, которые используют для порта из WinINet в WinHTTP, может потребоваться использовать те же параметры автопрокси-сервера, которые они могут получить в папке WinINet или Internet Explorer (IE).
ms.assetid: c3e867d8-9d67-4e6a-8551-1fa846e089ed
title: Настройка конфигураций прокси-сервера WinINet в WinHTTP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 91306f6591e0aab0f96fa010ee2a83d3f32c8fb4
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103999558"
---
# <a name="setting-wininet-proxy-configurations-in-winhttp"></a>Настройка конфигураций прокси-сервера WinINet в WinHTTP

## <a name="setting-automatic-proxy-on-winhttp-51"></a>Настройка автоматического прокси-сервера для WinHTTP 5,1

Приложениям, которые используют для порта из WinINet в WinHTTP, может потребоваться использовать те же параметры автопрокси-сервера, которые они могут получить в папке WinINet или Internet Explorer (IE). API-интерфейс WinHTTP версии 5,1 может извлекать и использовать эти параметры прокси. В общем случае служба WinHTTP указывает серверы обхода прокси-сервера и прокси-серверов для каждого сеанса при создании сеанса. Эти параметры могут быть переопределены отдельно для каждого запроса.

Чтобы использовать ту же конфигурацию прокси-сервера, что и WinINet или IE, клиент WinHTTP должен задать параметры прокси-сервера для этого сеанса. Кроме того, если IE или WinINet настроены для использования автоматического обнаружения веб-прокси (WPAD), то клиент WinHTTP, использующий эти параметры, должен задавать параметры прокси-сервера для каждого запроса. В следующих разделах описано, как указать параметры прокси-сервера для сеанса и запроса.

-   [Настройка конфигурации прокси-сервера в сеансе](#setting-the-proxy-configuration-on-a-session)
-   [Настройка конфигурации прокси-сервера для одного запроса](#setting-the-proxy-configuration-on-a-single-request)

## <a name="setting-the-proxy-configuration-on-a-session"></a>Настройка конфигурации прокси-сервера в сеансе

## <a name="the-application-is-running-on-a-user-account"></a>Приложение работает под учетной записью пользователя

Перед созданием сеанса приложение вызывает [**винхттпжетиепроксиконфигфоркуррентусер**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) для получения параметров прокси IE. Для получения этих параметров приложение должно выполняться от имени учетной записи пользователя. Параметр *ппроксиконфиг* — это указатель на структуру [**\_ \_ \_ \_ \_ конфигурации прокси-сервера для текущего пользователя WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) , которая содержит серверы прокси-сервера (*лпсзпрокси*) и обход прокси-сервера (*лпсзпроксибипасс*). Для инициализации сеанса WinHTTP используются значения прокси-сервера и обхода прокси-сервера для **\_ текущего \_ пользователя \_ \_ \_ WinHTTP** . Сеанс инициализируется путем вызова [**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen) с параметрами *пвсзпроксинаме* и *Пвсзпроксибипасс* , полученными из **лпсзпрокси** и **лпсзпроксибипасс** членов структуры **\_ \_ \_ \_ \_ конфигурации прокси-сервера для текущего пользователя WinHTTP** .

## <a name="the-application-is-running-as-a-service"></a>Приложение работает как служба

Приложение должно гарантировать, что параметры реестра для отдельного пользователя загружаются в реестр перед вызовом [**винхттпжетиепроксиконфигфоркуррентусер**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser). Если эти параметры не загружены в реестр, **винхттпжетиепроксиконфигфоркуррентусер** не сможет получить параметры прокси-сервера. Параметры реестра для отдельного пользователя можно загрузить в реестр, вызвав функцию **LoadUserProfile** . Если загрузка параметров реестра пользователя не является возможностью, приложение может вызвать [**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen) с использованием **\_ \_ \_ \_ прокси-сервера по умолчанию типа доступа WinHTTP** , указанного в параметре *двацесстипе* . Указание прокси-сервера по умолчанию в вызове **WinHttpOpen** указывает API WinHTTP на получение набора конфигурации прокси-сервера с помощью служебной программы [**proxycfg.exe**](proxycfg-exe--a-proxy-configuration-tool.md) WinHTTP. После загрузки параметров реестра для отдельного пользователя приложение выполняет действия, описанные в разделе [приложение выполняется в учетной записи пользователя](#the-application-is-running-on-a-user-account) , чтобы задать имя прокси-сервера и обход прокси-сервера.

## <a name="setting-the-proxy-configuration-on-a-single-request"></a>Настройка конфигурации прокси-сервера для одного запроса

Перед созданием сеанса приложение вызывает [**винхттпжетиепроксиконфигфоркуррентусер**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) , чтобы определить, настроены ли WinInet и IE на использование WPAD. **Винхттпжетиепроксиконфигфоркуррентусер** возвращает структуру [**\_ \_ \_ \_ \_ конфигурации прокси-сервера для текущего пользователя WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) , которая содержит элемент **фаутодетект** . Значение **true** для этого элемента указывает, что используется WPAD, а член **лпсзаутоконфигурл** содержит URL-адрес WPAD.

## <a name="automatic-proxy-configuration-is-used"></a>Используется автоматическая конфигурация прокси-сервера

Если используется протокол WPAD, приложение вызывает [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) для получения учетной записи-посредника для запроса. Параметр *лпвсзурл* содержит URL-адрес, на который отправляется запрос, а параметр *паутопроксйоптионс* содержит указатель на структуру ([**\_ \_ Параметры автопрокси WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_autoproxy_options)), который содержит параметры автопрокси. Приложение инициализирует структуру **\_ \_ параметров автопрокси WinHTTP** с параметрами, возвращенными из структуры [**\_ \_ \_ \_ \_ конфигурации прокси-сервера для текущего пользователя WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) в вызове [**винхттпжетиепроксиконфигфоркуррентусер**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser). Флаг **\_ \_ \_ URL-адреса конфигурации автопрокси WinHTTP** указывается в ЭЛЕМЕНТЕ **dwFlags** структуры **\_ \_ параметров автопрокси WinHTTP** , а элемент **лпсзаутоконфигурл** содержит URL-адрес автоматической настройки прокси-сервера из структуры **\_ \_ \_ \_ \_ конфигурации прокси-сервера для текущего пользователя WinHTTP** . Функция **WinHttpGetProxyForUrl** возвращает имя прокси-сервера и список обхода прокси-сервера в члене **лпсзпрокси** и **лпсзпроксибипасс** в [**структуре \_ \_ сведений о прокси-сервере WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info) .

После того как прокси-сервер для запроса получен из [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl), приложение создает запрос с помощью [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest). Затем вызывается [**винхттпсетоптион**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption) для установки прокси-сервера для запроса путем указания маркера запроса в параметре *хинтернет* . Параметр *элемент dwoption* в вызове **винхттпсетоптион** должен иметь значение **WinHTTP \_ \_ proxy** , а параметр *лпбуффер* — указатель на структуру [**\_ \_ сведений о прокси-сервере WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info) , которая содержит прокси-сервер и обход прокси-сервера, используемые для запроса.

## <a name="automatic-proxy-configuration-is-not-used"></a>Автоматическая настройка прокси-сервера не используется

Если вызов [**винхттпжетиепроксиконфигфоркуррентусер**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) указывает, что автопрокси не используется, приложение может просто создать запрос с помощью [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest). Конфигурация прокси-сервера одинакова для всего сеанса, и изменения для каждого запроса не требуются.

 

 



