---
title: О таблицах Atom
description: В этом разделе обсуждаются таблицы Atom.
ms.assetid: 12114a3e-99a4-480f-9d1a-57c1942b7382
keywords:
- атомы
- таблицы Atom
- имена Atom
- Платформа динамических данных Exchange (DDE), атомы
- DDE (платформа динамических данных Exchange), атомы
- глобальные таблицы Atom
- локальные таблицы Atom
- целочисленные атомы
- строковые атомы
ms.topic: article
ms.date: 08/25/2020
ms.openlocfilehash: 92a8304e1e96c7385ddb11ba6391258acbe62a26
ms.sourcegitcommit: f848119a8faa29b27585f4df53f6e50ee9666684
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/27/2021
ms.locfileid: "110549609"
---
# <a name="about-atom-tables"></a>О таблицах Atom

*Таблица Atom* — это определяемая системой таблица, в которой хранятся строки и соответствующие идентификаторы. Приложение помещает строку в таблицу Atom и получает 16-разрядное целое число, называемое *Atom*, которое можно использовать для доступа к строке. Строка, помещенная в таблицу Atom, называется *именем Atom*.

Система предоставляет несколько таблиц Atom. Каждая таблица Atom служит другой целью. Например, приложения платформа динамических данных Exchange (DDE) используют [глобальную таблицу Atom](#global-atom-table) для совместного использования строк имени элемента и имени раздела с другими приложениями. Вместо передачи фактических строк приложение DDE передает глобальные атомы в свое партнерское приложение. Участник использует атомы для получения строк из таблицы Atom.

Приложения могут использовать локальные таблицы Atom для хранения собственных сопоставлений имен элементов.

Система использует таблицы Atom, которые не доступны напрямую приложениям. Однако приложение использует эти атомы при вызове различных функций. Например, зарегистрированные форматы буфера обмена хранятся во внутренней таблице Atom, используемой системой. Приложение добавляет атомы в эту таблицу Atom с помощью функции [**регистерклипбоардформат**](/windows/desktop/api/Winuser/nf-winuser-registerclipboardformata) . Кроме того, зарегистрированные классы хранятся во внутренней таблице Atom, используемой системой. Приложение добавляет атомы в эту таблицу Atom с помощью функции [**registerClass**](/windows/desktop/api/winuser/nf-winuser-registerclassa) или [**RegisterClassEx**](/windows/desktop/api/winuser/nf-winuser-registerclassexa) .

В этом разделе рассматриваются следующие темы.

-   [Глобальная таблица Atom](#global-atom-table)
-   [Пользовательская таблица Atom](#user-atom-table)
-   [Локальные таблицы Atom](#local-atom-tables)
-   [Типы Atom](#atom-types)
    -   [Строковые атомы](#string-atoms)
    -   [Целочисленные атомы](#integer-atoms)
-   [Создание Atom и счетчик использования](#atom-creation-and-usage-count)
-   [Запросы Atom-Table](#atom-table-queries)
-   [Форматы строк Atom](#atom-string-formats)

## <a name="global-atom-table"></a>Глобальная таблица Atom

Глобальная таблица Atom доступна для всех приложений. Когда приложение помещает строку в глобальную таблицу Atom, система создает объект Atom, который уникален в пределах всей системы. Любое приложение, имеющее Atom, может получить строку, которую он идентифицирует, выполнив запрос к глобальной таблице Atom.

Приложение, определяющее частный формат данных DDE для обмена данными с другими приложениями, должно размещать имя формата в глобальной таблице Atom. Этот метод предотвращает конфликты с именами форматов, определенных системой или другими приложениями, и делает идентификаторы (атомы) для сообщений или форматов, доступных для других приложений.

## <a name="user-atom-table"></a>Пользовательская таблица Atom

В дополнение к глобальной таблице Atom пользовательская таблица Atom является другой системной таблицей Atom, которая также является общей для всех процессов. Таблица user Atom используется для небольшого числа сценариев, внутренних для Win32k; Например, имена модулей Windows, хорошо известные строки в Win32k, форматы OLE и т. д. Несмотря на то, что приложения не взаимодействуют с пользовательской таблицей Atom напрямую, они вызывают несколько API-интерфейсов, таких как [registerClass](/windows/win32/api/winuser/nf-winuser-registerclassexa), [регистервиндовмессаже](/windows/win32/api/winuser/nf-winuser-registerwindowmessagea)и [регистерклипбоардформат](/windows/win32/api/winuser/nf-winuser-registerclipboardformata), которые добавляют записи в таблицу Atom пользователя. Записи, добавленные, `RegisterClass` можно удалить с помощью `UnregisterClass` . Однако записи, добавленные `RegisterWindowMessage` и, `RegisterClipboardFormat` не удаляются до завершения сеанса. Если в таблице Atom пользователя больше нет пространства, а передаваемая строка еще не находится в таблице, вызов завершится ошибкой. 

### <a name="atom-table-size"></a>Размер таблицы Atom
 
Многие критические API, включая [CreateWindow](/windows/win32/api/winuser/nf-winuser-createwindowa), основываются на пользовательских атомах. Поэтому нехватка пространства в таблице Atom пользователя приведет к серьезным проблемам. Например, не удается запустить все приложения. Ниже приведены некоторые рекомендации по эффективному использованию приложением таблиц Atom и обеспечению надежности и производительности приложения и системы.  

1. Вы должны ограничить использование приложения пользовательской таблицей Atom. Хранение уникальных строк с помощью таких интерфейсов API, как `RegisterClass` , `RegisterWindowMessage` или, `RegisterClipboardFormat` занимает место в таблице Atom пользователя, которая используется глобально другими приложениями для регистрации классов окон с помощью строк. Если это возможно, следует использовать [аддатом](/windows/desktop/api/Winbase/nf-winbase-addatomw) / [делетеатом](/windows/desktop/api/Winbase/nf-winbase-deleteatom) для хранения строк в локальной таблице Atom или [глобаладдатом](/windows/desktop/api/Winbase/nf-winbase-globaladdatoma) / [глобалделетеатом](/windows/desktop/api/Winbase/nf-winbase-globaldeleteatom) , если атомы необходимы для кросс-процессов.

1. Если возникает проблема с приложением, вызывающим проблемы с таблицей Atom пользователя, можно исследовать основную причину, подключившись к отладчику ядра и нарушая процесс при вызовах метода `UserAddAtomEx` ( `bae1 win32kbase!UserAddAtomEx /p <eprocess> "kc10;g"` ). Найдите `user32!` в стеке вызовов, чтобы узнать, какой API вызывается. Эта методика похожа на обнаружение ошибок глобальной таблицы Atom, описанных в разделе [Определение утечек глобальной таблицы Atom](/archive/blogs/ntdebugging/identifying-global-atom-table-leaks). Другим способом дампа содержимого таблицы Atom пользователя является вызов [жетклипбоардформатнаме](/windows/win32/api/winuser/nf-winuser-getclipboardformatnamea) для диапазона возможных атомов от 0XC000 до 0xFFFF. Если общее число атомов постоянно выходит во время работы приложения или не возвращается к базовому плану при закрытии приложения, возникает проблема.

## <a name="local-atom-tables"></a>Локальные таблицы Atom

Приложение может использовать локальную таблицу Atom для эффективного управления большим количеством строк, используемых только в приложении. Эти строки и связанные с ними атомы доступны только для приложения, создавшего таблицу.

Приложение, которому необходима одна и та же строка в нескольких структурах, может уменьшить использование памяти с помощью локальной таблицы Atom. Вместо копирования строки в каждую структуру приложение может поместить строку в таблицу Atom и включить результирующий объект Atom в структуры. Таким образом, строка появляется только один раз в памяти, но может использоваться в приложении много раз.

Приложения также могут использовать локальные таблицы Atom для экономии времени при поиске определенной строки. Для выполнения поиска приложению требуется только поместить строку поиска в таблицу Atom и сравнить полученный объект Atom с атомами в соответствующих структурах. Сравнение атомов обычно выполняется быстрее, чем сравнение строк.

Таблицы Atom реализуются как хэш-таблицы. По умолчанию в локальной таблице Atom для хэш-таблицы используются 37 контейнеров. Однако можно изменить число контейнеров, используемых при вызове функции [**инитатомтабле**](/windows/desktop/api/Winbase/nf-winbase-initatomtable) . Если приложение вызывает **инитатомтабле**, это необходимо сделать до вызова любых других функций управления Atom.

## <a name="atom-types"></a>Типы Atom

Приложения могут создавать два типа атомов: строковые атомы и целочисленные атомы. Значения целочисленных атомов и строковых атомов не перекрываются, поэтому оба типа атомов можно использовать в одном блоке кода.

Несколько функций принимают в качестве параметров строки или атомы. При передаче Atom в эти функции приложение может использовать макрос [**макеинтатом**](/windows/desktop/api/Winbase/nf-winbase-makeintatom) для преобразования Atom в форму, которая может использоваться функцией.

В следующих разделах описываются типы Atom.

-   [Строковые атомы](#string-atoms)
-   [Целочисленные атомы](#integer-atoms)

### <a name="string-atoms"></a>Строковые атомы

Когда приложения передают строки, заканчивающиеся нулем, в функции [**глобаладдатом**](/windows/desktop/api/Winbase/nf-winbase-globaladdatoma), [**аддатом**](/windows/desktop/api/Winbase/nf-winbase-addatomw), [**глобалфиндатом**](/windows/desktop/api/Winbase/nf-winbase-globalfindatoma)и [**финдатом**](/windows/desktop/api/Winbase/nf-winbase-findatoma) , они получают *строковые атомы* (16-разрядные целые числа) в Return. Строковые атомы имеют следующие свойства:

-   Значения строковых атомов находятся в диапазоне от 0xC000 (МАКСИНТАТОМ) до 0xFFFF.
-   Регистр не важен при поиске имени Atom в таблице Atom. Кроме того, вся строка должна совпадать в операции поиска. сопоставление подстрок не выполняется.
-   Длина строки, связанной со строкой Atom, не может превышать 255 байт. Это ограничение относится ко всем функциям Atom.
-   *Счетчик ссылок* связан с каждым именем Atom. Счетчик увеличивается каждый раз, когда имя Atom добавляется в таблицу и уменьшается каждый раз при удалении имени Atom из него. Это не позволяет разным пользователям одной и той же строки Atom уничтожить имена Atom друг друга. Если число ссылок для имени Atom равно нулю, система удаляет Atom и имя Atom из таблицы.

### <a name="integer-atoms"></a>Целочисленные атомы

Целочисленные атомы отличаются от строковых атомов следующими способами.

-   Значения целочисленных атомов находятся в диапазоне от 0x0001 до 0xBFFF (**максинтатом**– 1).
-   Строковое представление целочисленного атома имеет тип \# *dddd*, где значения, представленные в *dddd* , являются десятичными цифрами. Ведущие нули игнорируются.
-   Число ссылок или затраты на хранение, связанные с целым числом, отсутствуют.

## <a name="atom-creation-and-usage-count"></a>Создание Atom и счетчик использования

Приложение создает локальный экземпляр Atom, вызывая функцию [**аддатом**](/windows/desktop/api/Winbase/nf-winbase-addatomw) ; Он создает глобальный объект Atom, вызывая функцию [**глобаладдатом**](/windows/desktop/api/Winbase/nf-winbase-globaladdatoma) . Для обеих функций требуется указатель на строку. Система выполняет поиск строки в соответствующей таблице Atom и возвращает в приложение соответствующий элемент Atom. В случае с строкой Atom, если строка уже находится в таблице Atom, система увеличивает счетчик ссылок для строки во время этого процесса.

Повторные вызовы для добавления одного и того же имени Atom возвращают один и тот же элемент Atom. Если имя Atom не существует в таблице при вызове [**аддатом**](/windows/desktop/api/Winbase/nf-winbase-addatomw) , имя Atom добавляется в таблицу и возвращается новый элемент Atom. Если это строковый Atom, то счетчик ссылок также имеет значение One.

Приложение должно вызывать функцию [**делетеатом**](/windows/desktop/api/Winbase/nf-winbase-deleteatom) , когда больше не требуется использовать локальный экземпляр Atom; Он должен вызывать функцию [**глобалделетеатом**](/windows/desktop/api/Winbase/nf-winbase-globaldeleteatom) , когда больше не требуется глобальный атом. В случае со строкой Atom любая из этих функций сокращает число ссылок соответствующего объекта Atom на единицу. Когда счетчик ссылок достигает нуля, система удаляет имя Atom из таблицы.

Имя Atom строкового Atom остается в глобальной таблице Atom, пока значение счетчика ссылок больше нуля, даже после того, как приложение, помещенное в таблицу, завершается. Локальная таблица Atom уничтожается при завершении связанного приложения независимо от количества ссылок на атомы в таблице.

## <a name="atom-table-queries"></a>Запросы Atom-Table

Приложение может определить, уже определена ли строка в таблице Atom с помощью функции [**финдатом**](/windows/desktop/api/Winbase/nf-winbase-findatoma) или [**глобалфиндатом**](/windows/desktop/api/Winbase/nf-winbase-globalfindatoma) . Эти функции выполняют поиск указанной строки в таблице Atom и, если строка находится в ней, возвращают соответствующий Atom.

Приложение может использовать функцию [**жетатомнаме**](/windows/desktop/api/Winbase/nf-winbase-getatomnamea) или [**глобалжетатомнаме**](/windows/desktop/api/Winbase/nf-winbase-globalgetatomnamea) для извлечения строки Atom-Name из таблицы Atom при условии, что приложение имеет объект Atom, соответствующий искомой строке. Обе функции копируют строку Atom-Name указанного Atom в буфер и возвращают длину скопированной строки. **Жетатомнаме** извлекает строку Atom-Name из локальной таблицы Atom, а **глобалжетатомнаме** извлекает строку Atom-Name из глобальной таблицы Atom.

## <a name="atom-string-formats"></a>Форматы строк Atom

Функции [**аддатом**](/windows/desktop/api/Winbase/nf-winbase-addatomw), [**глобаладдатом**](/windows/desktop/api/Winbase/nf-winbase-globaladdatoma), [**финдатом**](/windows/desktop/api/Winbase/nf-winbase-findatoma)и [**глобалфиндатом**](/windows/desktop/api/Winbase/nf-winbase-globalfindatoma) принимают указатель на строку, завершающуюся нулем. Приложение может указать этот указатель одним из следующих способов.



|     Формат строки               |    Описание                                                                                                |
|--------------------|----------------------------------------------------------------------------------------------------|
| \#*dddd*           | Целое число, заданное в виде десятичной строки. Используется для создания или поиска целочисленного атома.                  |
| *имя строкового Atom* | Имя строки Atom. Используется для добавления строкового имени Atom в таблицу Atom и получения Atom в Return. |



 

 

 
