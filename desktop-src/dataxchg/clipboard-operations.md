---
title: Операции с буфером обмена
description: Окно должно использовать буфер обмена при вырезании, копировании или вставлении данных. Окно помещает данные в буфер обмена для операций вырезания и копирования и извлекает данные из буфера обмена для операций вставки.
ms.assetid: 27f9142c-3154-4de5-aea6-3c53f7e940ec
keywords:
- Пользовательский интерфейс Windows, буфер обмена
- буфер обмена, Windows
- буфер обмена, вырезание данных
- буфер обмена, копирование данных
- буфер обмена, вставленные данные
- буфер обмена, окно "владелец"
- буфер обмена, отложенная визуализация
- буфер обмена, память
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5cb2c3451cf562b35b976e137a974e19892acbb3
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "104338913"
---
# <a name="clipboard-operations"></a>Операции с буфером обмена

Окно должно использовать буфер обмена при вырезании, копировании или вставлении данных. Окно помещает данные в буфер обмена для операций вырезания и копирования и извлекает данные из буфера обмена для операций вставки. В следующих разделах описываются эти операции и связанные с ними проблемы.

Чтобы поместить данные в буфер обмена или получить данные из него, окно должно сначала открыть буфер обмена с помощью функции [**опенклипбоард**](/windows/desktop/api/Winuser/nf-winuser-openclipboard) . Только в одном окне может быть открыт буфер обмена за раз. Чтобы узнать, в каком окне открыт буфер обмена, вызовите функцию [**жетопенклипбоардвиндов**](/windows/desktop/api/Winuser/nf-winuser-getopenclipboardwindow) . По завершении окно должно закрыть буфер обмена, вызвав функцию [**клосеклипбоард**](/windows/desktop/api/Winuser/nf-winuser-closeclipboard) .

В этом разделе рассматриваются следующие темы.

-   [Операции вырезания и копирования](#cut-and-copy-operations)
-   [Операции вставки](#paste-operations)
-   [Владение буфером обмена](#clipboard-ownership)
-   [Отложенная визуализация](#delayed-rendering)
-   [Память и буфер обмена](#memory-and-the-clipboard)

## <a name="cut-and-copy-operations"></a>Операции вырезания и копирования

Чтобы поместить сведения в буфер обмена, окно сначала очищает содержимое буфера обмена с помощью функции [**емптиклипбоард**](/windows/win32/api/winuser/nf-winuser-emptyclipboard) . Эта функция отправляет сообщение [**WM \_ дестройклипбоард**](wm-destroyclipboard.md) предыдущему владельцу буфера обмена, освобождает ресурсы, связанные с данными в буфере обмена, и назначает владение буферу обмена для окна, в котором открыт буфер обмена. Чтобы узнать, какое окно владеет буфером обмена, вызовите функцию [**жетклипбоардовнер**](/windows/win32/api/winuser/nf-winuser-getclipboardowner) .

После очистки буфера обмена окно помещает данные в буфер обмена в максимальном количестве форматов буфера обмена, упорядоченном от наиболее описательного формата буфера обмена к крайней описательной. Для каждого формата окно вызывает функцию [**сетклипбоарддата**](/windows/win32/api/winuser/nf-winuser-setclipboarddata) , указывая идентификатор формата и глобальный маркер памяти. Маркер памяти может иметь значение NULL, что означает, что окно визуализирует данные по запросу. Дополнительные сведения см. в разделе [отложенная визуализация](#delayed-rendering).

## <a name="paste-operations"></a>Операции вставки

Чтобы получить сведения о вставке из буфера обмена, окно сначала определяет формат буфера обмена для извлечения. Как правило, окно перечисляет доступные форматы буфера обмена с помощью функции [**енумклипбоардформатс**](/windows/desktop/api/Winuser/nf-winuser-enumclipboardformats) и использует первый распознаваемый формат. Этот метод выбирает наилучший доступный формат в соответствии с приоритетом, установленным при помещении данных в буфер обмена.

Кроме того, окно может использовать функцию [**жетприоритиклипбоардформат**](/windows/desktop/api/Winuser/nf-winuser-getpriorityclipboardformat) . Эта функция определяет наилучший доступный формат буфера обмена в соответствии с заданным приоритетом. Окно, которое распознает только один формат буфера обмена, может просто определить, доступен ли этот формат с помощью функции [**исклипбоардформатаваилабле**](/windows/desktop/api/Winuser/nf-winuser-isclipboardformatavailable) .

Определив используемый формат буфера обмена, окно вызывает функцию [**жетклипбоарддата**](/windows/desktop/api/Winuser/nf-winuser-getclipboarddata) . Эта функция возвращает маркер в глобальный объект памяти, содержащий данные в указанном формате. Окно может временно заблокировать объект памяти, чтобы проверить или скопировать данные. Однако окно не должно освобождать объект или оставаться заблокированным в течение длительного периода времени.

## <a name="clipboard-ownership"></a>Владение буфером обмена

*Владелец буфера обмена* — это окно, связанное с информацией в буфере обмена. Окно превращается в владельца буфера обмена при размещении данных в буфере обмена, в частности, при вызове функции [**емптиклипбоард**](/windows/desktop/api/Winuser/nf-winuser-emptyclipboard) . Окно остается владельцем буфера обмена до тех пор, пока оно не будет закрыто, или другое окно не будет очищать буфер обмена.

Когда буфер обмена очищается, владелец буфера получает сообщение [**WM \_ дестройклипбоард**](wm-destroyclipboard.md) . Ниже приведены некоторые причины, по которым окно может обработать это сообщение:

-   Окно отложенной отрисовки одного или нескольких форматов буфера обмена. В ответ на сообщение [**\_ дестройклипбоард WM**](wm-destroyclipboard.md) окно может освободить ресурсы, выделенные для отображения данных по запросу. Дополнительные сведения о подготовке данных к просмотру см. в разделе [отложенная визуализация](#delayed-rendering).
-   Окно поместило данные в буфер обмена в частном формате буфера обмена. Данные для закрытых форматов буфера обмена не освобождаются системой при очистке буфера обмена. Поэтому владелец буфера обмена должен освобождать данные при получении сообщения [**WM \_ дестройклипбоард**](wm-destroyclipboard.md) . Дополнительные сведения о форматах частных буферов обмена см. в разделе [форматы буфера обмена](clipboard-formats.md).
-   Окно поместило данные в буфер обмена, используя формат буфера обмена **CF \_ овнердисплай** . В ответ на сообщение [**\_ дестройклипбоард WM**](wm-destroyclipboard.md) окно может освободить ресурсы, которые использовались для вывода сведений в окне средства просмотра буфера обмена. Дополнительные сведения об этом альтернативном формате см. в разделе [Формат отображаемого владельца](about-the-clipboard.md).

## <a name="delayed-rendering"></a>Отложенная визуализация

При помещении формата буфера обмена в буфер обмена окно может отложить отображение данных в этом формате до тех пор, пока не будут нужны данные. Для этого в приложении можно указать **значение NULL** для параметра *хдата* функции [**сетклипбоарддата**](/windows/win32/api/winuser/nf-winuser-setclipboarddata) . Это полезно, если приложение поддерживает несколько форматов буфера обмена, некоторые или все из которых занимают много времени для отрисовки. При передаче маркера **null** окно отображает сложные форматы буфера обмена только в том случае, если они необходимы.

Если окно задерживает формат буфера обмена, оно должно быть подготовлено для подготовки к просмотру формата по запросу, если он является владельцем буфера обмена. Система отправляет владельцу буфера обмена сообщение [**WM \_ RENDERFORMAT**](wm-renderformat.md) при получении запроса для определенного формата, который не был подготовлен к просмотру. После получения этого сообщения окно должно вызвать функцию [**сетклипбоарддата**](/windows/win32/api/winuser/nf-winuser-setclipboarddata) , чтобы поместить глобальный маркер памяти в буфер обмена в запрошенном формате.

Приложение не должно открывать буфер обмена перед вызовом [**сетклипбоарддата**](/windows/win32/api/winuser/nf-winuser-setclipboarddata) в ответ на сообщение [**\_ RENDERFORMAT WM**](wm-renderformat.md) . Открытие буфера обмена не является обязательным, и любая попытка сделать это приведет к сбою, так как буфер обмена открывается приложением, запрашивающим формат для подготовки к просмотру.

Если владелец буфера обмена собирается уничтожить и откладывает визуализацию некоторых или всех форматов буфера обмена, он получает сообщение [**WM \_ рендераллформатс**](wm-renderallformats.md) . После получения этого сообщения окно должно открыть буфер обмена, убедиться, что он по-прежнему является владельцем буфера обмена с функцией [**жетклипбоардовнер**](/windows/win32/api/winuser/nf-winuser-getclipboardowner) , а затем поместить в буфер обмена допустимые дескрипторы памяти для всех форматов буфера обмена, которые он предоставляет. Это гарантирует, что эти форматы останутся доступными после уничтожения владельца буфера обмена.

В отличие от [**WM \_ RENDERFORMAT**](wm-renderformat.md), приложение, отвечающее [**на \_ рендераллформатс WM**](wm-renderallformats.md) , должно открыть буфер обмена перед вызовом [**сетклипбоарддата**](/windows/win32/api/winuser/nf-winuser-setclipboarddata) для размещения любых глобальных дескрипторов памяти в буфере обмена.

Все форматы буфера обмена, не отображаемые в ответ на [**сообщение \_ рендераллформатс WM**](wm-renderallformats.md) , становятся доступны другим приложениям и больше не перечисляются функциями буфера обмена.

## <a name="memory-and-the-clipboard"></a>Память и буфер обмена

Объект памяти, помещаемый в буфер обмена, должен быть выделен с помощью функции [**GlobalAlloc**](/windows/desktop/api/winbase/nf-winbase-globalalloc) с флагом **\_ перемещаемой ГМЕМ** .

После помещения объекта памяти в буфер обмена владение этим маркером памяти передается в систему. Когда буфер обмена очищается и объект памяти имеет один из следующих форматов буфера обмена, система освобождает объект памяти, вызывая указанную функцию:



| Функция для освобождения объекта                             | Формат буфера обмена                                                                                                                                               |
|-----------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [**делетеметафиле**](/windows/desktop/api/wingdi/nf-wingdi-deletemetafile)<br/> | **\_ДСПЕНХМЕТАФИЛЕ CF**<br/> **\_ДСПМЕТАФИЛЕПИКТ CF**<br/> **\_ЕНХМЕТАФИЛЕ CF**<br/> **\_МЕТАФИЛЕПИКТ CF**<br/>                            |
| [**DeleteObject**](/windows/desktop/api/wingdi/nf-wingdi-deleteobject)<br/>     | **\_точечный рисунок CF**<br/> **\_ДСПБИТМАП CF**<br/> **\_Палитра CF**<br/>                                                                              |
| [**GlobalFree**](/windows/desktop/api/winbase/nf-winbase-globalfree)<br/>        | **CF \_ DIB**<br/> **\_DIBV5 CF**<br/> **\_ДСПТЕКСТ CF**<br/> **\_ОЕМТЕКСТ CF**<br/> **\_текст CF**<br/> **\_УНИКОДЕТЕКСТ CF**<br/>   |
| нет<br/>                                     | **\_ОВНЕРДИСПЛАЙ CF**<br/> Когда буфер обмена очищается от объекта **CF \_ овнердисплай** , само приложение должно освободить объект памяти.<br/> |



 

 

