---
description: Счетчики используются для предоставления сведений о том, насколько хорошо работает операционная система или приложение, служба или драйвер.
ms.assetid: d172a131-61d3-4fc1-8e0c-b07b2bd34f80
title: Сведения о счетчиках производительности
ms.topic: article
ms.date: 08/17/2020
ms.openlocfilehash: dec7c71e99ab614ee64e3d1e8c9620f0be78c14a
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103909755"
---
# <a name="about-performance-counters"></a>Сведения о счетчиках производительности

Счетчики производительности Windows предоставляют высокоуровневый уровень абстракции с единообразным интерфейсом для сбора различных типов системных данных, таких как ЦП, память и статистика использования диска. Системные администраторы используют счетчики производительности для наблюдения за проблемами производительности или поведения. Разработчики программного обеспечения используют счетчики производительности для проверки использования ресурсов их компонентов.

> [!IMPORTANT]
> Счетчики производительности Windows оптимизированы для обнаружения и сбора данных по администрированию и диагностике. Они не подходят для сбора данных с высокой частотой или для профилирования приложений, так как они не предназначены для сбора более одного раза в секунду. Для доступа к системной информации с более низкими издержками можно использовать более прямые API, такие как [**вспомогательное состояние процесса**](../psapi/process-status-helper.md), [**глобалмемористатусекс**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-globalmemorystatusex), [**жетсистемтимес**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getsystemtimes)или [**GetProcessTimes**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getprocesstimes). Для профилирования можно выполнять сбор журналов ETW с данными профилирования системы с помощью [**tracelog.exe**](/windows-hardware/drivers/devtest/tracelog) с `-critsec` `-dpcisr` параметрами, `-eflag` или с `-ProfileSource` помощью [**профилирования счетчика оборудования**](/previous-versions/windows/desktop/hcp/hcp-reference).

> [!NOTE]
> Не путайте счетчики производительности Windows с API [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) . Счетчики производительности Windows обеспечивают высокоуровневую абстракцию для многих типов системных данных. Функция QueryPerformanceCounter предоставляет оптимизированный доступ к метке времени с высокой точностью.

## <a name="getting-started"></a>Приступая к работе

- Используйте [средства счетчиков производительности](performance-counters-tools.md) , если требуется получить или просмотреть данные о производительности из системы.
- Используйте [API сбора счетчиков производительности](consuming-counter-data.md) , если требуется написать сценарий или программу, собирающую данные о производительности из локальной системы.
- Используйте [Классы счетчиков производительности WMI](/windows/desktop/WmiSdk/monitoring-performance-data) , если требуется получить данные о производительности из локальной или удаленной системы с помощью инструментария WMI.
- Используйте [API поставщика счетчиков производительности](providing-counter-data.md) , если требуется опубликовать данные о производительности из программного компонента.

## <a name="concepts"></a>Основные понятия

Система счетчиков производительности Windows организована в виде **потребителей**, **поставщиков**, **каунтерсетс**, **счетчиков**, **экземпляров** и **значений счетчиков**.

**Потребитель** — это программный компонент, который использует данные о производительности. Windows включает несколько [встроенных средств](performance-counters-tools.md) , которые используют данные о производительности. К ним относятся диспетчер задач, монитор ресурсов, монитор производительности, typeperf.exe, logman.exe и relog.exe. Разработчики могут создавать сценарии и приложения, обращающиеся к счетчикам производительности через [API-интерфейсы счетчика производительности](consuming-counter-data.md).

**Поставщик** — это программный компонент, который [создает и публикует данные производительности](providing-counter-data.md). Поставщик будет публиковать данные для одного или нескольких *каунтерсетс*. Например, система базы данных может зарегистрироваться в качестве поставщика данных о производительности.

- **Поставщик v1** — это программный компонент, который публикует данные производительности с помощью [библиотеки DLL производительности](providing-counter-data-using-a-performance-dll.md) , которая выполняется в процессе потребителя. Поставщик v1 устанавливается на компьютере с помощью `.ini` файла. Архитектура поставщика v1 устарела. Новые поставщики должны использовать архитектуру поставщика v2.
- **Поставщик v2** — это программный компонент, который публикует данные производительности с помощью [API поставщика счетчиков производительности](providing-counter-data-using-version-2-0.md). Поставщик v2 устанавливается на систему через `.man` файл (XML-манифест).

Набор **счетчиков** — это группирование данных о производительности в поставщике. Набор счетчиков имеет имя и один или несколько *счетчиков*. Сбор данных из набора счетчиков возвращает число *экземпляров*. В некоторых API-интерфейсах Windows каунтерсетс называются **объектами производительности**. Например, поставщик данных производительности для системы базы данных может предоставлять набор счетчиков для статистики по базе данных.

**Счетчик** — это определение отдельной части данных о производительности. У счетчика есть имя и тип. Например, набор счетчиков «статистика по базе данных» может содержать счетчик с именем «транзакций в секунду» с типом `PERF_COUNTER_COUNTER` .

**Экземпляр** — это сущность, в которой сообщается о данных о производительности. Экземпляр имеет имя (строка) и одно или несколько *значений счетчика*. Например, набор счетчиков «статистика по базе данных» может содержать по одному экземпляру на базу данных. Имя экземпляра будет именем базы данных, а каждый экземпляр будет содержать значения счетчика для счетчиков "транзакций в секунду", "использование памяти" и "использование диска".

**Значение счетчика** — это значение одного элемента данных счетчика производительности. Значение счетчика — это целое число без знака, 32-бит или 64-бит, в зависимости от типа соответствующего счетчика. При разговоре об *экземпляре* *значение счетчика* иногда может называться *счетчиком* или *значением*.

> [!TIP]
> Может быть полезно связать термины счетчиков производительности с более привычными условиями электронной таблицы. Набор **счетчиков** подобен таблице. **Счетчик** похож на столбец. **Экземпляр** похож на строку. **Значение счетчика** похоже на ячейку в таблице.

**Один экземпляр каунтерсетс** всегда содержит данные только для одного экземпляра. Это распространено для каунтерсетс, которые сообщают о глобальной системе статистики. Например, Windows имеет встроенный набор счетчиков с одним экземпляром "память", который сообщает об использовании глобальной памяти.

**Каунтерсетс с несколькими экземплярами** содержит данные для переменного числа экземпляров. Это распространено для каунтерсетс, которые сообщают о сущностях в системе. Например, Windows имеет встроенный набор счетчиков с несколькими экземплярами "сведения о процессоре", который сообщает по одному экземпляру для каждого установленного ЦП.

Потребители периодически собираются и записывают данные из CounterSet поставщика. Например, потребитель может получать данные один раз в секунду или один раз в минуту. Собранные данные называются **примером**. Пример состоит из меток времени и данных для экземпляров набора счетчиков. Данные для каждого экземпляра включают имя экземпляра (строку) и набор значений счетчика (целые числа, по одному значению для каждого счетчика в наборе счетчиков).

Имена экземпляров должны быть уникальными в образце, т. е. поставщик не должен возвращать два экземпляра с одним и тем же именем как часть одного примера. Некоторые старые поставщики не соответствуют этому правилу, поэтому [потребители должны иметь возможность допускать неуникальные имена экземпляров](handling-duplicate-instance-names.md). Имена экземпляров не учитывают регистр, поэтому экземпляры не должны иметь имен, отличающихся только регистром.

> [!NOTE]
> В целях обратной совместимости набор счетчиков "процесс" возвращает неуникальные имена экземпляров на основе имени файла EXE. Это может привести к путанице в результатах, особенно при запуске или завершении процесса с неуникальным именем, так как это обычно приводит к сбою данных из-за неправильного соответствия имен экземпляров между выборками. Потребители в наборе счетчиков "процесс" должны иметь возможность допускать эти неуникальные имена экземпляров и результирующие данные.

Имена экземпляров должны быть стабильными в образцах, т. е. поставщик должен использовать одно и то же имя экземпляра для одной и той же сущности каждый раз при сборе набора счетчиков.

Каждый счетчик имеет тип. Тип счетчика указывает тип **необработанного значения** счетчика (беззнаковое 32-разрядное целое число или неподписанное 64-разрядное целое число). Тип счетчика также указывает, что представляет собой необработанное значение счетчика, которое определяет, как обработанное значение должно обрабатываться для создания полезной статистики.

Хотя некоторые типы счетчиков просты и имеют необработанное значение, которое напрямую полезно, многие типы счетчиков нуждаются в [дополнительной обработке](calculating-counter-values.md) , чтобы создать полезное **отформатированное значение**. Для создания форматированного значения некоторым типам счетчиков требуются необработанные значения из двух выборок, для некоторых типов счетчиков требуются метки времени, а для некоторых типов счетчиков требуются необработанные значения из нескольких счетчиков. Пример:

- `PERF_COUNTER_LARGE_RAWCOUNT` — Это 64-разрядное необработанное значение, которое не требует никакой обработки. Он подходит для значений на момент времени, например "байт используемой памяти".
- `PERF_COUNTER_RAWCOUNT_HEX` — Это 32-разрядное необработанное значение, которое должно быть полезно только для простого шестнадцатеричного форматирования. Он подходит для получения точки во времени или идентификации, например "Flags" или "базовый адрес".
- `PERF_COUNTER_BULK_COUNT` — Это 64-разрядное необработанное значение, указывающее количество событий и используемое для вычисления скорости возникновения событий. Чтобы быть полезным, для этого типа счетчика требуется два образца, которые были разделены по времени. Отформатированное значение — это частота событий, т. е. количество событий, произошедших в секунду за интервал между двумя примерами. Учитывая два образца `s0` и `s1` , отформатированное значение (частота событий) будет вычисляться как `(s1.EventCount - s0.EventCount)/(s1.TimestampInSeconds - s0.TimestampInSeconds)` .

Предполагается, что поставщики ведут себя так, как если бы они не изменяют состояние, т. е. сбор данных из набора счетчиков не должен заметно влиять на состояние поставщика. Например, поставщик не должен сбрасывать значения счетчика в 0 при сборе набора счетчиков и не должен использовать отметку времени предыдущей коллекции для корректировки значений в текущей коллекции. Вместо этого он должен предоставлять простые необработанные значения счетчиков с точными типами, чтобы потребитель мог вычислить полезную статистику на основе необработанных значений и их меток времени.

## <a name="performance-api-architecture"></a>Архитектура API производительности

![Приложения счетчиков производительности вызывают API Windows, которые вызывают поставщиков для получения данных о производительности.](images/architecture.png)

Потребители счетчиков производительности включают:

- [Приложения, предоставляемые корпорацией Майкрософт](performance-counters-tools.md) , такие как диспетчер задач, монитор ресурсов, монитор производительности и typeperf.exe.
- Предоставляемые корпорацией Майкрософт высокоуровневые поверхности API, которые предоставляют данные счетчиков производительности, такие как [классы производительности WMI](/windows/desktop/WmiSdk/monitoring-performance-data).
- Собственные приложения или скрипты, использующие [API-интерфейсы потребителя счетчика производительности](consuming-counter-data.md).

Большинство потребителей счетчиков производительности используют API из [PDH.dll](using-the-pdh-functions-to-consume-counter-data.md) для получения данных о производительности. PDH управляет множеством сложных аспектов сбора счетчиков производительности, таких как анализ запросов, сопоставление экземпляров по нескольким примерам и вычисление форматированных значений из необработанных данных счетчиков. Реализация PDH использует API реестра при использовании данных от поставщика v1 и использует API-интерфейсы потребителя v2 При использовании данных от поставщика v2.

Некоторые старые получатели счетчиков производительности используют [API реестра](using-the-registry-functions-to-consume-counter-data.md) для получения данных о производительности из специального `HKEY_PERFORMANCE_DATA` раздела реестра. Это не рекомендуется для нового кода, поскольку обработка данных из реестра является сложной и подвержена ошибкам. Реализация API реестра напрямую поддерживает сбор данных от поставщиков v1. Он косвенно поддерживает сбор данных от поставщиков v2 через слой перевода, использующий API-интерфейсы потребителя версии 2.

Некоторые потребители счетчиков производительности используют [функции-потребители версии PerfLib v2](using-the-perflib-functions-to-consume-counter-data.md) для прямого доступа к данным из поставщиков v2. Это сложнее, чем использование данных с помощью интерфейсов API PDH, но этот подход может быть полезен, если интерфейсы API PDH не могут быть использованы из-за проблем с производительностью или зависимостями. Реализация PerfLib v2 напрямую поддерживает сбор данных от поставщиков v2. Он не поддерживает сбор данных от поставщиков v1.

> [!NOTE]
> Windows OneCore не включает PDH.dll и не поддерживает использование данных счетчиков производительности с помощью API-интерфейсов реестра. Потребители, работающие в OneCore, должны использовать функции-потребители версии PerfLib v2.

Поставщики v1 реализуются как библиотека DLL поставщика, которая загружается в процесс потребителя. Реализация API реестра управляет загрузкой библиотеки DLL поставщика, вызовом библиотеки DLL для получения данных о производительности и выгрузкой библиотеки DLL соответствующим образом. Библиотека DLL поставщика отвечает за [сбор данных о производительности по мере необходимости](communicating-with-your-application.md), например с помощью обычных API Windows, RPC, именованных каналов, общей памяти или других механизмов взаимодействия между процессами.

Поставщики v2 реализуются как программа пользовательского режима (часто это служба Windows) или драйвер режима ядра. Обычно код поставщика данных о производительности интегрируется непосредственно в существующий компонент (т. е. драйвер или служба сообщает о своей статистике). Реализация PerfLib v2 управляет запросами и ответами с помощью расширения ядра PCW.sys, поэтому поставщику обычно не требуется реализовывать взаимодействие между процессами для предоставления данных о производительности.

> [!NOTE]
> API и средства счетчика производительности Windows включают ограниченную поддержку доступа к счетчикам производительности с других компьютеров с помощью удаленного реестра (для поставщиков v1) и RPC (для поставщиков v2). Эту поддержку часто трудно использовать в терминах элементов управления проверки подлинности (средства и API-интерфейсы могут проходить проверку подлинности только в качестве текущего пользователя), а также в плане [конфигурации системы](accessing-remote-counter-data.md) (необходимые конечные точки и службы отключены по умолчанию). Во многих случаях лучше обращаться к счетчикам производительности удаленных систем через [инструментарий WMI](/windows/desktop/WmiSdk/monitoring-performance-data) , а не через встроенную поддержку удаленного доступа.

## <a name="developer-audience"></a>Аудитория разработчиков

Счетчики производительности часто используются администраторами для определения проблем с производительностью или аномального поведения систем, разработчиками, которые могут изучить использование ресурсов программных компонентов, и отдельных пользователей, чтобы понять, как программы работают в своей системе. Использование может осуществляться с помощью графических средств графического интерфейса, таких как диспетчер задач или системный монитор, средства командной строки, такие как typeperf.exe или logman.exe, с помощью сценариев с помощью WMI и PowerShell, а также через API-интерфейсы C/C++ и .NET.

Поставщики счетчиков производительности обычно реализуются как драйверы режима ядра или службы пользовательского режима. Поставщики счетчиков производительности обычно пишутся на C или C++.

## <a name="run-time-requirements"></a>Требования к среде выполнения

Сведения о требованиях времени выполнения для определенного программного элемента см. в разделе "требования" на странице справочника по этому элементу.

Журнал версий см. в разделе [новые](performance-counters-what-s-new.md)возможности.

## <a name="see-also"></a>См. также раздел

[Использование счетчиков производительности](using-performance-counters.md)

[Справочник по счетчикам производительности](performance-counters-reference.md)
