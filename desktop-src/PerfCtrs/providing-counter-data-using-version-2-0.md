---
description: В версии 2,0 счетчики производительности изменили архитектуру, чтобы упростить процесс предоставления данных счетчиков потребителям.
ms.assetid: 37f75b15-3f52-4259-a6d9-5a1a14f88379
title: Предоставление данных счетчиков с помощью версии 2,0
ms.topic: article
ms.date: 08/17/2020
ms.openlocfilehash: 67976c8a0b6c77582ed8c50c2e5cf753c77fcf6b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105663162"
---
# <a name="providing-counter-data-using-version-20"></a>Предоставление данных счетчиков с помощью версии 2,0

Современные поставщики данных производительности используют манифест для определения данных счетчиков и использования API поставщика счетчиков производительности для управления данными в контексте поставщика. Поставщики, реализованные с использованием манифеста и API поставщика счетчиков производительности, часто называются **поставщиками версии 2**. Windows поддерживает поставщики пользовательского режима v2 в Windows Vista или более поздних версиях и поставщики в режиме ядра v2 в Windows 7 или более поздней версии.

На этой странице описываются поставщики пользовательского режима v2. Дополнительные сведения о поставщиках в режиме ядра v2 см. в разделе [мониторинг производительности в режиме ядра](/windows-hardware/drivers/devtest/kernel-mode-performance-monitoring).

В среде выполнения поставщики версии 2 работают следующим образом:

- Процесс поставщика регистрируется в системе счетчиков производительности Windows путем вызова Перфстартпровидер и Перфсеткаунтерсетинфо. Поставщик дополнительно предоставляет функцию обратного вызова, которая будет получать уведомления о запросах потребителей.
- Процесс поставщика добавляет или удаляет экземпляры соответствующим образом с помощью Перфкреатеинстанце и Перфделетеинстанце. Поставщик обновляет значения счетчиков при их изменении с помощью API-интерфейсов Perf.
- Потребитель выполняет запрос данных из CounterSet. Система проверяет, имеет ли вызывающий объект разрешения на получение данных. Затем система использует рабочий поток, выполняющийся в процессе поставщика, для обработки запроса, вызывая функцию обратного вызова поставщика, если это уместно. Рабочий поток копирует собранные данные в управляемый системой буфер, а затем система возвращает данные потребителю.

## <a name="steps-to-creating-a-provider"></a>Действия по созданию поставщика

1. Напишите манифест, определяющий данные счетчика, которые предоставит поставщик. Дополнительные сведения о создании манифеста см. в разделе [схема счетчиков производительности](performance-counters-schema.md).
2. Используйте [КТРПП](ctrpp.md) для создания кода шаблона, который вы включаете в поставщик. Код шаблона включает структуры, которые определяют наборы счетчиков, функции [_ *каунтеринитиализе* *](counterinitialize.md) и [**каунтерклеануп**](countercleanup.md) и строки ресурсов.

   Поставщик должен вызывать функции [**каунтеринитиализе**](counterinitialize.md) и [**каунтерклеануп**](countercleanup.md) . **Каунтеринитиализе** вызывает функцию [**перфстартпровидер**](/windows/desktop/api/Perflib/nf-perflib-perfstartprovider) для регистрации поставщика, а также вызывает функцию [**перфсеткаунтерсетинфо**](/windows/desktop/api/Perflib/nf-perflib-perfsetcountersetinfo) для инициализации набора счетчиков. **Каунтерклеануп** вызывает функцию [**перфстоппровидер**](/windows/desktop/api/Perflib/nf-perflib-perfstopprovider) для удаления регистрации поставщика.

3. Включите код шаблона из предыдущего шага в проект и завершите работу поставщика.

   Чтобы завершить работу поставщика, необходимо вызвать функцию [**перфкреатеинстанце**](/windows/desktop/api/Perflib/nf-perflib-perfcreateinstance) для каждого заданного экземпляра набора счетчиков.

   Чтобы задать значения счетчика, вызовите одну из следующих функций:

   - [**перфсетулонгкаунтервалуе**](/windows/desktop/api/Perflib/nf-perflib-perfsetulongcountervalue)
   - [**перфсетулонглонгкаунтервалуе**](/windows/desktop/api/Perflib/nf-perflib-perfsetulonglongcountervalue)
   - [**перфсеткаунтеррефвалуе**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue)

   Преимущество использования [**перфсеткаунтеррефвалуе**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue) заключается в том, что нет необходимости выполнять вызов функции для установки или обновления значения счетчика, просто обновить переменную локального счетчика (переменную, на которую указывает ссылка), а счетчики производительности используют указатель для доступа к значению счетчика.

   Если вы не используете [**перфсеткаунтеррефвалуе**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue), можно использовать следующие функции для увеличения или уменьшения значения счетчика:

   - [**перфдекрементулонгкаунтервалуе**](/windows/desktop/api/Perflib/nf-perflib-perfdecrementulongcountervalue)
   - [**перфдекрементулонглонгкаунтервалуе**](/windows/desktop/api/Perflib/nf-perflib-perfdecrementulonglongcountervalue)
   - [**перфинкрементулонгкаунтервалуе**](/windows/desktop/api/Perflib/nf-perflib-perfincrementulongcountervalue)
   - [**перфинкрементулонглонгкаунтервалуе**](/windows/desktop/api/Perflib/nf-perflib-perfincrementulonglongcountervalue)

   Перед завершением работы поставщика необходимо вызвать [**перфделетеинстанце**](/windows/desktop/api/Perflib/nf-perflib-perfdeleteinstance) для каждого созданного экземпляра набора счетчиков.

   Если вы указали атрибут **callback** в элементе [**provider**](/windows/desktop/PerfCtrs/performance-counters-provider--counters--element) в манифесте или использовали аргумент **-нотификатионкаллбакк** при вызове [КТРПП](ctrpp.md), необходимо реализовать функцию обратного вызова [*контролкаллбакк*](/windows/desktop/api/Perflib/nc-perflib-perflibrequest) . Функция обратного вызова передается в [**каунтеринитиализе**](counterinitialize.md).

   Если при вызове [КТРПП](ctrpp.md)использовался параметр **-меморираутинес** , необходимо реализовать функции обратного вызова [*аллокатемемори*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_alloc) и [*FreeMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_free) . Функции обратного вызова передаются в [**каунтеринитиализе**](counterinitialize.md).

4. При установке поставщика используйте средство LodCtr для записи имени двоичного файла, содержащего локализованные строки ресурсов и идентификаторы ресурсов, в реестр. Дополнительные сведения об использовании LodCtr см. в разделе [схема счетчиков производительности](performance-counters-schema.md).

5. При удалении поставщика используйте средство lodctr для удаления сведений о поставщике из реестра.
