---
description: Поставщик — это библиотека DLL производительности, которая предоставляет клиентам данные счетчиков.
ms.assetid: bbb777fe-b97e-4777-b797-ec8525065610
title: Создание библиотеки DLL расширения производительности
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e1ef4509af77bcc1a4016e494a2834d40162305a837349e32a573cbf36d994d3
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119011322"
---
# <a name="creating-a-performance-extension-dll"></a>Создание библиотеки DLL расширения производительности

> [!IMPORTANT]
> Из-за существенных ограничений производительности и надежности метод предоставления данных счетчиков производительности, описанных в этом разделе, может быть изменен или недоступен в будущем. Вместо этого корпорация Майкрософт рекомендует использовать метод, описанный в разделе [предоставление данных счетчиков с помощью версии 2,0](providing-counter-data-using-version-2-0.md) для создания новых счетчиков производительности и переноса существующих счетчиков производительности для использования этого метода.

[Поставщик v1](providing-counter-data.md) использует библиотеку DLL производительности, которая предоставляет клиентам данные счетчиков. DLL-библиотека производительности должна экспортировать функции [**опенперформанцедата**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)), [**коллектперформанцедата**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc)и [**клосеперформанцедата**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) . Как правило, для экспорта функций из библиотеки DLL используется файл определения модуля (DEF). Система вызывает эти функции, когда потребитель запрашивает данные о производительности.

При первом вызове [**процедура RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa)потребителем или если потребитель использует функцию [**регопенкэй**](/windows/desktop/api/winreg/nf-winreg-regopenkeya) или [**регконнектрегистри**](/windows/desktop/api/winreg/nf-winreg-regconnectregistrya) для открытия `HKEY_PERFORMANCE_DATA` , система вызывает функцию [**опенперформанцедата**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) для каждого поставщика, [зарегистрированного](adding-performance-counters.md) на компьютере. Исключением является, если поставщик указывает список объектов, которые он поддерживает, в `[objects]` разделе файла .INI. В этом случае система вызывает поставщик, только если один из запрашиваемых объектов соответствует объекту из списка.

Функция [**опенперформанцедата**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) предоставляет каждому поставщику возможность инициализировать свои структуры данных о производительности. Затем, если функция **опенперформанцедата** успешно возвращает значение, система вызывает функцию [**коллектперформанцедата**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc) поставщика. Последующие вызовы [**процедура RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) приведут к тому, что система вызывает функцию **коллектперформанцедата** .

Когда потребитель заканчивает сбор данных о производительности, он указывает при `HKEY_PERFORMANCE_DATA` вызове функции [**Ошибка RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) . Это приводит к тому, что система вызывает функцию [**клосеперформанцедата**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) для каждого поставщика. Затем поставщики выгружаются.

Несколько потребителей могут одновременно выполнять накопление данных о производительности. Система вызывает функции [**опенперформанцедата**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) и [**клосеперформанцедата**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) только один раз при каждой загрузке или выгрузке библиотеки DLL.

> [!Note]
> Не забудьте включить в код C++ модификатор extern "C", чтобы компилятор не добавим украшения к именам функций. в противном случае система может не найти ваши функции.

> [!Note]
> При возникновении ошибки при загрузке библиотеки DLL производительности, поиске функций или вызове функций система отключит поставщик для последующих коллекций в рамках одного процесса. Кроме того, если это происходит при выполнении в привилегированном процессе, система добавляет значение **счетчиков производительности "отключить** " для ключа **производительности** , чтобы предотвратить загрузку поставщика в будущем.

Дополнительные сведения о создании библиотеки DLL производительности см. в следующих разделах:

- [Реализация функции Опенперформанцедата](implementing-openperformancedata.md)
- [Реализация функции Коллектперформанцедата](implementing-collectperformancedata.md)
- [Обработка ошибок в библиотеке DLL](error-handling-in-the-dll.md)
- [Ограниченный доступ к библиотекам расширений производительности](restricting-access-to-performance-extension--dlls.md)
- [Примеры библиотек DLL производительности](performance-dll-samples.md)
