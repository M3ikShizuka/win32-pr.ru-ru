---
description: Чтобы создать новый запрос, собирающий данные о производительности из источника или файла журнала в режиме реального времени, вызовите функцию Пдхопенкуери. Функция возвращает маркер запроса, который используется в последующих вызовах функции PDH.
ms.assetid: 6fd4716e-b163-47a3-b0cb-5f9599f8681f
title: Создание запроса
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1175c491ac1336458ed73d375d963f8a68b874bf3fecbb32000730a475d52714
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119775664"
---
# <a name="creating-a-query"></a>Создание запроса

Чтобы создать новый запрос, собирающий данные о производительности из источника или файла журнала в режиме реального времени, вызовите функцию [**пдхопенкуери**](/windows/desktop/api/Pdh/nf-pdh-pdhopenquerya) . Функция возвращает маркер запроса, который используется в последующих вызовах функции PDH.

После создания запроса вызовите функцию [**пдхаддкаунтер**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) для каждого счетчика, который необходимо добавить в запрос. Для указания полного пути к счетчику можно использовать один из следующих методов.

-   Определите путь счетчика как статическую строку. Используйте этот метод, если вы всегда отслеживаете один и тот же счетчик, и если вы знакомы с правильным синтаксисом пути счетчика. Сведения о правильном синтаксисе, используемом для указания счетчика, см. в разделе [Указание пути счетчика](specifying-a-counter-path.md).
-   Инициализируйте [**структуру \_ \_ \_ элементов пути счетчика PDH**](/windows/desktop/api/Pdh/ns-pdh-pdh_counter_path_elements_a) с именами компьютера, объекта, счетчика и экземпляра. Передайте эту структуру в [**пдхмакекаунтерпас**](/windows/desktop/api/Pdh/nf-pdh-pdhmakecounterpatha) , которая вернет путь счетчика для указанных элементов.
-   Укажите путь к счетчику, который содержит подстановочные знаки, и вызовите [**пдхекспандвилдкардпас**](/windows/desktop/api/Pdh/nf-pdh-pdhexpandwildcardpatha) , чтобы получить список имен счетчиков, соответствующих подстановочным знакам в пути. Просмотрите список имен счетчиков и добавьте в запрос нужные счетчики из этого списка.
-   Вызовите функцию [**пдхбровсекаунтерс**](/windows/desktop/api/Pdh/nf-pdh-pdhbrowsecountersa) для вывода диалогового окна, позволяющего пользователю просматривать и выбирать счетчики производительности. Дополнительные сведения см. в разделе [Просмотр счетчиков](browsing-counters.md).

Обратите внимание, что если экземпляр счетчика не существует, [**пдхаддкаунтер**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) не сообщает о состоянии ошибки. Вместо этого он возвращает ошибку \_ Success. Причина такого поведения заключается в том, что неизвестно, существует ли несуществующий экземпляр счетчика или он будет существовать, но еще не был создан.

Отсутствующий экземпляр счетчика будет сообщен как [**пдхколлекткуеридата**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata), [**пдхжетравкаунтервалуе**](/windows/desktop/api/Pdh/nf-pdh-pdhgetrawcountervalue)или [**пдхжетформаттедкаунтервалуе**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue). При вызове **пдхколлекткуеридата** только для одного экземпляра счетчика, и экземпляр счетчика по-прежнему не существует, предполагается, что экземпляр счетчика не существует и функция возвращает PDH \_ No \_ Data. Однако если запрашивается более одного счетчика, **пдхколлекткуеридата** может вернуть ошибку, \_ даже если один из экземпляров счетчиков еще не существует. В этом случае вызовите **пдхжетравкаунтервалуе** или **пдхжетформаттедкаунтервалуе** для каждого из интересующих экземпляров счетчика. Если экземпляр не существует при вызове **пдхжетравкаунтервалуе**, функция возвращает ошибку \_ Success и устанавливает для элемента **Кстатус** в [**\_ \_ счетчике PDH RAW**](/windows/desktop/api/Pdh/ns-pdh-pdh_raw_counter) состояние PDH \_ \_ без \_ экземпляра. Если экземпляр не существует при вызове **пдхжетформаттедкаунтервалуе**, функция возвращает PDH \_ недопустимых \_ данных и устанавливает для элемента **кстатус** в [**PDH \_ FMT \_ COUNTERVALUE**](/windows/desktop/api/Pdh/ns-pdh-pdh_fmt_countervalue) значение PDH \_ кстатус \_ без \_ экземпляра.

Обратите внимание, что путь счетчика, указанный в функции [**пдхаддкаунтер**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) , должен быть локализован. Функция [**пдхадденглишкаунтер**](/windows/desktop/api/Pdh/nf-pdh-pdhaddenglishcountera) предоставляет независимый от локали способ добавления счетчиков производительности в запрос. Эта функция является рекомендуемым способом добавления в запрос независимых от локалей счетчиков.

Чтобы удалить счетчик из запроса, вызовите функцию [**пдхремовекаунтер**](/windows/desktop/api/Pdh/nf-pdh-pdhremovecounter) .

После завершения сбора данных для запроса вызовите функцию [**пдхклосекуери**](/windows/desktop/api/Pdh/nf-pdh-pdhclosequery) , чтобы закрыть запрос и освободить все выделенные системные ресурсы. **Пдхклосекуери** закрывает все дескрипторы счетчиков, связанные с запросом.

 

 



