---
description: Средство КТРПП — это предварительный процессор, который анализирует и проверяет манифест счетчиков.
ms.assetid: 3939f6a1-0a94-429d-a71e-b37f045fea13
title: CTRPP
ms.topic: reference
ms.date: 08/17/2020
topic_type:
- APIRef
- kbSyntax
api_name:
- CTRPP
api_type:
- NA
api_location: ''
ms.openlocfilehash: 8c55e9f3b95d99feabac92574a4be59dacb8ffd7f3b55be07c2bd8fec576da86
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "120033934"
---
# <a name="ctrpp"></a>CTRPP

Средство КТРПП — это предварительный процессор, который выполняет синтаксический анализ и проверку манифеста для поставщика v2. Средство создает `.rc` ресурсы со строками, необходимыми для потребителей поставщика, и создает `.h` заголовок с кодом, который используется для предоставления данных счетчика. Средство КТРПП следует запускать во время сборки поставщика. Созданный код следует использовать в качестве отправной точки при разработке поставщика вместо того, чтобы пытаться самостоятельно создавать этот код.

```syntax
ctrpp -o codeFile -rc rcFile [-legacy] [-MemoryRoutines] [-NotificationCallback] [-prefix prefix] [-ch symFile] [-backcompat] inputFile
```

## <a name="arguments"></a>Аргументы

|Параметр              |Описание
|--------------------|-----------
|*inputFile*         |**Требуется:** Указывает имя `.man` файла (XML-манифеста), определяющего счетчики.
|**-o** *codeFile*   |**Требуется:** Указывает имя `.h` файла кода, создаваемого КТРПП. Этот файл будет содержать встроенные вспомогательные функции C/C++, которые упрощают инициализацию и отинициализацию поставщика.
|**-RC** *rcFile*    |**Требуется:** Указывает имя `.rc` (файла ресурсов), создаваемого КТРПП. Этот файл будет содержать таблицу строк поставщика.
|**-CH** *симфиле*   |Указывает имя необязательного `.h` файла символов, создаваемого КТРПП. Этот файл будет содержать символы C/C++ для имен и идентификаторов GUID каждого набора счетчиков в поставщике.
|**— префикс префикса** |Задает префикс, используемый для переменных и функций, определенных в создаваемом файле заголовка.
|**-Нотификатионкаллбакк**|Изменяет сигнатуру по умолчанию функции [**каунтеринитиализе**](counterinitialize.md) , чтобы она включала параметры для указания имени функций обратного вызова [*контролкаллбакк*](/windows/desktop/api/Perflib/nc-perflib-perflibrequest), [*аллокатемемори*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_alloc)и [*FreeMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_free) . Этот аргумент имеет тот же результат, что и включение `callback` атрибута в элемент [**provider**](/windows/desktop/PerfCtrs/performance-counters-provider--counters--element) .
|**— Перенос** *выходной_файл*|Вместо создания `.h` файлов и `.rc` обновляет манифест *inputFile* до последней версии и сохраняет его в файле *выходной_файл*. Этот параметр нельзя использовать с другими параметрами. Использование: `CTRPP -migrate NewFile.man OldFile.man`
|**-Несовместимость**     |Не **рекомендуется:** в Windows 7 добавлена поддержка поставщиков режима ядра. по умолчанию код, созданный ктрпп для поставщиков режима ядра, будет несовместим с более ранними версиями Windows (драйвер не сможет загрузиться из-за отсутствия `Pcw***` api). Установите `-BackCompat` для обеспечения совместимости с более ранними версиями Windows. Драйвер динамически загрузит необходимые API, и созданный код автоматически отключит поставщик, если интерфейсы API недоступны.
|**-Меморираутинес** |Не **рекомендуется:** При использовании с `-Legacy` параметром включает шаблоны для подпрограмм памяти в созданном коде. В противном случае этот аргумент имеет тот же результат, что и `-NotificationCallback` параметр.
|**-Legacy**         |Не **рекомендуется:** создает `*.h` `*.c` файлы,, `*.rc` и `*_r.h` с помощью шаблонов кода Windows Vista (создает перфаутоинитиализе и перфаутоклеануп вместо каунтеринитиализе и каунтерклеануп). Этот параметр можно использовать с параметрами **-меморираутинес** и **-нотификатионкаллбакк** , но не может использоваться с другими параметрами. Не используйте параметры **-o** или **-RC** с этим параметром. Создаваемые файлы будут называться на основе имени манифеста и будут записаны в каталог, содержащий манифест. Использование: `CTRPP -legacy OldFile.man`

## <a name="remarks"></a>Remarks

Средство КТРПП создает `.h` файл кода, `.rc` файл ресурсов и при необходимости создает `.h` файл символов.

### <a name="using-the-generated-resource-file"></a>Использование созданного файла ресурсов

Средство КТРПП создаст `.rc` файл ресурсов, содержащий локализуемые строки, необходимые потребителям каунтерсетс поставщика.

> [!IMPORTANT]
> Ресурсы из этого файла должны быть добавлены в двоичный файл поставщика, а полный путь к двоичному файлу поставщика должен быть зарегистрирован во время установки манифеста поставщика. Потребители, которым не удается нахождение и загрузка ресурсов, не смогут использовать каунтерсетс поставщика.

Строковые ресурсы должны обрабатываться следующим образом:

- Разработчик редактирует файл манифеста поставщика ( `.man` ), чтобы задать `applicationIdentity` атрибуту поставщика имя двоичного файла поставщика (.DLL, .SYS или .EXE), который будет содержать строковые ресурсы для поставщика и будет установлен в составе компонента поставщика.
- Средство КТРПП считывает манифест поставщика и создает `.rc` файл.
- Средство [RC (Resource Compiler)](../menurc/resource-compiler.md) компилирует данные из файла, созданного КТРПП `.rc` , для создания `.res` файла, содержащего двоичные ресурсы. Это можно сделать путем непосредственного компилирования созданного КТРПП `.rc` файла или путем компиляции другого `.rc` файла, который включает созданный КТРПП `.rc` файл с помощью `#include` директивы.
- Компоновщик внедряет данные из файла, созданного RC, `.res` в двоичный файл поставщика.
- Во время установки двоичный файл поставщика копируется в систему пользователя, а манифест поставщика регистрируется с помощью [средства lodctr](/windows-server/administration/windows-commands/lodctr). Средство lodctr преобразует `applicationIdentity` атрибут манифеста поставщика в полный путь и записывает полный путь к двоичному файлу поставщика в реестре.
  - Если двоичный файл поставщика находится в том же каталоге, что и манифест, используйте: `lodctr.exe /m:"C:\full\manifest\path\manifest.man"` . lodctr объединяет указанный путь манифеста с атрибутом манифеста `applicationIdentity` для формирования полного пути.
  - Или используйте `lodctr.exe /m:"C:\full\manifest\path\manifest.man" "c:\full\binary\path"`. lodctr объединяет указанный двоичный путь с атрибутом манифеста `applicationIdentity` для формирования полного пути.
  - В целях диагностики можно проверить записанный полный путь, проверив `ApplicationIdentity` значение раздела реестра `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Perflib\_V2Providers\{<ProviderGuid>}` .
  - Если в двоичном файле используется MUI для локализации, скопируйте файл MUI вместе с двоичным файлом.
- Во время сбора набора счетчиков потребитель использует записанный полный путь к двоичному файлу поставщика для поиска и загрузки необходимых строк из ресурсов двоичного файла поставщика.

### <a name="using-the-generated-code-file-in-a-user-mode-provider"></a>Использование созданного файла кода в поставщике пользовательского режима

Средство КТРПП создаст `.h` файл кода C/C++. Если атрибут манифеста поставщика `providerType` имеет значение `userMode` , созданный файл кода будет содержать следующие определения, которые полезны при кодировании поставщика пользовательского режима.

- Функция инициализации поставщика с именем [ * **prefix * каунтеринитиализе**](counterinitialize.md).
- Функция очистки поставщика с именем [ * **prefix * каунтерклеануп**](countercleanup.md).
- Глобальная переменная ***provider** _, которая хранит обработчик поставщика, Открытый функцией _ *_prefix_CounterInitialize**. Имя переменной является значением `symbol` атрибута `provider` элемента в манифесте. Эта переменная должна использоваться в вызовах `PerfCreateInstance` , `PerfDeleteInstance` и других интерфейсах API для управления данными поставщика.
- Для каждого CounterSet — глобальная переменная ***CounterSet * GUID** с идентификатором GUID CounterSet. Имя переменной — это значение `counterSet` `symbol` атрибута элемента плюс суффикс GUID, например `MyCounterSetGUID` . Эта переменная должна использоваться в вызовах `PerfCreateInstance` , `PerfDeleteInstance` и других интерфейсах API для управления данными поставщика.
- Для каждого счетчика это макрос ***счетчика*** со значением счетчика `id` . Имя макроса является значением `counter` `symbol` атрибута элемента. Этот макрос следует использовать в вызовах `PerfSetCounterRefValue` , `PerfSetULongLongCounterValue` и других интерфейсах API для настройки данных поставщика.

В именах функций ***префикс*** ссылается на значение `-prefix` параметра командной строки. Если `-prefix` параметр не используется, функции будут называться `CounterInitialize` и `CounterCleanup` .

### <a name="using-the-generated-code-file-in-a-kernel-mode-provider"></a>Использование созданного файла кода в поставщике режима ядра

Средство КТРПП создаст `.h` файл кода C/C++. Если атрибут манифеста поставщика `providerType` имеет значение `kernelMode` , созданный файл кода будет содержать следующие определения, которые полезны при написании кода для каунтерсетс поставщика в режиме ядра:

- Функция инициализации CounterSet с именем <b> *prefix* Register</b>. Эта функция заполняет [регинфо](/windows-hardware/drivers/ddi/wdm/ns-wdm-_pcw_registration_information) структуру, затем вызывает [пкврегистер](/windows-hardware/drivers/ddi/wdm/nf-wdm-pcwregister), помещая полученный маркер регистрации CounterSet в глобальную переменную ***CounterSet*** .
- Функция очистки счетчика с именем <b> *prefix* Отмена регистрации *счетчика*</b>. Эта функция вызывает [пквунрегистер](/windows-hardware/drivers/ddi/wdm/nf-wdm-pcwunregister) для маркера регистрации CounterSet в глобальной переменной ***CounterSet*** .
- Функция создания экземпляра с именем <b> *prefix* создание *счетчика*</b>. Эта функция заполняет массив структур [пквдата](/windows-hardware/drivers/ddi/wdm/ns-wdm-_pcw_data) , а затем вызывает [пквкреатеинстанце](/windows-hardware/drivers/ddi/wdm/nf-wdm-pcwcreateinstance) , используя маркер регистрации CounterSet в глобальной переменной набора ***счетчиков*** .
- Функция очистки экземпляра с именем <b> *prefix*, закрывающая набор *счетчиков*</b>. Эта функция вызывает [пквклосеинстанце](/windows-hardware/drivers/ddi/wdm/nf-wdm-pcwcloseinstance).
- Экземпляр функции Reporting, именуемый <b> *prefix*, добавляет *CounterSet*</b> , используемый из функции обратного вызова CounterSet. Эта функция заполняет массив структур [пквдата](/windows-hardware/drivers/ddi/wdm/ns-wdm-_pcw_data) , а затем вызывает [пкваддинстанце](/windows-hardware/drivers/ddi/wdm/nf-wdm-pcwaddinstance).
- **Windows SDK 20H1 и более поздних версий:** Функция инициализации Регинфо с именем <b> *prefix* инитрегистратионинформатион *CounterSet*</b> для использования в расширенных сценариях. Эта функция заполняет структуру [регинфо](/windows-hardware/drivers/ddi/wdm/ns-wdm-_pcw_registration_information) . Эта функция может использоваться в тех случаях, когда созданный набор <b>*счетчиков* регистров *префиксов*</b> не соответствует вашим потребностям, например, если необходимо настроить значения в структуре регинфо или сохранить возвращенный обработчик в другой переменной.

В именах функций ***префикс*** ссылается на значение `-prefix` параметра командной строки. Если `-prefix` параметр не используется, функции не имеют префикса.

> [!NOTE]
> При наличии обратного вызова CounterSet используется созданная функция <b> добавления *счетчика*</b> . Созданный <b> *префикс* функции создания *счетчиков*</b> и <b> *префиксов* закрытия</b> используются при отсутствии обратного вызова CounterSet.

### <a name="using-the-generated-symbol-file"></a>Использование созданного файла символов

Если в командной строке указан параметр **-CH** , средство КТРПП создаст `.h` файл символов. Этот файл содержит символы C/C++ для имен и идентификаторов GUID каждого набора счетчиков в поставщике. Символы могут использоваться при написании программ, жестко запрограммированных для использования данных из этого CounterSet, с помощью [пользовательских функций PerfLib версии 2](using-the-perflib-functions-to-consume-counter-data.md).

## <a name="requirements"></a>Requirements (Требования)

| Требование             | Значение |
|-------------------------|-------|
| Минимальная версия клиента| Windows \[Только классические приложения Vista\]
| Минимальная версия сервера| Windows Только для \[ настольных приложений сервера 2008\]
