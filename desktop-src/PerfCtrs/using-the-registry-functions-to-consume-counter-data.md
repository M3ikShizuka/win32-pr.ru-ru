---
description: Для получения данных о производительности можно использовать функции реестра.
ms.assetid: feac7b8d-1dee-462c-89dc-bec1ba045da2
title: Использование функций реестра для использования данных счетчика
ms.topic: article
ms.date: 08/17/2020
ms.openlocfilehash: ce2a4ba9992510cb296b037cfd98965410c48939
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105663143"
---
# <a name="using-the-registry-functions-to-consume-counter-data"></a>Использование функций реестра для использования данных счетчика

Используйте [функции реестра](/windows/desktop/SysInfo/registry-functions) для получения данных о производительности из специального `HKEY_PERFORMANCE_DATA` раздела реестра.

Данные о производительности фактически не хранятся в реестре. Вызов функций реестра приводит к тому, что система собирается получить данные от соответствующего поставщика данных о производительности.

> [!Note]
> Для использования данных счетчика обычно не следует использовать функции реестра. Вместо этого следует [использовать функции модуля поддержки данных производительности (PDH)](using-the-pdh-functions-to-consume-counter-data.md). Функции PDH проще в использовании и позволяют избежать многих проблем производительности и надежности, которые могут возникать при неправильном использовании функций реестра.

> [!Note]
> При написании приложений OneCore Windows нельзя использовать функции реестра. Вместо этого используйте [функции-потребители версии PerfLib v2](using-the-perflib-functions-to-consume-counter-data.md).

Функции реестра — это низкоуровневые API для сбора данных от **поставщиков v1**. Функции реестра также поддерживают сбор данных от **поставщиков v2** через слой перевода, который вызывает [функции потребителя v2](using-the-perflib-functions-to-consume-counter-data.md).

Чтобы получить данные о производительности из локальной системы, вызовите функцию [**процедура RegQueryValueEx**](/windows/win32/api/winreg/nf-winreg-regqueryvalueexw) . Используйте `HKEY_PERFORMANCE_DATA` в качестве ключа. Первый вызов открывает ключ. Сначала не нужно открывать ключ явным образом.

Чтобы получить данные о производительности из удаленной системы, вызовите функцию [**регконнектрегистри**](/windows/desktop/api/winreg/nf-winreg-regconnectregistryw) . Используйте имя компьютера удаленной системы и используйте `HKEY_PERFORMANCE_DATA` его в качестве ключа. Этот вызов извлекает ключ, представляющий данные о производительности для удаленной системы. Используйте этот ключ вместо `HKEY_PERFORMANCE_DATA` Key для получения данных.

Не забудьте использовать функцию [**Ошибка RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) , чтобы закрыть маркер к ключу по завершении получения данных о производительности. Это важно для локальных и удаленных вариантов:

- `RegCloseKey(HKEY_PERFORMANCE_DATA)` фактически не закрывает обработчик реестра, но очищает все кэшированные данные и освобождает загруженные библиотеки DLL производительности.
- `RegCloseKey(hkeyRemotePerformanceData)` закрывает обработчик в реестре удаленного компьютера.

> [!IMPORTANT]
> Не вызывайте `RegCloseKey(HKEY_PERFORMANCE_DATA)` во время `DLL_PROCESS_DETACH` .

`lpValueName`Для указания извлекаемой информации используется параметр функции [**процедура RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) . В следующей таблице перечислены значения, которые можно указать для `lpValueName` . Обратите внимание, что строки значений не учитывают регистр.

|Значение|Описание
|-----|-----------
|`Global`| Получает данные о производительности для всех объектов производительности, зарегистрированных на компьютере, за исключением тех, которые включены в `Costly` категорию.
|`OLD_Global`| **Windows Vista и более поздние версии:** Получает данные о производительности для всех объектов производительности **v1** , зарегистрированных на компьютере, за исключением тех, которые включены в `Costly` категорию. Используйте этот параметр вместо того, `Global` чтобы собирать ненужные данные поставщика v2, если известно, что интересующие данные поступают от поставщика v1.
|`n1 n2 ...`| Получает данные производительности для одного или нескольких объектов производительности. Укажите десятичный индекс, связанный с каждым объектом, который необходимо получить, в списке с разделителями-пробелами. Например, если требуется получить объекты системы и памяти и определить, что индексы соответствующих строк имени — 2 и 4, укажите строку `"2 4"` . Обратите внимание, что запрос может возвращать разное количество объектов, чем вы запрашивали. Это может произойти, если указанный объект недоступен, если указанный объект зависит от типа другого объекта или если поставщик иным образом возвращает данные, которые не были запрошены напрямую. Например, потоки зависят от процессов, поэтому при запросе данных из `Thread` объекта результаты будут содержать данные из `Process` объекта.
|`Counter n`| Получает строки имен для указанного идентификатора языка, например "Английский для" `Counter 9` . Используйте возвращенные строки имени, чтобы найти индекс, соответствующий заданному имени, или найти имя, соответствующее заданному индексу. Дополнительные сведения см. в разделе [Получение имен счетчиков и текста справки](retrieving-counter-names-and-help-text.md) . Обратите внимание, что возвращаемый список содержит как имена объектов (CounterSet), так и имена счетчиков — нет простого способа определить, является ли имя именем объекта или именем счетчика.
|`Help n`| Извлекает строки справки для указанного идентификатора языка, например "Английский (для)" `Help 9` . Используйте возвращенные строки справки, чтобы найти описания, соответствующие объектам (CounterSet) или индексам справки по счетчикам. Дополнительные сведения см. в разделе [Получение имен счетчиков и текста справки](retrieving-counter-names-and-help-text.md) .
|`Costly`| Не **рекомендуется:** Получает данные о производительности для типов объектов, данные которых затратны для накопления с точки зрения процессорного времени или использования памяти. На сильно загруженном компьютере эта коллекция может занять несколько минут. Коллекцию следует выполнять в рабочем потоке, если приложение должно отвечать пользователю во время сбора данных.

Дополнительные сведения о формате данных производительности, возвращаемых реестром, см. в разделе [Формат данных производительности](performance-data-format.md).

Пример получения имен и описаний зарегистрированных счетчиков на компьютере см. в разделе [Получение имен счетчиков и текста справки](retrieving-counter-names-and-help-text.md).

Пример, который обращается к компонентам данных производительности, см. в разделе [Отображение имен объектов, экземпляров и счетчиков](displaying-object-instance-and-counter-names.md).

Пример, который извлекает, вычисляет и печатает значения счетчиков, см. в разделе [Получение данных счетчика](retrieving-counter-data.md) и [Вычисление значений счетчиков](calculating-counter-values.md).
