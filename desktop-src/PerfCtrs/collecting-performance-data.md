---
description: После создания запроса и добавления в него счетчиков вызовите функцию Пдхколлекткуеридата, чтобы получить текущие необработанные данные для всех счетчиков в запросе.
ms.assetid: 2534d387-a280-4716-9a9d-3e42f40e2f92
title: Сбор данных о производительности
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 79f65280190e67e27783ea7e7387eac0e348aad1a53ad016df3010ae0bfd2ea9
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119061242"
---
# <a name="collecting-performance-data"></a>Сбор данных о производительности

После [создания запроса](creating-a-query.md) и добавления в него счетчиков вызовите функцию [**пдхколлекткуеридата**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) , чтобы получить текущие необработанные данные для всех счетчиков в запросе.

Многие счетчики, например счетчики скорости, занимают два образца данных для вычисления форматированного значения данных. PDH сохраняет данные для текущего примера и ранее собранного примера. В следующей процедуре описывается сбор значений счетчиков, требующих двух выборок для вычисления отображаемого значения.

**Сбор значений счетчика, требующих двух выборок для вычисления воспроизводимого значения**

1.  Вызовите [**пдхколлекткуеридата**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) , чтобы получить первый пример.
2.  Вызовите функцию [**Sleep**](/windows/desktop/api/synchapi/nf-synchapi-sleep) , чтобы подождать минимум одну секунду между коллекциями.
3.  Вызовите [**пдхколлекткуеридата**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) еще раз, чтобы получить второй пример.
4.  Вызовите функцию [**пдхжетформаттедкаунтервалуе**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue) , чтобы вычислить отображаемое значение.
5.  Повторите шаги с 2 по 4.

В качестве альтернативы реализации периода ожидания можно вызвать функцию [**пдхколлекткуеридатаекс**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydataex) , которая создает поток времени, который ожидает заданный промежуток времени, собирает пример, а затем запускает определяемое приложением событие.

Если требуется запросить данные о производительности из файла журнала, можно также определить диапазон времени. Диапазон времени ограничивает запрос образцами, собранными в пределах диапазона времени (каждый пример содержит отметку времени для момента сбора данных). Дополнительные сведения о том, как задать и получить диапазоны времени, см. в разделе [Задание диапазона времени для запроса](setting-a-time-range-for-a-query.md).

Если вы хотите получить данные о производительности и записать их в файл журнала, вместо вызова [**пдхколлекткуеридата**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata)следует вызвать функцию [**пдхупдателог**](/windows/desktop/api/Pdh/nf-pdh-pdhupdateloga) . Дополнительные сведения см. в разделе [Работа с файлами журналов](working-with-log-files.md) и [запись данных о производительности в файл журнала](writing-performance-data-to-a-log-file.md).

Дополнительные сведения о вычислении отображаемого демонстрационного значения см. в разделе [Отображение данных о производительности](displaying-performance-data.md).

## <a name="understanding-multiple-processor-counters"></a>Основные сведения о нескольких счетчиках процессоров

Некоторые счетчики производительности были разработаны для однопроцессорных систем и могут быть неточными для многопроцессорных компьютеров. Например, процесс ограничен 100% от одного процессора; Однако его потоки могут использовать несколько процессоров, что позволяет суммировать более 100 процентов.

\\ \_ Значение счетчика "процессор (всего) \\ % загруженности процессора" представляет собой среднее использование всех процессоров. Например, если у вас есть два процессора, по одному на 100 процентов, а второй — 0%, этот счетчик сообщит 50%. Таким образом, диапазон составляет от 0 до 100.

\\Значение счетчика "процесс (X) \\ % времени процесса" — это сумма использования процессора всеми потоками процесса X. Например, на компьютере с двумя процессорами, если процесс состоит из двух потоков, один из которых занимает 75% ресурсов ЦП, а второй — 80 процентов другого ЦП, этот счетчик сообщит об 155%. Диапазон для этого счетчика — от 0 до 100 \* ProcessorCount.

* * Windows Server 2003 и Windows XP: * *

Можно получить значения за пределами ожидаемого диапазона значений загрузки ЦП. Чтобы вычислить процент загрузки ЦП, для PDH требуется два образца (каждый с необработанным значением и отметка времени). Так как PDH использует только имя экземпляра для сопоставления процессов, иногда может использоваться два образца из разных процессов. Например, если выполняется выборка из трех процессов и один процесс завершается после третьего примера, другой процесс переместится в слот, освобожденный этим завершенным процессом. В результате отформатированный счетчик предоставит неверное значение при форматировании четвертого примера, так как он использует третий пример из завершенного процесса и четвертый пример из процесса, который был перемещен в слот прерванного процесса.

В следующей таблице показано, как это может произойти при завершении процесса сбора данных. В таблице показаны пять выборок значений счетчиков для трех экземпляров процесса X. Эти примеры собираются через одну секунду. После сбора третьего примера процесс X в слоте 1 завершается. Когда процесс X в слоте 1 завершается, процесс X в слоте 2 перемещается в слот 1. Когда вы соберете четвертый пример для процесса X в слоте 2, первое значение теперь равно 20, а не 1 000, а второе значение — 1 500. При форматировании значения счетчика выдается 1 480 миллисекунд вместо ожидаемого 500 миллисекунд. При форматировании пятого значения выборки должно быть получено ожидаемое значение.

| Образец   | Слот 0 для процесса X | Слот 1 для процесса X           | Слот 2 для процесса X                     |
|----------|----------------------|--------------------------------|------------------------------------------|
| Пример 1 | 0                    | 0                              | 0                                        |
| Пример 2 | 20                   | 10                             | 500                                      |
| Пример 3 | 40                   | 20                             | 1000                                    |
| Пример 4 | 60                   | 1 500 (из первого слота 2) | Неприменимо. Теперь собраны в слот 1. |
| Пример 5 | 80                   | 2 000                          | Неприменимо. Теперь собраны в слот 1. |



 

 

 
