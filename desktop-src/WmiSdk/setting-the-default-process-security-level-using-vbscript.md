---
title: Задание уровня безопасности процесса по умолчанию с помощью VBScript
description: Скрипт может использовать параметры проверки подлинности и олицетворения WMI по умолчанию. Однако скрипту может потребоваться подключение с большей безопасностью или подключение к пространству имен, для которого требуется зашифрованное соединение.
ms.assetid: cb477224-3117-45e4-9271-613b58e48b6e
ms.tgt_platform: multiple
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 03fe69228021fe8d3f36f03e60cb2366b6132f59
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104272576"
---
# <a name="set-the-default-process-security-level-with-vbscript"></a>Задание уровня безопасности процесса по умолчанию с помощью VBScript

Скрипт может использовать параметры проверки подлинности и олицетворения WMI по умолчанию. Однако скрипту может потребоваться подключение с большей безопасностью или подключение к пространству имен, для которого требуется зашифрованное соединение. Дополнительные сведения см. в разделе [Setting Намепаце Security дескрипторы](setting-namespace-security-descriptors.md) и [требуется зашифрованное соединение с пространством имен](requiring-an-encrypted-connection-to-a-namespace.md).

В самом простом случае скрипт может использовать параметры проверки подлинности и олицетворения по умолчанию. Как правило, WMI работает на узле общей службы и использует ту же проверку подлинности, что и другие процессы в узле. Если вы хотите запустить процесс WMI с другим уровнем проверки подлинности, запустите WMI с помощью команды [**Winmgmt**](winmgmt.md) с параметром **/стандалонехост** и установите уровень проверки подлинности для WMI как обычно. Дополнительные сведения см. в разделе [обслуживание безопасности WMI](maintaining-wmi-security.md).

Следующий скрипт использует параметры по умолчанию для уровней олицетворения и проверки подлинности.


```VB
strComputer = "." 
Set objServices = GetObject("winmgmts:\\" _
    & strComputer & "\root\CIMV2") 
set objProcessSet = objServices.ExecQuery _
     ("SELECT Name FROM Win32_Process",,48)
For Each Process in objProcessSet
    WScript.Echo Process.Name
Next
```



Можно также использовать [моникер](constructing-a-moniker-string.md) в вызове [**GetObject**](https://msdn.microsoft.com/library/e9waz863(v=VS.71).aspx)и задать параметры безопасности по умолчанию, как показано в следующем примере.


```VB
strComputer = "." 
Set objServices = GetObject( _
    "winmgmts:{impersonationLevel=impersonate," _
    & "authenticationLevel=pktPrivacy}!root/cimv2")
set objProcessSet = objServices.ExecQuery _
     ("SELECT Name FROM Win32_Process",,48)
For Each Process in objProcessSet
    WScript.Echo Process.Name
Next
```



Дополнительные сведения о настройке различных уровней олицетворения или проверки подлинности в сценарии, а также о настройке значений по умолчанию для компьютера см. в следующих разделах:

-   [Изменение учетных данных проверки подлинности по умолчанию с помощью VBScript](#changing-the-default-authentication-credentials-using-vbscript)
-   [Изменение параметров олицетворения по умолчанию с помощью VBScript](#changing-the-default-impersonation-levels-using-vbscript)
-   [Настройка уровня олицетворения по умолчанию с помощью реестра](#setting-the-default-impersonation-level-using-the-registry)
-   [Доступ к объекту Свбемсекурити в VBScript](#accessing-the-swbemsecurity-object-in-vbscript)
-   [**свбемсекурити**](swbemsecurity.md)

## <a name="changing-the-default-authentication-credentials-using-vbscript"></a>Изменение учетных данных проверки подлинности по умолчанию с помощью VBScript

Можно изменить уровень проверки подлинности в скрипте, используя строку [моникера](constructing-a-moniker-string.md) , а также объекты [**SWbemLocator**](swbemlocator.md) и [**свбемсекурити**](swbemsecurity.md) .

Уровень проверки подлинности должен быть установлен в соответствии с требованиями целевой операционной системы, к которой выполняется подключение. Дополнительные сведения см. в разделе [подключение между разными операционными системами](/windows/desktop/WmiSdk/troubleshooting-a-remote-wmi-connection).

В следующем примере кода VBScript показано, как изменить уровень проверки подлинности в скрипте, получающем данные о свободном месте с удаленного компьютера с именем "Server1".


```VB
strComputer = "Server1"
Set objWMIService = GetObject("winmgmts:{authenticationLevel=Pkt}!\\" _
    & strComputer & "\root\cimv2")
Set colDisks = objWMIService.ExecQuery ("Select * from Win32_LogicalDisk")
For each objDisk in colDisks
    Wscript.Echo "DeviceID: " & vbTab & objDisk.DeviceID & vbNewLine & _
        "FreeSpace: " & vbTab & objDisk.FreeSpace 
    NextstrComputer = "." 
    Set objServices = GetObject( "winmgmts:{impersonationLevel=impersonate," _
                               & "authenticationLevel=pktPrivacy}!root/cimv2")
    Set objProcessSet = objServices.ExecQuery("SELECT Name FROM Win32_Process",,48)
    For Each Process in objProcessSet
        WScript.Echo Process.Name
    Next
Next
```



В поднаборе моникера скрипта соединения с WMI используйте короткое имя, указанное в столбце "имя моникера/описание" приведенной ниже таблицы. Например, в следующем сценарии для уровня проверки подлинности задано значение **вбемаусентикатионлевелпктинтегрити**.


```VB
SetobjWMIService = GetObject( _
    "winmgmts:{authenticationLevel=pktPrivacy}!root\cimv2")
```



В следующей таблице перечислены уровни проверки подлинности, которые можно задать. Эти уровни определяются в Wbemdisp. tlb в перечислении [вбемаусентикатионлевеленум](/windows/desktop/api/Wbemdisp/ne-wbemdisp-wbemauthenticationlevelenum).



| Имя/значение                                                      | Описание                                                                                                                                                                                                                                                                                            |
|-----------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **вбемаусентикатионлевелдефаулт**<br/> 0<br/>      | Моникер: по умолчанию<br/> Инструментарий WMI использует параметр проверки подлинности Windows по умолчанию. Это рекомендуемый параметр, позволяющий инструментарию WMI согласовывать уровень, требуемый сервером, который возвращает данные. Однако если для пространства имен требуется шифрование, используйте **вбемаусентикатионлевелпктприваци**.<br/> |
| **вбемаусентикатионлевелноне**<br/> 1<br/>         | Моникер: нет<br/> Не использует проверку подлинности.<br/>                                                                                                                                                                                                                                            |
| **вбемаусентикатионлевелконнект**<br/> 2<br/>      | Моникер: Connect<br/> Проверяет подлинность учетных данных клиента только в том случае, если клиент устанавливает связь с сервером.<br/>                                                                                                                                                    |
| **вбемаусентикатионлевелкалл**<br/> 3<br/>         | Вызов<br/> Проверка подлинности выполняется только в начале каждого вызова, когда сервер получает запрос.<br/>                                                                                                                                                                                      |
| **вбемаусентикатионлевелпкт**<br/> 4<br/>          | Моникер: PKT<br/> Проверяет, что все полученные данные получены от ожидаемого клиента.<br/>                                                                                                                                                                                                   |
| **вбемаусентикатионлевелпктинтегрити**<br/> 5<br/> | Моникер: Пктинтегрити<br/> Проверка подлинности и проверка того, что ни один из данных, передаваемых между клиентом и сервером, не был изменен.<br/>                                                                                                                                                  |
| **вбемаусентикатионлевелпктприваци**<br/> 6<br/>   | Моникер: Пктприваци<br/> Проверяет подлинность всех предыдущих уровней олицетворения и шифрует значение аргумента для каждого удаленного вызова процедуры. Используйте этот параметр, если для пространства имен, к которому выполняется подключение, требуется зашифрованное соединение.<br/>                                               |



 

Чтобы определить успешный вызов, проверьте возвращаемое значение после изменения уровня проверки подлинности.

Например, поскольку локальные соединения всегда имеют уровень проверки подлинности **вбемаусентикатионлевелпктприваци**, в следующем примере не удается установить уровень проверки подлинности, так как он подключается к локальному компьютеру.


```VB
strComputer = "."
Set objWMIService = GetObject("winmgmts:" _
    & "{impersonationLevel=impersonate," _
    & "authenticationLevel=pktPrivacy}!" _
    & "\\" & strComputer & "\root\cimv2")
```



Поставщик может установить безопасность для пространства имен таким образом, чтобы никакие данные не возвращались, если только вы не используете конфиденциальность пакетов (Пктприваци) в подключении к этому пространству имен. Это гарантирует, что данные шифруются по мере пересечения сети. При попытке задать более низкий уровень проверки подлинности будет получено сообщение об отказе в доступе. Дополнительные сведения см. в разделе [Защита пространств имен WMI](securing-wmi-namespaces.md).

## <a name="changing-the-default-impersonation-levels-using-vbscript"></a>Изменение уровней олицетворения по умолчанию с помощью VBScript

При вызове API скриптов для WMI рекомендуется использовать значения по умолчанию, которые WMI предоставляет для уровня олицетворения. Для удаленных вызовов и некоторых поставщиков с более чем одним прыжком к сети требуется более высокий уровень олицетворения, чем использование WMI. Если уровень олицетворения недостаточно, поставщик может отказаться от запроса или предоставить неполные сведения.

Если уровень олицетворения не задан ни в моникере, ни при установке [**свбемсекурити. имперсонатионлевел**](swbemsecurity-impersonationlevel.md) защищаемого объекта, установите уровень олицетворения DCOM по умолчанию для операционной системы. Уровень олицетворения должен быть установлен в соответствии с требованиями целевой операционной системы, к которой выполняется подключение. Дополнительные сведения см. в разделе [подключение между разными операционными системами](/windows/desktop/WmiSdk/troubleshooting-a-remote-wmi-connection).

В следующем примере кода VBScript показано изменение уровня олицетворения в том же скрипте, показанном выше.


```VB
strComputer = "Server1"
Set objWMIService = GetObject("winmgmts:{impersonationLevel=Impersonate}!\\" _
                              & strComputer & "\root\cimv2")
Set colDisks = objWMIService.ExecQuery("Select * from Win32_LogicalDisk")
For each objDisk in colDisks
Wscript.Echo "DeviceID: " & vbTab & objDisk.DeviceID & vbNewLine & _
             "FreeSpace: " & vbTab & objDisk.FreeSpace 
Next
```



В следующей таблице перечислены уровни проверки подлинности в [вбемимперсонатионлевеленум](/windows/desktop/api/Wbemdisp/ne-wbemdisp-wbemimpersonationlevelenum) , использующие.



| Имя/значение                                                    | Описание                                                                                                                                                                                                                         |
|---------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **вбемимперсонатионлевеланонимаус**<br/> 1<br/>   | Моникер: Anonymous<br/> Скрывает учетные данные вызывающей стороны. При этом уровне олицетворения во время вызовов, адресованных WMI, возможны сбои.<br/>                                                                                                  |
| **вбемимперсонатионлевелидентифи**<br/> 2<br/>    | Моникер: Identify<br/> позволяет объектам запрашивать учетные данные вызывающей стороны. При этом уровне олицетворения во время вызовов, адресованных WMI, возможны сбои.<br/>                                                                                 |
| **вбемимперсонатионлевелимперсонате**<br/> 3<br/> | Моникер: IMPERSONATE<br/> позволяет объектам использовать учетные данные вызывающей стороны. Это рекомендуемый уровень олицетворения для API-интерфейсов сценариев для вызовов WMI.<br/>                                                        |
| **вбемимперсонатионлевелделегате**<br/> 4<br/>    | Моникер: Delegate<br/> Позволяет объектам разрешать другим объектам использовать учетные данные вызывающей стороны. Это олицетворение будет работать с API-интерфейсом сценариев для вызовов инструментария WMI, но может представлять ненужные риски безопасности.<br/> |



 

В следующем примере показано, как задать олицетворение в строке моникера при получении конкретного экземпляра [**\_ процесса Win32**](/windows/desktop/CIMWin32Prov/win32-process).


```VB
Set object = GetObject("winmgmts:{impersonationLevel=impersonate}!root\cimv2:Win32_Process.Handle='0'")
```



Дополнительные сведения см. [в разделе Создание приложения WMI или скрипта](creating-a-wmi-application-or-script.md).

## <a name="setting-the-default-impersonation-level-using-the-registry"></a>Настройка уровня олицетворения по умолчанию с помощью реестра

Если у вас есть доступ к реестру, можно также задать раздел реестра уровня олицетворения по умолчанию. Этот ключ указывает, какой уровень олицетворения использует API скриптов для инструментария WMI, если не указано иное. Следующий путь определяет путь реестра.

**HKey \_ По локального \_ компьютера** \\ **программное обеспечение** \\ **Microsoft** \\ **WBEM** \\ **Скрипт** \\ **уровень олицетворения по умолчанию**

По умолчанию раздел реестра имеет значение 3, указывая уровень олицетворения IMPERSONATE. Некоторые поставщики могут потребовать более высокого уровня олицетворения.

## <a name="accessing-the-swbemsecurity-object-in-vbscript"></a>Доступ к объекту Свбемсекурити в VBScript

Другим способом установки уровня олицетворения является объект безопасности [**свбемсекурити**](swbemsecurity.md) , который отображается как свойство [**безопасности \_**](swbemservices-security-.md) объектов [**SwbemServices**](swbemservices.md), [**SWbemObject**](swbemobject.md), [**SWbemObjectSet**](swbemobjectset.md), [**свбемевентсаурце**](swbemeventsource.md), [**свбемобжектпас**](swbemobjectpath.md)и [**SwbemLocator**](swbemlocator.md) .

Инструментарий WMI передает параметр безопасности родительского объекта потомкам исходного объекта. Таким образом, можно задать уровень олицетворения объекта [**SwbemServices**](swbemservices.md) после входа в WMI и вызовов API, используя этот объект или созданные из него объекты, такие как объекты типа [**SWbemObject**](swbemobject.md).

## <a name="related-topics"></a>См. также

<dl> <dt>

[Подключение к инструментарию WMI на удаленном компьютере](connecting-to-wmi-on-a-remote-computer.md)
</dt> <dt>

[Защита клиентов скриптов](securing-scripting-clients.md)
</dt> </dl>

 

