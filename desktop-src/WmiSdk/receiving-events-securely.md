---
description: Временные и постоянные потребители имеют разные методы защиты доставки событий.
ms.assetid: cd02e5db-f9e2-438b-9632-0a1387a6d4e3
ms.tgt_platform: multiple
title: Безопасное получение событий
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d64db5b0289abd9a43caee6ddb3b68da94a9560b0ea8f591d95ee472cf900b4d
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118316531"
---
# <a name="receiving-events-securely"></a>Безопасное получение событий

Временные и постоянные потребители имеют разные методы защиты доставки событий.

В этом разделе обсуждаются следующие разделы:

-   [Защита временных потребителей](#securing-temporary-consumers)
-   [Защита постоянных потребителей](#securing-permanent-consumers)
-   [Защита постоянной подписки](#securing-the-permanent-subscription)
-   [Установка Administrator-Only SD](#setting-an-administrator-only-sd)
-   [Олицетворение удостоверения поставщика событий](#impersonating-the-event-provider-identity)
-   [Идентификаторы безопасности и постоянные подписки](#sids-and-permanent-subscriptions)
-   [Создание постоянных подписок с использованием учетных записей домена](#creating-permanent-subscriptions-using-domain-accounts)
-   [Связанные темы](#related-topics)

## <a name="securing-temporary-consumers"></a>Защита временных потребителей

[*Временные потребители*](gloss-t.md) выполняются до перезагрузки системы или остановки инструментария WMI, но не могут быть запущены при возникновении определенного события. Например, вызов [**SWbemServices.Exeкнотификатионкуерясинк**](swbemservices-execnotificationqueryasync.md) создает временный потребитель.

Вызовы [**SWbemServices.Exeкнотификатионкуери**](swbemservices-execnotificationquery.md) или [**IWbemServices:: ексекнотификатионкуери**](/windows/desktop/api/WbemCli/nf-wbemcli-iwbemservices-execnotificationquery) создают временные потребители событий. Временные потребители не могут контролировать, кто предоставляет события создаваемому [*приемнику*](gloss-s.md) событий.

Вызовы методов [**ексекнотификатионкуери**](swbemservices-execnotificationquery.md) могут выполняться синхронно, [*полусинхронном*](gloss-s.md)или асинхронно. Например, [**SWbemServices.Exeкнотификатионкуери**](swbemservices-execnotificationquery.md) является синхронным методом, который может вызываться полусинхронном в зависимости от того, как задан параметр *ифлагс* . [**SWbemServices.Exeкнотификатионкуерясинк**](swbemservices-execnotificationqueryasync.md) является асинхронным вызовом.

Имейте в виду, что обратный вызов приемника для асинхронных версий этих вызовов может быть не возвращен на том же уровне проверки подлинности, что и вызов созданного скрипта. Поэтому рекомендуется использовать семисинчронаус вместо асинхронных вызовов. Если требуется асинхронное взаимодействие, см. статью [вызов метода](calling-a-method.md) и [Настройка безопасности при асинхронном вызове](setting-security-on-an-asynchronous-call.md).

Подписчики скриптов не могут проверить права доступа поставщика событий, чтобы предоставить события приемнику, созданному сценарием. Поэтому рекомендуется, чтобы вызовы [**SWbemServices.Exeкнотификатионкуери**](swbemservices-execnotificationquery.md) использовали семисинчронаус форму вызова и использовали определенные параметры безопасности. Дополнительные сведения см. в разделе [осуществление вызова семисинчронаус с помощью VBScript](making-a-semisynchronous-call-with-vbscript.md).

## <a name="securing-permanent-consumers"></a>Защита постоянных потребителей

[*Постоянные потребители*](gloss-p.md) имеют постоянную подписку на события от поставщика событий, который будет сохранен после перезапуска операционной системы. Поставщик событий, поддерживающий постоянные потребители, является [*поставщиком потребителей событий*](gloss-e.md). Если поставщик событий не выполняется при возникновении события, Инструментарий WMI запускает поставщик, когда ему требуется доставка событий. WMI определяет, в какой поставщик потребителей должны доставляться события, на основе экземпляра [**\_ \_ евентконсумерпровидеррегистратион**](--eventconsumerproviderregistration.md) , который связывает экземпляр [**\_ \_ Win32Provider**](--win32provider.md) поставщика с [*логическим классом-получателем*](gloss-l.md) , определенным поставщиком потребителя. Дополнительные сведения о роли поставщиков потребителей см. в разделе [написание поставщика событий](writing-an-event-consumer-provider.md).

Постоянные потребители могут управлять отправкой событий и поставщиков событий для управления доступом к своим событиям.

Клиентские скрипты и приложения создают экземпляры класса логического потребителя в рамках подписки. Класс логического потребителя определяет, какие сведения содержит событие, что может делать клиент с событием и как доставляется событие.

[Классы стандартных потребителей](standard-consumer-classes.md) WMI предоставляют примеры роли для классов логических потребителей. Дополнительные сведения см. [в разделе Мониторинг и реагирование на события с помощью стандартных потребителей](monitoring-and-responding-to-events-with-standard-consumers.md).

## <a name="securing-the-permanent-subscription"></a>Защита постоянной подписки

Постоянные подписки имеют большую вероятность вызвать проблемы безопасности в WMI и, следовательно, предъявляют следующие требования к безопасности.

-   Логический экземпляр потребителя, [**\_ \_ EventFilter**](--eventfilter.md)и экземпляры [**\_ \_ филтертоконсумербиндинг**](--filtertoconsumerbinding.md) должны иметь один и тот же идентификатор безопасности (SID) в свойстве **креаторсид** . Дополнительные сведения см. [в разделе поддержание одного и того же идентификатора безопасности во всех экземплярах постоянной подписки](#sids-and-permanent-subscriptions).
-   Учетная запись, создающая подписку, должна быть либо учетной записью домена с правами локального администратора, либо локальной учетной записью группы администраторов. Использование идентификатора безопасности группы администраторов позволяет подписке продолжать работу на локальном компьютере, даже если она отключена от сети. Использование учетной записи домена позволяет точно идентифицировать пользователя.

    Однако если компьютер не подключен, а создание учетной записи является учетной записью домена, происходит сбой потребителя, так как WMI не может проверить удостоверение учетной записи. Чтобы избежать сбоя подписки, если компьютер отключен от сети, используйте идентификатор безопасности группы администраторов для подписки. В этом случае следует убедиться, что учетная запись LocalSystem может получать доступ к данным членства в домене. Некоторые поставщики потребителей событий имеют особенно высокий уровень безопасности, так как незаконная подписка может привести к существенному повреждению. Примерами являются стандартные потребители, [**активескриптевентконсумер**](activescripteventconsumer.md) и [**коммандлинивентконсумер**](commandlineeventconsumer.md).

-   Постоянную подписку можно настроить на прием событий только от конкретных удостоверений поставщиков событий. Установите дескриптор безопасности в свойстве **евентакцесс** экземпляра [**\_ \_ EventFilter**](--eventfilter.md) на удостоверения поставщика событий. Инструментарий WMI сравнивает удостоверение поставщика событий с дескриптором безопасности, чтобы определить, имеет ли поставщик **WBEM доступ к \_ \_ публикации** . Дополнительные сведения см. в разделе [константы безопасности WMI](wmi-security-constants.md).

    Если фильтр разрешает доступ к удостоверению поставщика событий, он также доверяет этому событию. Это позволяет потребителю, получившим событие, вызывать делегированное событие.

    **Примечание**  .  Значение по умолчанию для дескриптора безопасности в **евентакцесс** — **null**, что позволяет получить доступ ко всем. Для повышения безопасности событий рекомендуется ограничить доступ в экземпляре подписки [**\_ \_ EventFilter**](--eventfilter.md) .

## <a name="setting-an-administrator-only-sd"></a>Установка Administrator-Only SD

В следующем примере кода C++ создается дескриптор безопасности только для администраторов на экземпляре [**\_ \_ EventFilter**](--eventfilter.md) . В этом примере создается дескриптор безопасности с использованием [языка определения дескрипторов безопасности](/windows/desktop/SecAuthZ/security-descriptor-definition-language) (SDDL). Дополнительные сведения о подсистеме **WBEM \_ right \_** см. в разделе [константы безопасности WMI](wmi-security-constants.md).


```C++
// Create SD that allows only administrators 
//    to send events to this filter. 
// The SDDL settings are O:BAG:BAD:(A;;0x80;;;BA)
// Set the EventAccess property in the 
//    IWbemClassObject of the __EventFilter instance. 
   long lMask = WBEM_RIGHT_PUBLISH;
     WCHAR wBuf[MAX_PATH];
     _ltow( lMask, wBuf, 16 );
 
HRESULT hRes = pEventFilterInstance->Put( L"EventAccess", 0,
    &_variant_t( L"O:BAG:BAD:(A;;0x80;;;BA)" ), NULL );
```



Для предыдущего примера кода требуются следующие инструкции Reference и \# include.


```C++
#define _WIN32_DCOM
#include <wbemidl.h>
#include <comdef.h>

#pragma comment(lib, "wbemuuid.lib")
```



## <a name="impersonating-the-event-provider-identity"></a>Олицетворение удостоверения поставщика событий

Постоянному потребителю может потребоваться олицетворение поставщика событий для обработки события. Постоянные потребители могут олицетворять только поставщика событий, только если выполняются следующие условия.

-   Экземпляр [**\_ \_ филтертоконсумербиндинг**](--filtertoconsumerbinding.md) имеет свойство **маинтаинсекуритиконтекст** со значением **true**.
-   Событие доставляется в том же контексте безопасности, в котором находился поставщик при создании события. Только потребитель, реализованный как библиотека DLL, внутрипроцессный потребитель, может принимать события в контексте безопасности поставщика. Дополнительные сведения о безопасности внутрипроцессного поставщика и потребителей см. в разделе [размещение и безопасность поставщика](provider-hosting-and-security.md).
-   Поставщик событий выполняется в процессе, допускающем олицетворение.

Учетная запись, выполняющая процесс потребителя, должна иметь полный доступ на **\_ запись** к репозиторию WMI (также известному как репозиторий CIM). В подписке экземпляры [**\_ \_ филтертоконсумербиндинг**](--filtertoconsumerbinding.md), [**\_ \_ евентконсумер**](--eventconsumer.md)и [**\_ \_ EventFilter**](--eventfilter.md) должны иметь одинаковое значение индивидуального идентификатора безопасности (SID) в свойстве **креаторсид** . WMI сохраняет идентификатор безопасности в **креаторсид** для каждого экземпляра.

## <a name="sids-and-permanent-subscriptions"></a>Идентификаторы безопасности и постоянные подписки

Постоянная подписка не работает, если привязка, потребитель и фильтр созданы не одним пользователем. Это означает, что [**\_ \_ филтертоконсумербиндинг**](--filtertoconsumerbinding.md), [**\_ \_ евентконсумер**](--eventconsumer.md)и [**\_ \_ EventFilter**](--eventfilter.md) должны иметь одинаковое значение индивидуального идентификатора безопасности (SID) в свойстве **креаторсид** . Windows Инструментарий управления (WMI) сохраняет это значение.

## <a name="creating-permanent-subscriptions-using-domain-accounts"></a>Создание постоянных подписок с использованием учетных записей домена

При использовании учетных записей домена для создания постоянных подписок следует учитывать несколько проблем. Каждая постоянная подписка по-прежнему будет работать, когда никто из пользователей не вошел в систему. Это означает, что они работают под встроенной учетной записью LocalSystem.

Если пользователь домена является создателем постоянной подписки для потребителей с защитой безопасности ([**активескриптевентконсумер**](activescripteventconsumer.md), [**коммандлинивентконсумер**](commandlineeventconsumer.md)), Инструментарий WMI проверяет, принадлежат ли свойства **креаторсид** класса [**\_ \_ EventFilter**](--eventfilter.md) , класса [**\_ \_ филтертоконсумербиндинг**](--filtertoconsumerbinding.md) и экземпляров потребителей пользователю, который является членом локальной группы администраторов.

В следующем примере кода показано, как можно указать свойство **креаторсид** .

``` syntax
 instance of __EventFilter as $FILTER
    {
        // this is the Administrators SID in array of bytes format
        CreatorSID = {1,2,0,0,0,0,0,5,32,0,0,0,32,2,0,0};    
        // Add filter code here ...
    }

    instance of ActiveScriptEventConsumer as $CONSUMER
    {
       CreatorSID = {1,2,0,0,0,0,0,5,32,0,0,0,32,2,0,0};
       // Add consumer code here ...
    }

    instance of __FilterToConsumerBinding
    {
       CreatorSID = {1,2,0,0,0,0,0,5,32,0,0,0,32,2,0,0};
       Consumer = $CONSUMER;
       Filter = $FILTER;
       // Add binding code here ...
    }
```

в случае междоменных ситуаций добавьте пользователей, прошедших проверку подлинности, в "Windows группу доступа авторизации".

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Защита событий WMI](securing-wmi-events.md)
</dt> <dt>

[Получение события WMI](receiving-a-wmi-event.md)
</dt> </dl>

 

 
