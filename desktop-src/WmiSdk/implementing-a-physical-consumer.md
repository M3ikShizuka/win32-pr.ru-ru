---
description: Физический потребитель — это COM-объект, реализующий интерфейс Ивбемунбаундобжектсинк.
ms.assetid: 497457dc-61ca-4527-89fd-2af0383de5e9
ms.tgt_platform: multiple
title: Реализация физического потребителя
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: af0a9530ed7a98ce19b3b39f2f5a1fe52f3b0631
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105712466"
---
# <a name="implementing-a-physical-consumer"></a>Реализация физического потребителя

Физический потребитель — это COM-объект, реализующий интерфейс [**ивбемунбаундобжектсинк**](/windows/desktop/api/Wbemprov/nn-wbemprov-iwbemunboundobjectsink) . Инструментарий WMI загружает физического потребителя и передает события через **ивбемунбаундобжектсинк** в ответ на одно или несколько событий, как определено соответствующим логическим потребителем. Постоянные потребители имеют особые требования к безопасности. Дополнительные сведения см. в разделе [Защита событий WMI](securing-wmi-events.md).

Следующая процедура описывает, как реализовать физического потребителя для постоянного потребителя событий.

**Реализация физического потребителя для постоянного потребителя событий**

1.  Создайте COM-объект.

    Необходимо реализовать физического потребителя в качестве локального или удаленного сервера с помощью протокола COM.

2.  Определите, требуется ли поддержка синхронного или асинхронного уведомления о событиях.

    При асинхронном уведомлении о событиях поток отправки не связан с принимающим потоком. Таким образом, не блокируется ни WMI, ни поставщик событий, пока Инструментарий WMI доставляет уведомление любому потребителю, зарегистрированному для получения события. Недостатком асинхронной доставки является то, что переключение контекста происходит между моментом, когда поставщик создает событие, и временем получения события потребителем. Дополнительные сведения о работе в асинхронном режиме см. в разделе " [основы com](../com/guide.md) " в разделе "com" пакета средств разработки программного обеспечения Microsoft Windows (SDK). Дополнительные сведения о переключении контекста см. в разделе [Переключение контекста](../procthread/context-switches.md) в разделе библиотеки DLL, процессы и потоки Windows SDK.

    > [!Note]  
    > Поскольку обратный вызов приемника может не возвращаться на том же уровне проверки подлинности, что и клиент, рекомендуется использовать семисинчронаус вместо асинхронного взаимодействия. Дополнительные сведения см. [в разделе вызов метода](calling-a-method.md).

     

    При синхронном уведомлении Инструментарий WMI доставляет уведомления в том же потоке, который используется поставщиком событий для доставки события в WMI. В этом случае, когда поставщик событий отправляет уведомление, поставщик событий блокируется WMI до тех пор, пока Инструментарий WMI не доставляет уведомление. Использовать синхронное уведомление можно только в том случае, если потребитель работает очень быстро и может обработать событие в течение 100 микросекунд или меньше. Синхронные потребители, которые занимают слишком много времени для обработки событий, могут серьезно замедлять доставку событий всем остальным потребителям. Более того, они могут случайно заблокировать поставщик. Дополнительные сведения см. в разделе [Привязка фильтра событий к логическому потребителю](binding-an-event-filter-with-a-logical-consumer.md).

3.  Реализуйте функцию [**ивбемунбаундобжектсинк:: индикатетоконсумер**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemunboundobjectsink-indicatetoconsumer) .

    Инструментарий WMI использует функцию [**индикатетоконсумер**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemunboundobjectsink-indicatetoconsumer) для передачи необходимых указателей и событий физическому потребителю как для синхронной, так и для асинхронной связи. Ваша реализация **индикатетоконсумер** должна содержать весь необходимый код для реагирования на событие.

    В отличие от временных потребителей событий, нет необходимости вызывать интерфейс [**ивбемлокатор**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) для связи с WMI. Вместо этого инструментарий WMI находит указатель на потребителя с помощью поставщика потребителей событий. Дополнительные сведения см. в разделе [написание поставщика объектов событий](writing-an-event-consumer-provider.md).

    Однако если вы хотите выполнить обратный вызов к инструментарию WMI, используйте интерфейсы [**ивбемлокатор**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) и [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) . Традиционным способом подключения к WMI является процесс инициализации COM-объекта. Дополнительные сведения см. [в разделе Создание приложения WMI или скрипта](creating-a-wmi-application-or-script.md).

    При реализации физического потребителя в качестве внутрипроцессного COM-сервера и подключения к WMI отдельно от процесса инициализации необходимо использовать идентификатор класса **CLSID \_ вбемадминистративелокатор** для доступа к интерфейсу [**ивбемлокатор**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) в вызове функции [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance).

    В следующем примере показано, как использовать идентификатор класса **CLSID \_ вбемадминистративелокатор** для доступа к интерфейсу [**ивбемлокатор**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) .

    ```C++
    IWbemLocator *pLoc = 0;

    DWORD dwRes = CoCreateInstance(CLSID_WbemAdministrativeLocator, 0, 
        CLSCTX_INPROC_SERVER, IID_IWbemLocator, (LPVOID *) &pLoc);
    ```

    

    Интерфейс [**ивбемлокатор**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) получает указатель исходного пространства имен на WMI на определенном компьютере узла. Сбой использования идентификатора **\_ вбемадминистративелокатор CLSID** в вызове [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) приводит к ошибке "доступ запрещен".

    В обычных обстоятельствах Инструментарий WMI доставляет асинхронные события клиенту по одному за раз. Однако если клиент не может получать асинхронные уведомления о событиях по мере поступления событий, Инструментарий WMI начинает автоматически выполнять пакетные события в одном вызове. Автоматическая пакетирование помогает в том случае, если время кругового пути является проблемой, как часто бывает в сценариях с высокой пропускной способностью. Однако Пакетная обработка не повышает производительность системы в случае сбоя клиента или пропускной способности сети.

 

 
