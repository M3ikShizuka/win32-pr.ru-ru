---
description: Приложения должны выделить память для этих данных; TAPI и поставщик услуг предоставляют данные. Если операция является асинхронной, данные недоступны, пока асинхронное сообщение ответа не указывает на успешное выполнение.
ms.assetid: 61313fe3-74a1-4195-b5af-37463dad02c1
title: Выделение памяти
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f192e34fdc652293c480277631c3839ecd2435fc
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105682385"
---
# <a name="memory-allocation"></a>Выделение памяти

Приложения должны выделить память для этих данных; TAPI и поставщик услуг предоставляют данные. Если операция является асинхронной, данные недоступны, пока асинхронное сообщение ответа не указывает на успешное выполнение.

Все структуры данных, используемые для передачи данных между приложением и интерфейсом TAPI, являются *плоскими*. То есть структуры данных не содержат указатели на подструктуры, содержащие компоненты данных вариабли размера. Вместо этого структуры данных, используемые для передачи переменных объемов данных обратно в приложение, должны иметь следующие метаструктуре:

``` syntax
  DWORD  dwTotalSize;
  DWORD  dwNeededSize;
  DWORD  dwUsedSize; 
    <fixed size fields> 
  DWORD  dw<VarSizeField1>Size;
  DWORD  dw<VarSizeField1>Offset; 
    <fixed size fields> 
  DWORD  dw<VarSizeField2>Size;
  DWORD  dw<VarSizeField2>Offset; 
    <common extensions> 
    <var sized field1> 
    <var sized field2>
```

Элемент **двтоталсизе** — это размер (в байтах), выделенный этой структуре данных. Он отмечает конец структуры данных и задается приложением перед вызовом функции, которая использует эту структуру данных. Функция не считывает или не выполняет запись сверх этого размера. Приложение должно задать элемент **двтоталсизе** , чтобы указать общее число байтов, выделенных для TAPI для возврата содержимого структуры.

TAPI заполняет элемент **двнидедсизе** . Указывает, сколько байтов требуется для возврата всех запрошенных данных. Наличие полей размера вариабли часто делает приложение невозможным для оценки размера структуры данных, необходимой для выделения. Это поле возвращает число байтов, фактически необходимых для данных. Это число может быть меньше, равно или больше **двтоталсизе** и включает место для самого элемента **двтоталсизе** . Если значение больше, возвращаемая структура заполняется только частично. Если поля, необходимые приложению, доступны в частичной структуре, ничего делать не нужно. В противном случае приложение должно выделить структуру по крайней мере с размером **двнидедсизе** и вызвать функцию снова. Как правило, на этот раз доступно достаточно места для возврата всей информации, хотя размер может увеличиться.

TAPI заполняет элемент **двуседсизе** , если он возвращает данные в приложение для указания фактического размера (в байтах) части структуры данных, содержащей полезные данные. Если, например, выделенная структура была слишком мала, а обрезанное поле является полем размера вариабли, **двнидедсизе** больше, чем **двтоталсизе**, а обрезанное поле остается пустым. Таким образом, элемент **двуседсизе** может быть меньше **двтоталсизе**. Частичные значения полей не возвращаются.

Следующий заголовок является фиксированной частью структуры данных. Он содержит обычные поля и пары "размер-смещение", описывающие фактические поля размера вариабли. Поле Offset содержит смещение в байтах поля вариабли size с начала записи. Поле Размер содержит размер в байтах поля вариабли size. Если поле размера вариабли пустое, то поле Size равно нулю, а смещение устанавливается равным нулю. Вариабли размер полей, которые будут обрезаны, если общий размер структуры недостаточен, остается пустым. Это значит, что для поля размера задано нулевое значение, а для смещения установлено нулевое значение. Поля размера вариабли соответствуют полям с фиксированным размером.

Если поставщик услуг должен заполнить член переменной, TAPI инициализирует соответствующий размер и смещение равными нулю. Если поставщик услуг заполняет переменную член, он должен задать соответствующие значения в соответствующих элементах size и offset, включая **двуседсизе** и **двнидедсизе** , если он задает члены переменных. Поставщик услуг не должен усекать член переменной, чтобы он поместился в доступное пространство.

Поставщик услуг должен запускать переменные члены сразу после фиксированных членов структуры и оставлять все дополнительное пространство в конце выделенной памяти, чтобы TAPI мог использовать его для членов переменной длины. Члены переменной могут размещаться в любом порядке, но элементы должны быть непрерывными.

 

 



