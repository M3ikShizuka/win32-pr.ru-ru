---
description: Ценная функция телефонии — это небольшой набор функций, называемый поддержкой телефонии.
ms.assetid: 1c41f52b-f8bf-410e-a966-9323a690a4d5
title: Обзор службы поддержки телефонии
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 7b6a8826fd0c273936204d9250fb91504333d807
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103998869"
---
# <a name="assisted-telephony-overview"></a>Обзор службы поддержки телефонии

Ценная функция телефонии — это небольшой набор функций, называемый поддержкой телефонии. Служба поддержки телефонии разработана таким образом, чтобы обеспечить доступ к голосовым вызовам и вызовам мультимедиа, доступным для любого приложения, а не только для телефонной функциональности. Другими словами, служба телефонии позволяет приложениям выполнять телефонные звонки без необходимости учитывать сведения о службах полного API телефонии. Она расширяет возможности телефонии для работы с текстовыми приложениями, электронными таблицами, базами данных, диспетчерами персональных данных и другими приложениями, отличными от телефонии.

Список функций телефонии TAPI 2. x, поддерживающих базовые телефонные функции, см. в разделе [Справочник по быстрой функции TAPI](./tapi-quick-function-reference.md). TAPI 3. x поддерживает телефонную связь через интерфейс [**итрекуест**](/windows/desktop/api/tapi3if/nn-tapi3if-itrequest) .

Полезность телефонной связи может быть продемонстрирована в следующем примере. Приложение электронной таблицы может включать функции, набираемые телефонный номер для речевого вызова. При условии, что приложению не требуется никакой подробной функции управления вызовами, предоставляемой полным API телефонии, служба телефонии является самым простым и наиболее эффективным способом предоставления телефонной функциональности.

![Техническая поддержка телефонии с помощью приложения для электронных таблиц](images/assist4.png)

Служба поддержки телефонии и полный API телефонии используются и реализуются различными способами, поэтому не рекомендуется смешивать вызовы функций телефонной связи и вызовы функций API телефонии в одном приложении.

## <a name="using-assisted-telephony"></a>Использование службы поддержки телефонии

Приложения, использующие службы технической телефонии, инициируют только запросы на вызов, которые временно помещаются в очередь TAPI. Приложение запроса получателя получает эти запросы и выполняет их от имени приложения, поддерживающего телефонную связь. Функция [**тапирекуестмакекалл**](/windows/win32/api/tapi/nf-tapi-tapirequestmakecall) запрашивает установленный голосовой вызов. Запрашивающее приложение не управляет вызовом.

TAPI позволяет пользователю устанавливать разные или одинаковые приложения-получатели запросов для каждой из этих служб. Приложение становится получателем запроса путем регистрации в [**линерегистеррекуестреЦипиент**](/windows/win32/api/tapi/nf-tapi-lineregisterrequestrecipient), в котором значение **true** указано в качестве значения параметра *бенабле*. (При указании значения **false** отменяется регистрация приложения в качестве получателя запроса, который должен быть выполнен, когда определяется, что его обязанности отправляются за текущий сеанс.) Приложение выбирает службы, которые требуется выполнять в параметре *Дврекуестмоде* **линерегистеррекуестреЦипиент**. Возможные значения для запроса — ЛИНЕРЕКУЕСТМОДЕ \_ MAKECALL, чтобы продемонстрировать, что приложение будет выполнять запросы [**тапирекуестмакекалл**](/windows/win32/api/tapi/nf-tapi-tapirequestmakecall) . Если несколько приложений регистрируются для одних и тех же служб, используется схема приоритета, позволяющая пользователю выбрать приложение, предпочитаемое для обработки запросов. Эта схема приоритета идентична той, которая использовалась для передачи вызовов, и Маршрутизация входящих вызовов на основе списка имен файлов в **хандоффприоритиес** в реестре.

## <a name="call-requests"></a>Запросы вызовов

Служба телефонии предоставляет приложения с поддержкой телефонии с простым в использовании механизмом для осуществления телефонных звонков, не требуя от разработчика полноценного помощника по телефонии.

Функция [**тапирекуестмакекалл**](/windows/win32/api/tapi/nf-tapi-tapirequestmakecall) запрашивает голосовое обращение между пользователем и удаленной стороной, указанной по номеру телефона. Выполняется запрос к интерфейсу TAPI, который передает его в приложение, зарегистрированное как получатель таких запросов. Этот получатель является приложением диспетчера вызовов.

После того как приложение сделало запрос, управление вызовом осуществляется исключительно из приложения диспетчера звонков, так как вспомогательные приложения телефонии не могут управлять вызовами. Поскольку более сложные аспекты телефонии и все операции с пользовательским интерфейсом обрабатываются приложением диспетчера звонков, приложения, поддерживающие телефонию, не должны изменяться каким-либо значительным образом. Фактически, приложения, которые позволяют вызывать эту операцию со встроенного языка скриптов, могут быть не изменены вообще.

Функция [**тапижетлокатионинфо**](/windows/win32/api/tapi/nf-tapi-tapigetlocationinfo) возвращает в приложение код страны или региона и город (область), заданный пользователем в параметрах текущего расположения на панели управления телефонии. Приложение может использовать эти сведения, чтобы помочь пользователю в создании правильных канонических телефонных номеров, например, по умолчанию при вводе новых номеров в записи телефонной книги или записи базы данных.

## <a name="request-recipients"></a>Запрос получателей

Для запуска телефонной связи необходимы два типа приложений. *Клиенты* с поддержкой телефонии — это приложения, использующие телефонную связь, вызывая функции с префиксом "TAPI". Примером такого клиентского приложения может быть электронная таблица, в которую добавляется команда меню или **кнопка на панели** инструментов.

Вспомогательные *серверы* телефонии — это приложения, которые могут выполнять функции API телефонии, являющиеся результатом вызова другого приложения с предварительно заданной функцией "TAPI". Чтобы сделать его известным как сервер с поддержкой телефонии, такое приложение регистрируется в качестве одного с помощью функции [**линерегистеррекуестреЦипиент**](/windows/win32/api/tapi/nf-tapi-lineregisterrequestrecipient) .

Функции службы телефонии (начинающиеся с префикса "TAPI") называются *функциями запросов*. Вспомогательные приложения телефонии, которые обрабатывают эти запросы (поддерживающие серверы телефонии), называются *получателями запросов*.

## <a name="processing-assisted-telephony-requests"></a>Обработка запросов к телефонной связи

Процесс, с помощью которого доставляются и обслуживаются запросы, выглядит следующим образом:

1.  Когда TAPI получает запрос на телефонные услуги, он проверяет наличие получателя запроса, то есть приложения, зарегистрированного для обработки этого типа запроса. Если имеется получатель запроса, запрос помещается в очередь, а приложение с наивысшим приоритетом, зарегистрированное для службы этого запроса, отправляет сообщение [**\_ запроса строки**](./line-request.md) . Сообщение уведомляет получателя запроса о поступлении нового запроса, а также указывает на режим запроса.
2.  Если интерфейсу TAPI не удается найти работающее приложение для обработки такого запроса, оно пытается запустить приложение, которое было зарегистрировано как способное. Эти сведения о регистрации записываются в **хандоффприоритиес** в реестре. TAPI пытается запустить приложения в том порядке, в котором они перечислены в разделе **хандоффприоритиес** . (См. следующий шаг.)

    Если приложение в настоящее время не зарегистрировано, TAPI проверяет список приложений обработки запросов в связанной записи в **хандоффприоритиес**. Если связанная строка отсутствует в файле, если в ней нет приложений или если ни одно из приложений в списке не может быть запущено, запрос отклоняется с ошибкой ТАПИЕРР \_ норекуестреЦипиент.

    Когда получатель запроса запускается (независимо от того, был ли он запущен в TAPI), он обязан вызывать [**линерегистеррекуестреЦипиент**](/windows/win32/api/tapi/nf-tapi-lineregisterrequestrecipient) во время процесса запуска и регистрировать себя в качестве получателя запроса.

3.  Если в записи указаны одно или несколько приложений, TAPI начинается с первого приложения в списке (наивысший приоритет) и пытается запустить его с помощью функции [**CreateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa) . Если попытка запуска приложения завершается неудачей, TAPI пытается запустить следующее приложение в списке. При успешном запуске любого приложения TAPI просто помещает запрос в очередь и возвращает приложению уведомление об успешном выполнении, даже если запрос еще не получил сигнал получателю запроса.

    После запуска приложения запроса получателя он вызывает [**линерегистеррекуестреЦипиент**](/windows/win32/api/tapi/nf-tapi-lineregisterrequestrecipient), что вызывает отправку сообщения [**\_ запроса строки**](./line-request.md) и сообщает о том, что запрос поставлен в очередь. Если по какой бы то ни было причине запущенное приложение не регистрируется, запрос остается в очереди и остается в очереди до тех пор, пока приложение не будет зарегистрировано для этого типа запроса.

4.  Если интерфейс TAPI находит такое зарегистрированное приложение или успешно запускает его, он помещает запрос в очередь, отправляет \_ сообщение запроса строки в серверное приложение и возвращает индикатор успеха для вызова функции в приложении телефонной связи. Это сообщение об успешном выполнении сообщает только о том, что запрос был принят и поставлен в очередь, а не на успешное выполнение.

Когда серверное приложение готово обработать запрос, оно вызывает функцию [**линежетрекуест**](/windows/win32/api/tapi/nf-tapi-linegetrequest) . Это позволяет получить все необходимые сведения, например адрес для набора. Затем он обрабатывает запрос с помощью функций TAPI (таких как [**линемакекалл**](/windows/win32/api/tapi/nf-tapi-linemakecall) и [**линедроп**](/windows/win32/api/tapi/nf-tapi-linedrop)), которые в противном случае использовались для размещения вызова. При вызове **линежетрекуест** удаляется запрос из TAPI, а параметры запроса копируются в буфер запроса, выделенный приложением. Размер и Интерпретация содержимого буфера зависят от режима запроса.

Сервер должен гарантировать, что при выполнении запросов он использует правильные параметры. При этом выполняются следующие действия.

1.  Получатель запроса сначала получает сообщение [**\_ запроса строки**](./line-request.md) , информирующее о том, что для него могут существовать запросы в очереди запросов. Это означает, что приложение вызывает [**линежетрекуест**](/windows/win32/api/tapi/nf-tapi-linegetrequest) и сохраняет его вызов до тех пор, пока очередь не будет остановлена (если запрос на создание нового вызова) или удален существующий вызов. Это сообщение не содержит параметров для запроса, за исключением случаев, когда запрос удаляет существующий вызов.
2.  Если запрос должен выполнить новый вызов, сервер телефонной связи использует функцию [**линежетрекуест**](/windows/win32/api/tapi/nf-tapi-linegetrequest) для получения полного запроса, который включает параметры запроса. Теперь на сервере имеется вся необходимая информация, например номер, который необходимо набрать, или идентификатор создателя запроса. Однако сначала сервер должен выделить память, необходимую для хранения этих данных.
3.  Наконец, сервер выполняет запрос, вызывая соответствующую функцию TAPI или набор функций.

Если TAPI не может запустить приложение, которое может обслуживаться как получатель запроса, вызов телефонной связи завершается сбоем и возвращает ошибку ТАПИЕРР \_ норекуестреЦипиент.

## <a name="notes-on-request-recipient-operations"></a>Примечания по операциям получателя запроса

Следующие сведения относятся к системам, на которых обрабатываются запросы на поддержку телефонии.

-   В реестре по умолчанию должно быть список приложений диспетчера звонков в списке приоритетов для [**тапирекуестмакекалл**](/windows/win32/api/tapi/nf-tapi-tapirequestmakecall). Это было бы полезно, но не обязательно, чтобы приложение диспетчера вызовов имело параметр меню, который позволяет пользователям задать наивысший приоритет.
-   Когда приложение получателя телефонии автоматически запускается с помощью TAPI и является единственным приложением TAPI в системе, это действие инициализирует TAPI. Если приложение получателя телефонии инициализирует и завершает работу линейного устройства перед регистрацией для обращений в службы поддержки, TAPI также завершает работу и запрос на телефонную связь теряется. Если запущенное другое приложение TAPI выполняет инициализацию и завершение работы, также могут быть утрачены телефонные запросы на телефонные соединения.

 

 
