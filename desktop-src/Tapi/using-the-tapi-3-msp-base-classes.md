---
description: Следующая процедура описывает, как реализовать MSP с помощью ATL версии 2,1 или ATL версии 3,0 и базовых классов MSP.
ms.assetid: 7485c34a-3c8a-412f-9cb9-8eb895084292
title: Использование базовых классов MSP TAPI 3
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: eb8ad4fd160cf0fc4c7dd682a44f3a4ff0bcec25
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105684492"
---
# <a name="using-the-tapi-3-msp-base-classes"></a>Использование базовых классов MSP TAPI 3

Следующая процедура описывает, как реализовать MSP с помощью ATL версии 2,1 или ATL версии 3,0 и базовых классов MSP. Дополнительные сведения и список библиотек и заголовков см. в разделе [базовые классы MSP TAPI 3](tapi-3-msp-base-classes.md). Содержимое этого раздела предполагает, что у разработчика есть опыт работы с ATL и COM, а также реализована реализация DLL-библиотек COM с помощью ATL.

**Реализация и MSP с помощью ATL 2,1 или ATL 3,0**

1.  Создайте IDL-файл для MSP. Этот файл определяет идентификатор CLSID для MSP. Объявите свой MSP "coclass" как реализацию интерфейса [**итмспаддресс**](/windows/desktop/api/msp/nn-msp-itmspaddress) и объявите этот интерфейс как интерфейс по умолчанию для объекта класса. Для определения **итмспаддресс** импортируйте файл "MSP. idl". Включите в библиотеку типов MSP "coclass" для MSP. Если ваш MSP поддерживает частные (пользовательские) интерфейсы, определите их здесь и включите в библиотеку типов. В следующем примере кода показан IDL-файл, как описано выше, без пользовательских интерфейсов.

    ``` syntax
    import "msp.idl";
    [
          uuid(4DDB6D35-3BC1-11d2-86F2-006008B0E5D2),
          version(2.0),
          helpstring("Wave MSP 2.0 Type Library")
    ]
    library WAVEMSPLib
    {
    importlib("stdole32.tlb");
    importlib("stdole2.tlb");

    [
    uuid(4DDB6D36-3BC1-11d2-86F2-006008B0E5D2),
    helpstring("Wave MSP Class")
    ]
    coclass WaveMSP
    {
    [default] interface ITMSPAddress;
    };
    };
    ```

2.  Измените TSP, чтобы объявить CLSID MSP, когда Tapi3.dll запрашивает его. Убедитесь, что (1) ваш TSP может согласовать TAPI \_ VERSION3 \_ 0 или выше в функции тспи [**тспи \_ линенеготиатетспиверсион**](/windows/win32/api/tspi/nf-tspi-tspi_linenegotiatetspiversion), (2) в структуре TSP [**линедевкапс**](/windows/win32/api/tapi/ns-tapi-linedevcaps) \_ задан флаг Линедевкапфлагс MSP, установленный в члене **ДВДЕВКАПФЛАГС** , и (3) ваш TSP Возвращает CLSID MSP в тспи функции [**\_**](/windows/win32/api/tspi/nf-tspi-tspi_linemspidentify)TSPI lineMSPIdentify. Это должен быть тот же CLSID, указанный в файле IDL; Например, вторая строка UUID в примере IDL-файла на предыдущем шаге.
3.  Скомпилируйте пример приложения Мспбасе, расположенный в пакете SDK для платформы, чтобы создать библиотеку Мспбасесампле. lib.
4.  Свяжите библиотеку DLL MSP с библиотекой Мспбасесампле. lib.
5.  Включите Мспбасе. h из пакета SDK для определения базового класса MSP.
6.  Реализуйте экспортируемые библиотеки DLL (например, DllMain). Microsoft Visual C++ создаст их. В DllMain, при \_ подключении к ПРОЦЕССУ DLL \_ и \_ \_ отсоединении процесса DLL, соответственно, используйте макросы **мсплогрегистер** и **мсплогдерегистер** , чтобы включить функции ведения журнала для библиотеки DLL. Укажите имя библиотеки DLL в вызове **мсплогдерегистер** .
7.  Используйте макрос LOG, определенный в Мсплог. h, для вывода сообщений трассировки таким же образом, как базовые классы. Определите символ препроцессора МСПЛОГ, чтобы включить ведение журнала в библиотеку DLL. Оставьте его неопределенным, чтобы создать библиотеку DLL без ведения журнала.
8.  Создайте класс, производный от Кмспаддресс, который реализует адреса для MSP. Объявите глобальную карту объектов ATL, которая указывает ATL создать экземпляр класса Address при запросе **сосоздания** для идентификатора CLSID, УКАЗАННОГО в IDL-файле. Кроме того, создайте класс адресов из шаблона **CCOMCOCLASS** ATL и включите \_ объявление RESOURCEID реестра для объявления \_ в своем классе Address. Создайте соответствующий скрипт ресурсов и файл заголовка, как для любой другой библиотеки DLL ATL COM.
9.  Реализуйте необходимые переопределения Кмспаддресс для класса Address. Для [**мспаддрессаддреф**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-mspaddressaddref) и [**мспаддрессрелеасе**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-mspaddressrelease)вызовите предоставленные шаблоны вспомогательной функции. Для [**жеткаллмедиатипес**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-getcallmediatypes)просто верните точечный рисунок **DWORD** со всеми поддерживаемыми MSP тапимедиамодес ORed. В этом месте [**креатемспкалл**](/windows/desktop/api/msp/nf-msp-itmspaddress-createmspcall) и [**Шутдовнмспкалл**](/windows/desktop/api/msp/nf-msp-itmspaddress-shutdownmspcall)возвращают E \_ нотимпл и компилируются и связывают ваш MSP. Теперь убедитесь, что вы можете зарегистрировать и создать экземпляр MSP из приложений TAPI 3, но не удалось успешно создать вызовы.
10. Создайте класс, производный от Кмспкаллмултиграф, для реализации объектов вызова MSP. Вы можете последовать от [**кмспкаллбасе**](/windows/desktop/api/Mspcall/nl-mspcall-cmspcallbase) вместо [**кмспкаллмултиграф**](/windows/desktop/api/Mspcall/nl-mspcall-cmspcallmultigraph) , если модель фильтра-Graph-for-Stream не соответствует вашим требованиям. Это увеличит сложность задачи (на момент написания этой статьи все MSP наследуют объекты вызова непосредственно из **кмспкаллмултиграф**). В объекте Address реализуйте [**креатемспкалл**](/windows/desktop/api/msp/nf-msp-itmspaddress-createmspcall) и [**шутдовнмспкалл**](/windows/desktop/api/msp/nf-msp-itmspaddress-shutdownmspcall) для создания и завершения конкретного типа объекта Call с помощью предоставленных шаблонов вспомогательных функций. В объекте Call Переопределите [**креатестреамобжект**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-createstreamobject) , чтобы возвращал E \_ нотимпл. Переопределяйте [**мспкалладдреф**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-mspcalladdref) и [**мспкаллрелеасе**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-mspcallrelease) способом, идентичным соответствующим методам адреса. Опять же, вы сможете компилировать и связывать свой MSP; Теперь он должен иметь возможность создавать и завершать вызовы, но вызовы не будут выполнять никаких полезных потоков.
11. Создайте класс, производный от Кмспстреам, для реализации объектов потока MSP. В объекте Call реализуйте [**креатестреамобжект**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-createstreamobject) для создания и инициализации объекта Stream (обычно путем вызова метода ATL **CreateInstance** , за которым следует **\_ интерналкуеринтерфаце** ATL для [**итстреам**](/windows/win32/api/tapi3if/nn-tapi3if-itstream) , после чего вызывается метод **init** для объекта потока). Для поддержки фиксированного числа потоков (это распространено для MSP, которые не поддерживают изменение конфигураций потоков другими конечными точками в вызове), переопределите методы **init**, [**креатестреам**](/windows/win32/api/tapi3if/nf-tapi3if-itstreamcontrol-createstream)и [**ремовестреам**](/windows/win32/api/tapi3if/nf-tapi3if-itstreamcontrol-removestream) для объекта Call. (Вызов **init** сначала создает все потоки, а **креатестреам** и **ремовестреам** возвращают соответствующие коды ошибок TAPI, чтобы приложение не создавало или не удаляя потоки). В противном случае Переопределите метод **init** вызова, чтобы создать начальную конфигурацию потоков по умолчанию с использованием типов носителей, запрошенных для вызова. При создании объектов потока по умолчанию в методе **init** вызова используйте вспомогательный метод [**интерналкреатестреам**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-internalcreatestream) .
12. Реализуйте объект Stream. Единственным обязательным переопределением является метод [**Get \_ Name**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-get_name) , который просто возвращает понятное имя для потока. Кроме того, необходимо переопределить несколько других методов. В точности, какие методы переопределяются, зависит от реализации и от принятия решения о выполнении различных задач, связанных с построением и деконструированием графа фильтра. Эти задачи включают создание соответствующих фильтров транспорта, кодеков и т. д., а также их вставку и удаление из графов фильтров в нужное время. Для подключения выбранных терминалов к потокам также потребуется использовать интерфейс [**иттерминалконтрол**](/windows/desktop/api/Termmgr/nn-termmgr-itterminalcontrol) в объектах терминала. Может потребоваться переопределить [**селекттерминал**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-selectterminal) и [**унселекттерминал**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-unselectterminal) в объекте потока, чтобы ограничить конфигурации терминалов, которые будут приниматься потоками. ограничение каждого потока в одном терминале особенно упростит создание графов фильтров, но повлияет на функциональные возможности приложения, такие как предварительный просмотр видео. В зависимости от реализации вы размещаете построение графа, деконструкцию и код подключения терминала в методах [**стартстреам**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-startstream), [**стопстреам**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-stopstream), [**паусестреам**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-pausestream), [**Initialize**](/windows/desktop/api/msp/nf-msp-itmspaddress-initialize), [**Shutdown**](/windows/desktop/api/msp/nf-msp-itmspaddress-shutdown), [**селекттерминал**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-selectterminal)и [**унселекттерминал**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-unselectterminal) или в своих собственных методах, основанных на соединении частного TSP. Имейте в виду, что поток без выбранных терминалов должен относиться к нужному состоянию диаграммы. вызов **стартстреам** , за которым следует вызов **селекттерминал** в таком потоке, должен привести к потоку данных. Переопределите большинство из этих методов, чтобы убедиться в том, что в каждом из них возникает Правильная конструкция, деконструкция, соединение и отключение, в зависимости от состояния потока.
13. Реализуйте обмен данными по TSP. Переопределите [**кмспаддресс:: рецеиветспаддрессдата**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-receivetspaddressdata) и/или [**Кмспкаллбасе:: рецеиветспкаллдата**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-receivetspcalldata)и (или), [**вызвав для**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-postevent) объекта Address, или [**хандлестреамевент**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-handlestreamevent) в объекте Call (из объектов вызова или потока).
14. Используйте для объекта Address или Хандлестреамевент в объекте Call (из объектов Call или Stream), чтобы передавать события мультимедиа вызова приложению через Tapi3.dll. Обычно это делается для объекта Stream в переопределенных методах, включая методы [**процессграфевент**](/windows/desktop/api/Mspstrm/nf-mspstrm-cmspstream-processgraphevent), [**стопстреам**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-stopstream), [**стартстреам**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-startstream), [**паусестреам**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-pausestream), [**селекттерминал**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-selectterminal)и [**унселекттерминал**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-unselectterminal) , в зависимости от способа реализации потоков.
15. Реализуйте все необходимые частные интерфейсы или подпотоки на существующих объектах (адрес, вызов и поток). Обычно нет. Имейте в виду, что при реализации частных интерфейсов укажите идентификатор LIBID библиотеки типов из IDL-файла. То есть программисты приложения должны использовать библиотеку типов MSP при использовании пользовательских интерфейсов. Стандартные интерфейсы MSP, реализованные в базовых классах MSP, используют Tapi3.dll LIBID и поэтому доступны для всех приложений TAPI 3.
16. При реализации статического или динамического объекта терминала или замен для статических терминалов по умолчанию (не номинал) можно использовать предоставленные базовые классы терминала. Вам придется переопределять различные методы объекта Address, чтобы предоставить альтернативные или дополнительные методы создания объектов Terminal.
17. Реализуйте интерфейс Иобжектсафети в адресе, вызове, потоке и объектах терминала. Чтобы использовать [сопоставитель диспетчеризации](dispatch-mapper.md) для запроса интерфейсов в объектах MSP, пометьте объекты как надежные для создания сценариев на этих интерфейсах. Для этого реализуйте интерфейс **иобжектсафети** для объекта. Наследование от **кмспобжектсафетимпл** (вспомогательный класс, предоставленное в мспутилс. h) и добавление **ИОБЖЕКТСАФЕТИ** в карту COM ATL класса сделает \_ объекты надежными для сценариев на всех предоставляемых ими интерфейсах. Имейте в виду, что использование сопоставителя диспетчеризации для объектов MSP может быть неявным. Адрес MSP и вызов MSP обрабатываются по адресу TAPI и объектам вызова TAPI. Если в объектах TAPI для запроса интерфейсов, предоставляемых агрегированными объектами MSP, используется сопоставитель диспетчеризации, то сводные объекты MSP будут запрашиваться для обеспечения безопасности запрошенных интерфейсов.

 

 
