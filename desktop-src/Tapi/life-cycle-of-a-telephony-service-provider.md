---
description: В этом разделе представлен общий обзор операций TSP.
ms.assetid: 8ee592ff-387e-449e-8e3f-4f6407166fe5
title: Жизненный цикл поставщика услуг телефонии
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 830bc16ca606bb5bd38c4bce7c1e6e39dadb65a6
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104565163"
---
# <a name="life-cycle-of-a-telephony-service-provider"></a>Жизненный цикл поставщика услуг телефонии

В этом разделе представлен общий обзор операций TSP.

Сеанс — это время, в течение которого определенная конфигурация остается допустимой и выполняется операция телефонной связи. Поставщик услуг может поддерживать много сеансов между моментом, когда он впервые загружается, и после его освобождения. Для каждого сеанса TAPI согласовывает версию интерфейса, запускает сеанс, выполняет операции и в конечном итоге завершает сеанс. Поставщик услуг не должен хранить данные из одного сеанса в следующий.

После того как версия интерфейса известна, TAPI вызывает функцию [**тспи \_ провидеринит**](/windows/win32/api/tspi/nf-tspi-tspi_providerinit) для установки всех рабочих параметров. Поставщик услуг гарантирует, что вся информация о конфигурации в реестре будет стабильной при вызове функции **тспи \_ провидеринит** . Большинство поставщиков служб в это время считывают все сведения о конфигурации.

Нормальные операции могут выполняться в любом порядке после инициализации поставщика услуг.

TAPI согласовывает сведения, относящиеся к устройству, для каждого устройства. TAPI и поставщик услуг фиксируются в версии при открытии устройства.

Поставщик услуг может принимать запросы на выбор и отмену версий расширений. Пока выбрана версия расширения, устройство работает строго в соответствии с версией модуля, относящегося к конкретному устройству.

Согласование версии расширения для конкретного устройства может происходить несколько раз, до и после открытия устройства. TAPI передает диапазон версий, а поставщик услуг выбирает и возвращает значение из этого диапазона. Как правило, у поставщика услуг отключены расширения для конкретных устройств.

Это зафиксирует как TAPI, так и поставщик службы для работы на этом уровне версии расширения до тех пор, пока выбор не будет отменен. В течение времени, когда действует расширение для конкретного устройства, попытка согласовать уровень версии расширения должна разрешить только уровень версии, действующий в данный момент. После отмены расширения для конкретного устройства можно согласовать и выбрать другую версию.

Операции с телефоном в паре **Open/Close** показаны на следующем рисунке. Некоторые из этих операций являются синхронными, а другие — асинхронными. Если операция завершается асинхронно, можно запросить другую операцию перед завершением первого отчета. Таким образом, операции могут перекрываться любым способом. Поставщик услуг в конечном итоге должен сообщить о завершении для любой запрошенной асинхронной операции. Закрытие телефона означает принудительное завершение невыполненных асинхронных операций (возможно, с указанием ошибки).

Жизненный цикл линейных устройств аналогичен жизненному циклу для телефонов, за исключением того, что строки имеют собственные процедуры согласования, инициализации, открытия и закрытия. Операции с открытыми строками заключаются в скобки с помощью собственной пары **Open/Close** . Эта пара заключается в скобки между той же парой **инициализации и завершения работы** , что и Телефон, **открытый или закрывающий**.

Жизненный цикл вызовов строго заключен в скобки между **открывающим или закрывающим** строкой, содержащей их. Время существования вызовов может начинаться несколькими способами:

-   Запрошено из TAPI с помощью таких функций, как [**линемакекалл**](/windows/win32/api/tapi/nf-tapi-linemakecall), [**линесетуптрансфер**](/windows/win32/api/tapi/nf-tapi-linesetuptransfer)или [**линесетупконференце**](/windows/win32/api/tapi/nf-tapi-linesetupconference).
-   Злоумышленник поступил в поставщике услуг как новые входящие вызовы, инициированные пользователем вызовы на подключенной телефонной трубки или вызовы, созданные как побочные эффекты других операций, таких как помещение существующего вызова в удержание.

Время существования различных вызовов в одной строке может быть перекрываться любым способом. Все вызовы завершают свое время существования во время вызова функции ТСПИ, [**тспи \_ линеклосекалл**](/windows/win32/api/tspi/nf-tspi-tspi_lineclosecall) . На следующем рисунке показан жизненный цикл нескольких вызовов.

![жизненные циклы вызовов, перекрывающихся](images/modell.png)

Вызов может быть получен в TAPI, как показано в паре **MAKECALL/клосекалл** . Вызов также может исходить от поставщика услуг. Поставщик услуг объявляет это с помощью [**строки \_ невкалл**](line-newcall.md) сообщения в процедуру обратного вызова, предоставляемую TAPI. В этом случае TAPI возвращает свой идентификатор для вызова, который включается в последующие обратные вызовы, сообщающие о событиях, происходящих при вызове. В случае вызовов, время существования которых исходит от TAPI, этот идентификатор включается в операцию ТСПИ, которая создает вызов.

Все операции, которые начинают время существования вызова в TAPI и поставщике услуг, обмениваются идентификаторами для нового вызова. В случае порожденных вызовов TAPI TAPI передает свой идентификатор и получает идентификатор поставщика службы в качестве возвращаемого параметра. В случае, когда вызов исходит от поставщика услуг, поставщик услуг передает свой идентификатор в TAPI и получает идентификатор TAPI в качестве возвращаемого параметра.

На следующем рисунке представлено высокоуровневое представление установки, настройки и удаления поставщика услуг. последовательности жизненного цикла, охватывающие много сеансов. Типичный жизненный цикл этих операций можно отобразить с помощью следующей временной шкалы.

![Установка, Настройка и удаление поставщика услуг](images/model2.png)

Показан стандартный жизненный цикл установки и удаления, охватывающий несколько сеансов. Вызовы процедур **установки** и [**удаления**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove) строго парны и не перекрываются. Вызовы процедуры **настройки** могут происходить несколько раз в этой паре. Как правило, поставщик услуг выполняет процедуру **установки** в качестве внутреннего побочного действия для создания записей строк и телефонов. Процедура **настройки** может быть вызвана в другое время для изменения существующей установки. Процедура **установки** должна быть выполнена до того, как будет разрешена любая другая функция тспи. В идеальном случае все сеансы строго вкладываются в пару процедур **Install/Remove** .

Функции [**тспи \_ провидеринсталл**](/windows/win32/api/tspi/nf-tspi-tspi_providerinstall), [**тспи \_ провидерконфиг**](/windows/win32/api/tspi/nf-tspi-tspi_providerconfig)и [**тспи \_ провидерремове**](/windows/win32/api/tspi/nf-tspi-tspi_providerremove) взаимодействуют с самим поставщиком услуг, а не с каким бы то ни было конкретным устройством. Они влияют на сведения о статической конфигурации, которые остаются в нескольких сеансах и должны присутствовать для продолжения любой другой операции. Таким же, все остальные операции вкладываются между вызовом **тспи \_ провидеринсталл** и завершением соответствующего **тспи \_ провидерремове**. Эти две операции обычно происходят очень далеко друг от друга, скорее всего, в другой нагрузке поставщика услуг или при другой загрузке компьютера. Вызов функции **настройки** извне является необязательным, так как процедура **установки** необходима для включения поведения **конфигурации** в дополнение к собственным. Как правило, причина его вызова извне заключается в изменении существующей конфигурации.

В концепцию завершения операции [**\_ провидерремове тспи**](/windows/win32/api/tspi/nf-tspi-tspi_providerremove) есть тонкость. Желательно разрешить пользователю запускать служебную программу панели управления телефонии, предоставляемую вместе со службой телефонии, для изменения конфигураций поставщика услуг, даже если выполняются операции телефонии (сеансы). Следовательно, спецификации [**тспи \_ Провидерконфиг**](/windows/win32/api/tspi/nf-tspi-tspi_providerconfig) и **тспи \_ провидерремове** позволяют вызывать, пока не будет выполнен сеанс. Однако все изменения в конфигурации должны быть отложены до тех пор, пока операции телефонии не будут выключены и перезапущены. Поэтому строго говоря, завершение любой операции **тспи \_ Провидерконфиг** или **тспи \_ провидерремове** происходит вне любого сеанса. Вложенность действий показана на рисунке, даже несмотря на то, что вызовы процедур могут выглядеть немного иначе. Поставщик услуг может просто запретить **настройку config** или [**Удалить**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove) во время выполнения операций, хотя пользователь должен получать уведомления с помощью диалогового окна. Более удобная для пользователя реализация, которая позволяет использовать по крайней мере подмножество операций.

Эти операции **установки**, **настройки** и [**удаления**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove) имеют побочный результат для всех работающих приложений телефонии, что в итоге приводит к выключению использования службы телефонии. Вместе это завершает все невыполненные сеансы для поставщиков услуг. Это означает, что поставщики услуг должны читать новую конфигурацию реестра при начале новых сеансов. Все изменения, которые были отложены из-за **настройки** или [**удаления**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove) во время выполнения операций, вступают в силу.

 

 
