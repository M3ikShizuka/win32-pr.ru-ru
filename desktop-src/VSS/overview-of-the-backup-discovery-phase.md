---
description: 'После вызова Ивссбаккупкомпонентс:: Гасервритерметадата инициатор запроса использует экземпляр интерфейса Ивссасинк, возвращенный этим вызовом, чтобы определить, когда все модули записи в системе завершат создание документов метаданных модуля записи.'
ms.assetid: 04658d50-04f0-4189-8b88-ff152f1bf482
title: Обзор фазы обнаружения резервных копий
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 3d2d2a2d05220ecf3e25c77c18cc62b07726964f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105692891"
---
# <a name="overview-of-the-backup-discovery-phase"></a>Обзор фазы обнаружения резервных копий

После вызова [**ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata)инициатор запроса использует экземпляр интерфейса [**ивссасинк**](/windows/desktop/api/Vss/nn-vss-ivssasync) , возвращенный этим вызовом, чтобы определить, когда все модули записи в системе завершат создание документов метаданных модуля записи. Дополнительные сведения см. в разделе Общие сведения об [обработке резервной копии в VSS](overview-of-processing-a-backup-under-vss.md).

На этом этапе инициатор запроса может начать фазу обнаружения, проверив метаданные, чтобы определить, какие приложения выполняются и какие тома необходимо скопировать, чтобы получить полную резервную копию. В следующей таблице показана последовательность действий и событий, необходимых для фазы обнаружения резервных копий.



| Действие запросившего                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Событие | Действие записи                                                                     |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------|-----------------------------------------------------------------------------------|
| Получение документов метаданных модуля записи (см. [**ивссбаккупкомпонентс:: жетвритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata), [**ивссексаминевритерметадата**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata)).                                                                                                                                                                                                                                                                                                                                                 | Нет  | В течение этого периода модули записи могут продолжать работу с обычными операциями. |
| Используйте список компонентов и их [*наборов файлов*](vssgloss-f.md), а также исключенных файлов, чтобы получить список томов и файлов, участвующих в резервной копии (см. раздел [**ивссвмкомпонент**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent), [**ивссвмфиледеск**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc)).                                                                                                                                                                                                                                                                      | Нет  | Нет                                                                              |
| Выберите компоненты в документе метаданных модуля записи модуля записи для резервного копирования. Вызовите метод [**ивссбаккупкомпонентс:: AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) для каждого компонента, чтобы добавить его в документ компонентов резервного копирования. (См. статью [Работа с выборкой для резервного копирования](working-with-selectability-for-backup.md) и [Работа с документом резервных компонентов](working-with-the-backup-components-document.md).)                                                                                                                      | Нет  | Нет                                                                              |
| Инициализация набора теневых копий, контекста и проверки поддерживаемых томов (см. раздел [**ивссбаккупкомпонентс:: стартснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset), [**Ивссбаккупкомпонентс:: исволумесуппортед**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-isvolumesupported)).                                                                                                                                                                                                                                                                                   | Нет  | Нет                                                                              |
| При выполнении резервного копирования, не являющейся компонентом, добавьте требуемые целевые тома из документа метаданных модуля записи в набор теневых копий, вызвав [**ивссбаккупкомпонентс:: аддтоснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset) для каждого тома. В противном случае для компонентов в документе метаданных модуля записи, которые уже были добавлены в документ компонентов резервного копирования (путем вызова метода [**AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent)), запрашивающая сторона должна также вызвать **Ивссбаккупкомпонентс:: аддтоснапшотсет** для каждого соответствующего тома. | Нет  | Нет                                                                              |



 

## <a name="writer-actions-during-the-discovery-phase"></a>Действия модуля записи на этапе обнаружения

Поскольку фаза обнаружения резервной копии состоит в основном с инициатором запроса, обрабатывающим информацию, полученную из документов метаданных модуля записи, существует несколько требований к модулю записи.

Теоретически, модуль записи может продолжать нормально работать на этом этапе. Тем не менее, может быть желательно, чтобы модули записи начали подготовку к появлению операций теневого копирования и архивации.

## <a name="requester-actions-during-the-discovery-phase"></a>Действия запросившего на этапе обнаружения

Инициатор запроса использует объекты [**ивссексаминевритерметадата**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata) , полученные с помощью [**Ивссбаккупкомпонентс:: жетвритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) , для прохода по всем метаданным модулей записи и выбора тех модулей записи, данные которых планируется архивировать.

На этом этапе инициатору запроса потребуется создать исходный список кандидатов для резервного копирования каждого средства записи, пересматривая компоненты модуля записи с помощью [**ивссексаминевритерметадата::**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent)at. Это предоставляет инициатору запроса объекты [**ивссвмкомпонент**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent) , из которых можно получить спецификации файлов для резервного копирования с помощью [**ивссвмкомпонент::**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getfile), [**Ивссвмкомпонент:: Жетдатабасефиле**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabasefile)и [**ивссвмкомпонент:: GetDatabaseLogFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabaselogfile).

Так как объект [**ивссвмфиледеск**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) может использовать подстановочные знаки для хранения сведений о расположении файлов, может потребоваться использовать такие функции, как [**FindFirstFile**](/windows/win32/api/fileapi/nf-fileapi-findfirstfilea), [**финдфирстфиликс**](/windows/win32/api/fileapi/nf-fileapi-findfirstfileexa)и [**FindNextFile**](/windows/win32/api/fileapi/nf-fileapi-findnextfilea).

Пока теневая копия не будет завершена, модули записи могут добавлять или удалять файлы с диска в обычном процессе работы, поэтому не следует создавать фактический список файлов для резервного копирования в данный момент.

Вместо этого на этом этапе можно найти исходный список файлов и томов для резервного копирования, выполнив следующие действия.

1.  Изучение всех выбранных для резервного копирования и невыбираемых компонентов в документе метаданных модуля записи (с помощью [**ивссексаминевритерметадата**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata)) и их упорядочения в [*Наборы компонентов*](vssgloss-c.md) используют [*логический путь*](vssgloss-l.md) (см. раздел [Работа с выборкой и логические пути](working-with-selectability-and-logical-paths.md)).
2.  [*Включение явным образом*](vssgloss-e.md) всех обязательных компонентов (невыбираемых для компонентов резервного копирования без выбора для предков резервной копии) в документе компоненты резервного копирования с помощью [ **ивссбаккупкомпонентс:: AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent)
3.  Выбор явного включения необязательного выбора для компонентов резервного копирования, не определяющих набор компонентов (с помощью [**ивссбаккупкомпонентс:: AddComponent).**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent)
4.  Выбор [*наборов компонентов*](vssgloss-c.md) для участия в резервной копии путем явного добавления их определяемого для выбора компонента резервного копирования (с помощью [**Ивссбаккупкомпонентс:: AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent)), который [*неявно включает*](vssgloss-i.md) [*подкомпоненты*](vssgloss-s.md)набора компонентов.
5.  Используя сведения о [*наборе файлов*](vssgloss-f.md) в выбранных функциях управления документами и томами метаданных модуля записи, инициатор запроса определяет пути к файлам для резервного копирования и тома, которые необходимо скопировать.

Обратите внимание, что только явно включенные компоненты (с использованием [**ивссбаккупкомпонентс:: AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent)) в резервной копии и в документе компоненты резервного копирования будут иметь экземпляры интерфейса [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) , добавленные в этот документ. Эти экземпляры будут использоваться для проверки и изменения параметров компонентов для явно включаемых компонентов и любых их неявно включаемых компонентов (см. раздел [Выбор варианта и работа со свойствами компонентов](selectability-and-working-with-component-properties.md)).

Если модуль записи включает какие-либо компоненты модуля записи, он должен добавить все необходимые компоненты. Однако инициатор запроса также может полностью пропустить все наборы компонентов модуля записи. Если ни один из компонентов модуля записи не выбран явным образом, модуль записи не выбирается, а VSS препятствует участию в оставшейся части операции резервного копирования.

Инициатор запроса инициирует набор теневых копий, который будет содержать выбранные тома, вызвав [**ивссбаккупкомпонентс:: стартснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset).

Если том может участвовать в теневой копии (которую можно проверить с помощью [**ивссбаккупкомпонентс:: исволумесуппортед**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-isvolumesupported)), инициатор запроса может добавить этот том в набор теневых копий с помощью [**Ивссбаккупкомпонентс:: аддтоснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset).

Хотя в общем случае он не полезен, инициатор запроса иногда также может выбрать, какой [*поставщик*](vssgloss-p.md) будет поддерживать теневую копию для заданного тома (Дополнительные сведения см. в разделе [Выбор поставщиков](selecting-providers.md) ).

Следует соблюдать осторожность при обработке тома, содержащего подключенные папки или точки повторного анализа. Подключенная папка или точка повторной обработки могут быть отображены в теневой копии и могут быть резервными копиями. Однако не удается просмотреть подключенную папку или точку повторного анализа на тенев скопированном томе (см. раздел [Работа с подключенными папками и точки повторного анализа](working-with-reparse-and-mount-points.md)).

На этом этапе резервного копирования документ компонентов резервного копирования инициализируется и заполняется. В будущих операциях записи и запрашивающие стороны могут использовать интерфейс [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) для взаимодействия друг с другом.

Модули записи получают доступ к интерфейсу [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) при обработке событий [*PrepareForBackup*](vssgloss-p.md), [*моментального снимка*](vssgloss-p.md)и [*баккупкомплете*](vssgloss-b.md) .

 

 
