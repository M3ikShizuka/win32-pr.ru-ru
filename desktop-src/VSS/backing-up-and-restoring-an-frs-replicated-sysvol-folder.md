---
description: В этом разделе объясняется, как определить, реплицируется ли папка SYSVOL с помощью DFSR или ФСР, и как создать резервную копию и восстановить папку SYSVOL, реплицированную службой FRS.
ms.assetid: 32d8a5bd-eeb4-4db6-8129-b5cd3508a7e5
title: Резервное копирование и восстановление папки FRS-Replicated SYSVOL
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6d841f64bab62114824847f91876ba8bbffbb0166db942c0f3cb9d010b72f106
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "120124604"
---
# <a name="backing-up-and-restoring-an-frs-replicated-sysvol-folder"></a>Резервное копирование и восстановление папки FRS-Replicated SYSVOL

Папка системного тома (SYSVOL) предоставляет стандартное расположение для хранения важных элементов [Групповая политика](/previous-versions/windows/it-pro/windows-server-2003/cc779838(v=ws.10)) объектов и скриптов. Копия папки SYSVOL существует на каждом контроллере домена в домене. Репликация папки SYSVOL выполняется либо с помощью [Распределенная файловая система репликации (DFSR)](/windows-server/storage/dfs-replication/migrate-sysvol-to-dfsr) , либо с помощью [службы репликации файлов (FRS)](/previous-versions/windows/it-pro/windows-server-2003/cc781582(v=ws.10)). В этом разделе объясняется, как определить, реплицируется ли папка SYSVOL с помощью DFSR или ФСР, и как создать резервную копию и восстановить папку SYSVOL, реплицированную службой FRS.

FRS может копировать содержимое SYSVOL на другие контроллеры домена в домене. Служба FRS наблюдает за папкой SYSVOL и, если изменение выполняется для любого файла, хранящегося в папке SYSVOL, FRS автоматически реплицирует измененный файл в папки SYSVOL на других контроллерах домена в домене.

> [!Note]  
> Репликация содержимого папки SYSVOL выполняется только для шаблона групповая политика. Контейнер групповая политика реплицируется с помощью Active Directory репликации. Чтобы групповая политика успешно работать, на контроллере домена должен быть доступен как шаблон групповая политика, так и контейнер групповая политика.

 

В этом разделе рассматриваются следующие темы:

-   [Определение, реплицируется ли папка SYSVOL контроллера домена с помощью DFSR или FRS](#determining-whether-a-domain-controllers-sysvol-folder-is-replicated-by-dfsr-or-frs)
-   [Резервное копирование DFSR-Replicated папки SYSVOL](#backing-up-a-dfsr-replicated-sysvol-folder)
-   [резервное копирование FRS-Replicated папки SYSVOL в домене Windows server 2008 или Windows server 2003](#backing-up-an-frs-replicated-sysvol-folder-on-a-windows-server-2008-or-windows-server-2003-domain)
-   [Пример документа метаданных модуля записи FRS](#sample-frs-writer-metadata-document)
-   [Настройка разделов реестра для восстановления папки FRS-Replicated SYSVOL](#setting-registry-keys-for-a-restore-of-an-frs-replicated-sysvol-folder)
-   [Выполнение неполномочного восстановления папки FRS-Replicated SYSVOL](#performing-a-nonauthoritative-restore-of-an-frs-replicated-sysvol-folder)
-   [Выполнение полномочного восстановления папки FRS-Replicated SYSVOL](#performing-an-authoritative-restore-of-an-frs-replicated-sysvol-folder)

## <a name="determining-whether-a-domain-controllers-sysvol-folder-is-replicated-by-dfsr-or-frs"></a>Определение, реплицируется ли папка SYSVOL контроллера домена с помощью DFSR или FRS

В следующей таблице приведены сведения о том, как определить, реплицируется ли папка SYSVOL контроллера домена с помощью [DFSR](/windows-server/storage/dfs-replication/migrate-sysvol-to-dfsr) или FRS.

| Если контроллер домена работает                                                                                                                  | Репликация SYSVOL выполняется с помощью |
|------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------|
| Windows сервер 2008 + режим работы домена Windows сервер 2008 + [миграция SYSVOL](https://blogs.technet.com/filecab/archive/2008/02/08/sysvol-migration-series-part-1-introduction-to-the-sysvol-migration-process.aspx) завершен | DFSR                    |
| Windows сервер 2008 + режим работы домена ниже Windows сервер 2008                                                                              | НАБОРА                     |
| Windows Server 2003                                                                                                                                  | НАБОРА                     |



 

если [функциональный уровень](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc754918(v=ws.10)) домена — Windows Server 2008, а домен — [миграция sysvol](https://blogs.technet.com/filecab/archive/2008/02/08/sysvol-migration-series-part-1-introduction-to-the-sysvol-migration-process.aspx), то для репликации папки sysvol будет использоваться [служба DFSR](/windows-server/storage/dfs-replication/migrate-sysvol-to-dfsr) . если первый контроллер домена в домене был повышен непосредственно на [функциональном уровне](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc754918(v=ws.10))Windows Server 2008, DFSR автоматически используется для репликации SYSVOL. В таких случаях миграция репликации SYSVOL с FRS на DFSR не требуется. если домен был обновлен до [уровня](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc754918(v=ws.10))Windows Server 2008, служба frs используется для репликации SYSVOL до тех пор, пока не завершится процесс [миграции](https://blogs.technet.com/filecab/archive/2008/02/08/sysvol-migration-series-part-1-introduction-to-the-sysvol-migration-process.aspx) с FRS на DFSR.

чтобы определить, используется ли служба DFSR или FRS на контроллере домена, на котором работает Windows Server 2008, проверьте значение в разделе **HKEY \_ LOCAL \_ MACHINE** \\ **System** \\ **CurrentControlSet** \\ **Services** \\ **DFSR** \\ **Parameters** \\ **sysvol** \\  \\ **reлокалстате** sysvol. Если этот подраздел реестра существует и его значение равно 3 (ИСКЛЮЧЕНо), используется [Служба DFSR](/windows-server/storage/dfs-replication/migrate-sysvol-to-dfsr) . Если подраздел не существует или имеет другое значение, используется служба FRS.

## <a name="backing-up-a-dfsr-replicated-sysvol-folder"></a>Резервное копирование DFSR-Replicated папки SYSVOL

Если папка SYSVOL реплицируется с помощью [DFSR](/windows-server/storage/dfs-replication/migrate-sysvol-to-dfsr), для ее резервного копирования можно использовать модуль записи VSS DFSR. Дополнительные сведения о модуле записи VSS DFSR см. в статье [реплицированные папки DFSR](/previous-versions/windows/desktop/dfsr/dfsr-replicated-folders).

## <a name="backing-up-an-frs-replicated-sysvol-folder-on-a-windows-server-2008-or-windows-server-2003-domain"></a>резервное копирование FRS-Replicated папки SYSVOL в домене Windows server 2008 или Windows server 2003

на контроллере домена, на котором работает Windows server 2008 или Windows server 2003, имеется инфраструктура VSS, и поэтому модуль записи VSS frs может использоваться для резервного копирования папки SYSVOL и компонентов FRS.

В документе метаданных модуля записи VSS службы FRS содержатся сведения о расположении папки SYSVOL и списках исключений для модуля записи. На основе этих сведений приложение резервного копирования VSS (запросивший) может создать резервную копию папки SYSVOL с помощью регулярных методик резервного копирования на основе VSS.

Документ метаданных модуля записи содержит сведения о модуле записи, данных, которые владеет модулем записи, и восстановлении этих данных. Это документ только для чтения, который можно получить с помощью приложения резервного копирования перед созданием резервной копии. Средство [Diskshadow](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc772172(v=ws.11)) можно использовать для просмотра документа метаданных модуля записи VSS FRS. Команда [модуля записи списка Diskshadow](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc772172(v=ws.11)) предоставляет сведения о модулях записи, имеющихся в системе. Этот список содержит сведения о модуле записи FRS на контроллерах домена, использующих службу FRS для репликации SYSVOL или на файловых серверах, которые используют службу FRS для репликации [целевых объектов ссылок DFS](/previous-versions/windows/it-pro/windows-server-2003/cc782417(v=ws.10)).

в следующем примере документа метаданных модуля записи frs показан пример документа метаданных модуля записи frs для контроллера домена с папкой sysvol в папке D: \\ Windows \\ sysvol. Путь, показанный в разделе "Исключенные файлы", будет таким же, как и полученный при запросе раздела реестра **SYSVOL** службы Netlogon:

**HKey \_ \_** Параметры входа в систему локального компьютера \\ **System** \\ **CurrentControlSet** \\ **Services**( \\  \\  \\ **SYSVOL** )

Единственное исключение из этого правила возникает, когда контроллер домена находится в перенаправленном состоянии [миграции SYSVOL](https://blogs.technet.com/filecab/archive/2008/02/08/sysvol-migration-series-part-1-introduction-to-the-sysvol-migration-process.aspx). В этом состоянии записи, соответствующие FRS и службе [DFSR](/windows-server/storage/dfs-replication/migrate-sysvol-to-dfsr) , сообщают о соответствующих копиях папки SYSVOL. Тем не менее копия папки SYSVOL в службе [DFSR](/windows-server/storage/dfs-replication/migrate-sysvol-to-dfsr) (обычно это папка с именем SYSVOL \_ DFSR) является общей для контроллера домена; это путь, на который ссылается раздел реестра **SYSVOL** .

Для модуля записи VSS FRS требуется пользовательский метод восстановления. Это означает, что при восстановлении файлов, реплицируемых службой FRS, необходимо выполнить определенные пользовательские действия. Дополнительные сведения см. в статье выполнение неполномочного восстановления папки FRS-Replicated SYSVOL.

> [!Note]  
> резервные копии состояния системы для Windows контроллеров домена не включают базу данных frs, которая хранит сведения о состоянии для службы frs, относящейся к файлам в папке SYSVOL и других наборах содержимого. База данных FRS, журналы отладки, файлы промежуточной области и файлы в уже [существующей папке данных](/previous-versions/windows/it-pro/windows-server-2003/cc758169(v=ws.10)) исключаются из резервной копии состояния системы. Следующий пример спецификации модуля записи FRS содержит список исключений в разделе "Исключенные файлы".

 

## <a name="sample-frs-writer-metadata-document"></a>Пример документа метаданных модуля записи FRS

ниже приведен пример документа метаданных модуля записи FRS для контроллера домена, путь к которому папки sysvol — D: \\ Windows \\ SYSVOL.

``` syntax
* WRITER "FRS Writer"
    - Writer ID   = {d76f5a28-3092-4589-ba48-2958fb88ce29}
    - Writer Instance ID = {07ae58e5-6977-4e34-9dfe-399bbd2cbe40}
    - Supports restore events = FALSE
    - Writer restore conditions = VSS_WRE_NEVER
    - Restore method = VSS_RME_CUSTOM
    - Requires reboot after restore = FALSE

    - Excluded files:
       - Exclude: Path = d:\windows\ntfrs\jet, Filespec = *
       - Exclude: Path = d:\Windows\debug\NtFrs, Filespec = NtFrs*
       - Exclude: Path = d:\windows\sysvol\domain\DO_NOT_REMOVE_NtFrs_PreInstall_Directory, Filespec = *
       - Exclude: Path = d:\windows\sysvol\domain\NtFrs_PreExisting___See_EventLog, Filespec = *
       - Exclude: Path = d:\windows\sysvol\staging\domain, Filespec = NTFRS_*

    - Component "FRS Writer:\SYSVOL\da45368c-b2d3-4cf0-bdc338a2cde15a7b"
       - Name: 'da45368c-b2d3-4cf0-bdc338a2cde15a7b'
       - Logical Path: 'SYSVOL'
       - Full Path: '\SYSVOL\da45368c-b2d3-4cf0-bdc338a2cde15a7b'
       - Caption: ''
       - Type: VSS_CT_FILEGROUP [2]
       - Is Selectable: 'TRUE'
       - Is top level: 'TRUE'
       - Notify on backup complete: 'TRUE'
       - Components:
       - File List: Path = d:\windows\sysvol, Filespec = *
       - Affected paths by this component:
         - d:\windows\sysvol
       - Affected volumes by this component:
         - \\?\Volume{da897ba5-5840-11db-93c1-806e6f6e6963}\ [D:\]
       - Component Dependencies:
```

## <a name="setting-registry-keys-for-a-restore-of-an-frs-replicated-sysvol-folder"></a>Настройка разделов реестра для восстановления папки FRS-Replicated SYSVOL

Раздел реестра **BurFlags** используется для выполнения полномочного или неполномочного восстановления членов FRS НАБОРОВ реплик DFS или SYSVOL. В глобальном (на уровне компьютера) разделе реестра **BurFlags** СОДЕРЖАТСЯ \_ значения reg DWORD и находится в следующем расположении в реестре:

**HKey \_ Локальный \_ компьютер** \\ **System** \\ **CurrentControlSet** \\ **службы** \\ **NtFrs** \\ **Параметры**, \\ процесс **резервного копирования и восстановления** \\ **при запуске**

Наиболее распространенные значения для раздела реестра **BurFlags** :

-   D2, также называемый неполномочным режимом восстановления.
-   D4, также называемое восстановлением в режиме полномочного режима.

Имеются глобальные разделы реестра **BurFlags** , относящиеся к набору реплик. При установке глобального ключа реестра **BurFlags** повторно инициализируются все наборы реплик, которые содержит этот элемент. Этот глобальный ключ должен быть установлен, если сервер содержит только один набор реплик, или если наборы реплик, которые она содержит, имеют относительно малое число и небольшой размер. Например, если сервер является контроллером домена, на котором не размещены наборы содержимого, реплицированные с помощью службы FRS, отличной от папки SYSVOL, можно установить глобальный раздел реестра **BurFlags** .

Глобальный раздел реестра **BurFlags** находится в следующем расположении в реестре:

**HKey \_ Локальный \_ компьютер** \\ **System** \\ **CurrentControlSet** \\ **службы** \\ **NtFrs** \\ **Параметры**, \\ процесс **резервного копирования и восстановления** \\ **при запуске**

В отличие от глобального ключа **BurFlags** , ключ **BurFlags** , зависящий от набора реплик, позволяет повторно инициализировать дискретные индивидуальные наборы реплик, что позволяет оставить работоспособные наборы репликации нетронутыми.

Разделы реестра **BurFlags** , относящиеся к набору реплик, можно найти, определив идентификатор GUID для данного набора реплик.

Следующая процедура описывает, как определить, какой GUID соответствует определенному набору реплики, и описывает настройку восстановления.

**Определение идентификатора GUID, соответствующего определенному набору реплик, и Настройка восстановления**

1.  Завершите работу службы FRS.
2.  Чтобы определить идентификатор GUID, представляющий определенный набор реплик, выполните следующие действия.
    1.  В реестре откройте следующий раздел.

        **HKey \_ Локальные \_ Компьютеры** \\ **System** \\ **CurrentControlSet** \\ **Services службы** \\ **NtFrs** \\ **Параметры** \\ **набора реплик**

    2.  Под подразделом **наборов реплик** имеется один или несколько подразделов, каждый из которых идентифицируется по идентификатору GUID.
    3.  Значение **корня набора реплик** для каждого идентификатора GUID — это путь к файловой системе, указывающий набор реплик, представленный этим идентификатором GUID.
    4.  Перебрать этот список идентификаторов GUID, пока не будет найден нужный набор реплик. Обратите внимание на соответствующий идентификатор GUID.

3.  В реестре откройте следующий подраздел:

    **HKey \_ Локальный \_ компьютер** \\ **система** \\ **CurrentControlSet** \\ **службы** \\ **NtFrs** \\ **Параметры** для \\ **накопительных наборов реплик**

4.  Под этим подразделом выберите тот же идентификатор GUID, который был записан на шаге 2. Под подразделом GUID создайте запись для ключа **BurFlags** .
5.  Перезапустите службу FRS.

## <a name="performing-a-nonauthoritative-restore-of-an-frs-replicated-sysvol-folder"></a>Выполнение неполномочного восстановления папки FRS-Replicated SYSVOL

Неполномочное восстановление — это наиболее распространенный способ повторной инициализации репликации SYSVOL на отдельных контроллерах домена. Контроллеры домена, которые не восстанавливаются принудительно, должны иметь входящие подключения от других рабочих контроллеров домена, участвующих в Active Directory и репликации FRS. В крупной среде развертывания, состоящей из множества контроллеров домена, оставшиеся контроллеры домена можно восстановить с помощью восстановления неполномочного режима в следующих случаях:

-   Должен существовать хотя бы один известный работоспособный член реплики (контроллер домена с работоспособной папкой SYSVOL).
-   Другие контроллеры домена должны быть повторно инициализированы в порядке прямых партнеров репликации.

В следующей процедуре описывается, как выполнить неполномочное восстановление.

**Выполнение неполномочного восстановления**

1.  Завершите работу службы FRS.
2.  Восстановите данные из резервной копии в папку SYSVOL.
3.  Настройте раздел реестра **BurFlags** , задав для следующего раздела реестра значение DWORD D2.

    **HKey \_ Локальный \_ компьютер** \\ **System** \\ **CurrentControlSet** \\ **службы** \\ **NtFrs** \\ **Параметры** \\ **Backup/Restore** \\ **при запуске** \\ **BurFlags**

4.  Перезапустите службу FRS.

При перезапуске службы FRS выполняются следующие действия.

-   Значение раздела реестра **BurFlags** сбрасывается в ноль.
-   Файлы в повторно инициализированных папках FRS перемещаются в уже существующую папку.
-   Событие 13565 регистрируется в журнале событий FRS, чтобы сообщить о начале неполномочного восстановления.
    > [!Note]  
    > Коды событий службы FRS описаны в статье "коды ошибок журнала событий FRS" в базе знаний справки и поддержки по адресу <https://go.microsoft.com/fwlink/p/?linkid=117779>

     

-   База данных FRS перестраивается.
-   Член выполняет начальное соединение набора реплик от вышестоящего партнера или с компьютера, указанного в **родительском разделе реестра Set реплики** , если для НАБОРОВ реплик SYSVOL указан родительский элемент.
-   На повторно инициализированном компьютере выполняется полная репликация затронутых наборов реплик при запуске соответствующего расписания репликации.
-   После завершения процесса в журнал заносится событие 13516, сообщающее о работоспособности службы FRS. Если событие не заносится в журнал, возникает проблема с конфигурацией службы FRS.

> [!Note]  
> Размещение файлов в уже [существующей](/previous-versions/windows/it-pro/windows-server-2003/cc758169(v=ws.10)) папке на повторно инициализированных членах является защитой в службе FRS, которая предназначена для предотвращения случайной потери данных. Все файлы, предназначенные для реплики, которые существуют только в локальной папке и были реплицированы после того, как начальная репликация может быть скопирована в соответствующую папку. При исходящей репликации файлы в уже существующей папке можно удалить, чтобы освободить дополнительное место на диске.

 

## <a name="performing-an-authoritative-restore-of-an-frs-replicated-sysvol-folder"></a>Выполнение полномочного восстановления папки FRS-Replicated SYSVOL

Принудительное восстановление используется в качестве последнего средства в случае критических ситуаций, таких как расхождение данных в наборе содержимого, вызванных конфликтами каталогов. Например, для восстановления набора реплик FRS, где репликация полностью остановлена и требуется перестроение с нуля, может потребоваться полномочное восстановление.

Если необходимо выполнить полномочное восстановление папки SYSVOL, имейте в виду, что это очень сложный процесс. Исчерпывающие рекомендации, описывающие операции, которые необходимо выполнить для полномочного восстановления содержимого папки SYSVOL, описаны в статье «как перестроить дерево SYSVOL и его содержимое в домене» в базе знаний справки и поддержки по адресу <https://go.microsoft.com/fwlink/p/?linkid=117780> .

Перед выполнением полномочного восстановления FRS должны быть выполнены следующие требования:

1.  Служба FRS должна быть отключена для всех нижестоящих партнеров репликации (прямых и транзитивных) для повторно инициализированной папки SYSVOL до того, как будет настроено полномочное восстановление.
2.  События 13553 и 13516 были записаны в журнал событий FRS. Эти события указывают на то, что членство в наборе реплик SYSVOL установлено на контроллере домена, настроенном для полномочного восстановления.
    > [!Note]  
    > Коды событий службы FRS описаны в статье "коды ошибок журнала событий FRS" в базе знаний справки и поддержки по адресу <https://go.microsoft.com/fwlink/p/?linkid=117779>

     

3.  Контроллер домена, настроенный для полномочного восстановления, настроен как полномочный для всех данных SYSVOL, которые должны реплицироваться на оставшиеся контроллеры домена.
4.  Все остальные партнеры в наборе реплик должны быть повторно инициализированы с неполномочным восстановлением.

 

 
