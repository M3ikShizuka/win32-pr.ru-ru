---
description: примечание. этот раздел относится только к Windows server 2003 R2 и Windows server 2003 с пакетом обновления 1 (SP1).
ms.assetid: a192d9a7-1c65-4251-acb1-4df03ebfe910
title: резервное копирование и восстановление состояния системы в Windows server 2003 R2 и Windows server 2003 SP1
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: de2fdb50e3f719a5208c2894f5659f927bcc922d
ms.sourcegitcommit: d75fc10b9f0825bbe5ce5045c90d4045e3c53243
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2021
ms.locfileid: "127461365"
---
# <a name="backing-up-and-restoring-system-state-in-windows-server-2003-r2-and-windows-server-2003-sp1"></a>резервное копирование и восстановление состояния системы в Windows server 2003 R2 и Windows server 2003 SP1

> [!Note]  
> этот раздел относится только к Windows server 2003 R2 и Windows server 2003 с пакетом обновления 1 (SP1). Сведения о других версиях операционных систем см. в разделе [резервное копирование и восстановление состояния системы](locating-additional-system-files.md).

 

> [!Note]  
> корпорация майкрософт не предоставляет техническую поддержку для разработчиков и ит-специалистов по реализации оперативного восстановления состояния системы на Windows (все выпуски). сведения об использовании интерфейсов api и процедур, предоставляемых корпорацией майкрософт для внедрения оперативного восстановления состояния системы, см. в материалах сообщества, доступных в [центре Community MSDN](https://msdn.microsoft.com/community/default.aspx).

 

при выполнении резервного копирования или восстановления VSS Windows состояние системы определяется как коллекция из нескольких ключевых элементов операционной системы и их файлов. Эти элементы всегда должны обрабатываться операциями резервного копирования и восстановления как единое целое.

в Windows server 2003 R2 и Windows server 2003 с пакетом обновления 1 (SP1) отсутствует Windows API, предназначенный для обработки этих объектов в качестве одного, поэтому рекомендуется, чтобы у запрашивающих сторон был собственный объект состояния системы, чтобы они могли обрабатывать эти компоненты согласованным образом.

поскольку служба VSS работает на версиях Windows, где [*защита системных файлов*](vssgloss-s.md) (WFP) защищает файлы состояния системы от повреждения, для резервного копирования и восстановления состояния системы требуются специальные действия.

Состояние системы состоит из следующих компонентов:

-   Все файлы, защищенные WFP, загрузочные файлы, включая конфигурации NTLDR, нтдетект и счетчиков производительности
-   Active Directory (ADSI) (в системах, являющихся контроллерами домена);
-   Папка системного тома (SYSVOL), которая реплицируется службой репликации файлов (FRS) (в системах, являющихся контроллерами домена).
-   Сервер сертификатов (на компьютерах, которые предоставляют центр сертификации)
-   база данных кластера (на системах, которые являются узлами кластера Windows)
-   Служба реестра
-   База данных регистрации классов COM+

Состояние системы можно архивировать в любом порядке.

Однако при восстановлении состояния системы сначала следует заменить загрузочные файлы и зафиксировать системный раздел (Hive) реестра в качестве завершающего шага процесса и выполнить его в следующем порядке:

1.  Восстановите файлы загрузки.
2.  База данных регистрации классов COM+
3.  Восстановление SYSVOL, сервера сертификатов и баз данных кластера (при необходимости).
4.  Active Directory восстановления (при необходимости).
5.  Восстановите реестр.

Некоторые системные службы, такие как центр сертификации, имеют традиционные модули записи VSS и следуют алгоритмам резервного копирования и восстановления VSS. Другие, например реестр, нуждаются в пользовательских операциях резервного копирования или восстановления. Дополнительные сведения см. в разделе [пользовательские резервные копии и восстановление](custom-backups-and-restores.md).

## <a name="vss-backup-and-restores-of-boot-and-system-files"></a>Резервное копирование и восстановление VSS для загрузочных и системных файлов

Загрузочный и системный файлы должны быть резервными копиями и восстановлены только как единая сущность.

Инициатор запроса может безопасно использовать теневые копии этих файлов, а также убедиться, что системный том и загрузочное устройство имеют [*теневое копирование*](vssgloss-s.md).

Системные и загрузочные файлы включают в себя:

-   Основные загрузочные файлы: <dl> NtLdr.exe  
    Boot.ini  
    NtDetect.com  
    NtBootDD.sys (при наличии)  
    </dl>
-   The WFP service catalog file must be backed up prior to backing up the WFP files, and it is found under: <dl> % SystemRoot% \\ system32 \\ катрут \\ {F750E6C3-38EE-11D1-85E5-00C04FC295EE} </dl>
-   Файлы конфигурации счетчиков производительности для всех файлов, защищенных с помощью [*защиты системных файлов*](vssgloss-s.md) и перечисленных [**сфкжетнекстпротектедфиле**](/windows/win32/api/sfc/nf-sfc-sfcgetnextprotectedfile) (см. раздел операции восстановления из защищенных файлов WFP в VSS) -   : <dl> % SystemRoot% \\ system32 \\ Perf? 00?. включая  
    % SystemRoot% \\ system32 \\ Perf? 00?. BAK </dl>
-если этот параметр присутствует, файл метабазы iis должен быть включен в операции резервного копирования и восстановления, так как он содержит состояние, используемое Microsoft Exchange и другими сетевыми приложениями. Этот файл находится в папке <dl> % SystemRoot% \\ system32 \\ InetSrv \\ MetaBase. bin </dl>
-   Если создается резервная копия файла метабазы IIS, то ключи, позволяющие приложениям считывать определенные зашифрованные записи, должны восстанавливаться как часть состояния системы. Файлы можно найти в разделе: <dl> % SystemRoot% \\ system32 \\ Microsoft \\ Protect\\\*  
    % AllUsersProfile% \\ Microsoft \\ Crypto \\ RSA \\ MachineKeys\\\* </dl>
-При резервном копировании загрузочных и системных файлов может потребоваться определить загрузочное устройство DOS, выполнив следующие действия. 1. найдите системный раздел в разделе "Установка системпартитион **\_ локального \_ компьютера**" раздела hKey \\  \\  \\ .
    2.  Передайте переменную корневой среды системы (% SystemRoot%) в Диспетчер подключений, чтобы получить имя устройства NT.

## <a name="vss-restore-operations-of-wfp-protected-files"></a>Операции восстановления VSS для защищенных файлов WFP

Служба WFP предназначена для предотвращения случайной или поэтапной замены системных файлов. Поэтому необходимо выполнить специальные действия по восстановлению данных WFP.

Означает, что модуль записи WFP должен указать метод VSS рме RESTORE при **\_ \_ \_ \_ перезагрузке** при определении его документа метаданных модуля записи. Если инициатор запроса определяет, что модуль записи WFP не смог указать этот метод Restore, он указывает на ошибку модуля записи.

Чтобы заменить системные файлы, запрашивающий объект должен реализовать метод Restore **\_ рме \_ RESTORE в службе VSS \_ при \_ перезагрузке** с помощью функции Win32 [**мовефиликс**](/windows/win32/api/winbase/nf-winbase-movefileexa) с параметром **MOVEFILE \_ delay \_ до \_ reboot** . Восстановленные файлы не копируются в реальные каталоги системных файлов до перезагрузки системы. Перезапись защищенных системных файлов выполняется только в том случае, если значение следующей записи реестра **reg \_ Word** равно 1:

**HKey \_ Система локального \_ компьютера** \\  \\ **CurrentControlSet** \\  \\ **диспетчер сеансов** управления \\ **алловпротектедренамес** = 1

Это значение должно быть задано до любой загрузки, в которой защищенные файлы должны быть заменены через [**мовефиликс**](/windows/win32/api/winbase/nf-winbase-movefileexa) и удалены после перезагрузки.

Кроме того, необходимо создать резервную копию и восстановить каталог системы Dllcache с помощью резервного копирования и восстановления загрузочного тома и найти его, изучив запись реестра **\_ \_ SZ Expand** :

**HKey \_ \_** \\ **программное обеспечение** локального компьютера \\ **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **WinLogon** \\ **сфкдллкаче**<dl> <dt>

                  Data type
</dt> <dd>                  \_распаковать \_ SZ</dd> </dl>

Содержимое каталога системы Dllcache перестраивается с помощью средства проверки системных файлов (SFC) из командной строки.

-   Параметр **/сканонце** сканирует все защищенные файлы при следующей загрузке системы.
-   Параметр **/scannow** сканирует все защищенные файлы немедленно.

Все защищенные файлы будут просканированы, а все недопустимые версии будут заменены как в каталоге, так и в расположении Dllcache.

Существует четыре файла, которые являются частью платформы WFP и не могут быть восстановлены с помощью файлов WFP:

<dl> Ctl3dv2.dll  
DtcSetup.exe  
NtDll.dll  
Smss.exe  
</dl>

Эти файлы помогают в процессе восстановления файлов WFP, поэтому существует циклическая зависимость. Сейчас нет способа восстановить эти файлы, кроме переустановки Windows.

 

 
