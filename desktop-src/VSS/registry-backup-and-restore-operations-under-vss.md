---
description: Служба реестра Windows поддерживает модуль записи VSS, называемый модулем записи реестра, который позволяет запрашивающим стороне создавать резервные копии системного реестра, используя данные, хранящиеся на теневом скопированном томе.
ms.assetid: 94a45b04-0bdc-4211-bed0-caeabba774af
title: Операции резервного копирования и восстановления реестра в VSS
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: db1a3022ec2fb08b07bcff8b28455ae7154e4c40
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105692885"
---
# <a name="registry-backup-and-restore-operations-under-vss"></a>Операции резервного копирования и восстановления реестра в VSS

Служба реестра Windows поддерживает модуль записи VSS, называемый модулем записи реестра, который позволяет запрашивающим стороне создавать резервные копии системного реестра, используя данные, хранящиеся на теневом скопированном томе. Дополнительные сведения о модуле записи реестра см. [в разделе модули записи VSS в Box](in-box-vss-writers.md).

Модуль записи реестра выполняет резервное копирование на месте и восстанавливает реестр. Кроме того, модуль записи реестра сообщает только о системных кустах; Он не сообщает о пользовательских кустах.

**Windows Server 2003:** Средство записи реестра использует промежуточный файл репозитория (также известный как файл выдам) для хранения данных реестра. Кроме того, модуль записи реестра сообщает о кустах системы и пользовательских кустах.

Идентификатор модуля записи реестра — AFBAB4A2-367D-4D15-A586-71DBB18F8485.

**Windows XP:** Модуль записи в реестр отсутствует. Данные реестра сообщаются модулем записи загрузочного состояния, ИДЕНТИФИКАТОРом модуля записи которого является F2436E37-09F5-41AF-9B2A-4CA2435DBFD5.

> [!Note]  
> Корпорация Майкрософт не предоставляет техническую поддержку для разработчиков и ИТ-специалистов по внедрению оперативного восстановления состояния системы в Windows (все выпуски). Сведения об использовании интерфейсов API и процедур, предоставляемых корпорацией Майкрософт для внедрения оперативного восстановления состояния системы, см. в разделе Ресурсы сообщества, доступные в [центре сообщества MSDN](https://msdn.microsoft.com/community/default.aspx).

 

> [!Note]  
> Следующие сведения относятся только к Windows Server 2003 и Windows XP.

 

## <a name="registry-backup-using-vss"></a>Резервное копирование реестра с помощью VSS

Модуль записи реестра экспортирует и сохраняет активные файлы реестра в расположениях, заданных параметром CurrentControlSet Control System раздела **hKey \_ локального \_ компьютера** \\  \\  \\  \\ **хивелист**.

Имена значений в этой записи реестра указывают на куст реестра, который необходимо сохранить, а данные значения содержат файл, содержащий файл (файл Hive). Файлы Hive указываются в следующем формате: \\ \\  \\  \\ *имя файла* пути к харддискволумексу устройства.

Например, в разделе **hKey \_ локальный \_ компьютер** \\ **System** \\ **CurrentControlSet** \\ **Control** \\ **хивелист** может появиться **\\ системное \\ \\ программное обеспечение реестра**  =  \\ Device \\ HarddiskVolume1 \\ Windows \\ system32 \\ config \\ Software.

Модуль записи реестра обеспечивает сохранение файлов Hive на диске перед его теневой копией.

При резервном копировании кустов реестра инициатор запроса заменит \\ \\ *харддискволумекс* устройства строкой [*объекта устройства*](vssgloss-d.md) для теневого копирования тома.

> [!Note]  
> \\Путь к \\ *харддискволумексу* устройства можно преобразовать в эквивалентный путь Win32 с помощью функции [**куеридосдевице**](/windows/win32/api/fileapi/nf-fileapi-querydosdevicew) . Дополнительные сведения см. в разделе [Получение имени файла из маркера файла](../memory/obtaining-a-file-name-from-a-file-handle.md) или [Отображение имен путей к томам](../fileio/displaying-volume-paths.md).

 

## <a name="registry-restore-using-non-vss-win32-apis"></a>Восстановление реестра с помощью API-интерфейсов Win32, отличных от VSS

Для восстановления в режиме «в сети» (в защищенном режиме или полной операционной системе) подразделы в разделе **\_ \_** \\  \\ реестра **CurrentControlSet** \\ **управления** сеансами в системе hKey Machine \\ **Manager** \\ **PendingFileRenameOperations** должны быть сохранены.

Функции [**мовефиликс**](/windows/win32/api/winbase/nf-winbase-movefileexa) и [**мовефилетрансактед**](/windows/win32/api/winbase/nf-winbase-movefiletransacteda) используют этот раздел реестра для хранения сведений о файлах, которые были переименованы с помощью \_ параметра MOVEFILE Delay \_ до \_ reboot в параметре *dwFlags* .

Чтобы сохранить содержимое раздела реестра **PendingFileRenameOperations** , приложение резервного копирования должно вызвать функцию [**реглоадкэй**](/windows/win32/api/winreg/nf-winreg-regloadkeya) , чтобы подключить файл реестра для восстановления в активном реестре. Приложение резервного копирования может затем использовать различные функции реестра для копирования нужных ключей и значений в загруженный куст. После завершения копирования должны быть вызваны функции [**функция RegFlushKey вернула**](/windows/win32/api/winreg/nf-winreg-regflushkey) и [**регунлоадкэй**](/windows/win32/api/winreg/nf-winreg-regunloadkeya) .

Для восстановления в автономном режиме (среда восстановления Windows или Windows PE) необязательно учитывать раздел реестра **PendingFileRenameOperations** .

## <a name="registry-restore-using-non-vss-win32-apis-in-windows-server-2003"></a>Восстановление реестра с помощью интерфейсов Win32 API, отличных от VSS, в Windows Server 2003

> [!Note]  
> Следующие сведения относятся только к операциям восстановления, связанным с аварийным восстановлением (также известным как восстановление исходного состояния системы), которые выполняются в Windows Server 2003.

 

При восстановлении реестра приложению резервного копирования необходимо переместить некоторые подразделы из текущего реестра в реестр, который необходимо восстановить.

Для этого приложение резервного копирования может вызвать **реглоадкэй** , чтобы подключить файл реестра для восстановления в текущем активном реестре. Затем он может использовать различные функции реестра для копирования нужных ключей и значений в загруженный куст. После завершения копирования вызываются **функция RegFlushKey вернула** и **регунлоадкэй** .

Существует раздел реестра, указывающий на то, что приложение восстановления (инициатор запроса) содержит разделы реестра в **\_ \_ \\ системе hKey Local Machine** , которые не должны перезаписываться во время восстановления:

**HKEY \_ локальный \_ компьютер \\ система \\ CurrentControlSet \\ элемент управления \\ баккупресторе \\ кэйснотторесторе**

Часть процесса восстановления состояния системы включает восстановление ранее созданного резервного реестра.

Приложения резервного копирования должны соблюдать особую осторожность при восстановлении куста **\_ локальной \_ \\ системы hKey** , так как при установке временной версии операционной системы Windows в новом кусте System будут установлены ключи, значения которых должны сохраняться после операции восстановления.

Например, если в системе замены имеется сетевая карта, отличающаяся от исходной системы, восстановление исходных ключей для предыдущей карты приведет к непредсказуемым результатам. Это происходит потому, что служба самонастраивающийся обнаружила и поместила в реестр соответствующие записи в реестре служб и драйверов. Эти значения должны быть сохранены для правильной загрузки после восстановления системы.

В этом разделе описывается, как приложения резервного копирования могут определить, какие ключи и файлы должны сохраняться при выполнении восстановления куста **\_ локальной \_ \\ системы hKey** . В некоторых случаях это влечет за собой программное копирование ключей из вновь установленного куста установки в куст, подлежащей восстановлению. В других случаях обеспечение того, что разделы реестра продукта не заменяются, так же просто, как и при указании таких ключей в INF-файле конфигурации продукта.

Ключи (и данные ключей), которые должны быть сохранены, перечисляются в кусте **\_ локальной \_ машины \\ hKey** в разделе

**HKEY \_ локальный \_ компьютер \\ система \\ CurrentControlSet \\ элемент управления \\ баккупресторе \\ кэйснотторесторе**

Key в виде наборов \_ строк с несколькими \_ SZами (называемых *ключевыми строками* в этом документе).

Приложение для резервного копирования (инициатор запроса) должно проверять значения этих ключей в активном реестре и восстановленном реестре, так как любое приложение или служба могут добавлять значения в любое время.

Способ интерпретации ключевых строк приложениями резервного копирования определяется по символам терминала:

1.  Строки ключей, заканчивающиеся обратной косой чертой (" \\ "), обрабатываются как подразделы. При обнаружении такой подстроки приложение резервного копирования должно сохранять все данные и все подчиненные ключи.

    Например, следующий параметр указывает, что все подчиненные ключи и данные должны сохраняться в ходе операции восстановления:

    **\_ \_ Сведения о загрузке (в файле hKey локального компьютера \\ System \\ CurrentControlSet \\ Services \\ Dmio \\ )\\**

    В этом случае этот ключ и все подразделы и данные должны быть скопированы из существующего реестра (то есть из копии, созданной при установке Windows) в только что восстановленный реестр. Это называется операцией *замены ключа* . Эта операция заменяет соответствующий ключ в восстановленном реестре.

2.  Строки ключей, символ завершения которых является звездочкой (" \* "), указывает, что все подразделы должны быть объединены. Например, строка ключа:

    **HKey \_ \_ \\ \\ \\ CURRENTCONTROLSET \\ Services \* System на локальном компьютере* _

    Указывает, что ключ служб в существующем реестре (например, созданные установкой Windows) необходимо объединить с восстановленным реестром. Это называется операцией _key MERGE *, и если подраздел существует как в существующем кусте, так и в восстановленном кусте, ключ в восстановленном каталоге сохраняется со следующими исключениями:

    -   Если подраздел в существующем кусте содержит значение с именем Start, а подраздел в восстановленном виде — нет.
    -   Если подраздел в существующем и восстановленном кусте содержит значение с именем "Start", а его числовое значение в существующем Hive меньше.

    Значение "Start" в реестре указывает, когда запускается служба или драйвер, и может иметь числовое значение от 0-4. Чем меньше значение, тем быстрее в процессе загрузки служба запустится.

    Если этот ключ существует и в существующем, и в восстановленном каталоге, необходимо проверить значение стартового ключа в каждом кусте. Если значение в существующем Hive меньше значения в восстановленном каталоге, то меньшее значение должно быть сохранено.

    Опять же, этот ключ используется для определения того, следует ли запускать службу или драйвер во время загрузки, в системное время, вручную, автоматически или быть отключенным. Более низкое значение представляет время начала. Предыдущее время начала должно быть применено к новому реестру, чтобы гарантировать, что служба или драйверы должным образом запускаться при следующей загрузке.

3.  Строки ключей, символ завершения которых не является ни символом обратной косой чертой, ни звездочка, интерпретируется как сохраняемые значения реестра.

    Например, строка ключа:

    **HKEY \_ локальный \_ компьютер \\ система \\ CurrentControlSet \\ Управление \\ сеансом диспетчер сеансов \\ PendingFileRenameOperations**

    Механизм, с помощью которого ключи могут быть сохранены программно, включает API реестра Win32. Например, один алгоритм перечисляется ниже:

    1.  Восстановите резервную копию файла куста System в файл. В этом примере дайте имя System. reg.
    2.  Используйте **реглоадкэй** для загрузки System. reg в раздел **hKey на \_ локальном \_ компьютере** с временным именем. Например, одно из таких имен может быть

        **\_ \_ \\ система tmp ЛОКАЛЬНОГО компьютера \_ (hKey)**

    3.  Перечислите значения в подразделе **кэйснотторесторе** из обоих разделов реестра и создайте надмножество списков. Скопируйте каждый такой ключ из существующего

        **система HKEY на \_ локальном \_ компьютере \\**

        в раздел

        **\_ \_ \\ система tmp ЛОКАЛЬНОГО компьютера \_ (hKey)**

        ключ в соответствии с семантикой, описанной выше.

    4.  По завершении используйте   &  точки входа функция RegFlushKey вернула **регунлоадкэй** , чтобы сохранить

        **\_ \_ \\ система tmp ЛОКАЛЬНОГО компьютера \_ (hKey)**

        вернемся к System. reg.

    5.  Наконец, используйте **регреплацекэй** , чтобы указать, что System. reg должен заменить

        **система HKEY на \_ локальном \_ компьютере \\**

        файл Hive, система.

 

 
