---
description: Процесс создания теневой копии
ms.assetid: ca484eec-31c6-4790-9232-3ed67263f6fb
title: Процесс создания теневой копии
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: dae0d0cff8e4afdbecb5c61a934be1a9c9b731cbdbee8778afd714f6802ca2ae
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119056362"
---
# <a name="the-shadow-copy-creation-process"></a>Процесс создания теневой копии

Ниже приведено подробное описание роли поставщика оборудования при создании набора теневых копий. Схему этого процесса см. в разделе [Создание теневых копий для поставщиков](shadow-copy-creation-for-providers.md).

1.  Когда инициатор запроса добавляет каждый том в набор теневых копий, VSS определяет связанные LUN. Например, составной том может состоять из нескольких LUN. VSS создает исходные [**\_ \_ сведения о LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) , используя сведения о физических устройствах для каждого LUN.
2.  VSS вызывает [**арелунссуппортед**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) , чтобы определить, поддерживает ли поставщик теневую копию для этого LUN. Поставщик оборудования использует [**\_ \_ сведения о LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) , чтобы определить, поддерживаются ли номера LUN. Это определение должно иметь значение "все" или "нет" — один и тот же поставщик оборудования должен поддерживать все LUN, участвующие в конкретном томе. В примере составного тома поставщик не может указать, что он поддерживает только один из LUN, составляющих том.
3.  Для каждого тома в наборе теневых копий VSS вызывает [**ивсшардвареснапшотпровидер:: бегинпрепареснапшот**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) с тем же массивом [**структур \_ \_ данных LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) . В рамках одного вызова все LUN в массиве являются уникальными, но один и тот же LUN может появиться в последующем вызове каждый раз, когда один и тот же LUN участвует в нескольких томах. Поставщик должен правильно справиться с этим случаем.
4.  Сразу после [**ивсспровидеркреатеснапшотсет:: ендпрепареснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)служба VSS установит флаги "только для чтения", "скрытый", "без буквы диска" и "теневое копирование" на всех затронутых LUN. Эти флаги реализуются с помощью скрытых секторов на MBR-дисках или в битах, относящихся к операционной системе, в записи заголовка секции на дисках GPT. Эти флаги приводят к тому, что все тома на затронутых дисках будут отображаться на принимающих компьютерах в качестве только для чтения и скрыты. Обратите внимание, что скопированные с помощью теневого копирования LUN не были зафиксированы на этом этапе, поэтому в случае сбоя системы флаги будут сняты, а исходный LUN не будет затронуты. То есть все тома исходного LUN будут считаться нормальными — и сохранить их исходные буквы дисков, подключенные папки и состояние чтения и записи.
    > [!Note]  
    > Поставщики не должны пытаться изменить какие либо флаги LUN.

     

5.  В [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)теневые копии LUN фиксируются. **Коммитснапшотс** должен быть возвращен в течение нескольких секунд, или процесс создания теневой копии, вероятно, завершится ошибкой.
6.  После [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)VSS очищает флаги для всех исходных LUN, участвующих в теневой копии. Так как на этом этапе были зафиксированы LUN теневой копии, в LUN теневой копии сохранены эти флаги.
7.  После [**ивсспровидеркреатеснапшотсет::P осткоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots)служба VSS очищает флаги LUN (заданный после [**Ивсспровидеркреатеснапшотсет:: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)) и уведомляет средства записи о необходимости разморозить их. Затем служба VSS вызывает методы [**ивсспровидеркреатеснапшотсет::P рефиналкоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-prefinalcommitsnapshots) и [**Ивсспровидеркреатеснапшотсет::P ostfinalcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postfinalcommitsnapshots) .
8.  VSS извлекает массив структур [**\_ \_ данных LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) , по одному для каждого созданного LUN теневого копирования путем вызова [**ивсшардвареснапшотпровидер:: жеттаржетлунс**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns). Поставщик должен предоставить достаточно информации, чтобы разрешить VSS и поставщику однозначно находить теневые копии в любое время и в любой системе, подключенной к подсистеме. На данный момент LUN теневого копирования должен быть недоступен для этого компьютера — поставщик должен использовать какой-либо механизм, отличный от, просто считывая сведения из LUN.
9.  Для перепереносимых теневых копий VSS добавляет следующее в документ компонентов резервного копирования, описывающий набор теневых копий:
    1.  Исходный массив [**\_ \_ данных LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) для LUN.
    2.  Новый массив [**\_ \_ данных LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) для службы теневого копирования LUN.
    3.  Области диска для каждого тома в наборе теневых копий.
10. Для автоматического импорта теневых копий начинается процесс импорта. В [**ивсшардвареснапшотпровидер:: локателунс**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns)поставщику будут предоставлены [**\_ \_ сведения о LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) , созданные в [**жеттаржетлунс**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) во время создания. Во время **локателунс** поставщик должен сделать эти теневые копии LUN видимыми для системы. Поставщик не должен вызывать повторное сканирование шины. Служба VSS приведет к тому, что повторное сканирование и перечисление будут разрешать обнаружение LUN с помощью PNP, а тома будут подключены к сети.
11. VSS вызывает [**ивсшардвареснапшотпровидер:: филлинлунинфо**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) для новых прибывших дисков в системе. Служба VSS использует массив [**\_ \_ данных**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) LUN службы теневого копирования LUN из **филлинлунинфо**, сравнивая его **с \_ \_ данными LUN VDS** , созданными во время создания в [**жеттаржетлунс**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) , и экстенты дисков для каждого тома в наборе теневых копий, чтобы определить вновь поступившие LUN теневого копирования.
12. На этом этапе все тома, содержащиеся в LUN теневого копирования, подключены к скрытым и только для чтения, а VSS имеет сопоставление исходного тома с теневой копией тома.

Поскольку один LUN может содержать части нескольких томов, набор LUN теневого копирования может включать "лишние" тома. Эти тома не являются частью набора теневых копий и не должны использоваться, так как они не гарантированно должны быть постоянными.

После импорта доступ к теневой копии можно получить с помощью метода [**ивссбаккупкомпонентс:: Query**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-query) . Теневая копия также может быть представлена в виде буквы диска, подключенной папки или общего доступа с помощью [**ивссбаккупкомпонентс:: експосеснапшот**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-exposesnapshot). Набор теневых копий также может быть преобразован в обычный LUN с помощью метода [**ивссбаккупкомпонентс:: бреакснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-breaksnapshotset) . В приложениях управления могут использовать соответствующие API управления дисками для дальнейшего управления LUN (например, изменение атрибутов чтения и записи).

### <a name="transportable-shadow-copies-on-a-san"></a>Перепереносимые теневые копии в сети SAN

начиная с Windows server 2003, datacenter Edition и Windows Server 2003 выпуск Enterprise, VSS позволяет переносить наборы теневых копий в сети SAN. С точки зрения поставщика, способного переносить LUN между узлами, между непереносимым и переносимым набором теневых копий не существует различий.

**Windows server 2003, выпуск Standard, Windows server 2003, Web Edition и Windows XP:** Перепереносимые наборы теневых копий не поддерживаются. все выпуски Windows Server 2003 с пакетом обновления 1 (SP1) поддерживают переносимые наборы теневых копий.

Перепереносимые наборы теневых копий должны создаваться с помощью атрибута **VSS \_ VOLSNAP \_ attr \_** , добавленного к контексту теневой копии, описанному в разделе Перечисление [**\_ \_ \_ \_ атрибутов моментальных снимков тома VSS**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes) . Все тома в наборе должны быть перепереносимыми. При возврате успеха из [**ивсшардвареснапшотпровидер:: арелунссуппортед**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported)поставщик указывает, что он не поддерживает LUN, а также может передавать LUN. Создание транспортного набора теневых копий завершается, когда VSS записывает сведения о LUN в документ компонентов резервного копирования. Набор теневых копий может быть импортирован только один раз после первоначального создания.

На принимающем компьютере инициатор импортирует набор теневых копий. Метод [**ивссбаккупкомпонентс:: импортснапшотс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) использует компоненты резервного копирования, описывающие набор теневых копий в качестве входных данных. Импорт продолжается следующим образом:

1.  VSS формирует массив структур [**\_ \_ данных LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) для теневого копирования из документа компоненты резервного копирования.
2.  Когда VSS вызывает [**ивсшардвареснапшотпровидер:: локателунс**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns), массив структур [**\_ \_ данных LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) , созданный в [**ивсшардвареснапшотпровидер:: жеттаржетлунс**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) , будет передан поставщику. При обработке этого метода поставщик должен сделать эти LUN теневой копии видимыми для системы. Поставщик не должен вызывать повторное сканирование шины. VSS запустит повторное сканирование и перечисление, чтобы разрешить обнаружение LUN с помощью PNP и подключить тома к сети.
3.  VSS вызывает [**ивсшардвареснапшотпровидер:: филлинлунинфо**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) для новых прибывших дисков в системе. VSS использует массив LUN теневого копирования для [**виртуальных \_ структур \_ LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) из **филлинлунинфо**, сравнивая его с **\_ \_ данными LUN VDS** , созданными во время создания набора теневых копий в [**жеттаржетлунс**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) , и экстенты дисков для каждого тома в наборе теневых копий, чтобы определить вновь поступившие LUN теневого копирования.
4.  На этом этапе все тома, содержащиеся в перенесенных LUN, монтируются как скрытые и доступные только для чтения, а у VSS есть сопоставление исходного тома с Томом теневых копий.

Как для одного компьютера, так и для транспортного варианта последовательность аналогична, начиная с точки, в которой вызывается [**жеттаржетлунс**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) . При автоматическом импорте шаги выполняются непосредственно после создания.

 

 
