---
description: 'Участие в добавочных и разностных резервных копиях, как правило, происходит при обработке событий Identify (Квссвритер:: onidentify), PrepareForBackup (Квссвритер: Онпрепаребаккуп) и моментального снимка (Квссвритер: Онпостснапшот).'
ms.assetid: 85c4e003-b531-4283-83aa-dd5cc53f35b1
title: Роль модуля записи в добавочных и разностных резервных копиях VSS
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0d3c84245c21a47ba5535eccdfcbf10e988cf72b30ea99ee92086a9ca8f65647
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119863874"
---
# <a name="writer-role-in-vss-incremental-and-differential-backups"></a>Роль модуля записи в добавочных и разностных резервных копиях VSS

Участие в добавочных и разностных резервных копиях, как правило, происходит при обработке событий [*Identify*](vssgloss-i.md) ([**квссвритер:: onidentify**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onidentify)), [*PrepareForBackup*](vssgloss-p.md) ([**Квссвритер: онпрепаребаккуп**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup)) и *моментального снимка* ([**квссвритер: онпостснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot)). Способ, которым участвует модуль записи, состоит в том, поддерживает ли он метки резервного копирования и время последнего изменения, а также указывает, поддерживает ли инициатор выполнения резервного копирования [*частичные операции с файлами*](vssgloss-p.md).

## <a name="handling-identify-events-during-incremental-and-differential-backups"></a>Обработка событий Identify во время добавочных и разностных резервных копий

При обработке события Identify модули записи устанавливают базовую архитектуру для добавочных и разностных операций резервного копирования через схему резервного копирования ([**\_ \_ схема резервного копирования VSS**](/windows/desktop/api/Vss/ne-vss-vss_backup_schema)) и тип резервной копии спецификации файлов ([**\_ \_ \_ \_ тип резервного копирования спецификаций файлов VSS**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)).

Модуль записи указывает, какие операции он поддерживает в документе метаданных модуля записи, путем создания битовой маски значений [**\_ \_ схемы резервного копирования VSS**](/windows/desktop/api/Vss/ne-vss-vss_backup_schema) и передачи ее в метод [**ивсскреатевритерметадата:: сетбаккупсчема**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-setbackupschema) . В результате модуль записи может указать, поддерживает ли он следующее:

-   Добавочное резервное копирование (**\_ \_ добавочное создание VSS**)
-   Разностные резервные копии (**\_ \_ разностное** резервное копирование VSS)
-   Добавочные и разностные резервные копии не могут быть смешанными (**\_ \_ \_ добавочная \_ разностная копия VSS**)
-   Добавочные и разностные резервные копии с использованием меток резервного копирования (**\_ \_ метки времени VSS**)
-   Добавочные и разностные резервные копии на основе сведений о последнем изменении файла (**\_ \_ Последнее \_ изменение VSS**)

Модули записи используют маску типа резервной копии спецификации файлов, чтобы предоставить сведения на уровне набора файлов запрашивающей стороны о том, как включить файлы в добавочную или разностную резервную копию.

Модуль записи может задать файловую маску типа резервной копии спецификации файлов при добавлении набора файлов в компонент путем создания битовой маски значений [**\_ \_ \_ \_ типа резервных копий спецификации файлов VSS**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type) и передачи их в [**ивсскреатевритерметадата:: Адддатабасефилес**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabasefiles), [**ивсскреатевритерметадата:: адддатабаселогфилес**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabaselogfiles)или [**IVssCreateWriterMetadata:: AddFilesToFileGroup**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addfilestofilegroup).

Существует три значения параметра "требуется резервное копирование" для перечисления [**\_ \_ \_ \_ типов резервных копий спецификации файлов VSS**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type) , которые влияют на разностное и добавочное резервное копирование.

-   **\_ФСБТ VSS \_ \_ требуется вся резервная копия \_**
-   **\_ \_ требуется добавочное \_ резервное копирование VSS фсбт \_**
-   **\_ \_ требуется разностное \_ резервное копирование VSS фсбт \_**

Есть три значения "требуется теневая копия":

-   **\_ \_ \_ требуется моментальный снимок фсбт для VSS \_**
-   **\_ \_ требуется добавочный \_ моментальный снимок VSS фсбт \_**
-   **\_ \_ требуется разностный \_ моментальный снимок VSS фсбт \_**

Наборы файлов с меткой "требуется теневая копия" указывает, нужно ли инициатору запроса копировать данные из теневой копии при выполнении операций ДОБАВОЧной, РАЗНОСТной или полной резервной копии (которая включает операции добавочного и разностного копирования).

Флаг "требуется резервное копирование", применяемый к операциям ДОБАВОЧного, РАЗНОСТного или всех операций резервного копирования, указывает, что модуль записи требует, чтобы копия текущей версии набора файлов была доступна после восстановления любой операции резервного копирования. Как правило, это означает, что если набор файлов помечен как "требуется резервное копирование", все его члены будут скопированы на носитель резервных копий во время добавочной или разностной резервной копии независимо от того, когда произошло их резервное копирование или изменение.

По умолчанию наборы файлов добавляются в компоненты со спецификацией файлов тип резервной **копии \_ фсбт для \_ всех необходимых \_ резервных копий \_** \| **VSS \_ фсбт \_ все \_ \_ необходимые снимки**. Таким образом, если разработчик модуля записи не решил использовать значение по умолчанию (выбрав другой тип резервной копии, используя частичные операции с файлами или файлы с разной разницей), файлы большинства наборов файлов обычно копируются в резервные носители целиком.

На этом этапе документ метаданных модуля записи модуля записи полностью заполняется большей частью информации, которую инициатору запроса потребуется запустить разностную или добавочную архивацию. Дополнительные сведения о наборе файлов или данных на уровне файлов для поддержки резервного копирования будут обрабатываться во время события [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) .

## <a name="handling-prepareforbackup-events-during-incremental-and-differential-backups"></a>Обработка событий PrepareForBackup во время добавочных и разностных резервных копий

Прежде чем инициатор запроса продолжит фактическую операцию резервного копирования, модули записи могут изменить спецификацию [*добавочной*](vssgloss-i.md) или [*разностной*](vssgloss-d.md) резервной копии, изменив документ компонентов резервного копирования инициатора запроса через интерфейс [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) .

Поскольку модули записи используют интерфейс [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) , они обычно выполняют эти подготовительные действия при обработке события [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) .

В [**квссвритер: онпрепаребаккуп**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup)модули записи могут точнее указать, как некоторые файлы должны оцениваться для резервного копирования, указать, какие механизмы следует использовать при их резервном копировании и, возможно, установить метки резервного копирования.

<dl> <dt>

<span id="Partial_Files"></span><span id="partial_files"></span><span id="PARTIAL_FILES"></span>Частичные файлы
</dt> <dd>

Если инициатор запроса поддерживает их, то модуль записи может создать добавочную или разностную резервную копию, реализованную с помощью частичных операций с файлами. (Модули записи могут определить, поддерживает ли инициатор запросов частичные операции с файлами, вызвав [**квссвритер:: испартиалфилесуппортенаблед**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispartialfilesupportenabled).)

Модули записи используют [**ивсскомпонент:: аддпартиалфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile) , чтобы указать, какие части выбранных файлов будут архивироваться во время добавочной или разностной операции. Запрашивающие стороны должны учитывать эту спецификацию и всегда должно создавать резервные копии указанных разделов файлов. (Дополнительные сведения о частичных операциях с файлами см. в разделе [Работа с частичными файлами](working-with-partial-files.md) .)

С помощью [**ивсскомпонент:: аддпартиалфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile)модуль записи может добавить в резервную копию файл, который ранее не был добавлен в один из его наборов компонентов ( [**Ивсскреатевритерметадата:: адддатабасефилес**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabasefiles), [**Ивсскреатевритерметадата:: AddDatabaseLogFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabaselogfiles)или [**IVssCreateWriterMetadata:: AddFilesToFileGroup**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addfilestofilegroup)) в качестве частичного файла. Все новые файлы, добавляемые в резервную копию таким образом, должны находиться на томе, который уже поддается теневому копированию для этой резервной копии.

Если файл участвует в операциях с частичными файлами, это замещает все типы резервных копий спецификаций файлов, которые игнорируются.

</dd> <dt>

<span id="Differenced_Files"></span><span id="differenced_files"></span><span id="DIFFERENCED_FILES"></span>Файлы различий
</dt> <dd>

Модули записи, поддерживающие последнюю измененную схему резервного копирования (**\_ \_ схема BS VSS**), могут добавлять [*файлы различий*](vssgloss-d.md) в добавочную или разностную резервную копию.

При указании файла различий модуль записи использует [**ивсскомпонент:: адддифференцедфилебиластмодифитиме**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) и задает путь, имя файла и рекурсивный флаг, однако они не должны совпадать с набором файлов, входящим в какие-либо компоненты.

На самом деле, модуль записи может добавить файл, не добавленный ранее в один из его наборов компонентов ( [**ивсскреатевритерметадата:: адддатабасефилес**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabasefiles), [**Ивсскреатевритерметадата:: адддатабаселогфилес**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabaselogfiles)или [**IVssCreateWriterMetadata:: AddFilesToFileGroup**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addfilestofilegroup)), в резервную копию как файл с разной кодировкой. Все новые файлы, добавляемые в резервную копию таким образом, должны находиться на томе, который уже поддается теневому копированию для этой резервной копии.

Как правило, модуль записи также задает время последнего изменения при добавлении файла различий, основываясь на собственном механизме записи журнала. Это время последнего изменения, если оно указано, должно всегда использоваться запрашивающими стороны при определении необходимости включения файла в добавочную или разностную резервную копию.

Модуль записи может не указывать время последнего изменения при добавлении файла различий в добавочный или разностный резервный набор данных. В этом случае запрашивающие стороны могут свободно использовать собственные механизмы (например, журналы предыдущих резервных копий или сведения о файловой системе), чтобы определить, следует ли включать файл в добавочную или разностную резервную копию.

Тип резервной копии спецификации файла для любого файла различий игнорируется.

</dd> <dt>

<span id="Backup_Stamps"></span><span id="backup_stamps"></span><span id="BACKUP_STAMPS"></span>Метки резервного копирования
</dt> <dd>

Модули записи, поддерживающие метки резервного копирования (**\_ \_ Метка времени VSS**), имеют собственный частный формат для хранения сведений о времени последнего резервного копирования. Эта информация создается модулем записи во время резервного копирования.

Метка резервного копирования хранится в документе компоненты резервного копирования в виде строки методом [**ивсскомпонент:: сетбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp) . Метка резервного копирования применяется ко всем наборам файлов в компоненте (или наборе компонентов), соответствующем экземпляру [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent).

Если у инициатора запроса есть доступ к метке резервной копии предыдущей резервной копии, она будет доступна для модуля записи путем вызова [**ивссбаккупкомпонентс:: сетпревиаусбаккупстамп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp).

Затем модуль записи может проверить эту метку времени с помощью [**ивсскомпонент:: жетпревиаусбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).

Обратите внимание, что инициатор запроса просто сохраняет и возвращает строку, содержащую метку резервного копирования. Он не знает ничего о формате строки или его использовании; Эти сведения имеют только модуль записи.

Модуль записи может обновить текущую метку резервного копирования с помощью [**ивсскомпонент:: сетбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp) после вызова [**Ивсскомпонент:: жетпревиаусбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp), тем самым записывая в его собственном формате дату текущей операции добавочного или разностного резервного копирования.

</dd> </dl>

 

 



