---
description: Создание теневых копий для поставщиков
ms.assetid: d5042945-ba81-40d0-b204-1f08d153a788
title: Создание теневых копий для поставщиков
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 91cc7306e7a13ef8e96ab032016a922411a70f95
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104080616"
---
# <a name="shadow-copy-creation-for-providers"></a>Создание теневых копий для поставщиков

## <a name="the-shadow-copy-creation-process"></a>Процесс создания теневой копии

Инициатор запроса — это приложение, которое инициирует запрос на создание теневой копии. Как правило, инициатор запроса является приложением резервного копирования. При необходимости служба VSS будет вызывать задействованные поставщики. Большинство поставщиков заинтересованы в трех конкретных запросах от инициатора запроса.

1.  Инициатор запроса начинает действие создания теневого копирования с помощью вызова [**ивссбаккупкомпонентс:: стартснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset). При этом создается идентификатор **GUID** типа **, \_ который** уникальным образом идентифицирует этот набор теневых копий — снапшотсетид. На этом этапе поставщик не участвует, но Снапшотсетид широко используется во всех последующих шагах.
2.  Для каждого тома, который он хочет включить в этот набор теневых копий, запросивший объект вызывает [**ивссбаккупкомпонентс:: аддтоснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset). VSS определяет, какой поставщик будет использоваться для теневого копирования тома.
    -   В наборе теневых копий может участвовать несколько поставщиков. Например, если системный том и том данных входят в один и тот же набор теневых копий, то поставщик системы может выступать в качестве поставщика теневого копирования для системного тома, в то время как поставщик оборудования может выступать в качестве поставщика теневого копирования для тома данных. Оба поставщика будут входить в один и тот же набор теневых копий, и пользователь будет ждать одинаковой согласованности на каждом из этих томов.
    -   Чтобы поставщик оборудования был выбран, поставщик оборудования должен поддерживать все LUN, участвующие в указанном томе.
    -   Все зарегистрированные поставщики получают возможность указывать поддержку для данного тома во время создания теневого копирования. Если более чем один поставщик указывает на поддержку, служба VSS сначала по умолчанию будет иметь поставщиков оборудования, поставщиков программного обеспечения и, наконец, поставщика системы (если другие поставщики не указывают на поддержку этого тома).
    -   Инициатор запроса может переопределить этот порядок по умолчанию, явно указав поставщика, который требуется для создания теневой копии.
    -   При наличии нескольких поставщиков оборудования, поддерживающих данный том, не существует гарантии того, в каком порядке будут вызываться поставщики оборудования.
3.  После одного или нескольких вызовов [**аддтоснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset)инициатор запроса может запросить создание теневой копии с помощью метода [**Ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) . Затем служба VSS работает с системой для создания теневой копии. Метод **доснапшотсет** выполняет эту работу асинхронно, и инициатор запроса может либо опросить, либо дождаться завершения процесса создания теневой копии.

На этой диаграмме показано взаимодействие между инициатором запроса, службой VSS, поддержкой ядра VSS, всеми вовлеченными модулями записи VSS и поставщиками оборудования VSS. Подробное описание этих взаимодействий см. в описании [процесса создания теневой копии](the-shadow-copy-creation-process.md) .

![взаимодействие между инициатором запроса, компонентами резервного копирования, модулями записи и поставщиками](images/vssimpl.png)

После завершения процесса создания теневой копии инициатор запроса может определить, успешно ли создана теневая копия, и, если нет, определить источник сбоя.

Интервал времени между замораживанием и разморозкой приложений для записи должен быть минимальным. Поставщик должен асинхронно запускать всю подготовительную работу, связанную с теневой копией (например, поставщик оборудования, использующий плекс, запускающий синхронизацию) в методе [**ивсшардвареснапшотпровидер:: бегинпрепареснапшот**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) , а затем дожидаться завершения в методе [**Ивсспровидеркреатеснапшотсет:: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) .

Существуют несколько окон временных ограничений, которые должны следовать поставщикам. В результате правильно работающие поставщики будут выполнять всю ненужную обработку перед [**ивсспровидеркреатеснапшотсет::P рекоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) и после [**Ивсспровидеркреатеснапшотсет::P ostcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots).

Набор теневых копий фиксируется при вызове [**доснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) . Дополнительные тома не могут быть добавлены позже, так как дополнительные тома не будут совместно использовать один момент времени.

В наборе теневых копий имеется ограничение в 64 томов. Конкретный том может сопоставляться с целым LUN, частью LUN или частями нескольких LUN. В большинстве конфигураций будет по одному тому на один LUN, хотя произвольные сопоставления возможны.

Количество наборов теневых копий или количество наборов теневых копий исходного тома не ограничено. Поставщик может определять определенные ограничения или динамически ограничиваться исходя из доступных аппаратных ресурсов.

### <a name="point-in-time-for-writerless-applications"></a>Приложения, которые не подготовились к моменту времени

VSS включает специальную поддержку, которая определяет определенный момент времени для всех томов в наборе теневых копий. Поставщикам оборудования не требуется напрямую взаимодействовать с этими технологиями ядра, так как они вызываются как часть обычной обработки фиксации теневого копирования. Тем не менее полезно понимать механизмы, используемые, поскольку в нем объясняется определение "на момент времени" для приложений без записи (приложений, которые не предоставляли интерфейс модуля записи VSS и поэтому не участвуют в процессе создания теневой копии тома).

Эта поддержка ядра VSS для общего момента времени распределяется между драйвером VolSnap.sys, файловыми системами и VSS.

1.  До вызова поддержки ядра VSS служба VSS уже выполняет следующие действия.
    1.  Определяет, какие тома должны быть включены в теневую копию.
    2.  Определяет, какой поставщик следует использовать на каждом томе.
    3.  Замороженные приложения, принимающие сообщения о зависании и разморозе.
    4.  Подготовлены поставщики для теневой копии путем вызова методов [**прекоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) . Все поставщики теперь ожидают выполнения фактического создания теневой копии.
2.  Затем создается точка во времени. Служба VSS одновременно очищает файловые системы на всех томах, которые должны быть теневыми копиями.
    1.  Служба VSS выдает \_ команду ioctl VOLSNAP \_ flush \_ и \_ удерживает \_ запись на каждом томе, который очищает файловые системы. Этот запрос IOCTL передается вниз по стеку хранилища в VolSnap.sys. Затем VolSnap.sys сохраняет все операции IRP до шага 4 ниже. Любая файловая система (например, RAW) без поддержки этого нового IOCTL передает неизвестный запрос IOCTL вниз, где он снова удерживается VolSnap.sys. На томах NTFS диск записи также фиксирует журнал NTFS.
    2.  Это приостанавливает все действия с метаданными NTFS/FAT. метаданные файловой системы фиксируются в чистом виде.
    3.  Мгновенная теневая копия: VolSnap.sys приводит к последующей очереди запросов IRP на все тома, подходящие для теневого копирования.
    4.  VolSnap.sys ожидает завершения всех ожидающих операций записи на тенев скопированных томах. Теперь тома загруженася с учетом операций записи и были загружена в точно тот же момент на каждом томе. Нет гарантии на запись в сопоставленные разделы пользователя или записи, выданные между (a) и (b) в файловых системах, которые не реализуют обратный вызов IOCTL (например, RAW).
3.  VSS предписывает каждому поставщику принимать в теневой копии, вызывая методы [**ивсспровидеркреатеснапшотсет:: коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) . Поставщики должны выполнить все подготовительные действия, чтобы это действие было быстрым.

    Обратите внимание, что система ввода-вывода загружена только во время выполнения этих методов [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) . Если поставщик выполняет синхронизацию исходных и теневых копий, то эту синхронизацию необходимо выполнить до возврата метода **коммитснапшотс** поставщика. Он не может выполняться асинхронно.

4.  Сразу после возврата последнего метода [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) поставщика служба VSS освобождает все ожидающие записи IRP (включая IRP, которые блокируют файловые системы по завершении их путей фиксации), вызывая другой IRP, переданный в VolSnap.sys.
5.  Если процесс теневого копирования был успешным, VSS сейчас:
    1.  Вызывает [**посткоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) для используемых поставщиков.
    2.  Вызывает [**квссвритер:: размораживание**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) для задействованных модулей записи.
    3.  Информирует инициатор запроса о завершении процесса теневого копирования.

[**Прекоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)и [**посткоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) являются критически важными. Все операции ввода-вывода в приложениях с модулями записи фиксируются от **прекоммитснапшотс** до **посткоммитснапшотс**; любые задержки влияют на доступность приложения. Все файловые операции ввода-вывода, в том числе операции ввода-вывода в приложении, приостанавливаются во время **коммитснапшотс**.

Поставщики должны выполнить всю критическую работу до возврата из [**ендпрепареснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots).

-   [**Коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) должен возвращаться в течение нескольких секунд. Фаза **коммитснапшотс** находится в окне очистки и удерживания. Поддержка ядра VSS отменит очистку и удержание, удерживающие операции ввода-вывода, если последующий выпуск не будет получен в течение 10 секунд, а VSS не завершит процесс создания теневой копии. В системе будут выполняться другие действия, поэтому поставщик не должен полагаться на все 10 секунд. Поставщик не должен вызывать API-интерфейсы Win32 во время фиксации, так как многие из них приведут к непредвиденным операциям записи и блокировки. Если поставщику требуется более нескольких секунд для завершения вызова, возникает большая вероятность того, что произойдет сбой.
-   Полная последовательность от [**прекоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) до возврата [**посткоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) сопоставляется с окном между модулями записи, получающими события замораживания и разморозкой. Значение по умолчанию модуля записи для этого окна составляет 60 секунд, но модуль записи может переопределять этот параметр с меньшим временем ожидания. Например, Microsoft Exchange Server Writer изменяет время ожидания на 20 секунд. В этом методе поставщики не должны тратить больше второго или двух.

Во время [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) поставщик должен избегать операций файлового ввода-вывода без подкачки. Такой ввод-вывод имеет очень высокую вероятность взаимоблокировки. В частности, поставщик не должен синхронно записывать журналы отладки или трассировки.

 

 



