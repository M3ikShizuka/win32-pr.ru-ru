---
description: 'На этом этапе резервного копирования инициализируются модуль записи и инициатор запроса, заполняются их внутренние структуры данных, задаются резервные копии и устанавливаются данные модуля записи или инициатора запроса через требуемый вызов Ивссбаккупкомпонентс:: Гасервритерметадата. Дополнительные сведения см. в разделе Общие сведения об обработке резервной копии в VSS.'
ms.assetid: 1fc46062-c4a0-4aa2-ae05-3d7cded18584
title: Общие сведения об инициализации резервного копирования
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 53fb97b43cf19ca60e3e4601899700e35bdad3aa
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105692899"
---
# <a name="overview-of-backup-initialization"></a>Общие сведения об инициализации резервного копирования

На этом этапе резервного копирования инициализируются модуль записи и инициатор запроса, заполняются их внутренние структуры данных, задаются резервные копии и устанавливаются данные модуля записи или инициатора запроса через требуемый вызов [**ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata). Дополнительные сведения см. в разделе Общие сведения об [обработке резервной копии в VSS](overview-of-processing-a-backup-under-vss.md).

В следующей таблице показана последовательность действий и событий, необходимых для инициализации резервного копирования.



| Действие запросившего                                                                                                                                                                                                                                                                                                                            | Событие                                                     | Действие записи                                                                                                                                                                                                                                              |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Создает интерфейс [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) и инициализирует его для управления резервной копией (см. раздел [**креатевссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents), [**ивссбаккупкомпонентс:: инитиализефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup)) и при необходимости включает или отключает модули записи в системе. | Нет                                                      | Нет                                                                                                                                                                                                                                                       |
| При необходимости задайте контекст для операций теневого копирования и при необходимости запросите систему о поставщиках и теневых копиях, которые он поддерживает (см. [**ивссбаккупкомпонентс:: SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext), [**Ивссбаккупкомпонентс:: Query**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-query)).                                               | Нет                                                      | Нет                                                                                                                                                                                                                                                       |
| Инициатор запроса может предоставить дополнительные сведения об обработке операций резервного копирования и восстановления (см [**. раздел ивссбаккупкомпонентс:: сетбаккупстате**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate)).                                                                                                                                                        | Нет                                                      | Нет                                                                                                                                                                                                                                                       |
| Инициирует асинхронное обращение с помощью модулей записи (см [**. ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata))                                                                                                                                                                                           | [*Указывается*](vssgloss-i.md) | Создает документ метаданных модуля записи (см. раздел [Работа с документом метаданных модуля записи](working-with-the-writer-metadata-document.md), [**квссвритер:: onidentify**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onidentify), [**ивсскреатевритерметадата**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscreatewritermetadata)). |



 

## <a name="requester-actions-during-backup-initialization"></a>Действия запросившего во время инициализации резервного копирования

Объект [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) можно использовать только для одной резервной копии. Таким образом, инициатор запроса должен перейти к концу резервного копирования, включая освобождение интерфейса **ивссбаккупкомпонентс** . Если резервная копия должна преждевременно завершиться, инициатору запроса необходимо вызвать [**ивссбаккупкомпонентс:: абортбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-abortbackup) , а затем освободить объект **ивссбаккупкомпонентс** (Дополнительные сведения см. в разделе [Прерывание операций VSS](aborting-vss-operations.md) ). Не пытайтесь возобновить интерфейс **ивссбаккупкомпонентс** .

Как правило, документ компонентов резервного копирования инициатора запроса инициализируется как пустой. Документ с сохраненными компонентами резервного копирования может быть загружен при вызове [**ивссбаккупкомпонентс:: инитиализефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) , как правило, в поддержке переносимых теневых скопированных томов. В этом случае модуль записи с инициатором запроса будет немного отличаться от описанного ниже. (Дополнительные сведения см. в разделе [Импорт переносимых теневых томов](importing-transportable-shadow-copied-volumes.md) .)

Чтобы добавить тома в набор теневых копий, инициатор запроса должен сначала задать контекст для операции теневого копирования, вызвав [**ивссбаккупкомпонентс:: SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext). Если этот метод не вызывается, используется контекст по умолчанию для теневых копий, \_ CTX \_ резервное копирование VSS. Сведения о настройке контекста теневой копии см. в разделе [конфигурации контекста теневого копирования](shadow-copy-context-configurations.md).

Чтобы начать выполнение программы установки до создания резервной копии, инициатор запроса должен вызвать [**ивссбаккупкомпонентс:: сетбаккупстате**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate). Это означает, что инициатор запроса сообщает средствам записи:

-   Тип резервной копии (как определено [**в \_ \_ поле Тип резервной копии VSS**](/windows/desktop/api/Vss/ne-vss-vss_backup_type))
-   Содержит ли резервная копия состояние загрузочной системы
-   Поддерживает ли инициатор запроса выбор отдельных компонентов или резервное копирование целых томов.

Все запрашивающие стороны, участвующие в операциях резервного копирования и восстановления, всегда должны вызывать [**ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata). Этот метод инициирует обмен данными с инициатором записи, создавая событие [*Identify*](vssgloss-i.md) (инициализация) VSS, в ответ на то, что модуль записи создает свой документ метаданных.

Перед вызовом [**ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata)у инициатора запроса есть возможность явно включать или отключать определенные конкретные классы записи и записи с помощью [**Ивссбаккупкомпонентс:: енаблевритерклассес**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-enablewriterclasses), [**IVssBackupComponents::D Isablewriterinstances**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-disablewriterinstances)и [**IVssBackupComponents::D isablewriterclasses**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-disablewriterclasses) (по умолчанию включены все классы). После вызова **ивссбаккупкомпонентс:: гасервритерметадата** эти вызовы не оказывают никакого влияния.

Поскольку невозможно получить список модулей записи в системе до вызова [**ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata), запрашивающие стороны могут рассмотреть создание и удаление второго экземпляра [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) для получения списка.

Не нужно вызывать метод [**ивссбаккупкомпонентс:: гасервритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) после завершения [**Ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata). Модули записи, которые не обрабатывали событие [*определения*](vssgloss-i.md) , сформированное вызовами, не будут частью списка модулей записи, предоставляющих метаданные, обнаруженные [**Ивссбаккупкомпонентс:: жетвритерметадатакаунт**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadatacount) и [**ивссбаккупкомпонентс:: Жетвритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) (см. раздел [Определение состояния модуля записи](determining-writer-status.md)).

## <a name="writer-actions-during-backup-initialization"></a>Действия модуля записи во время инициализации резервного копирования

В ответ на событие Identify служба VSS вызывает метод виртуального обработчика каждого средства записи [**квссвритер:: onidentify**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onidentify). Модуль записи создает документ метаданных модуля записи путем переопределения реализации **квссвритер:: onidentify** по умолчанию и использования интерфейса [**ивсскреатевритерметадата**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscreatewritermetadata) .

Обратите внимание, что приложения, отличные от текущего запрашивающего (например, системных приложений), могут создавать события, которые должны обрабатываться модулем записи. Кроме того, разработчик не может определить, какое приложение создало событие Identify, с помощью [**квссвритер:: \ Identify**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onidentify) .

Это происходит, если при обработке операции резервного копирования модуль записи может получить несколько событий типа Identify, модуль записи никогда не должен задавать сведения о состоянии в обработчике [**квссвритер:: onidentify**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onidentify) .

Вместо этого [**квссвритер:: onidentify**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onidentify) должен выполнить последовательный алгоритм создания документа метаданных модуля записи модуля записи, особенно потому, что после того, как модуль записи создаст документ, ни инициатор запроса, ни модуль записи не смогут его изменить. С этого момента это документ, предназначенный только для чтения.

Это означает, что число и тип [*компонентов*](vssgloss-c.md) , связанных с модулем записи, какие файлы являются частью каждого компонента, и явное исключение файлов из операций резервного копирования или восстановления после того, как модуль записи возвращает данные о событии Identify.

Все модули записи, участвующие в VSS, должны выполнять следующие действия:

1.  Укажите метод Restore для всех компонентов, управляемых модулем записи, с помощью [**ивсскреатевритерметадата:: сетресторемесод**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-setrestoremethod).
2.  Добавьте по крайней мере один компонент с помощью [**ивсскреатевритерметадата:: AddComponent**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addcomponent) (Дополнительные сведения о спецификации компонентов см. в разделе [Определение компонентов по модулям записи](definition-of-components-by-writers.md) ).

Модуль записи указывает файлы для участия в операциях резервного копирования или восстановления путем добавления [*наборов файлов*](vssgloss-f.md)— сочетания пути, спецификации файла и флага рекурсии к заданному компоненту с помощью [**Ивсскреатевритерметадата:: аддфилестофилеграуп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addfilestofilegroup), [**Ивсскреатевритерметадата:: Адддатабасефилес**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabasefiles)или [**IVssCreateWriterMetadata:: AddDatabaseLogFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabaselogfiles), в зависимости от типа (см. раздел [Добавление файлов в компоненты](definition-of-components-by-writers.md)).

Модуль записи может также содержать один или несколько пустых компонентов, компонентов, к которым не были добавлены файлы. Они очень полезны при Организации компонентов модуля записи. (См. раздел [логическое расположение компонентов](logical-pathing-of-components.md).)

Модуль записи использует [**ивсскреатевритерметадата:: аддексклудефилес**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addexcludefiles) , чтобы явно запретить включение файлов в резервную копию. Это явное исключение полезно, поскольку подстановочные знаки можно использовать для указания файлов для включения (см. раздел [исключение спецификации списка файлов](writer-metadata-document-contents.md)). Обратите внимание, что список исключить файлы имеет приоритет над списками файлов компонентов.

[**Ивсскреатевритерметадата:: аддалтернателокатионмаппинг**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addalternatelocationmapping) используется для создания [*сопоставлений альтернативного расположения*](vssgloss-a.md) для указанных наборов файлов, которые были добавлены в один из компонентов модуля записи. Эти сопоставления используются при восстановлении файлов, так как восстановление в исходное расположение файла невозможно или нежелательно. (См. раздел [Общие сведения о фактическом восстановлении файлов](overview-of-actual-file-restoration.md) и [расположениях резервного копирования и восстановления не по умолчанию](non-default-backup-and-restore-locations.md).)

Так как набор файлов резервной копии указан в документе метаданных модуля записи, он не может быть изменен позже. Таким образом, модуль записи должен быть закодирован таким образом, чтобы определение набора файлов включало все файлы, необходимые в резервной копии, либо по имени, либо через подстановочные знаки. Возможно, это могут быть некоторые файлы, которые могут быть созданы после события Identify.

 

 



