---
description: 'Дополнительные сведения: примеры инструментов Вшадов'
ms.assetid: 6a69b75b-ee4a-4613-ba05-d2deb42759b7
title: Примеры инструментов Вшадов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 86ec0a753f2865be98cfed76cd192a73cfc785b3fcdc487f7685c9f4ae7d52e8
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119056352"
---
# <a name="vshadow-tool-examples"></a>Примеры инструментов Вшадов

В следующих примерах показано, как использовать средство Вшадов для выполнения наиболее распространенных задач.

-   [Доступ к свойствам теневого копирования из скрипта CMD](#accessing-shadow-copy-properties-from-a-cmd-script)
-   [Доступ к непостоянным теневым копиям](#accessing-nonpersistent-shadow-copies)
-   [Копирование файла из теневой копии](#copying-a-file-from-a-shadow-copy)
-   [Перечисление всех файлов на устройстве теневого копирования](#enumerating-all-files-on-a-shadow-copy-device)
-   [Импорт переносимой теневой копии](#importing-a-transportable-shadow-copy)
-   [Включение модулей записи или компонентов](#including-writers-or-components)
-   [Исключение модулей записи или компонентов](#excluding-writers-or-components)
-   [Разбиение наборов теневых копий с помощью метода Бреакснапшотсетекс](#breaking-shadow-copy-sets-using-the-breaksnapshotsetex-method)

Полный список параметров командной строки и их использовании см. в разделе [Вшадов Tool и Sample](vshadow-tool-and-sample.md).

## <a name="accessing-shadow-copy-properties-from-a-cmd-script"></a>Доступ к свойствам теневого копирования из скрипта CMD

При использовании необязательного флага **-script** при создании теневых копий вшадов создает файл сценария cmd, содержащий переменные среды, связанные с созданными теневыми копиями, например следующие:

-   Идентификатор набора теневых копий, который хранится в переменной среды% ВШАДОВ \_ Set \_ ID%
-   Идентификаторы теневых копий, которые хранятся в переменных вида% ВШАДОВ \_ ID \_ *nnn*%, где *nnn* представляет индекс исходного тома в командной строке вшадов
-   Имена устройств теневого копирования, которые хранятся в переменных вида% ВШАДОВ \_ устройство \_ *nnn*%, где *nnn* — индекс исходного тома в командной строке вшадов

Созданный КОМАНДный файл можно использовать для выполнения ограниченных операций управления теневыми копиями.

> [!Note]  
> Событие [**баккупкомплете**](/windows/win32/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) Writer отправляется после выполнения скрипта **-exec** . VSS вызывает метод **ивссбаккупкомпонентс:: баккупкомплете** , чтобы сообщить средствам записи о завершении резервного копирования, а также модули записи, которые могут усечь журналы на этом этапе. Поэтому важно убедиться, что на самом деле завершена теневая или резервная копия. Если резервное копирование завершилось сбоем, можно отменить процесс создания, возвращая ненулевой код выхода в выполненном сценарии или команде. (см. документацию по команде exit в [Windows командной строке](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc754340(v=ws.11)).) Если пользовательская команда возвращается с ненулевым кодом выхода, создание теневой копии отменяется и **ивссбаккупкомпонентс:: баккупкомплете** не будет вызываться.

 

В следующем примере показано, как создать постоянную теневую копию из командной строки и использовать для ее предоставления командный скрипт.

1.  **вшадов-p-NW-Script = SETVAR1. cmd c:**
2.  **вызов SETVAR1. cmd**
3.  **C: \\>вшадов-El =% вшадов \_ ID \_ 1%, c: \\ Directory1**

## <a name="accessing-nonpersistent-shadow-copies"></a>Доступ к непостоянным теневым копиям

Непостоянные теневые копии автоматически удаляются при выходе из программы, которая их создает (в данном случае Вшадов). Для доступа к содержимому этих теневых копий Вшадов позволяет выполнить сценарий после создания теневых копий, но до выхода из программы Вшадов.

В следующем примере показано, как использовать параметр командной строки-exec для выполнения скрипта с именем "Enum. cmd":

**вшадов-NW-Exec = Enum. cmd c:**

В выполненном сценарии можно также запустить созданный скрипт SETVAR в этой пользовательской команде. Это позволяет сценарию получить доступ к содержимому теневых копий напрямую. Помните, что теневое устройство можно получить из \_ \_ переменной среды вшадов устройства nnn.

Ниже приведен пример сценария Enum. cmd:

``` syntax
call SETVAR1.cmd
for /R %VSHADOW_DEVICE_1%\ %%i in (*.*) do @echo %%i
```

Ниже приведена Командная строка для выполнения скрипта Enum. cmd:

**вшадов-NW-Exec = c: \\ Enum. cmd-Script = setvar1. cmd c:**

## <a name="copying-a-file-from-a-shadow-copy"></a>Копирование файла из теневой копии

В следующем примере показано, как скопировать файл из теневой копии.

1.  **dir > c: \\somefile.txt**
2.  **вшадов-p-NW-Script = SETVAR1. cmd c:**
3.  **вызов SETVAR1. cmd**
4.  **копирование% ВШАДОВ \_ устройства \_ 1% \\somefile.txt c: \\ somefile \_bak.txt**

## <a name="enumerating-all-files-on-a-shadow-copy-device"></a>Перечисление всех файлов на устройстве теневого копирования

В следующем примере показано, как перечислить все файлы на устройстве теневого копирования из пакетного файла.

1.  **dir > c: \\somefile.txt**
2.  **вшадов-p-NW-Script = SETVAR1. cmd c:**
3.  **вызов SETVAR1. cmd**
4.  **для/R% ВШАДОВ \_ устройства \_ 1%%% \\ i в ( \* ) выполнить @echo %% i**

## <a name="importing-a-transportable-shadow-copy"></a>Импорт переносимой теневой копии

Чтобы создать транспортную теневую копию на одном компьютере и импортировать ее на другой компьютер, необходимо иметь два компьютера, подключенные (через конфигурацию SAN), к массиву хранения данных, поддерживающему теневые копии оборудования VSS. На каждом компьютере должен быть установлен поставщик оборудования VSS.

В следующем примере показано, как создать и импортировать теневую копию.

1.  Создайте набор теневых копий на компьютере а (рабочем сервере), введя следующую команду после командной строки:

    **вшадов-p-t =bc1.xml**

    При этом не будут предоставляться устройства теневого копирования на компьютере A.

2.  Скопируйте документ с компонентами резервного копирования (bc1.xml) с компьютера A на компьютер B.
3.  Импортируйте теневой набор на компьютере B, введя следующую команду:

    **вшадов-i =bc1.xml**

При необходимости эти теневые копии можно предоставить как буквы диска или подключенные папки. Кроме того, можно нарушить работу теневого набора, чтобы сделать новые тома теневой копии доступны для чтения и записи.

Чтобы автоматизировать процесс управления теневыми наборами, можно использовать параметр командной строки **-script** для создания СКРИПТа cmd, содержащего идентификаторы теневых копий. Затем можно скопировать созданный скрипт вместе с компонентами резервного копирования на другой компьютер.

В следующем примере показано, как создавать, предоставлять и разрывать переносимые теневые копии с помощью сценариев CMD.

1.  Создайте набор теневых копий на компьютере а (рабочем сервере) из командной строки следующим образом:

    **вшадов-p-t =bc1.xml-Script = SC1. cmd**

    Укажите параметр **-script** , чтобы создать скрипт, содержащий правильные определения переменных среды. Обратите внимание, что при этом не будут предоставляться устройства теневого копирования на компьютере A.

2.  Скопируйте документ компонентов резервного копирования (bc1.xml) и созданный скрипт (SC1. cmd) с компьютера A на компьютер B.
3.  Импортируйте теневой набор на компьютере B, введя следующую команду:

    **вшадов-i =bc1.xml**

    Созданные устройства будут отображаться на компьютере B.

4.  Запустите созданный скрипт, чтобы задать переменные среды для набора теневых копий, введя имя файла в командной строке, как показано в следующем примере:

    **SC1. cmd**

    Будут заданы соответствующие переменные среды, как описано в статье свойства теневого копирования Access из скрипта CMD.

5.  Предоставьте теневые копии на компьютере B, введя следующие команды:
    1.  **rmdir/s c: \\ \_ точка подключения**
    2.  **mkdir c: \\ \_ точка подключения**
    3.  **вшадов — El =% ВШАДОВ \_ ID \_ 1%, c: \\ \_ точка подключения**

    На компьютере B будут созданы устройства теневого копирования.
6.  Разбейте набор теневых копий, чтобы сделать тома доступными для записи, введя следующую команду:**C: \\>вшадов – BW =% вшадов \_ Set \_ ID%**

Обратите внимание, что непостоянные транспортные теневые копии также можно импортировать, но они автоматически удаляются при завершении процесса **вшадов** **-i** . Чтобы импортировать теневые копии перед удалением, необходимо использовать параметр командной строки **-exec** , как описано в статье доступ к непостоянным теневым копиям.

## <a name="including-writers-or-components"></a>Включение модулей записи или компонентов

По умолчанию все модули записи участвуют в создании теневой копии. Чтобы определить, какие модули записи и компоненты будут включаться в набор теневых копий, используйте параметр командной строки **-WM** или **-wm2** , как описано в разделе [Вывод сведений о состоянии и метаданных модуля записи](vshadow-tool-and-sample.md).

Чтобы убедиться, что все компоненты модуля записи включены, используйте необязательный флаг **-Wi** в любом из следующих форматов:

-   **вшадов** **— Wi-** *вритернаме*
-   **вшадов** **-Wi** **"**_строка имени модуля записи_*_"_*
-   **вшадов** **-Wi** **{**_вритерид_*_}_*
-   **вшадов** **-Wi** **{**_InstanceId_*_}_*

Чтобы убедиться в том, что некоторые компоненты включены, используйте необязательный флаг **-Wi** в любом из следующих форматов:

-   **вшадов** **-Wi** *вритернаме ***: \\**_логикалпас_* _\\_ * _ComponentName_
-   **вшадов** **-Wi** **"**_строка имени модуля записи_*_" \\ :_*_логикалпас_ *_\\_* _ComponentName_
-   **вшадов** **-Wi** **{**_вритерид_*_}: \\_*_логикалпас_ *_\\_* _ComponentName_
-   **вшадов** **-Wi** **{**_InstanceId_*_}: \\_*_логикалпас_ *_\\_* _ComponentName_

В следующих примерах показано, как использовать необязательный флаг **-Wi** .

-   Указание *вритернаме*: \\ *логикалпас* \\ *ComponentName*:

    **вшадов-Wi = "модуль записи в реестр: \\ Реестр"**

-   Указание {*вритерид*}:

    **вшадов-Wi = {BE000CBE-11FE-4426-9C58-531AA6355FC4}**

-   Указание более одного модуля записи или компонента:

    **вшадов-Wi = "модуль записи в реестр: \\ Реестр"-Wi = "com+ Регдб Writer"**

## <a name="excluding-writers-or-components"></a>Исключение модулей записи или компонентов

Чтобы исключить все модули записи, используйте флаг **-NW** Optional при создании теневой копии.

Чтобы исключить все компоненты модуля записи, используйте необязательный флаг **-WX** в любом из следующих форматов:

-   **вшадов** **-WX** *вритернаме*
-   **вшадов** **-WX** **"**_строка имени модуля записи_*_"_*
-   **вшадов** **-WX** **{**_вритерид_*_}_*
-   **вшадов** **-WX** **{**_InstanceId_*_}_*

Чтобы исключить определенные компоненты, используйте необязательный флаг **-WX** в любом из следующих форматов:

-   **вшадов** **-WX** *вритернаме ***: \\**_логикалпас_* _\\_ * _ComponentName_
-   **вшадов** **-WX** **"**_строка имени модуля записи_*_" \\ :_*_логикалпас_ *_\\_* _ComponentName_
-   **вшадов** **-WX** **{**_вритерид_*_}: \\_*_логикалпас_ *_\\_* _ComponentName_
-   **вшадов** **-WX** **{**_InstanceId_*_}: \\_*_логикалпас_ *_\\_* _ComponentName_

В следующих примерах показано, как использовать необязательный флаг **-WX** .

-   Указание *вритернаме*: \\ *логикалпас* \\ *ComponentName*:

    **вшадов-WX = "модуль записи реестра: \\ Реестр"**

-   Указание {*вритерид*}:

    **вшадов-WX = {BE000CBE-11FE-4426-9C58-531AA6355FC4}**

-   Указание более одного модуля записи или компонента:

    **вшадов-WX = "модуль записи реестра: \\ Реестр"-WX = "com+ Регдб Writer"**

## <a name="breaking-shadow-copy-sets-using-the-breaksnapshotsetex-method"></a>Разбиение наборов теневых копий с помощью метода Бреакснапшотсетекс

В следующих примерах показано, как использовать параметр командной строки **-BEX** .

-   Указание того, что LUN теневой копии будет маскироваться от узла:

    **вшадов** **-BEX** **-Mask**

-   Указание того, что LUN теневой копии будет предоставляться узлу в качестве тома для чтения и записи:

    **вшадов** **-BEX** **-RW**

-   Указание того, что LUN теневой копии будет предоставляться узлу в качестве тома для чтения и записи и что ни одна из подписей дисков в LUN теневой копии не будет возвращена к исходным LUN:

    **вшадов** **-BEX** **-revert**

 

 
