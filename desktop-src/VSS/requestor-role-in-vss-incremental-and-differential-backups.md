---
description: 'Для поддержки добавочной или разностной операции резервного копирования инициатор запроса должен выполнить следующие действия:'
ms.assetid: a77700e3-8217-460e-bec9-1041d03eec41
title: Роль инициатора запроса в добавочных и разностных резервных копиях VSS
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 637d4bf97b97d484080c85a2345599a05e4bbd89f88a0c1786b5bda911a83331
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118122009"
---
# <a name="requester-role-in-vss-incremental-and-differential-backups"></a>Роль инициатора запроса в добавочных и разностных резервных копиях VSS

Для поддержки [*добавочной*](vssgloss-i.md) или [*разностной*](vssgloss-d.md) операции резервного копирования инициатор запроса должен выполнить следующие действия:

1.  Определите, какая версия модуля записи доступна (с помощью [**ивссбаккупкомпонентс:: жетвритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) , чтобы получить доступ к информации в документах метаданных модуля записи) — в частности, определите, какая схема резервного копирования поддерживается ([**\_ \_ схема резервного копирования VSS**](/windows/desktop/api/Vss/ne-vss-vss_backup_schema)).
2.  Задайте соответствующее состояние резервного копирования.
3.  Получите спецификации уровня файла и набора файлов для добавочной или разностной резервной копии.
4.  Выполните резервное копирование.

## <a name="requester-determination-of-incremental-and-differential-support-and-configuration"></a>Определение добавочной и разностной поддержки и конфигурации инициатора запроса

Инициатору запроса необходимо получить сведения о поддержке модуля записи до выбора компонентов для включения в добавочную или разностную резервную копию или настройки ее собственного состояния.

<dl> <dt>

<span id="Determining_Writer_Support"></span><span id="determining_writer_support"></span><span id="DETERMINING_WRITER_SUPPORT"></span>Определение поддержки модуля записи
</dt> <dd>

Инициатор запроса определяет, поддерживает ли заданный модуль записи добавочные или разностные резервные копии VSS, получая маску схемы резервного копирования с помощью метода [**ивссексаминевритерметадата:: жетбаккупсчема**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema) .

Маска схемы резервного копирования модуля записи, поддерживающая добавочные или разностные методы VSS, будет содержать **\_ \_ добавочную** или **\_ \_ разностную резервную копию** VSS или и то, и другое. Модули записи могут также определять ограничения на их участие с флагом **\_ \_ \_ добавочного \_ разностного копирования в VSS** . (Дополнительные сведения о схемах резервного копирования см. в разделе [**\_ \_ схема резервного копирования VSS**](/windows/desktop/api/Vss/ne-vss-vss_backup_schema) .)

</dd> <dt>

<span id="Setting_Requester_Backup_State"></span><span id="setting_requester_backup_state"></span><span id="SETTING_REQUESTER_BACKUP_STATE"></span>Задание состояния резервного копирования запросившего
</dt> <dd>

Инициатор запроса указывает на то, что резервная копия является добавочной или разностной резервной копией, настроив тип резервной копии на **\_ BT- \_ добавочную** копию VSS или **VSS \_ BT \_ Differential** с помощью метода [**ивссбаккупкомпонентс:: сетбаккупстате**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate) перед созданием события [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) .

Метод [**ивссбаккупкомпонентс:: сетбаккупстате**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate) также используется для указания того, предоставляет ли инициатор запроса [*частичную поддержку файлов*](vssgloss-p.md), которая часто используется для реализации определенных добавочных операций резервного копирования и восстановления.

</dd> </dl>

## <a name="getting-writer-specifications-for-incremental-and-differential-backups"></a>Получение спецификаций модуля записи для добавочных и разностных резервных копий

Сведения о спецификации резервного копирования файлов на уровне файлов ([**\_ \_ \_ \_ Тип резервной копии спецификации файлов VSS**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)), содержащиеся в документе метаданных модуля записи каждого модуля записи, доступны для проверки после успешного возврата [**ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata).

Тем не менее, модуль записи может добавлять [*файлы различий*](vssgloss-d.md) или запрашивать [*частичную поддержку файлов*](vssgloss-p.md) до успешной обработки события [*моментального снимка*](vssgloss-p.md) .

Различия в поддержке файлов и частичных файлов могут привести к переопределению типа резервной копии спецификаций файлов, поэтому инициатору может потребоваться отложить полный анализ всех спецификаций модуля записи о добавочных и разностных резервных копиях до успешного возврата [**ивссбаккупкомпонентс::P репарефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup).

<dl> <dt>

<span id="Getting_File_Backup_Specification_Information"></span><span id="getting_file_backup_specification_information"></span><span id="GETTING_FILE_BACKUP_SPECIFICATION_INFORMATION"></span>Получение сведений о спецификации резервного копирования файлов
</dt> <dd>

Сведения о спецификации резервного копирования файлов на уровне файлов ([**\_ \_ \_ \_ Тип резервной копии спецификации файлов VSS**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)) содержатся в документе метаданных модуля записи каждого модуля записи и могут быть проверены сразу после успешного возврата [**ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata).

Запрашивающие стороны должны получить маски спецификаций резервного копирования файлов ([**\_ \_ \_ \_ тип резервного копирования для файлов VSS**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)) для каждого набора файлов каждого компонента модуля записи, включаемого в добавочную или разностную резервную копию независимо от того, был ли компонент [*явно*](vssgloss-e.md) или [*неявно*](vssgloss-i.md) включен.

Инициатор запроса может определить, какой документ метаданных модуля записи должен быть запрошен с помощью [**ивссбаккупкомпонентс:: жетвритеркомпонентскаунт**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponentscount) и [**Ивссбаккупкомпонентс:: жетвритеркомпонентс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents). Экземпляр интерфейса [**ивссвритеркомпонентсекст**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext) , возвращенный **Ивссбаккупкомпонентс:: жетвритеркомпонентс** , предоставляет сведения о записи с помощью метода [**ивссвритеркомпонентсекст:: GetWriterInfo**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getwriterinfo) .

Инициатор запроса получает сведения о компонентах через экземпляры интерфейса [**ивссвмкомпонент**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent) , соответствующие включаемому компоненту, управляемому заданным средством записи, с помощью [**ивссексаминевритерметадата::-Component**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent).

Сведения о наборах файлов, управляемых компонентом, соответствующим интерфейсу [**ивссвмкомпонент**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent) , получаются вызовами методов [**ивссвмкомпонент::-File**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getfile), [**Ивссвмкомпонент:: Жетдатабасефиле**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabasefile)или [**ивссвмкомпонент:: GetDatabaseLogFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabaselogfile) (при необходимости).

Эти вызовы могут возвращать экземпляры интерфейса [**ивссвмфиледеск**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) для каждого набора файлов компонента.

Тип резервной копии спецификации файлов для набора файлов получен путем вызова [**ивссвмфиледеск:: жетбаккуптипемаск**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getbackuptypemask).

</dd> <dt>

<span id="Getting_Partial_File_and_Differenced_File_Information"></span><span id="getting_partial_file_and_differenced_file_information"></span><span id="GETTING_PARTIAL_FILE_AND_DIFFERENCED_FILE_INFORMATION"></span>Получение сведений о частичном файле и различии файлов
</dt> <dd>

Инициатор запроса получает частичный файл и более разные сведения о файле через интерфейс [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) .

Инициатор запроса может выполнять итерацию всех модулей записи, входящих в резервную копию, с помощью [**ивссбаккупкомпонентс:: жетвритеркомпонентскаунт**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponentscount) и [**Ивссбаккупкомпонентс:: жетвритеркомпонентс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents).

Экземпляр интерфейса [**ивссвритеркомпонентсекст**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext) , возвращенный [**Ивссбаккупкомпонентс:: жетвритеркомпонентс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents) , предоставляет доступ ко всем экземплярам интерфейса [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) , соответствующим [*специально включаемым*](vssgloss-e.md) компонентам средства записи с помощью методов [**IVssWriterComponentsExt::-Component**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponent) и [**IVssWriterComponentsExt:: GetComponentCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponentcount) .

Инициатору запроса потребуется пройти все экземпляры [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) для всех модулей записи, схема которых поддерживает добавочную или разностную резервную копию, то есть модули записи, для которых маска схемы резервного копирования, возвращенная [**Ивссексаминевритерметадата:: жетбаккупсчема**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema), включает в себя **\_ \_ добавочную копию VSS** , если тип резервного копирования является **BT- \_ \_ добавочным**, или **\_ \_ разностной** копией VSS, если тип резервной копии является **\_ \_ разностной** копи

Частичные сведения о файле получаются путем вызова [**ивсскомпонент:: жетпартиалфилекаунт**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfilecount) и [**Ивсскомпонент:: жетпартиалфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) (см. раздел [Работа с частичными файлами](working-with-partial-files.md)).

Для модулей записи, которые поддерживают операции резервного копирования на основе данных о последнем изменении файла (записи, маска схемы резервного копирования которых была возвращена [**ивссексаминевритерметадата:: жетбаккупсчема**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema), включает в себя **\_ \_ Последнее \_ изменение VSS**), полученные сведения о файле получаются путем вызова [**Ивсскомпонент:: жетдифференцедфилескаунт**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdifferencedfilescount) и [**IVssComponent:: GetDifferencedFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdifferencedfile).

Обратите внимание, что файлы с различиями могут быть новыми, то есть файлами, не входящими ни в один файл, который в настоящий момент находится в документе метаданных модуля записи данного модуля записи.

Запрашивающие стороны не должны искать файлы, входящие в состав для частичных файловых операций и как файлы различий. Если инициатор запроса сталкивается с подобным обстоятельством, он должен вернуть и зарегистрировать ошибку модуля записи.

Инициатор запроса по-прежнему может продолжать создавать резервные копии файлов проблемного модуля записи, но в этом случае это следует делать в соответствии со спецификацией, приведенной в сведениях о файле различий.

</dd> </dl>

## <a name="implementing-incremental-or-differential-backups"></a>Реализация добавочных или разностных резервных копий

Перед реализацией резервной копии запрашивающие стороны должны иметь сведения о том, какие модули записи поддерживают [*добавочную*](vssgloss-i.md) или [*разностную*](vssgloss-d.md) резервную копию, все запрошенные операции с частичными файлами, все файлы различий и тип резервных копий для всех остальных файлов.

<dl> <dt>

<span id="Nonsupporting_Writers"></span><span id="nonsupporting_writers"></span><span id="NONSUPPORTING_WRITERS"></span>Неподдерживаемые модули записи
</dt> <dd>

Модули записи, схема которых не поддерживает добавочную или разностную резервную копию (модули записи, чья маска схемы резервного копирования, возвращенная [**ивссексаминевритерметадата:: жетбаккупсчема**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema), включает в себя **\_ \_ добавочную копию VSS** , если тип резервного копирования — **BT- \_ \_ добавочная** или не включает **\_ \_ разностную копию VSS** , если резервная копия VSS является **\_ \_ разностной**) не обеспечивает прямую поддержку добавочной или разностной архивации

Это не обязательно означает, что данные модуля записи не будут участвовать в добавочной или разностной операции резервного копирования. Тем не менее, при выборе того, что нужно сделать, — это по усмотрению автора запроса. Инициатор запроса может выполнять следующие действия:

-   Резервное копирование файлов, относящихся к неподдерживаемым модулям записи (явное указание пользователю)
-   Резервное копирование всех файлов неподдерживаемых модулей записи
-   Выполните добавочное резервное копирование с помощью данных файловой системы и собственных журналов инициатора запроса.

Последняя альтернатива должна использоваться с большой осторожностью и только в том случае, если инициатор запроса понимает, поддерживает ли модуль записи добавочное или разностное резервное копирование и восстановление данных независимо от механизма VSS.

</dd> <dt>

<span id="Supporting_Writers"></span><span id="supporting_writers"></span><span id="SUPPORTING_WRITERS"></span>Вспомогательные модули записи
</dt> <dd>

Инициатору запроса необходимо обработать (по порядку) все [*файлы с разной*](vssgloss-d.md)записью, а затем обработать все [*частичные*](vssgloss-p.md) запросы файлов, а затем выполнить резервное копирование оставшихся файлов в соответствии с их типом резервной копии ([**\_ \_ \_ \_ тип резервного копирования спецификации файлов VSS**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)).

1.  **Резервное копирование различных файлов:**

    Для модулей записи, которые поддерживают операции резервного копирования на основе данных о последнем изменении (записи, маска схемы резервного копирования которых была возвращена [**ивссексаминевритерметадата:: жетбаккупсчема**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema), включает в себя **\_ \_ Последнее \_ изменение VSS**), запрашивающая сторона использует путь, спецификацию файла и сведения о флагах рекурсии, возвращаемые [**ивсскомпонент:**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdifferencedfile)

    [**Ивсскомпонент:: жетдифференцедфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdifferencedfile) может также возвращать время последнего изменения (выраженное в виде структуры [**fileTime**](/windows/win32/api/minwinbase/ns-minwinbase-filetime) ).

    Если время последнего изменения, предоставленное модулем записи, не равно нулю, то инициатор запроса использует его в качестве основы (а не сведений о файловой системе или собственных сохраненных данных запрашивающей стороны) для определения того, должен ли файл быть включен в [*добавочную*](vssgloss-i.md) или [*разностную*](vssgloss-d.md) резервную копию.

    Например, если время последнего изменения файла, возвращенное модулем записи, было:

    -   После последнего полного резервного копирования файл должен быть добавлен как в добавочную, так и в разностную резервную копию.
    -   После последнего полного резервного копирования, но до последнего добавочного резервного копирования, файл должен быть добавлен в операции добавочного резервного копирования, но не на разностное резервное копирование.

    Если время последнего изменения, предоставленное модулем записи, равно нулю, то запрашивающая сторона должна использовать сведения о файловой системе и собственные хранимые данные для определения времени изменения файла различий.

2.  **Использование частичных операций с файлами:**

    Если средство записи запросило резервное копирование файла с помощью операции частичного файла, то запросивший объект использует сведения о смещении файла для сохранения указанных сегментов файлов на носителе резервных копий. (Дополнительные сведения о частичных операциях с файлами см. в разделе [Работа с частичными файлами](working-with-partial-files.md) .)

    Как отмечалось выше, модуль записи не должен обозначать файл как файл различий и как участник в операции частичного файла. Если инициатор запроса сталкивается с подобным обстоятельством, он должен вернуть и зарегистрировать ошибку модуля записи.

    Инициатор запроса по-прежнему может продолжать создавать резервные копии файлов проблемного модуля записи, но в этом случае это следует делать в соответствии со спецификацией, приведенной в сведениях о файле различий.

3.  **Работа с спецификацией файлов тип резервного копирования:**

    После обработки всех различий файлов и частичных операций с файлами инициатор запроса теперь обрабатывает все оставшиеся файлы в резервном наборе данных на основе их типа резервной копии ([**\_ \_ \_ \_ тип резервного копирования спецификации файлов VSS**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)).

    Существует три значения параметра "требуется резервное копирование" для перечисления [**\_ \_ \_ \_ типов резервных копий спецификации файлов VSS**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type) , которые влияют на разностное и добавочное резервное копирование.

    -   \_ФСБТ VSS \_ \_ требуется вся резервная копия \_
    -   \_ \_ требуется добавочное \_ резервное копирование VSS фсбт \_
    -   \_ \_ требуется разностное \_ резервное копирование VSS фсбт \_

    Есть три значения "требуется теневая копия":

    -   \_ \_ \_ требуется моментальный снимок фсбт для VSS \_
    -   \_ \_ требуется добавочный \_ моментальный снимок VSS фсбт \_
    -   \_ \_ требуется разностный \_ моментальный снимок VSS фсбт \_

    Наборы файлов с меткой "требуется теневая копия" указывают на то, что инициатору запроса необходимо копировать данные из теневой копии при выполнении ДОБАВОЧных, РАЗНОСТных или всех операций резервного копирования.

    Флаг "требуется резервное копирование", применяемый к операциям ДОБАВОЧного, РАЗНОСТного или всех операций резервного копирования, указывает, что модуль записи требует, чтобы копия текущей версии набора файлов была доступна после восстановления любой операции резервного копирования. Как правило, это означает, что если набор файлов помечен как "требуется резервное копирование", инициатор запроса скопирует все его члены на носитель резервных копий во время добавочной или разностной резервной копии независимо от того, когда произошло их резервное копирование или изменение.

    По умолчанию наборы файлов добавляются в компоненты со спецификацией файлов тип резервной копии \_ фсбт для \_ всех необходимых \_ резервных копий \_ \| VSS \_ фсбт \_ все \_ \_ необходимые снимки. Таким образом, если модуль записи явно не задает тип резервной копии спецификации файла в противном случае, инициатору потребуются копии файлов, не обработанных с помощью частичных операций с файлами, или файлы с определенными отличиями в большинстве наборов файлов, как правило, полностью копируются на носители резервных копий.

</dd> <dt>

<span id="Backup_Stamps"></span><span id="backup_stamps"></span><span id="BACKUP_STAMPS"></span>Метки резервного копирования
</dt> <dd>

Модули записи, поддерживающие метки резервного копирования ( \_ \_ Метка времени VSS), могут создавать сведения о штампах резервного копирования, которые будут использоваться для поддержки будущих добавочных и разностных операций резервного копирования и восстановления.

Формат и сведения, содержащиеся в строках, содержащих сведения о метке резервной копии, являются частными для модуля записи, который их создает. инициатор запроса не знает, как обрабатывать эту информацию.

Вспомогательные модули записи хранят метку резервного копирования в документе компоненты резервного копирования в виде строки с помощью метода [**ивсскомпонент:: сетбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp) .

Роль инициатора запроса в обработке сведений о метке резервного копирования — (если она существует), чтобы сделать ее доступной для модуля записи, вызвав [**ивссбаккупкомпонентс:: сетпревиаусбаккупстамп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp) в будущем операции резервного копирования или восстановления.

</dd> </dl>

 

 
