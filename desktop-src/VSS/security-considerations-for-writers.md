---
description: Инфраструктура VSS требует, чтобы процессы модуля записи могли функционировать как клиенты COM и как серверы.
ms.assetid: 59bb7a86-e874-45ce-abd6-cafd18802c4d
title: Вопросы безопасности для модулей записи
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 601b981613636a571c204acdfac78ada778bb19b16a3d2677c4e56ff3ee099cb
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119767684"
---
# <a name="security-considerations-for-writers"></a>Вопросы безопасности для модулей записи

Инфраструктура VSS требует, чтобы процессы модуля записи могли функционировать как клиенты COM и как серверы.

При работе в качестве серверов модули записи VSS предоставляют интерфейсы COM (например, обработчики событий VSS, такие как [**квссвритер:: onidentify**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onidentify)) и получают входящие вызовы COM из процессов VSS (например, запрашивающих и службы VSS) или вызовы RPC из процессов, которые являются внешними по отношению к VSS, обычно когда эти процессы создают события VSS (например, когда инициатор запроса вызывает [**Ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata)). Таким образом, модуль записи VSS должен безопасно управлять тем, какие клиенты COM могут выполнять входящие вызовы COM в процесс.

Аналогично, модули записи VSS также могут действовать как клиенты COM, делая исходящие вызовы COM обратными вызовами, предоставляемыми инфраструктурой VSS, или вызовы RPC к процессам, которые являются внешними по отношению к VSS. Эти обратные вызовы, предоставляемые приложением резервного копирования или службой VSS, позволяют модулю записи выполнять такие задачи, как обновление документа компонента резервного копирования через интерфейс [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) . Поэтому параметры безопасности VSS должны разрешать потокам записи исключать исходящие вызовы COM в другие процессы VSS.

Самым простым механизмом управления проблемами безопасности модуля записи является правильная выбор учетной записи пользователя, от имени которой она выполняется. Модуль записи обычно должен выполняться от имени пользователя, который является членом группы "Администраторы" или "операторы резервного копирования", либо должен запускаться как локальная системная учетная запись.

По умолчанию, когда модуль записи выступает в качестве клиента COM, если он не выполняется под этими учетными записями, любой вызов COM, который он делает, автоматически отклоняется с помощью **E \_ ACCESSDENIED** , не ПОЛУЧАЯ реализацию COM-метода.

## <a name="disabling-com-exception-handling"></a>Отключение обработки исключений COM

При разработке модуля записи установите \_ \_ флаг глобального параметра com комглб Exception не разграничения \_ Handle, чтобы отключить обработку исключений COM. Это важно, поскольку обработка исключений COM может маскировать неустранимые ошибки в приложении VSS. Ошибка, которая замаскирована, может привести к нестабильной работе и непредсказуемому состоянию, что может приводить к повреждению и зависаниям. Дополнительные сведения об этом флаге см. в разделе [иглобалоптионс](/windows/win32/api/objidlbase/nn-objidlbase-iglobaloptions).

## <a name="setting-writer-default-com-access-check-permission"></a>Задание разрешения на проверку доступа COM по умолчанию для модуля записи

Модули записи должны знать, что, когда их процессы работают в качестве сервера (например, для обработки событий VSS), они должны разрешать входящие вызовы от других участников VSS, таких как инициаторы запроса или служба VSS.

Однако по умолчанию процесс разрешается только клиентам COM, которые выполняются в одном сеансе входа в систему, идентификатором безопасности SELF) или выполняются под локальной системной учетной записью. Это потенциальная проблема, так как эти значения по умолчанию недостаточно для поддержки инфраструктуры VSS. Например, инициаторы запроса могут работать как учетная запись пользователя "оператор резервного копирования", которая не находится в том же сеансе входа, что и процесс записи или локальная системная учетная запись.

Для решения такого типа проблемы каждый серверный процесс COM может дополнительно контролировать, разрешено ли клиенту RPC или COM выполнять COM-метод, используемый сервером (в данном случае это средство записи), с помощью [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity) , чтобы установить разрешение на доступ по умолчанию для проверки доступа COM на уровне процесса.

Модули записи могут явно выполнять следующие действия:

-   Разрешить всем процессам доступ для вызова процесса записи.

    этот параметр может быть достаточно для многих модулей записи и используется другими серверами COM — например, все службы Windows на основе SVCHOST уже используют этот вариант, как и все службы COM+ по умолчанию.

    Разрешение всем процессам выполнять входящие вызовы COM не обязательно является слабостью безопасности. Модуль записи, действующий как сервер COM, как и все остальные серверы COM, всегда поддерживает возможность авторизации своих клиентов на каждом методе COM, реализованном в его процессе.

    Чтобы разрешить всем процессам доступ к модулю записи через COM, можно передать **нулевой** дескриптор безопасности в качестве первого параметра [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity). (Обратите внимание, что **CoInitializeSecurity** должен вызываться не более одного раза для всего процесса. Дополнительные сведения о **CoInitializeSecurity** см. в документации по com.)

    Ниже приведен пример кода, который включает вызов [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity):

    ``` syntax
    // Initialize COM security.
    hr = CoInitializeSecurity(
           NULL,                          // PSECURITY_DESCRIPTOR          pSecDesc,
           -1,                            // LONG                          cAuthSvc,
           NULL,                          // SOLE_AUTHENTICATION_SERVICE  *asAuthSvc,
           NULL,                          // void                         *pReserved1,
           RPC_C_AUTHN_LEVEL_PKT_PRIVACY, // DWORD                         dwAuthnLevel,
           RPC_C_IMP_LEVEL_IDENTIFY,      // DWORD                         dwImpLevel,
           NULL,                          // void                         *pAuthList,
           EOAC_NONE,                     // DWORD                         dwCapabilities,
           NULL                           // void                         *pReserved3
        );
    ```

    При явном задании безопасности на уровне COM модуля записи с помощью [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity)необходимо выполнить следующие действия.

    -   Задайте уровень проверки подлинности как минимум **RPC \_ C \_ AUTHN \_ Level \_ Connect**.

        Для повышения безопасности рассмотрите возможность использования **RPC \_ C \_ AUTHN \_ Level \_ PKT \_**.

    -   Установите уровень олицетворения **RPC \_ C на \_ \_ уровне Imp \_** , если процессу записи не нужно разрешать олицетворение для конкретных вызовов RPC или COM, которые не связаны с VSS.

-   Разрешить доступ только указанным процессам для вызова процесса записи.

    COM-сервер (например, модуль записи), вызывающий [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity) с дескриптором безопасности, не **равным NULL** , может использовать дескриптор для собственной настройки, чтобы принимать входящие вызовы только от пользователей, принадлежащих к определенному набору учетных записей.

    Модуль записи должен гарантировать, что клиенты COM, работающие с действительными пользователями, смогут обращаться к его процессу. Модуль записи, указывающий дескриптор безопасности в первом параметре, должен предоставить следующим пользователям возможность выполнять входящие вызовы в процессе запроса:

    -   Локальная система
    -   Члены локальной группы администраторов
    -   Члены группы локальных операторов резервного копирования
    -   Учетная запись, под которой выполняется модуль записи

## <a name="explicitly-controlling-user-account-access-to-a-writer"></a>Явное управление доступом учетной записи пользователя к модулю записи

Бывают случаи, когда доступ к модулю записи для выполнения процессов от имени локальной системы или локальных администраторов или локальных операторов резервного копирования может быть слишком ограниченным.

Например, процесс записи (возможно, не являющийся системным модулем записи) обычно не требуется запускать с учетной записью администратора или оператора резервного копирования. По соображениям безопасности лучше не искусственно повышать привилегии процесса для поддержки VSS.

В таких случаях **\_ \_** \\  \\  \\ необходимо изменить раздел реестра CurrentControlSet **Services** \\ **VSS** \\ для **вссакцессконтрол** служб, чтобы указать службе VSS, что указанный пользователь может быть защищен для выполнения модуля записи VSS.

В этом разделе необходимо создать подраздел с тем же именем, что и у учетной записи, которой должен быть предоставлен или запрещен доступ. Для этого подраздела необходимо задать одно из значений, приведенных в следующей таблице.

| Значение | Значение                                             |
|-------|-----------------------------------------------------|
| 0     | Запрещает пользователю доступ к модулю записи и инициатору запроса.  |
| 1     | Предоставьте пользователю доступ к своему модулю записи.               |
| 2     | Предоставьте пользователю доступ к инициатору запроса.            |
| 3     | Предоставьте пользователю доступ к своему модулю записи и инициатору запроса. |



 

В следующем примере предоставляется доступ к \\ учетной записи "mydomain myuser":

```
HKEY_LOCAL_MACHINE
   SYSTEM
      CurrentControlSet
         Services
            VSS
               VssAccessControl
                  MyDomain\MyUser = 1<dl>
<dt>

                  Data type
</dt>
<dd>                  REG_DWORD</dd>
</dl>
```

Этот механизм также можно использовать для явного ограничения выполнения модуля записи VSS другим разрешенным пользователем. В следующем примере ограничение доступа будет ограничено \\ учетной записью администратора сатдомаин:

```
HKEY_LOCAL_MACHINE
   SYSTEM
      CurrentControlSet
         Services
            VSS
               VssAccessControl
                  ThatDomain\Administrator = 0<dl>
<dt>

                  Data type
</dt>
<dd>                  REG_DWORD</dd>
</dl>
```

Администратор Сатдомаин пользователя \\ не сможет запустить модуль записи VSS.

 

 
