---
description: При подготовке к восстановлению инициатор запроса использует документы метаданных сохраненного модуля записи в сочетании с собственным извлеченным компонентом резервного копирования, чтобы определить, что нужно восстановить и как.
ms.assetid: 36cf188f-fce6-467c-a200-cbd9dc8f31a6
title: Общие сведения о подготовке к восстановлению
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fa9748ff3d6602695dfde703b020e10ab05791d5eeb3957d23a1d1a4fcb82cc2
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118998163"
---
# <a name="overview-of-preparing-for-restore"></a>Общие сведения о подготовке к восстановлению

При подготовке к восстановлению инициатор запроса использует документы метаданных сохраненного модуля записи в сочетании с собственным извлеченным компонентом резервного копирования, чтобы определить, что нужно восстановить и как. Дополнительные сведения см. в разделе Общие сведения об [обработке восстановления в VSS](overview-of-processing-a-restore-under-vss.md).

После выбора потенциальных компонентов для восстановления модули записи, выполняющиеся в системе, обращаются к документу компонентов резервного копирования инициатора запроса. Модули записи используют этот доступ, чтобы указать, как вызывать минимальную сложность при выполнении служб из-за восстановления.

После этого запрашивающая сторона получает достаточно информации, чтобы определить, какие файлы потребуется восстановить, а также то, где и как они должны быть восстановлены. (Дополнительные сведения см. [в разделе Создание набора восстановления](generating-a-restore-set.md).)

В следующей таблице показана последовательность действий и событий, необходимых для подготовки к операции восстановления.



| Действие запросившего                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Событие                                                         | Действие записи                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Получение сведений из документа о компонентах резервного копирования о компонентах, [*явно включаемых*](vssgloss-e.md) в операцию резервного копирования (см. раздел [**Ивссбаккупкомпонентс:: жетвритеркомпонентс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents)). Изучите извлеченные документы метаданных модуля записи, чтобы получить сведения о компонентах, явно включаемых в резервную копию, и любых обнаруженных [*неявно включаемых*](vssgloss-i.md) компонентов (См. раздел [**ивссексаминевритерметадата**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata), [**ивссвмкомпонент**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent).)<br/> | Нет                                                          | Нет                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| Выберите компоненты и наборы компонентов для восстановления (см. раздел [**ивссбаккупкомпонентс:: сетселектедфорресторе**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore) and [**Ивссбаккупкомпонентс:: аддресторесубкомпонент**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent).)                                                                                                                                                                                                                                                                                                                                                                                          | Нет                                                          | Нет                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| Инициатор запроса позволяет модулю записи обновлять документ компонентов резервного копирования и при необходимости передавать в модуль записи любые специальные параметры восстановления. (См. раздел [**ивссбаккупкомпонентс:: сетрестореоптионс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions), [**Ивссбаккупкомпонентс:: аддневтаржет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addnewtarget)и [**ивссбаккупкомпонентс::P rerestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore).)                                                                                                                                                                                                                                         | [*Предвосстановление*](vssgloss-p.md) | Модуль записи определяет участие в восстановлении, подготавливает файлы для восстановления и при необходимости изменяет документ резервных компонентов. (См. раздел [**квссвритер:: онпрересторе**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onprerestore), [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent), [**ивсскомпонент:: Исселектедфорресторе**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-isselectedforrestore), [**ивсскомпонент:: GetRestoreOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoreoptions), [**IVssComponent:: SetRestoreTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoretarget), [**IVssComponent:: SetRestoreMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoremetadata), [**IVssComponent:: AddDirectedTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddirectedtarget).) |
| Инициатор запроса ждет, пока модули записи не обрабатывали событие [**RESTORE**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) с помощью [**ивссасинк**](/windows/desktop/api/Vss/nn-vss-ivssasync). Он также должен проверять состояние модуля записи. (См. раздел [**ивссбаккупкомпонентс:: гасервритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**Ивссбаккупкомпонентс:: жетвритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus).)                                                                                                                                                                                                                                                                                  | Нет                                                          | Нет                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |



 

## <a name="requester-actions-during-restore-preparations"></a>Действия запросившего во время подготовительной процедуры восстановления

Чтобы определить, какие компоненты являются кандидатами для восстановления, инициатор запроса должен выполнить следующие действия:

-   Установите компонент и структуру [*набора компонентов*](vssgloss-c.md) , используемую для создания резервной копии.
-   Проверьте [*Выбор компонентов для восстановления*](vssgloss-s.md).
-   Используйте рекомендации по выбору ([Работа с выборкой для восстановления и подкомпонентов](working-with-selectability-for-restore-and-subcomponents.md)), чтобы выбрать компоненты для включения.
-   Используйте сведения о [*наборе файлов*](vssgloss-f.md) компонента, чтобы определить, какие файлы на носителе резервной копии необходимо восстановить.

Для этого инициатору запроса необходимо проверить [*явно включаемые*](vssgloss-e.md) компоненты в документе сохраненных компонентов резервного копирования. Эти сведения о компоненте доступны на основе модуля записи с помощью [**ивссбаккупкомпонентс:: жетвритеркомпонентс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents), который возвращает экземпляры интерфейса [**ивссвритеркомпонентсекст**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext) , из которого можно извлечь данные модуля записи и экземпляры интерфейса [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) .

Как отмечалось в других местах ([Использование компонентов инициатором запроса](use-of-components-by-the-requestor.md)), документ компонентов резервного копирования и интерфейс **ивсскомпонент** не содержат достаточно информации для поддержки резервного копирования. Таким образом, инициатор запроса должен проверить соответствующий документ метаданных сохраненного модуля записи с помощью [**ивссексаминевритерметадата**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata) (см. [сведения об идентификации модуля записи](writer-metadata-document-contents.md)).

Число компонентов, которыми управляет каждый модуль записи, возвращается функцией [**ивссексаминевритерметадата:: жетфилекаунтс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getfilecounts). Затем инициатор запроса может использовать [**ивссексаминевритерметадата::-Component**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent) , чтобы получить интерфейс [**ивссвмкомпонент**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent) для каждого компонента, управляемого модулем записи.

Изучив возможности [*выбора компонентов для резервного копирования*](vssgloss-s.md) и [*логических путей*](vssgloss-l.md) (см. раздел [Работа с возможностью выбора и логическими путями](working-with-selectability-and-logical-paths.md)), инициатор запроса может определить компоненты, которые задают наборы компонентов времени резервного копирования (явно включенные компоненты), а также элементы подкомпонентов этих наборов (неявно включенные компоненты).

Запрашивающие стороны указывают через документ компонентов резервного копирования, если компонент необходимо явно восстановить, используя [**ивссбаккупкомпонентс:: сетселектедфорресторе**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore) или [**Ивссбаккупкомпонентс:: аддресторесубкомпонент**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent). Выбор метода зависит от того, как изначально была создана резервная копия компонента и его [*Выбор для восстановления*](vssgloss-s.md). Эти компоненты, явно включаемые в инструкцию RESTORE, обозначают другие компоненты, которые неявно включены (Дополнительные сведения см. [в разделе Работа с выборкой для восстановления и подкомпонентов](working-with-selectability-for-restore-and-subcomponents.md) ).

Инициатор запроса может явно включить ни один из компонентов текущего модуля записи для восстановления с помощью [**ивссбаккупкомпонентс:: сетселектедфорресторе**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore) или [**Ивссбаккупкомпонентс:: аддресторесубкомпонент**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent). В этом случае этот модуль записи не будет принимать события VSS для оставшейся части операции восстановления.

Явное использование [**ивссбаккупкомпонентс:: сетселектедфорресторе**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore) или [**Ивссбаккупкомпонентс:: аддресторесубкомпонент**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent) для выбора компонента модуля записи, который не выполняется в данный момент, ВОЗВРАЩАЕТ \_ ошибку " \_ объект VSS \_ не найден" \_ . Сведения о восстановлении данных отсутствующих модулей записи см. в статье восстановление [без участия в записи](restores-without-writer-participation.md) .

Чтобы разрешить модулю записи получать полные сведения о том, какие параметры восстановления для записи и указать, что добавочное восстановление может быть отправлено в модули записи инициаторами вызовов [**ивссбаккупкомпонентс:: сетрестореоптионс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) и [**Ивссбаккупкомпонентс:: сетаддитионалресторес**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setadditionalrestores)соответственно.

На этом этапе инициатор запроса завершил подготовку и создаст событие для предварительного **восстановления** путем вызова [**ивссбаккупкомпонентс::P rerestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore), что позволяет модулям записи подготовиться к фактическому восстановлению.

## <a name="writer-actions-during-restore-preparations"></a>Действия модуля записи во время подготовительных процедур восстановления

Подготовка модуля записи для операции восстановления выполняется при обработке события, выполняемого перед [**восстановлением**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) , с помощью виртуального метода [**Квссвритер:: онпрересторе**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onprerestore). Реализация по умолчанию просто возвращает, не принимая никаких действий. Модули записи могут переопределить реализацию по умолчанию, чтобы повысить управляемость:

-   Переопределение [*методов Restore*](vssgloss-r.md) с помощью [*целевых объектов восстановления*](vssgloss-r.md)
-   Определение [ *направленных целевых объектов*](vssgloss-d.md)
-   Создание сообщений об ошибках и дополнительных данных
-   Предоставление сведений о метке резервного копирования

Обработчик событий [**квссвритер:: онпрересторе**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onprerestore) получает экземпляр [**ивссвритеркомпонентс**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents), из которого он может получить [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) интерфейсы для тех компонентов, которые явно включаются в документ компонентов резервного копирования во время резервного копирования.

Сведения о подкомпонентах неявно включаются в операции резервного копирования и явно включаются в восстановление с помощью экземпляра **ивсскомпонент** , соответствующего компоненту, который определил [*набор компонентов*](vssgloss-c.md)резервного копирования.

Метод [**ивсскомпонент:: исселектедфорресторе**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-isselectedforrestore) используется для определения того, следует ли восстанавливать явно включенный компонент резервного копирования.

Чтобы определить, был ли подкомпонент резервного копирования явно добавлен в восстановление, модули записи используют [**ивсскомпонент:: жетресторесубкомпонент**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoresubcomponent).

Модуль записи должен проверить [*набор файлов*](vssgloss-f.md) в каждом компоненте и определить, требуется ли выполнять действия для поддержки восстановления. Модуль записи должен выполнить оценку, если он хочет, чтобы его текущие файлы были перезаписаны, или если потребуется восстановление в новом расположении. Действия могут включать следующее.

-   Получение и работа с любыми параметрами записи или запрашивающей стороны, управляющими операциями восстановления (см [**. раздел ивсскомпонент:: жетрестореоптионс**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoreoptions)).
-   Закрытие и запись всех открытых файлов в настоящий момент
-   Обновление целевого объекта восстановления (например, для принудительного восстановления в альтернативное сопоставление расположения). См. раздел [**ивсскомпонент:: сетресторетаржет**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoretarget).
-   Взаимодействие с инициатором запроса через частные метаданные (см [**. ивсскомпонент:: сетрестореметадата**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoremetadata))
-   Указывает, что файл должен быть восстановлен путем повторного сопоставления через определение [*направленных целевых объектов*](vssgloss-d.md) (см [**. Ивсскомпонент:: адддиректедтаржет**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddirectedtarget)).

Экземпляр [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) будет либо создан явным включением компонента в документ компонентов резервного копирования во время резервного копирования, либо компонентом, определяющим набор компонентов резервного копирования, членом которого он был (см. раздел [Работа с выборкой для восстановления и подкомпонентов](working-with-selectability-for-restore-and-subcomponents.md)).

 

 
