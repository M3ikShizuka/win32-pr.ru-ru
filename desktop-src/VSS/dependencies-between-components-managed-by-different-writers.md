---
description: Существуют ситуации, когда данные из одного модуля записи зависят от данных, управляемых другим модулем записи. В таких случаях следует выполнять резервное копирование и восстановление данных из обоих модулей записи.
ms.assetid: 0413c289-74b7-4e83-a227-00bfb264e56e
title: Зависимости между компонентами, управляемыми разными модулями записи
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 91ba3be6a2c2f0a722c4c5f06ca95351e004e1cd
ms.sourcegitcommit: d75fc10b9f0825bbe5ce5045c90d4045e3c53243
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2021
ms.locfileid: "127461344"
---
# <a name="dependencies-between-components-managed-by-different-writers"></a>Зависимости между компонентами, управляемыми разными модулями записи

Существуют ситуации, когда данные из одного модуля записи зависят от данных, управляемых другим модулем записи. В таких случаях следует выполнять резервное копирование и восстановление данных из обоих модулей записи.

VSS обрабатывает эту проблему, используя понятие явной зависимости компонента записи и интерфейса [**ивссвмдепенденци**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmdependency) .

Модуль записи добавляет одну или несколько зависимостей при создании документа метаданных модуля записи с помощью метода [**ивсскреатевритерметадата:: аддкомпонентдепенденци**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addcomponentdependency) . Модуль записи передает методу имя и логический путь зависимого компонента (которым он управляет), а также имя и логический путь и [*идентификатор класса модуля записи*](vssgloss-w.md) (идентификатор GUID, определяющий класс) компонента, от которого он зависит.

После установки эта зависимость информирует инициатор запроса, что во время любой операции резервного копирования или восстановления зависимый компонент и целевые объекты его зависимостей должны участвовать.

Данный компонент может иметь несколько зависимостей, что требует, чтобы он и все зависимые целевые объекты участвовали в резервном копировании и восстановлении вместе.

Зависимый компонент и (или) целевые объекты его зависимостей могут включаться [*явно*](vssgloss-e.md) или [*неявно*](vssgloss-i.md) в операции резервного копирования или восстановления.

Механизм зависимости для компонента явного модуля записи не следует использовать для создания зависимости между двумя компонентами в одном модуле записи. Правила выбора могут более эффективно предоставлять одни и те же функции без риска циклических зависимостей.

Например, [**ивсскреатевритерметадата:: аддкомпонентдепенденци**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addcomponentdependency) можно использовать для определения зависимости компонента вритердата (с логическим путем "") модуля записи мивритер в компоненте интернетдата (с логическим путем "Connections") модуля записи с именем INTERNETCONNECTOR с идентификатором класса модуля записи X. (хотя несколько модулей записи с ОДИНАКОВым идентификатором класса могут быть одновременно включены в систему, путаница будет избегать, так как сочетание логического пути и имени компонента уникально в системе под управлением VSS.)

Модуль записи добавляет несколько зависимостей к данному компоненту, просто вызывая [**ивсскреатевритерметадата:: аддкомпонентдепенденци**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addcomponentdependency) , повторяемый с различными компонентами из разных модулей записи. Количество других компонентов, от которых зависит данный компонент, можно найти, изучив элемент **кдепенденЦиес** структуры [**\_ компонентинфо VSS**](/windows/desktop/api/VsBackup/ns-vsbackup-vss_componentinfo) .

Модуль записи или инициатор запроса извлекает экземпляры интерфейса [**ивссвмдепенденци**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmdependency) с помощью [**Ивссвмкомпонент:: dependency**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdependency). **Ивссвмдепенденци** возвращает имя компонента, логический путь и идентификатор класса модуля записи, управляющего компонентом, который является целевым объектом зависимости.

Механизм зависимости не предписывает определенный порядок предпочтения между зависимым компонентом и целями его зависимостей. Как отмечалось выше, все зависимости указывают на то, что каждый раз при резервном копировании или восстановлении какого-либо компонента или компонента, от которого он зависит, необходимо также создать резервную копию или восстановить компонент или компоненты, от которых они зависят. Точная реализация зависимости является обязательной для приложения резервного копирования.

Например, в приведенном выше случае компонент Вритердата (логический путь ") зависит от компонента Интернетконнектор (логический путь" соединения "). Инициатор запроса может интерпретировать его одним из следующих способов:

-   Если зависимый компонент Вритердата выбран (неявно или явно) для резервного копирования или восстановления, инициатор запроса должен выбрать (неявно или явно) целевой объект зависимости, Интернетдата
-   Если целевой объект зависимости Интернетдата не выбран для резервного копирования, то зависимый компонент Вритердата не должен быть выбран.

Однако при разработке поддержки зависимостей разработчикам инициатора запроса следует знать, что не существует способа, которым модуль записи может определить, является ли один из его компонентов целью зависимости.

## <a name="declaring-remote-dependencies"></a>Объявление удаленных зависимостей

Распределенное приложение — это приложение, которое можно настроить для использования одного или нескольких компьютеров за раз. Обычно приложение выполняется на одном или нескольких компьютерах серверов приложений и взаимодействует с (но может и не может выполняться) на одном или нескольких серверах баз данных. Эта конфигурация иногда называется развертыванием в нескольких системах. Часто одно и то же приложение можно настроить для запуска на одном компьютере, на котором работают сервер приложений и сервер базы данных. Такая конфигурация называется развертыванием с одной системой. В обеих конфигурациях сервер приложений и сервер базы данных имеют собственные независимые модули записи VSS.

В многосистемном развертывании, если компонент, управляемый модулем записи приложения, зависит от удаленного компонента, управляемого модулем записи сервера базы данных, это называется удаленной зависимостью. (Односистемное развертывание, напротив, имеет только локальные зависимости.)

в качестве примера многосистемного развертывания рассмотрим сервер приложений, использующий сервер базы данных SQL Server в качестве хранилища данных. Данные конкретного приложения, включая веб-части, файлы веб-содержимого и метабазу IIS, размещаются на одном или нескольких компьютерах, называемых интерфейсными веб-серверами. фактическое SQL хранилище данных, включающее базу данных конфигурации и несколько баз данных содержимого, находится на одном или нескольких компьютерах, называемых серверными серверами баз данных. Каждый интерфейсный веб-сервер содержит одно и то же содержимое и конфигурацию конкретного приложения. На каждом сервере серверных баз данных могут размещаться любые базы данных содержимого или базы данных конфигурации. Программное обеспечение приложения выполняется только на интерфейсных веб-серверах, а не на серверах баз данных. в этой конфигурации модуль записи VSS приложения имеет удаленную зависимость от компонентов, управляемых модулем записи SQL.

Модуль записи может объявить удаленную зависимость, вызвав метод [**аддкомпонентдепенденци**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addcomponentdependency) , предъявив " \\ \\ *имя_удаленного_компьютера* \\ ", где *имя_удаленного_компьютера* — это имя компьютера, на котором находится удаленный компонент, в логический путь в параметре *всзонлогикалпас* . Значение *имя_удаленного_компьютера* может быть IP-адресом или именем компьютера, возвращаемым функцией [**предполагался сбой getcomputernameex**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getcomputernameexa) .

**Windows Server 2003:** модуль записи не может объявлять удаленные зависимости, пока Windows Server 2003 с пакетом обновления 1 (SP1).

Для обнаружения зависимости инициатор запроса вызывает методы [**жетвритерид**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmdependency-getwriterid), [**жетлогикалпас**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getlogicalpath)и [**жеткомпонентнаме**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmdependency-getcomponentname) интерфейса [**ивссвмдепенденци**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmdependency) . Инициатор запроса должен проверить имя компонента, возвращаемое **жеткомпонентнаме** , в параметре *пбстркомпонентнаме* . Если имя компонента начинается с " \\ \\ ", инициатор запроса должен предположить, что он указывает удаленную зависимость, а первый компонент, следующий за " \\ \\ ", является *имя_удаленного_компьютера* , который был указан при вызове модуля записи с именем [**аддкомпонентдепенденци**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addcomponentdependency). Если имя компонента не начинается с " \\ \\ ", инициатор запроса должен предположить, что он указывает локальную зависимость.

При наличии удаленной зависимости инициатор запроса должен создать резервную копию удаленного компонента, когда он создает резервную копию локального компонента. Чтобы создать резервную копию удаленного компонента, запрашивающая сторона должна иметь агент на удаленном компьютере и инициировать резервное копирование на удаленном компьютере.

## <a name="structuring-remote-dependencies"></a>Структурирование удаленных зависимостей

Важно понимать, что зависимость не является компонентом в и самой. Компонент необходим для хранения зависимости.

В следующих примерах показаны два способа структурирования набора зависимостей.

``` syntax
Example 1:
    Writer 1
        Component A
            File A
            File B
            Dependency (SQL/MSDE Writer, Component X, "\")
            Dependency (SQL/MSDE Writer, Component Y, "\")

Example 2:
    Writer 2
        Component A
            File A
            File B
        Component B
            Dependency (SQL/MSDE Writer, Component X, "\")
            Dependency (SQL/MSDE Writer, Component Y, "\")
```

В примере 1 зависимости удерживаются компонентом а. Поскольку могут быть выбраны только компоненты, а не отдельные файлы, структурирование компонента A зависимостей таким образом потребует, чтобы весь компонент, как файлы, так и зависимости, всегда находился в резервной копии и восстановлен вместе. Они не могут быть архивированы или восстановлены по отдельности.

В примере 2 отдельные компоненты (компоненты A и B) хранят все зависимости. В этом случае можно выбирать два компонента независимо друг от друга и, следовательно, выполнять их резервное копирование и восстановление независимо друг от друга. Структурирование зависимостей таким образом позволяет распределенному приложению значительно повысить гибкость управления удаленными зависимостями.

## <a name="supporting-remote-dependencies"></a>Поддержка удаленных зависимостей

Инициатор запроса может предоставлять полную или частичную поддержку удаленных зависимостей.

Чтобы обеспечить полную поддержку, инициатор запроса должен выполнить следующие действия во время резервного копирования и восстановления.

Во время резервного копирования инициатор запроса должен запустить резервное копирование на внешнем (локальном) компьютере, определить имеющиеся зависимости и добавить в очередь дополнительные задания резервного копирования для записи серверных баз данных. Перед вызовом методов [**ивссбаккупкомпонентс:: сетбаккупсукцеедед**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded) и [**Ивссбаккупкомпонентс:: баккупкомплете**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) инициатору запроса необходимо подождать, пока не завершится выполнение заданий фонового резервного копирования на удаленном компьютере. Если инициатор запроса ожидает завершения резервного копирования компонентов серверной части перед вызовом **баккупкомплете**, это приведет к более легкому восстанавливаемому резервному копированию для модуля записи, который реализует дополнительные улучшения (например, блокировку топологии) во время резервного копирования. В следующей процедуре показано, что должен делать инициатор запроса:

1.  На локальном компьютере инициатор запроса вызывает методы [**ивссбаккупкомпонентс:: инитиализефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup), [**Ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata), [**IVssBackupComponents::P Repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)и [**IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) .
2.  После завершения локальной теневой копии, но до завершения резервного копирования инициатор запроса заставит в очередь дополнительные задания резервного копирования, отправив запрос агенту на удаленном компьютере.
3.  На удаленном компьютере агент инициатора запроса выполняет последовательность резервного копирования в очереди, вызывая [**инитиализефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup), [**гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata), [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup), [**доснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), [**сетбаккупсукцеедед**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded)и [**баккупкомплете**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete).
4.  Когда агент инициатора запроса завершает задания, помещенные в очередь на удаленном компьютере, инициатор запроса завершает последовательность резервного копирования, вызывая [**сетбаккупсукцеедед**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded) и [**баккупкомплете**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete).

Во время восстановления инициатор запроса должен начать восстановление, включающее внешний (локальный) компьютер, выбрать компоненты и их зависимости для восстановления, а затем отправить событие предварительного [**восстановления**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) , вызвав метод **ивссбаккупкомпонентс::P rerestore** . После этого инициатор запроса должен поочередно заставить в очередь задания восстановления на удаленном компьютере и вызвать метод [**ивссбаккупкомпонентс::P остресторе**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) после завершения восстановления серверной части. Это требование обеспечивает более полное управление процессом восстановления, а также улучшает работу пользователя с администратором. Поскольку резервные копии в каждой из систем не происходят в одной точке во времени, модуль записи внешнего интерфейса должен выполнить некоторую очистку данных серверной части. В примере приложения, рассмотренного в предыдущем разделе "объявление удаленных зависимостей", модуль записи должен инициировать повторное сопоставление или повторную индексацию сайта после завершения восстановления одной из серверных баз данных. Для этого модуль записи должен получить события на сервере переднего плана. В следующей процедуре показано, что должен делать инициатор запроса:

1.  На локальном компьютере инициатор запроса вызывает [**ивссбаккупкомпонентс:: инитиализефорресторе**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore), [**гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata), [**ивссбаккупкомпонентс:: SetSelectedForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore) (или [**IVssBackupComponentsEx:: SetSelectedForRestoreEx**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponentsex-setselectedforrestoreex)) и [**предвосстановление**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore).
2.  После завершения этапа предварительного [**восстановления**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) , но до начала этапа [**восстановления**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) , инициатор запроса заставит в очередь дополнительные задания восстановления, отправив запрос агенту на удаленном компьютере.
3.  На удаленном компьютере агент инициатора запроса выполняет задания восстановления в очереди, вызывая [**инитиализефорресторе**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore), [**гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata), [**сетселектедфорресторе**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore), [**RESTORE**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore), [**сетфилересторестатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setfilerestorestatus) (или [**SetSelectedForRestoreEx**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponentsex-setselectedforrestoreex)) и [**инструкцию RESTORE**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore).
4.  Когда агент инициатора запроса завершает задания, помещенные в очередь на удаленном компьютере, инициатор запроса завершает последовательность восстановления, вызывая [**ивссбаккупкомпонентс:: сетфилересторестатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setfilerestorestatus) и [**инструкцию RESTORE**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore).

Чтобы обеспечить частичную поддержку удаленных зависимостей, запрашивающая сторона должна следовать удаленным зависимостям и включать их в состав резервной копии, но порядок событий в системах внешнего интерфейса и серверной части, как описано в предыдущих двух процедурах, не потребуется. Для инициатора запроса, который реализует только частичную поддержку, инициатор запроса должен обратиться к документации по резервному копированию и восстановлению приложения записи, чтобы понять, какие сценарии поддерживаются.

 

 
