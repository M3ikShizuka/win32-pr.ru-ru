---
description: Иногда бывает полезно выполнять резервное копирование и восстановление только разделов файлов. Служба VSS предоставляет частичные механизмы файлов, которые, если инициаторы их поддерживают, позволяют модулям записи указывать частичные резервные копии файлов и восстановления.
ms.assetid: 02b74a4e-d69f-4eeb-866a-3399598b7035
title: Работа с частичными файлами
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 13e1aa2623788cc97d62c88d52ec7096829adc350e1d420e92cea12b8dd64d70
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118590458"
---
# <a name="working-with-partial-files"></a>Работа с частичными файлами

Иногда бывает полезно выполнять резервное копирование и восстановление только разделов файлов. Служба VSS предоставляет [*частичные механизмы файлов*](vssgloss-p.md) , которые, если инициаторы их поддерживают, позволяют модулям записи указывать частичные резервные копии файлов и восстановления.

Частичные операции с файлами часто используются для модулей записи, которые поддерживают очень большие файлы, а лишь небольшие доли от изменения между операциями резервного копирования. В этом случае часто бывает полезно скопировать только этот раздел, который был изменен на носитель резервной копии. По этой причине частичные операции с файлами обычно, но не являются монопольными, используются для поддержки добавочных операций резервного копирования и восстановления.

Если модуль записи хочет реализовать операцию с частичным файлом, он использует [**квссвритер:: испартиалфилесуппортенаблед**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispartialfilesupportenabled) , чтобы определить, поддерживает ли инициатор запроса, с которым он работает, операцию.

Если инициатор запроса поддерживает частичные операции с файлами и добавляет компонент, управляющий файлом (или компонентом, определяющим набор компонентов, который содержит файл), в документ компонентов резервного копирования, то средство записи указывает, какие разделы файла нужно сохранить (как правило, при обработке события [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) или [*моментального снимка*](vssgloss-p.md) ), вызвав [**ивсскомпонент:: аддпартиалфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).

Помимо пути и имени файла, модуль записи предоставляет диапазон, дополнительные сведения о метаданных для [**ивсскомпонент:: аддпартиалфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).

Сведения о диапазоне предоставляются в виде строки, содержащей одно из следующих значений:

-   Пары смещений в файл для резервного копирования (в байтах) и длину раздела для резервного копирования (в байтах), смещение и длину, разделенные двоеточием, и каждая пара, разделенная запятыми, например *Offset1 ***:**_length1_*_,_* * Offset2 ***:**_length2_.

    Каждое значение представляет собой 64-разрядное целое число (в шестнадцатеричном или десятичном формате), задающее смещение байтов и длину в байтах соответственно.

-   Полный путь, включая имя файла, в текущей системе файла двоичных диапазонов, содержащий следующие данные:
    -   Число (выраженное в виде 64-разрядного целого числа) различных диапазонов файлов, содержащихся в файле
    -   Каждый диапазон, выраженный в виде пары из 64-разрядных целых чисел: первый член пары, являющийся смещением в копируемом файле (в байтах), а второй элемент — это длина данных для резервного копирования (в байтах).

Если модуль записи использует файл Ranges для указания операции частичного файла, то инициатор запроса должен гарантировать, что резервная копия этого файла (даже если файл не обязательно является частью резервного набора данных по умолчанию) или что сведения о диапазонах на носителе резервной копии сохраняются каким-либо другим способом. Если резервная копия сведений о файле Ranges не создана, восстановление частично заархивированного файла будет невозможно.

Модуль записи также может добавлять строку, содержащую метаданные. Эти метаданные могут быть в формате, зависящем от модуля записи, так как они предназначены для того, чтобы модуль записи мог проверить все будущие восстановления.

С этой информацией вспомогательный запрашивающий объект может выполнять частичное резервное копирование файлов.

В качестве примера рассмотрим большой файл, заголовок которого (байты 64-512) содержит число записей и другие часто обновляемые сведения, а последние данные — в байтах файла (последние 65536 байта), 0x1239E8577A в 0x1239E7577A.

Модуль записи может указать список диапазонов в виде строки "**64:448, 0x1239E8577A: 65536**."

При восстановлении и до фактического выполнения операции восстановления инициатор запроса должен проверить, требует ли какие-либо файлов частичную поддержку файлов.

Для этого инициатор запроса сначала выполняет перебор модулей записи с хранимыми компонентами в своем документе компонентов резервного копирования с помощью [**ивссбаккупкомпонентс:: жетвритеркомпонентскаунт**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponentscount) и [**Ивссбаккупкомпонентс:: жетвритеркомпонентс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents).

Затем интерфейс [**ивссбаккупкомпонентс:: жетвритеркомпонентс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents) используется для возвращения экземпляров интерфейса [**ивссвритеркомпонентсекст**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext) , которые предоставляют [**ивссвритеркомпонентсекст::-Component**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponent) и [**IVssWriterComponentsExt:: GetComponentCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponentcount), которые позволяют инициатору запроса получать экземпляры [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) .

Это позволяет инициатору запроса получать сведения о частично резервном копировании файлов для участия в восстановлении с помощью [**ивсскомпонент:: жетпартиалфилекаунт**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfilecount) и [**Ивсскомпонент:: Жетпартиалфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) для экземпляра [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) , соответствующего компоненту, который управляет файлом (или компонентом, определяющим набор компонентов, который содержит файл).

Если операция с частичным файлом управлялась файлом диапазонов, этот файл следует восстановить до копирования данных обратно на диск. Может произойти, что инициатору запроса требуется скопировать файл Ranges обратно в новое расположение на диске. В этом случае это означает, что это сделано с помощью [**ивссбаккупкомпонентс:: сетранжесфилепас**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrangesfilepath).

Затем инициатор запроса продолжает копирование данных в соответствующие места назначения восстановления, которые уже находятся на диске.

Модуль записи (при обработке события [**RESTORE**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) ) путем проверки [**ивсскомпонент:: жетфилересторестатус**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getfilerestorestatus) для файлов, указанных в [**ивсскомпонент:: жетпартиалфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile), определяет, была ли операция частичного файла выполнена успешно. Модуль записи должен всегда пытаться проверить правильность этого восстановления, используя сведения о смещении и все метаданные, содержащиеся в документе резервные компоненты.

Если инициатору запроса пришлось восстановить файл Ranges в новом расположении, служба VSS обновит эти сведения, чтобы путь, возвращенный [**ивсскомпонент:: жетпартиалфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) , был правильным.

 

 
