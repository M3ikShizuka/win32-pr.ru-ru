---
description: Инфраструктура VSS требует, чтобы инициаторы VSS, такие как приложения резервного копирования, могли функционировать как клиенты COM и как сервер.
ms.assetid: b01145c6-76ba-4a81-bca6-59c4ca488dac
title: Вопросы безопасности для запрашивающих стороны
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 60d64a5c817a8c45951d56d3fa12e78a03d8bee9dd742f67755f949d1f90a0e5
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118590955"
---
# <a name="security-considerations-for-requesters"></a>Вопросы безопасности для запрашивающих стороны

Инфраструктура VSS требует, чтобы инициаторы VSS, такие как приложения резервного копирования, могли функционировать как клиенты COM и как сервер.

При работе в качестве сервера инициатор запроса предоставляет набор интерфейсов обратного вызова COM, которые могут быть вызваны внешними процессами (например, модулями записи или службой VSS). Таким образом, запрашивающие стороны должны безопасно управлять тем, какие клиенты COM могут выполнять входящие вызовы COM в процесс.

Аналогичным образом, запрашивающие стороны могут действовать как клиент COM для COM-интерфейсов API, предоставляемых модулем записи VSS или службой VSS. Параметры безопасности, зависящие от инициатора запроса, должны разрешать исходящим вызовам COM от инициатора запроса к этим другим процессам.

Простейшим механизмом управления проблемами безопасности инициатора запроса является выбор учетной записи пользователя, от имени которой она выполняется.

Инициатор запроса обычно должен выполняться от имени пользователя, который является членом группы "Администраторы" или "операторы резервного копирования", или выполнять от имени учетной записи локальной системы.

По умолчанию, когда инициатор запроса выступает в роли клиента COM, если он не выполняется под этими учетными записями, любой вызов COM автоматически отклоняется с помощью **E \_ ACCESSDENIED**, даже не ПОЛУЧАЯ реализацию COM-метода.

## <a name="disabling-com-exception-handling"></a>Отключение обработки исключений COM

При разработке инициатора запроса установите \_ флаг комглб исключения \_ не разграничения \_ обработки глобальных параметров, чтобы отключить обработку исключений COM. Это важно, поскольку обработка исключений COM может маскировать неустранимые ошибки в приложении VSS. Ошибка, которая замаскирована, может привести к нестабильной работе и непредсказуемому состоянию, что может приводить к повреждению и зависаниям. Дополнительные сведения об этом флаге см. в разделе [иглобалоптионс](/windows/win32/api/objidlbase/nn-objidlbase-iglobaloptions).

## <a name="setting-requester-default-com-access-check-permission"></a>Задание разрешения на проверку доступа COM по умолчанию для инициатора запроса

Запрашивающие стороны должны иметь в виду, что когда процесс выступает в качестве сервера (например, позволяет авторам изменений изменять документ компонентов резервного копирования), они должны разрешать входящие вызовы от других участников VSS, таких как модули записи или служба VSS.

однако по умолчанию Windows процесс разрешает только клиенты COM, которые выполняются в рамках одного сеанса входа в систему (идентификатор безопасности SELF) или выполняются под локальной системной учетной записью. Это потенциальная проблема, так как эти значения по умолчанию не подходят для инфраструктуры VSS. Например, модули записи могут работать как учетная запись пользователя "оператор резервного копирования", которая не находится в том же сеансе входа, что и запрашивающий процесс, или локальная системная учетная запись.

Для решения такого типа проблемы каждый серверный процесс COM может дополнительно контролировать, разрешено ли клиенту RPC или COM выполнять метод COM, реализуемый сервером (в данном случае в данном случае это инициатор запроса), с помощью [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity) установить разрешение доступа COM по умолчанию для всего процесса.

Инициаторы запроса могут явным образом выполнить следующие действия:

-   Разрешение всем процессам доступ для вызова процесса инициатора запроса.

    этот параметр может быть достаточно для большинства вызывающих запросов и используется другими серверами COM — например, все службы Windows на основе SVCHOST уже используют этот вариант, как и все службы COM+ по умолчанию.

    Разрешение всем процессам выполнять входящие вызовы COM не обязательно является слабостью безопасности. Инициатор запроса, действующий как сервер COM, как и все остальные серверы COM, всегда поддерживает возможность авторизации своих клиентов на каждом методе COM, реализованном в его процессе.

    Обратите внимание, что внутренние обратные вызовы COM, реализованные службой VSS, защищены по умолчанию.

    Чтобы разрешить всем процессам доступ к инициатору запроса через COM, можно передать **нулевой** дескриптор безопасности в качестве первого параметра [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity). (Обратите внимание, что **CoInitializeSecurity** должен вызываться не более одного раза для всего процесса. Дополнительные сведения о вызовах **CoInitializeSecurity** см. в документации по com или MSDN.)

    в следующем примере кода показано, как инициатору запроса следует вызвать [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity) в Windows 8 и Windows Server 2012 и более поздних версий для обеспечения совместимости с VSS для удаленных файловых ресурсов (рвсс):

    ``` syntax
    // Initialize COM security.
       hr = CoInitializeSecurity(
            NULL,                          //  PSECURITY_DESCRIPTOR         pSecDesc,
            -1,                            //  LONG                         cAuthSvc,
            NULL,                          //  SOLE_AUTHENTICATION_SERVICE *asAuthSvc,
            NULL,                          //  void                        *pReserved1,
            RPC_C_AUTHN_LEVEL_PKT_PRIVACY, //  DWORD                        dwAuthnLevel,
            RPC_C_IMP_LEVEL_IMPERSONATE,   //  DWORD                        dwImpLevel,
            NULL,                          //  void                        *pAuthList,
            EOAC_STATIC,                   //  DWORD                        dwCapabilities,
            NULL                           //  void                        *pReserved3
            );
    ```

    При явном задании безопасности на уровне COM инициатора запроса с помощью [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity)необходимо выполнить следующие действия.

    -   Установите уровень проверки подлинности по крайней мере на **\_ уровне RPC C \_ AUTHN, \_ \_ \_ целостность PKT**. Для повышения безопасности рассмотрите возможность использования **RPC \_ C \_ AUTHN \_ Level \_ PKT \_**.
    -   Задайте уровень олицетворения на **\_ уровне RPC C " \_ \_ \_ impersonate**".
    -   Установите для функций безопасности маскировку значение **еоак \_ static**. Дополнительные сведения о маскировке безопасности см. в разделе [маскировка](../com/cloaking.md).

    в следующем примере кода показано, как инициатор запроса должен вызвать [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity) в Windows 7 и Windows Server 2008 R2 и более ранних версиях (или в Windows 8 и Windows Server 2012 и более поздних версий, если не требуется совместимость с рвсс):

    ``` syntax
    // Initialize COM security.
       hr = CoInitializeSecurity(
            NULL,                          //  PSECURITY_DESCRIPTOR         pSecDesc,
            -1,                            //  LONG                         cAuthSvc,
            NULL,                          //  SOLE_AUTHENTICATION_SERVICE *asAuthSvc,
            NULL,                          //  void                        *pReserved1,
            RPC_C_AUTHN_LEVEL_PKT_PRIVACY, //  DWORD                        dwAuthnLevel,
            RPC_C_IMP_LEVEL_IDENTIFY,      //  DWORD                        dwImpLevel,
            NULL,                          //  void                        *pAuthList,
            EOAC_NONE,                     //  DWORD                        dwCapabilities,
            NULL                           //  void                        *pReserved3
            );
    ```

    При явном задании безопасности на уровне COM инициатора запроса с помощью [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity)необходимо выполнить следующие действия.

    -   Задайте уровень проверки подлинности как минимум **RPC \_ C \_ AUTHN \_ Level \_ Connect**. Для повышения безопасности рассмотрите возможность использования **RPC \_ C \_ AUTHN \_ Level \_ PKT \_**.
    -   Задайте уровень олицетворения на уровне " **назначение \_ RPC \_ C \_ \_** ", если только процессу инициатора запроса не нужно разрешать олицетворение для конкретных вызовов RPC или COM, которые не связаны с VSS.

-   Разрешить доступ только определенным процессам для вызова процесса инициатора запроса.

    COM-сервер (например, инициатор запроса), вызывающий [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity) с дескриптором безопасности, отличным от **null** , в качестве первого параметра может использовать дескриптор для настройки, чтобы принимать входящие вызовы только от пользователей, принадлежащих определенному набору учетных записей.

    Инициатор запроса должен убедиться, что клиенты COM, работающие с действительными пользователями, имеют право на вызов своего процесса. Инициатор запроса, указывающий дескриптор безопасности в первом параметре, должен предоставить следующим пользователям возможность выполнять входящие вызовы в процессе запроса:

    -   Локальная система
    -   Локальная служба.

        **Windows XP:** это значение не поддерживается до Windows Server 2003.

    -   Сетевая служба.

        **Windows XP:** это значение не поддерживается до Windows Server 2003.

    -   Члены локальной группы администраторов
    -   Члены группы локальных операторов резервного копирования
    -   Специальные пользователи, указанные в расположении реестра ниже, "1" в качестве \_ значения reg DWORD

## <a name="explicitly-controlling-user-account-access-to-a-requester"></a>Явное управление доступом учетной записи пользователя к инициатору запроса

Бывают случаи, когда запрещен доступ к инициатору запроса для процессов, работающих в качестве локальной системы, или группы локальных администраторов или локальных операторов резервного копирования, которые могут быть слишком ограниченными.

Например, указанный процесс инициатора запроса может не требоваться для запуска с учетной записью администратора или оператора резервного копирования. По соображениям безопасности лучше не искусственно повышать привилегии процессов для поддержки VSS.

В таких случаях **\_ \_** \\  \\  \\ необходимо изменить раздел реестра CurrentControlSet **Services** \\ **VSS** \\ для **вссакцессконтрол** служб, чтобы указать службе VSS, что указанный пользователь может быть защищен для выполнения запрашивающей стороны VSS.

В этом разделе необходимо создать подраздел с тем же именем, что и у учетной записи, которой должен быть предоставлен или запрещен доступ. Для этого подраздела необходимо задать одно из значений, приведенных в следующей таблице.

| Значение | Значение                                             |
|-------|-----------------------------------------------------|
| 0     | Запрещает пользователю доступ к модулю записи и инициатору запроса.  |
| 1     | Предоставьте пользователю доступ к своему модулю записи.               |
| 2     | Предоставьте пользователю доступ к инициатору запроса.            |
| 3     | Предоставьте пользователю доступ к своему модулю записи и инициатору запроса. |



 

В следующем примере предоставляется доступ к \\ учетной записи "mydomain myuser":

```
HKEY_LOCAL_MACHINE
   SYSTEM
      CurrentControlSet
         Services
            VSS
               VssAccessControl
                  MyDomain\MyUser = 2<dl>
<dt>

                  Data type
</dt>
<dd>                  REG_DWORD</dd>
</dl>
```

Этот механизм также можно использовать, чтобы явно ограничить выполнение инициатора запроса VSS другим разрешенным пользователем. В следующем примере ограничение доступа будет ограничено \\ учетной записью администратора сатдомаин:

```
HKEY_LOCAL_MACHINE
   SYSTEM
      CurrentControlSet
         Services
            VSS
               VssAccessControl
                  ThatDomain\Administrator = 0<dl>
<dt>

                  Data type
</dt>
<dd>                  REG_DWORD</dd>
</dl>
```

Администратор Сатдомаин пользователя \\ не сможет запустить инициатор запроса VSS.

## <a name="performing-a-file-backup-of-the-system-state"></a>Выполнение резервного копирования файлов состояния системы

Если инициатор запроса выполняет резервное копирование отдельных файлов, а не использует образ тома для резервного копирования, он должен вызвать функции [**финдфирстфиленамев**](/windows/win32/api/fileapi/nf-fileapi-findfirstfilenamew) и [**финднекстфиленамев**](/windows/win32/api/fileapi/nf-fileapi-findnextfilenamew) для перечисления жестких ссылок на файлы, расположенные в следующих каталогах:

-   Windows \\ system32 \\ WDI \\ perftrack\\
-   Windows \\ WINSXS\\

Доступ к этим каталогам могут получить только члены группы «Администраторы». По этой причине такой инициатор должен работать под системной учетной записью или с учетной записью пользователя, которая является членом группы "Администраторы".

**Windows XP и Windows Server 2003:** функции [**финдфирстфиленамев**](/windows/win32/api/fileapi/nf-fileapi-findfirstfilenamew) и [**финднекстфиленамев**](/windows/win32/api/fileapi/nf-fileapi-findnextfilenamew) не поддерживаются до Windows Vista и Windows Server 2008.

 

 
