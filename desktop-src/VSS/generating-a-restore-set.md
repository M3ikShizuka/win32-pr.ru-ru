---
description: Набор восстановления — это список всех восстанавливаемых файлов и расположений, в которые они будут восстановлены.
ms.assetid: 3196c26c-3407-4c00-a800-c3497df583e5
title: Создание набора восстановления
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: db3447ba6d258a5f22fff958761abc7ac0e4f27f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105692925"
---
# <a name="generating-a-restore-set"></a>Создание набора восстановления

Набор восстановления — это список всех восстанавливаемых файлов и расположений, в которые они будут восстановлены.

Как и при создании списка файлов резервных копий (см. раздел [Создание резервного набора данных](generating-a-backup-set.md)), алгоритм определения восстанавливаемых файлов и их восстановления должен проделать [*экземпляр модуля записи*](vssgloss-w.md) экземпляром модуля записи, а также на уровне отдельных компонентов для каждого экземпляра модуля записи.

Необходимо связать каждый файл на носителе резервных копий с управляемым им компонентом. Также необходимо получить [*метод восстановления*](vssgloss-r.md)управляющего компонента, сведения о [*целевом объекте восстановления*](vssgloss-r.md) файла и [*сопоставлении альтернативного расположения*](vssgloss-a.md) (если они есть).

Для некоторых файлов также могут потребоваться операции с [*частичными файлами*](vssgloss-p.md) или [*направленные целевые объекты*](vssgloss-d.md) для восстановления.

Изучив возможность [*выбора компонентов для резервного копирования*](vssgloss-s.md) и [*логических путей*](vssgloss-l.md) (см. раздел [Работа с возможностью выбора и логическими путями](working-with-selectability-and-logical-paths.md)), инициатор запроса может определить структуру компонентов операции резервного копирования, которую планируется восстановить.

После установки структуры компонентов резервной копии инициатор запроса может получить сведения о [*наборе файлов*](vssgloss-f.md) каждого компонента (спецификация файла, путь и флаг рекурсии). Затем инициатор запроса может создать набор восстановления.

Файлы, требующие [*частичных файлов*](vssgloss-p.md)или [*направленные целевые объекты*](vssgloss-d.md) , предоставляют собственные подробные инструкции по восстановлению (см. раздел [расположения резервных копий и восстановления, не используемые по умолчанию](non-default-backup-and-restore-locations.md)), которые затем можно добавить в набор восстановления.

Типичный механизм создания набора восстановления для файлов, не участвующих в операциях с частичными файлами, или [*направленные целевые объекты*](vssgloss-d.md) могут выполняться следующим образом.

1.  Получите список файлов на носителе резервных копий, включая исходные пути.

2.  Чтобы найти [*класс и компонент модуля записи*](vssgloss-w.md) для каждого файла на носителе резервной копии, выполните следующие действия.

    -   Для каждого модуля записи получите сведения о компоненте ([**ивссвмкомпонент**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent)), вызвав [**ивссексаминевритерметадата::-Component**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent) для всех его компонентов.
    -   Для каждого компонента получите сведения о дескрипторе файла ([**ивссвмфиледеск**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc)) для каждого набора файлов, содержащихся в компоненте (в зависимости от типов данных, содержащихся в компоненте, путем вызова [**ивссвмкомпонент::-File**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getfile), [**Ивссвмкомпонент:: Жетдатабасефиле**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabasefile)и [**ивссвмкомпонент:: жетдатабаселогфиле**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabaselogfile).
    -   Сравните имя файла и сведения о пути, возвращаемые сведениями о пути, которые содержатся в дескрипторе файла для каждого набора файлов в компоненте (возвращаемых [**ивссвмфиледеск::**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getpath) [**Ивссвмфиледеск:: жетфилеспек**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getfilespec)и [**ивссвмфиледеск:: жетрекурсиве**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getrecursive)) по пути к сохраненным файлам, чтобы определить, является ли файл частью компонента.
        > [!Note]  
        > Следует игнорировать любые сведения о альтернативном расположении в дескрипторе файла, полученном из компонента, найденного в документе метаданных сохраненного модуля записи (то есть [**ивссвмфиледеск:: жеталтернателокатион**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) не возвращает **значение NULL**). Это альтернативное расположение — [*альтернативный путь*](vssgloss-a.md), который используется только во время резервного копирования.

         

3.  Получите дополнительные сведения о сопоставлении для каждого файла на резервном носителе:

    -   Альтернативные сопоставления файлов хранятся в модуле записи, а не на уровне компонента, и получаются из объекта [**ивссвмфиледеск**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) , возвращаемого [**Ивссексаминевритерметадата:: жеталтернателокатионмаппинг**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping).
    -   Можно определить, имеет ли определенный файл сопоставление альтернативного расположения, путем проверки пути и имени файла по пути и спецификации файла, которые содержатся в сопоставлении альтернативного расположения, возвращаемом [**ивссексаминевритерметадата:: жеталтернателокатионмаппинг**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping), через [**Ивссвмфиледеск:: Multipath**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getpath), [**Ивссвмфиледеск:: GetFilespec**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getfilespec)и [**IVssWMFiledesc:: GetRecursive**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getrecursive). (Если во время резервного копирования использовался альтернативный путь, эти сведения должны игнорироваться во время этой проверки при обработке восстановления.)
    -   Если файл и альтернативное расположение сопоставляют дескрипторы файлов, то для поиска альтернативного расположения, в котором можно восстановить файл, используется метод [**ивссвмфиледеск:: жеталтернателокатион**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) объекта [**ивссвмфиледеск**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) , возвращаемого [**ивссексаминевритерметадата:: жеталтернателокатионмаппинг**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping) .
    -   Сопоставление альтернативного расположения, полученное таким способом, не обязательно будет соответствовать возвращенному из документа компонентом резервного копирования с помощью [**ивсскомпонент:: жеталтернателокатионмаппинг**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping). Значение [**ивссвмфиледеск:: жеталтернателокатион**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) непусто только в том случае, если для файла используется сопоставление альтернативного расположения.

4.  С помощью этого файла и сведений о компонентах можно запросить документ с компонентами резервного копирования, чтобы получить сведения о целевых объектах восстановления, параметрах и новых расположениях для восстановления каждого файла. Эти сведения можно объединить со списком файлов, компонентов и альтернативных расположений.

5.  Файлы, не защищенные модулями записи, можно выбирать способом, согласованным с традиционными операциями восстановления.

На этом этапе инициатору запроса должен быть предоставлен список всех файлов, необходимых для восстановления, а также инструкции по их восстановлению, а также можно начинать восстановление файлов на основе:

-   Следует ли использовать сопоставление альтернативного расположения или расположение исходного файла в качестве целевого объекта для восстановления, зависит от наличия или отсутствия файла в этом целевом расположении и настроек компонентов [**\_ \_ целевого объекта восстановления VSS**](/windows/desktop/api/VsWriter/ne-vswriter-vss_restore_target) и [**\_ \_ перечислений Ресторемесод VSS**](/windows/desktop/api/VsWriter/ne-vswriter-vss_restoremethod_enum) (см. раздел [расположения резервных копий и восстановления, отличные от используемых по умолчанию](non-default-backup-and-restore-locations.md)).
-   Возможность выполнения попытки восстановления будет зависеть от таких проблем, как разрешения на доступ к целевой системе, если целевые файлы заблокированы и другие обычные проблемы, связанные с восстановлением файлов.
-   Успешное или неуспешное выполнение восстановления данного компонента для данного экземпляра модуля записи должно быть сохранено в документе компоненты резервного копирования путем вызова [**ивссбаккупкомпонентс:: сетфилересторестатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setfilerestorestatus). Это сделает эту информацию доступной для модулей записи при обработке события повторного восстановления.
-   Если файл восстанавливается в сопоставление с альтернативным расположением, инициатор запроса должен вызвать [**ивссбаккупкомпонентс:: аддалтернативелокатионмаппинг**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addalternativelocationmapping). Это позволит модулям записи определить, восстановлены ли файлы в альтернативных расположениях с помощью [**ивсскомпонент:: жеталтернателокатионмаппинг**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping).
-   Инициаторы запроса могут попытаться восстановить файлы в совершенно новые места. Это допустимо, но инициатор запроса должен указать это значение для модуля записи с помощью метода [**ивссбаккупкомпонентс:: аддневтаржет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addnewtarget) .

 

 



