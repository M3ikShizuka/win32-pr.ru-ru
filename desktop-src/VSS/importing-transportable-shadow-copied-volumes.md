---
description: Иногда желательно создать теневую копию в одной системе, но использовать теневую копию на второй системе.
ms.assetid: 4ec63917-03c0-434e-892e-3d9d4c47740e
title: Импорт переносимых теневых скопированных томов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 3d259fbc047d088ee1f7064804a3ee98fe48da1b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104156126"
---
# <a name="importing-transportable-shadow-copied-volumes"></a>Импорт переносимых теневых скопированных томов

Иногда желательно создать теневую копию в одной системе, но использовать теневую копию на второй системе.

Рассмотрим случай, когда данные для резервного копирования обычно управляются заданной системой (*системоне*) во время нормальной работы и что эти данные физически хранятся в массиве хранения данных или на устройстве.

Чтобы минимизировать перебои в *системоне* (поскольку операции резервного копирования могут быть ресурсоемкими), желательно выполнить резервное копирование с помощью *системтво*, сервера резервного копирования, который имеет доступ к тому же массиву хранения данных, что и *системоне*.

Для обеспечения правильной теневой копии — взаимодействия с модулями записи в *системоне* и сохранения состояния в соответствии с текущими задачами — теневая копия должна выполняться *системоне*.

Поэтому *системоне* должен создать [*транспортную теневую копию*](vssgloss-t.md), которая затем будет импортирована *системтво* .

**Windows server 2003, Standard Edition, Windows Server 2003, Web Edition и Windows XP:** Перепереносимые наборы теневых копий не поддерживаются. Все выпуски Windows Server 2003 с пакетом обновления 1 (SP1) поддерживают переносимые наборы теневых копий.

Типичный пример импорта переносимой теневой копии может быть выполнен следующим образом.

1.  Изначально логическая единица (LUN), предоставляемая массивом хранения данных, монтируется как том на *системоне* (скажем, F:).
2.  Запрашивающий объект, выполняющийся на *системоне* , создает экземпляр [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) и продолжает работу, как если бы он был готов к резервному копированию. (Дополнительные сведения см. в разделе [Обзор инициализации резервного копирования](overview-of-backup-initialization.md), [Обзор этапа обнаружения резервных копий](overview-of-the-backup-discovery-phase.md)и [Обзор задач, выполняемых перед резервным копированием](overview-of-pre-backup-tasks.md) .)
3.  Запрашивающий объект *системоне* изменяет контекст теневого копирования, который обычно используется для локальной операции резервного копирования **( \_ \_ \_ резервное копирование приложений VSS CTX**), чтобы указать, что будет создана транспортная теневая копия (**VSS \_ VOLSNAP attr может быть \_ \_ транспортом**). Транспортный атрибут можно также добавить в другие контексты теневого копирования.
4.  С помощью контекста теневого копирования **для \_ \_ \_ резервного копирования CTX** для VSS в службе VSS с \| **\_ \_ \_ транспортным** экземпляром, который находится на *системоне* , создает теневую копию путем вызова [**ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset).
5.  *Системоне* использует [**Ивссбаккупкомпонентс:: савеасксмл**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-saveasxml) для сохранения текущего состояния документа компонентов резервного копирования и [**ивссексаминевритерметадата:: Савеасксмл**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-saveasxml) для сохранения документов метаданных модуля записи каждого модуля записи. Затем строки XML, содержащие эти документы, становятся доступными для запрашивающей стороны, который выполняется в *системтво*.

    Инициатор запроса передает документ компонентов резервного копирования в *системтво*.

    Обратите внимание, что инициатор запроса на *системоне* не освобождает экземпляр [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) в этот момент, если целью теневой копии является резервная копия. Интерфейс должен оставаться открытым до тех пор, пока *системтво* успешно не завершит свои операции резервного копирования. Только тогда инициатор запроса выдает событие [**баккупкомплете**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) , так как некоторые модули записи усекаются журналы и выполняют другие действия после успешной архивации. Если целью теневой копии является интеллектуальный анализ данных или другие цели, то на этом шаге интерфейс можно закрыть.

6.  Затем запрашивающий объект *системтво* вызывает [**Ивссбаккупкомпонентс:: импортснапшотс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) , чтобы получить доступ к теневой копии, созданной инициатором запроса на *системоне*.
    > [!Note]  
    > Инициатор запроса отвечает за сериализацию операции импорта теневого копирования. Кроме того, если вызов [**ивссбаккупкомпонентс:: импортснапшотс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) завершается СБОЕМ, VSS не будет очищать LUN. Инициатору запроса необходимо инициировать очистку LUN.

     

7.  Инициатор запроса на *системтво* продолжает создавать резервную копию материала с теневым копированием точно так же, как при резервном копировании созданной им теневой копии (см. [Обзор фактической резервной копии файлов](overview-of-actual-backup-of-files.md)).

    Инициатор запроса *системтво* получает [*объект устройства*](vssgloss-d.md) теневой копии с помощью [**ивссбаккупкомпонентс:: жетснапшотпропертиес**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getsnapshotproperties) в импортированной теневой копии и добавляет его в начало исходных путей к файлам, полученных из метаданных для доступа к файлам для резервного копирования.

8.  После использования теневой копии инициатор запроса на *системтво* должен удалить теневую копию. Как и в случае с непереносимыми теневыми копиями, если контекст теневой копии указывает на теневые копии с автоматическим освобождением (например, **\_ CTX \_ резервное копирование VSS**), то освобождение [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) на *системтво* вызовет удаление теневой копии службой VSS. В противном случае, если контекст указывает на постоянную теневую копию (например, **\_ \_ \_ откат приложения VSS CTX**), инициатор запроса на *системтво* должен явным образом удалить теневую копию.

    Затем инициатор запроса на *системтво* сигнализирует инициатору запроса на *системоне* , что он завершился с резервной копией переносимой теневой копии.

9.  После того как инициатор запроса *системоне* получил уведомление о том, что инициатор запроса на *системтво* завершил резервное копирование переносимой теневой копии, он уведомляет модули записи о своей системе, создавая событие [**баккупкомплете**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) с вызовом **ивссбаккупкомпонентс:: баккупкомплете**. На этом этапе инициатор запроса в *системоне* может освободить свой экземпляр [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents).

**Перепереносимые теневые копии в кластере:** Перепереносимые теневые копии необходимо импортировать из-за пределов кластера, если исходный том подключен в кластере. Сведения о реализации быстрого восстановления в кластере см. в статье [быстрое восстановление с помощью переносимых теневых скопированных томов](fast-recovery-using-transportable-shadow-copied-volumes.md).

 

 



