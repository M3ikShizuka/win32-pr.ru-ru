---
description: Поставщик теневого копирования должен соответствовать рекомендациям, чтобы обеспечить совместимость с инициатором запроса.
ms.assetid: 49baeb89-1dc9-45c2-a532-071085a8e52f
title: Требуемые поведения для поставщиков теневого копирования
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f451dea7154a313cd64a3a46fbcc3b5fe663ec12
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105692883"
---
# <a name="required-behaviors-for-shadow-copy-providers"></a>Требуемые поведения для поставщиков теневого копирования

Поставщик теневого копирования должен соответствовать рекомендациям, чтобы обеспечить совместимость с инициатором запроса. Во время выполнения приложение резервного копирования или любой другой инициатор запроса, использующий теневые копии, должен работать правильно без знания конкретных сведений о реализации поставщика.

## <a name="automagic-resource-management"></a>Управление ресурсами automagic

Инициатор запроса должен просто добавить том в набор теневых копий. Инициатор запроса может указать атрибуты теневого копирования, такие как **\_ \_ \_ транспортная служба VSS**, переопределяющая **\_ \_ \_ разностная копия, VSS Volsnap** attr и (или) **VSS \_ Volsnap \_ attr \_** в [**\_ \_ \_ контексте моментального снимка VSS**](/windows/desktop/api/Vss/ne-vss-vss_snapshot_context). Поставщик должен учитывать эти атрибуты. Если эти атрибуты не учитываются, то он должен указывать на то, что набор теневых копий не поддерживается путем установки параметра \* *Пбиссуппортед* в [**ивсшардвареснапшотпровидер:: арелунссуппортед**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) в **значение false**.

Поставщик не должен согласиться на поддержку теневой копии, которую он не может создать. Если в инициаторе запроса не указан Плекс или разностный атрибут, поставщик должен включить логику автоволшебия для выделения пространства подсистемы для теневого копирования и создания теневой копии с помощью наиболее подходящего метода. Поставщик оборудования не должен включать API конкретного поставщика для управления необходимыми свойствами теневого копирования.

## <a name="created-shadow-copy-volumes-are-read-only-and-hidden"></a>Тома теневой копии созданы Read-Only и скрыты

VSS устанавливает флаги на каждом затронутом LUN таким, что результирующие тома теневых копий будут скрыты и доступны только для чтения при обнаружении компьютером под управлением Windows Server 2003. Буквы дисков и подключенные папки не назначаются автоматически. VSS поддерживает эти флаги в течение жизненного цикла теневой копии.

## <a name="hardware-shadow-copy-luns-must-be-readwrite"></a>Аппаратные теневые копии LUN должны быть доступны для чтения и записи

VSS поддерживает аппаратные теневые копии только в том случае, если базовый LUN сопоставлен как доступный для чтения и записи. Это необходимо сделать до создания теневой копии. его невозможно выполнить после факта. Поставщики оборудования не должны изменять эти флаги. Дополнительные сведения о том, как VSS использует эти флаги, см. [в разделе процесс создания теневой копии](the-shadow-copy-creation-process.md).

## <a name="auto-import-hardware-shadow-copies-are-not-supported-on-windows-cluster-service"></a>Автоматическое импортирование аппаратных теневых копий не поддерживается в службе кластеров Windows

Служба кластеров Windows не поддерживает LUN с повторяющимися сигнатурами и разметкой секций. LUN теневой копии должен быть перенесен на узел, находящийся за пределами кластера. Дополнительные сведения см. в статье [быстрое восстановление с помощью переносимых теневых скопированных томов](fast-recovery-using-transportable-shadow-copied-volumes.md).

## <a name="shadow-copies-that-contain-dynamic-disks-must-be-transported-to-a-different-host"></a>Теневые копии, содержащие динамические диски, должны переноситься на другой узел

**До Windows Server 2008:** Собственная поддержка динамических дисков не может поддерживать LUN с повторяющимися сигнатурами и содержимым базы данных конфигурации. LUN теневой копии должен быть перенесен на другой узел. VSS применяет это, не разрешая автоматическое импортирование теневых копий динамических дисков. Инициатор запроса не должен импортировать транспортную теневую копию обратно на тот же узел.

**Начиная с Windows Server 2008:** Это ограничение удаляется.

## <a name="providers-are-out-of-process"></a>Поставщики вне процесса

Все поставщики должны быть реализованы как необработанные COM-компоненты.

## <a name="time-critical-operations"></a>Time-Critical операции

Длительные операции, такие как синхронизация плексов, должны быть инициированы в [**ивсшардвареснапшотпровидер:: бегинпрепареснапшот**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot). Эта функция должна запустить асинхронную подготовку и быстро возвращать данные. [**Ивсспровидеркреатеснапшотсет:: ендпрепареснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) служит «встречной» функцией — поставщик может подождать синхронно в этом методе для завершения подготовительной работы, запущенной **бегинпрепареснапшот**.

Поставщики не должны добавлять задержки в [**ивсспровидеркреатеснапшотсет::P рекоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**Ивсспровидеркреатеснапшотсет:: CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)или [**IVssProviderCreateSnapshotSet::P ostcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) , так как приложения фиксируются во время этих вызовов. **Коммитснапшотс** должен возвращаться в течение нескольких секунд, так как этот вызов вызывается во время очистки и удерживания, а поддержка ядра VSS отменит сброс и удержание, если выпуск не будет получен в течение 10 секунд, что приведет к сбою VSS при создании теневой копии. Если для выполнения этого вызова поставщик занимает более нескольких секунд, существует высокая вероятность того, что создание теневой копии завершится ошибкой.

## <a name="careful-io-during-commitsnapshots"></a>Тщательный ввод-вывод во время Коммитснапшотс

Поставщикам оборудования не нужно выполнять операции ввода-вывода для томов, участвующих в теневой копии, во время [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots). Если требуется любой ввод-вывод, поставщики не должны инициировать операции ввода-вывода для исходного тома при обработке метода **коммитснапшотс** .

Во время [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)драйверы поддержки ядра VSS блокируют ввод-вывод для исходных томов, для которых выполняется теневое копирование. Если поставщик использует синхронный ввод-вывод для тома, который находится в наборе теневых копий, операции ввода-вывода будут заблокированы, и процесс фиксации теневой копии будет блокироваться. Поставщик не должен вызывать API-интерфейсы Win32 во время **коммитснапшотс** , так как они будут иметь высокую вероятность возникновения операций ввода-вывода и взаимоблокировки. Время ожидания поддержки ядра VSS приведет к нарушению этой взаимоблокировки через 10 секунд, но это вызовет сбой создания теневой копии.

Если необходимо попытаться выполнить операцию ввода-вывода, она должна выполняться асинхронно. Ввод-вывод не будет выполнен до тех пор, пока все поставщики не будут возвращены из своих методов [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) . Как правило, лучше выполнять такие операции в вызове [**посткоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) .

## <a name="readwrite-shadow-copy-luns"></a>Чтение и запись LUN теневого копирования

В этой версии служба VSS поддерживает только LUN для чтения и записи, даже если тома доступны только для чтения. Причина заключается в том, что системе необходимо изменить такие структуры данных на диске, как:

-   Подпись диска, которая изменяется в процессе теневого копирования.
-   Структуры данных, связанные с секциями, включая те, которые указывают, что Секция доступна только для чтения, скрыта, является теневой копией и не должна назначать букву диска.

## <a name="unique-page-83-information"></a>Уникальная страница сведения 83

Как исходный LUN, так и созданный LUN теневой копии должны иметь по крайней мере один уникальный идентификатор хранилища на странице 83 данных. По крайней мере один \_ идентификатор хранилища с типом, равным 1, 2, 3 или 8, и Ассоциация 0 должна быть уникальной в ИСХОДНОМ LUN и только что созданном LUN теневой копии.

 

 



