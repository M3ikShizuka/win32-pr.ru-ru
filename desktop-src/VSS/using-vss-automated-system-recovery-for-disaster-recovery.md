---
description: Приложение для резервного копирования и восстановления VSS, которое выполняет аварийное восстановление (также называемое восстановлением исходного состояния системы), может использовать средство записи аварийного восстановления (ASR) вместе с среда предустановки Windows (Windows PE) для резервного копирования и восстановления критических томов и других компонентов загрузочного состояния системы. Приложение резервного копирования реализуется как инициатор запроса VSS.
ms.assetid: 13adfd79-f26a-4385-9b59-129d06fa72eb
title: Использование автоматического восстановления системы VSS для аварийного восстановления
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1e31ef8ba223f40928e2422fa92240656f94592d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105692391"
---
# <a name="using-vss-automated-system-recovery-for-disaster-recovery"></a>Использование автоматического восстановления системы VSS для аварийного восстановления

Приложение для резервного копирования и восстановления VSS, которое выполняет аварийное восстановление (также называемое восстановлением исходного состояния системы), может использовать средство записи аварийного восстановления (ASR) вместе с среда предустановки Windows (Windows PE) для резервного копирования и восстановления критических томов и других компонентов загрузочного состояния системы. Приложение резервного копирования реализуется как инициатор запроса VSS.

**Примечание**  .  Приложения, использующие ASR, должны лицензировать Windows PE.

**Windows Server 2003 и Windows XP:** ASR не реализован в качестве модуля записи VSS.

Сведения о средствах трассировки, которые можно использовать с ASR, см. в разделе [использование средств трассировки с помощью приложений VSS ASR](using-tracing-tools-with-vss-asr-applications.md).

**В этой статье:**

-   [Общие сведения о задачах этапа резервного копирования](#overview-of-backup-phase-tasks)
-   [Выбор критически важных компонентов для резервного копирования](#choosing-which-critical-components-to-back-up)
-   [Обзор задач этапа восстановления](#overview-of-restore-phase-tasks)
-   [Исключение всех дисков для тома](#excluding-all-disks-for-a-volume)

## <a name="overview-of-backup-phase-tasks"></a>Общие сведения о задачах этапа резервного копирования

Во время резервного копирования инициатор запроса выполняет следующие действия.

> [!Note]  
> Все действия необходимы, если не указано иное.

 

1.  Вызовите функцию [**креатевссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) , чтобы создать экземпляр интерфейса [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) и вызвать метод [**ивссбаккупкомпонентс:: инитиализефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) , чтобы инициализировать экземпляр для управления резервной копией.
2.  Вызовите [**ивссбаккупкомпонентс:: SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) , чтобы задать контекст для операции теневого копирования.
3.  Вызовите [**ивссбаккупкомпонентс:: сетбаккупстате**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate) , чтобы настроить резервное копирование. Задайте для параметра *ббаккупбутаблесистемстате* **значение true** , чтобы указать, что резервная копия будет включать загрузочное состояние системы.
4.  Выберите критически важные компоненты в документе метаданных модуля записи ASR Writer для резервного копирования и вызовите метод [**ивссбаккупкомпонентс:: AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) для каждого из них.
5.  Вызовите метод [**ивссбаккупкомпонентс:: стартснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) , чтобы создать новый пустой набор теневых копий.
6.  Вызовите метод [**ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) , чтобы инициировать асинхронное обращение с модулями записи.
7.  Вызовите [**ивссбаккупкомпонентс:: жетвритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) , чтобы получить документ метаданных модуля записи ASR Writer. Идентификатор модуля записи для модуля записи ASR — BE000CBE-11FE-4426-9C58-531AA6355FC4, а строка имени модуля записи — "ASR Writer".
8.  Вызовите [**ивссексаминевритерметадата:: савеасксмл**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-saveasxml) , чтобы сохранить копию документа метаданных модуля записи ASR Writer.
9.  Вызовите [**ивссбаккупкомпонентс:: аддтоснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset) для каждого тома, который может участвовать в теневых копиях, чтобы добавить том в набор теневых копий.
10. Вызовите [**ивссбаккупкомпонентс::P репарефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , чтобы уведомить модули записи о необходимости подготовки к операциям резервного копирования.
11. Вызовите [**ивссбаккупкомпонентс:: гасервритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) и [**Ивссбаккупкомпонентс:: Жетвритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) (или [**IVssBackupComponentsEx3:: жетвритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponentsex3-getwriterstatusex)), чтобы проверить состояние модуля записи ASR.
12. На этом этапе можно запросить сообщения об ошибках, которые были заданы модулем записи в своем методе [**квссвритер:: онпрепаребаккуп**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) . Пример кода, демонстрирующий просмотр этих сообщений, см. в разделе [**ивсскомпонентекс:: жетпрепарефорбаккупфаилуремсг**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponentex-getprepareforbackupfailuremsg).
13. Вызовите [**ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) , чтобы создать теневую копию тома.
14. Вызовите [**ивссбаккупкомпонентс:: гасервритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) и [**Ивссбаккупкомпонентс:: жетвритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) , чтобы проверить состояние модуля записи ASR.
15. Создайте резервную копию данных.
16. Укажите, завершилась ли операция резервного копирования путем вызова [**ивссбаккупкомпонентс:: сетбаккупсукцеедед**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded).
17. Вызовите [**ивссбаккупкомпонентс:: баккупкомплете**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) , чтобы указать, что операция резервного копирования завершена.
18. Вызовите [**ивссбаккупкомпонентс:: гасервритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) и [**Ивссбаккупкомпонентс:: жетвритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus). Память состояния сеанса модуля записи является ограниченным ресурсом, и модули записи должны в конечном итоге повторно использовать состояния сеанса. Этот шаг помечает состояние сеанса резервного копирования модуля записи как завершенное и уведомляет VSS о том, что этот слот сеанса резервного копирования может быть повторно использован последующей операцией резервного копирования.
    > [!Note]  
    > Это необходимо только в Windows Server 2008 с пакетом обновления 2 (SP2) и более ранних версий.

     

19. Вызовите [**ивссбаккупкомпонентс:: савеасксмл**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-saveasxml) , чтобы сохранить копию документа компонентов резервного копирования инициатора запроса. Сведения в документе о компонентах резервного копирования используются во время восстановления, когда инициатор запроса вызывает метод [**ивссбаккупкомпонентс:: инитиализефорресторе**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) .

## <a name="choosing-which-critical-components-to-back-up"></a>Выбор критически важных компонентов для резервного копирования

На этапе инициализации резервного копирования модуль записи ASR сообщает о следующих типах компонентов в своем документе метаданных модуля записи:

-   Критические тома, такие как загрузочный, системный и Windows RE, и раздел Windows RE, связанный с экземпляром Windows Vista или Windows Server 2008, который выполняется в данный момент. Том является *критическим томом* , если он содержит сведения о состоянии системы. Загрузочный и системный тома включаются автоматически. Инициатор запроса должен включать все тома, которые содержат критически важные для системы компоненты, например тома, содержащие Active Directory. Критические для системы компоненты отмечены как "невыбираемые для резервного копирования". В VSS "не является выбираемым" означает "не необязательно". Таким образом, инициатору запроса необходимо создать резервную копию в рамках состояния системы. Дополнительные сведения см. в разделе [резервное копирование и восстановление состояния системы](locating-additional-system-files.md). Компоненты, для которых \_ \_ установлен флаг VSS CF не \_ \_ состояния системы, не являются критически важными для системы.
    > [!Note]  
    > Компонент ASR — это критически важный для системы компонент, о котором сообщает модуль записи ASR.

     

-   Диски. Каждый фиксированный диск компьютера предоставляется в виде компонента ASR. Если диск не был исключен во время резервного копирования, он будет назначен во время восстановления и может быть создан повторно и отформатирован. Обратите внимание, что во время восстановления инициатор запроса по-прежнему может повторно создать диск, который был исключен во время резервного копирования, вызвав метод [**ивссбаккупкомпонентс:: сетрестореоптионс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) . Если выбран один диск в динамическом пакете диска, также необходимо выбрать все остальные диски в этом пакете. Если выбран том, так как это критически важный том (т. е. том, содержащий сведения о состоянии системы), необходимо также выбрать каждый диск, содержащий экстент для этого тома. Чтобы найти экстенты для тома, используйте управляющий код на подзапросе [**ioctl \_ \_ \_ \_ \_**](/windows/win32/api/winioctl/ni-winioctl-ioctl_volume_get_volume_disk_extents) .

    > [!Note]  
    > Во время резервного копирования инициатор запроса должен включать все фиксированные диски. Если диск, содержащий резервный набор данных инициатора запроса, является локальным диском, этот диск следует добавить. Во время восстановления запрашивающий объект должен исключить диск, содержащий резервный набор данных инициатора запроса, чтобы предотвратить перезапись.

     

    В среде с кластеризацией ASR не создает повторно макет общих дисков кластера. Эти диски следует восстанавливать в оперативном режиме после восстановления операционной системы в Windows RE.

-   Хранилище данные конфигурации загрузки (BCD). Этот компонент задает путь к каталогу, содержащему хранилище BCD. Инициатор запроса должен указать этот компонент и создать резервную копию всех файлов в каталоге хранилища BCD. Дополнительные сведения о хранилище BCD см. в разделе [About BCD](/previous-versions/windows/desktop/bcd/about-bcd).
    > [!Note]  
    > На компьютерах, использующих интерфейс EFI, системный раздел EFI (ESP) всегда скрыт и не может быть включен в теневую копию тома. Инициатор запроса должен создать резервную копию содержимого этой секции. Так как эта Секция не может быть включена в теневую копию тома, резервное копирование может выполняться только из динамического тома, а не из теневой копии. Дополнительные сведения о EFI и ESP см. в статье о [программе](/windows-hardware/drivers/bringup/).

В именах компонентов используются следующие форматы:

-   Для компонентов диска используется формат

    <COMPONENT logicalPath="Disks" componentName="harddisk*n*" componentType="filegroup" />

    где *n* — номер диска. Записывается только номер диска. Чтобы получить номер диска, используйте контрольный код для [**\_ \_ получения \_ \_ номера устройства в хранилище ioctl**](/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_get_device_number) .

-   Для компонентов тома используется формат

    <COMPONENT logicalPath="Volumes" componentName="Volume{*GUID*}" componentType="filegroup" />

    где *GUID* — GUID тома.

-   Для компонента хранилища BCD используется формат

    <COMPONENT logicalPath="BCD" componentName="BCD" componentType="filegroup" componentCaption = "This is the path to the boot BCD store and the boot managers...All the files in this directory need to be backed up...">

    Если системный раздел имеет имя GUID тома, этот компонент доступен для выбора. В противном случае он не может быть выбран.

    > [!Note]  
    > ASR добавляет файлы в файловую группу компонента хранилища BCD следующим образом:
    >
    > -   Для дисков EFI добавляется ASR
    >
    >     *Системпартитионпас* \\ \\Загрузка EFI \\ Майкрософт \\ \* .\*
    >
    >     где *системпартитионпас* — это путь к системному разделу.
    >
    > -   Для дисков GPT добавляется ASR
    >
    >     *Системпартитионпас* \\ Загрузка \\ \* .\*
    >
    >     где *системпартитионпас* — это путь к системному разделу.
    >
    > -   Путь к системному разделу можно найти в следующем разделе реестра: **\_ \_** \\  \\ **программа установки** \\ **системпартитион** локального компьютера hKey.

     

При восстановлении необходимо восстановить все компоненты, помеченные как критические тома. Если не удается восстановить один или несколько критических томов, операция восстановления завершается сбоем.

На этапе предварительного [**восстановления**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) последовательности восстановления диски, которые не были исключены во время резервного копирования, создаются повторно и форматируются по умолчанию. Однако они не создаются повторно или переформатированы, если они отвечают следующим условиям.

-   Базовый диск не создается повторно, если его структура диска не повреждена или в нее внесены только Аддитивные изменения. Структура диска не изменяется, если выполняются следующие условия.
    -   Подпись диска, тип диска (GPT или MBR), размер логического сектора и смещение начала тома не изменяются.
    -   Размер тома не уменьшается.
    -   Для дисков GPT идентификатор секции не изменяется.
-   Динамический диск не создается повторно, если его структура диска не повреждена или в нее были внесены только добавочные изменения. Для неизменности динамического диска необходимо выполнить все условия для базового диска. Кроме того, вся структура тома в пакете диска не должна быть повреждена. Структура тома диска не изменяется, если она соответствует следующим условиям, которые применяются к дискам MBR и GPT:
    -   Количество томов, доступных в физическом пакете во время восстановления, должно быть больше или равно числу томов, указанных в метаданных модуля записи ASR во время резервного копирования.
    -   Число [*плексов*](../vds/virtual-disk-service-glossary-all.md) на том должно быть не изменено.
    -   Число [*членов*](../vds/virtual-disk-service-glossary-all.md) должно быть неизменным.
    -   Число экстентов физического диска должно быть больше числа экстентов диска, указанных в метаданных модуля записи ASR.
    -   Неповрежденный пакет остается неизменным при добавлении дополнительных томов или при расширении тома в пакете (например, с простого тома на составной том).
        > [!Note]  
        > Если простой том зеркально отражается, он не изменяется и будет создан повторно, чтобы убедиться в том, что после восстановления состояние BCD и загрузочный том остаются постоянными. При удалении томов пакет создается повторно.

         
-   Если структура тома динамического диска не повреждена и в нее были внесены только Аддитивные изменения, диски в пакете не создаются повторно.

    **Windows Vista:** Динамические диски всегда создаются повторно. Обратите внимание, что это поведение изменилось в Windows Server 2008 и Windows Vista с пакетом обновления 1 (SP1).

В любое время до начала этапа восстановления инициатор запроса может указать, что диски должны быть кратко отформатированы, задав раздел реестра **hKey \_ Local \_ Machine** \\ **Software** \\ **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **ресторесессион** . В этом разделе есть значение с именем **куиккформат** и типом данных REG \_ DWORD. Если это значение не существует, его следует создать. Задайте для параметра **куиккформат** значение 1 для быстрого форматирования или 0 для ускорения форматирования.

Если значение **куиккформат** не существует, диски будут иметь низкую отформатированную.

Быстрое форматирование выполняется значительно быстрее, чем медленный формат (также называется полным форматированием). Однако быстрое форматирование не проверяет каждый сектор тома.

## <a name="overview-of-restore-phase-tasks"></a>Обзор задач этапа восстановления

Во время восстановления инициатор запроса выполняет следующие действия:

> [!Note]  
> Все действия необходимы, если не указано иное.

 

1.  Вызовите функцию [**креатевссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) , чтобы создать экземпляр интерфейса [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) и вызвать метод [**ивссбаккупкомпонентс:: инитиализефорресторе**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) , чтобы инициализировать экземпляр для восстановления, загрузив документ компонентов резервного копирования инициатора запроса в экземпляр.
2.  \[Этот шаг необходим только в том случае, если инициатору запроса необходимо изменить значение "Инклудедиск" или "Ексклудедиск" для одного или нескольких дисков. \] Вызовите метод [**ивссбаккупкомпонентс:: сетрестореоптионс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) , чтобы задать параметры восстановления для компонентов модуля записи ASR. Модуль записи ASR поддерживает следующие параметры: "Инклудедиск" позволяет инициатору запроса включить в целевую систему диск, который будет считаться восстановленным, даже если он не был выбран на этапе резервного копирования. "Ексклудедиск" позволяет инициатору запроса предотвратить повторное создание диска в целевой системе. Обратите внимание, что если для диска, содержащего критический том, указан параметр "Ексклудедиск", последующий вызов [**ивссбаккупкомпонентс::P**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) Повторное восстановление будет невозможно.

    В следующем примере показано, как использовать [**сетрестореоптионс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) , чтобы предотвратить повторное создание диска 0 и диска 1 и внедрить сторонние драйверы в восстановленный загрузочный том.

    Windows **server 2008, Windows Vista, Windows server 2003 и Windows XP:** Внедрение драйверов сторонних производителей не поддерживается.

    В примере предполагается, что указатель [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) , m \_ пбаккупкомпонентс, является допустимым.

    ```C++
        m_pBackupComponents->SetRestoreOptions(
            AsrWriterId,
            VSS_CT_FILEGROUP,
            NULL,
            TEXT("ASR"),
            TEXT("\"ExcludeDisk\"=\"0\", \"ExcludeDisk\"=\"1\" "),
            TEXT("\"InjectDrivers\"=\"1\" ")
            );
    ```

    

    Чтобы исключить все диски для указанного тома, см. следующую статью "исключение всех дисков для тома".

3.  Вызовите [**ивссбаккупкомпонентс::P Rerestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) , чтобы уведомить модуль записи ASR о необходимости подготовиться к операции восстановления. Вызывайте [**ивссасинк:: QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) столько раз, сколько необходимо, пока значение состояния, возвращенное в параметре *фрресулт* , не является \_ \_ асинхронным \_ ожиданием VSS S.
4.  Восстановление данных. На этапе восстановления ASR перестраивает путь GUID тома ( \\ \\ ? \\ Том {GUID}) для каждого тома, совпадающего с путем GUID тома, который использовался на этапе резервного копирования. Однако буквы дисков не сохраняются, так как это приведет к конфликту с буквами дисков, которые автоматически назначаются в среде восстановления. Поэтому при восстановлении данных инициатору запроса необходимо использовать пути GUID тома, а не буквы диска для доступа к томам.
5.  Задайте раздел реестра **HKLM** \\ **Software** \\ **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **ресторесессион** , чтобы указать набор восстановленных или переформатированных томов.

    В этом разделе есть значение с именем **ресторедволумес** и типом данных REG \_ Multi \_ SZ. Если это значение не существует, его следует создать. В этом значении инициатору запроса следует создать запись GUID тома для каждого восстановленного тома. Эта запись должна иметь следующий формат: \\ \\ ? \\ Том {78618c8f-aefd-11da-a898-806e6f6e6963}. При каждом выполнении восстановления без операционной системы ASR устанавливает значение **ресторедволумес** в набор томов, восстановленных с помощью ASR. Если инициатор запроса восстановил дополнительные тома, ему следует задать для этого параметра объединение набора томов, восстановленных инициатором запроса, и набора томов, восстановленных с помощью ASR. Если инициатор запроса не использовал ASR, он должен заменить список томов.

    Необходимо также создать значение с именем **ластинстанце** и типом данных REG \_ SZ. Этот ключ должен содержать случайный файл cookie, который однозначно определяет текущую операцию восстановления. Такой файл cookie можно создать с помощью функций [**ууидкреате**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) и [**ууидтостринг**](/windows/win32/api/rpcdce/nf-rpcdce-uuidtostring) . При каждом выполнении восстановления без операционной системы ASR сбрасывает этот параметр реестра, чтобы уведомлять запрашивающих и не поддерживающих VSS приложения резервного копирования, которые произошли при восстановлении.

6.  Вызовите [**ивссбаккупкомпонентс::P остресторе**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) , чтобы указать конец операции восстановления. Вызывайте [**ивссасинк:: QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) столько раз, сколько необходимо, пока значение состояния, возвращенное в параметре *фрресулт* , не является \_ \_ асинхронным \_ ожиданием VSS S.

На этапе восстановления ASR может создать или удалить разделы, чтобы восстановить предыдущее состояние компьютера. Запрашивающие стороны не должны пытаться сопоставлять номера дисков с этапа резервного копирования на этапе восстановления.

При восстановлении инициатор запроса должен исключить диск, содержащий резервный набор данных инициатора запроса. В противном случае резервный набор данных может быть перезаписан операцией восстановления.

При восстановлении диск исключается, если он не был выбран в качестве компонента во время резервного копирования или явно исключен путем вызова [**ивссбаккупкомпонентс:: сетрестореоптионс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) с параметром "ексклудедиск" во время восстановления.

Важно отметить, что во время аварийного восстановления WinPE существует функция модуля записи ASR, но другие модули записи недоступны, а служба VSS не запущена. После завершения аварийного восстановления WinPE компьютер перезапускается, и операционная система Windows работает нормально, служба VSS может быть запущена, а инициатор запроса может выполнять любые дополнительные операции восстановления, для которых требуется участие в модулях записи ASR.

Если во время сеанса восстановления приложение резервного копирования обнаруживает, что уникальные идентификаторы томов не изменились и, следовательно, все тома с момента создания резервной копии находятся в среде WinPE и остаются нетронутыми, приложение резервного копирования может восстановить только содержимое томов, не включая ASR. В этом случае приложение резервного копирования должно указать, что компьютер был восстановлен, задав следующий раздел реестра в восстановленной операционной системе: **hKey \_ Local \_ Machine** \\ **Software** \\ **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **ресторесессион**

В этом разделе Укажите **ластинстанце** в качестве значения Name, REG \_ SZ для типа значения и случайный файл cookie (например, GUID, созданный функцией [**ууидкреате**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) ) для данных значения.

Если во время сеанса восстановления приложение резервного копирования обнаруживает, что один или несколько томов изменились или отсутствуют, приложение резервного копирования должно использовать ASR для выполнения восстановления. ASR воссоздаст тома точно так же, как и на момент резервного копирования, и установит раздел реестра **ресторесессион** .

## <a name="excluding-all-disks-for-a-volume"></a>Исключение всех дисков для тома

В следующем примере показано, как исключить все диски для указанного тома.


```C++
HRESULT BuildRestoreOptionString
(
    const WCHAR             *pwszVolumeNamePath,
    CMyString               *pstrExclusionList
)
{
    HANDLE                  hVolume           = INVALID_HANDLE_VALUE;
    DWORD                   cbSize            = 0;
    VOLUME_DISK_EXTENTS     * pExtents        = NULL;
    DISK_EXTENT             * pExtent         = NULL;
    ULONG                   i                 = 0;
    BOOL                    fIoRet            = FALSE;
    WCHAR                   wszDest[MAX_PATH] = L"";
    CMyString               strVolumeName;
    CMyString               strRestoreOption;

    // Open a handle to the volume device.
    strVolumeName.Set( pwszVolumeNamePath );
    // If the volume name contains a trailing backslash, remove it.
    strVolumeName.UnTrailing( L'\\' );
    hVolume = ::CreateFile(strVolumeName, 0, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, NULL, 0);
    // Check whether the call to CreateFile succeeded.

    // Get the list of disks used by this volume.
    cbSize = sizeof(VOLUME_DISK_EXTENTS);
    pExtents = (VOLUME_DISK_EXTENTS *)::CoTaskMemAlloc(cbSize);

    ::ZeroMemory(pExtents, cbSize);

    fIoRet = ::DeviceIoControl(hVolume, IOCTL_VOLUME_GET_VOLUME_DISK_EXTENTS, NULL, 0, pExtents, cbSize, &cbSize, 0);
    if ( !fIoRet && GetLastError() == ERROR_MORE_DATA )
    {
        // Allocate more memory.
        cbSize = FIELD_OFFSET(VOLUME_DISK_EXTENTS, Extents) + pExtents->NumberOfDiskExtents * sizeof(DISK_EXTENT);
        ::CoTaskMemFree(pExtents);
        pExtents = NULL;

        pExtents = (VOLUME_DISK_EXTENTS *) ::CoTaskMemAlloc(cbSize);
        // Check whether CoTaskMemAlloc returned an out-of-memory error.
        ::ZeroMemory(pExtents, cbSize);

        // Now the buffer should be big enough.
        ::DeviceIoControl(hVolume, IOCTL_VOLUME_GET_VOLUME_DISK_EXTENTS, NULL, 0, pExtents, cbSize, &cbSize, 0);
        // Check whether the IOCTL succeeded.
    }
    // Check for errors; note that the IOCTL can fail for a reason other than insufficient memory.

    // For each disk, mark it to be excluded in the Restore Option string.
    for (i = 0; i < pExtents->NumberOfDiskExtents; i++)
    {
        pExtent = &pExtents->Extents[i];

        *wszDest = L'\0';
        StringCchPrintf(wszDest, MAX_PATH, L"\"ExcludeDisk\"=\"%d\", ", pExtent->DiskNumber); // check errors

        strRestoreOption.Append(wszDest);
        // Check for an out-of-memory error.
    }

    // Remove the trailing comma.
    strRestoreOption.TrimRight();
    strRestoreOption.UnTrailing(',');

    // Set the output parameter.
    strRestoreOption.Transfer( pstrExclusionList );

Exit:
    if( pExtents )
    {
        ::CoTaskMemFree(pExtents);
        pExtents = NULL;
    }

    if( hVolume != INVALID_HANDLE_VALUE )
    {
        ::CloseHandle(hVolume);
        hVolume = INVALID_HANDLE_VALUE;
    }

    return ( hr );
}

```



 

 
