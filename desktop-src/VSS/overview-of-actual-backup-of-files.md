---
description: VSS позволяет инициатору запроса получить доступ к теневой копии томов, содержащих данные для резервного копирования, и копировать их на носитель резервной копии.
ms.assetid: 187f26f2-f191-4703-9bde-3357f1ceef0c
title: Общие сведения о фактическом резервном копировании файлов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 98a504ff5a41725e33a2eb27792a3c6c89d00276
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105692903"
---
# <a name="overview-of-actual-backup-of-files"></a>Общие сведения о фактическом резервном копировании файлов

VSS позволяет инициатору запроса получить доступ к теневой копии томов, содержащих данные для резервного копирования, и копировать их на носитель резервной копии. В ходе этого процесса модули записи обычно продолжают работать нормально. Дополнительные сведения см. в разделе Общие сведения об [обработке резервной копии в VSS](overview-of-processing-a-backup-under-vss.md).

В следующей таблице показана последовательность действий и событий, необходимых для резервного копирования файлов.



<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Действие запросившего</th>
<th>Событие</th>
<th>Действие записи</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Доступ к файлам на тенев скопированном томе (см <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getsnapshotproperties"><strong>. раздел ивссбаккупкомпонентс:: жетснапшотпропертиес</strong></a>, <a href="/windows/desktop/api/Vss/ns-vss-vss_snapshot_prop"><strong>VSS_SNAPSHOT_PROP</strong></a>)</td>
<td>Нет</td>
<td>Нет</td>
</tr>
<tr class="even">
<td>Создайте список файлов для резервного копирования и скопируйте данные файлов на носитель резервной копии.</td>
<td>Нет</td>
<td>Нет</td>
</tr>
<tr class="odd">
<td>Укажите успешность или сбой резервного копирования с помощью <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded"><strong>ивссбаккупкомпонентс:: сетбаккупсукцеедед</strong></a>.</td>
<td>Нет</td>
<td>Нет</td>
</tr>
<tr class="even">
<td>Инициатор запроса указывает, что резервное копирование завершено путем вызова <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete"><strong>ивссбаккупкомпонентс:: баккупкомплете</strong></a>.</td>
<td><a href="vssgloss-b.md"><em>баккупкомплете</em></a></td>
<td>Выполните очистку после резервного копирования (см. раздел <a href="/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onbackupcomplete"><strong>квссвритер:: онбаккупкомплете</strong></a>, <a href="/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents"><strong>ивссвритеркомпонентс</strong></a>, <a href="/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent"><strong>ивсскомпонент</strong></a>).</td>
</tr>
<tr class="odd">
<td>Инициатор запроса ждет, пока все модули записи заподтверждают получение события <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete"><strong>ивссбаккупкомпонентс:: баккупкомплете</strong></a> с помощью <a href="/windows/desktop/api/Vss/nn-vss-ivssasync"><strong>ивссасинк</strong></a>. Он также должен проверить состояние модуля записи (см. раздел <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus"><strong>ивссбаккупкомпонентс:: гасервритерстатус</strong></a>, <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus"><strong>Ивссбаккупкомпонентс:: жетвритерстатус</strong></a>). Инициатор запроса должен вызвать <strong>гасервритерстатус</strong> в данный момент, чтобы сделать сеанс записи незавершенным.
<blockquote>
[!Note]<br />
Это необходимо только в Windows Server 2008 с пакетом обновления 2 (SP2) и более ранних версий.
</blockquote>
<br/></td>
<td>Нет</td>
<td>Нет</td>
</tr>
<tr class="even">
<td>Сохраните документ компонентов резервного копирования и каждый документ метаданных модуля записи в XML-документы, которые можно записать на носитель резервной копии (см. <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-saveasxml"><strong>ивссбаккупкомпонентс:: савеасксмл</strong></a> and <a href="/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-saveasxml"><strong>Ивссексаминевритерметадата:: савеасксмл</strong></a>).</td>
<td>Нет</td>
<td>Нет</td>
</tr>
</tbody>
</table>



 

## <a name="writer-actions-during-backup-of-files"></a>Действия модуля записи во время резервного копирования файлов

После завершения теневой копии все операции ввода-вывода в системе, для которой создается резервная копия, должны быть доступны для возобновления без нарушения целостности резервной копии. Это одна из основных причин для использования функции теневого копирования.

Таким образом, как и на этапе обнаружения (см. [Обзор этапа обнаружения резервного копирования](overview-of-the-backup-discovery-phase.md)), при создании резервных копий файлов на самом деле помещаются незначительные требования.

После завершения резервного копирования и запроса, создавшего событие [*баккупкомплете*](vssgloss-b.md) , VSS вызывает метод [**Квссвритер:: онбаккупкомплете**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onbackupcomplete) средства записи, виртуальный метод, который по умолчанию просто возвращает **значение true**. Однако модули записи могут переопределить реализацию по умолчанию и предпринять такие действия, как удаление оставшихся временных файлов, или использовать интерфейс [**ивссвритеркомпонентс**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents) , который вызывается вместе с для проверки состояния резервной копии каждого из [*включенных явно*](vssgloss-e.md) компонентов (и любого [*набора компонентов*](vssgloss-c.md) , которые они могут определить) путем получения соответствующего объекта [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) . Затем модуль записи может определить успешность или сбой резервного копирования, вызвав [**ивсскомпонент: жетбаккупсукцеедед**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupsucceeded). Значение, возвращаемое функцией **ивсскомпонент: жетбаккупсукцеедед** , будет иметь значение **true** , только если все явно включенные файлы в компоненте и все [*неявные включения*](vssgloss-i.md) всех его [*компонентов*](vssgloss-s.md) были успешно созданы.

Когда вызов [**квссвритер:: онбаккупкомплете**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onbackupcomplete) завершится, инициатор запроса должен вызвать [**Ивссбаккупкомпонентс:: гасервритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) и [**ивссбаккупкомпонентс:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) (для каждого модуля записи) один раз в последнее время. Память состояния сеанса модуля записи — это ограниченный ресурс, и модули записи должны в конечном итоге повторно использовать состояния сеанса. Этот шаг помечает состояние сеанса резервного копирования модуля записи как завершенное и уведомляет VSS о том, что этот слот сеанса резервного копирования может быть повторно использован последующей операцией резервного копирования.

## <a name="requester-actions-during-backup-of-files"></a>Действия запросившего во время резервного копирования файлов

Как указано в разделе [Общие сведения об этапе обнаружения резервных копий](overview-of-the-backup-discovery-phase.md), не следует создавать фактический список файлов для резервного копирования до завершения теневой копии.

[*Объект устройства*](vssgloss-d.md) , соответствующий теневой копии заданного тома, используется для получения доступа к файлам на тенев скопированном томе после завершения теневой копии. Объект устройства получается из объекта [**\_ \_ prop снимка VSS**](/windows/desktop/api/Vss/ns-vss-vss_snapshot_prop) , возвращенного [**ивссбаккупкомпонентс:: жетснапшотпропертиес**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getsnapshotproperties). Каждая теневая копия набора теневых копий будет иметь собственный объект устройства.

Затем для выбора файлов для резервного копирования используются объект устройства и пути, полученные из спецификации документа метаданных модуля записи. Дополнительные сведения см. [в разделе доступ инициатора запросов к теневым скопированным данным](requestor-access-to-shadow-copied-data.md) .

Файлы, включаемые в список резервных копий, зависят от природы конкретной резервной копии, от [*выбора компонентов для резервного копирования*](vssgloss-s.md)и структуры записи (см. раздел [Работа с выборкой для резервного копирования](working-with-selectability-for-backup.md)).

Помимо файлов, указанных в компонентах, данный модуль записи может также иметь явно исключенные файлы. Исключение файлов всегда следует учитывать независимо от того, какие компоненты выбраны.

Кроме того, как указано в [обзоре этапа обнаружения резервного копирования](overview-of-the-backup-discovery-phase.md), подключенная папка или точка повторного анализа могут быть отображены в теневой копии и могут быть архивированы. Однако не удается просмотреть подключенную папку или точку повторного анализа на томе, скопированном с помощью теневого копирования (см. раздел [Работа с подключенными папками и точки повторного анализа](working-with-reparse-and-mount-points.md)).

Во время операции резервного копирования следует также соблюдать осторожность, если [*альтернативный путь*](vssgloss-a.md) , возвращенный [**Ивссвмфиледеск:: жеталтернателокатион**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) , не является пустым. Альтернативный путь отличается от [*сопоставления альтернативного расположения*](vssgloss-a.md) тем, что он используется только во время резервного копирования, а сопоставление альтернативного расположения используется только во время восстановления.

В этом случае данные не должны архивироваться из их нормального расположения (обозначено [**ивссвмфиледеск::**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getpath)ивссвмфиледеск), но из расположения, возвращенного в [**жеталтернателокатион**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation). При восстановлении файл возвращается в обычное расположение. Дополнительные сведения см. в разделе [расположения резервного копирования и восстановления не по умолчанию](non-default-backup-and-restore-locations.md) .

Служба VSS не накладывает никаких ограничений на фактический механизм резервного копирования данных на носитель или выбранный носитель. Однако рекомендуется обрабатывать файлы каждого компонента каждого [*экземпляра модуля записи*](vssgloss-w.md) как единое целое. См. раздел [Создание резервного набора данных](generating-a-backup-set.md) для обсуждения рекомендаций по созданию списка файлов резервных копий.

Успешное или неуспешное выполнение резервного копирования любого файла, управляемого заданным компонентом, и (если он определяет [*набор компонентов*](vssgloss-c.md)) его [*подкомпоненты*](vssgloss-s.md) для данного экземпляра модуля записи должны быть сохранены в документе компонента резервного копирования путем вызова [**ивссбаккупкомпонентс:: сетбаккупсукцеедед**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded). Если какой-либо файл, управляемый компонентом или набором компонентов, не может выполнить резервное копирование, происходит сбой всего компонента. Точные сведения о том, какой файл не удалось архивировать, всегда следует записывать в журнал.

Разработчикам может оказаться полезным хранить записи на резервных носителях, для которых архивируются файлы, компоненты и набор компонентов, в которых они были членами, их спецификации и исходные пути. Также может быть полезно хранить такие сведения, как определение компонента каждого модуля записи. Это может упростить операцию извлечения. Однако эти сведения оставлены разработчику инициатора запроса.

Поскольку модули записи могут изменять документ резервных компонентов при обработке события [**моментального снимка**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) , созданного вызовом [**Ивссбаккупкомпонентс::D Оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), документ резервного копирования не следует сохранять до тех пор, пока не завершится этот асинхронный вызов.

Несмотря на то, что он может выполняться раньше, это удобное время для сохранения документа метаданных модуля записи.

Очень важно, чтобы и документ компонентов резервного копирования, и документы метаданных модуля записи сохранялись с помощью [**ивссбаккупкомпонентс:: савеасксмл**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-saveasxml) и [**Ивссексаминевритерметадата:: савеасксмл**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-saveasxml). Если это не так, использование VSS во время восстановления файлов будет невозможно.

Помимо хранения исходных метаданных, некоторые приложения резервного копирования могут оказаться полезными для сохранения копии собственного списка файлов (в их оптимизированном формате), а также связанных с ними модулей записи, компонента, процедуры восстановления и сведений о расположении — на носителе резервной копии для последующего извлечения. Такой список можно использовать, чтобы избежать некоторых синтаксических анализов и сравнений документов метаданных модуля записи и документов компонента резервного копирования во время восстановления.

Тома, для которых выполняется резервное копирование, могут содержать данные, не управляемые модулями записи VSS. Эти данные могут и должны быть созданы из теневой копии тома, где они будут находиться в [*состоянии*](vssgloss-c.md)отказоустойчивости. Дополнительные сведения см. в статье [резервное копирование без участия в записи](backups-without-writer-participation.md) .

 

 




