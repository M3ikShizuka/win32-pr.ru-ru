---
description: Задачи, выполняемые перед резервным копированием в VSS, посвящены созданию теневой копии томов, содержащих данные для резервного копирования.
ms.assetid: e6b082af-719b-4426-8217-0fc940f5884d
title: Общие сведения о задачах, выполняемых перед резервным копированием
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: af8dd6ea99215d486b8be7d07d30bcbdb5258548078fd642028dd6a93ca42796
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119511744"
---
# <a name="overview-of-pre-backup-tasks"></a>Общие сведения о задачах, выполняемых перед резервным копированием

Задачи, выполняемые перед резервным копированием в VSS, посвящены созданию теневой копии томов, содержащих данные для резервного копирования. Приложение резервного копирования сохранит данные из теневой копии, а не из фактического тома. Дополнительные сведения см. в разделе Общие сведения об [обработке резервной копии в VSS](overview-of-processing-a-backup-under-vss.md).

Инициаторы запроса обычно ожидают подготовки модулей записи к резервному копированию и созданию теневой копии. Модуль записи должен определить, следует ли принимать участие в резервной копии, и, если это так, настроить свои файлы и обеспечить готовность к архивации и теневому копированию. В следующей таблице показана последовательность действий и событий, необходимых для подготовки к операции резервного копирования.



| Действие запросившего                                                                                                                                                                                                                                                                                                            | Событие                                                                      | Действие записи                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Инициатор запроса может задать параметры резервного копирования (см [**. раздел ивссбаккупкомпонентс:: сетбаккупоптионс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions)).                                                                                                                                                                                          | Нет                                                                       | Нет                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Поддержка добавочных и разностных операций резервного копирования путем проверки любых сохраненных меток резервного копирования (см [**. раздел ивсскомпонент:: жетбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp), [**Ивссбаккупкомпонентс:: сетпревиаусбаккупстамп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp)).                                               | Нет                                                                       | Нет                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Уведомлять составителей подготовиться к операции резервного копирования с помощью [ **ивссбаккупкомпонентс::P репарефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)                                                                                                                                                                              | [*PrepareForBackup*](vssgloss-p.md)  | Подготовительная Подготовка модуля записи включает определение того, следует ли выполнять резервное копирование файлов, может быть, когда модуль записи участвует в закрепление теневой копии, а также создает метаданные для конкретного модуля записи (см. раздел [**квссвритер:: онпрепаребаккуп**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup), [**Квссвритер:: испасаффектед**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected), [**ивссвритеркомпонентс**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents), [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent), [**IVssComponent:: GetBackupOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupoptions), [**CVssWriter:: AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected), [**IVssComponent:: SetBackupMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupmetadata)и [**IVssComponent:: GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp). |
| Инициатор запроса ожидает настройки модулей записи для резервного копирования с помощью [**ивссасинк**](/windows/desktop/api/Vss/nn-vss-ivssasync). Он также должен проверить состояние модуля записи (см [**. раздел ивссбаккупкомпонентс:: гасервритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**Ивссбаккупкомпонентс:: жетвритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)).     | Нет                                                                       | Нет                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Инициатор запроса запрашивает теневую копию с помощью [ **ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)                                                                                                                                                                                                    | Нет                                                                       | Нет                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Нет                                                                                                                                                                                                                                                                                                                        | [*препарефорснапшот*](vssgloss-p.md) | [**Квссвритер:: онпрепареснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot): перевод модуля записи в состояние готовности к теневому копированию.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| Нет                                                                                                                                                                                                                                                                                                                        | [*Freeze*](vssgloss-f.md)                      | [**Квссвритер:: onfreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze): Окончательная настройка перед теневой копией.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| Нет                                                                                                                                                                                                                                                                                                                        | [*Постепенно*](vssgloss-t.md)                          | [**Квссвритер:: размораживание**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw): нормальная работа (включая ввод-вывод) может быть возобновлена.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Нет                                                                                                                                                                                                                                                                                                                        | [*Моментальный снимок*](vssgloss-p.md)          | [**Квссвритер:: онпостснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot): окончательная очистка процедур подготовки к теневому копированию. См. раздел [**ивсскомпонент:: адддифференцедфилесбиластмодифитиме**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) and [**Ивсскомпонент:: сетбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| Инициатор запроса ожидает завершения теневого копирования с помощью: [**ивссасинк**](/windows/desktop/api/Vss/nn-vss-ivssasync), он также должен проверить состояние модуля записи (см [**. Ивссбаккупкомпонентс:: гасервритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**ивссбаккупкомпонентс:: жетвритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)<br/> | Нет                                                                       | Нет                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |



 

## <a name="requester-pre-backup-tasks"></a>Задачи, выполняемые перед резервным копированием запросившего

Кроме того, перед созданием события [**ивссбаккупкомпонентс::P репарефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) инициатор запроса может также установить параметры резервного копирования для отдельных модулей записи с помощью [**Ивссбаккупкомпонентс:: сетбаккупоптионс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions) в зависимости от особенностей каждого модуля записи и от того, знает ли инициатор запроса.

Для поддержки добавочных и разностных операций инициаторы запроса могут на этом этапе проверить компоненты на наличие меток времени для предыдущей операции резервного копирования (с помощью [**ивсскомпонент:: жетбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp)) и использовать эти сведения для установки предыдущей метки времени для процесса записи (с помощью [**Ивссбаккупкомпонентс:: сетпревиаусбаккупстамп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp)). Дополнительные сведения см. в статье [добавочные и разностные резервные копии](incremental-and-differential-backups.md) .

Инициатор запроса теперь может направлять системные модули записи для завершения подготовительной подготовки и обработки создания теневой копии.

Во-первых, инициатор запроса создает событие [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , вызывая [**Ивссбаккупкомпонентс::P репарефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup).

После того как все записи, участвующие в участии, возвращали обработку события [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) (которое определяется инициатором запроса с помощью экземпляра интерфейса [**ивссасинк**](/windows/desktop/api/Vss/nn-vss-ivssasync) , возвращенного **PrepareForBackup**), инициатор запроса может инициировать теневую копию путем вызова [**ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), который, по мере выполнения, создаст события [*препарефорснапшот*](vssgloss-p.md), [*Freeze*](vssgloss-f.md), [*разморозить*](vssgloss-t.md)и [*моментального снимка*](vssgloss-p.md) для обработки.

В некоторых случаях инициатору может не потребоваться создавать теневую копию. В частности, каждый [*набор файлов*](vssgloss-f.md) , управляемых одним из компонентов конкретного модуля записи, имеет файловую маску резервной копии (обозначенную побитовой или из значений [**\_ \_ \_ \_ типа резервной копии спецификации файла VSS**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type) ), заданную во время события [*Identify*](vssgloss-i.md) . Эта маска определяет, помимо прочего, необходимость теневого копирования системы перед выполнением резервного копирования.

Если для резервного копирования наборов файлов на томах требуется теневая копия, то [**ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) не нужно вызывать.

## <a name="writer-pre-backup-tasks"></a>Задачи, выполняемые перед резервным копированием модуля записи

При обработке события [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) служба VSS вызывает метод [**Квссвритер:: онпрепаребаккуп**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) средства записи, виртуальный метод, который по умолчанию просто возвращает значение true.

Модули записи могут переопределить эту реализацию по умолчанию и использовать обработку, чтобы найти сведения о предстоящем резервном копировании и принять меры.

Модуль записи может определить сведения о ходе операции резервного копирования, связанные с шаблоном, с помощью следующих методов.

1.  [**Квссвритер:: Жетбаккуптипе**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-getbackuptype)
2.  [**Квссвритер:: Исбутаблестатебаккедуп**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-isbootablesystemstatebackedup)
3.  [**Квссвритер:: Арекомпонентсселектед**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected)

Модуль записи определяет, будут ли файлы, которыми он управляет, участвовать в теневой копии с помощью [**квссвритер:: испасаффектед**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected).

Более важно, когда VSS вызывает метод [**квссвритер:: онпрепаребаккуп**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) , он передает экземпляр интерфейса [**ивссвритеркомпонентс**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents) , который обеспечивает прямой доступ через интерфейс [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) к соответствующим компонентам, [*явным образом включаемым*](vssgloss-e.md) в документ компонентов резервного копирования инициатора запроса. Модуль записи использовал экземпляры интерфейса **ивсскомпонент** , определяющие наборы компонентов для получения доступа к его *неявно включаемому* компоненту (см. раздел [Выбор и работа со свойствами компонента](selectability-and-working-with-component-properties.md)).

Во время обработки события [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) модули записи используют интерфейс [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) для выполнения операций по компонентам (или по набору компонентов), в том числе:

1.  Добавление [*частичных файлов*](vssgloss-p.md) (если поддерживается) путем вызова [**Ивсскомпонент:: аддпартиалфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).
2.  Задание любых частных метаданных, которые модуль записи должен будет выполнять для восстановления.
3.  Если модуль записи поддерживает добавочные и разностные резервные копии (см. раздел [добавочное и разностное резервное копирование](incremental-and-differential-backups.md)), выполните следующие действия.
    -   Проверка на наличие предыдущих меток времени резервного копирования путем вызова [**ивсскомпонент:: жетпревиаусбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).
    -   Добавление необходимых [*файловых различий*](vssgloss-d.md) путем вызова [**Ивсскомпонент:: адддифференцедфилесбиластмодифитиме**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).
    -   Если модуль записи поддерживает схему **\_ \_ метки** времени "BS" VSS, добавляйте строки временной метки резервного копирования в собственном формате модуля записи с помощью [**ивсскомпонент:: сетбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).
4.  Инициация очень длительных асинхронных операций, таких как синхронизация данных на нескольких дисках. Это позволит модулю записи продолжать работу во время обработки операции, включая обработку других событий VSS. Эти операции должны завершаться до события [*Freeze*](vssgloss-f.md) .

Вызов [**ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) инициирует теневую копию и создает следующие события, которые должны быть обработаны разработчиками:

-   [*препарефорснапшот*](vssgloss-p.md)
-   [*Freeze*](vssgloss-f.md)
-   [*Постепенно*](vssgloss-t.md)
-   [*Моментальный снимок*](vssgloss-p.md)

Три обработчика модуля записи —[**квссвритер:: онпрепареснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot), [**квссвритер:: onfreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze)и [**квссвритер:: размораживание**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw)— чистые виртуальные методы, и каждый модуль записи должен реализовать их, а не использовать значения по умолчанию. В зависимости от потребностей модуля записи их можно закодировать как фиктивные методы, просто возвращая **значение true**.

Поскольку обычно промежуток времени между выдачей события [*Freeze*](vssgloss-f.md) и выдачей события [*разморозки*](vssgloss-t.md) , большая часть основной работы по подготовке к теневой копии, такой как завершение работы процессов, создание временных файлов или сток очередей ввода-вывода, будет обрабатываться в [**квссвритер:: онпрепареснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot).

Как модуль записи может использовать [**квссвритер:: онпрепареснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) для управления вводом-выводом, прежде чем создание теневой копии сильно зависит от собственной архитектуры модуля записи.

Все записи, которые могут позволить хранить все операции записи и сохранять данные в абсолютном состоянии перед [*закреплением*](vssgloss-f.md), должны сделать это.

Если модуль записи не может заморозить операции ввода-вывода, он должен принять действия по созданию стабильного источника для резервного копирования и уменьшению времени восстановления для теневой копии. Примерами могут служить очередь входящих запросов ввода-вывода или создание повторяющегося набора файлов в [*альтернативном пути*](vssgloss-a.md) , который будет использоваться в качестве источника резервной копии.

Метод [**квссвритер:: onfreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze) выполняет простые и короткие задачи, такие как проверка того, что [**Квссвритер:: онпрепареснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) Left I/O в правильном состоянии и что все асинхронные задачи, запускаемые [**квссвритер:: онпрепаребаккуп**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) завершены. Этот метод является последней возможностью модуля записи для запрета теневой копии в случае возникновения проблем (см. раздел [ошибки и запреты модуля записи](writer-errors-and-vetoes.md)).

Обычно средство записи может возобновить нормальную работу после события [*разморозки*](vssgloss-t.md) : теневая копия не будет немедленно готова к резервному копированию после разморозки, но модуль записи должен возобновить нормальную работу. Поэтому, как правило, [**квссвритер:: размораживание**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) используется модулями записи для возврата в состояние, предшествующее замораживанию. Однако все временные файлы, созданные для поддержки теневой копии, должны оставаться на месте до события [*моментального снимка*](vssgloss-p.md) . Как правило, для такого рода очистки следует использовать [**квссвритер:: онпостснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) . Так как многие приложения не нуждаются в такой очистке, **квссвритер:: онпостснапшот** является виртуальным методом с реализацией по умолчанию, который просто возвращает **значение true**. Если выполняется добавочная или разностная резервная копия, модуль записи может вызывать [**ивсскомпонент:: жетпревиаусбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp) и [**Ивсскомпонент:: сетбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp). Дополнительные сведения см. [в разделе роль модуля записи в резервном копировании сложных хранилищ](writer-role-in-backing-up-complex-stores.md). В данный момент можно вызвать еще один метод — [**ивсскомпонент:: адддифференцедфилесбиластмодифитиме**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).

 

 




