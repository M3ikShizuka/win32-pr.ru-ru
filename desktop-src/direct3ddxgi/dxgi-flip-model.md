---
description: Windows 8 добавлена поддержка отражения модели представления и связанной с ней статистики в DXGI 1,2.
ms.assetid: E132DAF5-80B7-4C52-A760-3779CC140CE7
title: Модель перелистывания DXGI
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 04b4b4cf8f792a23d4d32e5cb4b4273594745283cb803a638ea3d0cf4c45977f
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118289459"
---
# <a name="dxgi-flip-model"></a>Модель перелистывания DXGI

Windows 8 добавлена поддержка отражения модели представления и связанной с ней статистики в DXGI 1,2. модель зеркального отображения в режиме DXGI для Windows 8 не отличается от модели Windows 7 с [режимом отражения Direct3D 9EX](../direct3darticles/direct3d-9ex-improvements.md). Приложения для показа видеоматериалов или частоты кадров, такие как игры, могут использовать больше преимуществ с помощью функции "отразить презентацию". Приложения, использующие DXGI, переворачивают модель представления, уменьшают нагрузку на системные ресурсы и увеличивают производительность. Приложения также могут использовать существующие улучшения статистики с функцией эргономичного представления, чтобы лучше управлять скоростью презентации, предоставляя механизмы обратной связи и исправления в режиме реального времени.

-   [Сравнение модели перелистывания DXGI и модели BitBlt](#comparing-the-dxgi-flip-model-and-the-bitblt-model)
-   [Использование модели перелистывания DXGI](#how-to-use-dxgi-flip-model)
-   [Синхронизация кадров для приложений модели перелистывания DXGI](#frame-synchronization-of-dxgi-flip-model-apps)
-   [Предотвращение, обнаружение и восстановление после сбоев](#avoiding-detecting-and-recovering-from-glitches)
-   [Связанные темы](#related-topics)

## <a name="comparing-the-dxgi-flip-model-and-the-bitblt-model"></a>Сравнение модели перелистывания DXGI и модели BitBlt

Среда выполнения использует побитовую пересылку (BitBlt) и переворачивает модели представления, чтобы представить графическое содержимое на мониторах отображения. крупнейшим различием между bitblt и отражением моделей представления является то, как содержимое буфера обмена получается в Windows 8 DWM для компоновки. В модели BitBlt содержимое заднего буфера копируется в поверхность перенаправления при каждом вызове [**IDXGISwapChain1::P resent1**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgiswapchain1-present1). В модели перелистывания все задние буферы совместно используются диспетчер окон рабочего стола (DWM). Таким образом, DWM может составляться непосредственно из этих задних буферов без каких бы то ни было дополнительных операций копирования. Как правило, модель перелистывания более эффективна. Модель перелистывания также предоставляет больше функций, таких как улучшенная статистика.

если у вас есть устаревшие компоненты, использующие Windows интерфейс графических устройств (GDI) для записи в [**HWND**](../winprog/windows-data-types.md) напрямую, используйте модель bitblt.

Повышение производительности модели перелистывания DXGI имеет большое значение, если приложение находится в оконном режиме. Последовательность в этой таблице и иллюстрация Сравнение использования пропускной способности памяти и операций чтения и записи в оконных приложениях, в которых выбирается отразить модель относительно модели BitBlt.



| Шаг | Модель BitBlt, представленная в DWM                                                                               | Модель перелистывания DXGI, представленная в DWM                                   |
|------|-----------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|
| 1.   | Приложение обновляет свой кадр (запись)<br/>                                                              | Приложение обновляет свой кадр (запись)<br/>                     |
| 2.   | Среда выполнения Direct3D копирует содержимое поверхности в поверхность перенаправления DWM (чтение, запись)<br/>            | Среда выполнения Direct3D передает поверхность приложения в DWM<br/>        |
| 3.   | После завершения копирования в общей области DWM отображает поверхность приложения на экране (чтение, запись).<br/> | DWM отображает поверхность приложения на экране (чтение, запись)<br/> |



 

![Иллюстрация сравнения модели БЛТ и модели перелистывания](images/blt-flip-mode-present.png)

Модель отражения уменьшает использование системной памяти за счет сокращения числа операций чтения и записи средой выполнения Direct3D для композиции оконных кадров с помощью DWM.

## <a name="how-to-use-dxgi-flip-model"></a>Использование модели перелистывания DXGI

приложения Direct3D 11,1, предназначенные для Windows 8, используют модель перелистывания путем создания цепочки буферов с [**\_ \_ \_ перелистыванием \_ последовательного**](/windows/desktop/api/DXGI/ne-dxgi-dxgi_swap_effect) значения перечисления, заданным в элементе **SwapEffect** в структуре [**\_ \_ \_ DESC1 в цепочке**](/windows/desktop/api/DXGI1_2/ns-dxgi1_2-dxgi_swap_chain_desc1) подкачки. При установке **SwapEffect** в **\_ действие переключить \_ эффекты \_ \_ переключения DXGI** также установите для этих элементов **\_ цепочки подкачки DXGI \_ \_ DESC1** указанные значения:

-   **BufferCount** значение от 2 до 16, чтобы предотвратить снижение производительности в результате ожидания DWM для освобождения буфера представления.
-   **Форматирование** в \_ формате DXGI \_ R16G16B16A16 \_ float, \_ \_ B8G8R8A8 \_ UNORM или DXGI \_ \_ R8G8B8A8 \_ UNORM
-   Элемент **Count** [**\_ образца \_ DESC**](/windows/desktop/api/dxgicommon/ns-dxgicommon-dxgi_sample_desc) структуры, в котором элемент **сампледеск** указывает на один и элемент **Quality** **\_ примера \_ DESC** равным нулю, так как несколько примеров сглаживания (MSAA) не поддерживаются.

если в Windows 7 или более ранней версии операционной системы вы используете [**\_ \_ \_ \_ отразить эффекты переключения DXGI**](/windows/desktop/api/DXGI/ne-dxgi-dxgi_swap_effect) , то создание устройства завершается сбоем. При использовании модели перелистывания можно использовать полноэкранный режим отображения статистики в оконном режиме. Поведение в полноэкранном режиме не затрагивается. Если передать **значение NULL** параметру *пфуллскриндеск* [**IDXGIFactory2:: креатесвапчаинфорхвнд**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgifactory2-createswapchainforhwnd) для цепочки оконных буферов и задать для **SwapEffect** **\_ \_ эффекты переключения \_ \_ DXGI**, среда выполнения создает один лишний обратный буфер и поворачивает каждый из них в буфер, который превращается в передний буфер во время презентации.

При использовании модели перелистывания рассмотрите следующие советы.

-   Используйте одну цепочку перелистывания моделей для каждого [**HWND**](../winprog/windows-data-types.md). Не следует ориентироваться на несколько цепочек переключения моделей перелистывания в один и тот же **HWND**.
-   Не используйте цепочку перелистывания моделей с функцией [**скроллвиндов**](/windows/win32/api/winuser/nf-winuser-scrollwindow) или [**скроллвиндовекс**](/windows/win32/api/winuser/nf-winuser-scrollwindowex) GDI. Некоторые приложения Direct3D используют функции **скроллвиндов** и **скроллвиндовекс** GDI для обновления содержимого окна после возникновения события прокрутки пользователем. **Скроллвиндов** и **скроллвиндовекс** выполняют битблтс содержимое окна на экране при прокрутке окна пользователем. Эти функции также нуждаются в обновлениях модели BitBlt для содержимого GDI и Direct3D. Приложения, использующие какую-либо функцию, не обязательно будут отображать видимое содержимое окна при прокрутке экрана, когда приложение находится в оконном режиме. Не рекомендуется использовать функции **скроллвиндов** и **скроллвиндовекс** GDI, а вместо этого перерисовывать содержимое GDI и Direct3D на экране в ответ на прокрутку.
-   Используйте в [**HWND**](../winprog/windows-data-types.md) модель отражения, которая не предназначена для других API, включая модель представления DXGI BitBlt, другие версии Direct3D или GDI. Так как модель BitBlt поддерживает дополнительную копию поверхности, вы можете добавить GDI и другое содержимое Direct3D в тот же **HWND** с помощью поэтапного обновления из Direct3D и GDI. Если используется модель перелистывания, видимы только содержимое Direct3D в цепочках перелистывания моделей, которые среда выполнения передает в DWM. Среда выполнения игнорирует все остальные обновления содержимого BitBlt модели Direct3D или GDI.

## <a name="frame-synchronization-of-dxgi-flip-model-apps"></a>Синхронизация кадров для приложений модели перелистывания DXGI

Представленная статистика представляет собой сведения о времени кадров, которые используются приложениями мультимедиа для синхронизации видео-и звуковых потоков и восстановления после сбоев воспроизведения видео. Приложения могут использовать сведения о времени кадров в представленной статистике, чтобы настроить интенсивность представления видеокадров для более гладких презентаций. Чтобы получить данные статистики, вызовите метод [**идксгисвапчаин:: жетфраместатистикс**](/windows/desktop/api/DXGI/nf-dxgi-idxgiswapchain-getframestatistics) , чтобы получить структуру [**\_ \_ статистики кадра DXGI**](/windows/desktop/api/DXGI/ns-dxgi-dxgi_frame_statistics) . **DXGI \_ \_Статистика по кадрам** содержит статистику о вызовах [**IDXGISwapChain1::P resent1**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgiswapchain1-present1) . Цепочка перелистывания моделей предоставляет данные статистики как в оконном, так и в полноэкранном режиме. Для цепочек переключения моделей BitBlt в оконном режиме все **значения \_ \_ статистики кадров DXGI** являются нулями.

Для статистики, представленной в модели отражения, [**идксгисвапчаин:: жетфраместатистикс**](/windows/desktop/api/DXGI/nf-dxgi-idxgiswapchain-getframestatistics) возвращает несвязанную **\_ \_ \_ статистику кадра \_ ошибок DXGI** в следующих ситуациях:

-   Первый вызов [**жетфраместатистикс**](/windows/desktop/api/DXGI/nf-dxgi-idxgiswapchain-getframestatistics), который указывает начало последовательности
-   Изменение режима: в оконном режиме на весь экран или из полноэкранного режима до полноэкранных переходов

Значения в **пресентрефрешкаунт**, **синкрефрешкаунт** и **синккпктиме** , входящие в [**\_ \_ статистику кадра DXGI**](/windows/desktop/api/DXGI/ns-dxgi-dxgi_frame_statistics) , имеют следующие характеристики.

-   **Пресентрефрешкаунт** равно **синкрефрешкаунт** , когда приложение представлено на каждом вертикальной синхронизации.
-   **Синкрефрешкаунт** получается в интервале вертикальной синхронизации, когда предпринята передача, **синккпктиме** приблизительно соответствует времени, связанному с интервалом вертикальной синхронизации.

Метод [**идксгисвапчаин:: жетластпресенткаунт**](/windows/desktop/api/DXGI/nf-dxgi-idxgiswapchain-getlastpresentcount) возвращает последнее текущее количество, то есть текущий идентификатор последнего успешного вызова [**IDXGISwapChain1::P resent1**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgiswapchain1-present1) , сделанного устройством отображения, связанным с цепочкой буферов. Этот идентификатор является значением элемента **пресенткаунт** в структуре [**\_ \_ статистики кадра DXGI**](/windows/desktop/api/DXGI/ns-dxgi-dxgi_frame_statistics) . Для цепочек переключения модели BitBlt в оконном режиме все значения **\_ \_ статистики кадров DXGI** являются нулями.

## <a name="avoiding-detecting-and-recovering-from-glitches"></a>Предотвращение, обнаружение и восстановление после сбоев

Выполните следующие действия, чтобы избежать, обнаружить и восстановить данные о сбоях в кадре.

1.  Queue [**IDXGISwapChain1::P resent1**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgiswapchain1-present1) вызовы (то есть вызывают **IDXGISwapChain1::P resent1** несколько раз, что приводит к их сопоставлению в очереди).
2.  Создайте структуру представления очереди для хранения всех успешно отправленных [**IDXGISwapChain1::P resent1**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgiswapchain1-present1)(возвращенных [**Идксгисвапчаин:: жетластпресенткаунт**](/windows/desktop/api/DXGI/nf-dxgi-idxgiswapchain-getlastpresentcount)) и связанных, вычисляемых/ожидаемых **пресентрефрешкаунт** значений.
3.  Чтобы обнаружить сбой, выполните следующие действия.

    -   Вызовите [**идксгисвапчаин:: жетфраместатистикс**](/windows/desktop/api/DXGI/nf-dxgi-idxgiswapchain-getframestatistics).
    -   Для этого кадра получите текущий идентификатор (**пресенткаунт**) и число вертикальной синхронизации, где операционная система предвидит последний образ на мониторе (**пресентрефрешкаунт**).
    -   Получите ожидаемый **пресентрефрешкаунт** , связанный с текущим идентификатором и сохраненный ранее в структуре представления очереди.
    -   Если фактический **пресентрефрешкаунт** позже ожидаемого **пресентрефрешкаунт**, произошла ошибка.

4.  Чтобы устранить сбой, выполните следующие действия.

    -   Вычислите количество кадров, которые нужно пропустить для восстановления после сбоя. Например, если на шаге 3 показано, что ожидаемое число вертикальной синхронизации (**пресентрефрешкаунт**) для текущего идентификатора (**пресенткаунт**) равно 5, а фактическое число вертикальной синхронизации для текущего идентификатора равно 8, число кадров, которое нужно пропустить для восстановления после сбоя, равно трем кадрам.
    -   Передайте 0 в параметр *синЦинтервал* в этом количестве вызовов [**IDXGISwapChain1::P resent1**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgiswapchain1-present1) для удаления и пропуска этого числа кадров.

        > [!Note]  
        > Если сбой состоит из большого числа кадров, вызовите [**IDXGISwapChain1::P resent1**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgiswapchain1-present1) с параметром *flags* , установленным в [**DXGI \_ Present \_ restart**](dxgi-present.md) для удаления и пропуска всех невыполненных операций в очереди.

         

Ниже приведен пример сценария восстановления после сбоев в представлении кадров.

![Иллюстрация примера сценария восстановления после сбоев в представлении кадров](images/frame-sync-glitch-recover.png)

В примере сценария предполагается, что кадр а переходит на экран с числом вертикальной синхронизации, равным 1. Но на самом деле вы обнаружите число вертикальной синхронизации, которое кадр A отобразит на экране как 4. Поэтому вы определяете, что произошел сбой. Затем можно удалить 3 кадра, то есть можно передать значение 0 в параметр *синЦинтервал* в 3 вызовах [**IDXGISwapChain1::P resent1**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgiswapchain1-present1). В предыдущем примере сценария для восстановления после сбоя необходимо всего 8 **IDXGISwapChain1::P resent1ных** вызовов. Затем 9-й кадр отображается в соответствии с предполагаемым числом вертикальной синхронизации.

Ниже приведена временная шкала событий презентации. Каждая вертикальная линия представляет вертикальной синхронизации. Горизонтальное направление — время, которое увеличивается вправо. Чтобы представить, как могут возникать проблемы, можно использовать рисунок.

![Иллюстрация временной шкалы событий презентации](images/present-timeline.png)

Эта последовательность показана на рисунке.

1.  Приложение выводится из спящего режима на вертикальной синхронизации, отображает синий, вызывает [**IDXGISwapChain1::P resent1**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgiswapchain1-present1), а затем возвращается в спящий режим.
2.  Графический процессор (GPU) выходит из режима простоя, выполняет визуализацию синим цветом, а затем возвращается в спящий режим.
3.  DWM выходит из спящего режима в следующий вертикальной синхронизации, переводит синий в задний буфер, вызывает [**IDXGISwapChain1::P resent1**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgiswapchain1-present1), а затем возвращается в спящий режим.
4.  Приложение выходит из спящего режима, выводит зеленую сторону, вызывает [**IDXGISwapChain1::P resent1**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgiswapchain1-present1), а затем возвращается в спящий режим.
    > [!Note]  
    > Приложение выполняется параллельно, пока GPU выполняет композицию синего цвета.

     

5.  Затем GPU отображает зеленый цвет для приложения.
6.  Наконец, средство Digital to аналоговый Converter (DAC) отображает результаты композиции DWM на мониторе на следующем вертикальной синхронизации.

С временной шкалы можно представить задержку представления статистики и способ возникновения сбоев. Например, чтобы отобразить сбой DWM для зеленого цвета, отображаемого на экране, представьте расширяющее зеленое/красное поле таким образом, чтобы правая сторона зеленой/красной рамки совпадала с правой стороной фиолетового/красного прямоугольника. В этом сценарии DAC отображает два фрагмента синего, а затем зеленый кадр. Вы видите, что эта ошибка возникла при чтении текущей статистики.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Улучшение представления с помощью модели перелистывания, "грязных" прямоугольников и областей с прокруткой](dxgi-1-2-presentation-improvements.md)
</dt> </dl>

 

 
