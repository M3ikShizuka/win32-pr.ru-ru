---
title: Инициализация библиотеки COM
description: Инициализация библиотеки COM
ms.assetid: b044e146-8409-4f8d-87d3-52f21ebc2255
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0c1bc9536c186c2af3b604f7eb5666a6a31e7a845cf3b20f64a132119d16cb1e
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119979994"
---
# <a name="initializing-the-com-library"></a>Инициализация библиотеки COM

любая программа Windows, использующая COM, должна инициализировать библиотеку com, вызвав функцию [**CoInitializeEx**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializeex) . Каждый поток, использующий интерфейс COM, должен выполнять отдельный вызов этой функции. **CoInitializeEx** имеет следующую сигнатуру:


```C++
HRESULT CoInitializeEx(LPVOID pvReserved, DWORD dwCoInit);
```



Первый параметр зарезервирован и должен иметь **значение NULL**. Второй параметр указывает потоковую модель, которую будет использовать программа. Модель COM поддерживает две различные модели потоков, потоковое *и* *многопоточное* . При указании потоков подразделений выполняются следующие гарантии.

-   Вы будете обращаться к каждому COM-объекту из одного потока; указатели на COM-интерфейсы не будут совместно использоваться несколькими потоками.
-   Поток будет иметь цикл обработки сообщений. (См. [окно сообщения](window-messages.md) в модуле 1.)

Если какое-либо из этих ограничений не равно true, используйте многопоточность модели. Чтобы указать потоковую модель, установите один из следующих флагов в параметре *двкоинит* .



| Флаг                          | Описание         |
|-------------------------------|---------------------|
| **\_апартментсреадед** | Потоковое подразделение. |
| **Многопотоковая ИНИЦИАЛИЗАЦИя \_**     | Многопоточных.      |



 

Необходимо задать только один из этих флагов. Как правило, поток, создающий окно, должен использовать флаг **коinit \_ апартментсреадед** , а другие потоки должны использовать **\_ многопотоковую инициализацию**. Однако для некоторых COM-компонентов требуется конкретная потоковая модель. В документации MSDN следует сообщить, когда это так.

> [!Note]  
> На самом деле, даже при указании потоков подразделений все равно можно совместно использовать интерфейсы между потоками, используя метод, именуемый *упаковкой*. Упаковка выходит за рамки этого модуля. Важно отметить, что при работе с потоковыми апартаментами никогда не нужно просто копировать указатель интерфейса в другой поток. Дополнительные сведения о потоковых моделях COM см. в разделе [процессы, потоки и подразделения](/windows/desktop/com/processes--threads--and-apartments).

 

В дополнение к уже упомянутым флагам рекомендуется установить флаг **\_ \_ OLE1DDE Disabled** в параметре *двкоинит* . Установка этого флага позволяет избежать некоторых издержек, связанных с связыванием и внедрением объектов (OLE) 1,0, устаревшей технологией.

Вот как можно инициализировать COM для потоков подразделений:


```C++
HRESULT hr = CoInitializeEx(NULL, COINIT_APARTMENTTHREADED | COINIT_DISABLE_OLE1DDE);
```



Возвращаемый тип **HRESULT** содержит код ошибки или успешного выполнения. В следующем разделе мы рассмотрим обработку ошибок COM.

## <a name="uninitializing-the-com-library"></a>Отмена инициализации библиотеки COM

Для каждого успешного вызова [**CoInitializeEx**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializeex)необходимо вызвать [**CoUninitialize**](/windows/desktop/api/combaseapi/nf-combaseapi-couninitialize) перед выходом из потока. Эта функция не принимает параметров и не имеет возвращаемого значения.


```C++
CoUninitialize();
```



## <a name="next"></a>Следующая

[Коды ошибок в COM](error-codes-in-com.md)

 

 