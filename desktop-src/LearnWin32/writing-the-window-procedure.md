---
title: Написание процедуры окна
description: Написание процедуры окна
ms.assetid: f022bb88-6e4c-4ec4-9eef-f125ad92167e
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 853f5effe693e10ad0c5515e9d2ea87d200a1e7dd9b0c79da46228909e53deef
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119520464"
---
# <a name="writing-the-window-procedure"></a>Написание процедуры окна

Функция [**DispatchMessage**](/windows/desktop/api/winuser/nf-winuser-dispatchmessage) вызывает процедуру окна, которая является целью сообщения. Процедура окна имеет следующую сигнатуру.

```C++
LRESULT CALLBACK WindowProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam);
```

Существует четыре параметра:

- *HWND* — это дескриптор окна.
- *uiacp* — это код сообщения; Например, сообщение с [**\_ размером WM**](/windows/desktop/winmsg/wm-size) указывает, что размер окна был изменен.
- *wParam* и *lParam* содержат дополнительные данные, относящиеся к сообщению. Точное значение зависит от кода сообщения.

**LResult** — это целочисленное значение, которое программа возвращает в Windows. Он содержит ответ программы на определенное сообщение. Значение этого параметра зависит от кода сообщения. **Обратный вызов** — это соглашение о вызовах для функции.

Типичная процедура окна — это просто большой оператор switch, который переключается на код сообщения. Добавьте варианты для каждого сообщения, которое требуется обработать.

```C++
switch (uMsg)
{
    case WM_SIZE: // Handle window resizing

    // etc
}
```

Дополнительные данные для сообщения содержатся в параметрах *lParam* и *wParam* . Оба параметра — это целочисленные значения, размер которых равен ширине указателя (32 бит или 64 бит). Значение каждого из них зависит от кода сообщения (*uiacp*). Для каждого сообщения необходимо найти код сообщения в MSDN и привести параметры к правильному типу данных. Обычно данные представляют собой числовое значение или указатель на структуру. Некоторые сообщения не содержат данных.

Например, документация для сообщения о [**\_ размере WM**](/windows/desktop/winmsg/wm-size) сообщает, что:

- *wParam* — это флаг, указывающий, было ли окно сведено, развернуто или изменено его размер.
- *lParam* содержит новую ширину и высоту окна в виде 16-разрядных значений, упакованных в 1 32 или 64-разрядное число. Для получения этих значений необходимо выполнить некоторую побитовую смену. К счастью, файл заголовка Виндеф. h содержит вспомогательные макросы, которые делают это.

Типичная процедура окна обрабатывает десятки сообщений, поэтому она может увеличиваться довольно долго. Одним из способов сделать код более модульным является помещение логики обработки каждого сообщения в отдельную функцию. В окне процедуры приведите параметры *wParam* и *lParam* к правильному типу данных и передайте эти значения в функцию. Например, для обработки сообщения с [**\_ размером WM**](/windows/desktop/winmsg/wm-size) процедура окна будет выглядеть следующим образом:

```C++
LRESULT CALLBACK WindowProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam)
{
    switch (uMsg)
    {
    case WM_SIZE:
        {
            int width = LOWORD(lParam);  // Macro to get the low-order word.
            int height = HIWORD(lParam); // Macro to get the high-order word.

            // Respond to the message:
            OnSize(hwnd, (UINT)wParam, width, height);
        }
        break;
    }
}

void OnSize(HWND hwnd, UINT flag, int width, int height)
{
    // Handle resizing
}
```

Макросы [**ловорд**](/previous-versions/windows/desktop/legacy/ms632659(v=vs.85)) и [**HIWORD**](/previous-versions/windows/desktop/legacy/ms632657(v=vs.85)) получают 16-разрядные значения ширины и высоты из *lParam*. (Эти сведения можно найти в документации MSDN по каждому коду сообщения.) Процедура окна извлекает ширину и высоту, а затем передает эти значения в `OnSize` функцию.

## <a name="default-message-handling"></a>Обработка сообщений по умолчанию

Если вы не обрабатываете конкретное сообщение в процедуре окна, передайте параметры сообщения непосредственно в функцию [**дефвиндовпрок**](/windows/desktop/api/winuser/nf-winuser-defwindowproca) . Эта функция выполняет действие по умолчанию для сообщения, которое зависит от типа сообщения.

```C++
return DefWindowProc(hwnd, uMsg, wParam, lParam);
```

## <a name="avoiding-bottlenecks-in-your-window-procedure"></a>Предотвращение узких мест в процедуре окна

Во время выполнения процедуры окна она блокирует любые другие сообщения для Windows, созданные в том же потоке. Поэтому следует избегать длительной обработки внутри процедуры окна. Например, предположим, что программа открывает TCP-соединение и ожидает ответа сервера на неограниченное время. Если сделать это внутри процедуры окна, Пользовательский интерфейс не будет отвечать, пока запрос не завершится. В течение этого времени окно не может обрабатывать ввод, перерисовку или даже закрытие окна с помощью мыши или клавиатуры.

Вместо этого следует переместить работу в другой поток, используя один из многозадачных средств, встроенных в Windows:

- Создание нового потока.
- Использование пула потоков.
- Используйте асинхронные вызовы ввода-вывода.
- Используйте асинхронные вызовы процедур.

## <a name="next"></a>Следующая

[Рисование окна](painting-the-window.md)
