---
title: Моментальные снимки системы
description: Моментальные снимки являются основой функций справки средства. Моментальный снимок — это доступная только для чтения копия текущего состояния одного или нескольких следующих списков, расположенных в процессах, потоках, модулях и кучах системной памяти.
ms.assetid: a8122960-f078-4efb-8e01-bf6fb69ee0dd
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6ab6f9a45ad2e12eda53d3143e43c9234c20aae3
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "103890836"
---
# <a name="snapshots-of-the-system"></a>Моментальные снимки системы

Моментальные снимки являются основой функций справки средства. Моментальный снимок — это доступная только для чтения копия текущего состояния одного или нескольких следующих списков, расположенных в системной памяти: процессов, потоков, модулей и куч.

Процессы, использующие функции справки средства, обращаются к этим спискам из моментальных снимков, а не непосредственно из операционной системы. Списки в системной памяти изменяются при запуске и завершении процессов, создании и уничтожении потоков, при загрузке и выгрузке исполняемых модулей из системной памяти, а также при создании и уничтожении куч. Использование сведений из моментального снимка предотвращает несоответствия. В противном случае изменения в списке могут привести к неправильному просмотру списка или вызвать нарушение прав доступа (ошибка GP). Например, если приложение проходит по списку потоков во время создания или завершения других потоков, то сведения, используемые приложением для обхода списка потоков, могут стать устаревшими и могут вызвать ошибку при прохождении приложения в списке.

Чтобы создать снимок системной памяти, используйте функцию [**CreateToolhelp32Snapshot**](/windows/desktop/api/TlHelp32/nf-tlhelp32-createtoolhelp32snapshot) . Вы можете управлять содержимым моментального снимка, указав одно или несколько следующих значений при вызове этой функции:

-   **TH32CS \_ снафеаплист**
-   **TH32CS \_ снапмодуле**
-   **TH32CS \_ снаппроцесс**
-   **TH32CS \_ снапсреад**

Значения **TH32CS \_ Снафеаплист** и **TH32CS \_ снапмодуле** обрабатываются отдельно. Если эти значения заданы, то списки кучи и модулей указанного процесса включаются в моментальный снимок. Если в качестве идентификатора процесса указать нуль, используется текущий процесс. Значение **TH32CS \_ снапсреад** всегда создает моментальный снимок на уровне системы, даже если идентификатор процесса передается в [**CreateToolhelp32Snapshot**](/windows/desktop/api/TlHelp32/nf-tlhelp32-createtoolhelp32snapshot).

Чтобы перечислить кучу или состояние модуля для всех процессов, укажите значение **TH32CS \_ снапалл** и идентификатор процесса текущего процесса. Затем для каждого дополнительного процесса в моментальном снимке вызовите [**CreateToolhelp32Snapshot**](/windows/desktop/api/TlHelp32/nf-tlhelp32-createtoolhelp32snapshot) еще раз, указав идентификатор процесса и значение **TH32CS \_ снафеаплист** или **TH32CS \_ снапмодуле** .

Код расширенного состояния ошибки для [**CreateToolhelp32Snapshot**](/windows/desktop/api/TlHelp32/nf-tlhelp32-createtoolhelp32snapshot) можно получить с помощью функции [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror) .

Когда процесс завершит использование моментального снимка, удалите его с помощью функции [**CloseHandle**](/windows/desktop/api/handleapi/nf-handleapi-closehandle) . Если не уничтожить моментальный снимок, то процесс будет утечкой памяти до тех пор, пока он не завершит работу, после чего система освободит память.

> [!Note]  
> Обработчик моментальных снимков выступает в качестве маркера файла и подчиняется тем же правилам, что и для процессов и потоков, в которых он может использоваться. Чтобы указать, что маркер наследуется, Создайте моментальный снимок, используя значение **\_ inherit TH32CS** .

 

## <a name="related-topics"></a>См. также

<dl> <dt>

[Создание моментального снимка и Просмотр процессов](taking-a-snapshot-and-viewing-processes.md)
</dt> </dl>

 

 