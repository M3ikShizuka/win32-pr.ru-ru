---
description: Компоненты часто предназначены для выполнения задач инициализации при первом вызове, а не при их загрузке.
ms.assetid: 404c083c-7bee-44c2-b8e7-da1901b6ab2f
title: Инициализация One-Time
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 16f451e3c51716b4ff6f33b55d8d8602b5d5c28f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105664519"
---
# <a name="one-time-initialization"></a>Инициализация One-Time

Компоненты часто предназначены для выполнения задач инициализации при первом вызове, а не при их загрузке. Функции однократной инициализации гарантируют, что инициализация выполняется только один раз, даже если несколько потоков могут попытаться выполнить инициализацию.

**Windows Server 2003 и Windows XP:** Приложения должны предоставлять собственную синхронизацию для однократной инициализации с помощью [блокируемых функций](interlocked-variable-access.md) или другого механизма синхронизации. Функции однократной инициализации доступны начиная с Windows Vista и Windows Server 2008.

Функции однократной инициализации предоставляют значительные преимущества, чтобы гарантировать, что только один поток выполняет инициализацию:

-   Они оптимизированы для ускорения.
-   Они создают соответствующие барьеры на архитектуре процессора, которые им требуются.
-   Они поддерживают как блокировку, так и параллельную инициализацию.
-   Они позволяют избежать внутренней блокировки, чтобы код мог выполняться асинхронно или синхронно.

Система управляет процессом инициализации с помощью непрозрачной **инициализации \_ после** структуры, содержащей данные и сведения о состоянии. Вызывающий объект выделяет эту структуру и инициализирует ее путем вызова [**инитонцеинитиализе**](/windows/win32/api/synchapi/nf-synchapi-initonceinitialize) (для динамической инициализации структуры) или присваивания константной **инициализации \_ после \_ статической \_ инициализации** переменной структуры (для статической инициализации структуры). Изначально данные, хранящиеся в структуре одноразовой инициализации, имеют значение NULL и ее состояние не инициализировано.

Структуры однократной инициализации нельзя совместно использовать между процессами.

Поток, выполняющий инициализацию, может дополнительно задать контекст, доступный вызывающему объекту после завершения инициализации. Контекстом может быть объект синхронизации, который может быть значением или структурой данных. Если контекст является значением, его инициализация с низким порядком **\_ после \_ CTX \_ зарезервированных \_ битов** должна равняться нулю. Если контекст является структурой данных, структура данных должна быть выровняйтеся по **двойному значению**. Контекст возвращается вызывающему объекту в выходном параметре *lpContext* функции [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize) или [**InitOnceExecuteOnce**](/windows/win32/api/synchapi/nf-synchapi-initonceexecuteonce) .

Однократную инициализацию можно выполнять синхронно или асинхронно. Необязательная функция обратного вызова может использоваться для синхронной однократной инициализации.

## <a name="synchronous-one-time-initialization"></a>Синхронная однократная инициализация

Следующие шаги описывают синхронную однократную инициализацию, которая не использует функцию обратного вызова.

1.  Первый поток для вызова функции [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize) успешно запускает однократную инициализацию. Для синхронной однократной инициализации **InitOnceBeginInitialize** должен вызываться без флага **инициализации \_ \_ Async** .
2.  Последующие потоки, которые пытаются инициализировать инициализацию, блокируются до тех пор, пока первый поток не завершит инициализацию или не завершится ошибкой Если первый поток завершается ошибкой, следующий поток разрешается выполнить инициализацию и т. д.
3.  После завершения инициализации поток вызывает функцию [**InitOnceComplete**](/windows/win32/api/synchapi/nf-synchapi-initoncecomplete) . Поток может при необходимости создать объект синхронизации (или другие данные контекста) и указать его в параметре *lpContext* функции **InitOnceComplete** .
4.  Если инициализация завершилась с ошибкой, то состояние структуры одноразовой инициализации изменяется на инициализировано, а обработчик *lpContext* (если таковой имеется) хранится в структуре инициализации. Последующие попытки инициализации возвращают данные контекста. Если инициализация завершается неудачно, данные имеют **значение NULL**.

Следующие шаги описывают синхронную однократную инициализацию, которая использует функцию обратного вызова.

1.  Первый поток для успешного вызова функции [**InitOnceExecuteOnce**](/windows/win32/api/synchapi/nf-synchapi-initonceexecuteonce) передает указатель на определяемую приложением функцию обратного вызова [*инитонцекаллбакк*](/windows/win32/api/synchapi/nc-synchapi-pinit_once_fn) и любые данные, необходимые для функции обратного вызова. Если вызов выполняется, функция обратного вызова *инитонцекаллбакк* выполняется.
2.  Последующие потоки, которые пытаются инициализировать инициализацию, блокируются до тех пор, пока первый поток не завершит инициализацию или не завершится ошибкой Если первый поток завершается ошибкой, следующий поток разрешается выполнить инициализацию и т. д.
3.  После завершения инициализации функция обратного вызова возвращает значение. Функция обратного вызова может при необходимости создать объект синхронизации (или другие данные контекста) и указать его в выходном параметре *контекста* .
4.  Если инициализация завершилась с ошибкой, то состояние структуры одноразовой инициализации изменяется на инициализировано и обработчик *контекста* (если таковой имеется) хранится в структуре инициализации. Последующие попытки инициализации возвращают данные контекста. Если инициализация завершается неудачно, данные имеют **значение NULL**.

## <a name="asynchronous-one-time-initialization"></a>Асинхронная однократная инициализация

Следующие шаги описывают асинхронную однократную инициализацию.

1.  Если несколько потоков одновременно пытаются начать инициализацию, вызвав [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize) с параметром **init \_ Once \_**, функция будет выполнена для всех потоков, у которых для параметра *fPending* задано значение **true**. Только один поток на самом деле завершится с инициализацией; другие одновременные попытки не изменяют состояние инициализации.
2.  Когда [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize) возвращает, параметр *fPending* указывает состояние инициализации:
    -   Если *fPending* имеет **значение false**, то один поток был успешно инициализирован при инициализации. Другие потоки должны очистить все созданные ими контекстные данные и использовать данные контекста в выходном параметре *lpContext* объекта [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize).
    -   Если *fPending* имеет **значение true**, инициализация еще не завершена и другие потоки должны продолжить работу.
3.  Каждый поток вызывает функцию [**InitOnceComplete**](/windows/win32/api/synchapi/nf-synchapi-initoncecomplete) . Поток может при необходимости создать объект синхронизации (или другие данные контекста) и указать его в параметре *lpContext* объекта **InitOnceComplete**.
4.  Когда [**InitOnceComplete**](/windows/win32/api/synchapi/nf-synchapi-initoncecomplete) возвращает, его возвращаемое значение указывает, был ли вызывающий поток завершен при инициализации.
    -   Если [**InitOnceComplete**](/windows/win32/api/synchapi/nf-synchapi-initoncecomplete) завершается успешно, вызывающий поток успешно завершил инициализацию. Состояние структуры одноразовой инициализации изменяется на инициализировано, а обработчик *lpContext* (если таковой имеется) хранится в структуре инициализации.
    -   Если [**InitOnceComplete**](/windows/win32/api/synchapi/nf-synchapi-initoncecomplete) завершается сбоем, то другой поток был успешным при инициализации. Вызывающий поток должен очистить все созданные данные контекста и вызвать [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize) с **init \_ \_ \_ только один раз** , чтобы получить все данные контекста, хранящиеся в структуре одноразовой инициализации.

## <a name="calling-one-time-initialization-from-multiple-sites"></a>Вызов инициализации One-Time из нескольких сайтов

Однократная инициализация, защищенная одной структурой **init \_ Once** , может быть выполнена на сайтах несколько. разные обратные вызовы могут передаваться с каждого сайта, а синхронизация с ответом и без обратного вызова может быть смешанной. Инициализация все еще гуарантед для выполнения суцесфулли только один раз.

Однако асинхронная и синхронная инициализация не могут быть смешанными: после попытки асинхронной инициализации произойдет сбой при попытке запустить синхронную инициализацию.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Использование инициализации One-Time](using-one-time-initialization.md)
</dt> </dl>

 

 
