---
description: Асинхронный вызов процедур (APC) — это функция, которая выполняется асинхронно в контексте определенного потока.
ms.assetid: 0197d78e-a4dc-414b-88ba-c5ec5f2ed614
title: Асинхронные вызовы процедур
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: dd95e9afd663e2a462335b3c47bfe99462b449e7
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103999007"
---
# <a name="asynchronous-procedure-calls"></a>Асинхронные вызовы процедур

*Асинхронный вызов процедур* (APC) — это функция, которая выполняется асинхронно в контексте определенного потока. Когда компания APC помещается в очередь потока, система выдает программное прерывание. При следующем запланированном потоке будет запущена функция APC. Компания APC, созданная системой, называется *режимом ядра APC*. Компания APC, созданная приложением, называется *пользовательским режимом APC*. Поток должен находиться в состоянии оповещения для запуска в пользовательском режиме.

Каждый поток имеет собственную очередь APC. Приложение помещает в очередь APC в поток, вызывая функцию [**куеуеусерапк**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-queueuserapc) . Вызывающий поток задает адрес функции APC в вызове **куеуеусерапк**. Очередь APC является запросом потока на вызов функции APC.

При постановке в очередь пользовательского режима APC поток, в котором он находится в очереди, не направляется на вызов функции APC, если он не находится в состоянии оповещения. Поток входит в состояние оповещения при вызове функции [**слипекс**](/windows/win32/api/synchapi/nf-synchapi-sleepex), [**сигналобжектандваит**](/windows/win32/api/synchapi/nf-synchapi-signalobjectandwait), [**мсгваитформултиплеобжектсекс**](/windows/desktop/api/Winuser/nf-winuser-msgwaitformultipleobjectsex), [**ваитформултиплеобжектсекс**](/windows/win32/api/winuser/nf-winuser-msgwaitformultipleobjectsex)или [**WaitForSingleObjectEx**](/windows/win32/api/synchapi/nf-synchapi-waitforsingleobjectex) . Если ожидание достигнуто до постановки в очередь APC, поток больше не находится в состоянии ожидания с оповещением, поэтому функция APC не будет выполняться. Однако компания APC по-прежнему находится в очереди, поэтому функция APC будет выполняться, когда поток вызовет другую функцию ожидания с оповещением.

Функции [**реадфиликс**](/windows/win32/api/fileapi/nf-fileapi-readfileex), [**сетваитаблетимер**](/windows/win32/api/synchapi/nf-synchapi-setwaitabletimer), [**сетваитаблетимерекс**](/windows/win32/api/synchapi/nf-synchapi-setwaitabletimerex)и [**вритефиликс**](/windows/win32/api/fileapi/nf-fileapi-writefileex) реализуются с помощью APC в качестве механизма обратного вызова уведомлений о завершении.

При использовании [пула потоков](../procthread/thread-pools.md)Обратите внимание, что APC не работает, а также другие механизмы сигнализации, поскольку система управляет временем существования потоков пула потоков, поэтому поток может быть завершен до доставки уведомления. Вместо использования механизма сигнализации на основе APC, такого как параметр *Пфнкомплетионраутине* [**сетваитаблетимер**](/windows/win32/api/synchapi/nf-synchapi-setwaitabletimer) или [**сетваитаблетимерекс**](/windows/win32/api/synchapi/nf-synchapi-setwaitabletimerex), используйте ожидающий объект, например таймер, созданный с помощью [**креатесреадпултимер**](/windows/win32/api/threadpoolapiset/nf-threadpoolapiset-createthreadpooltimer). Для ввода-вывода используйте объект завершения ввода-вывода, созданный с помощью [**креатесреадпулио**](/windows/win32/api/threadpoolapiset/nf-threadpoolapiset-createthreadpoolio) , или *Хевент* структуру с [**перекрытием**](/windows/win32/api/minwinbase/ns-minwinbase-overlapped) , где событие может быть передано в функцию [**SetThreadpoolWait**](/windows/win32/api/threadpoolapiset/nf-threadpoolapiset-setthreadpoolwait) .

## <a name="synchronization-internals"></a>Внутренние компоненты синхронизации

При выдаче запроса ввода-вывода структура выделяется для представления запроса. Эта структура называется пакетом запросов ввода-вывода (IRP). При синхронном вводе-выводе поток создает IRP, отправляет его в стек устройств и ожидает завершения запроса IRP в ядре. При асинхронном вводе-выводе поток создает IRP и отправляет его в стек устройств. Стек может немедленно завершить IRP, или же он может вернуть состояние ожидания, указывающее на то, что запрос выполняется. В этом случае IRP по-прежнему связывается с потоком, поэтому он будет отменен, если поток завершится или вызовет функцию, например [**канцелио**](/windows/win32/api/ioapiset/nf-ioapiset-cancelio). Тем временем поток может продолжать выполнять другие задачи, пока стек устройств продолжает обрабатывать IRP.

Существует несколько способов, которые система может указать на завершение IRP:

-   Обновите перекрытый структуру с помощью результата операции, чтобы поток мог опросить, чтобы определить, завершена ли операция.
-   Сигнализирует о событии в структуре OVERLAPPED, чтобы поток мог синхронизироваться с событием и пробуждении по завершении операции.
-   Помещает IRP в очередь ожидающего потока APC, чтобы поток выполнит процедуру APC при входе в состояние ожидания с оповещением и возвращал из операции ожидания с состоянием, указывающим на то, что выполнялась одна или несколько подпрограмм APC.
-   Помещает IRP в очередь на порт завершения ввода-вывода, где он будет выполняться следующим потоком, ожидающим порт завершения.

Потоки, ожидающие передачи данных на порт завершения ввода-вывода, не ожидают состояния, доступного для оповещения. Таким образом, если эти потоки выдают запросы IRP, настроенные для завершения как APC в потоке, эти завершения IPC не будут выполняться своевременно. они будут выполняться только в том случае, если поток получает запрос от порта завершения ввода-вывода, а затем выводит предупреждение.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Использование ожидающего таймера с асинхронным вызовом процедуры](using-a-waitable-timer-with-an-asynchronous-procedure-call.md)
</dt> </dl>

 

 
