---
description: Шифрует сообщение для обеспечения конфиденциальности с помощью Kerberos.
ms.assetid: b9b6ca95-b986-4de7-bd28-994a5125ad05
title: Функция Енкриптмессаже (Kerberos)
ms.topic: reference
ms.date: 07/25/2019
ms.openlocfilehash: 89c6504fe8518e1c43d155ebce638dec1acfeb80
ms.sourcegitcommit: 9b5faa61c38b2d0c432b7f2dbee8c127b0e28a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/19/2021
ms.locfileid: "122476220"
---
# <a name="encryptmessage-kerberos-function"></a>Функция Енкриптмессаже (Kerberos)

Функция **енкриптмессаже (Kerberos)** шифрует сообщение для обеспечения [*конфиденциальности*](../secgloss/p-gly.md). **Енкриптмессаже (Kerberos)** позволяет приложению выбирать из [*алгоритмов шифрования*](../secgloss/c-gly.md) , поддерживаемых выбранным механизмом. Функция **енкриптмессаже (Kerberos)** использует [*контекст безопасности*](../secgloss/s-gly.md) , на который ссылается маркер контекста. Некоторые пакеты не имеют зашифрованных и не расшифрованных сообщений, а предоставляют [*хэш*](../secgloss/h-gly.md) целостности, который можно проверить.

> [!Note]  
> **Енкриптмессаже (Kerberos)** и [**декриптмессаже (Kerberos)**](decryptmessage--kerberos.md) могут вызываться одновременно из двух разных потоков в одном контексте SSPI, если [*один поток*](../secgloss/s-gly.md) шифруется, а другой расшифровывается. При шифровании нескольких потоков или при расшифровке более одного потока каждый поток должен получить уникальный контекст.

## <a name="syntax"></a>Синтаксис

```C++
SECURITY_STATUS SEC_Entry EncryptMessage(
  _In_    PCtxtHandle    phContext,
  _In_    ULONG          fQOP,
  _Inout_ PSecBufferDesc pMessage,
  _In_    ULONG          MessageSeqNo
);
```

## <a name="parameters"></a>Параметры

<dl> <dt>

*фконтекст* \[ окне\]
</dt> <dd>

Маркер [*контекста безопасности*](../secgloss/s-gly.md) , который будет использоваться для шифрования сообщения.

</dd> <dt>

*фкоп* \[ окне\]
</dt> <dd>

Зависящие от пакета флаги, указывающие качество защиты. [*Пакет безопасности*](../secgloss/s-gly.md) может использовать этот параметр, чтобы включить выбор [*алгоритмов шифрования*](../secgloss/c-gly.md).

Этот параметр может иметь следующий флаг.


| Значение | Значение | 
|-------|---------|
| <span id="SECQOP_WRAP_NO_ENCRYPT"></span><span id="secqop_wrap_no_encrypt"></span><dl><dt><strong>SECQOP_WRAP_NO_ENCRYPT</strong></dt></dl> | Создать заголовок или трейлер, но не шифровать сообщение.<br /><blockquote>[!Note]<br />KERB_WRAP_NO_ENCRYPT имеет то же значение и то же самое.</blockquote><br /> | 


</dd> <dt>

*пмессаже* \[ в, out\]
</dt> <dd>

Указатель на структуру [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc) . На входе структура ссылается на одну или несколько структур [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) , которые могут иметь тип данных pvbuffer \_ . Этот буфер содержит сообщение для шифрования. Сообщение шифруется на месте, перезаписывая исходное содержимое структуры.

Функция не обрабатывает буферы с \_ атрибутом pvbuffer ReadOnly.

Длина структуры [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) , содержащей сообщение, не должна превышать **кбмаксимуммессаже**, которая получена из функции [**QueryContextAttributes (Kerberos)**](querycontextattributes--kerberos.md) (SECPKG \_ attr \_ Streams \_ sizes).

Приложения, не использующие SSL, должны предоставить [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) типа pvbuffer \_ Padding.

</dd> <dt>

*Мессажесекно* \[ окне\]
</dt> <dd>

Порядковый номер, назначенный сообщению транспортным приложением. Если транспортное приложение не поддерживает порядковые номера, этот параметр должен быть равен нулю.

</dd> </dl>

## <a name="return-value"></a>Возвращаемое значение

Если функция завершается успешно, функция возвращает значение секунды \_ E \_ ОК.

Если функция завершается ошибкой, возвращается один из следующих кодов ошибок.

| Код возврата                                                                                                    | Описание                                                                                                                                                                                                                                   |
|----------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <dl> <dt>**\_ \_ \_ слишком \_ маленький буфер E с**</dt> </dl>      | Выходной буфер слишком мал. Дополнительные сведения см. в подразделе "Примечания".                                                                                                                                                                 |
| <dl> <dt>**с \_ \_ \_ истекшим сроком действия в контексте E**</dt> </dl>        | Приложение ссылается на контекст, который уже был закрыт. Правильно написанное приложение не должно получить эту ошибку.                                                                                               |
| <dl> <dt>**с \_ е \_ . \_ неправильная система шифрования E \_**</dt> </dl> | [*Шифр*](../secgloss/c-gly.md) , выбранный для [*контекста безопасности*](../secgloss/s-gly.md) , не поддерживается.                                                                                                         |
| <dl> <dt>**СЕК \_ . \_ недостаточный \_ объем памяти**</dt> </dl>    | Недостаточно доступной памяти для завершения запрошенного действия.                                                                                                                                                             |
| <dl> <dt>**c \_ E \_ Недопустимый \_ маркер**</dt> </dl>         | В параметре *фконтекст* указан недопустимый маркер контекста.                                                                                                                                                     |
| <dl> <dt>**в секунду \_ E \_ Недопустимый \_ токен**</dt> </dl>          | Не \_ найден буфер типа данных pvbuffer.                                                                                                                                                                                          |
| <dl> <dt>**с \_ е \_ КОП \_ не \_ поддерживается**</dt> </dl>     | [*Контекст безопасности*](../secgloss/s-gly.md)не поддерживает ни конфиденциальность, ни [*целостность*](../secgloss/i-gly.md) . |

## <a name="remarks"></a>Комментарии

Функция **енкриптмессаже (Kerberos)** шифрует сообщение на основе сообщения и [*ключа сеанса*](../secgloss/s-gly.md) из [*контекста безопасности*](../secgloss/s-gly.md).

Если приложение транспорта создало [*контекст безопасности*](../secgloss/s-gly.md) для поддержки обнаружения последовательности и вызывающий объект предоставляет порядковый номер, функция включает эти сведения в зашифрованное сообщение. Включение этой информации обеспечивает защиту от воспроизведения, вставки и подавления сообщений. [*Пакет безопасности*](../secgloss/s-gly.md) включает порядковый номер, переданный из транспортного приложения.

> [!Note]  
> Эти буферы должны быть представлены в указанном порядке.

| Тип буфера                           | Описание                                                                                                                    |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------------|
| \_ \_< заголовка потока pvbuffer  | Для внутреннего использования. Инициализация не требуется.                                                                       |
| \_данные pvbuffer            | Содержит зашифрованное сообщение в [*виде открытого текста*](../secgloss/s-gly.md) . |
| \_трейлер потока \_ pvbuffer | Для внутреннего использования. Инициализация не требуется.                                                                        |
| PVBUFFER \_ пусто           | Для внутреннего использования. Инициализация не требуется. Размер может быть равен нулю.                                                      |

Для оптимальной производительности структуры *пмессаже* должны выделяться из непрерывной памяти.

**Windows XP:** Эта функция также называлась **сеалмессаже**. Теперь приложения должны использовать только **енкриптмессаже (Kerberos)** .

## <a name="requirements"></a>Требования

| Требование | Значение |
|--------------------------|-------------------------------------------|
| Минимальная версия клиента | Windows \[Только классические приложения XP\]          |
| Минимальная версия сервера | Windows Только для \[ настольных приложений сервера 2003\] |
| Заголовок                   | SSPI. h (включая Security. h)               |
| Библиотека                  | Secur32. lib                               |
| DLL                      | Secur32.dll                               |

## <a name="see-also"></a>См. также

<dl> <dt>

[Функции SSPI](authentication-functions.md#sspi-functions)
</dt> <dt>

[**AcceptSecurityContext (Kerberos)**](acceptsecuritycontext--kerberos.md)
</dt> <dt>

[**Декриптмессаже (Kerberos)**](decryptmessage--kerberos.md)
</dt> <dt>

[**InitializeSecurityContext (Kerberos)**](initializesecuritycontext--kerberos.md)
</dt> <dt>

[**QueryContextAttributes (Kerberos)**](querycontextattributes--kerberos.md)
</dt> <dt>

[**Pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer)
</dt> <dt>

[**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc)
</dt> </dl>
