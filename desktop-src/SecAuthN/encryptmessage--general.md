---
description: Шифрует сообщение для обеспечения конфиденциальности.
ms.assetid: 2e09f262-9c3e-4db2-9285-017f5e1810c7
title: Функция Енкриптмессаже (General) (SSPI. h)
ms.topic: reference
ms.date: 07/25/2019
ms.openlocfilehash: 6645d58b753503853dae7998982a32221d1f0d14
ms.sourcegitcommit: 9b5faa61c38b2d0c432b7f2dbee8c127b0e28a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/19/2021
ms.locfileid: "122476290"
---
# <a name="encryptmessage-general-function"></a>Функция Енкриптмессаже (общая)

Функция **енкриптмессаже (общая)** шифрует сообщение для обеспечения [*конфиденциальности*](../secgloss/p-gly.md). **Енкриптмессаже (Общие)** позволяет приложению выбирать из [*алгоритмов шифрования*](../secgloss/c-gly.md) , поддерживаемых выбранным механизмом. Функция **енкриптмессаже (General)** использует [*контекст безопасности*](../secgloss/s-gly.md) , на который ссылается маркер контекста. Некоторые пакеты не имеют зашифрованных и не расшифрованных сообщений, а предоставляют [*хэш*](../secgloss/h-gly.md) целостности, который можно проверить.

При использовании [*поставщика службы поддержки*](../secgloss/s-gly.md) дайджеста безопасности эта функция доступна только в качестве механизма SASL.

При использовании поставщика общих служб SChannel эта функция шифрует сообщения с помощью [*ключа сеанса*](../secgloss/s-gly.md) , согласованного с удаленной стороной, которая получит сообщение. Алгоритм шифрования определяется используемым [комплектом [*шифров*](../secgloss/c-gly.md)]([*cipher*](../secgloss/c-gly.md)-suites-in-schannel.md) .

> [!Note]  
> **Енкриптмессаже (General)** и [**декриптмессаже (General)**](decryptmessage--general.md) могут вызываться одновременно из двух разных потоков в одном контексте SSPI, если [*один поток*](../secgloss/s-gly.md) шифруется, а другой расшифровывается. При шифровании нескольких потоков или при расшифровке более одного потока каждый поток должен получить уникальный контекст.

Сведения об использовании этой функции с конкретным поставщиком общих служб см. в следующих разделах.

| Раздел                                                            | Описание                                               |
|------------------------------------------------------------------|-----------------------------------------------------------|
| [**Енкриптмессаже (дайджест)**](encryptmessage--digest.md)       | Шифрует сообщение для обеспечения конфиденциальности с помощью дайджеста.    |
| [**Енкриптмессаже (Kerberos)**](encryptmessage--kerberos.md)   | Шифрует сообщение для обеспечения конфиденциальности с помощью Kerberos.  |
| [**Енкриптмессаже (согласование)**](encryptmessage--negotiate.md) | Шифрует сообщение для обеспечения конфиденциальности с помощью Negotiate. |
| [**Енкриптмессаже (NTLM)**](encryptmessage--ntlm.md)           | Шифрует сообщение для обеспечения конфиденциальности с помощью NTLM.      |
| [**Енкриптмессаже (Schannel)**](encryptmessage--schannel.md)   | Шифрует сообщение для обеспечения конфиденциальности с помощью канала Schannel.  |

## <a name="syntax"></a>Синтаксис

```C++
SECURITY_STATUS SEC_Entry EncryptMessage(
  _In_    PCtxtHandle    phContext,
  _In_    ULONG          fQOP,
  _Inout_ PSecBufferDesc pMessage,
  _In_    ULONG          MessageSeqNo
);
```
## <a name="parameters"></a>Параметры

*фконтекст* \[ окне\]

Маркер [*контекста безопасности*](../secgloss/s-gly.md) , который будет использоваться для шифрования сообщения.

*фкоп* \[ окне\]

Зависящие от пакета флаги, указывающие качество защиты. [*Пакет безопасности*](../secgloss/s-gly.md) может использовать этот параметр, чтобы включить выбор [*алгоритмов шифрования*](../secgloss/c-gly.md).

При использовании дайджест-поставщика общих служб этот параметр должен иметь значение 0.

Этот параметр может иметь один из следующих флагов.


| Значение | Значение | 
|-------|---------|
| <span id="SECQOP_WRAP_NO_ENCRYPT"></span><span id="secqop_wrap_no_encrypt"></span><dl><dt><strong>SECQOP_WRAP_NO_ENCRYPT</strong></dt></dl> | Создать заголовок или трейлер, но не шифровать сообщение.<br /><blockquote>[!Note]<br />KERB_WRAP_NO_ENCRYPT имеет то же значение и то же самое.</blockquote><br /> | 
| <span id="SECQOP_WRAP_OOB_DATA"></span><span id="secqop_wrap_oob_data"></span><dl><dt><strong>SECQOP_WRAP_OOB_DATA</strong></dt></dl> | Отправка сообщения с предупреждением SChannel. В этом случае параметр <em>пмессаже</em> должен содержать стандартный двухбайтовый код события SSL/TLS. Это значение поддерживается только поставщиком общих служб SChannel.<br /> | 


*пмессаже* \[ в, out\]

Указатель на структуру [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc) . На входе структура ссылается на одну или несколько структур [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) . Один из них может иметь тип данных PVBUFFER \_ . Этот буфер содержит сообщение для шифрования. Сообщение шифруется на месте, перезаписывая исходное содержимое структуры.

Функция не обрабатывает буферы с \_ атрибутом pvbuffer ReadOnly.

Длина структуры [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) , которая содержит сообщение, не должна превышать **кбмаксимуммессаже**, которая получена из функции [**QueryContextAttributes (Общие)**](querycontextattributes--general.md) (SECPKG \_ attr \_ Streams \_ sizes).

При использовании дайджест-поставщика общих служб \_ \_ \_ для хранения сведений о [*сигнатурах*](../secgloss/d-gly.md#_security_digital_signature_gly) должен быть второй буфер с типом заполнения pvbuffer или с данными буфера (в секунду). Чтобы получить размер выходного буфера, вызовите функцию [**QueryContextAttributes (General)**](querycontextattributes--general.md) и укажите \_ размеры SECPKG attr \_ . Функция вернет структуру [**\_ размеров секпкгконтекст**](/windows/win32/api/sspi/ns-sspi-secpkgcontext_sizes) . Размер выходного буфера равен сумме значений в элементах **кбмакссигнатуре** и **кбблокксизе** .

Приложения, не использующие SSL, должны предоставить [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) типа pvbuffer \_ Padding.

*Мессажесекно* \[ окне\]

Порядковый номер, назначенный сообщению транспортным приложением. Если транспортное приложение не поддерживает порядковые номера, этот параметр должен быть равен нулю.

При использовании дайджест-поставщика общих служб этот параметр должен иметь значение 0. Хэш-код дайджеста управляет нумерацией последовательности внутренним образом.

При использовании поставщика общих служб SChannel этот параметр должен иметь значение 0. Поставщик общих служб SChannel не использует порядковые номера.

</dd> </dl>

## <a name="return-value"></a>Возвращаемое значение

Если функция завершается успешно, функция возвращает значение секунды \_ E \_ ОК.

Если функция завершается ошибкой, возвращается один из следующих кодов ошибок.

| Код возврата                         | Описание                                                                                                                                                                 |
|-------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **\_ \_ \_ слишком \_ маленький буфер E с**      | Выходной буфер слишком мал. Дополнительные сведения см. в подразделе "Примечания".                                                                                                          |
| **с \_ \_ \_ истекшим сроком действия в контексте E**        | Приложение ссылается на контекст, который уже был закрыт. Правильно написанное приложение не должно получить эту ошибку.                                        |
| **с \_ е \_ . \_ неправильная система шифрования E \_** | [*Шифр*](../secgloss/c-gly.md) , выбранный для [*контекста безопасности*](../secgloss/s-gly.md) , не поддерживается.                                                                       |
| **СЕК \_ . \_ недостаточный \_ объем памяти**    | Недостаточно доступной памяти для завершения запрошенного действия.                                                                                                      |
| **c \_ E \_ Недопустимый \_ маркер**         | В параметре *фконтекст* указан недопустимый маркер контекста.                                                                                              |
| **в секунду \_ E \_ Недопустимый \_ токен**          | Не \_ найден буфер типа данных pvbuffer.                                                                                                                                   |
| **с \_ е \_ КОП \_ не \_ поддерживается**     | [*Контекст безопасности*](../secgloss/s-gly.md)не поддерживает ни конфиденциальность, ни [*целостность*](../secgloss/i-gly.md) . |

## <a name="remarks"></a>Комментарии

Функция **енкриптмессаже (общая)** шифрует сообщение на основе сообщения и [*ключа сеанса*](../secgloss/s-gly.md) из [*контекста безопасности*](../secgloss/s-gly.md).

Если приложение транспорта создало [*контекст безопасности*](../secgloss/s-gly.md) для поддержки обнаружения последовательности и вызывающий объект предоставляет порядковый номер, функция включает эти сведения в зашифрованное сообщение. Включение этой информации обеспечивает защиту от воспроизведения, вставки и подавления сообщений. [*Пакет безопасности*](../secgloss/s-gly.md) включает порядковый номер, переданный из транспортного приложения.

При использовании дайджест-поставщика общих служб получите размер выходного буфера, вызвав функцию [**QueryContextAttributes (General)**](querycontextattributes--general.md) и УКАЗАВ \_ размеры SECPKG attr \_ . Функция вернет структуру [**\_ размеров секпкгконтекст**](/windows/win32/api/sspi/ns-sspi-secpkgcontext_sizes) . Размер выходного буфера равен сумме значений в элементах **кбмакссигнатуре** и **кбблокксизе** .

При использовании с поставщиком общих служб SChannel параметр *пмессаже* должен содержать структуру [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc) со следующими буферами.

> [!Note]  
> Эти буферы должны быть представлены в указанном порядке.

| Тип буфера                | Описание                                                                                 |
|----------------------------|---------------------------------------------------------------------------------------------|
| \_заголовок потока \_ pvbuffer  | Для внутреннего использования. Инициализация не требуется.                                                |
| \_данные pvbuffer            | Содержит зашифрованное сообщение в [*виде открытого текста*](../secgloss/s-gly.md) . |
| \_трейлер потока \_ pvbuffer | Для внутреннего использования. Инициализация не требуется.                                                |
| PVBUFFER \_ пусто           | Для внутреннего использования. Инициализация не требуется. Размер может быть равен нулю.                              |

При использовании поставщика общих служб SChannel необходимо определить максимальный размер каждого буфера, вызвав функцию [**QueryContextAttributes (General)**](querycontextattributes--general.md) и указав \_ \_ атрибут размер потока SECPKG attr \_ . Эта функция возвращает структуру [**секпкгконтекст \_ стреамсизес**](/windows/win32/api/sspi/ns-sspi-secpkgcontext_streamsizes) , члены которой содержат максимальные размеры для буферов заголовка (**кбхеадер** элемента), сообщения (**кбмаксимуммессаже** Member) и трейлеров (**кбтраилер** Member).

Для оптимальной производительности структуры *пмессаже* должны выделяться из непрерывной памяти.

**Windows XP/2000:** Эта функция также называлась **сеалмессаже**. Теперь приложения должны использовать только **енкриптмессаже (Общие)** .

## <a name="requirements"></a>Требования

| Требование | Значение |
|-------------------------------------|--------------------------------------------------------------------------------------------------------|
| Минимальная версия клиента | Windows \[Только классические приложения XP\]                                                            |
| Минимальная версия сервера | Windows Только для \[ настольных приложений сервера 2003\]                                                   |
| Заголовок                   | <dl> <dt>SSPI. h (включая Security. h)</dt> </dl> |
| Библиотека                  | <dl> <dt>Secur32. lib</dt> </dl>                 |
| DLL                      | <dl> <dt>Secur32.dll</dt> </dl>                 |

## <a name="see-also"></a>См. также

- [Функции SSPI](authentication-functions.md#sspi-functions)
- [**AcceptSecurityContext (Общие)**](acceptsecuritycontext--general.md)
- [**Декриптмессаже (Общие)**](decryptmessage--general.md)
- [**InitializeSecurityContext (Общие)**](initializesecuritycontext--general.md)
- [**QueryContextAttributes (Общие)**](querycontextattributes--general.md)
- [**Pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer)
- [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc)
