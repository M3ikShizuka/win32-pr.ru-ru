---
description: Шифрует сообщение для обеспечения конфиденциальности с помощью канала Schannel.
ms.assetid: b02b38bd-f3dd-4bf8-a36e-44ff9fbbe550
title: Функция Енкриптмессаже (Schannel)
ms.topic: reference
ms.date: 07/25/2019
ms.openlocfilehash: de792e543a8cb67bd6b608d79832fd31a68267fc297a85e0e178d268bbc069d6
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119008292"
---
# <a name="encryptmessage-schannel-function"></a>Функция Енкриптмессаже (Schannel)

Функция **енкриптмессаже (Schannel)** шифрует сообщение для обеспечения [*конфиденциальности*](../secgloss/p-gly.md). **Енкриптмессаже (Schannel)** позволяет приложению выбирать между [*алгоритмами шифрования*](../secgloss/c-gly.md) , поддерживаемыми выбранным механизмом. Функция **енкриптмессаже (Schannel)** использует [*контекст безопасности*](../secgloss/s-gly.md) , на который ссылается маркер контекста. Некоторые пакеты не имеют зашифрованных и не расшифрованных сообщений, а предоставляют [*хэш*](../secgloss/h-gly.md) целостности, который можно проверить.

При использовании поставщика общих служб SChannel эта функция шифрует сообщения с помощью [*ключа сеанса*](../secgloss/s-gly.md) , согласованного с удаленной стороной, которая получит сообщение. Алгоритм шифрования определяется используемым [комплектом [*шифров*](../secgloss/c-gly.md)]([*cipher*](../secgloss/c-gly.md)-suites-in-schannel.md) .

> [!Note]  
> **Енкриптмессаже (Schannel)** и [**декриптмессаже (Schannel)**](decryptmessage--schannel.md) могут быть вызваны одновременно из двух разных потоков в одном контексте SSPI, [*Если один поток*](../secgloss/s-gly.md) шифруется, а другой расшифровывается. При шифровании нескольких потоков или при расшифровке более одного потока каждый поток должен получить уникальный контекст.

## <a name="syntax"></a>Синтаксис

```C++
SECURITY_STATUS SEC_Entry EncryptMessage(
  _In_    PCtxtHandle    phContext,
  _In_    ULONG          fQOP,
  _Inout_ PSecBufferDesc pMessage,
  _In_    ULONG          MessageSeqNo
);
```

## <a name="parameters"></a>Параметры

*фконтекст* \[ окне\]

Маркер [*контекста безопасности*](../secgloss/s-gly.md) , который будет использоваться для шифрования сообщения.

*фкоп* \[ окне\]

Зависящие от пакета флаги, указывающие качество защиты. [*Пакет безопасности*](../secgloss/s-gly.md) может использовать этот параметр, чтобы включить выбор [*алгоритмов шифрования*](../secgloss/c-gly.md).

Этот параметр может иметь следующий флаг.

| Значение                                                                                                                                                                                | Значение                                                                                                                                                                                                                                                                                                                                                              |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span id="SECQOP_WRAP_OOB_DATA"></span><span id="secqop_wrap_oob_data"></span><dl> <dt>**СЕККОП \_ Перенос \_ \_ данных OOB**</dt> </dl> | Отправка сообщения с предупреждением SChannel. В этом случае параметр *пмессаже* должен содержать стандартный двухбайтовый код события SSL/TLS. Это значение поддерживается только поставщиком общих служб SChannel.<br/> например, начиная с Windows Vista, сообщение "сервер hello", отправленное сервером во время повторной проверки подлинности, должно быть зашифровано как оповещение TLS.<br/> |

*пмессаже* \[ в, out\]

Указатель на структуру [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc) . На входе структура ссылается на одну или несколько структур [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) . Один из них может иметь тип данных PVBUFFER \_ . Этот буфер содержит сообщение для шифрования. Сообщение шифруется на месте, перезаписывая исходное содержимое структуры.

Функция не обрабатывает буферы с \_ атрибутом pvbuffer ReadOnly.

Длина структуры [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) , которая содержит сообщение, не должна превышать **кбмаксимуммессаже**, которая получена из функции [**QueryContextAttributes (Schannel)**](querycontextattributes--schannel.md) ( \_ Размер потока SECPKG attr \_ \_ ).

*Мессажесекно* \[ окне\]

Порядковый номер, назначенный сообщению транспортным приложением. Если транспортное приложение не поддерживает порядковые номера, этот параметр должен быть равен нулю.

При использовании поставщика общих служб SChannel этот параметр должен иметь значение 0. Поставщик общих служб SChannel не использует порядковые номера.

## <a name="return-value"></a>Возвращаемое значение

Если функция завершается успешно, функция возвращает значение секунды \_ E \_ ОК.

Если функция завершается ошибкой, возвращается один из следующих кодов ошибок.

| Код возврата                                                                                                    | Описание                                                                                                                                                 |
|----------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <dl> <dt>**\_ \_ \_ слишком \_ маленький буфер E с**</dt> </dl>      | Выходной буфер слишком мал. Дополнительные сведения см. в подразделе "Примечания".<br/>                                                                               |
| <dl> <dt>**с \_ \_ \_ истекшим сроком действия в контексте E**</dt> </dl>        | Приложение ссылается на контекст, который уже был закрыт. Правильно написанное приложение не должно получить эту ошибку.<br/>             |
| <dl> <dt>**с \_ е \_ . \_ неправильная система шифрования E \_**</dt> </dl> | [*Шифр*](../secgloss/c-gly.md) , выбранный для [*контекста безопасности*](../secgloss/s-gly.md) , не поддерживается.<br/>                       |
| <dl> <dt>**СЕК \_ . \_ недостаточный \_ объем памяти**</dt> </dl>    | Недостаточно доступной памяти для завершения запрошенного действия.<br/>                                                                           |
| <dl> <dt>**c \_ E \_ Недопустимый \_ маркер**</dt> </dl>         | В параметре *фконтекст* указан недопустимый маркер контекста.<br/>                                                                   |
| <dl> <dt>**в секунду \_ E \_ Недопустимый \_ токен**</dt> </dl>          | Не \_ найден буфер типа данных pvbuffer.<br/>                                                                                                        |
| <dl> <dt>**с \_ е \_ КОП \_ не \_ поддерживается**</dt> </dl>     | [*Контекст безопасности*](../secgloss/s-gly.md)не поддерживает ни конфиденциальность, ни [*целостность*](../secgloss/i-gly.md) .<br/> |

## <a name="remarks"></a>Remarks

Функция **енкриптмессаже (Schannel)** шифрует сообщение на основе сообщения и [*ключа сеанса*](../secgloss/s-gly.md) из [*контекста безопасности*](../secgloss/s-gly.md).

Если приложение транспорта создало [*контекст безопасности*](../secgloss/s-gly.md) для поддержки обнаружения последовательности и вызывающий объект предоставляет порядковый номер, функция включает эти сведения в зашифрованное сообщение. Включение этой информации обеспечивает защиту от воспроизведения, вставки и подавления сообщений. [*Пакет безопасности*](../secgloss/s-gly.md) включает порядковый номер, переданный из транспортного приложения.

При использовании с поставщиком общих служб SChannel параметр *пмессаже* должен содержать структуру [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc) со следующими буферами.

> [!Note]  
> Эти буферы должны быть представлены в указанном порядке.

| Тип буфера                | Описание                                                                                                         |
|----------------------------|---------------------------------------------------------------------------------------------------------------------|
| \_заголовок потока \_ pvbuffer  | Для внутреннего использования. Инициализация не требуется.                                                                        |
| \_данные pvbuffer            | Содержит зашифрованное сообщение в [*виде открытого текста*](../secgloss/s-gly.md) . |
| \_трейлер потока \_ pvbuffer | Для внутреннего использования. Инициализация не требуется.                                                                        |
| PVBUFFER \_ пусто           | Для внутреннего использования. Инициализация не требуется. Размер может быть равен нулю.                                                      |

При использовании поставщика общих служб SChannel необходимо определить максимальный размер каждого буфера, вызвав функцию [**QueryContextAttributes (Schannel)**](querycontextattributes--schannel.md) и указав \_ \_ атрибут размеров SECPKG attr Stream \_ . Эта функция возвращает структуру [**секпкгконтекст \_ стреамсизес**](/windows/win32/api/sspi/ns-sspi-secpkgcontext_streamsizes) , члены которой содержат максимальные размеры для буферов заголовка (**кбхеадер** элемента), сообщения (**кбмаксимуммессаже** Member) и трейлеров (**кбтраилер** Member).

Для оптимальной производительности структуры *пмессаже* должны выделяться из непрерывной памяти.

**Windows XP/2000:** Эта функция также называлась **сеалмессаже**. Теперь приложения должны использовать только **енкриптмессаже (Schannel)** .

## <a name="requirements"></a>Requirements (Требования)

| Требование | Значение |
|-------------------------------------|--------------------------------|
| Минимальная версия клиента | Windows \[Только классические приложения XP\]          |
| Минимальная версия сервера | Windows Только для \[ настольных приложений сервера 2003\] |
| Заголовок                   | SSPI. h (включая Security. h)               |
| Библиотека                  | Secur32. lib                               |
| DLL                      | Secur32.dll                               |

## <a name="see-also"></a>См. также

- [Функции SSPI](authentication-functions.md#sspi-functions)
- [**AcceptSecurityContext (Schannel)**](acceptsecuritycontext--schannel.md)
- [**Декриптмессаже (Schannel)**](decryptmessage--schannel.md)
- [**InitializeSecurityContext (Schannel)**](initializesecuritycontext--schannel.md)
- [**QueryContextAttributes (Schannel)**](querycontextattributes--schannel.md)
- [**Pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer)
- [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc)
