---
description: Получает маркер для существующих учетных данных субъекта безопасности.
ms.assetid: acda4cf3-39a6-4bd2-91a0-db1f191b57b5
title: Функция AcquireCredentialsHandle (General) (SSPI. h)
ms.topic: reference
ms.date: 07/25/2019
ms.openlocfilehash: 0fcac88d1dcf31da19a15ab8a4834ae628d4e98e45ab777ec3da0db14092c75d
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "120101464"
---
# <a name="acquirecredentialshandle-general-function"></a>Функция AcquireCredentialsHandle (общая)

Функция **AcquireCredentialsHandle (General)** получает маркер для существующих учетных данных [*субъекта безопасности*](../secgloss/s-gly.md). Этот обработчик необходим для функций [**InitializeSecurityContext (General)**](initializesecuritycontext--general.md) и [**AcceptSecurityContext (General)**](acceptsecuritycontext--general.md) . Это могут быть либо существовавшие ранее учетные данные, которые устанавливаются с помощью системного входа, не описываемого здесь, либо вызывающая сторона может предоставить альтернативные учетные данные.

> [!Note]  
> Это не «вход в сеть» и не предполагает сбор учетных данных.

 

Сведения об использовании этой функции с конкретным [*поставщиком поддержки безопасности*](../secgloss/s-gly.md) (SSP) см. в следующих разделах.



| Раздел                                                                                           | Описание                                                                                                                                   |
|-------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------|
| [**AcquireCredentialsHandle (CredSSP)**](acquirecredentialshandle--credssp.md)<br/>     | Получает маркер для существующих учетных данных субъекта безопасности, использующего поставщик поддержки безопасности учетных данных (CredSSP).<br/> |
| [**AcquireCredentialsHandle (дайджест)**](acquirecredentialshandle--digest.md)<br/>       | Получает маркер для существующих учетных данных субъекта безопасности, который использует дайджест.<br/>                                         |
| [**AcquireCredentialsHandle (Kerberos)**](acquirecredentialshandle--kerberos.md)<br/>   | Получает маркер для существующих учетных данных субъекта безопасности, использующего протокол Kerberos.<br/>                                       |
| [**AcquireCredentialsHandle (согласование)**](acquirecredentialshandle--negotiate.md)<br/> | Получает маркер для существующих учетных данных субъекта безопасности, использующего Negotiate.<br/>                                      |
| [**AcquireCredentialsHandle (NTLM)**](acquirecredentialshandle--ntlm.md)<br/>           | Получает маркер для существующих учетных данных субъекта безопасности, использующего NTLM.<br/>                                           |
| [**AcquireCredentialsHandle (Schannel)**](acquirecredentialshandle--schannel.md)<br/>   | Получает маркер для существующих учетных данных субъекта безопасности, использующего SChannel.<br/>                                       |



 

## <a name="syntax"></a>Синтаксис


```C++
SECURITY_STATUS SEC_Entry AcquireCredentialsHandle(
  _In_  SEC_CHAR       *pszPrincipal,
  _In_  SEC_CHAR       *pszPackage,
  _In_  ULONG          fCredentialUse,
  _In_  PLUID          pvLogonID,
  _In_  PVOID          pAuthData,
  _In_  SEC_GET_KEY_FN pGetKeyFn,
  _In_  PVOID          pvGetKeyArgument,
  _Out_ PCredHandle    phCredential,
  _Out_ PTimeStamp     ptsExpiry
);
```



## <a name="parameters"></a>Параметры

<dl> <dt>

*псзпринЦипал* \[ окне\]
</dt> <dd>

Указатель на строку, завершающуюся нулем, которая указывает имя участника, учетные данные которого будут ссылаться на этот обработчик.

При использовании дайджест-поставщика общих служб этот параметр является необязательным.

При использовании поставщика общих служб SChannel этот параметр не используется и должен иметь значение **null**.

> [!Note]  
> Если процесс, запрашивающий этот обработчик, не имеет доступа к учетным данным, функция возвращает ошибку. Строка NULL указывает, что процессу требуется маркер для учетных данных пользователя, от имени которого выполняется [*контекст безопасности*](../secgloss/s-gly.md) .

 

</dd> <dt>

*псзпаккаже* \[ окне\]
</dt> <dd>

Указатель на строку, завершающуюся нулем, которая указывает имя [*пакета безопасности*](../secgloss/s-gly.md) , с помощью которого будут использоваться эти учетные данные. Это имя [*пакета безопасности*](../secgloss/s-gly.md) , возвращаемое в члене **Name** структуры [**Секпкгинфо**](/windows/win32/api/sspi/ns-sspi-secpkginfoa) , возвращаемой функцией [**енумератесекуритипаккажес**](/windows/win32/api/sspi/ns-sspi-secpkginfoa) . После установки контекста [**QueryContextAttributes (Общие)**](querycontextattributes--general.md) можно вызвать с параметром *улаттрибуте* , для которого задано значение SECPKG \_ attr, \_ \_ чтобы вернуть сведения о используемом [*пакете безопасности*](../secgloss/s-gly.md) .

При использовании дайджест-поставщика общих служб задайте для этого параметра значение WDIGEST \_ SP \_ Name.

При использовании поставщика общих служб SChannel присвойте этому параметру \_ имя унисп.

</dd> <dt>

*фкредентиалусе* \[ окне\]
</dt> <dd>

Флаг, указывающий, как будут использоваться эти учетные данные. Этот параметр может принимать одно из указанных ниже значений.



| Значение                                                                                                                                                                                                                                                                                    | Значение                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span id="SECPKG_CRED_AUTOLOGON_RESTRICTED"></span><span id="secpkg_cred_autologon_restricted"></span><dl> <dt>**SECPKG \_ Режим \_ автоматического входа в систему с \_ ограничением**</dt> <dt>0x00000010</dt> </dl> | В системе безопасности не используются учетные данные или учетные данные для входа по умолчанию из [диспетчера учетных данных](credential-manager.md).<br/> Это значение поддерживается только [*ограниченным делегированием*](../secgloss/s-gly.md)Negotiate.<br/> **Windows server 2008, Windows Vista, Windows Server 2003 и Windows XP:** Это значение не поддерживается.<br/>                                                                                                                                 |
| <span id="SECPKG_CRED_BOTH"></span><span id="secpkg_cred_both"></span><dl> <dt>**SECPKG \_ cred \_**</dt> </dl>                                                                                                                  | Проверка входящих учетных данных или использование локальных учетных данных для подготовки исходящего маркера. Этот флаг включает и другие флаги. Этот флаг не является допустимым для хэш-правил дайджеста и SChannel.<br/>                                                                                                                                                                                                                                                                |
| <span id="SECPKG_CRED_INBOUND"></span><span id="secpkg_cred_inbound"></span><dl> <dt>**SECPKG \_ cred \_ Inbound**</dt> </dl>                                                                                                         | Проверка учетных данных входящего сервера. Входящие учетные данные могут быть проверены с помощью центра проверки подлинности при вызове [**InitializeSecurityContext (General)**](initializesecuritycontext--general.md) или [**AcceptSecurityContext (General)**](acceptsecuritycontext--general.md) . Если такой центр недоступен, функция завершится ошибкой и возвратит значение, равное, \_ \_ без \_ центра проверки подлинности \_ . Проверка зависит от пакета.<br/> |
| <span id="SECPKG_CRED_OUTBOUND"></span><span id="secpkg_cred_outbound"></span><dl> <dt>**исходящий SECPKG \_ cred \_**</dt> </dl>                                                                                                      | Разрешение учетных данных локального клиента для подготовки исходящего маркера.<br/>                                                                                                                                                                                                                                                                                                                                                                                        |
| <span id="SECPKG_CRED_PROCESS_POLICY_ONLY"></span><span id="secpkg_cred_process_policy_only"></span><dl> <dt>**SECPKG \_ \_ \_ \_ Только политика процесса CRED**</dt> , <dt>0x00000020</dt> </dl>   | Функция обрабатывает политику сервера и возвращает данные в секунду, т. **\_ е. \_ не имеет \_ учетных данных**, указывая, что приложение должно запрашивать учетные данные.<br/> Это значение поддерживается только [*ограниченным делегированием*](../secgloss/s-gly.md)Negotiate.<br/> **Windows server 2008, Windows Vista, Windows Server 2003 и Windows XP:** Это значение не поддерживается.<br/>                                                                                                          |



 

</dd> <dt>

*пвлогонид* \[ окне\]
</dt> <dd>

Указатель на [*локально уникальный идентификатор*](../secgloss/l-gly.md) (LUID), определяющий пользователя. Этот параметр предоставляется для процессов файловой системы, таких как сетевые перенаправления. Этот параметр может принимать значение **NULL**.

При использовании поставщика общих служб SChannel этот параметр не используется и должен иметь значение **null**.

</dd> <dt>

*паусдата* \[ окне\]
</dt> <dd>

Указатель на данные, зависящие от пакета. Этот параметр может иметь **значение NULL**, что означает, что необходимо использовать учетные данные по умолчанию для этого [*пакета безопасности*](../secgloss/s-gly.md) . Чтобы использовать предоставленные учетные данные, передайте в этом параметре структуру [**\_ \_ \_ удостоверений проверки подлинности WinNT (с**](/windows/win32/api/sspi/ns-sspi-sec_winnt_auth_identity_a) ). Время выполнения RPC передает все, что было указано в [**рпкбиндингсетаусинфо**](/windows/win32/api/rpcdce/nf-rpcdce-rpcbindingsetauthinfo).

При использовании дайджест-поставщика общих служб этот параметр является указателем на [**структуру \_ \_ \_ удостоверения WinNT auth в секунду**](/windows/win32/api/sspi/ns-sspi-sec_winnt_auth_identity_a) , которая содержит сведения для проверки подлинности, используемые для нахождение учетных данных.

При использовании поставщика общих служб SChannel укажите структуру учетных записи [**SChannel \_**](/windows/win32/api/schannel/ns-schannel-schannel_cred) , указывающую используемый протокол, и параметры для различных настраиваемых функций канала.

При использовании пакетов NTLM или Negotiate максимальная длина символов для имени пользователя, пароля и домена составляет 256, 256 и 15 соответственно.

</dd> <dt>

*пжеткэйфн* \[ окне\]
</dt> <dd>

Этот параметр не используется и должен иметь значение **null**.

</dd> <dt>

*пвжеткэйаргумент* \[ окне\]
</dt> <dd>

Этот параметр не используется и должен иметь значение **null**.

</dd> <dt>

*фкредентиал* \[ заполняет\]
</dt> <dd>

Указатель на структуру [кредхандле](sspi-handles.md) для получения маркера учетных данных.

</dd> <dt>

*птсекспири* \[ заполняет\]
</dt> <dd>

Указатель на структуру [**метки времени**](timestamp.md) , которая получает время истечения срока действия возвращенных учетных данных. Значение, возвращаемое этой структурой **отметок времени** , зависит от [*ограниченного делегирования*](../secgloss/s-gly.md). [*Пакет безопасности*](../secgloss/s-gly.md) должен вернуть это значение в местное время.

Для этого параметра задается постоянное максимальное время. Нет времени истечения срока действия для дайджест- [*контекста безопасности*](../secgloss/s-gly.md)или учетных данных, либо при использовании дайджест-поставщика общих служб.

При использовании поставщика общих служб SChannel этот параметр является необязательным. Если учетные данные, используемые для проверки подлинности, являются сертификатом, этот параметр получает срок действия этого сертификата. Если сертификат не указан, возвращается максимальное значение времени.

</dd> </dl>

## <a name="return-value"></a>Возвращаемое значение

Если функция завершается успешно, функция возвращает значение секунды \_ E \_ ОК.

Если функция завершается ошибкой, возвращается один из следующих кодов ошибок.



| Код возврата                                                                                                 | Описание                                                                                                                                        |
|-------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------|
| <dl> <dt>**СЕК \_ . \_ недостаточный \_ объем памяти**</dt> </dl> | Недостаточно доступной памяти для завершения запрошенного действия.<br/>                                                                  |
| <dl> <dt>**\_ \_ Внутренняя ошибка E \_ sec**</dt> </dl>      | Произошла ошибка, которая не сопоставлена с кодом ошибки SSPI.<br/>                                                                               |
| <dl> <dt>**с \_ \_ без \_ учетных данных**</dt> </dl>      | Учетные данные недоступны в [*ограниченном делегировании*](../secgloss/s-gly.md).<br/> |
| <dl> <dt>**СЕК. \_ е. \_ не \_ владелец**</dt> </dl>           | Вызывающий объект функции не имеет необходимых учетных данных.<br/>                                                                     |
| <dl> <dt>**с \_ е \_ SECPKG \_ не \_ Найдено**</dt> </dl>   | Запрошенный [*пакет безопасности*](../secgloss/s-gly.md) не существует.<br/>                                                                                          |
| <dl> <dt>**с \_ е \_ неизвестные \_ учетные данные**</dt> </dl> | Учетные данные, предоставленные пакету, не распознаны.<br/>                                                                            |



 

## <a name="remarks"></a>Remarks

Функция **AcquireCredentialsHandle (General)** возвращает маркер учетных данных участника, например пользователя или клиента, который используется конкретным [*ограниченным делегированием*](../secgloss/s-gly.md). Это может быть обработчик существующих учетных данных, или функция может создать новый набор учетных данных и вернуть их. Этот маркер можно использовать при последующих вызовах функций [**AcceptSecurityContext (General)**](acceptsecuritycontext--general.md) и [**InitializeSecurityContext (General)**](initializesecuritycontext--general.md) .

Как правило, **AcquireCredentialsHandle (Общие)** не позволяет процессу получить маркер учетных данных других пользователей, выполнивших вход на тот же компьютер. однако вызывающая сторона с SE \_ \_ [*привилегией*](../secgloss/s-gly.md) имени TCB имеет возможность указать [*идентификатор входа*](../secgloss/l-gly.md) (LUID) любого существующего маркера сеанса входа, чтобы получить маркер для учетных данных этого сеанса. Обычно это используется модулями режима ядра, которые должны действовать от имени вошедшего в систему пользователя.

Пакет может вызвать функцию в *пжеткэйфн* , предоставляемую транспортом времени выполнения RPC. Если транспорт не поддерживает понятие обратного вызова для получения учетных данных, этот параметр должен иметь **значение NULL**.

Для вызывающих объектов в режиме ядра необходимо отметить следующие отличия.

-   Два строковых параметра должны быть строками в [*Юникоде*](../secgloss/u-gly.md) .
-   Значения буфера должны выделяться в виртуальной памяти процесса, а не в пуле.

По завершении использования возвращенных учетных данных освободите память, используемую учетными данными, вызвав функцию [**фрикредентиалшандле**](/windows/win32/api/sspi/nf-sspi-freecredentialshandle) .

## <a name="requirements"></a>Requirements (Требования)



| Требование | Значение |
|-------------------------------------|--------------------------------------------------------------------------------------------------------|
| Минимальная версия клиента<br/> | Windows \[Только классические приложения XP\]<br/>                                                            |
| Минимальная версия сервера<br/> | Windows Только для \[ настольных приложений сервера 2003\]<br/>                                                   |
| Заголовок<br/>                   | <dl> <dt>SSPI. h (включая Security. h)</dt> </dl> |
| Библиотека<br/>                  | <dl> <dt>Secur32. lib</dt> </dl>                 |
| DLL<br/>                      | <dl> <dt>Secur32.dll</dt> </dl>                 |
| Имя в кодировке Юникод и ANSI<br/>   | **Аккуирекредентиалшандлев** (Юникод) и **аккуирекредентиалшандлеа** (ANSI)<br/>            |



## <a name="see-also"></a>См. также

<dl> <dt>

[Функции SSPI](authentication-functions.md#sspi-functions)
</dt> <dt>

[**AcceptSecurityContext (Общие)**](acceptsecuritycontext--general.md)
</dt> <dt>

[**InitializeSecurityContext (Общие)**](initializesecuritycontext--general.md)
</dt> <dt>

[**фрикредентиалшандле**](/windows/win32/api/sspi/nf-sspi-freecredentialshandle)
</dt> </dl>

 

 
