---
description: Позволяет компоненту сервера транспортного приложения устанавливать контекст безопасности между сервером и удаленным клиентом, использующим дайджест.
ms.assetid: 017683e3-b21a-4e97-9232-582ac7dbd5b2
title: Функция AcceptSecurityContext (Digest) (SSPI. h)
ms.topic: article
ms.date: 07/25/2019
ms.openlocfilehash: 11ffa801612f14f5b9aaf61e7d48b61377bc9e56
ms.sourcegitcommit: de72a1294df274b0a71dc0fdc42d757e5f6df0f3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "104081742"
---
# <a name="acceptsecuritycontext-digest-function"></a>Функция AcceptSecurityContext (Digest)

Функция **AcceptSecurityContext (Digest)** позволяет компоненту сервера транспортного приложения устанавливать [*контекст безопасности*](../secgloss/s-gly.md) между сервером и удаленным клиентом. Удаленный клиент использует функцию [**InitializeSecurityContext (Digest)**](initializesecuritycontext--digest.md) для запуска процесса установки контекста безопасности. Серверу может потребоваться один или несколько маркеров ответа от удаленного клиента для завершения установки контекста безопасности.

## <a name="syntax"></a>Синтаксис


```C++
SECURITY_STATUS SEC_Entry AcceptSecurityContext(
  _In_opt_    PCredHandle    phCredential,
  _Inout_opt_ PCtxtHandle    phContext,
  _In_opt_    PSecBufferDesc pInput,
  _In_        ULONG          fContextReq,
  _In_        ULONG          TargetDataRep,
  _Inout_opt_ PCtxtHandle    phNewContext,
  _Inout_opt_ PSecBufferDesc pOutput,
  _Out_       PULONG         pfContextAttr,
  _Out_opt_   PTimeStamp     ptsExpiry
);
```



## <a name="parameters"></a>Параметры

<dl> <dt>

*фкредентиал* \[ в необязательное\]
</dt> <dd>

Маркер учетных данных сервера. Сервер вызывает функцию [**AcquireCredentialsHandle (Digest)**](acquirecredentialshandle--digest.md) с \_ \_ флагом SECPKG CRED Inbound или SECPKG CRED, \_ \_ установленным для получения этого маркера.

</dd> <dt>

*фконтекст* \[ в, out, необязательно\]
</dt> <dd>

Указатель на структуру [кткссандле](sspi-handles.md) . При первом вызове **AcceptSecurityContext (Digest)** этот указатель имеет **значение NULL**. При последующих вызовах *фконтекст* — это описатель частично сформированного контекста, который был возвращен в параметре *фневконтекст* при первом вызове.

</dd> <dt>

*пинпут* \[ в необязательное\]
</dt> <dd>

Указатель на структуру [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc) , созданную клиентским вызовом [**InitializeSecurityContext (Digest)**](initializesecuritycontext--digest.md) , который содержит дескриптор входного буфера.

В следующей таблице показана конфигурация буфера для дайджест-HTTP. Первый буфер должен иметь тип **\_ Token pvbuffer**, а остальные должны иметь тип **pvbuffer \_ pkg \_ params**. SASL требует только нулевого буфера.



| \#Тип/буффер буфера                                                                                                                                                                                                 | Значение                                                                                                                                                                  |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span id="0"></span><dl> <dt>**0**</dt> <dt> **\_ маркер pvbuffer**</dt> </dl>                                        | Пустой для первого вызова и ответ на запрос, полученный от клиента для второго вызова.<br/>                                                             |
| <span id="1"></span><dl> <dt>**1**</dt> <dt> **pvbuffer \_ \_ параметров pkg**</dt> </dl>                                  | Метод. Символы имеют формат вирелине из строки запроса. Однобайтовые символы ASCII США.<br/>                                                                |
| <span id="2"></span><dl> <dt>**2**</dt> <dt> **\_ \_ параметра pkg pvbuffer**</dt> </dl>                                  | Зарезервировано.<br/>                                                                                                                                                     |
| <span id="3"></span><dl> <dt>**3**</dt> <dt> **pvbuffer \_ \_ параметров pkg**</dt> </dl>                                  | Хентити. Шестнадцатеричное представление H (сущность-тело). Однобайтовые символы ASCII США.<br/>                                                                       |
| <span id="4"></span><dl> <dt>**4**</dt> <dt> **pvbuffer \_ \_ параметров pkg**</dt> </dl>                                  | Сферы. Строка области для запроса. Строка в Юникоде, которая должна быть представлена в ASCII US.<br/>                                                                 |
| <span id="5"></span><dl> <dt>**5**</dt> <dt> **\_ \_ привязок каналов pvbuffer** \| **pvbuffer \_ ReadOnly**</dt> </dl> | Содержит значение токена привязки канала.<br/> Windows **server 2008, Windows Vista, Windows server 2003 и Windows XP:** Это значение не поддерживается.<br/> |



 

</dd> <dt>

*фконтекстрек* \[ окне\]
</dt> <dd>

Битовые флаги, указывающие атрибуты, необходимые серверу для установки контекста. Битовые флаги можно комбинировать с помощью операций побитового **или** . Этот параметр может принимать одно или несколько следующих значений.



| Значение                                                                                                                                                                                                                                          | Значение                                                                                                                                                                                                                                                                                                                                                                                                                     |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span id="ASC_REQ_ALLOCATE_MEMORY"></span><span id="asc_req_allocate_memory"></span><dl> <dt>**по УБЫВАНИЮ \_ требований \_ выделить \_ память**</dt> </dl>                                                  | Дайджест выделяет выходные буферы. Завершив использование выходных буферов, освободите их, вызвав функцию [**фриконтекстбуффер**](/windows/win32/api/sspi/nf-sspi-freecontextbuffer) .<br/>                                                                                                                                                                                                                                      |
| <span id="ASC_REQ_ALLOW_MISSING_BINDINGS"></span><span id="asc_req_allow_missing_bindings"></span><dl> <dt>**в ASC \_ req \_ разрешены \_ отсутствующие \_ привязки**</dt> </dl>                            | Указывает, что дайджест не требует привязки каналов для внутренних и внешних каналов. Это значение используется для обратной совместимости, если неизвестна поддержка привязки канала конечной точки.<br/> Это значение взаимоисключающее с **\_ \_ \_ привязками прокси-сервера ASC req**.<br/> Windows **server 2008, Windows Vista, Windows server 2003 и Windows XP:** Это значение не поддерживается.<br/> <br/> |
| <span id="ASC_REQ_CONFIDENTIALITY"></span><span id="asc_req_confidentiality"></span><dl> <dt>**конфиденциальность по УБЫВАНИЮ \_ требований \_**</dt> </dl>                                                   | Шифрование и расшифровка сообщений. <br/> Хэш-код дайджеста поддерживает этот флаг только для SASL.<br/>                                                                                                                                                                                                                                                                                                                       |
| <span id="ASC_REQ_PROXY_BINDINGS"></span><span id="asc_req_proxy_bindings"></span><dl> <dt>**\_ \_ привязка прокси-сервера ASC req \_**</dt> </dl>                                                     | Указывает, что для дайджеста требуется привязка канала.<br/> Это значение взаимоисключающее с параметром **ASC \_ req \_ разрешает \_ отсутствие \_ привязок**.<br/> Windows **server 2008, Windows Vista, Windows server 2003 и Windows XP:** Это значение не поддерживается.<br/> <br/>                                                                                                                                         |
| <span id="ASC_REQ_CONNECTION"></span><span id="asc_req_connection"></span><dl> <dt>**\_Подключение ASC req \_**</dt> </dl>                                                                  | [*Контекст безопасности*](../secgloss/s-gly.md) не будет работать с сообщениями форматирования.<br/>                                                                                                                                                                                                                                                                                                                                                        |
| <span id="ASC_REQ_EXTENDED_ERROR"></span><span id="asc_req_extended_error"></span><dl> <dt>**\_ \_ Расширенная ошибка по убыванию требований \_**</dt> </dl>                                                     | При возникновении ошибок удаленная сторона будет уведомлена.<br/>                                                                                                                                                                                                                                                                                                                                                            |
| <span id="ASC_REQ_HTTP__0x10000000_"></span><span id="asc_req_http__0x10000000_"></span><span id="ASC_REQ_HTTP__0X10000000_"></span><dl> <dt>**ASC \_ req \_ http (0x10000000)**</dt> </dl> | Используйте дайджест для HTTP. Пропустите этот флаг, чтобы использовать дайджест в качестве механизма SASL.<br/>                                                                                                                                                                                                                                                                                                                                          |
| <span id="ASC_REQ_INTEGRITY"></span><span id="asc_req_integrity"></span><dl> <dt>**\_ \_ целостность требований ASC**</dt> </dl>                                                                     | Подписывание сообщений и проверка подписей.<br/>                                                                                                                                                                                                                                                                                                                                                                             |
| <span id="ASC_REQ_REPLAY_DETECT"></span><span id="asc_req_replay_detect"></span><dl> <dt>**Обнаружение повторного \_ воспроизведения требований ASC \_ \_**</dt> </dl>                                                        | Обнаружение воспроизводимых пакетов.<br/>                                                                                                                                                                                                                                                                                                                                                                                         |
| <span id="ASC_REQ_SEQUENCE_DETECT"></span><span id="asc_req_sequence_detect"></span><dl> <dt>**\_ \_ Обнаружение последовательности "ASC req" \_**</dt> </dl>                                                  | Обнаружение сообщений, полученных за пределами последовательности.<br/>                                                                                                                                                                                                                                                                                                                                                                        |



 

Возможные флаги атрибутов и их значения см. в разделе [требования к контексту](context-requirements.md). Флаги, используемые для этого параметра, имеют префикс ASC \_ req, например, ASC \_ req \_ Delegate.

Запрошенные атрибуты могут не поддерживаться клиентом. Дополнительные сведения см. в описании параметра *пфконтекстаттр* .

</dd> <dt>

*Таржетдатареп* \[ окне\]
</dt> <dd>

Представление данных, например порядок байтов, на целевом объекте. Этот параметр может быть либо \_ собственными \_ дреп, либо безопасностью \_ сети \_ дреп.

Этот параметр не используется с дайджест-SSP. При использовании дайджест-поставщика общих служб укажите для этого параметра нулевое значение.

</dd> <dt>

*фневконтекст* \[ в, out, необязательно\]
</dt> <dd>

Указатель на структуру [кткссандле](sspi-handles.md) . При первом вызове **AcceptSecurityContext (Digest)** этот указатель получает новый обработчик контекста. При последующих вызовах *фневконтекст* может совпадать с маркером, указанным в параметре *фконтекст* .

</dd> <dt>

*паутпут* \[ в, out, необязательно\]
</dt> <dd>

Указатель на структуру [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc) , содержащую дескриптор выходного буфера. Этот буфер отправляется клиенту для ввода в дополнительные вызовы [**InitializeSecurityContext (Digest)**](initializesecuritycontext--digest.md). Выходной буфер может быть создан, даже если функция возвращает значение в СЕКУНДах \_ \_ . Любой созданный буфер должен быть отправлен обратно клиентскому приложению.

</dd> <dt>

*пфконтекстаттр* \[ заполняет\]
</dt> <dd>

Указатель на переменную, которая получает набор битовых флагов, указывающих атрибуты установленного контекста. Описание различных атрибутов см. в разделе [требования к контексту](context-requirements.md). Флаги, используемые для этого параметра, имеют префикс ASC \_ RET, например, ASC \_ RET \_ Delegate.

Не проверяйте атрибуты, связанные с безопасностью, до тех пор, пока завершающий вызов функции не вернется успешно. Флаги атрибутов, не связанные с безопасностью, такие как \_ \_ флаг ASC \_ , выделенная память, можно проверить перед окончательным возвратом.

</dd> <dt>

*птстиместамп* \[ out, необязательно\]
</dt> <dd>

Указатель на структуру [**метки времени**](timestamp.md) , которая получает время окончания срока действия контекста. Рекомендуется, чтобы [*пакет безопасности*](../secgloss/s-gly.md) всегда возвращал это значение в местное время.

Для этого параметра задается постоянное максимальное время. Нет времени истечения срока действия для дайджест- [*контекста безопасности*](../secgloss/s-gly.md)или учетных данных, либо при использовании дайджест-поставщика общих служб.

> [!Note]  
> До последнего вызова процесса проверки подлинности время истечения срока действия контекста может быть неправильным, поскольку на последующих этапах согласования будут предоставлены дополнительные сведения. Таким образом, *птстиместамп* должен иметь **значение NULL** до последнего вызова функции.

 

</dd> </dl>

## <a name="return-value"></a>Возвращаемое значение

Эта функция возвращает одно из следующих значений.



<table><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><thead><tr class="header"><th>Возвращаемый код и значение</th><th>Описание</th></tr></thead><tbody><tr class="odd"><td><dl> <dt><strong>SEC_E_INSUFFICIENT_MEMORY</strong></dt> <dt>0x80090300L</dt> </dl></td><td>Ошибка при выполнении функции. Недостаточно доступной памяти для завершения запрошенного действия.<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_E_INTERNAL_ERROR</strong></dt> <dt>0x80090304L</dt> </dl></td><td>Ошибка при выполнении функции. Произошла ошибка, которая не сопоставлена с кодом ошибки SSPI.<br/></td></tr><tr class="odd"><td><dl> <dt><strong>SEC_E_INVALID_HANDLE</strong></dt> <dt>0x80100003L</dt> </dl></td><td>Ошибка при выполнении функции. В функцию передан недопустимый маркер.<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_E_INVALID_TOKEN</strong></dt> <dt>0x80090308L</dt> </dl></td><td>Ошибка при выполнении функции. В функцию передан недопустимый токен.<br/></td></tr><tr class="odd"><td><dl> <dt><strong>SEC_E_LOGON_DENIED</strong></dt> <dt>0x8009030CL</dt> </dl></td><td>Ошибка входа в систему.<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_E_NO_AUTHENTICATING_AUTHORITY</strong></dt> <dt>0x80090311L</dt> </dl></td><td>Ошибка при выполнении функции. Не удалось связаться с центром сертификации для проверки подлинности. Это может быть вызвано следующими причинами.<br/><ul><li>Неверное доменное имя субъекта проверки подлинности.</li><li>Домен недоступен.</li><li>Не удалось установить отношение доверия.</li></ul></td></tr><tr class="odd"><td><dl> <dt><strong>SEC_E_NO_CREDENTIALS</strong></dt> <dt>0x8009030EL</dt> </dl></td><td>Ошибка при выполнении функции. Недопустимый обработчик учетных данных, указанный в параметре <em>фкредентиал</em> .<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_E_OK</strong></dt> <dt>0x00000000</dt> </dl></td><td>Функция выполнена успешно. Был принят [*контекст безопасности*](../secgloss/s-gly.md) , полученный от клиента. Если выходная лексема была создана функцией, она должна быть отправлена в клиентский процесс.<br/></td></tr><tr class="odd"><td><dl> <dt><strong>SEC_E_SECURITY_QOS_FAILED</strong></dt> <dt>0x80090332L</dt> </dl></td><td>Ошибка при выполнении функции. В параметре <em>фконтекстрек</em> указан недопустимый флаг атрибута контекста.<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_I_COMPLETE_AND_CONTINUE</strong></dt> <dt>0x00090314L</dt> </dl></td><td>Функция выполнена успешно. Сервер должен вызвать [<strong>CompleteAuthToken</strong>] (/Windows/Win32/API/SSPI/NF-SSPI-completeauthtoken) и передать выходной токен клиенту. Затем сервер ждет возврата токена от клиента, а затем выполняет еще один вызов [<strong>AcceptSecurityContext (Digest)</strong>] (AcceptSecurityContext--Digest.md).<br/></td></tr><tr class="odd"><td><dl> <dt><strong>SEC_I_COMPLETE_NEEDED</strong></dt> <dt>0x00090313L</dt> </dl></td><td>Функция выполнена успешно. Сервер должен завершить создание сообщения от клиента, а затем вызвать функцию [<strong>CompleteAuthToken</strong>] (/Windows/Win32/API/SSPI/NF-SSPI-completeauthtoken).<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_I_CONTINUE_NEEDED</strong></dt> <dt>0x00090312L</dt> </dl></td><td>Функция выполнена успешно. Сервер должен отправить выходной токен клиенту и дождаться возвращенного маркера. Возвращаемый токен должен передаваться в <em>пинпут</em> для другого вызова [<strong>AcceptSecurityContext (Digest)</strong>] (AcceptSecurityContext--Digest.md).<br/></td></tr><tr class="odd"><td><dl> <dt><strong>STATUS_LOGON_FAILURE</strong></dt> <dt>0xC000006DL</dt> </dl></td><td>Ошибка при выполнении функции. Функция [<strong>AcceptSecurityContext (Digest)</strong>] (AcceptSecurityContext--Digest.md) была вызвана после установки указанного контекста.<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_E_BAD_BINDINGS</strong></dt> <dt>0x80090346L</dt> </dl></td><td>Ошибка при выполнении функции. Политика привязки канала не была удовлетворена.<br/></td></tr></tbody></table>



 

## <a name="remarks"></a>Комментарии

**AcceptSecurityContext (Digest)** — это серверная функция, аналогичная функции [**InitializeSecurityContext (Digest)**](initializesecuritycontext--digest.md) .

Когда сервер получает запрос от клиента, сервер использует параметр *фконтекстрек* , чтобы указать, что он требует для сеанса. Таким образом, сервер может указать, что клиенты должны иметь возможность использовать конфиденциальную сессию или сеанс с проверкой [*целостности*](../secgloss/i-gly.md), а также могут отклонять клиенты, которые не могут удовлетворить это требование. Кроме того, сервер может не потребовать ничего, а любой клиент, который может предоставить или требуется, возвращается в параметре *пфконтекстаттр* .

Для пакета, поддерживающего многоэтапную проверку подлинности, например взаимную проверку подлинности, вызывающая последовательность выглядит следующим образом:

1.  Клиент передает токен на сервер.
2.  Сервер вызывает **AcceptSecurityContext (дайджест)** в первый раз, что создает маркер ответа, который затем отправляется клиенту.
3.  Клиент получает маркер и передает его в [**InitializeSecurityContext (дайджест)**](initializesecuritycontext--digest.md). Если **InitializeSecurityContext (дайджест)** возвращает значение \_ \_ в секунду, выполняется взаимная проверка подлинности и может начаться безопасный сеанс. Если **InitializeSecurityContext (дайджест)** возвращает код ошибки, согласование взаимной проверки подлинности завершается. В противном случае маркер безопасности, возвращенный **InitializeSecurityContext (дайджест)** , отправляется клиенту, а шаги 2 и 3 повторяются.

Параметры *фконтекстрек* и *пфконтекстаттр* представляют собой битовую маску, представляющую различные атрибуты контекста. Описание различных атрибутов см. в разделе [требования к контексту](context-requirements.md).

> [!Note]  
> Параметр *пфконтекстаттр* допустим при любом успешном возвращении, но только при окончательном успешном возвращении следует изучить флаги, относящиеся к аспектам безопасности контекста. Промежуточные возвраты могут задавать, например, \_ флаг « \_ Выделенная память ISC» \_ .

 

Вызывающий объект отвечает за определение того, достаточно ли атрибутов последнего контекста. Если, например, был запрошен параметр конфиденциальность (шифрование), но его не удалось установить, некоторые приложения могут немедленно завершить подключение. Если невозможно установить [*контекст безопасности*](../secgloss/s-gly.md) , сервер должен освободить частично созданный контекст, вызвав функцию [**делетесекуритиконтекст**](/windows/win32/api/sspi/nf-sspi-deletesecuritycontext) . Сведения о том, когда следует вызывать функцию **делетесекуритиконтекст** , см. в разделе **делетесекуритиконтекст**.

После установки [*контекста безопасности*](../secgloss/s-gly.md) серверное приложение может использовать функцию [**куерисекуритиконтексттокен**](/windows/win32/api/sspi/nf-sspi-querysecuritycontexttoken) для получения маркера учетной записи пользователя, которой сопоставлен сертификат клиента. Кроме того, сервер может использовать функцию [**имперсонатесекуритиконтекст**](/windows/win32/api/sspi/nf-sspi-impersonatesecuritycontext) для олицетворения пользователя.

## <a name="requirements"></a>Требования



| Требование | Значение |
|-------------------------------------|--------------------------------------------------------------------------------------------------------|
| Минимальная версия клиента<br/> | Только для \[ классических приложений Windows XP\]<br/>                                                            |
| Минимальная версия сервера<br/> | \[Только для настольных приложений Windows Server 2003\]<br/>                                                   |
| Header<br/>                   | <dl> <dt>SSPI. h (включая Security. h)</dt> </dl> |
| Библиотека<br/>                  | <dl> <dt>Secur32. lib</dt> </dl>                 |
| DLL<br/>                      | <dl> <dt>Secur32.dll</dt> </dl>                 |



## <a name="see-also"></a>См. также раздел

<dl> <dt>

[Функции SSPI](authentication-functions.md#sspi-functions)
</dt> <dt>

[**делетесекуритиконтекст**](/windows/win32/api/sspi/nf-sspi-deletesecuritycontext)
</dt> <dt>

[**InitializeSecurityContext (дайджест)**](initializesecuritycontext--digest.md)
</dt> </dl>

 

 
