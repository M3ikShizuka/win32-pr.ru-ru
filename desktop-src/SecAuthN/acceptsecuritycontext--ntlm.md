---
description: Позволяет компоненту сервера транспортного приложения устанавливать [*контекст безопасности*](../secgloss/s-gly.md) между сервером и удаленным клиентом, использующим NTLM.
ms.assetid: 7a0f5118-be6d-443d-8b01-596dc4030b3b
title: Функция AcceptSecurityContext (NTLM) (SSPI. h)
ms.topic: reference
ms.date: 07/25/2019
ms.openlocfilehash: cd3a3aa27776cd1922539dc4104eb246accfbed2
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104423909"
---
# <a name="acceptsecuritycontext-ntlm-function"></a>Функция AcceptSecurityContext (NTLM)

Функция **AcceptSecurityContext (NTLM)** позволяет компоненту сервера транспортного приложения устанавливать [*контекст безопасности*](../secgloss/s-gly.md) между сервером и удаленным клиентом. Удаленный клиент использует функцию [**InitializeSecurityContext (NTLM)**](initializesecuritycontext--ntlm.md) для запуска процесса установки [*контекста безопасности*](../secgloss/s-gly.md). Серверу может потребоваться один или несколько маркеров ответа от удаленного клиента для завершения установки [*контекста безопасности*](../secgloss/s-gly.md).

## <a name="syntax"></a>Синтаксис


```C++
SECURITY_STATUS SEC_Entry AcceptSecurityContext(
  _In_opt_    PCredHandle    phCredential,
  _Inout_opt_ PCtxtHandle    phContext,
  _In_opt_    PSecBufferDesc pInput,
  _In_        ULONG          fContextReq,
  _In_        ULONG          TargetDataRep,
  _Inout_opt_ PCtxtHandle    phNewContext,
  _Inout_opt_ PSecBufferDesc pOutput,
  _Out_       PULONG         pfContextAttr,
  _Out_opt_   PTimeStamp     ptsTimeStamp
);
```



## <a name="parameters"></a>Параметры

<dl> <dt>

*фкредентиал* \[ в необязательное\]
</dt> <dd>

Маркер учетных данных сервера. Сервер вызывает функцию [**AcquireCredentialsHandle (NTLM)**](acquirecredentialshandle--ntlm.md) с \_ \_ установленным флагом SECPKG CRED Inbound или SECPKG \_ cred \_ для получения этого маркера.

</dd> <dt>

*фконтекст* \[ в, out, необязательно\]
</dt> <dd>

Указатель на структуру [кткссандле](sspi-handles.md) . При первом вызове **AcceptSecurityContext (NTLM)** этот указатель имеет **значение NULL**. При последующих вызовах *фконтекст* — это описатель частично сформированного контекста, который был возвращен в параметре *фневконтекст* при первом вызове.

</dd> <dt>

*пинпут* \[ в необязательное\]
</dt> <dd>

Указатель на структуру [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc) , созданную клиентским вызовом [**InitializeSecurityContext (NTLM)**](initializesecuritycontext--ntlm.md) , который содержит дескриптор входного буфера.

Сведения о привязке канала можно указать, передав структуру [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) **\_ \_ привязок каналов типа pvbuffer** в дополнение к буферам, созданным вызовом функции [**InitializeSecurityContext (General)**](initializesecuritycontext--general.md) . Сведения о привязке канала для буфера привязки канала можно получить, вызвав функцию [**QueryContextAttributes (Schannel)**](querycontextattributes--schannel.md) в контексте SChannel, который клиент использовал для проверки подлинности.

</dd> <dt>

*фконтекстрек* \[ окне\]
</dt> <dd>

Битовые флаги, указывающие атрибуты, необходимые серверу для установки контекста. Битовые флаги можно комбинировать с помощью операций побитового **или** . Этот параметр может принимать одно или несколько следующих значений.



| Значение                                                                                                                                                                                         | Значение                                                              |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------|
| <span id="ASC_REQ_CONFIDENTIALITY"></span><span id="asc_req_confidentiality"></span><dl> <dt>**конфиденциальность по УБЫВАНИЮ \_ требований \_**</dt> </dl>  | Шифрование и расшифровка сообщений.<br/>                             |
| <span id="ASC_REQ_CONNECTION"></span><span id="asc_req_connection"></span><dl> <dt>**\_Подключение ASC req \_**</dt> </dl>                 | [*Контекст безопасности*](../secgloss/s-gly.md) не будет работать с сообщениями форматирования.<br/> |
| <span id="ASC_REQ_EXTENDED_ERROR"></span><span id="asc_req_extended_error"></span><dl> <dt>**\_ \_ Расширенная ошибка по убыванию требований \_**</dt> </dl>    | При возникновении ошибок удаленная сторона будет уведомлена.<br/>     |
| <span id="ASC_REQ_INTEGRITY"></span><span id="asc_req_integrity"></span><dl> <dt>**\_ \_ целостность требований ASC**</dt> </dl>                    | Подписывание сообщений и проверка подписей.<br/>                      |
| <span id="ASC_REQ_REPLAY_DETECT"></span><span id="asc_req_replay_detect"></span><dl> <dt>**Обнаружение повторного \_ воспроизведения требований ASC \_ \_**</dt> </dl>       | Обнаружение воспроизводимых пакетов.<br/>                                  |
| <span id="ASC_REQ_SEQUENCE_DETECT"></span><span id="asc_req_sequence_detect"></span><dl> <dt>**\_ \_ Обнаружение последовательности "ASC req" \_**</dt> </dl> | Обнаружение сообщений, полученных за пределами последовательности.<br/>                 |



 

Возможные флаги атрибутов и их значения см. в разделе [требования к контексту](context-requirements.md). Флаги, используемые для этого параметра, имеют префикс ASC \_ req, например, ASC \_ req \_ Delegate.

Запрошенные атрибуты могут не поддерживаться клиентом. Дополнительные сведения см. в описании параметра *пфконтекстаттр* .

</dd> <dt>

*Таржетдатареп* \[ окне\]
</dt> <dd>

Представление данных, например порядок байтов, на целевом объекте. Этот параметр может быть либо \_ собственными \_ дреп, либо безопасностью \_ сети \_ дреп.

</dd> <dt>

*фневконтекст* \[ в, out, необязательно\]
</dt> <dd>

Указатель на структуру [кткссандле](sspi-handles.md) . При первом вызове **AcceptSecurityContext (NTLM)** этот указатель получает новый обработчик контекста. При последующих вызовах *фневконтекст* может совпадать с маркером, указанным в параметре *фконтекст* .

</dd> <dt>

*паутпут* \[ в, out, необязательно\]
</dt> <dd>

Указатель на структуру [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc) , содержащую дескриптор выходного буфера. Этот буфер отправляется клиенту для ввода в дополнительные вызовы [**InitializeSecurityContext (NTLM)**](initializesecuritycontext--ntlm.md). Выходной буфер может быть создан, даже если функция возвращает значение в СЕКУНДах \_ \_ . Любой созданный буфер должен быть отправлен обратно клиентскому приложению.

</dd> <dt>

*пфконтекстаттр* \[ заполняет\]
</dt> <dd>

Указатель на переменную, которая получает набор битовых флагов, указывающих атрибуты установленного контекста. Описание различных атрибутов см. в разделе [требования к контексту](context-requirements.md). Флаги, используемые для этого параметра, имеют префикс ASC \_ RET, например, ASC \_ RET \_ Delegate.

Не проверяйте атрибуты, связанные с безопасностью, до тех пор, пока завершающий вызов функции не вернется успешно. Флаги атрибутов, не связанные с безопасностью, такие как \_ \_ флаг ASC \_ , выделенная память, можно проверить перед окончательным возвратом.

</dd> <dt>

*птстиместамп* \[ out, необязательно\]
</dt> <dd>

Указатель на структуру [**метки времени**](timestamp.md) , которая получает время окончания срока действия контекста. Рекомендуется, чтобы [*пакет безопасности*](../secgloss/s-gly.md) всегда возвращал это значение в местное время.

> [!Note]  
> До последнего вызова процесса проверки подлинности время истечения срока действия контекста может быть неправильным, поскольку на последующих этапах согласования будут предоставлены дополнительные сведения. Таким образом, *птстиместамп* должен иметь **значение NULL** до последнего вызова функции.

 

</dd> </dl>

## <a name="return-value"></a>Возвращаемое значение

Эта функция возвращает одно из следующих значений.



<table><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><thead><tr class="header"><th>Возвращаемый код и значение</th><th>Описание</th></tr></thead><tbody><tr class="odd"><td><dl> <dt><strong>SEC_E_INSUFFICIENT_MEMORY</strong></dt> <dt>0x80090300L</dt> </dl></td><td>Ошибка при выполнении функции. Недостаточно доступной памяти для завершения запрошенного действия.<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_E_INTERNAL_ERROR</strong></dt> <dt>0x80090304L</dt> </dl></td><td>Ошибка при выполнении функции. Произошла ошибка, которая не сопоставлена с кодом ошибки SSPI.<br/></td></tr><tr class="odd"><td><dl> <dt><strong>SEC_E_INVALID_HANDLE</strong></dt> <dt>0x80100003L</dt> </dl></td><td>Ошибка при выполнении функции. В функцию передан недопустимый маркер.<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_E_INVALID_TOKEN</strong></dt> <dt>0x80090308L</dt> </dl></td><td>Ошибка при выполнении функции. В функцию передан недопустимый токен.<br/></td></tr><tr class="odd"><td><dl> <dt><strong>SEC_E_LOGON_DENIED</strong></dt> <dt>0x8009030CL</dt> </dl></td><td>Ошибка входа в систему.<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_E_NO_AUTHENTICATING_AUTHORITY</strong></dt> <dt>0x80090311L</dt> </dl></td><td>Ошибка при выполнении функции. Не удалось связаться с центром сертификации для проверки подлинности. Это может быть вызвано следующими причинами.<br/><ul><li>Неверное доменное имя субъекта проверки подлинности.</li><li>Домен недоступен.</li><li>Не удалось установить отношение доверия.</li></ul></td></tr><tr class="odd"><td><dl> <dt><strong>SEC_E_OK</strong></dt> <dt>0x00000000</dt> </dl></td><td>Функция выполнена успешно. Был принят [*контекст безопасности*](../secgloss/s-gly.md) , полученный от клиента. Если выходная лексема была создана функцией, она должна быть отправлена в клиентский процесс.<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_I_COMPLETE_AND_CONTINUE</strong></dt> <dt>0x00090314L</dt> </dl></td><td>Функция выполнена успешно. Сервер должен вызвать [<strong>CompleteAuthToken</strong>] (/Windows/Win32/API/SSPI/NF-SSPI-completeauthtoken) и передать выходной токен клиенту. Затем сервер ждет возврата токена от клиента, а затем выполняет еще один вызов [<strong>AcceptSecurityContext (NTLM)</strong>] (AcceptSecurityContext--NTLM.md).<br/></td></tr><tr class="odd"><td><dl> <dt><strong>SEC_I_COMPLETE_NEEDED</strong></dt> <dt>0x00090313L</dt> </dl></td><td>Функция выполнена успешно. Сервер должен завершить создание сообщения от клиента, а затем вызвать функцию [<strong>CompleteAuthToken</strong>] (/Windows/Win32/API/SSPI/NF-SSPI-completeauthtoken).<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_I_CONTINUE_NEEDED</strong></dt> <dt>0x00090312L</dt> </dl></td><td>Функция выполнена успешно. Сервер должен отправить выходной токен клиенту и дождаться возвращенного маркера. Возвращаемый токен должен передаваться в <em>пинпут</em> для другого вызова [<strong>AcceptSecurityContext (NTLM)</strong>] (AcceptSecurityContext--NTLM.md).<br/></td></tr></tbody></table>



 

## <a name="remarks"></a>Комментарии

Функция **AcceptSecurityContext (NTLM)** является аналогом сервера функции [**InitializeSecurityContext (NTLM)**](initializesecuritycontext--ntlm.md) .

Когда сервер получает запрос от клиента, сервер использует параметр *фконтекстрек* , чтобы указать, что он требует для сеанса. Таким образом, сервер может указать, что клиенты должны иметь возможность использовать конфиденциальную сессию или сеанс с проверкой [*целостности*](../secgloss/i-gly.md), а также могут отклонять клиенты, которые не могут удовлетворить это требование. Кроме того, сервер может не потребовать ничего, а любой клиент, который может предоставить или требуется, возвращается в параметре *пфконтекстаттр* .

Для пакета, поддерживающего многоэтапную проверку подлинности, например взаимную проверку подлинности, вызывающая последовательность выглядит следующим образом:

1.  Клиент передает токен на сервер.
2.  В первый раз сервер вызывает **AcceptSecurityContext (NTLM)** , который создает маркер ответа, который затем отправляется клиенту.
3.  Клиент получает маркер и передает его в [**InitializeSecurityContext (NTLM)**](initializesecuritycontext--ntlm.md). Если **InitializeSecurityContext (NTLM)** Возвращает секунды \_ \_ , то выполнена взаимная проверка подлинности, и может начаться безопасный сеанс. Если **InitializeSecurityContext (NTLM)** возвращает код ошибки, согласование взаимной проверки подлинности завершается. В противном случае маркер безопасности, возвращенный **InitializeSecurityContext (NTLM)** , отправляется клиенту, а шаги 2 и 3 повторяются.

Параметры *фконтекстрек* и *пфконтекстаттр* представляют собой битовую маску, представляющую различные атрибуты контекста. Описание различных атрибутов см. в разделе [требования к контексту](context-requirements.md).

> [!Note]  
> Параметр *пфконтекстаттр* допустим при любом успешном возвращении, но только при окончательном успешном возвращении следует изучить флаги, относящиеся к аспектам безопасности контекста. Промежуточные возвраты могут задавать, например, \_ флаг « \_ Выделенная память ISC» \_ .

 

Вызывающий объект отвечает за определение того, достаточно ли атрибутов последнего контекста. Если, например, был запрошен параметр конфиденциальность (шифрование), но его не удалось установить, некоторые приложения могут немедленно завершить подключение. Если невозможно установить [*контекст безопасности*](../secgloss/s-gly.md) , сервер должен освободить частично созданный контекст, вызвав функцию [**делетесекуритиконтекст**](/windows/win32/api/sspi/nf-sspi-deletesecuritycontext) . Сведения о том, когда следует вызывать функцию **делетесекуритиконтекст** , см. в разделе **делетесекуритиконтекст**.

После установки [*контекста безопасности*](../secgloss/s-gly.md) серверное приложение может использовать функцию [**куерисекуритиконтексттокен**](/windows/win32/api/sspi/nf-sspi-querysecuritycontexttoken) для получения маркера учетной записи пользователя, которой сопоставлен сертификат клиента. Кроме того, сервер может использовать функцию [**имперсонатесекуритиконтекст**](/windows/win32/api/sspi/nf-sspi-impersonatesecuritycontext) для олицетворения пользователя.

## <a name="requirements"></a>Требования



| Требование | Значение |
|-------------------------------------|--------------------------------------------------------------------------------------------------------|
| Минимальная версия клиента<br/> | Только для \[ классических приложений Windows XP\]<br/>                                                            |
| Минимальная версия сервера<br/> | \[Только для настольных приложений Windows Server 2003\]<br/>                                                   |
| Header<br/>                   | <dl> <dt>SSPI. h (включая Security. h)</dt> </dl> |
| Библиотека<br/>                  | <dl> <dt>Secur32. lib</dt> </dl>                 |
| DLL<br/>                      | <dl> <dt>Secur32.dll</dt> </dl>                 |



## <a name="see-also"></a>См. также раздел

<dl> <dt>

[Функции SSPI](authentication-functions.md#sspi-functions)
</dt> <dt>

[**делетесекуритиконтекст**](/windows/win32/api/sspi/nf-sspi-deletesecuritycontext)
</dt> <dt>

[**InitializeSecurityContext (NTLM)**](initializesecuritycontext--ntlm.md)
</dt> </dl>

 

 
