---
description: Расшифровывает сообщение.
ms.assetid: ea271d0c-9167-41c5-8919-09611206fc71
title: Функция Декриптмессаже (General) (SSPI. h)
ms.topic: reference
ms.date: 07/25/2019
ms.openlocfilehash: 9dfbde6c0b4a8c46920428af3d7f700268f11690
ms.sourcegitcommit: 9b5faa61c38b2d0c432b7f2dbee8c127b0e28a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/19/2021
ms.locfileid: "122476920"
---
# <a name="decryptmessage-general-function"></a>Функция Декриптмессаже (общая)

Функция **декриптмессаже (общая)** расшифровывает сообщение. Некоторые пакеты не шифруют и не расшифровываются сообщения, а выполняют и проверяют [*хэш*](../secgloss/h-gly.md)целостности.

[*Поставщик поддержки*](../secgloss/s-gly.md) дайджеста безопасности (SSP) обеспечивает конфиденциальность шифрования и расшифровки сообщений, которыми обмениваются клиент и сервер, только как механизм SASL.

Эта функция также используется с поставщиком услуг безопасности SChannel для передачи запроса от отправителя сообщения для повторного согласования (повтора) атрибутов соединения или для завершения работы соединения.

> [!Note]  
> [**Енкриптмессаже (General)**](encryptmessage--general.md) и **декриптмессаже (General)** могут вызываться одновременно из двух разных потоков в одном контексте SSPI, если [*один поток*](../secgloss/s-gly.md) шифруется, а другой расшифровывается. При шифровании нескольких потоков или при расшифровке более одного потока каждый поток должен получить уникальный контекст.

 

Сведения об использовании этой функции с конкретным поставщиком общих служб см. в следующих разделах.



| Раздел                                                            | Описание                            |
|------------------------------------------------------------------|----------------------------------------|
| [**Декриптмессаже (дайджест)**](decryptmessage--digest.md)       | Расшифровывает сообщение с помощью дайджеста.    |
| [**Декриптмессаже (Kerberos)**](decryptmessage--kerberos.md)   | Расшифровывает сообщение с помощью протокола Kerberos.  |
| [**Декриптмессаже (согласование)**](decryptmessage--negotiate.md) | Расшифровывает сообщение с помощью Negotiate. |
| [**Декриптмессаже (NTLM)**](decryptmessage--ntlm.md)           | Расшифровывает сообщение с помощью NTLM.      |
| [**Декриптмессаже (Schannel)**](decryptmessage--schannel.md)   | Расшифровывает сообщение с помощью канала Schannel.  |



 

## <a name="syntax"></a>Синтаксис


```C++
SECURITY_STATUS SEC_Entry DecryptMessage(
  _In_    PCtxtHandle    phContext,
  _Inout_ PSecBufferDesc pMessage,
  _In_    ULONG          MessageSeqNo,
  _Out_   PULONG         pfQOP
);
```



## <a name="parameters"></a>Параметры

<dl> <dt>

*фконтекст* \[ окне\]
</dt> <dd>

Маркер [*контекста безопасности*](../secgloss/s-gly.md) , который будет использоваться для расшифровки сообщения.

</dd> <dt>

*пмессаже* \[ в, out\]
</dt> <dd>

Указатель на структуру [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc) . На входе структура ссылается на одну или несколько структур [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) . Один из них может иметь тип данных PVBUFFER \_ . Этот буфер содержит зашифрованное сообщение. Зашифрованное сообщение расшифровывается на месте, переписывая исходное содержимое его буфера.

При использовании дайджест-поставщика общих служб на входе структура ссылается на одну или несколько структур [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) . Один из них должен иметь тип PVBUFFER \_ Data или pvbuffer \_ Stream и должен содержать зашифрованное сообщение.

При использовании поставщика общих служб SChannel с контекстами, не ориентированными на соединение, в качестве входных данных структура должна содержать четыре структуры [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) . Ровно один буфер должен иметь тип данных PVBUFFER \_ и содержать зашифрованное сообщение, которое расшифровывается на месте. Оставшиеся буферы используются для вывода и должны иметь тип PVBUFFER \_ Empty. Для контекстов, ориентированных на соединение, \_ должен быть указан буфер типа данных pvbuffer, как указано для контекстов, не ориентированных на соединение. Кроме того, \_ необходимо также указать второй буфер типа токена pvbuffer, содержащий маркер безопасности.

</dd> <dt>

*Мессажесекно* \[ окне\]
</dt> <dd>

Порядковый номер, ожидаемый транспортным приложением (при наличии). Если транспортное приложение не поддерживает порядковые номера, этот параметр должен иметь значение 0.

При использовании дайджест-поставщика общих служб этот параметр должен иметь значение 0. Хэш-код дайджеста управляет нумерацией последовательности внутренним образом.

При использовании поставщика общих служб SChannel этот параметр должен иметь значение 0. Поставщик общих служб SChannel не использует порядковые номера.

</dd> <dt>

*пфкоп* \[ заполняет\]
</dt> <dd>

Указатель на переменную типа **ulong** , которая получает зависящие от пакета флаги, указывающие качество защиты.

При использовании поставщика общих служб SChannel этот параметр не используется и должен иметь значение **null**.

Этот параметр может иметь один из следующих флагов.




| Значение | Значение | 
|-------|---------|
| <span id="SECQOP_WRAP_NO_ENCRYPT"></span><span id="secqop_wrap_no_encrypt"></span><dl><dt><strong>SECQOP_WRAP_NO_ENCRYPT</strong></dt></dl> | Сообщение не было зашифровано, но был создан заголовок или трейлер.<br /><blockquote>[!Note]<br />KERB_WRAP_NO_ENCRYPT имеет то же значение и то же самое.</blockquote><br /> | 
| <span id="SIGN_ONLY_"></span><span id="sign_only_"></span><dl><dt><strong>SIGN_ONLY</strong></dt></dl> | При использовании дайджест-поставщика общих служб используйте этот флаг, если [*контекст безопасности*](../secgloss/s-gly.md) настроен на проверку только [*подписи*](../secgloss/s-gly.md) . Дополнительные сведения см. в разделе [качество защиты](quality-of-protection.md).<br /> | 




 

</dd> </dl>

## <a name="return-value"></a>Возвращаемое значение

Если функция проверяет, что сообщение было получено в правильной последовательности, функция возвращает значение в секунду \_ E \_ ОК.

Если функция не расшифрует сообщение, она возвращает один из следующих кодов ошибок.



| Код возврата                                                                                                    | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|----------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <dl> <dt>**\_ \_ \_ слишком \_ маленький буфер E с**</dt> </dl>      | Буфер сообщений слишком мал. Используется с дайджест-SSP.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| <dl> <dt>**с \_ е \_ . \_ неправильная система шифрования E \_**</dt> </dl> | [*Шифр*](../secgloss/c-gly.md) , выбранный для [*контекста безопасности*](../secgloss/s-gly.md) , не поддерживается. Используется с дайджест-SSP.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <dl> <dt>**с \_ \_ неполным \_ сообщением электронной почты**</dt> </dl>     | Данные во входном буфере неполны. Приложению необходимо прочитать больше данных с сервера и вызвать [**декриптмессаже (Общие)**](decryptmessage--general.md) еще раз.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| <dl> <dt>**c \_ E \_ Недопустимый \_ маркер**</dt> </dl>         | В параметре *фконтекст* указан недопустимый маркер контекста. Используется с дайджест-SSP и поставщиками SChannel.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <dl> <dt>**в секунду \_ E \_ Недопустимый \_ токен**</dt> </dl>          | Буферы имеют неверный тип или не найдены буфер типа \_ данных pvbuffer. Используется с поставщиком общих служб SChannel.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| <dl> <dt>**с \_ \_ измененным сообщением E \_**</dt> </dl>        | Сообщение было изменено. Используется с дайджест-SSP и поставщиками SChannel.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| <dl> <dt>**с \_ не \_ \_ по \_ порядку**</dt> </dl>       | Сообщение не было получено в правильной последовательности.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| <dl> <dt>**с \_ е \_ КОП \_ не \_ поддерживается**</dt> </dl>     | [*Контекст безопасности*](../secgloss/s-gly.md)не поддерживает ни конфиденциальность, ни [*целостность*](../secgloss/i-gly.md) . Используется с дайджест-SSP.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| <dl> <dt>**с \_ \_ \_ истекшим сроком действия контекста**</dt> </dl>        | Отправитель сообщения завершил использование подключения и инициировал завершение работы. Сведения об инициализации или распознавании выключения см. в разделе [Завершение работы подключения SChannel](shutting-down-an-schannel-connection.md). Используется с поставщиком общих служб SChannel.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| <dl> <dt>**с повторного \_ \_ согласования**</dt> </dl>             | Для удаленной стороны требуется новая последовательность подтверждения или приложение только что инициировало завершение работы. Вернитесь к циклу согласования и вызовите [**AcceptSecurityContext (General)**](acceptsecuritycontext--general.md) или [**InitializeSecurityContext (General)**](initializesecuritycontext--general.md), передав пустые Входные буферы. <br/> Если функция возвращает буфер буфера с типом " **\_ \_ дополнительный буфер**", он должен быть передан в функцию [**AcceptSecurityContext (General)**](acceptsecuritycontext--general.md) в качестве входного буфера.<br/> Используется с поставщиком общих служб SChannel.<br/> Повторное согласование не поддерживается для режима ядра SChannel. Вызывающий объект должен либо игнорировать это возвращаемое значение, либо завершить соединение. Если значение не пропускается, клиент или сервер могут завершить подключение в результате.<br/> |



 

## <a name="remarks"></a>Комментарии

При использовании поставщика общих служб SChannel функция **декриптмессаже (общая)** ВОЗВРАЩАЕТ значение с \_ \_ \_ истекшим сроком действия в секундах, когда отправитель сообщения отключил соединение. Сведения об инициализации или распознавании выключения см. в разделе [Завершение работы подключения SChannel](shutting-down-an-schannel-connection.md).

При использовании поставщика общих служб SChannel **декриптмессаже (Общие)** Возвращает секунду, \_ \_ когда отправитель сообщения желает повторно согласовать соединение ([*контекст безопасности*](../secgloss/s-gly.md)). Приложение обрабатывает запрошенное повторное согласование путем вызова [**AcceptSecurityContext (Общие)**](acceptsecuritycontext--general.md) (на стороне сервера) или [**InitializeSecurityContext (Общие)**](initializesecuritycontext--general.md) (на стороне клиента) и передачи пустых входных буферов. После того как этот начальный вызов вернет значение, продолжайте, как будто приложение создает новое соединение. Дополнительные сведения см. в разделе [Создание [*контекста безопасности*](../secgloss/s-gly.md)SChannel](creating-an-schannel-security-context.md).

Сведения о взаимодействии с GSSAPI см. [в статье взаимодействие между SSPI/Kerberos и GSSAPI](sspi-kerberos-interoperability-with-gssapi.md).

## <a name="requirements"></a>Требования



| Требование | Значение |
|-------------------------------------|--------------------------------------------------------------------------------------------------------|
| Минимальная версия клиента<br/> | Windows \[Только классические приложения XP\]<br/>                                                            |
| Минимальная версия сервера<br/> | Windows Только для \[ настольных приложений сервера 2003\]<br/>                                                   |
| Заголовок<br/>                   | <dl> <dt>SSPI. h (включая Security. h)</dt> </dl> |
| Библиотека<br/>                  | <dl> <dt>Secur32. lib</dt> </dl>                 |
| DLL<br/>                      | <dl> <dt>Secur32.dll</dt> </dl>                 |



## <a name="see-also"></a>См. также

<dl> <dt>

[Функции SSPI](authentication-functions.md#sspi-functions)
</dt> <dt>

[**Енкриптмессаже (Общие)**](encryptmessage--general.md)
</dt> <dt>

[**Pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer)
</dt> <dt>

[**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc)
</dt> </dl>

 

 
