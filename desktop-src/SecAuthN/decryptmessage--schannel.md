---
description: Расшифровывает сообщение с помощью канала Schannel.
ms.assetid: 5d7c8598-2d6b-4839-ae98-dff964bc962c
title: Функция Декриптмессаже (Schannel)
ms.topic: reference
ms.date: 07/25/2019
ms.openlocfilehash: 6bfbb354be9f3553e5369b8ce1f8b4260eab8ee9
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103808681"
---
# <a name="decryptmessage-schannel-function"></a>Функция Декриптмессаже (Schannel)

Функция **декриптмессаже (Schannel)** расшифровывает сообщение. Некоторые пакеты не шифруют и не расшифровываются сообщения, а выполняют и проверяют [*хэш*](../secgloss/h-gly.md)целостности.


Эта функция также используется вместе с поставщиком услуг [*безопасности*](../secgloss/s-gly.md#_SECURITY_SECURITY_SUPPORT_PROVIDER_GLY) SChannel для передачи запроса от отправителя сообщения о повторном согласовании (повтора) атрибутов соединения или при завершении соединения.

> [!Note]  
> [**Енкриптмессаже (Schannel)**](encryptmessage--schannel.md) и **декриптмессаже (Schannel)** могут быть вызваны одновременно из двух разных потоков в одном контексте SSPI, [*Если один поток*](../secgloss/s-gly.md#_SECURITY_SECURITY_SUPPORT_PROVIDER_INTERFACE_GLY) шифруется, а другой расшифровывается. При шифровании нескольких потоков или при расшифровке более одного потока каждый поток должен получить уникальный контекст.


## <a name="syntax"></a>Синтаксис

```C++
SECURITY_STATUS SEC_Entry DecryptMessage(
  _In_    PCtxtHandle    phContext,
  _Inout_ PSecBufferDesc pMessage,
  _In_    ULONG          MessageSeqNo,
  _Out_   PULONG         pfQOP
);
```

## <a name="parameters"></a>Параметры

*фконтекст* \[ окне\]


Маркер [*контекста безопасности*](../secgloss/s-gly.md#_SECURITY_SECURITY_CONTEXT_GLY) , который будет использоваться для расшифровки сообщения.

*пмессаже* \[ в, out\]

Указатель на структуру [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc) . На входе структура ссылается на одну или несколько структур [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) . Один из них может иметь тип данных PVBUFFER \_ . Этот буфер содержит зашифрованное сообщение. Зашифрованное сообщение расшифровывается на месте, переписывая исходное содержимое его буфера.

При использовании поставщика общих служб SChannel с контекстами, не ориентированными на соединение, в качестве входных данных структура должна содержать четыре структуры [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) . Ровно один буфер должен иметь тип данных PVBUFFER \_ и содержать зашифрованное сообщение, которое расшифровывается на месте. Оставшиеся буферы используются для вывода и должны иметь тип PVBUFFER \_ Empty. Для контекстов, ориентированных на соединение, \_ должен быть указан буфер типа данных pvbuffer, как указано для контекстов, не ориентированных на соединение. Кроме того, \_ необходимо также указать второй буфер типа токена pvbuffer, содержащий маркер безопасности.

*Мессажесекно* \[ окне\]

Порядковый номер, ожидаемый транспортным приложением (при наличии). Если транспортное приложение не поддерживает порядковые номера, этот параметр должен иметь значение 0.

При использовании поставщика общих служб SChannel этот параметр должен иметь значение 0. Поставщик общих служб SChannel не использует порядковые номера.

*пфкоп* \[ заполняет\]

Указатель на переменную типа **ulong** , которая получает зависящие от пакета флаги, указывающие качество защиты.

При использовании поставщика общих служб SChannel этот параметр не используется и должен иметь значение **null**.

Этот параметр может иметь следующий флаг.

<table><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><thead><tr class="header"><th>Значение</th><th>Значение</th></tr></thead><tbody><tr class="odd"><td><span id="SECQOP_WRAP_NO_ENCRYPT"></span><span id="secqop_wrap_no_encrypt"></span><dl> <dt><strong>SECQOP_WRAP_NO_ENCRYPT</strong></dt> </dl></td><td>Сообщение не было зашифровано, но был создан заголовок или трейлер.<br/><blockquote>[!Note]<br />
KERB_WRAP_NO_ENCRYPT имеет то же значение и то же самое.</blockquote><br/></td></tr></tbody></table>

## <a name="return-value"></a>Возвращаемое значение

Если функция проверяет, что сообщение было получено в правильной последовательности, функция возвращает значение в секунду \_ E \_ ОК.

Если функция не расшифрует сообщение, она возвращает один из следующих кодов ошибок.

| Код возврата                     | Описание                                                                                                    |
|---------------------------------|----------------------------------------------------------------------------------------------------------------|
| **c \_ E \_ Недопустимый \_ маркер**     | В параметре *фконтекст* указан недопустимый маркер контекста. Используется с поставщиком общих служб SChannel.     |
| **в секунду \_ E \_ Недопустимый \_ токен**      | Буферы имеют неверный тип или не найдены буфер типа \_ данных pvbuffer. Используется с поставщиком общих служб SChannel.  |
| **с \_ \_ измененным сообщением E \_**    | Сообщение было изменено. Используется с поставщиком общих служб SChannel.                                                      |
| **с \_ не \_ \_ по \_ порядку**   | Сообщение не было получено в правильной последовательности.                                                          |
| **с \_ \_ \_ истекшим сроком действия контекста**    | Отправитель сообщения завершил использование подключения и инициировал завершение работы. Сведения об инициализации или распознавании выключения см. в разделе [Завершение работы подключения SChannel](shutting-down-an-schannel-connection.md). Используется с поставщиком общих служб SChannel. |
| **с повторного \_ \_ согласования**         | Для удаленной стороны требуется новая последовательность подтверждения или приложение только что инициировало завершение работы. Вернитесь к циклу согласования и вызовите [**AcceptSecurityContext (Schannel)**](acceptsecuritycontext--schannel.md) или [**InitializeSecurityContext (Schannel)**](initializesecuritycontext--schannel.md), передайте SECBUFFER_EXTRA, возвращенные из декриптмессаже (). Повторное согласование не поддерживается для режима ядра SChannel. Вызывающий объект должен либо игнорировать это возвращаемое значение, либо завершить соединение. Если значение не пропускается, клиент или сервер могут завершить подключение в результате. |


## <a name="remarks"></a>Комментарии

Иногда приложение будет считывать данные от удаленной стороны, пытаться расшифровать их с помощью **декриптмессаже (Schannel)** и обнаружить, что **декриптмессаже (Schannel)** закончились, но выходные буферы пусты. Это нормальное поведение, и приложения должны уметь работать с ним.

При использовании поставщика общих служб SChannel функция [**декриптмессаже (общая)**](decryptmessage--general.md) ВОЗВРАЩАЕТ значение с \_ \_ \_ истекшим сроком действия в секундах, когда отправитель сообщения отключил соединение. Сведения об инициализации или распознавании выключения см. в разделе [Завершение работы подключения SChannel](shutting-down-an-schannel-connection.md).

Если вы используете TLS 1,0, может потребоваться несколько раз вызывать эту функцию, настраивая входной буфер при каждом вызове, чтобы расшифровать сообщение целиком.


Функция **декриптмессаже (Schannel)** Возвращает секунду, \_ \_ когда отправитель сообщения желает повторно согласовать соединение ([*контекст безопасности*](../secgloss/s-gly.md)). Приложение обрабатывает запрошенное повторное согласование путем вызова [**AcceptSecurityContext (Schannel)**](acceptsecuritycontext--schannel.md) (на стороне сервера) или [**InitializeSecurityContext (Schannel)**](initializesecuritycontext--schannel.md) (на стороне клиента) и передачи SECBUFFER_EXTRA возвращены из декриптмессаже (). После того как этот начальный вызов вернет значение, продолжайте, как будто приложение создает новое соединение. Дополнительные сведения см. в разделе [Создание контекста безопасности SChannel](creating-an-schannel-security-context.md).


## <a name="requirements"></a>Требования

| Требование | Значение |
|--------------------------|-------------------------------------------|
| Минимальная версия клиента | Только для \[ классических приложений Windows XP\]          |
| Минимальная версия сервера | \[Только для настольных приложений Windows Server 2003\] |
| Header                   | SSPI. h (включая Security. h)               |
| Библиотека                  | Secur32. lib                               |
| DLL                      | Secur32.dll                               |

## <a name="see-also"></a>См. также раздел

- [Функции SSPI](authentication-functions.md#sspi-functions)
- [**Енкриптмессаже (Schannel)**](encryptmessage--schannel.md)
- [**Pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer)
- [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc)
