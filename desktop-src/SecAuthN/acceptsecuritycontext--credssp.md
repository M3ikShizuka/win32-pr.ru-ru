---
description: Позволяет серверному компоненту транспортного приложения устанавливать контекст безопасности между сервером и удаленным клиентом.
ms.assetid: a53f733e-b646-4431-b021-a2c446308849
title: Функция AcceptSecurityContext (CredSSP)
ms.topic: article
ms.date: 07/25/2019
ms.openlocfilehash: df4c87274c3a19d9e4a028cde813801688ce1927d1a0b89dbe3a7e8633ce8b57
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119141697"
---
# <a name="acceptsecuritycontext-credssp-function"></a>Функция AcceptSecurityContext (CredSSP)

Функция **AcceptSecurityContext (CredSSP)** позволяет компоненту сервера транспортного приложения устанавливать контекст безопасности между сервером и удаленным клиентом. Удаленный клиент вызывает функцию [**InitializeSecurityContext (CredSSP)**](initializesecuritycontext--credssp.md) для запуска процесса установки контекста безопасности. Серверу может потребоваться один или несколько маркеров ответа от удаленного клиента для завершения установки контекста безопасности.

## <a name="syntax"></a>Синтаксис

```C++
SECURITY_STATUS SEC_ENTRY AcceptSecurityContext(
  _In_opt_    PCredHandle    phCredential,
  _In_opt_    PCtxtHandle    phContext,
  _In_opt_    PSecBufferDesc pInput,
  _In_        unsigned long  fContextReq,
  _In_        unsigned long  TargetDataRep,
  _Inout_opt_ PCtxtHandle    phNewContext,
  _Inout_opt_ PSecBufferDesc pOutput,
  _Out_       unsigned long  *pfContextAttr,
  _Out_opt_   PTimeStamp     ptsExpiry
);
```

## <a name="parameters"></a>Параметры

*фкредентиал* \[ в необязательное\]

Маркер учетных данных сервера. Чтобы получить этот обработчик, сервер вызывает функцию [**AcquireCredentialsHandle (CredSSP)**](acquirecredentialshandle--credssp.md) с \_ \_ \_ установленным флагом SECPKG CRED Inbound или SECPKG CRED \_ .

*фконтекст* \[ в необязательное\]

Указатель на структуру [кткссандле](sspi-handles.md) . При первом вызове метода **AcceptSecurityContext (CredSSP)** этот указатель имеет **значение NULL**. При последующих вызовах *фконтекст* указывает частично сформированный контекст, возвращенный в параметре *фневконтекст* при первом вызове.

*пинпут* \[ в необязательное\]

Указатель на структуру [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc) , созданную при вызове клиента в [**InitializeSecurityContext (CredSSP)**](initializesecuritycontext--credssp.md). Структура содержит дескриптор входного буфера.

Первый буфер должен иметь тип **\_ Token pvbuffer** и содержать маркер безопасности, полученный от клиента. Второй буфер должен иметь тип **pvbuffer \_ Empty**.

*фконтекстрек* \[ окне\]

Битовые флаги, указывающие атрибуты, необходимые серверу для установки контекста. Битовые флаги можно комбинировать с помощью операций побитового **или** . Этот параметр может принимать одно или несколько следующих значений.

| Значение                          | Значение                                                                                                                                                                                                        |
|--------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **по УБЫВАНИЮ \_ требований \_ выделить \_ память** | Поставщик поддержки безопасности учетных данных (CredSSP) будет выделять выходные буферы. Завершив использование выходных буферов, освободите их, вызвав функцию [**фриконтекстбуффер**](/windows/win32/api/sspi/nf-sspi-freecontextbuffer) . |
| **\_Подключение ASC req \_**       | Контекст безопасности не будет работать с сообщениями форматирования.                                                                                                                                                      |
| **\_ДЕЛЕГАТ ASC req \_**         | Серверу разрешено олицетворять клиента. Игнорировать этот флаг для ограниченного делегирования.                                                         |
| **\_ \_ Расширенная ошибка по убыванию требований \_**  | При возникновении ошибок удаленная сторона будет уведомлена.                                                                                                                                                          |
| **Обнаружение повторного \_ воспроизведения требований ASC \_ \_**   | Обнаружение воспроизводимых пакетов.                                                                                                                                                                                       |
| **\_ \_ Обнаружение последовательности "ASC req" \_** | Обнаружение сообщений, полученных за пределами последовательности.                                                                                                                                                                      |
| **\_поток требований \_ ASC**           | Поддерживать соединение с потоковой ориентацией.                                                                                                                                                                          |

Возможные флаги атрибутов и их значения см. в разделе [требования к контексту](context-requirements.md). Флаги, используемые для этого параметра, имеют префикс ASC \_ req, например, ASC \_ req \_ Delegate.

Запрошенные атрибуты могут не поддерживаться клиентом. Дополнительные сведения см. в описании параметра *пфконтекстаттр* .

*Таржетдатареп* \[ окне\]

Представление данных, например порядок байтов, на целевом объекте. Этот параметр может быть либо **\_ собственными \_ Дреп** , либо **безопасностью \_ сети \_ дреп**.

*фневконтекст* \[ в, out, необязательно\]

Указатель на структуру [кткссандле](sspi-handles.md) . При первом вызове метода **AcceptSecurityContext (CredSSP)** этот указатель получает новый обработчик контекста. При последующих вызовах *фневконтекст* может совпадать с маркером, указанным в параметре *фконтекст* .

*паутпут* \[ в, out, необязательно\]

Указатель на структуру [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc) , содержащую дескриптор выходного буфера. Этот буфер отправляется клиенту для ввода в дополнительные вызовы [**InitializeSecurityContext (CredSSP)**](initializesecuritycontext--credssp.md). Выходной буфер может быть создан, даже если функция возвращает значение в СЕКУНДах \_ \_ . Любой созданный буфер должен быть отправлен обратно клиентскому приложению.

На выходе этот буфер получает маркер для контекста безопасности. Маркер должен быть отправлен клиенту. Функция также может возвращать буфер типа PVBUFFER " \_ дополнительный".

*пфконтекстаттр* \[ заполняет\]

Указатель на набор битовых флагов, указывающих атрибуты установленного контекста. Описание различных атрибутов см. в разделе [требования к контексту](context-requirements.md). Флаги, используемые для этого параметра, имеют префикс ASC \_ RET, например, ASC \_ RET \_ Delegate.

Не проверяйте атрибуты, связанные с безопасностью, до тех пор, пока завершающий вызов функции не вернется успешно. Флаги атрибутов, не связанные с безопасностью, такие как \_ \_ флаг ASC \_ , выделенная память, можно проверить перед окончательным возвратом.

*птсекспири* \[ out, необязательно\]

Указатель на структуру [**метки времени**](timestamp.md) , которая получает время окончания срока действия контекста. Рекомендуется, чтобы пакет безопасности всегда возвращал это значение в местное время.

> [!Note]  
> До последнего вызова процесса проверки подлинности время истечения срока действия контекста может быть неправильным, поскольку на последующих этапах согласования будут предоставлены дополнительные сведения. Таким образом, *птстиместамп* должен иметь **значение NULL** до последнего вызова функции.

## <a name="return-value"></a>Возвращаемое значение

Эта функция возвращает одно из следующих значений.

| Возвращаемый код и значение                                   | Описание                                                                                                                                                                 |
|-----------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| SEC_E_INCOMPLETE_MESSAGE <br/> 0x80090318L          | Функция выполнена успешно. Данные во входном буфере неполны. Приложение должно считывать дополнительные данные из клиента и повторно вызывать [<strong>AcceptSecurityContext (CredSSP)</strong>](acceptsecuritycontext--credssp.md) . |
| SEC_E_INSUFFICIENT_MEMORY <br/> 0x80090300L         | Ошибка при выполнении функции. Недостаточно доступной памяти для завершения запрошенного действия.                                                                                 |
| SEC_E_INTERNAL_ERROR <br/> 0x80090304L              | Ошибка при выполнении функции. Произошла ошибка, которая не сопоставлена с кодом ошибки SSPI.                                                                                              |
| SEC_E_INVALID_HANDLE <br/> 0x80100003L              | Ошибка при выполнении функции. В функцию передан недопустимый маркер.                                                                                                        |
| SEC_E_INVALID_TOKEN <br/> 0x80090308L               | Ошибка при выполнении функции. В функцию передан недопустимый токен.                                                                                                         |
| SEC_E_LOGON_DENIED <br/> 0x8009030CL                | Ошибка входа в систему.                                                                                                                                                           |
| SEC_E_NO_AUTHENTICATING_AUTHORITY <br/> 0x80090311L | Ошибка при выполнении функции. Не удалось связаться с центром сертификации для проверки подлинности. Это может быть вызвано следующими причинами.<br/><ul><li>Неверное доменное имя субъекта проверки подлинности.</li><li>Домен недоступен.</li><li>Не удалось установить отношение доверия. |
| SEC_E_NO_CREDENTIALS <br/>0x8009030EL               | Ошибка при выполнении функции. Недопустимый обработчик учетных данных, указанный в параметре *фкредентиал* .                            |
| SEC_E_OK <br/> 0x00000000                          | Функция выполнена успешно. Был принят контекст безопасности, полученный от клиента. Если функция создала выходной токен, маркер должен быть отправлен клиентскому процессу. |
| SEC_E_UNSUPPORTED_FUNCTION <br/> 0x80090302L        | Ошибка при выполнении функции. Параметр *фконтекстрек* указал недопустимый флаг атрибута контекста (ASC_REQ_DELEGATE или ASC_REQ_PROMPT_FOR_CREDS).                       |
| SEC_I_COMPLETE_AND_CONTINUE <br/> 0x00090314L       | Функция выполнена успешно. Сервер должен вызвать [**CompleteAuthToken**](/windows/win32/api/sspi/nf-sspi-completeauthtoken) и передать выходной токен клиенту. После этого сервер должен дождаться возврата токена от клиента перед выполнением другого вызова [**AcceptSecurityContext (CredSSP)**](acceptsecuritycontext--credssp.md). |
| SEC_I_COMPLETE_NEEDED <br/> 0x00090313L             | Функция выполнена успешно. Сервер должен завершить создание сообщения от клиента перед вызовом [ **CompleteAuthToken**](/windows/win32/api/sspi/nf-sspi-completeauthtoken)                             |
| SEC_I_CONTINUE_NEEDED <br/> 0x00090312L             | Функция выполнена успешно. Сервер должен отправить выходной токен клиенту и дождаться возвращенного маркера. Возвращаемый токен должен передаваться в *пинпут* для другого вызова [**AcceptSecurityContext (CredSSP)**](acceptsecuritycontext--credssp.md).


## <a name="remarks"></a>Remarks

Функция **AcceptSecurityContext (CredSSP)** — это серверный аналог функции [**InitializeSecurityContext (CredSSP)**](initializesecuritycontext--credssp.md) .

Когда сервер получает запрос от клиента, он использует параметр *фконтекстрек* , чтобы указать, что он требует для сеанса. Таким образом, сервер может потребовать, чтобы клиенты могли использовать конфиденциальный сеанс или сессию с проверкой [*целостности*](../secgloss/i-gly.md). Он может отклонять клиенты, которые не могут удовлетворить это требование. Кроме того, серверу может потребоваться ничего. любой клиент, который требуется или может предоставить клиенту, возвращается в параметре *пфконтекстаттр* .

Параметры *фконтекстрек* и *пфконтекстаттр* представляют собой битовую маску, представляющую различные атрибуты контекста. Описание различных атрибутов см. в разделе [требования к контексту](context-requirements.md).

> [!Note]  
> Хотя параметр *пфконтекстаттр* допустим при любом успешном возвращении, следует проанализировать флаги, относящиеся к аспектам безопасности контекста, только в окончательном успешном возвращении. Промежуточные возвраты могут задавать, например, \_ флаг « \_ Выделенная память ISC» \_ .

Вызывающий объект отвечает за определение того, достаточно ли атрибутов последнего контекста. Например, если запрос шифрования (шифрование) был запрошен, но его не удалось установить, некоторые приложения могут немедленно завершить подключение. Если невозможно установить контекст безопасности, сервер должен освободить частично созданный контекст, вызвав функцию [**делетесекуритиконтекст**](/windows/win32/api/sspi/nf-sspi-deletesecuritycontext) . Сведения о том, когда следует вызывать функцию **делетесекуритиконтекст** , см. в разделе **делетесекуритиконтекст**.

После установки контекста безопасности серверное приложение может использовать функцию [**куерисекуритиконтексттокен**](/windows/win32/api/sspi/nf-sspi-querysecuritycontexttoken) для получения маркера учетной записи пользователя, которой сопоставлен сертификат клиента. Кроме того, сервер может использовать функцию [**имперсонатесекуритиконтекст**](/windows/win32/api/sspi/nf-sspi-impersonatesecuritycontext) для олицетворения пользователя.

## <a name="requirements"></a>Требования

| Требование | Значение |
|--------------------------|-------------------------------------------|
| Минимальная версия клиента | Windows \[ только классические приложения Vista\]       |
| Минимальная версия сервера | Windows Только для \[ настольных приложений сервера 2008\] |
| Заголовок                   | SSPI. h (включая Security. h)               |
| Библиотека                  | Secur32. lib                               |
| DLL                      | Secur32.dll                               |

## <a name="see-also"></a>См. также раздел

- [Функции SSPI](authentication-functions.md#sspi-functions)
- [**делетесекуритиконтекст**](/windows/win32/api/sspi/nf-sspi-deletesecuritycontext)
- [**InitializeSecurityContext (CredSSP)**](initializesecuritycontext--credssp.md)
