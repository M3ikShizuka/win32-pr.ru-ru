---
title: Пользовательские наборы шрифтов
description: В этом разделе описываются различные способы использования пользовательских шрифтов в приложении.
ms.assetid: 50842838-d150-df9a-f1b7-67ce5ea2bc80
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fb4b8b9c49895c2b137aaa33cf0788d9518a1d53834c74eb27feb6b44fa045d2
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118650288"
---
# <a name="custom-font-sets"></a>Пользовательские наборы шрифтов

В этом разделе описываются различные способы использования пользовательских шрифтов в приложении.

-   [Общие ](#introduction)
-   [Сводка API-интерфейсов](#summary-of-apis)
-   [Основные понятия](#key-concepts)
-   [Шрифты и форматы файлов шрифтов](#fonts-and-font-file-formats)
-   [Наборы шрифтов и коллекции шрифтов](#font-sets-and-font-collections)
-   [Распространенные сценарии](#common-scenarios)
    -   [Создание набора шрифтов с помощью произвольных шрифтов в локальной файловой системе](#creating-a-font-set-using-arbitrary-fonts-in-the-local-file-system)
    -   [Создание набора шрифтов с помощью известных шрифтов в локальной файловой системе](#creating-a-font-set-using-known-fonts-in-the-local-file-system)
    -   [Создание пользовательского набора шрифтов с помощью известных удаленных шрифтов в Интернете](#creating-a-custom-font-set-using-known-remote-fonts-on-the-web)
    -   [Создание пользовательского набора шрифтов с помощью данных шрифтов, загруженных в память](#creating-a-custom-font-set-using-font-data-loaded-into-memory)
-   [Расширенные сценарии](#advanced-scenarios)
    -   [Объединение наборов шрифтов](#combining-font-sets)
    -   [Использование локальных данных шрифта WOFF или WOFF2 ](#using-local-woff-or-woff2-font-data)
    -   [использование DirectWrite удаленных способов использования шрифтов с пользовательской реализацией низкого уровня сети](#using-directwrite-remote-font-mechanisms-with-custom-low-level-network-implementation)
    -   [поддержка сценариев в более ранних версиях Windows](#supporting-scenarios-on-earlier-windows-versions)

## <a name="introduction"></a>Введение

В большинстве случаев приложения используют шрифты, установленные локально в системе. DirectWrite предоставляет доступ к этим шрифтам с помощью методов [**IDWriteFactory3:: жетсистемфонтсет**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory3-getsystemfontset) или [**идвритефактори:: жетсистемфонтколлектион**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-getsystemfontcollection) . в некоторых случаях приложениям также может потребоваться использовать шрифты, включенные в состав Windows 10 но не установленные в текущей системе. доступ к таким шрифтам можно получить из службы Windows шрифтов с помощью метода **жетсистемфонтсет** или путем вызова [**IDWriteFactory3:: жетсистемфонтколлектион**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory3-getsystemfontcollection) с инклудедовнлоадаблефонтс set в TRUE. 

однако в некоторых сценариях приложений приложениям необходимо использовать шрифты, которые не установлены в системе и не предоставляются службой шрифтов Windows. Ниже приведены примеры таких сценариев.

-   Шрифты внедряются в виде ресурсов в двоичном файле приложения.
-   Файлы шрифтов упаковываются в пакет приложения и хранятся на диске в папке установки приложения.
-   Приложение — это средство разработки шрифтов, которое должно загружать файлы шрифтов, заданные пользователем. 
-   Шрифты внедряются в файлы документов, которые можно просматривать или изменять в приложении. 
-   Приложение использует шрифты, полученные из общедоступной службы веб-шрифтов. 
-   Приложение использует потоковую передачу данных с помощью протокола частной сети. 

DirectWrite предоставляет интерфейсы api для работы с пользовательскими шрифтами в этих и других похожих сценариях. Данные пользовательского шрифта могут поступать из файлов в локальной файловой системе; из удаленных облачных источников, доступ к которым осуществлялся по протоколу HTTP; или из произвольных источников после загрузки в буфер памяти. 

> [!Note]  
> хотя DirectWrite предоставила интерфейсы api для работы с пользовательскими шрифтами с момента Windows 7, новые api-интерфейсы были добавлены в Windows 10 и опять в Windows 10 Creators Update (предварительная версия сборки 15021 или более поздней версии), которые упрощают реализацию нескольких упомянутых сценариев. В этом разделе основное внимание уделяется интерфейсам API, доступным в Windows 10. для приложений, которые должны работать с более ранними версиями Windows, см. статью [пользовательские коллекции шрифтов (Windows 7/8)](custom-font-collections.md). 

 

## <a name="summary-of-apis"></a>Сводка API-интерфейсов

Эта статья посвящена функциональным возможностям, предоставляемым следующими интерфейсами API: 

-   Интерфейс [**идвритефонтсет**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontset)
-   Интерфейс [**идвритефонтсетбуилдер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder)
-   Интерфейс [**IDWriteFontSetBuilder1**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder1) 
-   Интерфейс [**идвритефонтфацереференце**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference)
-   Интерфейс [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile)
-   Метод [**идвритефактори:: креатефонтфилереференце**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-createfontfilereference) 
-   Метод [**идвритефактори:: креатекустомфонтфилереференце**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-createcustomfontfilereference) 
-   Методы [**IDWriteFactory3:: креатефонтфацереференце**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontresource-createfontfacereference) 
-   [**Дврите \_ Структура \_ свойства Font**](/windows/win32/api/dwrite_3/ns-dwrite_3-dwrite_font_property) 
-   [**Дврите \_ Перечисление \_ \_ идентификаторов свойств шрифтов**](/windows/win32/api/dwrite_3/ne-dwrite_3-dwrite_font_property_id) 
-   Интерфейс [**идвритефонтфилелоадер**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfileloader) 
-   Метод [**идвритефактори:: регистерфонтфилелоадер**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-registerfontfileloader) 
-   Метод [**идвритефактори:: унрегистерфонтфилелоадер**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-unregisterfontfileloader) 
-   Метод [**IDWriteFactory5:: креатеинмеморифонтфилелоадер**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory5-createinmemoryfontfileloader) 
-   Интерфейс [**идвритеинмеморифонтфилелоадер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteinmemoryfontfileloader) 
-   Метод [**IDWriteFactory5:: креатехттпфонтфилелоадер**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory5-createhttpfontfileloader) 
-   Интерфейс [**идвритеремотефонтфилелоадер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfileloader) 
-   Интерфейс [**идвритефонтдовнлоадкуеуе**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadqueue) 
-   Интерфейс [**идвритефонтдовнлоадлистенер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadlistener) 
-   Интерфейс [**идвритефонтфилестреам**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfilestream) 
-   Интерфейс [**идвритеремотефонтфилестреам**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfilestream) 
-   Интерфейс [**идвритеасинкресулт**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteasyncresult) 
-   Метод [**IDWriteFactory5:: анализеконтаинертипе**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory5-analyzecontainertype) 
-   Метод [**IDWriteFactory5:: унпаккфонтфиле**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory5-unpackfontfile) 

 

## <a name="key-concepts"></a>Основные понятия

чтобы понять DirectWrite интерфейсы api для работы с пользовательскими шрифтами, полезно понять концептуальную модель, которая опирается на эти api. Основные понятия будут описаны здесь. 

когда DirectWrite выполняет фактический макет текста или отрисовку, ему необходимо получить доступ к реальным данным шрифта. Объект начертания шрифта содержит фактические данные шрифта, которые должны существовать в локальной системе. Но для других операций, таких как проверка доступности определенного шрифта или представление выбора шрифта пользователю, все, что требуется, — это ссылка на определенный шрифт, а не фактические данные шрифта. в DirectWrite объект ссылки на шрифт содержит только сведения, необходимые для нахождение и создания экземпляра шрифта. поскольку ссылка на начертание шрифта не содержит фактических данных, DirectWrite может работать со ссылками на начертание шрифта, для которых фактические данные находятся в удаленном сетевом расположении, а также когда фактические данные являются локальными.

Набор шрифтов — это набор ссылок на начертание шрифта, а также некоторые базовые информационные свойства, которые можно использовать в ссылке на шрифт или в сравнении с другими шрифтами, например с именем семейства или со значением толщины шрифта. Фактические данные для различных шрифтов могут быть локальными, или же они могут быть удаленными или иметь несколько комбинаций.

Набор шрифтов можно использовать для получения соответствующего объекта коллекции шрифтов. Дополнительные сведения см. в разделе наборы шрифтов и коллекции шрифтов ниже. 

Интерфейс Идвритефонтсет предоставляет методы, позволяющие выполнять запросы для значений свойств, таких как имя семейства или начертание шрифта, или для ссылок на начертание шрифта, которые соответствуют определенным значениям свойств. После фильтрации до определенного выбора можно получить экземпляр интерфейса [**идвритефонтфацереференце**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference) с методами для загрузки (если фактические данные шрифта в настоящее время являются удаленными) для получения соответствующего объекта [**IDWriteFontFace3**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontface3) , который можно использовать для макета и отрисовки. 

Интерфейс Идвритефонтфиле полагается на каждое начертание шрифта или ссылку на начертание шрифта. Он представляет расположение файла шрифта и содержит два компонента: загрузчик файла шрифта и ключ файла шрифта. Загрузчик файлов шрифтов ([**идвритефонтфилелоадер**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfileloader)) используется для открытия файла при необходимости и возвращает поток с данными ([**идвритефонтфилестреам**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfilestream)). В зависимости от загрузчика данные могут находиться в локальном пути к файлу, удаленном URL-адресе или в буфере памяти. Ключ — это значение, определяемое загрузчиком, которое уникально определяет файл в контексте загрузчика, позволяя загрузчику искать данные и создавать для них поток. 

Пользовательские шрифты можно легко добавить в пользовательский набор шрифтов, который, в свою очередь, можно использовать для фильтрации или организации сведений о шрифтах в таких целях, как создание пользовательского интерфейса средства выбора шрифта. Набор шрифтов также можно использовать для создания коллекции шрифтов для использования в интерфейсах API более высокого уровня, таких как [**идвритетекстформат**](/windows/win32/api/dwrite/nn-dwrite-idwritetextformat) и [**идвритетекстлайаут**](/windows/win32/api/dwrite/nn-dwrite-idwritetextlayout). Интерфейс [**идвритефонтсетбуилдер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder) можно использовать для создания пользовательского набора шрифтов, включающего несколько пользовательских шрифтов. Его также можно использовать для создания пользовательского набора шрифтов, который смешивает пользовательские шрифты и шрифты, предоставленные системой. или, который смешивает шрифты с различными источниками для фактических данных — локальное хранилище, удаленные URL-адреса и память. 

Как уже упоминалось, ссылка на начертание шрифта может ссылаться на данные шрифтов в удаленном источнике, но данные должны быть локальными, чтобы получить объект начертания шрифта, который можно использовать для макета и отрисовки. Загрузка удаленных данных осуществляется с помощью очереди загрузки шрифтов. Приложения могут использовать интерфейс [**идвритефонтдовнлоадкуеуе**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadqueue) для постановки в очередь запросов на загрузку удаленных шрифтов для запуска процесса загрузки, а также для регистрации объекта [**идвритефонтдовнлоадлистенер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadlistener) , чтобы предпринять действия по завершении процесса загрузки. 

для большинства описываемых здесь интерфейсов DirectWrite предоставляет системные реализации. Единственным исключением является интерфейс [**идвритефонтдовнлоадлистенер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadlistener) , который реализуется приложением для выполнения действий, связанных с конкретным приложением, когда удаленные шрифты загружаются локально. Приложения могут быть причиной предоставления собственных пользовательских реализаций для некоторых других интерфейсов, хотя это будет необходимо только в определенных, более сложных сценариях. Например, приложению потребуется предоставить пользовательскую реализацию интерфейса [**идвритефонтфилелоадер**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfileloader) для управления файлами шрифтов в локальном хранилище, в котором используется формат контейнера WOFF2. Дополнительные сведения будут приведены ниже. 

## <a name="fonts-and-font-file-formats"></a>Шрифты и форматы файлов шрифтов

Еще одним ключевым понятием, которое полезно для понимания, является связь между отдельными шрифтами и файлами шрифтов, которые их содержат. Знакомство с файлом шрифтов OpenType (. ttf или. ОТФ), содержащим один шрифт. Но формат шрифта OpenType также позволяет коллекции шрифтов OpenType (. ТТК или. ОТК), которая представляет собой отдельный файл, содержащий несколько шрифтов. Файлы коллекций OpenType часто используются для больших шрифтов, которые тесно связаны и имеют одинаковые значения для некоторых данных шрифтов: комбинируя шрифты в одном файле, можно отменить дублирование общих данных. По этой причине начертание шрифта или начертание шрифта должно ссылаться не только на файл шрифта (или на эквивалентный источник данных), но и на тот общий случай, в котором файл может быть файлом коллекции. 

Для шрифтов, используемых в Интернете, данные шрифтов часто упаковываются в определенные форматы контейнеров, WOFF или WOFF2, которые обеспечивают сжатие данных шрифтов и некоторый уровень защиты от пиратства и нарушения лицензий на шрифты. Функционально, файл WOFF или WOFF2 эквивалентен шрифту OpenType или файлу коллекции шрифтов, но данные кодируются в другом формате, который требует распаковки, прежде чем их можно будет использовать. 

некоторые api DirectWrite могут работать с отдельными лицами шрифта, а другие api-интерфейсы могут обрабатывать файлы, которые могут содержать файлы коллекций OpenType, содержащие несколько лиц. Аналогично некоторые API-интерфейсы работают только с необработанными данными формата OpenType, в то время как другие интерфейсы API могут обрабатывать Упакованные форматы контейнеров WOFF и WOFF2. Эти сведения приведены в обсуждении ниже. 

## <a name="font-sets-and-font-collections"></a>Наборы шрифтов и коллекции шрифтов

Некоторые приложения могут быть реализованы для работы со шрифтами с помощью интерфейса [**идвритефонтколлектион**](/windows/win32/api/dwrite/nn-dwrite-idwritefontcollection) . Существует прямая корреспонденция между коллекцией шрифтов и набором шрифтов. Каждый из них может содержать одни и те же шрифты, но они представляются другой организации. Из любой коллекции шрифтов можно получить соответствующий набор шрифтов и наоборот.

При работе с несколькими пользовательскими шрифтами проще всего использовать интерфейс построителя наборов шрифтов, чтобы создать пользовательский набор шрифтов, а затем получить коллекцию шрифтов после создания набора шрифтов. Ниже подробно описан процесс создания пользовательского набора шрифтов. Чтобы получить интерфейс [**IDWriteFontCollection1**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontcollection1) из набора шрифтов, используется метод [**IDWriteFactory3:: креатефонтколлектионфромфонтсет**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory3-createfontcollectionfromfontset) .

Если приложение содержит объект коллекции и ему нужно получить соответствующий набор шрифтов, это можно сделать с помощью метода [**IDWriteFontCollection1::-font**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontcollection1-getfontset) . 

## <a name="common-scenarios"></a>Распространенные сценарии

В этом разделе описаны некоторые из наиболее распространенных сценариев, включающих пользовательские наборы шрифтов:

-   Создание пользовательского набора шрифтов с помощью произвольных шрифтов в путях в локальной файловой системе.
-   Создание пользовательского набора шрифтов с помощью известных шрифтов (возможно, Объединенных с приложением), которые хранятся в локальной файловой системе.
-   Создание пользовательского набора шрифтов с помощью известных удаленных шрифтов в Интернете.
-   Создание пользовательского набора шрифтов с использованием данных шрифта, загруженных в память.

полные реализации этих сценариев приведены в [примере DirectWrite пользовательские наборы шрифтов](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DirectWriteCustomFontSets/). Этот пример также иллюстрирует один более сложный сценарий для обработки данных шрифтов, упакованных в форматах контейнеров WOFF или WOFF2, которые будут рассмотрены ниже. 

### <a name="creating-a-font-set-using-arbitrary-fonts-in-the-local-file-system"></a>Создание набора шрифтов с помощью произвольных шрифтов в локальной файловой системе

При работе с произвольным набором файлов шрифтов в локальном хранилище метод [**IDWriteFontSetBuilder1:: аддфонтфиле**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) удобен, поскольку в одном вызове он может выполнять все грани шрифта в файле коллекции шрифтов OpenType, а также все экземпляры для шрифта переменной OpenType. он доступен в Windows 10 Creators Update (предварительная версия сборки 15021 или более поздней версии) и рекомендуется при наличии. 

Чтобы использовать этот метод, используйте следующий процесс.

<dl> 1. Начните с создания интерфейса <a href="/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory5">IDWriteFactory5</a> : 


```C++
IDWriteFactory5* pDWriteFactory; 
HRESULT hr = DWriteCreateFactory( 
  DWRITE_FACTORY_TYPE_SHARED, 
  __uuidof(IDWriteFactory5), 
  reinterpret_cast<IUnknown**>(&pDWriteFactory) 
); 
```



   
2. Используйте фабрику для получения интерфейса <a href=""></a> [**IDWriteFontSetBuilder1**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder1) : 


```C++
IDWriteFontSetBuilder1* pFontSetBuilder; 
if (SUCCEEDED(hr)) 
{ 
  hr = pDWriteFactory->CreateFontSetBuilder(&pFontSetBuilder); 
}  
                
```



  
3. Для каждого файла шрифта в локальной файловой системе создайте [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile) , ссылающийся на него: 


```C++
IDWriteFontFile* pFontFile; 
if (SUCCEEDED(hr)) 
{ 
  hr = pDWriteFactory->CreateFontFileReference(pFilePath, /* lastWriteTime*/ nullptr, &pFontFile); 
} 
```



   
4. Добавьте объект [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile) в конструктор набора шрифтов с помощью метода [**аддфонтфиле**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) : 


```C++
hr = pFontSetBuilder->AddFontFile(pFontFile); 
```

Если путь к файлу, указанный в вызове [**креатефонтфилереференце**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-createfontfilereference) , ссылается на нечто, отличное от поддерживаемого файла OpenType, то вызов [**АДДФОНТФИЛЕ**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) возвратит ошибку дврите \_ E \_ FILEFORMAT.

5. После добавления всех файлов в построитель набора шрифтов можно создать пользовательский набор шрифтов: 


```C++
IDWriteFontSet* pFontSet; 
hr = pFontSetBuilder->CreateFontSet(&pFontSet); 
```



   
</dl>

если приложение должно выполняться в Windows 10 версиях, предшествующих Windows 10 Creators Update, метод аддфонтфиле будет недоступен. Доступность можно обнаружить путем создания интерфейса [**IDWriteFactory3**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory3) , а затем с помощью QueryInterface, чтобы попытаться получить интерфейс [**IDWriteFactory5**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory5) . Если это происходит, то также будет доступен интерфейс [**IDWriteFontSetBuilder1**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder1) и метод [**аддфонтфиле**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) .

Если метод Аддфонтфиле недоступен, то для добавления отдельных гарнитур необходимо использовать метод [**идвритефонтсетбуилдер:: аддфонтфацереференце**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder-addfontfacereference(idwritefontfacereference)) . Чтобы разрешить использование файлов коллекций шрифтов OpenType, содержащих несколько лиц, метод [**идвритефонтфиле:: Analyze**](/windows/win32/api/dwrite/nf-dwrite-idwritefontfile-analyze) можно использовать для определения количества лиц, содержащихся в файле. Процесс выглядит следующим образом.

<dl> 1. Начните с создания интерфейса <a href="/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory3">IDWriteFactory3</a> : 


```C++
IDWriteFactory3* pDWriteFactory; 
HRESULT hr = DWriteCreateFactory( 
DWRITE_FACTORY_TYPE_SHARED, 
  __uuidof(IDWriteFactory5), 
  reinterpret_cast<IUnknown**>(&pDWriteFactory) 
); 
```



  
2. Используйте фабрику для получения интерфейса [**идвритефонтсетбуилдер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder) : 


```C++
IDWriteFontSetBuilder* pFontSetBuilder; 
if (SUCCEEDED(hr)) 
{ 
  hr = pDWriteFactory->CreateFontSetBuilder(&pFontSetBuilder); 
} 
```



  
3. Для каждого файла шрифта создайте [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile), как описано выше. 


```C++
IDWriteFontFile* pFontFile; 
if (SUCCEEDED(hr)) 
{ 
  hr = pDWriteFactory->CreateFontFileReference(pFilePath, /* lastWriteTime*/ nullptr, &pFontFile); 
} 
```



Вместо того чтобы добавлять файл непосредственно в построитель набора шрифтов, необходимо определить количество граней и создать отдельные объекты [**идвритефонтфацереференце**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference) .   
4. Чтобы получить количество лиц в файле, используйте метод [**Analyze**](/windows/win32/api/dwrite/nf-dwrite-idwritefontfile-analyze) . 


```C++
BOOL isSupported; 
DWRITE_FONT_FILE_TYPE fileType; 
UINT32 numberOfFonts; 
hr = pFontFile->Analyze(&isSupported, &fileType, /* face type */ nullptr, &numberOfFonts); 
```



Метод [**Analyze**](/windows/win32/api/dwrite/nf-dwrite-idwritefontfile-analyze) также задает значения для параметров support и filetype. Если формат файла не поддерживается, то поддерживается значение FALSE и выполняется соответствующее действие, например игнорирование файла.   
5. Перебрать число шрифтов, заданных в параметре Нумбероффонтс. В цикле создайте [**идвритефонтфацереференце**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference) для каждой пары "файл-индекс" и добавьте их в конструктор набора шрифтов. 


```C++
for (uint32_t fontIndex = 0; fontIndex < numberOfFonts; fontIndex++) 
{ 
  IDWriteFontFaceReference* pFontFaceReference;
  hr = pDWriteFactory->CreateFontFaceReference(pFontFile, fontIndex, DWRITE_FONT_SIMULATIONS_NONE, &pFontFaceReference);

  if (SUCCEEDED(hr))
  {
    hr = pFontSetBuilder->AddFontFaceReference(pFontFaceReference);
  }
} 
```



  
6. После добавления всех граней в построитель набора шрифтов создайте пользовательский набор шрифтов, как показано выше.  
</dl>

приложение может быть спроектировано таким образом, чтобы оно использовало предпочтительный метод [**аддфонтфиле**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) при выполнении на Windows 10 Creators Update, но при работе в более ранних версиях Windows 10 будет возвращаться к использованию метода [**аддфонтфацереференце**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder-addfontfacereference(idwritefontfacereference)) . Проверьте доступность интерфейса [**IDWriteFactory5**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory5) , как описано выше, а затем создайте ветвь соответствующим образом. этот подход проиллюстрирован в [примере пользовательских наборов шрифтов DirectWrite](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DirectWriteCustomFontSets/). 

### <a name="creating-a-font-set-using-known-fonts-in-the-local-file-system"></a>Создание набора шрифтов с помощью известных шрифтов в локальной файловой системе

Как упоминалось выше, каждая ссылка на начертание шрифта в наборе шрифтов связана с определенными информационными свойствами, такими как имя семейства и плотность шрифта. При добавлении пользовательских шрифтов к построителю набора шрифтов с помощью приведенных выше вызовов API эти информационные свойства получаются непосредственно из фактических данных шрифта, которые считываются при добавлении шрифта. Однако в некоторых ситуациях, если у приложения есть другой источник информации о шрифте, может потребоваться предоставить собственные пользовательские значения для этих свойств. 

В качестве примера того, как это может быть полезно, предположим, что приложение объединяет некоторые шрифты, используемые для представления определенных элементов пользовательского интерфейса в приложении. Иногда может потребоваться изменить конкретные шрифты, используемые приложением для этих элементов, например, с новой версией приложения. Если в приложении закодированы ссылки на определенные шрифты, то замена одного шрифта на другой может потребовать изменения каждой из этих ссылок. Вместо этого, если приложение использует пользовательские свойства для назначения функциональных псевдонимов на основе типа отображаемого элемента или текста, сопоставляет каждый псевдоним с конкретным шрифтом в одном месте, а затем использует Псевдонимы во всех контекстах, где создаются и обрабатываются шрифты, а затем замена одного шрифта на другой требует только изменения одного места, где псевдоним сопоставляется с конкретным шрифтом. 

Пользовательские значения для информационных свойств могут быть назначены при вызове метода [**идвритефонтсетбуилдер:: аддфонтфацереференце**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder-addfontfacereference(idwritefontfacereference)) . Для этого используется следующий метод. его можно использовать в любой версии Windows 10. 

Как показано выше, начните с получения интерфейсов [**IDWriteFactory3**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory3) и [**идвритефонтсет**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontset) . Для добавления каждого пользовательского начертания шрифта создайте [**идвритефонтфацереференце**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference), как показано выше. Однако перед добавлением к построителю набора шрифтов (в цикле на шаге 5, показанном выше), приложение определяет используемые значения настраиваемых свойств. 

Набор значений пользовательских свойств определяется с помощью массива структур [**\_ \_ свойств Font дврите**](/windows/win32/api/dwrite_3/ns-dwrite_3-dwrite_font_property) . Каждый из них определяет определенное свойство из перечисления с [**\_ \_ \_ идентификатором свойства Font дврите**](/windows/win32/api/dwrite_3/ne-dwrite_3-dwrite_font_property_id) и соответствующее значение свойства, которое будет использоваться.  

Обратите внимание, что все значения свойств присваиваются в виде строк. Если впоследствии они будут отображаться для пользователей, можно задать альтернативные значения для данного свойства для разных языков, но это не является обязательным. Также обратите внимание, что если в приложении заданы значения пользовательских свойств, то в наборе шрифтов будут использоваться только указанные значения. DirectWrite не будет наследовать никакие значения непосредственно от шрифта для информационных свойств, используемых в наборе шрифтов. 

В следующем примере определяются пользовательские значения для трех информационных свойств: имя семейства, полное имя и плотность шрифта. 


```C++
DWRITE_FONT_PROPERTY props[] = 
{ 
  { DWRITE_FONT_PROPERTY_ID_FAMILY_NAME, L"My Icon Font", L"en-US" }, 
  { DWRITE_FONT_PROPERTY_ID_FULL_NAME, L"My Icon Font", L"en-US" }, 
  { DWRITE_FONT_PROPERTY_ID_WEIGHT, L"400", nullptr } 
}; 
               
            
```



После определения требуемого массива значений свойств для шрифта выполните вызов Аддфонтфацерефенце, передав массив свойств, а также ссылку на начертание шрифта. 


```C++
hr = pFontSetBuilder->AddFontFaceReference(pFontFaceReference, props, ARRAYSIZE(props)); 
```



 

После добавления всех пользовательских шрифтов к построителю набора шрифтов вместе со своими пользовательскими свойствами создайте пользовательский набор шрифтов, как показано выше. 

### <a name="creating-a-custom-font-set-using-known-remote-fonts-on-the-web"></a>Создание пользовательского набора шрифтов с помощью известных удаленных шрифтов в Интернете

Пользовательские свойства важны для работы с удаленными шрифтами. Каждая ссылка на начертание шрифта должна иметь некоторые информационные свойства, характеризующие шрифт и отличающие его от других шрифтов. так как данные шрифтов для удаленных шрифтов не являются локальными, DirectWrite не может наследовать свойства непосредственно из данных шрифта. Следовательно, свойства должны предоставляться явно при добавлении удаленного шрифта в построитель набора шрифтов.

Последовательность вызовов API для добавления удаленных шрифтов к набору шрифтов аналогична последовательности, описанной в предыдущем сценарии. Поскольку данные шрифта являются удаленными, операции, связанные с чтением фактических данных шрифта, будут отличаться, чем при работе с файлами в локальном хранилище. В этой ситуации в Windows 10 Creators Update добавлен новый интерфейс более низкого уровня [**идвритеремотефонтфилелоадер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfileloader). 

чтобы использовать загрузчик файлов удаленного шрифта, его необходимо сначала зарегистрировать в фабрике DirectWrite. Загрузчик должен удерживаться в приложении до тех пор, пока используются шрифты, связанные с ним. После того как шрифты больше не используются и в некоторый момент до уничтожения фабрики, необходимо отменить регистрацию загрузчика. Это можно сделать в деструкторе для класса, владеющего объектом Loader. Эти действия будут показаны ниже. 

Ниже приведен метод создания пользовательского набора шрифтов с использованием удаленных шрифтов. для этого требуется Windows 10 Creators Update.  

<dl> 1. Создайте интерфейс IDWriteFactory5, как показано выше.   
2. Создайте интерфейс <a href="/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder">идвритефонтсетбуилдер</a> , как показано выше.   
3. Используйте фабрику для получения <a href="/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfileloader">идвритеремотефонтфилелоадер</a>. 


```C++
IDWriteRemoteFontFileLoader* pRemoteFontFileLoader; 
if (SUCCEEDED(hr)) 
{ 
    hr = pDWriteFactory->CreateHttpFontFileLoader( 
        /* referrerURL */ nullptr, 
        /* extraHeaders */ nullptr, 
        &pRemoteFontFileLoader 
    ); 
} 
```



Он возвращает предоставляемую системой реализацию интерфейса удаленного загрузчика файлов шрифтов, которая может управлять HTTP-взаимодействием для загрузки данных шрифтов от имени приложения. URL-адрес источника ссылки или дополнительные заголовки можно указать, если это требуется для службы шрифтов или служб, которые являются источником для шрифтов.    

> [!IMPORTANT]
> Примечание о безопасности. при попытке получить удаленный шрифт злоумышленник может подменить предполагаемый сервер, который будет вызываться. В этом случае URL-адреса целевого объекта и источника ссылки и сведения о заголовке будут раскрываться злоумышленнику. Разработчики приложений несут ответственность за устранение этого риска. Рекомендуется использовать протокол HTTPS, а не HTTP. 

 

Для нескольких шрифтов можно использовать один удаленный загрузчик файлов шрифтов, хотя при получении шрифтов из нескольких служб с разными требованиями к URL-адресу ссылки или дополнительным заголовкам можно использовать разные загрузчики.   
4. Зарегистрируйте загрузчик файлов удаленного шрифта с фабрикой. 


```C++
 if (SUCCEEDED(hr)) 
 { 
     hr = pDWriteFactory->RegisterFontFileLoader(pRemoteFontFileLoader); 
 } 
```



С этого момента действия по созданию пользовательского набора шрифтов похожи на те, которые описаны для известных локальных файлов шрифтов, с двумя важными исключениями. Во-первых, объект [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile) создается с помощью удаленного интерфейса загрузчика файлов шрифтов вместо использования фабрики. Во-вторых, метод Analyze нельзя использовать, так как данные шрифта не являются локальными. Вместо этого приложение должно определить, является ли файл удаленного шрифта файлом коллекции шрифтов OpenType, и если да, то он должен определить, какой из шрифтов в коллекции будет использоваться, и индекс для каждого из них. Таким образом, оставшиеся шаги приведены ниже.   
5. Для каждого удаленного файла шрифтов используйте удаленный интерфейс загрузчика файлов шрифтов для создания [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile), указав URL-адрес, необходимый для доступа к файлу шрифта. 


```C++
 IDWriteFontFile* pFontFile; 
 hr = pRemoteFontFileLoader->CreateFontFileReferenceFromUrl( 
     pDWriteFactory, 
     /* baseUrl */ L"https://github.com/", 
     /* fontFileUrl */ L"winjs/winjs/blob/master/src/fonts/Symbols.ttf?raw=true", 
     &pFontFile 
 ); 
```



Обратите внимание, что полный URL-адрес может быть указан в параметре Фонтфилеурл, или его можно разделить на базовые и относительные части. если указан базовый url-адрес, то объединение значений baseUrl и фонтфилеурл должно предоставить полный URL-адрес — DirectWrite не предоставит никаких дополнительных разделителей.  

> [!IMPORTANT]
> примечание о безопасности и производительности. при попытке получения удаленного шрифта не гарантируется, что Windows получит ответ от сервера. В некоторых случаях сервер может ответить с ошибкой "файл не найден" для недопустимого относительного URL-адреса, но перестает отвечать, если он получает несколько недопустимых запросов. если сервер не отвечает, Windows в конечном итоге истечет время ожидания, хотя это может занять несколько минут, если инициируется несколько выборок. Необходимо сделать так, чтобы URL-адреса стали действительными при выполнении вызовов. 

 

Также обратите внимание, что URL-адрес может указывать на необработанный файл шрифта OpenType (. ttf,. ОТФ,. ТТК,. ОТК), но он также может указывать на шрифты в файле контейнера WOFF или WOFF2. если имеется ссылка на файл WOFF или WOFF2, то DirectWriteная реализация загрузчика файлов удаленного шрифта автоматически выполнит распаковку данных шрифта из файла контейнера.   
6. Для каждого индекса начертания шрифта в используемом удаленном файле шрифта создайте [**идвритефонтфацереференце**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference). 


```C++
 IDWriteFontFaceReference* pFontFaceReference; 
 hr = pDWriteFactory->CreateFontFaceReference(pFontFile, /* faceIndex */ 0, DWRITE_FONT_SIMULATIONS_NONE, &pFontFaceReference);
```



  
7. Определите пользовательские свойства для начертания шрифта, как показано выше.   
8. Добавьте ссылку на шрифт и пользовательские свойства в конструктор набора шрифтов, как показано выше.   
9. После добавления всех шрифтов в построитель набора шрифтов создайте набор шрифтов, как показано выше.   
10. В некоторый момент, когда удаленные шрифты больше не используются, отмените регистрацию удаленного загрузчика файлов шрифтов. 


```C++
hr = pDWriteFactory->UnregisterFontFileLoader(pRemoteFontFileLoader); 
```



  
</dl>

После создания пользовательского набора шрифтов с настраиваемыми удаленными шрифтами набор шрифтов содержит ссылки и информационные свойства для удаленных шрифтов, но фактические данные все еще являются удаленными. DirectWrite поддержка удаленных шрифтов позволяет поддерживать ссылку на шрифт в наборе шрифтов, а также выбирать шрифт для использования в макете и подготовке к просмотру, но фактические данные не загружаются до фактического использования, например, когда будет выполняться макет текста.  

приложение может использовать внешний подход, запрашивая, что DirectWrite загрузить данные шрифта и затем подождать подтверждения успешной загрузки, прежде чем начнется обработка с помощью шрифта. Однако загрузка по сети подразумевает некоторую задержку в непредсказуемом состоянии, и успешное выполнение также не имеет значения. По этой причине, как правило, лучше использовать другой подход, позволяя макету и подготовке к просмотру изначально использовать альтернативные или резервные шрифты, которые уже являются локальными, при запросе загрузки требуемого удаленного шрифта и последующем обновлении результатов после загрузки нужного шрифта. 

Чтобы запрашивать загрузку всего шрифта перед его использованием, можно использовать метод [**идвритефонтфацереференце:: енкуеуефонтдовнлоадрекуест**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontfacereference-enqueuefontdownloadrequest) . Если шрифт слишком большой, для обработки определенных строк может потребоваться только часть данных. DirectWrite предоставляет дополнительные методы, которые можно использовать для запроса частей данных шрифта, необходимых для конкретного содержимого, [**енкуеуечарактердовнлоадрекуест**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontfacereference-enqueuecharacterdownloadrequest) и [**енкуеуеглифдовнлоадрекуест**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontfacereference-enqueueglyphdownloadrequest).  

Предположим, что подход, выполняемый в приложении, заключается в том, чтобы разрешить изначальное выполнение обработки с использованием локальных, альтернативных или резервных шрифтов. Метод Идвритефонтфаллбакк::[**мапчарактерс**](idwritefontfallback-mapcharacters.md) можно использовать для задания локальных резервных шрифтов. Кроме того, он автоматически заставит в очередь запрос на загрузку предпочтительного шрифта. кроме того, если используется [**идвритетекстлайаут**](/windows/win32/api/dwrite/nn-dwrite-idwritetextlayout) и часть или весь текст в макете отформатированы с использованием удаленной ссылки на шрифт, то DirectWrite будет автоматически использовать метод **мапчарактерс** для получения локальных шрифтов отката и постановки запроса на загрузку удаленных данных шрифта. 

DirectWrite поддерживает очередь загрузки шрифтов для каждой фабрики, и запросы, выполненные с помощью упомянутых выше методов, добавляются в эту очередь. Очередь загрузки шрифтов можно получить с помощью метода [**IDWriteFactory3:: жетфонтдовнлоадкуеуе**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory3-getfontdownloadqueue) . 

Если запрос на загрузку выполнен, но данные шрифта уже являются локальными, это приведет к невыполнению операции: в очередь загрузки ничего не будет добавлено. Приложение может проверить, пуста ли очередь, или нет ожидающих запросов на скачивание, вызвав метод [**идвритефонтдовнлоадкуеуе:: IsEmpty**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontdownloadqueue-isempty) . 

После добавления в очередь запросов удаленного шрифта необходимо запустить процесс загрузки. Если в [**идвритетекстлайаут**](/windows/win32/api/dwrite/nn-dwrite-idwritetextlayout)используются удаленные шрифты, загрузка будет инициирована автоматически, когда приложение вызывает методы **идвритетекстлайаут** , которые выполняют операции макета или отрисовки, такие как методы жетлинеметрикс или Draw. В других сценариях приложение должно инициировать загрузку напрямую путем вызова [**идвритефонтдовнлоадкуеуе:: BeginDownload**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontdownloadqueue-begindownload).  

После завершения скачивания приложение будет выполнять необходимые действия — продолжить работу с ожидающими операциями или повторить операции, которые изначально были выполнены с помощью резервных шрифтов. (если используется макет текста DirectWrite, можно использовать [**IDWriteTextLayout3:: инвалидателайаут**](idwritetextlayout3-invalidatelayout.md) для очистки временных результатов, вычисленных с помощью резервных шрифтов.) Чтобы приложение было уведомлено о завершении процесса загрузки и предпринять соответствующие действия, приложение должно предоставить реализацию интерфейса [**идвритефонтдовнлоадлистенер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadlistener) и передать его в вызов BeginDownload. 

> [!IMPORTANT]
> примечание о безопасности и производительности. при попытке получения удаленного шрифта не гарантируется, что Windows получит ответ от сервера. если сервер не отвечает, Windows в конечном итоге истечет время ожидания, хотя это может занять несколько минут, если несколько удаленных шрифтов будут выбраны, но не будут работать. Вызов BeginDownload будет возвращаться немедленно. Приложения не должны блокировать пользовательский интерфейс при ожидании вызова [**идвритефонтдовнлоадлистенер::D овнлоадкомплетед**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontdownloadlistener-downloadcompleted) . 

 

примеры реализации этих взаимодействий с очередью загрузки шрифтов DirectWrite и интерфейсом [**идвритефонтдовнлоадлистенер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadlistener) можно увидеть в [примере DirectWrite пользовательские наборы шрифтов](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DirectWriteCustomFontSets/), а также в [примере DirectWrite загружаемые шрифты](https://github.com/Microsoft/Windows-universal-samples/tree/master/Samples/DWriteTextLayoutCloudFont). 

### <a name="creating-a-custom-font-set-using-font-data-loaded-into-memory"></a>Создание пользовательского набора шрифтов с помощью данных шрифтов, загруженных в память

Так же как низкоуровневые операции чтения данных из файла шрифта отличаются для файлов на локальном диске и удаленных файлов в Интернете, то же самое справедливо и для данных шрифтов, загружаемых в буфер памяти. новый интерфейс низкого уровня для обработки данных шрифта в памяти был добавлен в Windows 10 Creators Update [**идвритеинмеморифонтфилелоадер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteinmemoryfontfileloader). 

как и в случае с удаленным загрузчиком файлов шрифтов, загрузчик файлов шрифтов в памяти сначала должен быть зарегистрирован в фабрике DirectWrite. Загрузчик должен удерживаться в приложении до тех пор, пока используются шрифты, связанные с ним. После того как шрифты больше не используются и в некоторый момент до уничтожения фабрики, необходимо отменить регистрацию загрузчика. Это можно сделать в деструкторе для класса, владеющего объектом Loader. Эти действия будут показаны ниже. 

Если приложение имеет отдельные сведения о шрифтах, представленных данными, он может добавить отдельные ссылки на шрифт в построитель набора шрифтов с заданными пользовательскими свойствами. Поскольку данные шрифта находятся в локальной памяти, это не является обязательным. DirectWrite смогут считывать данные напрямую для получения значений свойств. 

DirectWrite предполагает, что данные шрифта находятся в формате raw (формат opentype), эквивалентном файлу opentype (. ttf,. отф,. ттк,. отк), но в памяти, а не на диске. Данные не могут быть в формате контейнера WOFF или WOFF2. Данные могут представлять коллекцию шрифтов OpenType. Если пользовательские свойства не используются, метод [**IDWriteFontSetBuilder1:: аддфонтфиле**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) можно использовать для добавления в данные всех начертаний шрифтов в одном вызове. 

Важным моментом для сценария в памяти является время существования данных. если указатель на буфер предоставлен для DirectWrite без четкого указания на наличие владельца, DirectWrite скопирует данные в новый буфер памяти, который будет владеть. Чтобы избежать копирования данных и дополнительного выделения памяти, приложение может передать объект владельца данных, реализующий IUnknown, и который владеет буфером памяти, содержащим данные шрифта. реализуя этот интерфейс, DirectWrite может добавить к счетчику ссылок объекта, тем самым гарантируя время существования принадлежащих данных. 

Метод создания пользовательского набора шрифтов с использованием данных шрифта в памяти выглядит следующим образом. для этого требуется Windows 10 Creators Update. Предполагается, что реализованный приложением объект-владелец данных, реализующий IUnknown, а также методы, возвращающие указатель на буфер памяти и размер буфера. 

<dl> 1. Создайте интерфейс IDWriteFactory5, как показано выше.  
2. Создайте интерфейс [**IDWriteFontSetBuilder1**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder1) , как показано выше.  
3. Используйте фабрику для получения Идвритеинмеморифонтфилелоадер. 


```C++
 IDWriteInMemoryFontFileLoader* pInMemoryFontFileLoader; 
if (SUCCEEDED(hr)) 
{ 
    hr = pDWriteFactory->CreateInMemoryFontFileLoader(&pInMemoryFontFileLoader); 
}
```



Это возвращает системную реализацию интерфейса загрузчика файлов шрифтов в памяти.   
4. Зарегистрируйте загрузчик файлов шрифтов в памяти с фабрикой. 


```C++
if (SUCCEEDED(hr)) 
{ 
    hr = pDWriteFactory->RegisterFontFileLoader(pInMemoryFontFileLoader); 
}
```



   
5. Для каждого файла шрифта в памяти используйте загрузчик файлов шрифтов в памяти для создания [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile). 


```C++
IDWriteFontFile* pFontFile; 
hr = pInMemoryFontFileLoader->CreateInMemoryFontFileReference( 
    pDWriteFactory, 
    pFontDataOwner->fontData /* returns void* */, 
    pFontDataOwner->fontDataSize /* returns UINT32 */, 
    pFontDataOwner /* ownerObject, owns the memory with font data and implements IUknown */, 
    &pFontFile 
); 
```



   
6. Добавьте объект [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile) в конструктор набора шрифтов с помощью метода [**аддфонтфиле**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) , как показано выше.  При необходимости приложение может создавать отдельные объекты [**идвритефонтфацереференце**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference) на основе **идвритефонтфиле**, при необходимости определять пользовательские свойства для каждой ссылки на шрифт, а затем добавлять ссылку на начертание шрифта с пользовательскими свойствами в набор шрифтов с помощью метода [**аддфонтфацереференце**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder-addfontfacereference(idwritefontfacereference)) , как показано выше.   
7. После добавления всех шрифтов в построитель набора шрифтов создайте пользовательский набор шрифтов, как показано выше.   
8. В какой-то момент, когда шрифты в памяти больше не используются, отмените регистрацию загрузчика файлов шрифтов в памяти. 


```C++
hr = pDWriteFactory->UnregisterFontFileLoader(pInMemoryFontFileLoader);
```



  
</dl>

 

## <a name="advanced-scenarios"></a>Расширенные сценарии

Некоторые приложения могут иметь особые требования, требующие более сложной обработки, чем описано выше. 

### <a name="combining-font-sets"></a>Объединение наборов шрифтов

Некоторым приложениям может потребоваться создать набор шрифтов, состоящий из сочетания элементов из других наборов шрифтов. Например, приложению может потребоваться создать набор шрифтов, который объединяет все шрифты, установленные в системе, с помощью выбора пользовательских шрифтов или комбинирует установленные шрифты, соответствующие определенным условиям, с другими шрифтами. DirectWrite содержит api-интерфейсы для поддержки манипуляции и объединения наборов шрифтов. 

Чтобы объединить два или более наборов шрифтов, метод [**идвритефонтсетбуилдер:: аддфонтсет**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder-addfontset) добавляет все шрифты в заданном наборе шрифтов для добавления в построитель набора шрифтов в одном вызове. Если в новом наборе шрифтов требуется только определенное начертание шрифта из существующего набора шрифтов, метод [**идвритефонтсет:: жетматчингфонтс**](idwritefontset-getmatchingfonts-overload.md) можно использовать для получения нового объекта набора шрифтов, который был отфильтрован, чтобы включить только шрифты, соответствующие указанным свойствам. Эти методы предоставляют простой способ создания пользовательского набора шрифтов, объединяющего шрифты из двух или более существующих наборов шрифтов. 

### <a name="using-local-woff-or-woff2-font-data"></a>Использование локальных данных шрифта WOFF или WOFF2

если приложение имеет файлы шрифтов в локальной файловой системе или в буфере памяти, но они используют форматы контейнеров WOFF или WOFF2, DirectWrite (Windows 10 создателя обновления или более поздней версии) предоставляет метод для распаковки формата контейнера, [**IDWriteFactory5:: унпаккфонтфиле**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory5-unpackfontfile), который возвращает [**идвритефонтфилестреам**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfilestream). 

Однако приложению потребуется способ получить [**идвритефонтфилестреам**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfilestream) в объекте-загрузчике файлов шрифтов. Один из способов сделать это — создать пользовательскую реализацию [**идвритефонтфилелоадер**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfileloader) , которая заключает поток в оболочку. Как и в случае с другими загрузчиками файлов шрифтов, это необходимо зарегистрировать перед использованием и отменить регистрацию, прежде чем фабрика выйдет из области действия.  

Если пользовательский загрузчик также будет использоваться с файлами необработанных шрифтов (без упаковки), то приложению также потребуется предоставить пользовательскую реализацию интерфейса [**идвритефонтфилестреам**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfilestream) для обработки этих файлов. Однако существуют более простые способы использования интерфейсов API, описанных выше для обработки файлов необработанных шрифтов. Необходимость в реализации пользовательского потока можно избежать с помощью отдельных путей кода для упакованных файлов шрифтов и файлов необработанных шрифтов. 

После создания пользовательского объекта-загрузчика файла шрифта Упакованные данные файла шрифта добавляются в загрузчик с помощью средств, зависящих от приложения. Загрузчик может управлять несколькими файлами шрифтов, каждый из которых определяется с помощью определяемого приложением ключа, непрозрачного для DirectWrite. После добавления упакованного файла шрифта в загрузчик метод [**идвритефактори:: креатекустомфонтфилереференце**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-createcustomfontfilereference) используется для получения [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile) на основе этого загрузчика для данных шрифта, идентифицируемых заданным ключом.  

фактическое распаковку данных шрифтов можно выполнить при добавлении шрифтов в загрузчик, но их также можно обработать в методе [**идвритефонтфилелоадер:: креатестреамфромкэй**](/windows/win32/api/dwrite/nf-dwrite-idwritefontfileloader-createstreamfromkey) , который DirectWrite вызовет, когда ему сначала нужно считать данные шрифта. 

После создания объекта Идвритефонтфиле оставшиеся шаги по добавлению шрифтов в пользовательский набор шрифтов будут описаны выше. 

реализация, использующая этот подход, проиллюстрирована в [примере пользовательских наборов шрифтов DirectWrite](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DirectWriteCustomFontSets/). 

### <a name="using-directwrite-remote-font-mechanisms-with-custom-low-level-network-implementation"></a>использование DirectWrite удаленных способов использования шрифтов с пользовательской реализацией низкого уровня сети

механизмы DirectWrite для обработки удаленных шрифтов можно разделить на механизмы более высокого уровня — наличие наборов шрифтов, включающих в себя ссылки на шрифт для удаленных шрифтов, проверку локализации данных шрифта и управление очередью для запросов на загрузку шрифтов, а также механизмы более низкого уровня, обрабатывающие фактическую загрузку. Некоторым приложениям может потребоваться использовать удаленные механизмы шрифтов более высокого уровня, но также требуется пользовательское взаимодействие с сетью, например обмен данными с серверами с помощью протоколов, отличных от HTTP. 

В этой ситуации приложению потребуется создать пользовательскую реализацию интерфейса [**идвритеремотефонтфилелоадер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfileloader) , который взаимодействует с другими интерфейсами более низкого уровня в требуемых направлениях. Приложению также потребуется предоставить пользовательские реализации этих интерфейсов нижнего уровня: [**идвритеремотефонтфилестреам**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfilestream)и [**идвритеасинкресулт**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteasyncresult). эти три интерфейса имеют методы обратного вызова, которые DirectWrite будут вызываться во время операций загрузки. 

при вызове [**идвритефонтдовнлоадкуеуе:: BeginDownload**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontdownloadqueue-begindownload) DirectWrite сделает запросы к удаленному загрузчику файлов шрифтов о локализации данных и запросит удаленный поток. Если данные не являются локальными, будет вызван метод потока BeginDownload. реализация потока не должна блокироваться на этом вызове, но должна немедленно возвращаться, передавая объект [**идвритеасинкресулт**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteasyncresult) , предоставляющий маркер ожидания, DirectWrite будет использовать для ожидания асинхронной операции загрузки. Реализация пользовательского потока отвечает за обработку удаленного соединения. когда произошло событие завершения, DirectWrite вызовет метод [**идвритеасинкресулт:: unresult**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwriteasyncresult-getresult) для определения результата операции. Если результат выполнен успешно, ожидается, что последующие вызовы Реадфрагмент к потоку для скачанных диапазонов будут успешными. 

> [!IMPORTANT]
> Примечание о безопасности и производительности. при попытке получить удаленный шрифт возможны проблемы, которые могут быть вызваны злоумышленником для подмены вызываемого сервера или того, что сервер может не отвечать. При реализации пользовательских сетевых взаимодействий вы можете иметь больший контроль над устранением рисков, чем при работе с серверами сторонних производителей. Однако следует рассмотреть соответствующие меры, чтобы избежать раскрытия информации или отказа в обслуживании. Рекомендуется использовать защищенные протоколы, такие как HTTPS. кроме того, следует выполнить сборку в некоторое время ожидания, чтобы обработчик событий возвращался в DirectWrite в конечном итоге получает набор. 

 

### <a name="supporting-scenarios-on-earlier-windows-versions"></a>поддержка сценариев в более ранних версиях Windows

описанные сценарии могут поддерживаться в DirectWrite в более ранних версиях Windows, но при этом требуется гораздо более настраиваемая реализация в части приложения с использованием более ограниченных интерфейсов api, которые были доступны до Windows 10. дополнительные сведения см. в разделе [коллекции пользовательских шрифтов (Windows 7/8)](custom-font-collections.md).

 

 