---
title: Знакомство с DirectWrite
description: Люди взаимодействуют с текстом все время в повседневной жизни.
ms.assetid: ec7cc4a3-b925-48dc-920f-fd293b4c69f0
keywords:
- DirectWrite, о программе
- DirectWrite, типографские функции
- оформление
- DirectWrite, Международный текст
- DirectWrite, шрифты OpenType
- Шрифты OpenType
- DirectWrite, ClearType
- ClearType
- DirectWrite, общие сведения об API
- DirectWrite, Идвритефонтфаце
- идвритефонтфаце
- DirectWrite, отрисовка текста
- DirectWrite, режимы рендеринга
- DirectWrite, взаимодействие GDI
- DirectWrite, взаимодействие
- взаимодействие, DirectWrite
- взаимодействие, интерфейс графических устройств (GDI)
- Интерфейс графических устройств (GDI)
- GDI (интерфейс графических устройств)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4064feccbdbc03f4b2e4d0118e5ab704013d314e
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "103891029"
---
# <a name="introducing-directwrite"></a>Знакомство с DirectWrite

Люди взаимодействуют с текстом все время в повседневной жизни. Это основной способ, с помощью которого люди могут использовать увеличивающийся объем информации. В прошлом он использовался для печати содержимого, в первую очередь документы, газеты, книги и т. д. Все чаще это Интернет-содержимое на компьютере под управлением Windows. Обычный пользователь Windows тратит много времени на чтение с экрана компьютера. Они могут работать в Интернете, проверять электронную почту, создавать отчеты, заполнять электронную таблицу или писать программное обеспечение, но что на самом деле выполняется чтение. Несмотря на то, что текст и шрифты перейти почти каждую часть взаимодействия с пользователем в Windows, для большинства пользователей чтение на экране не так удобно, как чтение напечатанных данных.

Для разработчиков приложений Windows написание кода обработки текста является сложной задачей из-за повышенных требований к повышению удобочитаемости, расширенному форматированию и применению элементов управления макета, а также поддержке нескольких языков, которые приложение должно отобразить. Даже основная система обработки текста должна разрешать текстовые вводы, макеты, отображение, редактирование, копирование и вставлять. Пользователи Windows обычно предполагают даже больше, чем эти основные функции, и требуют даже простых редакторов для поддержки нескольких шрифтов, различных стилей абзацев, внедренных изображений, проверки орфографии и других функций. Современная модель пользовательского интерфейса также больше не ограничена одним форматом, обычным текстом, но должна обеспечить лучшую работу с богатыми шрифтами и макетами текста.

Это введение в то, как [DirectWrite](direct-write-portal.md) позволяет приложениям Windows расширять возможности текста для пользовательского интерфейса и документов.

## <a name="improving-the-text-experience"></a>Улучшение текстового интерфейса

Современные приложения Windows имеют сложные требования к тексту в пользовательском интерфейсе и документах. К ним относится более удобочитаемость, поддержка большого спектра языков и сценариев и высокая производительность отрисовки. Кроме того, для большинства существующих приложений требуется способ переноса существующих вложений в базу кода WindowsWin32.

[DirectWrite](direct-write-portal.md) предоставляет следующие три функции, позволяющие разработчикам приложений Windows улучшать текст в своих приложениях: независимость от системы отрисовки, качественное типографское Оформление и несколько уровней функциональности.

## <a name="rendering-system-independence"></a>Независимость от Rendering-System

[DirectWrite](direct-write-portal.md) не зависит от какой-либо конкретной графической технологии. Приложения могут использовать технологию отрисовки, которая лучше всего подходит для их нужд. Это дает приложениям возможность по-прежнему выполнять визуализацию некоторых частей приложения через GDI и другие компоненты с помощью Direct3D или [Direct2D](../direct2d/direct2d-portal.md). На самом деле, приложение может выбрать визуализацию DirectWrite через собственный стек отрисовки.

## <a name="high-quality-typography"></a>High-Quality оформления

[DirectWrite](direct-write-portal.md) использует преимущества технологии шрифтов [OpenType](../intl/opentype-font-format.md) для обеспечения высокого качества типографской работы в приложениях Windows. Система шрифтов DirectWrite предоставляет службы для работы с перечислением шрифтов, откатом шрифтов и кэшированием шрифтов, которые необходимы приложениям для обработки шрифтов.

Поддержка [OpenType](../intl/opentype-font-format.md) , предоставляемая [DirectWrite](direct-write-portal.md) , позволяет разработчикам добавлять в свои приложения дополнительные типографские функции и поддержку международного текста.

## <a name="support-for-advanced-typographic-features"></a>Поддержка расширенных типографских функций

[DirectWrite](direct-write-portal.md) позволяет разработчикам приложений разблокирование функций шрифтов OpenType, которые они не могут использовать в WinForms или GDI. Объект DirectWrite [**идвритетипографи**](/windows/win32/api/dwrite/nn-dwrite-idwritetypography) предоставляет множество дополнительных возможностей шрифтов OpenType, таких как стилистические варианты и глифы. Пакет средств разработки программного обеспечения Microsoft Windows (SDK) предоставляет набор образцов шрифтов [OpenType](../intl/opentype-font-format.md) , разработанных с широкими возможностями, такими как шрифты Pericles и Pescadero. Дополнительные сведения о функциях OpenType см. в разделе [функции шрифтов OpenType](/previous-versions/dotnet/netframework-3.0/ms745109(v=vs.85)).

## <a name="support-for-international-text"></a>Поддержка международного текста

[DirectWrite](direct-write-portal.md) использует шрифты [OpenType](../intl/opentype-font-format.md) , чтобы обеспечить широкую поддержку международного текста. Поддерживаются такие функции Юникода, как суррогаты, BIDI, перенос строк и UVS. Языковая настройка элементов скрипта, подстановки чисел и формирования глифов гарантирует, что текст в любом скрипте будет иметь правильный макет и отрисовку.

В настоящее время поддерживаются следующие скрипты.

> [!Note]  
> Для сценариев, помеченных атрибутом \* , системные шрифты по умолчанию отсутствуют. Приложения должны устанавливать шрифты, поддерживающие эти скрипты.

 

-   Арабский
-   Армянский
-   бенгала
-   Бопомофо
-   Брайля\*
-   Канадский слоговое письмо слогового письма
-   Чероки
-   Китайский (упрощенное & традиционное письмо)
-   Кириллица
-   Коптский\*
-   Девангари
-   Эфиопского
-   Грузинский
-   глаголитик\*
-   Греческий
-   Гуджарати
-   Гурмукхи
-   Иврит
-   Японский
-   Каннада
-   Кхмерский
-   Корейский
-   Лаосский
-   Латиница
-   Малаялам
-   Монгольский
-   Мьянма
-   Новая письменность тай-лю
-   Блок\*
-   Ория
-   ' Блок-PA
-   руник\*
-   Сингальский
-   Сирийский
-   Тай Le
-   Тамильский
-   Телугу
-   мальдивский
-   Тайский
-   Тибетский
-   Носу

## <a name="multiple-layers-of-functionality"></a>Несколько уровней функциональности

[DirectWrite](direct-write-portal.md) предоставляет многоуровневые уровни функциональности, каждый из которых тесно взаимодействует со следующим. Структура API предоставляет разработчикам приложений свободу и гибкость при внедрении отдельных слоев в зависимости от их потребностей и расписания. На следующей схеме показана связь между этими слоями.

![Схема DirectWrite слоев и взаимодействие с приложением или платформой пользовательского интерфейса и API графики](images/intro-01.png)

API макета текста предоставляет функции высшего уровня, доступные в [DirectWrite](direct-write-portal.md). Она предоставляет службам приложения возможность измерять, отображать и взаимодействовать с форматированными текстовыми строками. Этот текстовый API можно использовать в приложениях, которые в настоящее время используют Win32's DrawText для создания современного пользовательского интерфейса с форматированным текстом.

Приложения с большим объемом текста, реализующие собственный обработчик макета, могут использовать следующий слой ниже: обработчик скриптов. Обработчик скриптов разбивает фрагмент текста на блоки сценариев и обрабатывает сопоставление между представлениями Юникода с соответствующим представлением глифа в шрифте, чтобы текст скрипта правильно отображался на правильном языке. Система макета, используемая слоем API макета текста, строится на основе шрифта и системы обработки сценариев.

Уровень визуализации глифов — это самый нижний уровень функциональности, обеспечивающий функции визуализации глифов для приложений, реализующих собственный обработчик макетов текста. Слой рендеринга глифов также полезен для приложений, реализующих пользовательский модуль подготовки отчетов для изменения поведения рисования глифов с помощью функции обратного вызова в API форматирования текста [DirectWrite](direct-write-portal.md) .

Система шрифтов [DirectWrite](direct-write-portal.md) доступна для всех функциональных уровней DirectWrite и позволяет приложению получать доступ к сведениям о шрифтах и глифах. Он предназначен для работы с общими технологиями шрифтов и форматов данных. Модель шрифтов DirectWrite соответствует стандартной типографской методике поддержки любого количества весов, стилей и растянутости в одном семействе шрифтов. Эта модель, та же самая модель, за которой следуют WPF и CSS, указывает, что шрифты, которые отличаются только по весу (полужирный, светло-и т. д.), стиль (вертикальный, курсив или наклонный) или растяжение (узкие, сжатые, широкие и т. д.) считаются членами одного семейства шрифтов.

### <a name="improved-text-rendering-with-cleartype"></a>Улучшенная визуализация текста с помощью технологии ClearType

Улучшение удобочитаемости на экране является ключевым требованием для всех приложений Windows. Свидетельство от исследования в окне «научный психологии» указывает, что нам нужно уметь распознать каждую букву точно, и что даже интервал между буквами очень важен для быстрой обработки. Буквы и слова, которые не являются симметричными, воспринимается как некрасивое и снижают удобство чтения. Кевин Ларсон (, Microsoft Advanced Read Technologies Group, написала статью о теме, опубликованной в спектре IEEE. Статья называется «технология текста» ( https://www.spectrum.ieee.org/print/5049) .

Текст в [DirectWrite](direct-write-portal.md) отображается с помощью технологии Microsoft ClearType, что повышает четкость и удобочитаемость текста. Технология ClearType использует преимущества того факта, что современные ЖК-дисплеи имеют полосы RGB для каждого пикселя, который можно контролировать по отдельности. DirectWrite использует новейшие усовершенствования технологии ClearType, впервые включенные в Windows Vista с Windows Presentation Foundation, что позволяет ему оценивать не только отдельные буквы, но и интервалы между буквами. До этих улучшений ClearType текст с размером "10 или 12 точек" был сложен для отображения: можно поместить 1 пиксель между буквами, которые часто слишком маленькие, или 2 пиксела, что часто бывает слишком много. Использование дополнительного разрешения в подпикселях дает нам дробные промежутки, что улучшает однородность и симметрию всей страницы.

На следующих двух иллюстрациях показано, как могут начинаться глифы на любой границе области во время использования позиционирования в пикселах.

Следующая иллюстрация отображается с помощью версии GDI визуализатора ClearType, который не применяет позиционирование в пикселях.

![изображение "технология", отображаемая без позиционирования в пикселах](images/intro-03.png)

Следующая иллюстрация отображается с использованием [DirectWrite](direct-write-portal.md) версии визуализатора ClearType, в которой используется позиционирование в пикселях.

![Иллюстрация визуализации "технология" с позиционированием в пикселах](images/intro-04.png)

Обратите внимание, что пробелы между буквами h и n являются более четными на втором изображении, а буква o больше, чем буква n, больше, даже с буквой l. Также обратите внимание на то, что области буквы l являются более естественными.

Положение ClearType в подпикселях предлагает наиболее точные пробелы на экране, особенно небольшие размеры, в которых разница между подпикселем и целым пикселем представляет значительную долю ширины глифа. Он позволяет измерять текст в идеальном пространстве разрешения и визуализировать его естественное расположение на ЖК-полосе цветов с детализацией по подпикселям. Текст, измеряемый и визуализированный с помощью этой технологии, определяется по определению, не зависит от разрешения, что означает, что точно такой же макет текста достигается в пределах различных способов разрешения экрана.

В отличие от любого из типов отрисовки с помощью технологии GDI, технология ClearType обеспечивает наиболее точную ширину символов.

API текстовой строки применяет отрисовку текста в виде вложенных пикселов по умолчанию, что означает, что она измеряет текст в идеальном разрешении независимо от текущего разрешения экрана и выдает результат позиционирования глифов на основе действительно масштабируемых ширины и смещений для глифов.

Для больших объемов текста [DirectWrite](direct-write-portal.md) также позволяет использовать сглаживание вдоль оси y, чтобы сделать края более гладкими и отрисовывать письма как предназначенные для работы в конструкторе шрифтов. На следующем рисунке показано сглаживание по оси y.

![изображение «ClearType», отображаемое как текст GDI, и DirectWrite текст с сглаживанием по оси y](images/intro-05.png)

Несмотря на то, что [DirectWrite](direct-write-portal.md) текст размещается и визуализируется с использованием подразделов ClearType по умолчанию, доступны другие параметры отрисовки. Многие существующие приложения используют GDI для отрисовки большей части своего пользовательского интерфейса, а некоторые приложения используют элементы управления для редактирования системы, которые продолжают использовать GDI для отрисовки текста. При добавлении DirectWrite текста в эти приложения может потребоваться пожертвировать возможности чтения, предоставляемые с помощью технологии ClearType, чтобы обеспечить единообразное отображение текста в приложении.

Для удовлетворения этих требований [DirectWrite](direct-write-portal.md) также поддерживает следующие параметры визуализации:

-   Технология ClearType (по умолчанию).
-   Технология ClearType в подпикселях с сглаживанием как по горизонтали, так и по вертикали.
-   Текст с псевдонимом.
-   Формат GDI (например, режим чтения, используемый Microsoft Word).
-   Совместимость с GDI — ширина (включая Восточно-азиатское внедренное растровое изображение).

Каждый из этих режимов подготовки можно настроить с помощью API DirectWrite и с помощью нового тюнера «входящие» в Windows 7 Inbox.

> [!Note]  
> Начиная с Windows 8, в большинстве случаев следует использовать сглаживание текста в оттенках серого. Этот процесс описан в следующем разделе.

 

### <a name="support-for-natural-layout"></a>Поддержка естественного макета

Естественное расположение не зависит от разрешения, поэтому пробелы в символах не меняются при изменении масштаба или в зависимости от DPI на дисплее. Дополнительное преимущество заключается в том, что для создания шрифта используется параметр «промежуток». Естественная структура становится возможной благодаря поддержке естественной отрисовки в DirectWrite, что означает, что отдельные глифы можно размещать в долях пикселя.

Хотя естественное расположение используется по умолчанию, некоторые приложения должны визуализировать текст с тем же отступом и внешним видом, что и GDI. Для таких приложений DirectWrite предоставляет классический и естественный режимы измерения GDI, а также соответствующие режимы рендеринга.

Любой из приведенных выше режимов рендеринга можно сочетать с любым из двух режимов сглаживания: ClearType или градации серого. Сглаживание ClearType навязывает более высокое разрешение, по отдельности управляя красным, зеленым и синим значениями цвета каждого пикселя. Сглаживание в оттенках серого рассчитывает только одно значение (или альфа) для каждого пикселя. По умолчанию используется технология ClearType, но сглаживание оттенков серого рекомендуется для приложений Магазина Windows, так как оно работает быстрее и совместимо со стандартным сглаживанием, в то же время обеспечивая высокую удобочитаемость.

## <a name="api-overview"></a>Обзор API

Интерфейс [**идвритефактори**](/windows/win32/api/dwrite/nn-dwrite-idwritefactory) является отправной точкой для использования функции DirectWrite. Фабрика — это корневой объект, который создает набор объектов, которые можно использовать вместе.

Операция форматирования и макета является необходимым условием для операций, так как текст необходимо правильно отформатировать и определить в соответствии с заданным набором ограничений, прежде чем он может быть нарисован или проверен на попадание. Для этой цели можно создать два ключевых объекта с [**идвритефактори**](/windows/win32/api/dwrite/nn-dwrite-idwritefactory) : [**идвритетекстформат**](/windows/win32/api/dwrite/nn-dwrite-idwritetextformat) и [**идвритетекстлайаут**](/windows/win32/api/dwrite/nn-dwrite-idwritetextlayout). Объект **идвритетекстформат** представляет сведения о форматировании для абзаца текста. Функция [**идвритефактори:: креатетекстлайаут**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-createtextlayout) принимает входную строку, связанные с ней ограничения, такие как размер заполняемого пространства, и объект **идвритетекстформат** и помещает полностью проанализированный и отформатированный результат в **идвритетекстлайаут** для использования в последующих операциях.

Приложение может затем визуализировать текст с помощью функции [**дравтекстлайаут**](/windows/win32/api/d2d1/nf-d2d1-id2d1rendertarget-drawtextlayout) , предоставляемой [Direct2D](../direct2d/direct2d-portal.md) , или путем реализации функции обратного вызова, которая может использовать GDI, Direct2D или другие графические системы для отрисовки глифов. В одном тексте формата функция [**DrawText**](/windows/win32/api/d2d1/nf-d2d1-id2d1rendertarget-drawtext(constwchar_uint32_idwritetextformat_constd2d1_rect_f__id2d1brush_d2d1_draw_text_options_dwrite_measuring_mode)) в Direct2D предоставляет более простой способ рисования текста без необходимости создания объекта [**идвритетекстлайаут**](/windows/win32/api/dwrite/nn-dwrite-idwritetextlayout) .

## <a name="formatting-and-drawing-hello-world-using-directwrite"></a>Форматирование и Рисование "Hello World" с помощью DirectWrite

В следующем примере кода показано, как приложение может отформатировать один абзац с помощью [**идвритетекстформат**](/windows/win32/api/dwrite/nn-dwrite-idwritetextformat) и нарисовать его с помощью функции [Direct2D](../direct2d/direct2d-portal.md)[**DrawText**](/windows/win32/api/d2d1/nf-d2d1-id2d1rendertarget-drawtext(constwchar_uint32_idwritetextformat_constd2d1_rect_f__id2d1brush_d2d1_draw_text_options_dwrite_measuring_mode)) .


```C++
HRESULT DemoApp::DrawHelloWorld(
    ID2D1HwndRenderTarget* pIRenderTarget
    )
{
    HRESULT hr = S_OK;
    ID2D1SolidColorBrush* pIRedBrush = NULL;
    IDWriteTextFormat* pITextFormat = NULL;
    IDWriteFactory* pIDWriteFactory = NULL;

    if (SUCCEEDED(hr))
    {
        hr = DWriteCreateFactory(DWRITE_FACTORY_TYPE_SHARED,
                __uuidof(IDWriteFactory),
                reinterpret_cast<IUnknown**>(&pIDWriteFactory));
    }

    if(SUCCEEDED(hr))
    {
        hr = pIDWriteFactory->CreateTextFormat(
            L"Arial", 
            NULL,
            DWRITE_FONT_WEIGHT_NORMAL, 
            DWRITE_FONT_STYLE_NORMAL, 
            DWRITE_FONT_STRETCH_NORMAL, 
            10.0f * 96.0f/72.0f, 
            L"en-US", 
            &pITextFormat
        );
    }

    if(SUCCEEDED(hr))
    {
        hr = pIRenderTarget->CreateSolidColorBrush(
            D2D1:: ColorF(D2D1::ColorF::Red),
            &pIRedBrush
        );
    }
    
   D2D1_RECT_F layoutRect = D2D1::RectF(0.f, 0.f, 100.f, 100.f);

    // Actually draw the text at the origin.
    if(SUCCEEDED(hr))
    {
        pIRenderTarget->DrawText(
            L"Hello World",
            wcslen(L"Hello World"),
            pITextFormat,
            layoutRect, 
            pIRedBrush
        );
    }

    // Clean up.
    SafeRelease(&pIRedBrush);
    SafeRelease(&pITextFormat);
    SafeRelease(&pIDWriteFactory);

    return hr;
}
```



## <a name="accessing-the-font-system"></a>Доступ к системе шрифтов

Помимо указания имени семейства шрифтов для текстовой строки с помощью интерфейса [**идвритетекстформат**](/windows/win32/api/dwrite/nn-dwrite-idwritetextformat) в приведенном выше примере, [DirectWrite](direct-write-portal.md) предоставляет приложениям больший контроль над выбором шрифтов через перечисление шрифтов и возможность создания пользовательской коллекции шрифтов на основе внедренных шрифтов документа.

Объект [**идвритефонтколлектион**](/windows/win32/api/dwrite/nn-dwrite-idwritefontcollection) представляет собой коллекцию семейств шрифтов. DirectWrite предоставляет доступ к набору шрифтов, установленных в системе, с помощью специальной коллекции шрифтов, называемой коллекцией системных шрифтов. Это достигается путем вызова метода [**жетсистемфонтколлектион**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-getsystemfontcollection) объекта [**идвритефактори**](/windows/win32/api/dwrite/nn-dwrite-idwritefactory) . Приложение также может создать коллекцию пользовательских шрифтов из набора шрифтов, перечисленных с помощью определяемого приложением обратного вызова, то есть закрытых шрифтов, установленных приложением, или внедренных в документ шрифтов.

Затем приложение может вызвать метод [**FontFamily**](/windows/win32/api/dwrite/nf-dwrite-idwritefont-getfontfamily) , чтобы получить конкретный объект FontFamily в коллекции, а затем вызвать метод [**Идвритефонтфамили:: жетфирстматчингфонт**](/windows/win32/api/dwrite/nf-dwrite-idwritefontfamily-getfirstmatchingfont) , чтобы получить конкретный объект [**идвритефонт**](/windows/win32/api/dwrite/nn-dwrite-idwritefont) . Объект **идвритефонт** представляет шрифт в коллекции шрифтов и предоставляет свойства и несколько базовых метрик шрифта.

[**Идвритефонтфаце**](/windows/win32/api/dwrite/nn-dwrite-idwritefontface) — это еще один объект, который представляет шрифт и предоставляет полный набор метрик для шрифта. **Идвритефонтфаце** можно создать непосредственно из имени шрифта. приложению не нужно получать коллекцию шрифтов для доступа к нему. Это полезно для приложения текстового макета, такого как Microsoft Word, которое должно запрашивать подробные сведения о конкретном шрифте.

На следующей схеме показана связь между этими объектами.

![Схема связи между коллекцией шрифтов, семейством шрифтов и начертанием шрифта](images/fontcollection.png)

### <a name="idwritefontface"></a>идвритефонтфаце

Объект [**идвритефонтфаце**](/windows/win32/api/dwrite/nn-dwrite-idwritefontface) представляет шрифт и предоставляет более подробные сведения о шрифте, чем делает объект [**идвритефонт**](/windows/win32/api/dwrite/nn-dwrite-idwritefont) . Метрики шрифта и глифа из **идвритефонтфаце** полезны для приложений, которые реализуют макет текста.

Самые распространенные приложения не будут использовать эти API напрямую, а вместо этого будут использовать [**идвритефонт**](/windows/win32/api/dwrite/nn-dwrite-idwritefont) или указать имя семейства шрифтов напрямую.

В следующей таблице приведена сводка сценариев использования для двух объектов.



| Категория                                                                                                         | [**идвритефонт**](/windows/win32/api/dwrite/nn-dwrite-idwritefont) | [**идвритефонтфаце**](/windows/win32/api/dwrite/nn-dwrite-idwritefontface) |
|------------------------------------------------------------------------------------------------------------------|--------------------------------------------|----------------------------------------------------|
| Интерфейсы API для поддержки взаимодействия с пользователем, таких как пользовательский интерфейс для выбора шрифта: описание и другие информационные API | Да                                        | Нет                                                 |
| Интерфейсы API для поддержки сопоставления шрифтов: семейство, стиль, вес, растяжение, покрытие символов                                 | Да                                        | Нет                                                 |
| API DrawText                                                                                                     | Да                                        | Нет                                                 |
| API, используемые для отрисовки                                                                                          | Нет                                         | Да                                                |
| API, используемые для макета текста: метрики глифов и т. д.                                                              | Нет                                         | Да                                                |
| Интерфейсы API для элементов управления ИП и текста: метрики на уровне шрифта                                                           | Да                                        | Да                                                |



 

Ниже приведен пример приложения, которое перечисляет шрифты в коллекции системных шрифтов.


```C++
#include <dwrite.h>
#include <string.h>
#include <stdio.h>
#include <new>

// SafeRelease inline function.
template <class T> inline void SafeRelease(T **ppT)
{
    if (*ppT)
    {
        (*ppT)->Release();
        *ppT = NULL;
    }
}

void wmain()
{
    IDWriteFactory* pDWriteFactory = NULL;

    HRESULT hr = DWriteCreateFactory(
            DWRITE_FACTORY_TYPE_SHARED,
            __uuidof(IDWriteFactory),
            reinterpret_cast<IUnknown**>(&pDWriteFactory)
            );

    IDWriteFontCollection* pFontCollection = NULL;

    // Get the system font collection.
    if (SUCCEEDED(hr))
    {
        hr = pDWriteFactory->GetSystemFontCollection(&pFontCollection);
    }

    UINT32 familyCount = 0;

    // Get the number of font families in the collection.
    if (SUCCEEDED(hr))
    {
        familyCount = pFontCollection->GetFontFamilyCount();
    }

    for (UINT32 i = 0; i < familyCount; ++i)
    {
        IDWriteFontFamily* pFontFamily = NULL;

        // Get the font family.
        if (SUCCEEDED(hr))
        {
            hr = pFontCollection->GetFontFamily(i, &pFontFamily);
        }

        IDWriteLocalizedStrings* pFamilyNames = NULL;
        
        // Get a list of localized strings for the family name.
        if (SUCCEEDED(hr))
        {
            hr = pFontFamily->GetFamilyNames(&pFamilyNames);
        }

        UINT32 index = 0;
        BOOL exists = false;
        
        wchar_t localeName[LOCALE_NAME_MAX_LENGTH];

        if (SUCCEEDED(hr))
        {
            // Get the default locale for this user.
            int defaultLocaleSuccess = GetUserDefaultLocaleName(localeName, LOCALE_NAME_MAX_LENGTH);

            // If the default locale is returned, find that locale name, otherwise use "en-us".
            if (defaultLocaleSuccess)
            {
                hr = pFamilyNames->FindLocaleName(localeName, &index, &exists);
            }
            if (SUCCEEDED(hr) && !exists) // if the above find did not find a match, retry with US English
            {
                hr = pFamilyNames->FindLocaleName(L"en-us", &index, &exists);
            }
        }
        
        // If the specified locale doesn't exist, select the first on the list.
        if (!exists)
            index = 0;

        UINT32 length = 0;

        // Get the string length.
        if (SUCCEEDED(hr))
        {
            hr = pFamilyNames->GetStringLength(index, &length);
        }

        // Allocate a string big enough to hold the name.
        wchar_t* name = new (std::nothrow) wchar_t[length+1];
        if (name == NULL)
        {
            hr = E_OUTOFMEMORY;
        }

        // Get the family name.
        if (SUCCEEDED(hr))
        {
            hr = pFamilyNames->GetString(index, name, length+1);
        }
        if (SUCCEEDED(hr))
        {
            // Print out the family name.
            wprintf(L"%s\n", name);
        }

        SafeRelease(&pFontFamily);
        SafeRelease(&pFamilyNames);

        delete [] name;
    }

    SafeRelease(&pFontCollection);
    SafeRelease(&pDWriteFactory);
}

```



## <a name="text-rendering"></a>Отрисовка текста

Интерфейсы API отрисовки текста позволяют подготавливать глифы в шрифте [DirectWrite](direct-write-portal.md) к [Direct2D](../direct2d/direct2d-portal.md) поверхности или к независимому точечному рисунку устройства GDI или преобразовывать их в кривые или точечные рисунки. Технология визуализации ClearType в DirectWrite поддерживает позиционирование в подпикселях с повышенной четкостью и контрастностью по сравнению с предыдущими реализациями в Windows. DirectWrite также поддерживает черно-белый текст с псевдонимами для поддержки сценариев, включающих Восточно-азиатские шрифты с внедренными точечными рисунками или когда пользователь отключил сглаживание шрифтов любого типа.

Все параметры настраиваются всеми доступными регуляторами ClearType, доступными через API-интерфейсы [DirectWrite](direct-write-portal.md) , а также через новый апплет панели управления Windows 7 ClearType.

Для отрисовки глифов доступны два API-интерфейса, один из которых обеспечивает визуализацию с аппаратным ускорением через [Direct2D](../direct2d/direct2d-portal.md) , а другой предоставляет программную отрисовку точечному рисунку GDI. Приложение, использующее [**идвритетекстлайаут**](/windows/win32/api/dwrite/nn-dwrite-idwritetextlayout) и реализующий обратный вызов [**идвритетекстрендерер**](/windows/win32/api/dwrite/nn-dwrite-idwritetextrenderer) , может вызывать любую из этих функций в ответ на обратный вызов [**DrawGlyphRun**](/windows/win32/api/dwrite/nf-dwrite-idwritetextrenderer-drawglyphrun) . Кроме того, приложения, которые реализуют собственный макет или работают с данными на уровне глифов, могут использовать эти API.

1.  [**ID2DRenderTarget::D Равглифрун**](/windows/win32/api/d2d1/nf-d2d1-id2d1rendertarget-drawglyphrun)

    Приложения могут использовать [**DrawGlyphRun**](/windows/win32/api/d2d1/nf-d2d1-id2d1rendertarget-drawglyphrun) API [Direct2D](../direct2d/direct2d-portal.md) для обеспечения аппаратного ускорения отрисовки текста с помощью GPU. Аппаратное ускорение влияет на все фазы конвейера отрисовки текста — от слияния глифов до глифов и фильтрации растрового изображения, чтобы применить алгоритм смешивания ClearType к окончательно отображаемым выходным данным. Это рекомендуемый API для получения наилучшей производительности отрисовки.

2.  [**Идвритебитмапрендертаржет::D Равглифрун**](/windows/win32/api/dwrite/nf-dwrite-idwritebitmaprendertarget-drawglyphrun)

    Приложения могут использовать метод [**идвритебитмапрендертаржет::D равглифрун**](/windows/win32/api/dwrite/nf-dwrite-idwritebitmaprendertarget-drawglyphrun) для выполнения программного отображения выполнения глифов до точечного рисунка 32 бит/с. Объект [**идвритебитмапрендертаржет**](/windows/win32/api/dwrite/nn-dwrite-idwritebitmaprendertarget) инкапсулирует растровое изображение и контекст устройства памяти, который можно использовать для отрисовки глифов. Этот API полезен, если вы хотите остаться в GDI, так как у вас есть существующая база кода, отображаемая в GDI.

Если у вас есть приложение с существующим кодом макета текста, использующим GDI, и вы хотите сохранить существующий код макета, но использовать [DirectWrite](direct-write-portal.md) только для завершающего этапа отрисовки глифов, [**Идвритегдиинтероп:: креатефонтфацефромхдк**](/windows/win32/api/dwrite/nf-dwrite-idwritegdiinterop-createfontfacefromhdc) предоставляет мост между двумя API. Перед вызовом этой функции приложение будет использовать функцию **идвритегдиинтероп:: креатефонтфацефромхдк** для получения ссылки Font-Face из контекста устройства.

> [!Note]  
> В большинстве случаев приложениям может не потребоваться использовать эти API-интерфейсы для отрисовки глифов. После того как приложение создало объект [**идвритетекстлайаут**](/windows/win32/api/dwrite/nn-dwrite-idwritetextlayout) , он может использовать метод [**ID2D1RenderTarget::D равтекстлайаут**](/windows/win32/api/d2d1/nf-d2d1-id2d1rendertarget-drawtextlayout) для отрисовки текста.

 

## <a name="custom-rendering-modes"></a>Пользовательские режимы отрисовки

Ряд параметров влияет на отрисовку текста, например гамма, уровень ClearType, геометрию в пикселях и улучшенную контрастность. Параметры отрисовки инкапсулированы объектом, который реализует открытый интерфейс [**идвритерендерингпарамс**](/windows/win32/api/dwrite/nn-dwrite-idwriterenderingparams) . Объект параметров отрисовки автоматически инициализируется на основе свойств оборудования и (или) пользовательских настроек, заданных в приложении ClearType панели управления в Windows 7. Как правило, если клиент использует API макета [DirectWrite](direct-write-portal.md) , то DirectWrite автоматически выбирает режим рендеринга, соответствующий указанному режиму измерения.

Приложения, которым требуется больший контроль, могут использовать [**идвритефактори:: креатекустомрендерингпарамс**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-createcustomrenderingparams) для реализации различных параметров отрисовки. Эта функция также может использоваться для установки гаммы, геометрии в пикселях и улучшенной контрастности.

Ниже приведены различные доступные параметры отрисовки.

-   Сглаживание в дочерних точках

    Приложение задает для параметра *рендерингмоде* значение дврите \_ режима рендеринга \_ \_ естественное, чтобы указать отрисовку с сглаживанием только в горизонтальном измерении.

-   Сглаживание для дочерних точек в горизонтальных и вертикальных измерениях.

    Приложение задает для параметра *рендерингмоде* значение дврите \_ режима рендеринга \_ \_ Natural \_ симметрично, чтобы указать отрисовку с сглаживанием как по горизонтали, так и по вертикали. Таким образом, кривые и диагональные линии выглядят более гладко за счет некоторого мягкости и обычно используются с размерами выше 16 ппем.

-   Текст с псевдонимом

    Приложение устанавливает параметр *рендерингмоде* в \_ режим рендеринга дврите \_ , \_ чтобы указать текст с псевдонимом.

-   Текст в градациях серого

    Приложение задает для параметра *пикселжеометри* значение дврите \_ пиксельной \_ геометрии \_ Flat, чтобы указать текст в градациях серого.

-   Совместимый с GDI-ширина (включая Восточно-азиатское внедренное изображение)

    Приложение задает для параметра *рендерингмоде* значение дврите \_ режима рендеринга \_ \_ \_ классическая, чтобы задать сглаживание, совместимое с GDI.

-   Естественная толщина GDI

    Приложение задает для параметра *рендерингмоде* значение дврите \_ режима отрисовки \_ \_ GDI \_ Natural, чтобы задать совместимое сглаживание GDI.

-   Текст контура

    Для отрисовки крупного размера разработчик приложения может предпочесть визуализироваться с помощью контура шрифта, а не с помощью растрирования растрового изображения. Приложение устанавливает параметр *рендерингмоде* в **\_ \_ \_ структуру режима рендеринга дврите** , чтобы указать, что отрисовка должна обходить средство программной прорисовки и использовать контуры напрямую.

## <a name="gdi-interoperability"></a>Взаимодействие GDI

Интерфейс [**идвритегдиинтероп**](/windows/win32/api/dwrite/nn-dwrite-idwritegdiinterop) обеспечивает взаимодействие с GDI. Это позволяет приложениям продолжить существующие инвестиции в базовые модули кода GDI и выборочно использовать [DirectWrite](direct-write-portal.md) для отрисовки или разметки.

Ниже приведены API-интерфейсы, которые позволяют приложению переходить на систему шрифтов GDI или из нее:

-   [**креатефонтфромлогфонт**](/windows/win32/api/dwrite/nf-dwrite-idwritegdiinterop-createfontfromlogfont)

    Создает объект [**идвритефонт**](/windows/win32/api/dwrite/nn-dwrite-idwritefont) , соответствующий свойствам, указанным в структуре [**LOGFONT**](/windows/win32/api/wingdi/ns-wingdi-logfonta) .

-   [**конвертфонттологфонт**](/windows/win32/api/dwrite/nf-dwrite-idwritegdiinterop-convertfonttologfont)

    Инициализирует структуру [**LOGFONT**](/windows/win32/api/wingdi/ns-wingdi-logfonta) на основе свойств, совместимых с GDI, для указанного [**идвритефонт**](/windows/win32/api/dwrite/nn-dwrite-idwritefont).

-   [**конвертфонтфацетологфонт**](/windows/win32/api/dwrite/nf-dwrite-idwritegdiinterop-convertfontfacetologfont)

    Инициализирует структуру [**LOGFONT**](/windows/win32/api/wingdi/ns-wingdi-logfonta) на основе свойств, совместимых с GDI, для указанного [**идвритефонтфаце**](/windows/win32/api/dwrite/nn-dwrite-idwritefontface).

-   [**креатефонтфацефромхдк**](/windows/win32/api/dwrite/nf-dwrite-idwritegdiinterop-createfontfacefromhdc)

    Создает объект [**идвритефонтфаце**](/windows/win32/api/dwrite/nn-dwrite-idwritefontface) , соответствующий выбранному в данный момент **хфонт**.

## <a name="conclusion"></a>Заключение

Улучшение возможностей чтения — это отличная ценность для пользователей, будь то экран или на бумаге. [DirectWrite](direct-write-portal.md) обеспечивает простоту использования и многоуровневую модель программирования для разработчиков приложений, чтобы улучшить работу с текстом для приложений Windows. Приложения могут использовать DirectWrite для отображения форматированного текста для пользовательского интерфейса и документов с помощью API макета. В более сложных сценариях приложение может работать непосредственно с глифами, получить доступ к шрифтам и т. д., а также использовать возможности DirectWrite для предоставления высокого качества типографского оформления.

Возможности взаимодействия [DirectWrite](direct-write-portal.md) позволяют разработчикам приложений переносить существующие базы кода Win32 и внедрять DirectWrite в своих приложениях выборочно.

 

 