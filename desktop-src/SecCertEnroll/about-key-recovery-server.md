---
description: Центр сертификации Майкрософт (ЦС) можно настроить для архивации и восстановления закрытого ключа, связанного с открытым ключом, отправленным в запросе на сертификат.
ms.assetid: c6535dbf-c3fe-4f70-9a70-02805253a651
title: Сервер восстановления ключей
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a313ac46bf540d6d0f356f7e2c4910e31bee1f2a4268931ac6a942085505b423
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118903777"
---
# <a name="key-recovery-server"></a>Сервер восстановления ключей

Центр сертификации Майкрософт (ЦС) можно настроить для архивации и восстановления закрытого ключа, связанного с открытым ключом, отправленным в запросе на сертификат. Восстановление полезно в случае утери ключа. По умолчанию архивировать можно только ключи шифрования. Нет необходимости архивировать ключи, предназначенные только для подписания, поскольку при потере закрытого ключа подписывания требуется только открытый ключ для проверки подписи.

Чтобы заархивировать ключ, ЦС должен быть настроен на выдачу сертификатов агента восстановления ключей (KRA) и уже выдавал по крайней мере один. Агент восстановления ключей — это администратор, который разрешает организациям расшифровывать закрытые ключи. Для повышения безопасности рекомендуется назначать агент восстановления ключей и роли диспетчера сертификатов разным пользователям, которому диспетчеру сертификатов разрешено получать, но не расшифровывать архивированные ключи, а агенту восстановления ключей разрешено расшифровывать ключи, но не извлекать их.

## <a name="key-archival"></a>Архивирование ключей

Клиент обычно запрашивает сертификат с помощью шаблона. Если шаблон требует архивирования закрытого ключа, клиент и центр сертификации выполняют следующие шаги:

1.  Клиент получает и проверяет сертификат Exchange ЦС, чтобы определить, подписан ли он с помощью того же ключа, который использовался для подписания сертификата для подписи ЦС. Это гарантирует, что единственный ЦС, который может расшифровать закрытый ключ, — это центр сертификации, из которого запрашивается сертификат.
2.  Открытый ключ в сертификате ЦС Exchange используется для шифрования закрытого ключа, связанного с запросом на сертификат, и отправки запроса в ЦС.
3.  ЦС использует закрытый ключ, связанный с сертификатом Exchange, для расшифровки закрытого ключа, отправленного клиентом, и проверяет, связаны ли открытые и закрытые ключи в запросе.
4.  ЦС шифрует закрытый ключ с помощью открытого ключа в сертификате KRA. Если ЦС выпустил несколько KRA-сертификатов, закрытый ключ шифруется один раз с каждым доступным открытым ключом, чтобы любой Полномочный агент восстановления ключей мог восстановить ключ. Зашифрованные закрытые ключи хранятся в базе данных сертификатов.
5.  Центр сертификации освобождает все ссылки на закрытый ключ и обеспечивает безопасное освобождение и обнуление всей памяти, содержащей ключ. Это гарантирует, что ЦС не будет иметь доступ к ключу в формате открытого текста.

> [!Note]  
> Для архивации ключей можно использовать только запрос CMC. Запросы CMC представлены интерфейсом [**IX509CertificateRequestCmc**](/windows/desktop/api/CertEnroll/nn-certenroll-ix509certificaterequestcmc) .

 

## <a name="key-recovery"></a>Восстановление ключей

Восстановление ключей не поддерживается напрямую службами Active Directory сертификатов или API регистрации сертификатов. Однако корпорация Майкрософт предоставляет следующие приложения для упрощения процесса:

-   Certutil.exe — это программа командной строки, которая может использоваться для получения сведений о конфигурации ЦС, проверки сертификатов, пар ключей и цепочек сертификатов, а также резервного копирования и восстановления ключей. он входит в состав серверных операционных систем, начиная с Windows server 2003.
-   Krecover.exe — это программа на основе диалоговых окон, которая обеспечивает восстановление ключей. он входит в состав набора ресурсов, начиная с Windows Server 2003.

Для восстановления закрытого ключа выполняются следующие действия.

1.  Диспетчер сертификатов находит потенциальные кандидаты для восстановления ключей в базе данных сертификатов, используя имя сертификата, инициатора запроса или пользователя. Для этой цели можно использовать команду **certutil** **-GetKey** .
2.  После того как диспетчер сертификатов выдает список сертификатов, команда **-GetKey** вызывается снова с конкретным серийным номером или бегунком печати для получения \# файла PKCS 7, содержащего KRA-сертификат, цепочку сертификатов пользователей и закрытый ключ, который был зашифрован во время архивации с помощью открытого ключа KRA.
3.  Диспетчер сертификатов передает управление процессом агенту восстановления ключей, закрытый ключ которого соответствует открытому ключу, содержащемуся в сертификате KRA.
4.  Агент восстановления ключей расшифровывает заархивированный закрытый ключ, возвращенный в файле PKCS \# 7, с помощью закрытого ключа KRA. Это можно сделать с помощью команды **certutil** **-рековеркэй** , которая помещает ключ в защищенный паролем файл PKCS \# 12. Клиенту должен быть предоставлен пароль с помощью безопасного аппаратного механизма.
5.  Клиент импортирует \# файл PKCS 12 и использует пароль для получения ключа.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Элементы PKI](about-pki-components.md)
</dt> </dl>

 

 



