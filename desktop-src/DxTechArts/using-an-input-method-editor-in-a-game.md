---
title: Использование редактора метода ввода в игре
description: В этой статье объясняется, как можно реализовать базовый элемент управления редактора IME в полноэкранном приложении Microsoft DirectX.
ms.assetid: 760ed960-08a3-e967-282e-7fbdbaeb7a4d
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d8cb5869579da97aeea465b572082a23a963e9db
ms.sourcegitcommit: 9b5faa61c38b2d0c432b7f2dbee8c127b0e28a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/19/2021
ms.locfileid: "122471970"
---
# <a name="using-an-input-method-editor-in-a-game"></a>Использование редактора метода ввода в игре

> [!Note]  
> в этой статье подробно описывается работа с редактором метода ввода Windows XP (IME). в IME для Windows Vista были внесены изменения, которые не полностью описаны в этой статье. дополнительные сведения об изменениях IME для Windows Vista см. в разделе [редакторы методов ввода (ime)](https://www.microsoft.com/globaldev/vista/Whats_New_Vista.mspx#e4eac) в [Windows Vista — Ever-Expanding представление интернационализации](https://www.microsoft.com/globaldev/vista/Whats_New_Vista.mspx) на портале Microsoft Global Development and Computing.

 

Редактор методов ввода (IME) — это программа, которая позволяет легко вводить текст с помощью стандартной клавиатуры для восточно-азиатских языков, таких как китайский, японский, корейский и другие языки со сложными символами. Например, с помощью редакторов IME пользователь может вводить сложные символы в текстовом процессоре, или проигрыватель многомногопользовательской Интернет-игры может общаться с друзьями в сложных символах.

В этой статье объясняется, как можно реализовать базовый элемент управления редактора IME в полноэкранном приложении Microsoft DirectX. Приложения, использующие преимущества ДКСУТ, автоматически получают функции IME. Для приложений, которые не используют платформу, в этой статье описывается добавление поддержки IME в элемент управления "поле ввода".

Содержимое:

-   [Поведение IME по умолчанию](#default-ime-behavior)
-   [Использование IME с ДКСУТ](#using-imes-with-dxut)
-   [Переопределение поведения IME по умолчанию](#overriding-the-default-ime-behavior)
-   [Функции](#functions)
-   [Сообщения](#ime-messages)
-   [Примеры](#examples)
    -   [Редактор метода CHT версии 4,2, 4,3 и 4,4](#cht-ime-version-42-43-and-44)
    -   [Метод IME для CHT версии 5,0](#cht-ime-version-50)
    -   [Метод IME версии 5,1, 5,2 и CHS IME версии 5,3](#cht-ime-version-51-52-and-chs-ime-version-53)
    -   [CHS IME версии 4,1](#chs-ime-version-41)
    -   [CHS IME версии 4,2](#chs-ime-version-42)
-   [Сообщения IME](#ime-messages)
    -   [WM \_ инпутлангчанже](#wm_inputlangchange)
    -   [\_старткомпоситион IME \_ WM](/windows)
    -   [\_композиция IME \_ WM](/windows)
    -   [\_ендкомпоситион IME \_ WM](/windows)
    -   [\_уведомление редактора IME WM \_](/windows)
-   [Отрисовка](#rendering)
    -   [Индикатор локали ввода](#input-locale-indicator)
    -   [Окно композиции](#composition-window)
    -   [Чтение и кандидат Windows](#reading-and-candidate-windows)
-   [Ограничения](#limitations)
-   [Сведения о реестре](#registry-information)
-   [Приложение а. версии CHT для каждой операционной системы](#appendix-a-cht-versions-per-operating-system)
-   [Дополнительные сведения](#further-information)
-   [жетреадингстринг](#getreadingstring)
-   [шовреадингвиндов](#showreadingwindow)

## <a name="default-ime-behavior"></a>Поведение IME по умолчанию

Редакторы IME сопоставляют ввод с клавиатуры с фонетическими компонентами или другими элементами языка, характерными для выбранного языка. В типичном сценарии пользователь вводит ключи, представляющие произношение сложного символа. Если редактор IME распознает произношение как допустимый, он предоставляет пользователю список кандидатов слов или фраз, из которых пользователь может выбрать последний вариант. затем выбранное слово отправляется в приложение через ряд сообщений Microsoft Windows [**WM \_ CHAR**](/windows/desktop/inputdev/wm-char) . Поскольку редактор IME работает на уровне ниже приложения путем перехвата ввода с клавиатуры, наличие редактора IME прозрачно для приложения. почти все Windows приложения могут легко воспользоваться преимуществами ime, не обращаясь к их существованию и не требуя специального программирования.

Типичный редактор IME отображает несколько окон для указания пользователя в символьной записи, как показано в следующих примерах.

![в IME отображается несколько окон](images/ime-elements.png)

| Тип окна                                       | Описание                                                                                                                                                                                                                                                                                                                 | Выходные данные IME                                   |
|---------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|
| A. Окно чтения                                 | Содержит нажатия клавиш с клавиатуры; как правило, изменения после каждого нажатия клавиши.                                                                                                                                                                                                                                              | считывание строки                               |
| Б. Окно композиции                             | Содержит коллекцию символов, которые пользователь состоял с редактором IME. Эти символы рисуются редактором IME поверх приложения. Когда пользователь уведомляет IME о приемлемой строке композиции, редактор IME отправляет строку композиции приложению через ряд \_ сообщений WM char. | Строка композиции                           |
| В. Окно кандидатов                               | Когда пользователь вводит допустимое произношение, редактор IME отображает список символов-кандидатов, которые соответствуют заданному произношению. Затем пользователь выбирает из этого списка предполагаемый символ, а редактор IME добавляет этот символ в окно композиции.                                                    | Следующий символ в строке композиции |
| Г. Индикатор [локали ввода](/windows/desktop/Intl/nls-terminology) | Показывает язык, выбранный пользователем для ввода с клавиатуры. этот индикатор внедрен на панель задач Windows. Чтобы выбрать язык ввода, откройте панель управления язык и региональные стандарты, а затем щелкните сведения на вкладке языки.                                                               | \-                                           |



 

## <a name="using-imes-with-dxut"></a>Использование IME с ДКСУТ

В ДКСУТ класс Кдксутимидитбокс реализует функциональность IME. Этот класс является производным от класса Кдксутедитбокс, базового элемента управления Edit, предоставляемого платформой. Кдксутимидитбокс расширяет этот элемент управления "поле ввода" для поддержки IME путем переопределения методов Кдксутимидитбокс. Эти классы разработаны таким образом, чтобы помочь разработчикам узнать, что нужно сделать из платформы, чтобы реализовать поддержку IME в своих собственных элементах управления редактирования. В оставшейся части этого раздела объясняется, как платформа и Кдксутимидитбокс в частности, переопределяет базовый элемент управления "поле ввода" для реализации функций IME.

Большинство переменных IME в Кдксутимидитбокс объявляются как статические, поскольку многие буферы и состояния IME относятся к конкретному процессу. Например, процесс содержит только один буфер для строки композиции. Даже если процесс имеет десять элементов управления "поле ввода", все они будут совместно использовать один и тот же буфер строк композиции. Таким образом, буфер строк композиции для Кдксутимидитбокс является статическим и не позволяет приложению занимать ненужное пространство памяти.

Кдксутимидитбокс реализуется в следующем коде ДКСУТ:

(Корень пакета SDK) \\ Примеры \\ C++ \\ Common \\ дксутгуи. cpp

## <a name="overriding-the-default-ime-behavior"></a>Переопределение поведения IME по умолчанию

обычно редактор IME использует стандартные процедуры Windows для создания окна (см. раздел [использование Windows](/windows/desktop/winmsg/using-windows)). В обычных обстоятельствах это дает удовлетворительные результаты. Однако если приложение представлено в полноэкранном режиме, как обычно используется для игр, стандартные окна больше не работают и могут не отображаться поверх приложения. чтобы преодолеть эту ошибку, приложение должно изобразить сами окна IME вместо того, чтобы полагаться на Windows для выполнения этой задачи.

Если поведение при создании окна IME по умолчанию не позволяет определить, что требуется приложению, приложение может переопределить обработку окна IME. Приложение может достичь этого, обрабатывая сообщения, связанные с IME, и вызывая API [диспетчера методов ввода](/windows/desktop/Intl/input-method-manager) (IMM).

Когда пользователь взаимодействует с IME для ввода сложных символов, IMM отправляет сообщения в приложение, чтобы уведомить его о важных событиях, таких как запуск композиции или отображение окна кандидатов. Приложение обычно игнорирует эти сообщения и передает их в обработчик сообщений по умолчанию, что приводит к их обработке редактором IME. Когда приложение, а не обработчик по умолчанию, обрабатывает сообщения, оно точно определяет, что происходит в каждом из событий IME. Часто обработчик сообщений получает содержимое различных окон IME путем вызова API IMM. После того, как приложение покажет эти сведения, оно может правильно отображать окна IME, когда оно должно отображаться на экране.

## <a name="functions"></a>Функции

Редактору IME необходимо получить строку чтения, скрыть окно чтения и получить ориентацию окна чтения. В этой таблице показаны функции для каждой версии IME:



|                    | Идет чтение строки                                                | Скрытие окна чтения                       | Ориентация окна чтения                              |
|--------------------|-----------------------------------------------------------------------|---------------------------------------------|------------------------------------------------------------|
| **До версии 6,0** | A. Чтение закрытых данных IME в окне прямого доступа. См. раздел "4 структуры". | Ловушки частных сообщений IME. См. "3 сообщения" | Изучите сведения реестра. См. раздел «5 данных реестра». |
| **После версии 6,0**  | [жетреадингстринг](#getreadingstring)                                 | [шовреадингвиндов](#showreadingwindow)     | [жетреадингстринг](#getreadingstring)                      |



 

## <a name="messages"></a>Сообщения

Следующие сообщения не должны обрабатываться для нового редактора IME, реализующего [шовреадингвиндов](#showreadingwindow)().

Следующие сообщения перехватываются обработчиком сообщений приложения (т. е. они не передаются в Дефвиндовпрок), чтобы предотвратить отображение окна чтения.

``` syntax
Msg == WM_IME_NOTIFY
wParam == IMN_PRIVATE
lParam == 1, 2 (CHT IME version 4.2, 4.3 and 4.4 / CHS IME 4.1 and 4.2)
lParam == 16, 17, 26, 27, 28 (CHT IME version 5.0, 5.1, 5.2 / CHS IME 5.3)
```

## <a name="examples"></a>Примеры

В следующих примерах показано, как получить сведения о строках из старого редактора IME, не имеющего Жетреадингстринг (). Код создает следующие выходные данные:



| Выходные данные              | Описание                                                                                      |
|--------------|---------------------------------------------------------------------------------------|
| DWORD двлен  | Длина строки чтения.                                                          |
| DWORD дверр  | Индекс символа ошибки.                                                                   |
| LPWSTR встр  | Указатель на строку чтения.                                                         |
| BOOL (Юникод) | Если значение равно true, строка чтения имеет формат Юникода. В противном случае он имеет формат многобайтового формата. |



 

### <a name="cht-ime-version-42-43-and-44"></a>Редактор метода CHT версии 4,2, 4,3 и 4,4

``` syntax
LPINPUTCONTEXT lpIMC = _ImmLockIMC(himc);
LPBYTE p = *(LPBYTE *)((LPBYTE)_ImmLockIMCC(lpIMC->hPrivate) + 24);
if (!p) break;
dwlen = *(DWORD *)(p + 7*4 + 32*4);
dwerr = *(DWORD *)(p + 8*4 + 32*4);
wstr = (WCHAR *)(p + 56);
unicode = TRUE;
```

### <a name="cht-ime-version-50"></a>Метод IME для CHT версии 5,0

``` syntax
LPINPUTCONTEXT lpIMC = _ImmLockIMC(himc);
LPBYTE p = *(LPBYTE *)((LPBYTE)_ImmLockIMCC(lpIMC->hPrivate) + 3*4);
if (!p) break;
p = *(LPBYTE *)((LPBYTE)p + 1*4 + 5*4 + 4*2 );
if (!p) break;
dwlen = *(DWORD *)(p + 1*4 + (16*2+2*4) + 5*4 + 16);
dwerr = *(DWORD *)(p + 1*4 + (16*2+2*4) + 5*4 + 16 + 1*4);
wstr = (WCHAR *)(p + 1*4 + (16*2+2*4) + 5*4);
unicode = FALSE;
```

### <a name="cht-ime-version-51-52-and-chs-ime-version-53"></a>Метод IME версии 5,1, 5,2 и CHS IME версии 5,3

``` syntax
LPINPUTCONTEXT lpIMC = _ImmLockIMC(himc);
LPBYTE p = *(LPBYTE *)((LPBYTE)_ImmLockIMCC(lpIMC->hPrivate) + 4);
if (!p) break;
p = *(LPBYTE *)((LPBYTE)p + 1*4 + 5*4); 
if (!p) break;
dwlen = *(DWORD *)(p + 1*4 + (16*2+2*4) + 5*4 + 16 * 2);
dwerr = *(DWORD *)(p + 1*4 + (16*2+2*4) + 5*4 + 16 * 2 + 1*4);
wstr  = (WCHAR *) (p + 1*4 + (16*2+2*4) + 5*4);
unicode = TRUE;
```

### <a name="chs-ime-version-41"></a>CHS IME версии 4,1

``` syntax
// GetImeId(1) returns VS_FIXEDFILEINFO:: dwProductVersionLS of IME file
int offset = ( GetImeId( 1 ) >= 0x00000002 ) ? 8 : 7;
LPINPUTCONTEXT lpIMC = _ImmLockIMC(himc);
BYTE p = *(LPBYTE *)((LPBYTE)_ImmLockIMCC(lpIMC->hPrivate) + offset * 4);
if (!p) break;
dwlen = *(DWORD *)(p + 7*4 + 16*2*4);
dwerr = *(DWORD *)(p + 8*4 + 16*2*4);
dwerr = min(dwerr, dwlen);
wstr = (WCHAR *)(p + 6*4 + 16*2*1);
unicode = TRUE;
```

### <a name="chs-ime-version-42"></a>CHS IME версии 4,2

``` syntax
int nTcharSize = IsNT() ? sizeof(WCHAR) : sizeof(char);
LPINPUTCONTEXT lpIMC = _ImmLockIMC(himc);
BYTE p = *(LPBYTE *)((LPBYTE)_ImmLockIMCC(lpIMC->hPrivate) + 1*4 + 1*4 + 6*4);
if (!p) break;
dwlen = *(DWORD *)(p + 1*4 + (16*2+2*4) + 5*4 + 16 * nTcharSize);
dwerr = *(DWORD *)(p + 1*4 + (16*2+2*4) + 5*4 + 16 * nTcharSize + 1*4);
wstr  = (WCHAR *) (p + 1*4 + (16*2+2*4) + 5*4);
unicode = IsNT() ? TRUE : FALSE;
```

## <a name="ime-messages"></a>Сообщения IME

Полноэкранное приложение должно правильно работать со следующими сообщениями, связанными с IME:

### <a name="wm_inputlangchange"></a>WM \_ инпутлангчанже

Модуль IMM отправляет сообщение WM \_ инпутлангчанже в активное окно приложения после того, как пользовательский язык ввода был изменен пользователем с помощью сочетания клавиш (обычно Alt + Shift) или с индикатором локали ввода на панели задач или в языковой панели. Языковая панель — это элемент управления на экране, с помощью которого пользователь может настроить службу текстового ввода. (См. раздел [как показать языковую панель](/windows/desktop/TSF/how-to-set-up-tsf).) На следующем снимке экрана показан список выбора языка, который отображается, когда пользователь щелкает индикатор локали.

![Список выбора языка, который отображается, когда пользователь щелкает индикатор локали](images/ime-langselection.png)

Когда модуль IMM отправляет сообщение WM \_ инпутлангчанже, кдксутимидитбокс должен выполнить несколько важных задач:

1.  Метод Жеткэйбоардлайаут вызывается для возврата идентификатора локали ввода (ID) для потока приложения. Класс Кдксутимидитбокс сохраняет этот идентификатор в статической переменной члена s \_ хклкуррент для последующего использования. Важно, чтобы приложение знало текущий язык ввода, поскольку редактор IME для каждого языка имеет собственное поведение. Разработчику может потребоваться предоставить другой код для разных языков ввода.
2.  Кдксутимидитбокс инициализирует строку для отображения в индикаторе языка поля редактирования. Этот индикатор может отображать активный язык ввода, когда приложение работает в полноэкранном режиме, и ни панель задач, ни языковая панель не видны.
3.  Метод Иммжетконверсионстатус вызывается для указания того, находится ли язык ввода в собственном или несобственном режиме преобразования. Собственный режим преобразования позволяет пользователю вводить текст на выбранном языке. Неуправляемый режим преобразования делает клавиатуру стандартной английской клавиатуры. Важно дать пользователю визуальную подсказку о том, в каком типе преобразования находится редактор IME, чтобы пользователь мог легко узнать, какие символы должны быть доступны при попадании в ключ. Кдксутимидитбокс предоставляет эту визуальную подсказку с цветом индикатора языка. Когда язык ввода использует IME с собственным режимом преобразования, класс Кдксутимидитбокс рисует текст индикатора цветом, определенным \_ параметром m индикаторимеколор. Если редактор IME находится в режиме преобразования, отличном от Native, или вообще не используется IME, класс рисует текст индикатора с цветом, определенным \_ параметром m индикаторенгколор.
4.  Кдксутимидитбокс проверяет язык ввода и устанавливает для статической переменной члена s \_ бинсертонтипе значение true для корейского языка и false для всех остальных языков. Этот флаг необходим из-за различных вариантов поведения корейского IME и других редакторов IME. При вводе символов на языках, отличных от корейского, вводимый пользователем текст отображается в окне композиции, и пользователь может свободно изменять содержимое строки композиции. Пользователь нажимает клавишу ВВОД при удовлетворении строки композиции, а строка композиции отправляется в приложение как ряд \_ сообщений WM char. Однако в редакторах IME для корейского языка, когда пользователь нажимает клавишу для ввода текста, символ немедленно отправляется в приложение. Когда пользователь в дальнейшем нажимает больше ключей для изменения начального символа, символ в поле ввода изменяется в соответствии с дополнительными входными данными пользователя. По сути, пользователь состоит из составляющих символов в поле ввода. Эти два поведения по-разному могут быть Кдксутимидитбокс для каждого из них.
5.  Статический метод-член Сетупимеапи вызывается для получения адресов двух функций из модуля IME: Жетреадингстринг и Шовреадингвиндов. Если эти функции существуют, вызывается Шовреадингвиндов, чтобы скрыть окно чтения по умолчанию для этого редактора IME. Так как приложение визуализирует само окно чтения, оно уведомляет редактор IME о необходимости отключить прорисовку окна чтения по умолчанию, чтобы оно не мешало отрисовке в полноэкранном режиме.

Модуль IMM отправляет \_ сообщение SETCONTEXT редактора WM IME \_ при активации окна приложения. Параметр lParam этого сообщения содержит флаг, указывающий редактору IME, что должны быть выведены окна, а какие — нет. Поскольку приложение обрабатывает всю прорисовку, редактор IME не требует прорисовки каких-либо окон IME. Таким образом, обработчик сообщений приложения просто устанавливает параметр lParam в значение 0 и возвращает.

Чтобы обеспечить поддержку редактора IME для приложений, требуется специальная обработка, связанная с IME, \_ \_ SETCONTEXT IME. поскольку Windows обычно отправляет это сообщение в приложение до вызова метода панорамаинитиализе (), для панорамы не существует шанса обработать пользовательский интерфейс для отображения окон списка кандидатов.

в следующем фрагменте кода указано, Windows приложения не отображают пользовательский интерфейс, связанный с окном списка кандидатов, что позволяет использовать панораму для специально обрабатывающего этого пользовательского интерфейса.

``` syntax
case WM_IME_SETCONTEXT:
         lParam = 0;
    lRet = DefWindowProc(hWnd, msg, wParam, lParam);
    break;
    //... more message processing
    return lRet;
```

### <a name="wm_ime_startcomposition"></a>\_старткомпоситион IME \_ WM

Модуль IMM отправляет \_ сообщение старткомпоситион редактора IME WM в \_ приложение, когда композиция IME собирается начать работу в результате нажатия клавиш пользователем. Если редактор IME использует окно композиции, то он отображает текущую строку композиции в окне композиции. Кдксутимидитбокс обрабатывает это сообщение, выполняя две задачи:

1.  Кдксутимидитбокс очищает буфер строк композиции и буфер атрибутов. Эти буферы являются статическими членами Кдксутимидитбокс.
2.  Кдксутимидитбокс задает \_ значение true для статической переменной члена бхидекарет. Этот член, определенный в базовом классе Кдксутедитбокс, определяет, следует ли рисовать курсор в поле ввода при отрисовке поля редактирования. Окно композиции работает аналогично полю редактирования с текстом и курсором. Чтобы избежать путаницы при отображении окна композиции, поле редактирования скрывает курсор таким образом, чтобы в каждый момент времени был виден только один курсор.

### <a name="wm_ime_composition"></a>\_композиция IME \_ WM

Модуль IMM отправляет в \_ приложение сообщение композиции редактора IME WM, \_ когда пользователь вводит нажатие клавиши для изменения строки композиции. Значение lParam указывает тип информации, которую приложение может извлечь из диспетчера метода ввода (IMM). Приложение должно извлечь доступную информацию, вызвав [**иммжеткомпоситионстринг**](/windows/desktop/api/imm/nf-imm-immgetcompositionstringa) , а затем сохранить данные в своем частном буфере, чтобы он мог ВИЗУАЛИЗИРОВАТЬ элементы IME позже.

Кдксутимидитбокс проверяет наличие и получает следующие данные строки композиции:



| [**WM \_ Значение \_**](/windows/desktop/Intl/wm-ime-composition) флага lParam для композиции IME | Данные                           | Описание                                                                                                                                                                                                                                                                                                                                                          |
|-----------------------------------------------------------------------|--------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| \_КОМПАТТР GC                                                         | Атрибут компоновки          | Этот атрибут содержит такие сведения, как состояние каждого символа в строке композиции (например, преобразованный или не преобразованный). Эти сведения необходимы, так как Кдксутимидитбокс цвета символы строки композиции по-разному основаны на их атрибутах.                                                                                   |
| \_КОМПКЛАУСЕ GC                                                       | Сведения о предложении композиции | Сведения об этом предложении используются, когда активен редактор IME для японского языка. При преобразовании строки компоновки на японском языке символы могут быть сгруппированы вместе как предложение, которое преобразуется в одну сущность. Когда пользователь перемещает курсор, Кдксутимидитбокс использует эти сведения для выделения всего предложения целиком, а не всего одного символа в предложении. |
| \_КОМПСТР GC                                                          | Строка композиции             | Эта строка является актуальной строкой, которая формируется пользователем. Это также строка, отображаемая в окне композиции.                                                                                                                                                                                                                                        |
| \_КУРСОРПОС GC                                                        | Расположение курсора композиции    | В окне композиции реализуется курсор, аналогичный курсору в поле ввода. Приложение может извлекать позицию курсора при обработке \_ \_ сообщения композиции редактора мыши WM, чтобы правильно нарисовать курсор.                                                                                                                                            |
| \_РЕСУЛТСТР GC                                                        | Результирующая строка                  | Результирующая строка доступна, когда пользователь собирается завершить процесс композиции. Эта строка должна быть получена, а символы должны быть отправлены в поле ввода.                                                                                                                                                                                        |



 

### <a name="wm_ime_endcomposition"></a>\_ендкомпоситион IME \_ WM

Модуль IMM отправляет \_ сообщение ендкомпоситион редактора IME WM в \_ приложение при завершении операции композиции IME. Это может произойти, когда пользователь нажимает клавишу ВВОД для утверждения строки композиции или клавишу ESC для отмены композиции. Кдксутимидитбокс обрабатывает это сообщение, настроив буфер строк композиции как пустой. Затем \_ параметру бхидекарет присваивается значение false, так как окно композиции закрывается, а курсор в поле ввода снова становится видимым.

Обработчик сообщений Кдксутимидитбокс также устанавливает \_ для бшовреадингвиндов значение false. Этот флаг определяет, будет ли класс рисовать окно чтения, когда поле ввода отображается, поэтому при завершении компоновки должно быть задано значение FALSE.

### <a name="wm_ime_notify"></a>\_уведомление редактора IME WM \_

Модуль IMM отправляет сообщение с \_ уведомлением редактора IME WM \_ в приложение при каждом изменении окна редактора IME. Приложение, обрабатывающее Рисование окон IME, должно обработать это сообщение, чтобы оно знало о любом обновлении содержимого окна. Параметр wParam обозначает выполняемую команду или изменение. Кдксутимидитбокс обрабатывает следующие команды:




| Команда IME | Описание | 
|-------------|-------------|
| <a href="/windows/desktop/Intl/imn-setopenstatus">IMN_SETOPENSTATUS</a> | Этот атрибут содержит такие сведения, как состояние каждого символа в строке композиции (например, преобразованный или не преобразованный). Эти сведения необходимы, так как Кдксутимидитбокс цвета символы строки композиции по-разному основаны на их атрибутах. | 
| <a href="/windows/desktop/Intl/imn-opencandidate">IMN_OPENCANDIDATE</a>  /  <a href="/windows/desktop/Intl/imn-changecandidate">IMN_CHANGECANDIDATE</a> | Отправляется в приложение, когда окно кандидатов будет открыто или Обновлено соответственно. Если пользователь хочет изменить преобразованный текст, откроется окно кандидатов. Окно обновляется, когда пользователь перемещает индикатор выделения или изменяет страницу. Кдксутимидитбокс использует один обработчик сообщений для обеих этих команд, так как необходимые задачи точно одинаковы:<br /><ol><li>Кдксутимидитбокс задает элемент Бшоввиндов структуры списка кандидатов s_CandList значение TRUE, чтобы указать, что окно кандидатов должно рисоваться во время отрисовки кадров.</li><li>Кдксутимидитбокс извлекает список кандидатов, вызывая <a href="/windows/desktop/api/imm/nf-imm-immgetcandidatelista"><strong>иммжеткандидателист</strong></a>, сначала для получения требуемого размера буфера, а затем снова для получения фактических данных.</li><li>Структура списка частных кандидатов s_CandList инициализируется извлеченными данными-кандидатами.</li><li>Строки-кандидаты хранятся в виде массива строк.</li><li>Будет сохранен индекс выбранной записи, а также индекс страницы.</li><li>Кдксутимидитбокс проверяет, является ли стиль окна кандидатов вертикальным или горизонтальным. Если стиль окна является горизонтальным, то дополнительный буфер строки, член Хориканд s_CandList, должен инициализироваться со всеми строками-кандидатами, в которых вставлены символы пробела между соседними строками. При отрисовке вертикального окна-кандидата отдельные строки-кандидаты рисуются по одному за раз, а координаты y увеличиваются для каждой строки. Однако эту строку Хориканд следует использовать при отрисовке горизонтального окна-кандидата, поскольку символ пробела является лучшим способом разделения двух смежных строк в одной строке.</li></ol> | 
| <a href="/windows/desktop/Intl/imn-closecandidate">IMN_CLOSECANDIDATE</a> | Отправляется в приложение, когда будет закрыто окно кандидатов. Это происходит, когда пользователь сделал выбор из списка кандидатов. Кдксутимидитбокс обрабатывает эту команду, устанавливая для флага Visible окна кандидатов значение FALSE, а затем очищает буфер строки-кандидата. | 
| IMN_PRIVATE | Отправляется в приложение, когда редактор IME обновляет строку чтения в результате ввода или удаления символов пользователем. Приложение должно получить строку чтения и сохранить ее для подготовки к просмотру. Кдксутимидитбокс имеет два метода для получения строки чтения, основываясь на том, как считывание строк поддерживается в IME: <br /><ul><li>Если редактор IME поддерживает функцию Жетреадингстринг, вызывается Жетреадингстринг для получения строки чтения.</li><li>Если редактор IME не реализует Жетреадингстринг, Кдксутимидитбокс извлекает строку чтения из содержимого входного контекста.</li></ul> | 




 

## <a name="rendering"></a>Отрисовка

Отрисовка элементов IME и окон осуществляется просто. Кдксутимидитбокс позволяет сначала подготовить базовый класс, так как окна IME должны отображаться в верхней части элемента управления "поле ввода". После отображения базового поля редактирования Кдксутимидитбокс проверяет флаг видимости для каждого окна IME (индикатор, композиция, кандидат и окно чтения) и отображает окно, если оно должно быть видимым. Описание различных типов окон IME см. в разделе поведение IME по умолчанию.

### <a name="input-locale-indicator"></a>Индикатор локали ввода

Индикатор локали ввода подготавливается к просмотру перед любыми другими окнами IME, так как это элемент, который всегда отображается. Поэтому он должен отображаться под другими окнами IME. Кдксутимидитбокс визуализирует индикатор, вызывая метод Рендериндикатор, в котором цвет шрифта индикатора определяется с помощью проверки \_ статической переменной s, которая отражает текущий режим преобразования IME. Если редактор IME включен и встроенное преобразование активно, метод использует m индикаторимеколор в \_ качестве цвета индикатора. Если редактор IME отключен или находится в несобственном режиме преобразования, \_ для рисования текста индикатора используется m индикаторимеколор. По умолчанию окно индикатора отображается справа от поля ввода. Приложения могут изменить это поведение, переопределив метод Рендериндикатор.

На следующем рисунке показаны различные варианты обозначения языка ввода для английского языка, японского языка в алфавитно-цифровых режимах преобразования и японского языка в режиме встроенного преобразования:

![различные варианты обозначения языка ввода для английского и японского языков](images/ime-indicator.png)

### <a name="composition-window"></a>Окно композиции

Рисование окна композиции обрабатывается в методе Рендеркомпоситион объекта Кдксутимидитбокс. Окно композиции перемещается над полем ввода. Он должен отображаться в позиции курсора базового элемента управления "поле ввода". Кдксутимидитбокс обрабатывает отрисовку следующим образом:

1.  Вся строка композиции рисуется с использованием цветов строк композиции по умолчанию.
2.  Символы с определенными специальными атрибутами должны отображаться на разных цветах, поэтому Кдксутимидитбокс проверяет символы строки композиции и проверяет атрибут String. Если атрибут вызывает разные цвета, символ снова рисуется с соответствующими цветами.
3.  Курсор окна композиции рисуется для завершения отрисовки.

Курсор должен мигать для корейского IME, но не для других редакторов IME. Рендеркомпоситион определяет, должен ли курсор быть видимым на основе значений таймера при использовании корейского редактора IME.

### <a name="reading-and-candidate-windows"></a>Чтение и кандидат Windows

Окна чтения и кандидатов отображаются одним и тем же методом Кдксутимидитбокс, Рендеркандидатереадингвиндов. Оба окна содержат массив строк для вертикального макета или одну строку в случае горизонтального макета. Основная часть кода в Рендеркандидатереадингвиндов используется для размещения окна таким образом, чтобы ни одна часть окна не находилась вне окна приложения и не была обрезана.

## <a name="limitations"></a>Ограничения

Редакторы IME иногда содержат дополнительные функции, позволяющие упростить ввод текста. Некоторые функции, доступные в более новых редакторах IME, показаны на следующих рисунках. Эти дополнительные функции отсутствуют в ДКСУТ. Реализация поддержки этих дополнительных функций может быть сложной, поскольку для получения необходимой информации из редакторов IME не определен интерфейс.

Расширенный китайский язык IME с расширенным списком кандидатов:

![Расширенный китайский язык IME с расширенным списком кандидатов](images/ime-advanced1.png)

Расширенный IME для японского языка с некоторыми потенциальными записями, содержащими дополнительный текст для описания их значений:

![Расширенный японский редактор IME с некоторыми потенциальными записями, содержащими дополнительный текст для описания их значений](images/ime-advanced2.png)

Расширенный редактор IME для корейского языка, включающий систему распознавания рукописного текста:

![Расширенный корейский язык IME, включающий систему распознавания рукописного текста](images/ime-advanced3.png)

## <a name="registry-information"></a>Сведения о реестре

Следующие данные реестра проверяются, чтобы определить ориентацию окна чтения, если текущий редактор IME имеет старую версию CHT New фонетическая, не реализующая Жетреадингстринг ().



| Клавиши                                                           | Значение            |
|---------------------------------------------------------------|------------------|
| HKCU \\ программное обеспечение \\ Microsoft \\ Windows \\ CurrentVersion \\ IME \_ Name | Сопоставление клавиш |



 

Где: \_ имя IME — мстЦиф, если версия файла IME — 5,1 или более поздняя; в противном случае \_ имя IME — тинтлгнт.

Ориентация окна чтения горизонтальна, если:

-   Редактор IME имеет версию 5,0, а значение сопоставления клавиатуры — 0x22 или 0x23.
-   Редактор IME имеет версию 5,1 или 5,2, а параметр сопоставления клавиатуры имеет значение 0x22, 0x23 или 0x24.

Если ни одно из условий не выполнено, окно чтения является вертикальным.

## <a name="appendix-a-cht-versions-per-operating-system"></a>Приложение а. версии CHT для каждой операционной системы



| Операционная система           | Версия IME для CHT |
|----------------------------|-----------------|
| Windows 98                 | 4.2             |
| Windows 2000               | 4.3             |
| неизвестно                    | 4.4.             |
| Windows ПОМОЩЬ                 | 5.0             |
| Office XP                  | 5.1             |
| Windows XP                 | 5,2             |
| Автономный веб-довнлоадбле | 6,0             |



 

## <a name="further-information"></a>Дополнительные сведения

Дополнительные сведения см. в следующих разделах:

-   [Установка и использование редакторов метода ввода](/windows/desktop/DxTechArts/installing-and-using-input-method-editors)
-   [Международный вывод текста](/windows/desktop/Intl/creating-your-own-format-selection-user-interface)
-   [Консорциум Unicode](https://www.unicode.org/)
-   Разработка международного программного обеспечения. Dr. International. второй Ed. Redmond, штат Вашингтон: Microsoft Press, 2003.

## <a name="getreadingstring"></a>жетреадингстринг

Получает сведения о строках.

**Параметры**

<dl> <dt>

<span id="himc_"></span><span id="HIMC_"></span>*химк* 
</dt> <dd>

\[в \] контексте ввода.

</dd> <dt>

<span id="uReadingBufLen"></span><span id="ureadingbuflen"></span><span id="UREADINGBUFLEN"></span>*уреадингбуфлен*
</dt> <dd>

\[\]Длина лпвреадингбуф в WCHAR. Если он равен нулю, это означает, что длина буфера чтения запросов превышает.

</dd> <dt>

<span id="lpwReadingBuf_"></span><span id="lpwreadingbuf_"></span><span id="LPWREADINGBUF_"></span>*лпвреадингбуф* 
</dt> <dd>

\[исходящий \] Возврат строки (не ноль в конце).

</dd> <dt>

<span id="pnErrorIndex_"></span><span id="pnerrorindex_"></span><span id="PNERRORINDEX_"></span>*пнеррориндекс* 
</dt> <dd>

\[out \] возвращает индекс символа ошибки в строке чтения, если таковой имеется.

</dd> <dt>

<span id="pfIsVertical_"></span><span id="pfisvertical_"></span><span id="PFISVERTICAL_"></span>*пфисвертикал* 
</dt> <dd>

\[Если это так \] , то пользовательский интерфейс считывается вертикально. В противном случае — горизонтальное Пумаксреадинглен.

</dd> <dt>

<span id="puMaxReadingLen_"></span><span id="pumaxreadinglen_"></span><span id="PUMAXREADINGLEN_"></span>*пумаксреадинглен* 
</dt> <dd>

\[\]Длина пользовательского интерфейса чтения. Максимальная длина чтения не фиксирована; Он зависит не только от раскладки клавиатуры, но и от режима ввода (например, внутреннего кода, суррогатного ввода).

</dd> </dl>

**Возвращаемые значения**

Длина строки чтения.

**Замечания**

Если возвращаемое значение больше значения параметра Уреадингбуфлен, то все выходные параметры не определены.

Эта функция реализована в CHT IME 6,0 или более поздней версии и может быть получена с помощью GetProcAddress в обработчике модуля IME. обработчик модуля IME может быть получен с помощью Иммжетимефиленаме и LoadLibrary.

**Требования**

<dl> <dt>

<span id="Header"></span><span id="header"></span><span id="HEADER"></span>**Заголовок**
</dt> <dd>

Объявлено в IMM. h.

</dd> <dt>

<span id="Import_Library"></span><span id="import_library"></span><span id="IMPORT_LIBRARY"></span>**Импорт библиотеки**
</dt> <dd>

Используйте IMM. lib.

</dd> </dl>

## <a name="showreadingwindow"></a>шовреадингвиндов

Показать (или скрыть) окно чтения.

**Параметры**

<dl> <dt>

<span id="himc_"></span><span id="HIMC_"></span>*химк* 
</dt> <dd>

\[в \] контексте ввода.

</dd> <dt>

<span id="bShow_"></span><span id="bshow_"></span><span id="BSHOW_"></span>*бшов* 
</dt> <dd>

\[в поле имеет \] значение true, чтобы показать окно чтения (или false, чтобы скрыть его).

</dd> </dl>

**Возвращаемые значения**

**Замечания**

Возвращает значение TRUE в случае успеха или FALSE в противном случае.

**Требования**

<dl> <dt>

<span id="Header"></span><span id="header"></span><span id="HEADER"></span>**Заголовок**
</dt> <dd>

Объявлено в IMM. h.

</dd> <dt>

<span id="Import_Library"></span><span id="import_library"></span><span id="IMPORT_LIBRARY"></span>**Импорт библиотеки**
</dt> <dd>

Используйте IMM. lib.

</dd> </dl>
