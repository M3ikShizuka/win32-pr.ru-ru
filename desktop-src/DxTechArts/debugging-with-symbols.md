---
title: Отладка с использованием символов
description: В этой статье представлен общий обзор того, как лучше использовать символы в процессе отладки.
ms.assetid: 7ce0c9c7-485c-8d72-0353-27fd2e369a7c
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: cdabd1a99f203adb2422cc4bbc71c3fb2f6108a0a3869077e97683bdcf830100
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119070564"
---
# <a name="debugging-with-symbols"></a>Отладка с использованием символов

В этой статье представлен общий обзор того, как лучше использовать символы в процессе отладки. В нем объясняется, как использовать сервер символов Майкрософт, а также как настроить и использовать собственный частный сервер символов. Эти рекомендации помогут повысить эффективность и способность отлаживать проблемы даже в тех случаях, когда все символы и исполняемые файлы, связанные с проблемой, не находятся на компьютере.

-   [Символы](#debugging-with-symbols)
-   [Использование символов для отладки](#using-symbols-for-debugging)
-   [Получение необходимых символов](#getting-the-symbols-you-need)
    -   [Проверьте, совпадает ли заданная библиотека DLL или файл .exe и PDB в одной папке](#check-if-a-given-dll-or-exe-file-and-pdb-in-the-same-folder-match)
    -   [Убедитесь, что все библиотеки DLL и исполняемые файлы в наборе папок соответствуют PDB](#check-if-all-the-dlls-and-executable-files-in-a-set-of-folders-have-matching-pdbs)
    -   [Как работает симчк](#how-symchk-works)
-   [Серверы символов](#symbol-servers)
-   [Использование сервера символов Майкрософт](#using-the-microsoft-symbol-server)
-   [Получение символов вручную](#getting-symbols-manually)
-   [Настройка сервера символов](#setting-up-a-symbol-server)
-   [Добавление символов на сервер символов](#adding-symbols-to-a-symbol-server)
-   [Рекомендации](#best-practices)

## <a name="symbols"></a>Символы

Для отладки доступен ряд различных типов символов. К ним относятся Информация CodeView символы, COFF, DBG, SYM, PDB и даже экспорт символов, созданных из таблицы экспорта двоичных файлов. В этом техническом документе обсуждаются только VS.NET и символы формата PDB, так как они являются самыми последними Предпочтительными форматами. Они создаются по умолчанию для проектов, компилируемых с помощью Visual Studio.

Создание PDB-файлов для исполняемых объектов выпуска не влияет на оптимизацию или значительно изменяет размер создаваемых файлов. Как правило, единственным отличием является путь, а имя файла PDB-файла внедряется в исполняемый файл. По этой причине следует всегда создавать PDB-файлы, даже если вы не хотите поставлять их вместе с исполняемым файлом.

PDB-файлы создаются, если проект строится с помощью параметра компилятора **/Zi** или **/Zi** (создание сведений о PDB), а также коммутатора компоновщика **/Debug** (создание отладочной информации). PDB-файлы, созданные компилятором, объединяются и записываются в один файл PDB, который размещается в том же каталоге, что и исполняемый объект.

По умолчанию PDB-файлы содержат следующие сведения:

-   Открытые символы (обычно все функции, статические и глобальные переменные)
-   Список объектных файлов, отвечающих за разделы кода в исполняемом файле
-   Сведения о оптимизации указателя фрейма (FPO)
-   Сведения о имени и типе для локальных переменных и структур данных
-   Сведения об исходном файле и номере строки

Если вас интересуют сведения, использующие PDB-файл, чтобы помочь им реконструировать исполняемый файл, можно также создать файлы с удаленным PDB-файлами с помощью параметра компоновщика **/PDBSTRIPPED: filename** . Если у вас есть файлы PDB, из которых вы хотите удалить закрытую информацию из, можно использовать средство с именем pdbcopy, которое входит в состав средств отладки для Windows.

По умолчанию очищенные PDB-файлы содержат следующие сведения:

-   Открытые символы (обычно не статические функции и глобальные переменные)
-   Список объектных файлов, отвечающих за разделы кода в исполняемом файле
-   Сведения о оптимизации указателя фрейма (FPO)

Это минимальные сведения, необходимые для обеспечения надежной отладки. Минимальная информация также затрудняет получение дополнительных сведений о исходном коде. Так как создается и очищенный PDB-файл, и обычный PDB-файл, можно предоставить удаленную версию пользователям, которым могут потребоваться ограниченные возможности отладки, но оставить полные файлы PDB конфиденциальными. Обратите внимание, что **/PDBSTRIPPED** создает второй, меньший PDB-файл, поэтому при создании сборок для широкого распределения следует использовать правильный PDB-файл. Для типичного проекта обычная PDB-файл может быть размером в несколько мегабайт, но удаленная версия PDB может составлять всего несколько сотен килобайт.

## <a name="using-symbols-for-debugging"></a>Использование символов для отладки

При отладке приложения, в котором произошел сбой, отладчик пытается отобразить в стеке функции, которые привели к сбою. Без файла PDB отладчик не может разрешить имена функций, их параметры или любые локальные переменные, хранимые в стеке. При отладке 32-разрядных исполняемых файлов существуют ситуации, когда невозможно даже получить надежные трассировки стека без символов. Иногда можно просмотреть необработанные значения в стеке и определить, какие значения могут возвращать адреса, но они могут быть легко путают со ссылками на функции или данными.

Если функции в текущем стеке скомпилированы с использованием оптимизации указателей на фреймы (**/Oy**), и если символы отсутствуют, отладчик не может надежно определить, какая функция вызвала текущую функцию. Это связано с тем, что без сведений о оптимизации указателя кадров (FPO), содержащихся в PDB, отладчик не может полагаться на регистр указателя кадра (EBP), указывающий на сохраненный предыдущий указатель на кадр и на обратный адрес родительской функции. Вместо этого он догадаться. Иногда он получает право. Однако он часто получает неправильный, что может привести к неправильному получению. Если отображается предупреждение об отсутствующих символах или символы не загружены, как показано в следующем примере, не следует доверять стеку с этого момента.

``` syntax
SWPerfTest.exe!TextFunction(... ...)    Line 59    C++
d3dx9d.dll!008829b5()
[Frames below may be incorrect and/or missing, no symbols loaded for d3dx9d.dll]
SWPerfTest.exe!main(int argc=, const char * * argv=)  Line 328 + 0x12 bytes     C++
SWPerfTest.exe!__mainCRTStartup() Line 716 + 0x17 bytes    C
kernel32.dll!@BaseThreadInitThunk@12() + 0x12 bytes
ntdll.dll!__RtlUserThreadStart@8() + 0x27 bytes
```

Во многих случаях можно продолжить отладку без символов, так как проблема находится в расположении с точными символами, и вам не нужно просматривать функции в стеке вызовов. Даже если в библиотеке, находящихся в стеке вызовов, нет доступных PDB-файлов, при условии, что они были скомпилированы с помощью указателей на фреймы, отладчик должен иметь возможность правильно угадать в родительских функциях. начиная с версии Windows XP с пакетом обновления 2 (sp2) все Windows DLL и исполняемые файлы компилируются с отключением FPO, так как это делает отладку более точной. Отключение FPO также позволяет профилировщикам выборки проходить по стеку во время выполнения с минимальным влиянием на производительность. в версиях Windows до Windows XP с пакетом обновления 2 (SP2) для всех двоичных файлов операционной системы требуются соответствующие файлы символов, содержащие сведения о завершении, чтобы обеспечить точную отладку и профилирование.

При отладке 64-разрядных машинных исполняемых файлов не требуется использовать файлы символов для создания правильных трассировок стека, так как операционная система и компиляторы x64 не требуют их. Однако по-прежнему требуются файлы символов для получения имен функций, вызова параметров и локальных переменных.

Однако некоторые случаи особенно сложны для отладки без символов. Например, если выполняется отладка программы, для которой был создан PDB-файл, и при сбое обратного вызова из функции в библиотеке DLL, для которой отсутствуют символы, вы не сможете увидеть, какая функция вызывала обратный вызов, так как вы не сможете декодировать стек. Это часто происходит в библиотеках сторонних производителей, если PDB не предоставлены или в старых компонентах операционной системы, если PDB недоступны. Обратные вызовы часто происходят во время передачи сообщения, перечисления, выделения памяти или обработки исключений. Отладка этих функций без точного стека может оказаться неприятной.

Чтобы надежно выполнять отладку мини-дампов, созданных на другом компьютере или вызвавших сбой в коде, важно иметь возможность доступа ко всем символам и двоичным файлам для исполняемых файлов, на которые имеются ссылки в мини-дампе. Если символы и двоичные файлы доступны на сервере символов, они автоматически получаются отладчиком. Дополнительные сведения о мини-дампах см. в техническом документе [анализ аварийного дампа](/windows/desktop/DxTechArts/crash-dump-analysis) .

## <a name="getting-the-symbols-you-need"></a>Получение необходимых символов

Visual Studio и другие отладчики майкрософт, такие как WinDbg, обычно настроены на работу только при создании приложения и его отладке на своем компьютере. если вам нужно передать исполняемый файл другому пользователю, при наличии на компьютере нескольких версий библиотеки DLL или файла .exe или при необходимости точной отладки приложения, использующего Windows или другие библиотеки, такие как DirectX, необходимо понимать, как отладчики могут находить и загружать символы. отладчик использует либо путь поиска символов, указанный пользователем, либо, который находится в параметрах \\ отладки \\ символов в Visual Studio — или \_ \_ \_ переменная среды path символов NT. Как правило, отладчик выполняет поиск соответствующих PDB в следующих расположениях:

-   Расположение, указанное в библиотеке DLL или в исполняемом файле.

    Если на компьютере была создана библиотека DLL или исполняемый файл, по умолчанию компоновщик поместит полный путь и имя файла соответствующего PDB-файла в библиотеку DLL или исполняемый файл. При отладке отладчик сначала проверяет, существует ли файл символов в расположении, указанном в библиотеке DLL или в исполняемом файле. Это полезно, так как у вас всегда есть символы, доступные для кода, скомпилированного на компьютере.

-   PDB, которые могут присутствовать в одной папке с библиотекой DLL или исполняемым файлом.
-   Все папки локального кэша символов.
-   Любые серверы символов локальной сетевой папки.
-   Любые серверы символов Интернета, например Microsoft Symbol Server.

Чтобы убедиться в наличии всех PDB, необходимых для точной отладки, установите средства отладки для Windows. Битовые версии 32 и 64 можно найти в [средствах отладки для Windows](/windows-hardware/drivers/debugger/).

Полезным средством, устанавливаемым с этим пакетом, является symchk.exe. Он может помочь определить отсутствующие или неверные символы. Это средство имеет большое количество возможных параметров командной строки. Ниже приведены две из наиболее полезных и часто используемых.

### <a name="check-if-a-given-dll-or-exe-file-and-pdb-in-the-same-folder-match"></a>Проверьте, совпадает ли заданная библиотека DLL или файл .exe и PDB в одной папке

``` syntax
"c:\Program Files\Debugging Tools for Windows\symchk" testing.dll /s .

SYMCHK: FAILED files = 0
SYMCHK: PASSED + IGNORED files = 1
```

Параметр **/s.** параметр указывает **симчк** искать символы только в текущей папке, а не на серверах символов.

### <a name="check-if-all-the-dlls-and-executable-files-in-a-set-of-folders-have-matching-pdbs"></a>Убедитесь, что все библиотеки DLL и исполняемые файлы в наборе папок соответствуют PDB

``` syntax
"c:\Program Files\Debugging Tools for Windows\symchk" *.* /r
```

Параметр **/r** задает **симчк** для рекурсивного прохода по папкам, чтобы убедиться, что все исполняемые файлы имеют совпадающие PDB. Без параметра **/s** **симчк** использует текущий \_ \_ путь к символам NT \_ для поиска символов на любом частном или локальном сервере или на серверах символов Майкрософт. Средство **симчк** выполняет поиск только символов для исполняемых файлов (.exe, .dll и т. д.). Подстановочные знаки нельзя использовать для поиска символов в неисполняемых файлах.

### <a name="how-symchk-works"></a>Как работает симчк

Когда компоновщик создает .dll, исполняемые и PDB-файлы, в каждом файле хранятся идентичные идентификаторы GUID. Идентификатор GUID используется средствами для определения того, соответствует ли указанный PDB-файл библиотеке DLL или исполняемому файлу. Если вы изменяете библиотеку DLL или исполняемый файл с помощью редактора ресурсов или шифрования для защиты от копирования или изменяете сведения о версии, идентификатор GUID обновляется, и отладчик не может загрузить PDB-файл. По этой причине очень важно избегать управления библиотекой DLL или исполняемым файлом после его создания компоновщиком.

Вы также можете использовать служебную программу DUMPBIN, поставляемую вместе с VS.NET, чтобы показать пути к символам, в которых выполняется поиск, и определить, найдены ли файлы символов, соответствующие заданной библиотеке DLL или исполняемому файлу. Например:

``` syntax
DUMPBIN /PDBPATH:VERBOSE filename.exe
```

## <a name="symbol-servers"></a>Серверы символов

Сервер символов — это репозиторий для нескольких версий исполняемого файла и файлов символов. Он содержит либо сами файлы символов, либо ссылки на соответствующие файлы символов. Отладчики понимают, как использовать серверы символов и могут использовать их для поиска отсутствующих или неизвестных символов.

DLL и исполняемые файлы также доступны на сервере символов Майкрософт. Это позволяет отлаживать сбои и проверять код для файлов операционной системы, которые могут отсутствовать на компьютере. Если отладчик обнаруживает исполняемый файл или библиотеку DLL, которая не существует в системе, используемой для отладки, она автоматически запрашивает как символы, так и копию двоичного файла на серверах символов Майкрософт. Это полезно при отладке компонента, имеющего много версий, например msvcrt.dll, и необходимо изучить код для версии, которая не существует на компьютере. Это также помогает отлаживать Мини-дампы, созданные в операционной системе, отличной от системы, используемой для отладки.

Корпорация Майкрософт публикует все PDB-файлы для всех операционных систем и других перераспределенных компонентов, таких как пакет SDK DirectX, на внешнем доступном сервере символов. Это упрощает отладку приложения, использующего эти библиотеки DLL или исполняемые файлы. Сервер символов Майкрософт можно использовать для разрешения символов вместе с любыми локальными символами для компонентов, созданных на компьютере.

Можно настроить компьютер для использования сервера символов Майкрософт, который предоставляет доступ ко всем файлам символов Майкрософт. Можно также настроить частный сервер символов для вашей компании, группы или сети, который можно использовать для хранения нескольких более ранних версий проекта, над которым вы работаете, или для предоставления локального кэша для символов, используемых на сервере символов Майкрософт.

Чтобы использовать сервер символов, укажите путь поиска в переменной среды, которая называется « \_ \_ путь к символам NT» \_ . отладчики и современные средства, такие как WinDbg, NTSD или Visual Studio, автоматически используют этот путь для поиска символов.

Когда отладчик выполняет поиск символов, он сначала выполняет поиск в локальной среде. Затем он выполняет поиск на серверах символов. При обнаружении совпадающего символа он передает файл символов в локальный кэш. Символы для типовой библиотеки DLL или исполняемого файла, размер которых составляет от 1 до 100 МБ. Поэтому при отладке процесса, включающего множество библиотек DLL, может потребоваться некоторое время для разрешения всех символов и их перемещения в локальный кэш.

## <a name="using-the-microsoft-symbol-server"></a>Использование сервера символов Майкрософт

Сервер символов Майкрософт позволяет получить все последние символы, включая символы для исправленных или обновленных файлов. Сервер символов Майкрософт доступен по адресу <https://msdl.microsoft.com/download/symbols> .

Доступ к серверу символов можно получить одним из следующих способов.

-   Введите адрес сервера напрямую. в Visual Studio в меню **сервис** выберите пункт **параметры**, затем пункт **отладка**, а затем выберите пункт **символы**.
-   Используйте переменную среды \_ \_ путь к символам NT \_ . Рекомендуется использовать этот метод.

    Это используется всеми средствами отладки. он также используется Visual Studio и считывается и декодирован при открытии Visual Studio. Поэтому при его изменении необходимо перезапустить Visual Studio.

    Эта переменная среды позволяет указать несколько серверов символов, например внутренний частный сервер символов. Он также позволяет указать каталог локального кэша для хранения PDB-файлов для всех символов, которые вы ищете на серверах символов — как внутри, так и через Интернет.

Для \_ \_ переменной пути к символам NT используется следующий синтаксис \_ :

``` syntax
srv*[local cache]*[private symbol server]*https://msdl.microsoft.com/download/symbols
```

Замените \[ локальный кэш \] именем каталога на компьютере, где будет храниться кэш любых используемых символов, например% systemroot% \\ SYMBOLS или c: \\ SYMBOLS.

\[Частный сервер символов \] является необязательным. Он может указывать на сервер символов, расположенный в сети, или на сервер символов, который совместно используется вашей командой, группой продуктов или компанией.

Чтобы использовать только сервер символов Майкрософт вместе с локальным кэшем символов, чтобы ускорить доступ через Интернет, используйте следующий параметр для \_ \_ пути к символам NT \_ :

``` syntax
srv*c:\symbols*https://msdl.microsoft.com/download/symbols
```

другие параметры для \_ \_ пути к символам NT можно найти \_ в файле справки, который устанавливается вместе с пакетом средств отладки Microsoft для Windows.

Исполняемые файлы без символов могут увеличить время, затрачиваемое на запуск отладчика, если используется сервер символов. Это происходит потому, что отладчик запрашивает сервер символов каждый раз при попытке загрузить исполняемый файл. По этой причине лучше всегда запрашивать символы для всех компонентов.

Может оказаться невозможным запрашивать символы для каждого компонента — например, видеодрайверы могут иметь библиотеки DLL в пространстве процесса, а необходимые PDB-файлы доступны на сервере символов Майкрософт. В этом случае при запуске сеанса отладки возникает небольшая задержка.

Чтобы избежать такой небольшой задержки, можно запустить отладчик один раз, чтобы кэшировать все символы локально с сервера символов Майкрософт. Затем измените путь к \_ \_ символам NT, \_ чтобы удалить сервер символов Майкрософт. Если исполняемые файлы не изменяются, для проверки исполняемых файлов, не имеющих символов, запрос через Интернет не потребуется, так как у вас есть локальные кэшированные копии всех символов, необходимых на сервере символов Майкрософт.

## <a name="getting-symbols-manually"></a>Получение символов вручную

Если отладчик настроен правильно, он автоматически загружает все необходимые символы из локального кэша или с сервера символов. Если вы хотите получить символы только для одного исполняемого файла или для папки исполняемых файлов, можно использовать **симчк**. например, если вы хотите скачать символы для \_ файла d3dx930.dll в системной папке Windows в текущем каталоге, можно использовать следующую команду:

``` syntax
"c:\Program Files\Debugging Tools for Windows\symchk" c:\Windows\System32\d3dx9_30.dll /oc \.
```

Средство **симчк** имеет много других целей. дополнительные сведения см. в разделе **симчк/?** или в документации по средствам отладки Microsoft для Windows.

## <a name="setting-up-a-symbol-server"></a>Настройка сервера символов

Настройка сервера символов очень проста. Это полезно по следующим причинам.

-   Для экономии пропускной способности или ускорения разрешения символов для вашей компании, группы или продукта. Внутренний сервер символов на локальном файловом ресурсе в сети кэширует все ссылки на внешние серверы символов, такие как Microsoft Symbol Server. Доступ к локальному или внутреннему серверу символов можно быстро получить одновременно несколькими людьми. Поэтому он экономит пропускную способность и задержку, с которой могут создаваться дублирующие запросы символов.
-   Для хранения символов для старых сборок, версий или внешних выпусков приложения. Хранение символов для этих сборок на сервере символов, к которому можно легко получить доступ, позволяет отлаживать сбои и проблемы в этих сборках на любом компьютере с отладчиком и подключением к локальному серверу символов. Это особенно полезно при отладке мини-дампов, созданных исполняемыми файлами, которые не были построены самостоятельно, то есть сборками, созданными другим программистом или компьютером сборки. Если символы для этих сборок хранятся на сервере символов, вы получите надежную и точную отладку.
-   Для обновления символов в актуальном состоянии. при обновлении компонентов, таких как компоненты ос, измененные Центр обновления Windows или пакетом SDK DirectX, можно по-прежнему выполнять отладку с использованием всех последних символов.

Настройка сервера символов в собственной локальной сети — это просто создание общей папки на сервере и предоставление пользователям полных разрешений на доступ к общей папке для создания файлов и папок. эта общая папка должна быть создана в серверной операционной системе, например Windows server 2003, чтобы количество пользователей, которые могут одновременно получить доступ к ней, не ограничено.

Например, если вы настроили общую папку на \\ \\ mainserver- \\ символах, члены вашей команды настроили \_ \_ путь к символам NT \_ следующим образом:

``` syntax
Srv*c:\symbols*\\mainserver\symbols*https://msdl.microsoft.com/download/symbols
```

По мере извлечения символов файлы и папки отображаются в \\ \\ \\ общем каталоге mainserver Symbols, а также в отдельных кэшах в каталоге c: \\ SYMBOLS.

Обычно это все, что необходимо для настройки и использования собственного сервера символов или сервера символов Майкрософт.

## <a name="adding-symbols-to-a-symbol-server"></a>Добавление символов на сервер символов

Чтобы добавить, удалить или изменить файлы в общей папке сервера символов, используйте средство symstore.exe. это средство является частью пакета средств отладки Microsoft для Windows. полная документация по серверам символов, средству symstore и индексированию символов включена в пакет средств отладки для Windows пакета.

Вам может потребоваться добавить символы непосредственно на собственный сервер символов в рамках процесса сборки или сделать символы доступными для всей команды для библиотек или средств сторонних разработчиков. Процесс добавления символа в файловый ресурс сервера символов называется индексированием символов. Существует два распространенных способа индексирования символов. Файл символов можно скопировать на сервер символов. Или указатель на расположение символа можно скопировать на сервер символов. Если у вас есть архивная папка, содержащая старые сборки, может потребоваться индексировать указатели на PDB-файлы, которые уже находятся в общей папке, вместо дублирования символов. Так как символы иногда могут быть десятками мегабайт, рекомендуется заранее спланировать объем пространства, которое может потребоваться для архивации всех сборок проекта в ходе разработки. При индексировании только указателей на символы могут возникнуть проблемы при удалении старых сборок или изменении имени общей папки.

Например, для рекурсивного индексирования всех символов в c: \\ дкссим \\ Дополнительные \\ символы, полученные из пакета SDK DirectX за Октябрь 2006, на файловый ресурс сервера символов, именуемый \\ \\ \\ символами mainserver, можно использовать следующую команду:

``` syntax
"c:\Program Files\Debugging Tools for Windows\symstore" add /f "C:\dxsym\Extras\Symbols\*.pdb"
/s \\mainserver\symbols /t "October 2006 DirectX SDK " /r
```

Параметр **/t "Comment"** используется для добавления описания транзакции, которая добавила символы. Это может быть полезно при выполнении административных задач с символами.

## <a name="best-practices"></a>Советы и рекомендации

-   Настройте файловый ресурс сервера символов для своей команды, компании или продукта.
-   Настройте \_ путь к \_ символам NT, \_ чтобы указать локальный кэш, сервер закрытых символов и сервер символов Майкрософт.
-   Если отладчику не удается загрузить символы для отлаживаемого компонента, обратитесь к владельцу компонента, чтобы запросить символы — по крайней мере в виде очищенного PDB-файла.
-   Настройте автоматическую систему сборки для индексирования символов на закрытом сервере символов для каждой создаваемой сборки. Убедитесь, что распространяемые сборки являются сборками, создаваемыми этим процессом. Это гарантирует, что символы всегда будут доступны для проблем отладки.
-   настройте сервер символов, чтобы разрешить отладчикам доступ к исходному коду для определенного модуля непосредственно из Visual source Сейф или системы управления версиями на основе перфорце. Если сведения о исходном файле и символы для выпущенной версии игры индексируются, разработчики, у которых есть доступ к серверу символов, могут иметь полный исходный уровень отладки сообщаемых проблем без сохранения сред сборки или старых версий исходных файлов на компьютерах разработки. Сведения о настройке сервера символов для разрешения индексации данных исходного файла см. в документации по исходному серверу.

 

 
