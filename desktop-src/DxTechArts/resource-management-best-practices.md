---
title: Рекомендации по управлению ресурсами
description: В этой статье рассматриваются рекомендации по работе с ресурсами, как правило, поведение управляемых и неуправляемых ресурсов, а также подробное описание того, как ресурсы обычно обрабатываются средой выполнения и драйверами.
ms.assetid: 265ae0b2-f268-a4a4-551e-9d3dae886517
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 27cdadb8cee3cb57f4208657054784937ecd1ea2
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "104338436"
---
# <a name="resource-management-best-practices"></a>Рекомендации по управлению ресурсами

Управляемые текстуры, также известные как автоматическое управление текстурами, были доступны в DirectX с версии 6 с несколькими редакциями и улучшениями, внесенными в последующих выпусках. Начиная с версии API Direct3D 9, автоматическое управление ресурсами включает поддержку текстур, буферов вершин и буферов индексов с единообразным общим интерфейсом. С помощью диспетчера ресурсов Direct3D приложения могут значительно упростить обработку ситуаций, связанных с потерями устройств, и могут полагаться на систему для обработки разумного объема избыточных ресурсов памяти видео.

Разработчики иногда могут столкнуться с проблемами, используя управляемые ресурсы, частично из-за абстрактной природы системы. Хотя многие распространенные сценарии для ресурсов хорошо подходят для управляемых ресурсов, некоторые из них лучше использовать при использовании неуправляемых ресурсов. В этой статье рассматриваются рекомендации по работе с ресурсами, как правило, поведение управляемых и неуправляемых ресурсов, а также подробное описание того, как ресурсы обычно обрабатываются средой выполнения и драйверами.

В этой статье рассматриваются следующие понятия:

-   [Видеопамять](#video-memory)
-   [Управляемые ресурсы](#managed-resources)
-   [Ресурсы, управляемые драйвером](#driver-managed-resources)
-   [Ресурсы по умолчанию](#default-resources)
    -   [Использование управляемых и ресурсов по умолчанию](#using-both-managed-and-default-resources)
    -   [Динамические ресурсы по умолчанию](#dynamic-default-resources)
-   [Ресурсы системной памяти](#system-memory-resources)
-   [Общие рекомендации](#general-recommendations)
-   [См. также](#related-topics)

## <a name="video-memory"></a>Видеопамять

Чтобы система видео использовала ресурс, она должна находиться в памяти, доступной для GPU. Локальная видеопамять обеспечивает наилучшую производительность GPU, а определенные ресурсы (например, целевые объекты отрисовки и буферы глубины и трафаретов) должны находиться в локальной видеопамяти. С появлением AGP графический процессор также может получить доступ к части системной памяти напрямую. Эта область памяти, известная как Апертура AGP, называется нелокальной видеопамятью и недоступна для других целей. Нелокальная видеопамять может считываться и записываться ЦП, что обычно не имеет высокопроизводительного доступа к локальной видеопамяти, и поэтому идеально подходит для использования в качестве ресурса общей памяти. Важно помнить о том, что память AGP, как и локальная видеопамять, становится недействительной в ситуациях потерянных устройств, а постоянные ресурсы, расположенные там, должны быть восстановлены.

**Рис. 1. Отношение GPU, ЦП, видеопамяти и ОЗУ системы**

![отношение GPU, ЦП, видеопамяти и ОЗУ системы](images/managingresources1.gif)

В некоторых интегрированных видеороликах используется унифицированная архитектура памяти, где основная память может быть адресациа всеми компонентами систем. Direct3D поддерживает установку без внесения каких либо изменений в приложение, используя те же советы, что и для конфигураций локальной видеопамяти. В таких системах ресурсы всегда находятся в системной памяти, и драйвер отвечает за то, чтобы ресурсы работали примерно так же, как в более традиционной архитектуре, в то же время используя свойства самой части и любое конкретное поведение аппаратной реализации.

**Рис. 2. GPU и ЦП имеют равный доступ к системной памяти в архитектуре единой памяти**

![GPU и ЦП имеют равный доступ к системной памяти в архитектуре единой памяти](images/managingresources2.gif)

## <a name="managed-resources"></a>Управляемые ресурсы

Большая часть ресурсов должна быть создана как управляемые ресурсы в \_ управляемом пуле. Все ресурсы будут созданы в системной памяти и скопированы в видеопамяти по мере необходимости. Потерянные устройства будут автоматически обрабатываться из копии системной памяти. Так как не все управляемые ресурсы должны помещаться в видеопамять, можно чрезмерно зафиксировать память, в которой для отображения в любом кадре достаточно меньше рабочего набора ресурсов видеопамяти. Обратите внимание, что большая часть этого резервного копирования системной памяти будет выдаваться на диск с течением времени, поэтому выполнение операции сброса может оказаться слишком длительным из-за необходимости вернуть эти данные для восстановления потерянной видеопамяти.

Среда выполнения сохраняет метку времени для последнего использования ресурса, и при сбое выделения видеопамяти для загрузки необходимого управляемого ресурса он будет освобождать ресурсы на основе этой метки времени LRU. Использование [**SetPriority**](/windows/desktop/api/d3d9helper/nf-d3d9helper-idirect3dresource9-setpriority) имеет приоритет над отметкой времени, поэтому для более часто используемых ресурсов должно быть задано более высокое значение приоритета. Direct3D 9,0 имеет ограниченную информацию о видеопамяти, управляемой драйвером, поэтому среде выполнения может потребоваться исключить несколько ресурсов, чтобы создать достаточно большой регион для выполнения выделения. Правильные приоритеты могут помочь в устранении ситуаций, когда что-то будет вытеснено, а затем снова потребуется в ближайшее время. Приложение также может вызвать [**евиктманажедресаурцес**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-evictmanagedresources) , чтобы принудительно удалить все управляемые ресурсы. Опять же, это может быть трудоемкой операцией для повторной загрузки всех ресурсов, необходимых для следующего кадра, но она очень полезна для переходов на уровне, где рабочий набор значительно меняется, а также для удаления фрагментации видеопамяти.

Число кадров также сохраняется, чтобы среда выполнения определяла, использовался ли ресурс, который был выбран для исключения, в начале текущего кадра, что подразумевает пробуксовка ситуацию, когда больше ресурсов используется в одном кадре, чем помещается в видеопамять. Это активирует политику замены, чтобы переключиться на MRU, а не LRU для оставшейся части кадра, так как это, как правило, выполняется немного лучше при таких условиях. Такое поведение пробуксовка существенно влияет на производительность отрисовки. Обратите внимание, что понятие текущего кадра привязано к [**ендсцене**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-endscene), поэтому любое приложение, использующее управляемые ресурсы, должно выполнять регулярные вызовы этого метода.

Разработчики, стремящиеся найти дополнительные сведения о том, как управляемые ресурсы работают в своем приложении, могут использовать запрос события RESOURCEMANAGER через интерфейс [**IDirect3DQuery9**](/windows/desktop/api/d3d9helper/nn-d3d9helper-idirect3dquery9) . Это работает только при использовании сред выполнения отладки, поэтому эти сведения не могут зависеть от приложения, но предоставляют подробную информацию о ресурсах, управляемых средой выполнения.

Понимание того, как работает диспетчер ресурсов, может помочь при настройке и отладке приложений, важно не привязывать приложение слишком тесно к деталям реализации текущей среды выполнения или драйверов. Редакции драйвера или изменения оборудования могут значительно изменить поведение, а будущие версии Direct3D будут значительно улучшены и сложнее управлять ресурсами.

## <a name="driver-managed-resources"></a>Ресурсы Driver-Managed

Драйверы Direct3D можно использовать для реализации функции управления текстурами, управляемой драйвером, которая определяется D3DCAPS2 \_ канманажересаурце, что позволяет драйверу управлять ресурсами вместо среды выполнения. Для драйвера (редких), который реализует эту функцию, точное поведение диспетчера ресурсов драйвера может сильно различаться, и вы должны обратиться к поставщику драйвера за сведениями о том, как это работает для своей реализации. Кроме того, можно гарантировать, что диспетчер среды выполнения всегда используется, указав D3DCREATE \_ Отключить \_ Управление драйверами \_ при создании устройства.

## <a name="default-resources"></a>Ресурсы по умолчанию

Хотя управляемые ресурсы просты, эффективны и просты в использовании, бывают случаи, когда использование видеопамяти является предпочтительным или даже обязательным. Такие ресурсы создаются в \_ категории пула по умолчанию. Использование таких ресурсов приводит к дополнительным осложнениям приложения. Код необходим для работы с ситуацией потерянных устройств для всех \_ ресурсов пула по умолчанию, и при копировании в них данных необходимо учитывать вопросы производительности. Невозможность указания использования \_ WRITEONLY или назначение блокируемого целевого объекта прорисовки также может накладывать серьезные штрафы в производительности.

Вызов **блокировки** по \_ умолчанию для ресурса пула, скорее всего, приведет к остановке GPU, чем при работе с \_ ресурсом, управляемым пулом, если не использовать определенные флаги подсказок. В зависимости от расположения ресурса возвращаемый указатель может быть временным буфером системной памяти или указателем непосредственно в память AGP. Если это временный буфер системной памяти, данные потребуется передать в видеопамять после вызова **Unlock** . Если видеоресурс не предназначен только для записи, данные необходимо передать во временный буфер во время **блокировки**. Если это область памяти AGP, временные копии исключаются, но требуемое поведение кэша может привести к снижению производительности.

Следует уделить внимание написанию полной строки кэша данных в любом указателе на память апертуры AGP, чтобы избежать снижения числа операций, приводящих к объединению с возможностью чтения и записи, а также последовательного доступа к области памяти. Если приложению необходимо сделать произвольный доступ к данным во время создания и вы не хотите использовать управляемый ресурс для буфера, следует работать с копией системной памяти. После создания данных можно выполнить потоковую передачу результата в память заблокированных ресурсов, чтобы не платить большую штраф за операцию объединения в кэш.

Флаг LOCK \_ нуверврите можно использовать для эффективного добавления данных для некоторых ресурсов, но в идеале можно избежать нескольких вызовов **блокировки** и **разблокировки** одного и того же ресурса. Правильная работа различных флагов блокировки важна для оптимальной производительности, как при использовании шаблона доступа к данным с поддержкой кэша при переполнении памяти.

### <a name="using-both-managed-and-default-resources"></a>Использование управляемых и ресурсов по умолчанию

Смешивание распределения \_ ресурсов по умолчанию управляемых и пулов может привести к фрагментации видеопамяти и путать представление видеопамяти, доступной для управляемых ресурсов, в среде выполнения. В идеале следует создать все \_ ресурсы пула по умолчанию, прежде чем использовать \_ управляемые ресурсы пула или использовать вызов [**евиктманажедресаурцес**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-evictmanagedresources) перед выделением неуправляемых ресурсов. Помните, что все выделения, сделанные из пула \_ по умолчанию, которые находятся в видеопамяти, занимают память в течение жизненного цикла ресурса, недоступного для использования диспетчером ресурсов или в других целях.

Обратите внимание, что, в отличие от предыдущих версий Direct3D, среда выполнения версии 9 автоматически удаляет некоторые управляемые ресурсы, прежде чем выдавать неудачное выделение неуправляемого ресурса для нехватки видеопамяти, но это может привести к созданию дополнительной фрагментации и даже принудительной перезаписи ресурса в неоптимальное расположение (например, наличие статической текстуры в нелокальной видеопамяти). Опять же, лучше всего выделить все необходимые неуправляемые ресурсы перед использованием любых управляемых ресурсов.

### <a name="dynamic-default-resources"></a>Динамические ресурсы по умолчанию

Данные, формируемые и обновленные с высокой частотой, не нуждаются в резервном хранилище, так как при восстановлении устройства все данные будут созданы повторно. Такие данные, как правило, лучше всего создавать в пуле \_ по умолчанию, указывая \_ динамическое указание Usage, чтобы драйвер мог принимать решения по оптимизации при помещении ресурса, зная, что он будет обновляться часто. Как правило, это означает помещение ресурса в нелокальную видеопамять и, следовательно, очень медленный доступ к GPU, чем к локальной видеопамяти. Для архитектуры с областью размещения драйвер может выбрать конкретное размещение динамических ресурсов для оптимизации доступа на запись ЦП.

Такое использование является типичным для решений с обложками программного обеспечения и примитивов на основе ЦП, заполняющих буферы вершин и индексов, и флаг блокировки снимается \_ , чтобы остановки не создавались в случаях, когда ресурс по-прежнему используется из предыдущего кадра. При использовании управляемого ресурса в этом случае будет обновлен буфер системной памяти, который затем будет скопирован в видеопамять, а затем использован только для кадра или двух символов перед заменой. Для систем с нелокальной видеопамятью лишние копии устраняются при правильном использовании этого динамического шаблона.

Стандартные текстуры не могут быть заблокированы и могут быть обновлены только через [**упдатесурфаце**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatesurface) или [**упдатетекстуре**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatetexture). Некоторые системы поддерживают динамические текстуры, которые могут быть заблокированы, и используют шаблон запрета блокировки \_ , но \_ перед использованием таких ресурсов необходимо проверить бит (D3DCAPS2 динамиктекстурес). Для высокодинамических текстур (видео или процедур) приложение может создать соответствующие ресурсы пула \_ по умолчанию и \_ системмем пула и управлять обновлениями видео-памяти с помощью **упдатетекстуре**. Для наиболее частых и частичных обновлений **упдатетекстуре** парадигма, скорее всего, является лучшим выбором.

При проектировании систем, которые сильно полагаются на динамическую отправку, удобно использовать динамические ресурсы. Статические ресурсы должны быть помещены в пул \_ под управлением, чтобы обеспечить оптимальное использование локальной видеопамяти и более эффективно использовать ограниченную шину и основную пропускную способность памяти. Для ресурсов, которые являются частично статическими, может оказаться, что затраты на отправку в локальную видеопамять гораздо меньше, чем порожденный трафик постоянной шины, что делает их динамическими.

## <a name="system-memory-resources"></a>Ресурсы системной памяти

Ресурсы также можно создать в пуле \_ системмем. Хотя графический конвейер не может использовать их, их можно использовать в качестве источников для обновления \_ ресурсов пула по умолчанию с помощью [**Упдатесурфаце**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatesurface) или [**упдатетекстуре**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatetexture). Их режим блокировки прост, хотя ожидание может произойти, если они используются одним из упомянутых выше методов.

Несмотря на то что они находятся в системной памяти, \_ ресурсы пула системмем ограничены теми же форматами и возможностями (например, максимальный размер), которые поддерживаются драйвером устройства. \_Тип временных ресурсов пула — это другая форма ресурса системной памяти, которая может использовать все форматы и возможности, поддерживаемые средой выполнения, но не доступ к ним. Ресурсы временных ресурсов предназначены главным образом для использования средствами содержимого.

**Рис. 3. Ресурсы памяти в видеопамяти, апертуре AGP и ОЗУ системы**

![ресурсы памяти в видеопамяти, апертуре AGP и ОЗУ системы](images/managingresources3.gif)

## <a name="general-recommendations"></a>Основные рекомендации

Получение сведений о технических реализациях для управления ресурсами будет длительным способом достижения целей производительности для вашего приложения. Планирование того, как ресурсы представлены для Direct3D, а архитектурный проект, позволяющий своевременно загружать данные, является более сложной задачей. Мы рекомендуем использовать ряд рекомендаций при принятии решений для вашего приложения:

-   Предварительно обработайте все ресурсы. В процессе разработки удобнее выполнять преобразование и оптимизацию ресурсов во время загрузки, но это обеспечивает высокую производительность на компьютерах пользователей. Предварительно обработанные ресурсы быстрее загружаются, быстрее используются и предоставляют возможность выполнять сложные автономные работы.
-   Избегайте создания большого количества ресурсов на кадр. Взаимодействие с драйверами позволяет сериализовать ЦП и GPU, а задействованные операции имеют высокую плотность, так как они часто требуют перехода ядра. Разраспределите создание по нескольким кадрам или повторно используйте ресурсы без их создания или освобождения. В идеале следует ожидать несколько кадров перед блокировкой или освобождением ресурсов, которые были недавно использованы для подготовки к просмотру.
-   В конце кадра не забудьте отменить привязку всех каналов ресурсов (то есть источников потоков, стадий текстуры и текущих индексов). Это гарантирует, что висячие ссылки на ресурсы будут удалены, прежде чем они приведут к тому, что диспетчер ресурсов будет поддерживать резидентные ресурсы, которые больше не используются.
-   Для текстур используйте сжатые форматы (например, Дкстн) с MIP-Maps и рассмотрите возможность использования текстуры Atlas. Это значительно сокращает требования к пропускной способности и позволяет уменьшить общий размер ресурсов, что делает их более эффективными.
-   Для геометрии используйте индексированную геометрию, так как это помогает сжимать ресурсы буфера вершин, а современное видеооборудование сильно оптимизируется при повторном использовании вершин. Используя программируемые шейдеры вершин, можно сжимать сведения о вершинах и расширять их во время обработки вершин. Опять же, это позволяет сократить требования к пропускной способности и сделать ресурсы буфера вершин более эффективными.
-   Избегайте чрезмерного оптимизации управления ресурсами. Будущие редакции драйверов, оборудования и операционной системы могут вызвать проблемы совместимости, если приложение слишком сильно настраивается для определенного сочетания. Так как большинство приложений привязаны к ЦП, дорогостоящее управление на основе ЦП обычно вызывает больше проблем с производительностью, чем устраняется.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Управление ресурсами](/windows/desktop/direct3d9/managing-resources)
</dt> <dt>

[Потерянные устройства](/windows/desktop/direct3d9/lost-devices)
</dt> <dt>

[Оптимизация производительности](/windows/desktop/direct3d9/performance-optimizations)
</dt> <dt>

[Сжатые ресурсы текстуры](/windows/desktop/direct3d9/compressed-texture-resources)
</dt> <dt>

[Запросы](/windows/desktop/direct3d9/queries)
</dt> <dt>

[**D3DUSAGE**](/windows/desktop/direct3d9/d3dusage)
</dt> <dt>

[**D3DPOOL**](/windows/desktop/direct3d9/d3dpool)
</dt> <dt>

[D3DCREATE](/windows/desktop/direct3d9/d3dcreate)
</dt> </dl>

 

 