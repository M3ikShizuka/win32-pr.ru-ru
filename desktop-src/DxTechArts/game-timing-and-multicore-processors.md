---
title: Расписание игры и многоядерный процессор
description: в этой статье предлагается более точное и надежное решение для получения времени цп с высоким разрешением с помощью Windows api-интерфейсов QueryPerformanceCounter и куериперформанцефрекуенци.
ms.assetid: 1512324d-dffa-3681-be3f-f63a3b8f11db
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ed5e668e87a2645859838b1fdf9cfb35263381e9ce9c73fbe72232ad3d3a46cd
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118649352"
---
# <a name="game-timing-and-multicore-processors"></a>Расписание игры и многоядерный процессор

Благодаря тому, что технологии управления питанием становятся более распространенными на современных компьютерах, часто используемый метод для получения времени ЦП с высоким разрешением, инструкция RDTSC может перестать работать должным образом. в этой статье предлагается более точное и надежное решение для получения времени цп с высоким разрешением с помощью Windows api-интерфейсов [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) и [**куериперформанцефрекуенци**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).

-   [Фон](#background)
-   [Рекомендации](#recommendations)
-   [Совместимость приложений](#application-compatibility)

## <a name="background"></a>Историческая справка

С момента появления набора инструкций x86 P5 многие разработчики игр использовали счетчик меток времени чтения, инструкцию RDTSC для выполнения высокого разрешения времени. Windowsные таймеры мультимедийных данных достаточно точны для обработки звука и видео, но с интервалом в десятых миллисекундах или меньше, они не имеют достаточного разрешения для предоставления сведений о дельта-времени. Многие игры по-прежнему используют таймер мультимедиа при запуске, чтобы установить частоту ЦП, и используют это значение частоты для масштабирования результатов из RDTSC, чтобы получить точное время. из-за ограничений RDTSC API Windows предоставляет более правильный способ доступа к этим функциям с помощью подпрограмм [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) и [**куериперформанцефрекуенци**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).

Такое использование RDTSC в отношении времени снижается из следующих фундаментальных проблем:

-   Ненепрерывные значения. Использование RDTSC напрямую предполагает, что поток всегда работает на том же процессоре. Многопроцессорные и двухъядерные системы не гарантируют синхронизацию их счетчиков циклов между ядрами. Это усугубятся в сочетании с современными технологиями управления питанием, которые бездействуют и восстанавливают различные ядра в разное время, что приводит к несинхронизированности ядер. Для приложения это, как правило, приводит к возникновению сбоев или к сбоям при переходе потока между процессорами и получением значений времени, которые приводят к большим различиям, отрицательным разности или времени остановки.
-   Доступность выделенного оборудования. RDTSC блокирует сведения о времени, которые приложение запрашивает в счетчике цикла процессора. В течение многих лет это был лучший способ получения сведений о времени высокой точности, но новые системные платы теперь включают выделенные временные устройства, которые предоставляют сведения о времени высокого разрешения без недостатков RDTSC.
-   Вариативность частоты ЦП. Предполагается, что частота ЦП фиксирована в течение жизненного цикла программы. Однако благодаря современным технологиям управления питанием это неверное предположение. В то время как изначально ограничены переносными компьютерами и другими мобильными устройствами, технология, которая изменяет частоту ЦП, используется во многих настольных ПК. Отключение своей функции для поддержания постоянной частоты обычно неприемлемо для пользователей.

## <a name="recommendations"></a>Рекомендации

Играм требуются точные сведения о времени, но также необходимо реализовать код времени, чтобы избежать проблем, связанных с использованием RDTSC. При реализации синхронизации с высоким разрешением выполните следующие действия.

1.  Используйте [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) и [**куериперформанцефрекуенци**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) вместо RDTSC. Эти API-интерфейсы могут использовать RDTSC, но вместо этого могут использовать устройства управления временем на материнской плате или другие системные службы, предоставляющие высококачественные сведения о времени высокого разрешения. Хотя RDTSC работает гораздо быстрее, чем **QueryPerformanceCounter**, поскольку последний является вызовом API, он представляет собой API, который может вызываться несколько сотен раз на кадр без заметного воздействия. (Тем не менее, разработчики должны попытаться вызвать **QueryPerformanceCounter** как можно меньше, чтобы избежать снижения производительности.)
2.  При вычислении разностей значения должны быть отрезкими, чтобы гарантировать, что ошибки в значениях времени не приводят к сбоям или нестабильным вычислениям, связанным со временем. Диапазон срезов должен быть от 0 (чтобы предотвратить отрицательные разностные значения) на какое-либо разумное значение в зависимости от наименьшей ожидаемой частоты кадров. Фиксация может оказаться полезной при отладке приложения, но следует помнить, что при анализе производительности или запуске игры в неоптимизированном режиме.
3.  Вычисление всего времени в одном потоке. Вычисление времени для нескольких потоков — например, при каждом потоке, связанном с конкретным процессором, значительно сокращает производительность многоядерных систем.
4.  укажите, что один поток должен оставаться на одном процессоре с помощью Windows API [**сетсреадаффинитимаск**](/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask). Как правило, это основной игровой поток. Хотя [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) и [**куериперформанцефрекуенци**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) обычно корректируются для нескольких процессоров, ошибки в BIOS или драйверах могут привести к тому, что эти подпрограммы возвращают различные значения, так как поток перемещается с одного процессора на другой. Поэтому лучше разместить поток на одном процессоре.

    Все остальные потоки должны действовать без сбора собственных данных таймера. Не рекомендуется использовать рабочий поток для расчета времени, так как это станет узким местом синхронизации. Вместо этого рабочие потоки должны считывать метки времени из основного потока, а поскольку рабочие потоки только считывают метки времени, нет необходимости использовать критические разделы.

5.  Вызовите [**куериперформанцефрекуенци**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) только один раз, так как частота не изменится во время работы системы.

## <a name="application-compatibility"></a>Совместимость приложений

Многие разработчики внесли предположения о поведении RDTSC в течение многих лет, поэтому вполне вероятно, что некоторые существующие приложения будут столкнуться с проблемами при запуске в системе с несколькими процессорами или ядрами из-за реализации времени. Как правило, эти проблемы могут быть переработаны как сбойные или медленное движение. Не существует простого решения для приложений, которые не знают об управлении питанием, однако существует существующая оболочка, позволяющая принудительно запускать приложение на одном процессоре в многопроцессорной системе.

чтобы создать эту оболочку совместимости, скачайте набор средств совместимость приложений майкрософт из [Windows совместимости приложений](/archive/blogs/yongrhee/download-application-compatibility-toolkit-act-for-windows-10).

Используя администратор совместимости, часть набора средств, создайте базу данных приложения и соответствующие исправления. Создайте новый режим совместимости для этой базы данных и выберите исправление совместимости **синглепрокаффинити** , чтобы принудительно запустить все потоки приложения на одном процессоре или в ядре. С помощью программы командной строки Fixpack.exe (также является частью набора средств) можно преобразовать эту базу данных в устанавливаемый пакет для установки, тестирования и распространения.

Инструкции по использованию администратора совместимости см. в документации по набору средств. Синтаксис и примеры использования Fixpack.exe см. в справке командной строки.

Сведения, ориентированные на клиентов, см. в следующих статьях базы знаний Майкрософт:

-   [программы, использующие функцию QueryPerformanceCounter, могут работать плохо в Windows Server 2003 и в Windows XP](https://support.microsoft.com/kb/895980) (статья 895980)
-   [на компьютере под управлением Windows XP, на котором используется двухъядерный процессор (статья 909944), может снизиться производительность игры](https://support.microsoft.com/kb/909944)

 

 
