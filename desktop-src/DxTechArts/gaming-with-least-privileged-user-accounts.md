---
title: Игры с Least-Privileged учетными записями пользователей
description: в этой статье описывается, как разработчики игр могут создавать игры Microsoft Windows, которые хорошо работают с учетными записями пользователей с минимальными правами доступа (также известными как учетные записи с ограниченным доступом пользователей).
ms.assetid: 1b7cc3c9-b180-14b1-53c8-57f9e545d009
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 939d22b1d8bf381e98c5b6a7222be29b565c3d9e1f0758788aff94b0915b1807
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119340744"
---
# <a name="gaming-with-least-privileged-user-accounts"></a>Игры с Least-Privileged учетными записями пользователей

в этой статье описывается, как разработчики игр могут создавать игры Microsoft Windows, которые хорошо работают с учетными записями пользователей с минимальными правами доступа (также известными как учетные записи с ограниченным доступом пользователей).

-   [Введение](#introduction)
-   [Доступ к файлам для учетных записей пользователей Least-Privileged](#file-access-for-least-privileged-user-accounts)
    -   [Сценарий 1. файлы, которые не нужно просматривать или изменять пользователями](#scenario-1-files-that-do-not-need-to-be-viewed-or-altered-by-users)
    -   [Сценарий 2. файлы, которые должны быть просмотрены или изменены пользователями](#scenario-2-files-that-need-to-be-viewed-or-altered-by-users)
-   [Доступ к реестру для учетных записей пользователей Least-Privileged](#registry-access-for-least-privileged-user-accounts)
-   [Установка исправлений с учетными записями пользователей Least-Privileged](#patching-with-least-privileged-user-accounts)

## <a name="introduction"></a>Введение

Windows управляет своими пользователями с учетными записями. Сегодня более 80% пользователей компьютеров дома используют свой компьютер совместно с другими членами семьи. если несколько пользователей совместно используют один компьютер Windows, создаются несколько учетных записей пользователей, и каждый пользователь входит в систему с помощью отдельной учетной записи для доступа к компьютеру. Благодаря повышению уровня осведомленности о безопасности, многие пользователи работают на компьютерах с учетными записями пользователей с минимальными правами, которые также называются учетными записями ограниченных пользователей, которые не имеют полного контроля над системой. Учетные записи администратора обычно имеют неограниченный доступ к каждой части компьютера. это может повлиять на работу игр на основе Windows.

Существуют дополнительные преимущества для разработчиков игр, которые пишут свои игры для работы с учетными записями пользователей с минимальными правами доступа. в Windows Vista и более поздних версий применяются учетные записи пользователей с минимальными привилегиями. это означает, что каждая учетная запись в системе, за исключением локального администратора, является учетной записью пользователя с минимальными правами доступа. это повлияет на то, как игры, которые не соответствуют рекомендациям (устаревшие приложения), выполняются в Windows Vista и более поздних версиях. Например, когда приложение пытается выполнить запись в папку или значение реестра, к которому у него отсутствует разрешение, запись файла перенаправляется в виртуальное хранилище файлов для пользователя. Это хранилище виртуальных файлов будет находиться в папке, к которой пользователь имеет доступ для записи. Такое поведение может показаться неразрушительным, так как при сбое попытки записи произойдет сбой. Однако приложения, создающие виртуализованные файлы, могут запутать пользователей, так как файлы не будут записываться в местоположение, которое пользователи хотят. Например, игры, записывающие файлы высокой оценки в ту же папку, что и исполняемая папка, будут записывать эти файлы в виртуализированную папку. Следовательно, один пользователь не может видеть высокую оценку, полученную другим пользователем, так как каждый пользователь имеет отдельное виртуальное хранилище файлов.

игры, которые следуют рекомендациям в этой статье, будут работать с учетными записями пользователей с минимальными правами, поэтому они будут поддерживать совместимость с Windows Vista и более поздних версий.

## <a name="file-access-for-least-privileged-user-accounts"></a>Доступ к файлам для учетных записей пользователей Least-Privileged

Windows поддерживает две файловые системы: FAT32 и NTFS. FAT32 — это устаревшая файловая система, которая поддерживается только для обеспечения обратной совместимости. NTFS поддерживает более мощные и надежные разрешения на доступ к файлам. использование файловой системы NTFS в качестве розничных продавцов — это доставка новых компьютеров с Windows предварительно установленными на жестком диске с файловой системой NTFS. в системе Windows XP на основе NTFS пользователи с учетными записями пользователей с минимальными правами доступа имеют ограниченный доступ к нескольким папкам. однако они будут иметь полный доступ к системе Windows XP на основе FAT32.

В следующей таблице перечислены расположения этих папок по умолчанию и их разрешения.



| Путь                                               | Содержимое папки              | Чтение | запись | Создание/удаление |
|----------------------------------------------------|------------------------------|------|-------|---------------|
| <Drive>: \\ Windows                            | операционная система Windows | X    |       |               |
| <Drive>: \\ Program Files                      | Файлы исполняемого приложения | X    |       |               |
| <Drive>: \\ документы и Параметры \\ имя пользователя\* | Файлы каждого пользователя            | X    | X     | X             |
| <Drive>: \\ документы и Параметры \\ все пользователи  | Все файлы пользователей               | X    | X     | X             |



 

\* UserName — имя входа пользователя.

в учетной записи с минимальными правами доступа вы можете читать, записывать, создавать и удалять файлы в любой папке: documents, Параметры \\ Username или documents и Параметры \\ всех пользователей.

Это означает, что не следует размещать игры в \\ файлах программ, вместо этого они должны находиться в вложенной папке в папке " \\ Мои документы". Кроме того, не следует помещать временные данные приложений в \\ Program Files или \\ Мои документы, вместо этого их следует размещать в папке Application Data ( \_ Локальная папка \_ AppData).

В частности, существуют два сценария, которые должны быть обработаны каждой игрой:

### <a name="scenario-1-files-that-do-not-need-to-be-viewed-or-altered-by-users"></a>Сценарий 1. файлы, которые не нужно просматривать или изменять пользователями

Типичным примером будет файл конфигурации игры, временные файлы и файлы кэша игры. Эти файлы обычно хранятся в папке Application Data. Чтобы получить этот путь к папке, вызовите функцию [**шжетфолдерпас**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shgetfolderpatha) с кодом CSid \_ или local AppData (CSID), \_ \_ как показано в следующем примере кода.

``` syntax
#include <shlobj.h>
#include <strsafe.h>

#define APPNAME L"MyApp"

WCHAR wszPath[MAX_PATH];

// Local Application Data
SHGetFolderPath( hWnd, CSIDL_LOCAL_APPDATA, NULL, SHGFP_TYPE_CURRENT, wszPath );
StringCchCatW( wszPath, MAX_PATH, L"\\" );
StringCchCatW( wszPath, MAX_PATH, APPNAME );

// Create the folder wszPath
// Then create files in wszPath
// Roaming Application Data
SHGetFolderPath( hWnd, CSIDL_APPDATA, NULL, SHGFP_TYPE_CURRENT, wszPath );
StringCchCatW( wszPath, MAX_PATH, L"\\" );
StringCchCatW( wszPath, MAX_PATH, APPNAME );

// Create the folder wszPath
// Then create files in wszPath
```

различие между локальными и перемещаемыми папками данных приложений заключается в том, что в Windows 2000 и Windows XP перемещаемое содержимое копируется на сервер и с сервера в течение процесса входа и выхода, а локальное содержимое — нет. Для большинства игр достаточно данных локального приложения.

### <a name="scenario-2-files-that-need-to-be-viewed-or-altered-by-users"></a>Сценарий 2. файлы, которые должны быть просмотрены или изменены пользователями

В качестве типичного примера можно привести файлы сохраненных игр пользователя. Храните файлы в папке документов пользователя, чтобы они были легко видны пользователю. Приложение получает путь к папке документа пользователя, вызывая [**шжетфолдерпас**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shgetfolderpatha) с кодом CSid \_ (личное), как показано в следующем примере кода:

``` syntax
#include <shlobj.h>
#include <strsafe.h>

#define APPNAME L"MyApp"

WCHAR wszPath[MAX_PATH];

SHGetFolderPath( hWnd, CSIDL_PERSONAL, NULL, SHGFP_TYPE_CURRENT, wszPath );
StringCchCatW( wszPath, MAX_PATH, L"\\" );
StringCchCatW( wszPath, MAX_PATH, APPNAME );

// Create the folder wszPath
// Then create files in wszPath
```

Иногда в игре может потребоваться хранить файлы, предназначенные для просмотра и использования всеми пользователями. Одним из примеров является запись высокой оценки, в которой все пользователи записываются в один и тот же файл записи, чтобы высокие показатели поддерживались на уровне всей системы, а не отдельные высокие оценки для каждого пользователя. Другими примерами являются Скачанные карты, миссии и изменения в игре. Если они являются общими, то только один пользователь должен загрузить их, а не каждый пользователь. В этом сценарии используйте папку Document в папке Shared Profile, как показано в следующем коде.

``` syntax
#include <shlobj.h>
#include <strsafe.h>

#define APPNAME L"MyApp"

WCHAR wszPath[MAX_PATH];

SHGetFolderPath( hWnd, CSIDL_COMMON_DOCUMENTS, NULL, SHGFP_TYPE_CURRENT, wszPath );
StringCchCatW( wszPath, MAX_PATH, L"\\" );
StringCchCatW( wszPath, MAX_PATH, APPNAME );

// Create the folder wszPath
// Then create files in wszPath
```

## <a name="registry-access-for-least-privileged-user-accounts"></a>Доступ к реестру для учетных записей пользователей Least-Privileged

приложения часто используют реестр Windows для хранения информации. Аналогично доступу к файлам, учетные записи администратора и наименее привилегированных пользователей не имеют одинаковых разрешений для реестра. Для учетных записей с минимальными правами доступа весь \_ \_ узел ЛОКАЛЬНОГО компьютера hKey доступен только для чтения. Например, игра может считывать сведения о конфигурации по умолчанию, но не может записывать новые сведения на этот узел. Следовательно, игры, работающие в пользовательском режиме с минимальными привилегиями и требующие записи в реестр, должны будут \_ использовать \_ узел текущего пользователя hKey для хранения информации для каждого пользователя, как показано в следующем коде.

``` syntax
#define APP_REGISTRY_KEY_PATH L"Software\\MyCompany\\MyApp"

LONG lRetVal;
HKEY hKey;

lRetVal = RegCreateKeyExW( HKEY_CURRENT_USER,
                           APP_REGISTRY_KEY_PATH,
                           0,
                           NULL,
                           REG_OPTION_NON_VOLATILE,
                           KEY_WRITE|KEY_READ,
                           NULL,
                           &hKey,
                           NULL );

if( ERROR_SUCCESS == lRetVal )
{
    // Store information in hKey
}
```

Следует отметить, что во время установки данные реестра должны быть записаны на \_ локальный \_ компьютер hKey, а не в hKey \_ текущий \_ пользователь. Это связано с тем, что пользователь, выполняющий установку, обычно является администратором, и может быть не единственным человеком, использующим эту программу. В этом случае при записи в HKEY \_ текущий \_ пользователь информация становится недоступной для других пользователей. Обычно это не проблема, поскольку сведения, записываемые в реестр во время установки, являются параметрами конфигурации и по умолчанию, которые применяются к каждому пользователю программы.

При удалении игры необходимо выполнить дополнительные усилия, чтобы удалить каждое значение, записанное игрой в реестр. Поскольку установщик запускается одним человеком, как правило, администратор, просто удаляя соответствующую информацию в HKEY \_ локальный \_ компьютер и hKey \_ текущий \_ пользователь, вы не удаляете значения для других пользователей. Одним из способов удаления сведений для каждого пользователя в реестре является перечисление \_ корня куста реестра hKey Users. Каждый подраздел в разделе HKEY \_ Users соответствует \_ Hive текущего \_ пользователя hKey для конкретного пользователя в системе. При перечислении \_ пользователей hKey и удалении сведений, относящихся к игре, в каждом подразделе, установщик может убедиться, что никакие сведения не остались.

## <a name="patching-with-least-privileged-user-accounts"></a>Установка исправлений с учетными записями пользователей Least-Privileged

Установка исправлений для игры предполагает обновление файлов игры. Таким образом, обычно требуется доступ на запись в папку программы игры. Установка исправлений для игры — это простой процесс, который выполняется администратором, поскольку он имеет неограниченный доступ к папке программы игры. И наоборот, он, как правило, был сложным, если это не было возможно, для минимально привилегированного пользователя в исправлении игр из-за ограничений доступа. теперь [установщик Windows](/windows/desktop/Msi/windows-installer-portal) был усовершенствован, чтобы сделать возможным исправление учетной записи пользователя с минимальными привилегиями. чтобы воспользоваться преимуществами этой функции, в играх рекомендуется использовать установщик Windows для установки и исправления.

начиная с установщик Windows 3,0, при выполнении определенных условий исправления приложений могут применяться пользователями с минимальными правами. Это следующие условия:

-   приложение было установлено с помощью установщик Windows 3,0.
-   Приложение первоначально устанавливалось для каждого компьютера.
-   Приложение устанавливается со съемного носителя, такого как компакт-диск или цифровой видеодиск (DVD).
-   Исправления имеют цифровую подпись сертификата, идентифицируемого исходным пакетом установщика (.msi файл).
-   Исправления можно проверить по цифровой подписи.
-   Исходный пакет установщика не отключил исправление учетной записи пользователя с минимальными привилегиями.
-   Системный администратор не отключил исправление учетной записи с минимальными правами доступа через системную политику.

Как правило, пользователь с минимальными правами не может изменять программные файлы игры. однако если выполняются указанные выше условия и включено исправление LUA, установщик Windows может обновить файлы игры, чтобы пользователь мог получить последнюю версию.

> [!Note]  
> Сведения, содержащиеся в этой статье, относятся к предварительной версии программного обеспечения, которая может быть значительно изменена перед первым коммерческим выпуском. Таким образом, информация может не точнее описывать или отражать программный продукт при первой коммерческой выпуске. Эта статья предназначена только для информационных целей, и корпорация Майкрософт не предоставляет никаких гарантий, явных или подразумеваемых, относительно этой статьи или содержащейся в ней информации.

 

 

 