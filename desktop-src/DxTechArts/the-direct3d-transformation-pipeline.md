---
title: Конвейер преобразования Direct3D
description: В этой статье содержится техническое описание разработчиков приложений Direct3D по настройке параметров конвейера преобразования Direct3D путем непосредственной манипуляции с матрицами Direct3D.
ms.assetid: 48ae49f0-1162-c292-4bd4-34da5aadd2df
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a2b97a87293a840ccd9641b1418c2005cf73a855
ms.sourcegitcommit: 37f276b5d887a3aad04b1ba86e390dea9d87e591
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/04/2021
ms.locfileid: "103913943"
---
# <a name="the-direct3d-transformation-pipeline"></a>Конвейер преобразования Direct3D

В этой статье содержится техническое описание разработчиков приложений Direct3D по настройке параметров конвейера преобразования Direct3D путем непосредственной манипуляции с матрицами Direct3D.

-   [Обзор](#overview)
-   [Конвейер преобразования](#the-transformation-pipeline)
-   [Советы по использованию](#usage-tips)

## <a name="overview"></a>Обзор

В Direct3D используется три преобразования для перевода координат трехмерной модели в координаты пикселей (пространство экрана). Эти преобразования — мировое преобразование, видовое преобразование и проекционное преобразование.

Преобразование «мир» управляет тем, как координаты модели преобразуются в мировые координаты. Преобразование «мир» может включать переводы, вращения и масштабирование, но не применяется к индикаторам. Дополнительные сведения о работе с преобразованиями мирового уровня см. в разделе [универсальное преобразование](/windows/desktop/direct3d9/world-transform).

Представление "преобразование" управляет переходом от мировых координат в "область камеры", определяя расположение камеры в мире. Пример работы с преобразованиями представлений см. в разделе [представление преобразования](/windows/desktop/direct3d9/view-transform).

Преобразование «проекция» изменяет геометрию из области камеры на «место обрезки» и применяет искажение перспективы. Термин «пространство обрезки» означает, как геометрия обрезается в том представления во время этого преобразования. Пример работы с преобразованиями проекции см. в разделе [преобразование проекции](/windows/desktop/direct3d9/projection-transform).

Наконец, геометрия в пространстве обрезки преобразуется в координаты пикселей (пространство экрана). Это преобразование управляется параметрами окна просмотра.

Отсечение и преобразование вершин должно выполняться в однородном пространстве (просто размещение, в котором система координат включает четвертый элемент), но окончательный результат для большинства приложений должен быть не однородными трехмерными (трехмерными) координатами, определенными в "пространстве экрана". Это означает, что входные вершины и том обрезки должны быть преобразованы в однородное пространство для выполнения обрезки, а затем преобразованы обратно в неоднородное пространство для отображения.

Три преобразования Direct3D — преобразование «мир», «представление» и «проекция» — определяются матрицами Direct3D. Матрица Direct3D — это однородная матрица 4x4, определенная структурой [**D3DMATRIX**](/windows/desktop/direct3d9/d3dmatrix) . Несмотря на то, что матрицы Direct3D не являются стандартными объектами, они не представлены COM-интерфейсом. их можно создавать и задавать так же, как любой другой объект Direct3D. Дополнительные сведения о матрицах Direct3D см. в разделе [преобразования](/windows/desktop/direct3d9/transforms).

## <a name="the-transformation-pipeline"></a>Конвейер преобразования

Если вершина в координатах модели имеет значение PM = (XM, им, ZM, 1), то преобразования, показанные на следующем рисунке, применяются к экранным координатам вычислений PS = (XS, ИС, ZS, WS).

![Преобразование пространства модели в область экрана](images/d3dxfrm61.gif)

Ниже приведены описания этапов, показанных на предыдущем рисунке.

1.  Матрица World Мворлд преобразует вершины из области модели в мировое пространство. Эта матрица задается следующим образом:

    ``` syntax
        d3dDevice->SetTransform (D3DTRANSFORMSTATE_WORLD, matrix address) 
    ```

    В реализации Direct3D предполагается, что последний столбец этой матрицы имеет значение (0, 0, 0, 1). Если пользователь указывает матрицу с другим последним столбцом, то ошибка не возвращается, но освещение и туман будут неправильными.

2.  Просмотр матрицы Мвиев преобразует вершины из мирового пространства в пространство камеры. Эта матрица задается следующим образом:

    ``` syntax
        d3dDevice->SetTransform (D3DTRANSFORMSTATE_VIEW, matrix address) 
    ```

    В реализации Direct3D предполагается, что последний столбец этой матрицы имеет значение (0, 0, 0, 1). Если пользователь указывает матрицу с другим последним столбцом, то ошибка не возвращается, но освещение и туман будут неправильными.

3.  Матрица проекции Мпрож преобразует вершины из пространства камеры в пространство проекции. Эта матрица задается следующим образом:

    ``` syntax
        d3dDevice->SetTransform (D3DTRANSFORMSTATE_PROJECTION, matrix address) 
    ```

    Последний столбец матрицы проекции должен иметь значение (0, 0, 1, 0) или (0, 0, a, 0) для правильного эффекта тумана и освещения. предпочтительно использовать форму (0, 0, 1, 0).

    Отсеченный том для всех точек XP = (XP, ИП, ZP, WP) в пространстве проекции определяется следующим образом:

    ``` syntax
        -Wp < Xp <= Wp 
        -Wp < Yp <= Wp 
        0 < Zp <= Wp 
    ```

    Все точки, которые не соответствуют этим формулам, будут обрезаны.

    Если том представления определен как:

    -   Программная ширина экранного окна в пространстве камеры в ближней вырезанной плоскости
    -   SH-высота окна экрана в пространстве камеры в ближайшем вырезанной плоскости
    -   Зн. Расстояние до ближайшей плоскости обрезки вдоль Z-осей в пространстве камеры
    -   ЗФ, расстояние до дальней плоскости и оси Z в пространстве камеры

    затем матрица проекции перспективы может быть написана следующим образом:

    ![Показывает матрицу проекции перспективы.](images/d3dxfrm62.gif)

    где миж являются членами Мпрож.

    Для ортогональной проекции:

    ![Ортогональная проекция](images/d3dxfrm63.gif)

    В Direct3D предполагается, что матрица проекции перспективы имеет вид:

    ![матрица проекции перспективы](images/d3dxfrm64.gif)

    Если матрица проекции перспективы не имеет такой формы, то будут присутствовать некоторые артефакты. Например, таблица тумана не будет работать.

4.  Direct3D позволяет пользователю изменить громкость клипа следующим образом:

    ![изменение громкости клипа](images/d3dxfrm65.gif)

    Его можно переписывать следующим образом:

    ![изменение перезаписи клипа](images/d3dxfrm66.gif)

    где:

    ``` syntax
        Cx, Cy - dvClipX, dvClipY from D3DVIEWPORT9  
        Cw, Ch - dvClipWidth, dvClipHeight from D3DVIEWPORT9  
        Zmin, Zmax - dvMinZ, dvMaxZ from D3DVIEWPORT9  
    ```

    Это преобразование может обеспечить повышенную точность и эквивалентно масштабированию и сдвигу тома обрезки.

    Соответствующая матрица Мклип:

    ![Матрица мклип](images/d3dxfrm67.gif)

    Вершина преобразуется следующим образом:

    ``` syntax
        dvClipWidth = 2   
        dvClipHeight = 2   
        dvClipX = -1   
        dvClipY = 1   
        dvMinZ = 0   
        dvMaxZ = 1   
    ```

    Если вы не хотите масштабировать громкость клипа, можно задать для параметров окна просмотра значения по умолчанию:

    ``` syntax
        (Xc, Yc, Zc, Wc) = (Xp, Yp, Zp, Wp) * Mclip   
    ```

5.  Этап обрезки необязателен, если пользователь указывает \_ флаг D3DDP донотклип в вызове дравпримитиве. В этом случае все матрицы (включая MVS) могут быть объединены.
6.  Матрица масштаба окна просмотра MVS масштабирует координаты в окне окна просмотра и переворачивает ось Y в сторону:

    ![Матрица масштаба окна просмотра MVS](images/d3dxfrm68.gif)

    где:

    ``` syntax
        dwX, dwY - viewport offsets in pixels from D3DVIEWPORT9 
        dwWidth, dwHeight - viewport width and height in pixels from D3DVIEWPORT9    
    ```

7.  Наконец, экранные координаты вычисляются и передаются в средство программной прорисовки:

    ![экранные координаты, вычисленные и передаваемые в средство программной прорисовки](images/d3dxfrm69.gif)

## <a name="usage-tips"></a>Советы по использованию

Ниже приведены некоторые советы по использованию конвейера преобразования Direct3D.

-   Последний столбец мира и матрицы просмотра должны иметь значение (0, 0, 0, 1) или освещение будет неправильным.
-   Задайте параметры окна просмотра для создания матрицы Мклип Identity, если только вы не понимаете, для чего она нужна.

    ``` syntax
        dvClipWidth = 2 
        dvClipHeight = 2
        dvClipX = -1
        dvClipY = 1
        dvMinZ = 0 
        dvMaxZ = 1
    ```

 

 