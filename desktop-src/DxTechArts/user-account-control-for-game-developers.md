---
title: Контроль учетных записей для разработчиков игр
description: в этой статье описываются рекомендации и рекомендации для разработчиков игр по эффективному взаимодействии с функцией безопасности контроля учетных записей (UAC), представленной в Windows Vista.
ms.assetid: dbac1c07-73dd-f2bc-3c5c-d6160368a88f
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 14013a99926301d93a9b7b710af30f33f85b4fa1a48a60a6979c8a6868474e09
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118396538"
---
# <a name="user-account-control-for-game-developers"></a>Контроль учетных записей для разработчиков игр

в этой статье описываются рекомендации и рекомендации для разработчиков игр по эффективному взаимодействии с функцией безопасности контроля учетных записей (UAC), представленной в Windows Vista.

-   [Общие сведения об управлении учетными записями пользователей](#overview-of-user-account-control)
-   [учетные записи пользователей в Windows Vista](#user-accounts-in-windows-vista)
-   [Доступ к файлу как обычный пользователь](#file-access-as-a-standard-user)
-   [Доступ к реестру как обычный пользователь](#registry-access-as-a-standard-user)
-   [Повышение привилегий](#privilege-elevation)
-   [Влияние контроля учетных записей на функцию CreateProcess ()](#uac-implications-with-createprocess)
-   [Задание уровня выполнения в манифесте приложения](#setting-the-execution-level-in-the-application-manifest)
-   [Встраивание манифеста в Visual Studio](#embedding-a-manifest-in-visual-studio)
-   [Совместимость UAC с более старыми играми](#uac-compatibility-with-older-games)
-   [Устаревшие сценарии и манифесты](#legacy-scenarios-and-manifests)
-   [Заключение](#conclusion)
-   [Дополнительные материалы](#further-reading)

## <a name="overview-of-user-account-control"></a>Общие сведения об управлении учетными записями пользователей

контроль учетных записей (UAC), появившийся в Windows Vista, — это функция безопасности, которая призвана помочь предотвратить использование слабых злоумышленниками уязвимостей или ошибок, обнаруженных в широко используемых приложениях, для изменения операционной системы или других установленных программ. Это достигается путем запуска подавляющего большинства программ и процессов в качестве стандартного пользователя (также известного как ограниченный пользователь, ограниченный пользователь или пользователь Least-Privileged), даже если учетная запись текущего пользователя имеет учетные данные администратора. Процесс с правами обычного пользователя имеет множество ограничений, которые не позволяют вносить изменения на уровне системы.

UAC также отвечает за повышение привилегий процесса, используя схему проверки подлинности на основе диалоговых окон, инициированную при выполнении определенных процессов, которые обозначаются как обязательные права администратора. Повышение привилегий позволяет администраторам запускать большинство приложений на уровне безопасности (то же самое, что и любой другой стандартный пользователь), но также разрешать выполнение процессов и операций, требующих прав администратора. UAC поддерживает сквозную проверку подлинности, чтобы администратор мог предоставить программе повышенные привилегии, пока Стандартный пользователь в системе не вошел в систему.

Функция UAC включена по умолчанию. Хотя Администратор может отключить UAC на уровне всей системы, это имеет ряд негативных последствий. Во первых, это приводит к ослаблению безопасности всех административных учетных записей, так как все процессы запускаются с административными учетными данными, даже если они действительно не требуются большинству приложений. Если UAC отключен, стандартное пользовательское приложение, предоставляющее уязвимую уязвимость в системе безопасности, потенциально может быть использовано для кражи частной информации, установки rootkit-программ или шпионского по, уничтожения целостности системы или размещения зомби-атак в других системах. В то время как функция UAC включена, запуск большинства программного обеспечения в качестве обычного пользователя значительно ограничивает потенциальный ущерб от такой ошибки. Во-вторых, отключение UAC отключает многие обходные пути для совместимости приложений, которые позволяют обычным пользователям успешно запускать широкий спектр приложений. Отключение UAC не рекомендуется использовать в качестве решения для совместимости.

Важно отметить, что приложения должны использовать стандартные права пользователя, только если это возможно. Администраторы могут легко повышать уровень привилегий процесса, однако при каждом запуске приложения все равно требуется вмешательство пользователя и подтверждение, требующее учетных данных администратора. Это повышение необходимо также выполнить во время запуска программы, поэтому требование учетных данных администратора даже для одной операции требует предоставления системе большего риска для всего времени выполнения приложения. Обычные пользователи, не имеющие возможности повышать свои привилегии, также часто встречаются в параметрах семьи и бизнеса. «Запуск от имени администратора» не является хорошим решением для обеспечения совместимости, предоставляет пользователю и системе повышенную угрозу безопасности и создает разочарование для пользователей во многих ситуациях.

> [!Note]  
> функция контроля учетных записей пользователей, появившаяся в Windows Vista, также присутствует в Windows 7. В то время как взаимодействие с пользователем, работающее с различными системными функциями, было улучшено по отношению к контролю учетных записей пользователей, влияние на приложения практически не отличается. все рекомендации по Windows Vista, описанные в этой статье, применимы и к Windows 7. дополнительные сведения об изменениях пользовательского интерфейса UAC для Windows 7 см. в разделе [пользовательский интерфейс — обновления диалогового окна управления учетными записями пользователей](../win7appqual/user-interface---user-account-control-dialog-updates.md).

 

## <a name="user-accounts-in-windows-vista"></a>учетные записи пользователей в Windows Vista

Windows В Vista каждый пользователь распределяется по двум типам учетных записей: Администраторы и обычные пользователи.

учетная запись обычного пользователя аналогична учетной записи с ограниченным доступом в Windows XP. как и в Windows XP, стандартный пользователь не может выполнять запись в папку Program files, не может выполнить запись в \_ раздел реестра HKEY на локальном \_ компьютере и не может производить задачи, которые изменяют систему, например установку драйвера режима ядра или доступ к пространствам процессов системного уровня.

с момента выпуска Windows XP учетная запись администратора значительно изменилась. Ранее всем процессам, запущенным членом группы "Администраторы", были предоставлены права администратора. При включенном контроле учетных записей все процессы выполняются с правами обычного пользователя, если только администратор не повышают их. Это различие делает учетные записи в группе «Администраторы» более безопасными, уменьшая риски безопасности, вызванные потенциальными ошибками в большинстве программ.

Важно, чтобы все приложения, особенно игры, работали эффективно и в соответствии с выполняемыми процессами обычного пользователя. Все операции, требующие прав администратора, должны выполняться во время установки или с помощью вспомогательных программ, которые явно запрашивают учетные данные администратора. Хотя повышение привилегий довольно тривиально для члена группы "Администраторы", стандартные пользователи должны откладываться на учетные данные администратора, чтобы физически ввести пароль для повышения привилегий. поскольку учетные записи, защищенные с помощью родительского контроля, должны быть обычными пользователями, это будет очень распространенной ситуацией для любителей, использующих Windows Vista.

если ваша игра уже работает на Windows XP с ограниченными учетными записями пользователей, то переход на систему контроля учетных записей на Windows Vista должен быть очень простым. Большинство таких приложений будет работать как есть, хотя настоятельно рекомендуется добавить манифест приложения. (Манифесты описаны далее в этом разделе, посвященном [настройке уровня выполнения в манифесте приложения](#setting-the-execution-level-in-the-application-manifest).)

## <a name="file-access-as-a-standard-user"></a>Доступ к файлу как обычный пользователь

Аспектом игры, которые наиболее подвержены ограничениям обычного пользователя, являются организация файловой системы и специальные возможности. Никогда не следует рассчитывать, что игра может записывать файлы в папку, в которой установлена игра. в Windows Vista для экземпляра пользователь должен обладать повышенными привилегиями операционной системы, прежде чем приложение сможет выполнять запись в папку Program files. чтобы избежать этого, следует классифицировать файлы данных игр по области и доступности, а также использовать функцию [**шжетфолдерпас**](/windows/win32/api/shlobj_core/nf-shlobj_core-shgetfolderpatha) вместе с константами csid, предоставленными оболочкой Windows, для создания соответствующих путей к файлам. Константы CSID соответствуют известным папкам в файловой системе, используемой операционной системой, и позволяют секционировать глобальные и пользовательские файлы.

попытка создать или записать файл или каталог в папку, которая не предоставляет разрешение на запись в процесс, приведет к сбою в Windows Vista, если приложение не имеет прав администратора. Если исполняемый файл 32-разрядной игры работает в устаревшем режиме, так как он не объявил запрошенный уровень выполнения, операции записи будут выполнены успешно, но будут подвергаться виртуализации, как описано в разделе "совместимость UAC с более старыми играми" Далее в этой статье.

**Таблица 1. Известные папки**



| Имя CSID             | типичный путь (Windows Vista)                                                   | Права обычного пользователя | Права администратора | Область доступа | Описание                                                                                                                      | Примеры                                                          |
|------------------------|--------------------------------------------------------------------------------|----------------------|----------------------|--------------|----------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------|
| личный код CSID \_        | В. \\ Пользователи, \\ документы, имена пользователей \\                                                | Чтение/запись           | Чтение/запись           | Per-User     | Пользовательские файлы игр, которые считываются и изменяются и могут управляться за пределами контекста игры.                          | Снимки экрана. Сохраненные игровые файлы с сопоставлением с расширением файла. |
| \_Локальная папка \_ AppData CSid  | В: \\ Пользователи \\ имя пользователя \\ AppData \\ Local                                           | Чтение/запись           | Чтение/запись           | Per-User     | Файлы игр для отдельных пользователей, которые считываются и изменяются и используются только в контексте игры.                                 | Файлы игрового кэша. Конфигурации проигрывателя.                          |
| \_распространенная папка \_ AppData | C: \\ папка ProgramData                                                                | Чтение и запись, если владелец  | Чтение/запись           | Все пользователи    | Файлы игр, которые могут быть созданы пользователем и прочитаны всеми пользователями. Доступ на запись предоставляется только создателю файла (owner). | Профили пользователей                                                     |
| \_программные \_ файлы CSid  | C: \\ Program Files<br/> или диспетчер конфигурации служб<br/> C: \\ Program Files (x86) <br/> | Только для чтения            | Чтение/запись           | Все пользователи    | Статические игровые файлы, написанные установщиком игр, которые считываются всеми пользователями.                                                    | Игровые ресурсы, такие как материалы и сетки.                        |



 

Как правило, ваша игра устанавливается в папку в папке, представленной \_ \_ константой программных файлов CSid. Однако это не всегда так. Вместо этого следует использовать относительный путь из исполняемого файла при создании строк пути к файлам или каталогам, расположенным в папке установки.

Кроме того, следует отменять использование жестко запрограммированных допущений относительно известных путей к папкам. например, в Windows XP Professional 64-bit Edition и Windows Vista x64 путь к файлам программы — C: \\ program files (x86) для 32-разрядных программ и C: \\ program files для 64-разрядных программ. эти известные пути изменяются с Windows XP, и пользователи могут повторно настраивать расположение многих из этих папок и даже размещать их на разных дисках. Поэтому всегда используйте константы CSID, чтобы избежать путаницы и потенциальных проблем. Windows программа установки распознает эти известные расположения папок и переместит данные при обновлении операционной системы с Windows XP; в отличие от этого, использование нестандартных расположений или жестко запрограммированных путей может привести к сбою после обновления ОС.

Обратите внимание на очевидные различия в удобстве использования пользовательских папок, заданных стандартом CSID \_ и локальной AppData (CSID) \_ \_ . Рекомендуемым вариантом выбора константы CSID для записи файла является использование CSID \_ Personal, если предполагается, что пользователь взаимодействует с файлом, например двойным щелчком мыши, чтобы открыть его в средстве или приложении, и использовать \_ локальную \_ AppData для других файлов с именем CSid. Обе папки могут использоваться приложением для хранения и организации файлов данных, относящихся к пользователю, так как они не отличаются в области доступа или уровня привилегий. Следует соблюдать осторожность при создании имен путей, которые достаточно уникальны для того, чтобы не конфликтовать с другими приложениями, но достаточно коротко, чтобы хранить количество символов в полном пути меньше, чем значение MAX \_ path, 260.

В следующем коде приведен пример того, как записать файл в известную папку:

``` syntax
#include <windows.h>
#include <shlobj.h>
#include <shlwapi.h>
        ...
        ...
        ...
        TCHAR strPath[MAX_PATH];
        if( SUCCEEDED(
        SHGetFolderPath( NULL, CSIDL_PERSONAL, NULL, SHGFP_TYPE_CURRENT, strPath ) ) )
        {
        PathAppend( strPath, TEXT( "Company Name\\Title" ) );

        if( !PathFileExists( strPath ) )
        {
        if( ERROR_SUCCESS != SHCreateDirectoryEx( NULL, strPath, NULL ) )
        return E_FAIL;
        }

        PathAppend( strPath, TEXT( "gamefile.txt" ) );

        // strPath is now something like:
        // C:\Users\<current user>\Documents\Company Name\Title\gamefile.txt
        // Open the file for writing
        HANDLE hFile = CreateFile(strPath, GENERIC_WRITE, NULL, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);

        if( INVALID_HANDLE_VALUE != hFile )
        {
        // TODO: Write to file
        CloseHandle(hFile);
        }
        }
```

## <a name="registry-access-as-a-standard-user"></a>Доступ к реестру как обычный пользователь

Доступ к реестру обычного пользователя ограничивается тем же способом, что и файловая система. Обычному пользователю разрешен доступ на чтение ко всем ключам в реестре; Тем не менее доступ на запись предоставляется только \_ \_ поддереву, которое сопоставляется внутренне с поддеревом пользователя hKey \_ \\ ID безопасности (SID) текущего пользователя. Приложению, для которого требуется выполнить запись в реестр, отличный от \_ текущего пользователя hKey, \_ требуются права администратора.

Если 32-разрядное приложение не содержит запрошенный уровень выполнения в манифесте, то все операции записи в программу HKEY на \_ локальном \_ компьютере \\ будут виртуализированы, а запись в другие расположения за пределами текущего пользователя hKey завершится \_ \_ ошибкой.

Хранение постоянных данных в реестре, например конфигурации пользователя, не рекомендуется. Предпочтительным способом хранения постоянных данных из игры является запись данных в файловую систему путем вызова [**шжетфолдерпас**](/windows/win32/api/shlobj_core/nf-shlobj_core-shgetfolderpatha) и получения значения константы CSid, описанной в предыдущем разделе.

## <a name="privilege-elevation"></a>Повышение привилегий

в Windows Vista любое приложение, требующее прав администратора, должно объявлять запрос на уровне администрирования в своем манифесте (как описано в следующем разделе [установка уровня выполнения в манифесте приложения](#setting-the-execution-level-in-the-application-manifest)).

Повышение уровня, как известно, — это процедура, управляемая функцией UAC для продвижения процесса к административному процессу. Привилегии процесса могут повышаться только во время создания. После создания процесс никогда не будет повышен до более высокого уровня привилегий. По этой причине. операции, требующие административных учетных данных, должны быть изолированы от отдельных установщиков и других вспомогательных программ.

При выполнении программы UAC проверяет запрошенный уровень выполнения в манифесте и, если требуются повышенные привилегии, запрашивает у текущего пользователя одно из двух стандартных диалоговых окон: одно для обычного пользователя и другое для администратора.

Если текущий пользователь является обычным пользователем, UAC запрашивает у пользователя учетные данные администратора, прежде чем разрешить выполнение программы.

**Рис. 1. Запрос стандартного пользователя на ввод учетных данных для учетной записи администратора**

![запрос стандартного пользователя на ввод учетных данных для учетной записи администратора](images/uac-prompt-elevation.jpg)

Если текущий пользователь является администратором, функция UAC запрашивает у пользователя разрешение, прежде чем разрешить выполнение программы.

**Рис. 2. Запрос администратора на авторизацию изменений на компьютере**

![запрос администратора на авторизацию изменений на компьютере](images/uac-prompt-authorization.jpg)

Приложению предоставляются права администратора, только если стандартный пользователь предоставил правильные учетные данные администратора или пользователь с правами администратора предоставит подтверждение. что-то еще приведет к завершению работы приложения.

Важно отметить, что процесс с повышенными привилегиями выполняется от имени пользователя с правами администратора, который вводит учетные данные в запрос UAC, а не в качестве стандартного пользователя, выполнившего вход в систему. это аналогично **запуску программы RunAs** в Windows XP. процесс с повышенными правами получает доступ к папке и разделам реестра администратора при обращении к данным для каждого пользователя, а все программы, запускаемые процессом с повышенными правами, также наследуют права администратора и расположения учетной записи пользователя. Для администраторов, которые запрашивают подтверждение ( "продолжить **" или "Отмена"**), эти расположения будут соответствовать расположениям текущего пользователя. Однако в общем случае процессы, требующие повышения прав, не должны обрабатывать данные для каждого пользователя. Обратите внимание, что это может существенно повлиять на работу установщика. Если установщик, работающий от имени администратора, записывает данные в HKCU или профиль пользователя, он может быть очень хорошо записан в неправильное расположение. Рассмотрите возможность создания этих значений для каждого пользователя при первом запуске игры.

## <a name="uac-implications-with-createprocess"></a>Влияние контроля учетных записей на функцию CreateProcess ()

Механизм повышения прав UAC не будет вызываться из вызова функции Win32 [**CreateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa)() для запуска исполняемого файла, который настроен так, чтобы требовать более высокий уровень выполнения по сравнению с текущим процессом. В результате вызов функции **CreateProcess**() завершится с ошибкой [**GetLastError**](/windows/win32/api/errhandlingapi/nf-errhandlingapi-getlasterror)(), возвращающей повышение погрешности \_ \_ . Процедура **CreateProcess**() будет выполнена только в том случае, если уровень выполнения вызываемого объекта равен или меньше значения вызывающего объекта. Процесс без повышения прав, который должен порождать процессы с повышенными правами, должен сделать это с помощью функции [**ShellExecute**](/windows/win32/api/shellapi/nf-shellapi-shellexecutea)(), которая приведет к активации механизма повышения прав UAC с помощью оболочки.

## <a name="setting-the-execution-level-in-the-application-manifest"></a>Задание уровня выполнения в манифесте приложения

Вы объявили запрошенный уровень выполнения игры, добавив расширение в манифест приложения. В следующем коде XML показана минимальная конфигурация, необходимая для установки уровня выполнения для приложения.

``` syntax
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<assembly xmlns="urn:schemas-microsoft-com:asm.v1" manifestVersion="1.0">
    <ms_asmv2:trustInfo xmlns:ms_asmv2="urn:schemas-microsoft-com:asm.v2">
        <ms_asmv2:security>
            <ms_asmv2:requestedPrivileges>
                <ms_asmv2:requestedExecutionLevel level="asInvoker" uiAccess="false" />
            </ms_asmv2:requestedPrivileges>
        </ms_asmv2:security>
    </ms_asmv2:trustInfo>
</assembly>
```

В приведенном выше коде операционная система сообщила, что для игры требуются права обычного пользователя только по следующему тегу:

``` syntax
<ms_asmv2:requestedExecutionLevel level="asInvoker" uiAccess="false" />
```

При явном задании requestedExecutionLevel в значение "asInvoker" Этот пример утверждает операционной системе, что игра будет работать нормально без прав администратора. в результате UAC отключает виртуализацию и запускает игру с теми же привилегиями, что и вызывающий объект, который обычно имеет привилегии обычного пользователя, так как Windows Explorer работает от имени обычного пользователя.

Чтобы получить доступ к операционной системе, необходимо повысить уровень прав администратора, заменив "asInvoker" на "requireAdministrator", чтобы создать следующий тег:

``` syntax
<ms_asmv2:requestedExecutionLevel level="requireAdministrator" uiAccess="false" />
```

При такой конфигурации операционная система запрашивает у текущего пользователя одно из стандартных диалоговых окон по повышению прав UAC при каждом запуске игры. Настоятельно рекомендуется, чтобы ни одна игра не запускала права администратора, поскольку это диалоговое окно не будет работать быстро, но оно также сделает игру несовместимой с родительскими элементами управления. Перед добавлением этого требования в любой исполняемый файл тщательно продумайте.

Распространенное заблуждение заключается в том, что добавление манифеста, устанавливающего requestedExecutionLevel в значение «requireAdministrator», обходит необходимость в запросе на повышение прав. Это не так. Это просто не потребует от операционной системы угадать, требуются ли для установки или обновления приложения права администратора. Пользователю по-прежнему предлагается авторизовать повышение прав.

Windows проверяет подпись любого приложения, помеченного на повышение прав, перед отображением запроса контроля учетных записей. Большой исполняемый файл, помеченный для повышения прав, занимает больше времени, чем небольшой исполняемый файл, и дольше, чем исполняемый файл, помеченный как "asInvoker". Исполняемые файлы программы установки, которые являются самораскрывающимися, должны быть помечены как «asInvoker», а все части, которые необходимо пометить как «requireAdministrator», должны быть помещены в отдельный вспомогательный исполняемый файл.

Атрибут uiAccess, показанный в предыдущих примерах, должен всегда иметь значение FALSE для игр. Этот атрибут указывает, имеют ли клиенты автоматизации пользовательского интерфейса доступ к защищенному системному ИНТЕРФЕЙСу, и имеют особые последствия безопасности, если задано значение TRUE.

## <a name="embedding-a-manifest-in-visual-studio"></a>Встраивание манифеста в Visual Studio

поддержка манифеста впервые добавлена в Visual Studio, начиная с VS2005. по умолчанию исполняемый файл, встроенный в Visual Studio 2005 (или более поздней версии), будет содержать автоматически созданный манифест, внедренный в состав процесса сборки. Содержимое автоматически созданного манифеста зависит от определенных конфигураций проекта, указанных в диалоговом окне Свойства проекта.

манифест, автоматически формируемый Visual Studio 2005, не будет содержать <trustInfo> блок, так как не существует способа настройки уровня выполнения UAC в свойствах проекта. Предпочтительный способ добавления этих сведений — позволить VS2005 объединить определяемый пользователем манифест, содержащий <trustInfo> блок, с автоматически созданным манифестом. Это так же просто, как добавить в \* решение файл. manifest, содержащий XML-код, указанный в предыдущем разделе. когда Visual Studio встречает файл манифеста в решении, он автоматически вызывает средство манифеста (mt.exe) для слияния файлов. manifest с автоматически созданным.

> [!Note]  
> в средстве манифеста (mt.exe) имеется ошибка, предоставляемая Visual Studio 2005, которая приводит к объединенному и внедренному манифесту, что может вызвать проблемы при запуске исполняемого файла в Windows XP до SP3. Ошибка является следствием того, как средство переопределяет пространство имен по умолчанию при объявлении <trustInfo> блока. К счастью, можно легко обойти проблему, явно объявляя другое пространство имен в <trustInfo> блоке и выполнив области дочернего узла до нового пространства имен. Это исправление показано в XML-коде, приведенном в предыдущем разделе.

 

предупреждение об использовании средства mt.exe, включенного в Visual Studio 2005, заключается в том, что при обработке блока будет выдаваться предупреждения, <trustInfo> так как средство не содержит обновленную схему для проверки XML. чтобы устранить это предупреждение, рекомендуется заменить все файлы mt.exe в каталоге установки Visual Studio 2005 (существует несколько экземпляров) с mt.exe, указанным в последней Windows SDK.

начиная с Visual Studio 2008, теперь можно указать уровень выполнения приложения в диалоговом окне свойств проекта (рис. 3) или с помощью флага компоновщика/MANIFESTUAC. установка этих параметров приведет к тому, что Visual Studio 2008 будет автоматически создавать и внедрять манифест с соответствующим <trustInfo> блоком в исполняемый файл.

**Рис. 3. установка уровня выполнения в Visual Studio 2008**

![Настройка уровня выполнения в Visual Studio 2008](images/setting-execution-level-in-vs2008.jpg)

внедрение манифеста в более ранние версии Visual Studio без поддержки манифеста по-прежнему возможно, но требует больше работы от разработчика. пример того, как это сделать, см. в проекте Visual Studio 2003, включенном в любой пример в пакете SDK DirectX, до выпуска версии за март 2008.

## <a name="uac-compatibility-with-older-games"></a>Совместимость UAC с более старыми играми

если в игре кажется, что файл успешно сохранен и загружен в каталог Program files, но нет свидетельства о файловом Windows Vista, любое 32-разрядное приложение, которое не содержит запрошенный уровень выполнения в его манифесте, считается устаревшим приложением. до Windows Vista большинство приложений обычно выполнялись пользователями с правами администратора. в результате эти приложения могут свободно считывать и записывать системные файлы и разделы реестра, и многие разработчики не сделали изменений, необходимых для правильной работы с ограниченными учетными записями пользователей в Windows XP. однако в Windows Vista эти же приложения будут завершаться сбоем из-за недостаточных прав доступа в новой модели безопасности, что обеспечивает выполнение стандартного пользователя для устаревших приложений. чтобы снизить последствия этого, виртуализация также была добавлена в Windows Vista. виртуализация позволит поддерживать тысячи устаревших приложений на Windows Vista, не требуя, чтобы эти приложения были более высоким уровнем привилегий в любой момент, просто для выполнения нескольких небольших операций. , шансы на то, что ваша игра работает в устаревшем режиме и была подвержена виртуализации.

Виртуализация влияет на файловую систему и реестр путем перенаправления записей, чувствительных к системе (и последующих операций с файлами и реестрами), к месту на уровне пользователя в профиле текущего пользователя. Например, если приложение пытается выполнить запись в следующий файл:

<dl> C: \\ Program Files название \\ компании \\ \\config.ini  
</dl>

запись автоматически перенаправляется в:

<dl> C: \\ Users \\ имя пользователя \\ AppData \\ Local \\ виртуалсторе \\ Program Files название \\ организации \\ \\config.ini  
</dl>

Аналогично, если приложение пытается записать значение реестра следующим образом:

<dl> Название \_ компании hKey по для локального \_ компьютера \\ \\ \\  
</dl>

Вместо этого он будет перенаправлен на:

<dl> HKEY. \_ текущие \_ пользовательские \\ классы программного обеспечения \\ \\ виртуалсторе \\ машинного \\ программного обеспечения \\ \\ название компании  
</dl>

Доступ к файлам и разделам реестра, затронутым виртуализации, осуществляется только с помощью операций с файлами и реестрами из виртуализированных приложений, работающих от имени текущего пользователя.

Однако виртуализация имеет много ограничений. Один из них заключается в том, что 64-разрядные приложения никогда не работают в устаревшем режиме для операций совместимости, которые связаны с виртуализацией в 32-разрядных приложениях, в 64-bit. Кроме того, если устаревшее приложение, выполняемое в качестве стандартного пользователя, пытается записать любой тип исполняемого файла в расположение, для которого требуются учетные данные администратора, виртуализация не будет выполняться и запись завершится ошибкой.

**Рис. 4. Процесс виртуализации**

![процесс виртуализации](images/uac-virtualization-process.jpg)

Когда устаревшее приложение пытается выполнить операцию чтения с учетом системных расположений в файловой системе или реестре, сначала выполняется поиск в виртуальных расположениях. Если файл или раздел реестра не найден, операционная система обращается к системным расположениям по умолчанию.

виртуализация будет удалена из последующих версий Windows поэтому важно не полагаться на эту функцию. Вместо этого следует явно настроить манифест приложения для стандартных привилегий пользователя или администратора, так как это приведет к отключению виртуализации. Виртуализация также не очевидна для конечных пользователей, поэтому, несмотря на то, что виртуализация может позволить приложению работать, он может создавать вызовы поддержки и затруднять проблемы для этих клиентов.

Обратите внимание, что если контроль учетных записей отключен, Виртуализация также отключается. если виртуализация отключена, учетные записи обычных пользователей ведут себя так же, как ограниченные учетные записи пользователей в Windows XP, а устаревшие приложения могут работать неправильно для обычных пользователей, которые в противном случае были бы успешно выполнены в результате виртуализации

## <a name="legacy-scenarios-and-manifests"></a>Устаревшие сценарии и манифесты

Для большинства сценариев использования просто помечайте .exe правильными элементами манифеста контроля учетных записей и убедитесь, что приложение работает правильно, так как стандартный пользователь достаточно для обеспечения отличной совместимости с UAC. большинство игроков работают Windows Vista или Windows 7 с включенным контролем учетных записей пользователей. для Windows XP и пользователей в Windows Vista или Windows7 с отключенной функцией контроля учетных записей пользователей они обычно запускаются с помощью учетных записей администратора. Хотя это менее безопасный режим работы, он обычно не будет работать с какими-либо дополнительными проблемами совместимости, хотя, как указано выше, отключение UAC также отключает виртуализацию.

Следует отметить, что в манифесте контроля учетных записей программа помечена как «requireAdministrator». в Windows XP и Windows Vista или Windows 7 с отключенным контролем учетных записей элементы манифеста UAC игнорируются системой. В этом случае пользователи с учетными записями администратора всегда будут запускать все программы с полными правами администратора, поэтому эти программы будут работать должным образом. Windows однако пользователи с ограниченными правами и обычные пользователи, работающие в Windows Vista или Windows 7, всегда будут запускать эти программы с ограниченными полномочиями, и все операции на уровне администратора завершатся сбоем. Поэтому рекомендуется, чтобы программы, помеченные как «Рекуиретадминистратор», вызывали [**исусеранадмин**](/windows/win32/api/shlobj_core/nf-shlobj_core-isuseranadmin) при запуске и отображали неустранимую ошибку, если она возвращает значение false. Для сценария большинства, описанного выше, это всегда будет удачно, но обеспечивает лучшую работу пользователя и четкое сообщение об ошибке в этой редкий ситуации.

## <a name="conclusion"></a>Заключение

как разработчик игр, нацеленный на многопользовательскую среду Windows, крайне важно, чтобы ваша игра работала эффективно и ответственно. Основной исполняемый файл игры не должен зависеть от прав администратора. Это не только предотвращает появление запросов на повышение прав при каждом запуске игры, что может негативно повлиять на работу пользователей, но также позволяет вашей игре использовать преимущества других функций, требующих выполнения обычных пользовательских привилегий, таких как родительские элементы управления.

для приложений, которые должны работать как с учетными данными обычного пользователя (или ограниченного пользователя) в предыдущих версиях Windows не повлияли UAC, они будут выполняться без повышения прав. Однако они должны включать манифест с требуемым уровнем выполнения, равным "asInvoker", для соответствия стандартам приложения для Vista.

## <a name="further-reading"></a>Дополнительные материалы

чтобы получить помощь в проектировании приложений для Windows Vista, соответствующих контролю учетных записей, скачайте следующий технический документ: [требования к разработке приложений Windows Vista для обеспечения совместимости с контролем учетных записей пользователей](/previous-versions/dotnet/articles/bb530410(v=msdn.10)).

Этот технический документ содержит подробные инструкции по проектированию, а также примеры кода, требования и рекомендации. в этой статье также подробно описаны технические обновления и изменения в работе пользователей в Windows Vista.

дополнительные сведения об управлении учетными записями пользователей см. [Windows Vista: управление учетными записями пользователей](https://www.microsoft.com/technet/windowsvista/security/uac.mspx) в [Microsoft TechNet](https://www.microsoft.com/technet/).

еще один полезный ресурс — это статья, в которой [ваши приложения хорошо воспроизводятся с помощью контроля учетных записей Windows Vista](/archive/msdn-magazine/2007/january/teach-your-apps-to-work-with-windows-vista-user-account-control), из [журнала MSDN Magazine](/archive/msdn-magazine/msdn-magazine-issues)2007 января. в этой статье рассматриваются общие вопросы совместимости приложений, а также преимущества и проблемы использования пакетов установщик Windows в Windows Vista.

дополнительные сведения об ошибке и исправлении для mt.exe, средство, используемое Visual Studio 2005 для автоматического слияния и встраивания манифеста в исполняемый файл, см. [в разделе обзор манифестов, часть 2. пространства имен по умолчанию и манифесты UAC в Windows Vista](https://techcommunity.microsoft.com/t5/Windows-Blog-Archive/bg-p/Windows-Blog-Archive/2006/09/08/exploring-manifests-part-2-default-namespaces-and-uac-manifests-in-windows-vista/) в блоге крис Jackson на [сайте MSDN](/archive/blogs/).

 

