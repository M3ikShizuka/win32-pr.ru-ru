---
description: ДКСВА обработка видео включает функции графического оборудования, предназначенные для обработки несжатых видеоизображений. Службы обработки видео включают в себя дечередование и смешение видео.
ms.assetid: bd688f81-4b7c-4016-b0bd-e40782131f8e
title: Обработка видео ДКСВА
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: bcf5058d93ddd7c506a501eb6ca07c4661755fc8
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104539560"
---
# <a name="dxva-video-processing"></a>Обработка видео ДКСВА

ДКСВА обработка видео включает функции графического оборудования, предназначенные для обработки несжатых видеоизображений. Службы обработки видео включают в себя дечередование и смешение видео.

В этом разделе содержатся следующие подразделы.

-   [Обзор](#overview)
-   [Создание устройства обработки видео](#creating-a-video-processing-device)
    -   [Получение указателя Идиректксвидеопроцессорсервице](#get-the-idirectxvideoprocessorservice-pointer)
    -   [Перечисление устройств обработки видео](#enumerate-the-video-processing-devices)
    -   [Перечислить форматы Render-Target](#enumerate-render-target-formats)
    -   [Запрос возможностей устройства](#query-the-device-capabilities)
    -   [Создание устройства](#create-the-device)
-   [Видеопроцесс Блит](#video-process-blit)
    -   [Параметры Блит](#blit-parameters)
    -   [Примеры входных данных](#input-samples)
-   [Композиция изображений](#image-composition)
    -   [Пример 1. пустых](#example-1-letterboxing)
    -   [Пример 2. изображения подпотока растяжения](#example-2-stretching-substream-images)
    -   [Пример 3. несоответствие высоты потока](#example-3-mismatched-stream-heights)
    -   [Пример 4. целевой прямоугольник меньше поверхности назначения](#example-4-target-rectangle-smaller-than-destination-surface)
    -   [Пример 5. исходные прямоугольники](#example-5-source-rectangles)
    -   [Пример 6. пересечение прямоугольников назначения](#example-6-intersecting-destination-rectangles)
    -   [Пример 7. растяжение и обрезка видео](#example-7-stretching-and-cropping-video)
-   [Порядок входных образцов](#input-sample-order)
    -   [Пример 1](#example-1-letterboxing)
    -   [Пример 2](#example-2-stretching-substream-images)
    -   [Пример 3](#example-3-mismatched-stream-heights)
    -   [Пример 4](#example-4-target-rectangle-smaller-than-destination-surface)
-   [См. также](#related-topics)

## <a name="overview"></a>Обзор

Графическое оборудование может использовать графический процессор (GPU) для обработки несжатых видео-изображений. Устройство *обработки видео* — это программный компонент, инкапсулирующий эти функции. Приложения могут использовать устройство обработки видео для выполнения таких функций, как:

-   Дечередование и обратная чересстрочности
-   Смешивание подпотоков видео на основном видеоизображении
-   Настройка цвета (в cAmp) и фильтрация изображений
-   Масштабирование изображения
-   Преобразование цветового пространства
-   Альфа-смешение

На следующей диаграмме показаны этапы конвейера обработки видео. Схема не предназначена для отображения фактической реализации. Например, графический драйвер может сочетать несколько этапов в одну операцию. Все эти операции можно выполнить в одном вызове устройства обработки видео. Некоторые показанные здесь этапы, такие как фильтрация шума и подробностей, могут не поддерживаться драйвером.

![Диаграмма, на которой показаны этапы обработки видео дксва.](images/8581554e-a1bc-4cab-9ae1-99a6537e2a84.gif)

Входные данные для конвейера обработки видео всегда включают *основной* поток видео, который содержит основные данные изображения. Основной поток видео определяет частоту кадров для выходного видео. Каждый кадр выходного видео вычисляется относительно входных данных из основного видеопотока. Пиксели в основном потоке всегда являются непрозрачными, без данных на основе альфа-пикселя. Основной видеопоток может быть прогрессивным или чередованием.

При необходимости конвейер обработки видео может получить до 15 подпотоков видео. Подпоток содержит дополнительные данные изображения, такие как скрытые субтитры или DVD-диски. Эти изображения отображаются в основном видеопотоке и, как правило, не отображаются сами по себе. Изображения в подпотоке могут содержать альфа-данные для каждого пикселя и всегда прогрессивные кадры. Устройство обработки видео Alpha — смешивает изображения подпотока с текущим разотроеным кадром из основного видеопотока.

В оставшейся части этого раздела термин *изображение* используется для входных данных на устройство обработки видео. Изображение может состоять из последовательного кадра, одного поля или двух полей с чередованием. Выходные данные всегда имеют разкадровую рамку.

Видеодрайвер может реализовать несколько устройств обработки видео, чтобы предоставить различные наборы возможностей обработки видео. Устройства идентифицируются по идентификатору GUID. Следующие идентификаторы GUID являются стандартными:

-   **DXVA2 \_ Видеопрокбобдевице**. Это устройство выполняет дечередование Боба.
-   **DXVA2 \_ Видеопрокпрогрессиведевице**. Это устройство используется, если видео содержит только прогрессивные кадры без чередующихся кадров. (В некоторых видеоматериалах содержится сочетание последовательных и чередующихся кадров. Прогрессивное устройство не может использоваться для этого типа смешанного видеоматериала, так как для чередующихся кадров требуется шаг с чередованием.)

Каждый графический драйвер, поддерживающий обработку видео ДКСВА, должен реализовывать по крайней мере эти два устройства. Графический драйвер может также предоставлять другие устройства, которые определяются с помощью идентификаторов GUID, определяемых драйвером. Например, драйвер может реализовать собственный алгоритм дечередования, который обеспечивает более качественные выходные данные, чем Боб. Некоторые алгоритмы разчередования могут потребовать, чтобы изображения прямого или обратной ссылки из первичного потока. В этом случае вызывающий объект должен предоставить эти изображения драйверу в правильной последовательности, как описано далее в этом разделе.

Также предоставляется справочное программное устройство. Программное устройство оптимизировано для качества, а не для скорости и может быть недостаточным для обработки видео в реальном времени. На справочном программном устройстве используется значение GUID DXVA2 \_ видеопроксофтваредевице.

## <a name="creating-a-video-processing-device"></a>Создание устройства обработки видео

Перед использованием обработки видео ДКСВА приложение должно создать устройство обработки видео. Ниже приведен краткий обзор шагов, которые более подробно описаны в оставшейся части этого раздела.

1.  Получает указатель на интерфейс [**идиректксвидеопроцессорсервице**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoprocessorservice) .
2.  Создайте описание формата видео для основного видеопотока. Это описание используется для получения списка устройств обработки видео, поддерживающих формат видео. Устройства идентифицируются по идентификатору GUID.
3.  Для конкретного устройства получите список форматов подготовки к просмотру, поддерживаемых устройством. Форматы возвращаются в виде списка значений **D3DFORMAT** . Если вы планируете смешивать подпотоки, получите также список поддерживаемых форматов подпотоков.
4.  Запросите возможности каждого устройства.
5.  Создайте устройство для обработки видео.

Иногда можно опустить некоторые из этих шагов. Например, вместо получения списка форматов для подготовки к просмотру можно просто попытаться создать устройство обработки видео с предпочтительным форматом и проверить успешность его выполнения. Вероятнее всего, общий формат, такой как D3DFMT \_ X8R8G8B8, может быть выполнен.

В оставшейся части этого раздела подробно описаны эти действия.

### <a name="get-the-idirectxvideoprocessorservice-pointer"></a>Получение указателя Идиректксвидеопроцессорсервице

Интерфейс [**идиректксвидеопроцессорсервице**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoprocessorservice) получается с устройства Direct3D. Есть два способа получить указатель на этот интерфейс:

-   С устройства Direct3D.
-   Из [Диспетчер устройств Direct3D](direct3d-device-manager.md).

Если у вас есть указатель на устройство Direct3D, можно получить указатель [**идиректксвидеопроцессорсервице**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoprocessorservice) , вызвав функцию [**DXVA2CreateVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-dxva2createvideoservice) . Передайте указатель на интерфейс **IDirect3DDevice9а** устройства и укажите **IID \_ идиректксвидеопроцессорсервице** для параметра *riid* , как показано в следующем коде:


```C++
    // Create the DXVA-2 Video Processor service.
    hr = DXVA2CreateVideoService(g_pD3DD9, IID_PPV_ARGS(&g_pDXVAVPS));
```



в некоторых случаях один объект создает устройство Direct3D, а затем использует его совместно с другими объектами через [Диспетчер устройств Direct3D](direct3d-device-manager.md). В этом случае можно вызвать [**IDirect3DDeviceManager9:: жетвидеосервице**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) в диспетчере устройств, чтобы получить указатель [**идиректксвидеопроцессорсервице**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoprocessorservice) , как показано в следующем коде:


```C++
HRESULT GetVideoProcessorService(
    IDirect3DDeviceManager9 *pDeviceManager,
    IDirectXVideoProcessorService **ppVPService
    )
{
    *ppVPService = NULL;

    HANDLE hDevice;

    HRESULT hr = pDeviceManager->OpenDeviceHandle(&hDevice);
    if (SUCCEEDED(hr))
    {
        // Get the video processor service 
        HRESULT hr2 = pDeviceManager->GetVideoService(
            hDevice, 
            IID_PPV_ARGS(ppVPService)
            );

        // Close the device handle.
        hr = pDeviceManager->CloseDeviceHandle(hDevice);

        if (FAILED(hr2))
        {
            hr = hr2;
        }
    }

    if (FAILED(hr))
    {
        SafeRelease(ppVPService);
    }

    return hr;
}
```



### <a name="enumerate-the-video-processing-devices"></a>Перечисление устройств обработки видео

Чтобы получить список устройств обработки видео, заполните структуру [**DXVA2 \_ видеодеск**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videodesc) форматом основного видеопотока и передайте эту структуру методу [**идиректксвидеопроцессорсервице:: жетвидеопроцессордевицегуидс**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoprocessorservice-getvideoprocessordeviceguids) . Метод возвращает массив идентификаторов GUID, по одному для каждого устройства обработки видео, которое можно использовать с этим видеоформатом.

Рассмотрим приложение, которое визуализирует видеопоток в формате YUY2, используя определение BT. 709 для цвета YUV с частотой кадров в 29,97 кадров в секунду. Предположим, что видеоматериал состоит только из последовательных кадров. В следующем фрагменте кода показано, как заполнить описание формата и получить идентификаторы GUID устройства:


```C++
    // Initialize the video descriptor.

    g_VideoDesc.SampleWidth                         = VIDEO_MAIN_WIDTH;
    g_VideoDesc.SampleHeight                        = VIDEO_MAIN_HEIGHT;
    g_VideoDesc.SampleFormat.VideoChromaSubsampling = DXVA2_VideoChromaSubsampling_MPEG2;
    g_VideoDesc.SampleFormat.NominalRange           = DXVA2_NominalRange_16_235;
    g_VideoDesc.SampleFormat.VideoTransferMatrix    = EX_COLOR_INFO[g_ExColorInfo][0];
    g_VideoDesc.SampleFormat.VideoLighting          = DXVA2_VideoLighting_dim;
    g_VideoDesc.SampleFormat.VideoPrimaries         = DXVA2_VideoPrimaries_BT709;
    g_VideoDesc.SampleFormat.VideoTransferFunction  = DXVA2_VideoTransFunc_709;
    g_VideoDesc.SampleFormat.SampleFormat           = DXVA2_SampleProgressiveFrame;
    g_VideoDesc.Format                              = VIDEO_MAIN_FORMAT;
    g_VideoDesc.InputSampleFreq.Numerator           = VIDEO_FPS;
    g_VideoDesc.InputSampleFreq.Denominator         = 1;
    g_VideoDesc.OutputFrameFreq.Numerator           = VIDEO_FPS;
    g_VideoDesc.OutputFrameFreq.Denominator         = 1;

    // Query the video processor GUID.

    UINT count;
    GUID* guids = NULL;

    hr = g_pDXVAVPS->GetVideoProcessorDeviceGuids(&g_VideoDesc, &count, &guids);
```



Код для этого примера взят из примера пакета SDK для [DXVA2 \_ видеопрок](dxva2-videoproc-sample.md) .

Массив *пгуидс* в этом примере выделяется методом [**жетвидеопроцессордевицегуидс**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoprocessorservice-getvideoprocessordeviceguids) , поэтому приложение должно освободить массив путем вызова [**CoTaskMemFree**](/windows/win32/api/combaseapi/nf-combaseapi-cotaskmemfree). Оставшиеся действия можно выполнить с помощью любого идентификатора GUID устройства, возвращенного этим методом.

### <a name="enumerate-render-target-formats"></a>Перечислить форматы Render-Target

Чтобы получить список форматов подготовки к просмотру, поддерживаемых устройством, передайте GUID устройства и структуру [**DXVA2 \_ видеодеск**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videodesc) в метод [**идиректксвидеопроцессорсервице:: жетвидеопроцессоррендертаржетс**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoprocessorservice-getvideoprocessorrendertargets) , как показано в следующем коде:


```C++
    // Query the supported render-target formats.

    UINT i, count;
    D3DFORMAT* formats = NULL;

    HRESULT hr = g_pDXVAVPS->GetVideoProcessorRenderTargets(
        guid, &g_VideoDesc, &count, &formats);

    if (FAILED(hr))
    {
        DBGMSG((L"GetVideoProcessorRenderTargets failed: 0x%x.\n", hr));
        return FALSE;
    }

    for (i = 0; i < count; i++)
    {
        if (formats[i] == VIDEO_RENDER_TARGET_FORMAT)
        {
            break;
        }
    }

    CoTaskMemFree(formats);

    if (i >= count)
    {
        DBGMSG((L"The device does not support the render-target format.\n"));
        return FALSE;
    }
```



Метод возвращает массив значений **D3DFORMAT** . В этом примере, где тип входных данных — YUY2, типичным списком форматов может быть D3DFMT \_ X8R8G8B8 (32-bit RGB) и D3DMFT \_ YUY2 (входной формат). Однако точный список будет зависеть от драйвера.

Список доступных форматов для подпотоков может изменяться в зависимости от формата целевого объекта подготовки к просмотру и входного формата. Чтобы получить список форматов подпотоков, передайте GUID устройства, структуру формата и формат целевого объекта в метод [**идиректксвидеопроцессорсервице:: жетвидеопроцессорсубстреамформатс**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoprocessorservice-getvideoprocessorsubstreamformats) , как показано в следующем коде:


```C++
    // Query the supported substream formats.

    formats = NULL;

    hr = g_pDXVAVPS->GetVideoProcessorSubStreamFormats(
        guid, &g_VideoDesc, VIDEO_RENDER_TARGET_FORMAT, &count, &formats);

    if (FAILED(hr))
    {
        DBGMSG((L"GetVideoProcessorSubStreamFormats failed: 0x%x.\n", hr));
        return FALSE;
    }

    for (i = 0; i < count; i++)
    {
        if (formats[i] == VIDEO_SUB_FORMAT)
        {
            break;
        }
    }

    CoTaskMemFree(formats);

    if (i >= count)
    {
        DBGMSG((L"The device does not support the substream format.\n"));
        return FALSE;
    }
```



Этот метод возвращает другой массив значений **D3DFORMAT** . Типичными форматами подпотоков являются АЙУВ и AI44.

### <a name="query-the-device-capabilities"></a>Запрос возможностей устройства

Чтобы получить возможности конкретного устройства, передайте в метод [**идиректксвидеопроцессорсервице:: жетвидеопроцессоркапс**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoprocessorservice-getvideoprocessorcaps) идентификатор GUID устройства, структуру формата и формат целевого объекта подготовки к просмотру. Метод заполняет структуру структуры [**DXVA2 \_ видеопроцессоркапс**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videoprocessorcaps) с помощью возможностей устройства.


```C++
    // Query video processor capabilities.

    hr = g_pDXVAVPS->GetVideoProcessorCaps(
        guid, &g_VideoDesc, VIDEO_RENDER_TARGET_FORMAT, &g_VPCaps);

    if (FAILED(hr))
    {
        DBGMSG((L"GetVideoProcessorCaps failed: 0x%x.\n", hr));
        return FALSE;
    }
```



### <a name="create-the-device"></a>Создание устройства

Чтобы создать устройство обработки видео, вызовите метод [**идиректксвидеопроцессорсервице:: креатевидеопроцессор**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoprocessorservice-createvideoprocessor). Входными данными для этого метода являются GUID устройства, описание формата, формат целевого объекта подготовки и максимальное количество вложенных потоков, которые планируется смешивать. Метод возвращает указатель на интерфейс [**идиректксвидеопроцессор**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoprocessor) , который представляет устройство обработки видео.


```C++
    // Finally create a video processor device.

    hr = g_pDXVAVPS->CreateVideoProcessor(
        guid,
        &g_VideoDesc,
        VIDEO_RENDER_TARGET_FORMAT,
        SUB_STREAM_COUNT,
        &g_pDXVAVPD
        );
```



## <a name="video-process-blit"></a>Видеопроцесс Блит

Основная операция обработки видео — это *Блит обработки видео*. ( *Блит* — это любая операция, объединяющая два или более точечных рисунка в одно растровое изображение. Блит обработка видео сочетает входные рисунки для создания выходного кадра.) Чтобы выполнить Блит обработки видео, вызовите [**идиректксвидеопроцессор:: видеопроцессблт**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoprocessor-videoprocessblt). Этот метод передает набор видеороликов на устройство обработки видео. В ответ устройство обработки видео обрабатывает входные изображения и создает один выходной кадр. Обработка может включать в себя дечередование, преобразование цветового пространства и смешивание подпотоков. Выходные данные записываются на конечную поверхность, предоставленную вызывающей стороной.

Метод [**видеопроцессблт**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoprocessor-videoprocessblt) принимает следующие параметры:

-   *pRT* указывает на поверхность целевого объекта отрисовки **IDirect3DSurface9** , которая будет принимать обработанный кадр видео.
-   *пблтпарамс* указывает на структуру [**DXVA2 \_ видеопроцессблтпарамс**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videoprocessbltparams) , которая задает параметры для Блит.
-   *псамплес* — это адрес массива структур [**DXVA2 \_ видеосампле**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videosample) . Эти структуры содержат входные образцы для Блит.
-   *Нумсамплес* задает размер массива *псамплес* .
-   *Зарезервированный* параметр зарезервирован и должен иметь **значение NULL**.

В массиве *псамплес* вызывающий объект должен предоставить следующие входные примеры:

-   Текущее изображение из основного видеопотока.
-   Ссылки на рисунки вперед и назад, если это требуется для алгоритма дечередования.
-   Ноль или больше изображений подпотока, не более 15 подпотоков.

Драйверу требуется, чтобы этот массив наследовался в определенном порядке, как описано в статье [Порядок входных образцов](#input-sample-order).

### <a name="blit-parameters"></a>Параметры Блит

Структура [**DXVA2 \_ видеопроцессблтпарамс**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videoprocessbltparams) содержит общие параметры для Блит. Наиболее важные параметры хранятся в следующих членах структуры:

-   **Таржетфраме** — время презентации выходного кадра. Для последовательного содержимого это время должно совпадать с временем начала текущего кадра из основного видеопотока. Это время указано в примере **Start** элемента структуры [**DXVA2 \_ видеосампле**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videosample) для этого входного примера.

    Для содержимого с чередованием рамка с двумя полями с чередованием создает два выходных кадра с чередованием. В первом выходном кадре время презентации должно совпадать с временем начала текущего изображения в основном видеопотоке, как и в прогрессивном содержимом. Во втором выходном кадре время начала должно равняться средней точке между временем начала текущего изображения в основном видеопотоке и временем начала следующего изображения в потоке. Например, если входное видео содержит 25 кадров в секунду (50 полей в секунду), выходные кадры будут иметь отметки времени, показанные в следующей таблице. Метки времени отображаются в единицах 100 наносекунд.

    

    | Рисунок входных данных | **Таржетфраме** (1) | **Таржетфраме** (2) |
    |---------------|---------------------|---------------------|
    | 0             | 0                   | 200 000              |
    | 400000        | 0                   | 600 000              |
    | 800000        | 800000              | 1000000             |
    | 1200000       | 1200000             | 1400000             |

    

     

    Если чередование содержимого состоит из одиночных полей, а не полей с чередованием, то время вывода всегда совпадает со временем ввода, как в случае с прогрессивным содержимым.

-   **Таржетрект** определяет прямоугольную область в области назначения. Блит будет записывать выходные данные в этот регион. В частности, каждый пиксель в **таржетрект** будет изменен, и никакие Пиксели за пределами **таржетрект** будут изменены. Целевой прямоугольник определяет ограничивающий прямоугольник для всех входных потоков видео. Размещение отдельных потоков внутри этого прямоугольника осуществляется с помощью параметра *Псамплес* [**Идиректксвидеопроцессор:: видеопроцессблт**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoprocessor-videoprocessblt).
-   **BackgroundColor** задает цвет фона везде, где не отображается изображение видео. Например, когда изображение видео размером 16 x 9 отображается в области 4 x 3 (пустых), области леттербоксед отображаются с цветом фона. Цвет фона применяется только в пределах целевого прямоугольника (**таржетрект**). Все пиксели за пределами **таржетрект** не изменяются.
-   **Дестформат** описывает цветовое пространство для выходного видео, например, используется ли цвет ITU-R BT. 709 или BT. 601. Эти сведения могут повлиять на отображение изображения. Дополнительные сведения см. в разделе [Расширенные сведения о цвете](extended-color-information.md).

Другие параметры описаны на справочной странице структуры [**DXVA2 \_ видеопроцессблтпарамс**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videoprocessbltparams) .

### <a name="input-samples"></a>Примеры входных данных

Параметр *псамплес* объекта [**Идиректксвидеопроцессор:: видеопроцессблт**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoprocessor-videoprocessblt) указывает на массив структур [**DXVA2 \_ видеосампле**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videosample) . Каждая из этих структур содержит сведения о одном входном образце и указателе на поверхность Direct3D, содержащую пример. Каждый пример является одним из следующих:

-   Текущее изображение из основного потока.
-   Изображение прямой или обратной ссылки из основного потока, используемое для дечередования.
-   Изображение подпотока.

Точный порядок, в котором образцы должны отображаться в массиве, описывается далее в разделе [Порядок входных примеров](#input-sample-order).

Можно предоставить до 15 графических подпотоков, хотя большинству приложений для видео требуется только один подпоток. Число подпотоков может изменяться при каждом вызове [**видеопроцессблт**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoprocessor-videoprocessblt). Изображения из подпотока обозначаются установкой элемента **самплеформат. самплеформат** структуры [**DXVA2 \_ видеосампле**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videosample) равным DXVA2 \_ самплесубстреам. Для основного видеопотока этот член описывает чересстрочную развертку входного видео. Дополнительные сведения см. в разделе [**DXVA2 \_ самплеформат**](/windows/desktop/api/dxva2api/ne-dxva2api-dxva2_sampleformat) Enumeration.

Для основного видеопотока **начальный** и **конечный** элементы структуры [**DXVA2 \_ видеосампле**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videosample) дают время начала и окончания входного примера. Для изображений подпотока установите эти значения равными нулю, так как время презентации всегда вычисляется из основного потока. Приложение отвечает за отслеживание, когда необходимо представить все изображение подпотока и отправить его в [**видеопроцессблт**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoprocessor-videoprocessblt) в нужное время.

Два прямоугольника определяют, как будет располагаться исходное видео для каждого потока:

-   Элемент **SrcRect** структуры [**DXVA2 \_ видеосампле**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videosample) указывает *Исходный прямоугольник*, прямоугольную область исходного изображения, которая будет отображаться в составном кадре выходных данных. Чтобы обрезать изображение, присвойте этому свойству значение меньше размера кадра. В противном случае задайте значение, равное размеру кадра.
-   Элемент **DstRect** той же структуры задает *прямоугольник назначения*, прямоугольную область назначения, в которой будет отображаться кадр видео.

Драйвер блитс Пиксели из исходного прямоугольника в прямоугольник назначения. Два прямоугольника могут иметь разные размеры или пропорции. драйвер будет масштабировать образ по мере необходимости. Более того, каждый входной поток может использовать другой коэффициент масштабирования. По сути, масштабирование может потребоваться для получения правильных пропорций в выходном кадре. Драйвер не принимает пропорции пикселя источника в учетную запись, поэтому если в исходном изображении используются неквадратные Пиксели, то приложение может вычислить правильный конечный прямоугольник.

Предпочтительные форматы подпотока — АЙУВ и AI44. Последний — это формат с использованием формата в виде палет с 16 цветами. Записи палитры задаются в элементе **PAL** структуры [**DXVA2 \_ видеосампле**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videosample) . (Если исходный видеоформат изначально выражается как тип носителя Media Foundation, записи палитры хранятся в атрибуте [**Palette- \_ \_ Палитра MF**](mf-mt-palette-attribute.md) .) Для форматов, не являющихся палетами, очистите этот массив до нуля.

## <a name="image-composition"></a>Композиция изображений

Каждая операция Блит определяется следующими тремя прямоугольниками:

-   *Целевой* прямоугольник (**таржетрект**) определяет область в области назначения, в которой будут отображаться выходные данные. Выходное изображение обрезается по этому прямоугольнику.
-   Прямоугольник *назначения* для каждого потока (**DstRect**) определяет, где находится входной поток в составном изображении.
-   *Исходный* прямоугольник для каждого потока (**SrcRect**) определяет, какая часть исходного изображения отображается.

Целевой и конечный прямоугольники указываются относительно поверхности назначения. Исходный прямоугольник указывается относительно исходного изображения. Все прямоугольники указываются в пикселях.

![Схема, показывающая исходный, конечный и целевой прямоугольники](images/dxva-vp-rects.gif)

Устройство обработки видео Alpha смешивает входные изображения, используя любой из следующих источников альфа-данных:

-   Альфа-данные для каждого пикселя из подпотоков.
-   Плоское альфа-значение для каждого видеопотока, указанное в элементе **планаралфа** структуры [**DXVA2 \_ видеосампле**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videosample) .
-   Плоское альфа-значение составного изображения, заданное в **альфа** -элементе структуры [**DXVA2 \_ видеопроцессблтпарамс**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videoprocessbltparams) . Это значение используется для смешения всего составного изображения с цветом фона.

В этом разделе приводится ряд примеров, демонстрирующих, как устройство обработки видео создает выходное изображение.

### <a name="example-1-letterboxing"></a>Пример 1. пустых

В этом примере показано, как леттербокс исходный образ, настроив прямоугольник назначения так, чтобы он был меньше целевого прямоугольника. Основным видеопотоком в этом примере является изображение 720 × 480, которое должно отображаться с пропорциями 16:9. Конечная поверхность — 640 × 480 пикселей (пропорции 4:3). Для достижения правильного соотношения сторон конечный прямоугольник должен быть 640 × 360. Для простоты в этом примере не содержится подпоток. На следующей диаграмме показаны исходные и конечные прямоугольники.

![Схема, показывающая пустых.](images/428105fa-a26b-48a6-991d-44d24ab786b1.gif)

На предыдущей схеме показаны следующие прямоугольники:

-   Целевой прямоугольник: {0, 0, 640, 480}
-   Основное видео:

    -   Исходный прямоугольник: {0, 0, 720, 480}
    -   Конечный прямоугольник: {0, 60, 640, 420}

Драйвер будет разбить видео, сжать его до 640 × 360 и Блит кадр в прямоугольник назначения. Целевой прямоугольник больше, чем прямоугольник назначения, поэтому драйвер будет использовать цвет фона для заполнения горизонтальных полос выше и ниже рамки. Цвет фона задается в структуре [**DXVA2 \_ видеопроцессблтпарамс**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videoprocessbltparams) .

### <a name="example-2-stretching-substream-images"></a>Пример 2. изображения подпотока растяжения

Изображения в подпотоке могут дополняться за пределами основного видеоизображения. Например, в видео DVD-коде основной видеопоток может иметь пропорции 4:3, в то время как подпоток равен 16:9. В этом примере оба видеопотока имеют одинаковые исходные размеры (720 × 480), но этот подпоток должен отображаться с пропорциями 16:9. Для достижения этого пропорций изображение подпотока растягивается по горизонтали. Исходный и конечный прямоугольники показаны на следующей схеме.

![Диаграмма, демонстрирующая растяжение изображения подпотока.](images/7ab31c65-06b9-4843-90b8-2f9fb6f6b20e.gif)

На предыдущей схеме показаны следующие прямоугольники:

-   Целевой прямоугольник: {0, 0, 854, 480}
-   Основное видео:

    -   Исходный прямоугольник: {0, 0, 720, 480}
    -   Конечный прямоугольник: {0, 107, 474, 480}

-   Поддержка
    -   Исходный прямоугольник: {0, 0, 720, 480}
    -   Прямоугольник назначения: {0, 0, 854, 480}

Эти значения сохраняют высоту изображения и горизонтальное масштабирование обоих изображений. В регионах, где отображаются оба изображения, они являются альфа-смешением. Где изображение подпотока ексендс за пределами видео ограничения primay, этот подпоток смешивается с цветом фона. Это альфа-смешение учетных записей для измененных цветов в правой части диаграммы.

### <a name="example-3-mismatched-stream-heights"></a>Пример 3. несоответствие высоты потока

В предыдущем примере подпоток и первичный поток имеют одинаковую высоту. Потоки также могут иметь несовпадающие значения высоты, как показано в этом примере. Области в целевом прямоугольнике, где не отображается видео, отображаются с использованием цвета фона — черным в этом примере. Исходный и конечный прямоугольники показаны на следующей схеме.

![на схеме показаны несоответствующие значения высоты потока](images/0190a15a-d971-450f-90ed-ce5633e1069c.gif)

На предыдущей схеме показаны следующие прямоугольники:

-   Целевой прямоугольник: {0, 0, 150, 85}
-   Основное видео:
    -   Исходный прямоугольник: {0, 0, 150, 50}
    -   Конечный прямоугольник: {0, 17, 150, 67}
-   Поддержка
    -   Исходный прямоугольник: {0, 0, 100, 85}
    -   Прямоугольник назначения: {25, 0, 125, 85}

### <a name="example-4-target-rectangle-smaller-than-destination-surface"></a>Пример 4. целевой прямоугольник меньше поверхности назначения

В этом примере показан случай, когда целевой прямоугольник меньше поверхности назначения.

![Схема, показывающая Блит в прямоугольник назначения.](images/360a85a3-333c-4b32-b8f7-1beb1e805921.gif)

На предыдущей схеме показаны следующие прямоугольники:

-   Конечная поверхность: {0, 0, 300, 200}
-   Целевой прямоугольник: {0, 0, 150, 85}
-   Основное видео:
    -   Исходный прямоугольник: {0, 0, 150, 50}
    -   Конечный прямоугольник: {0, 17, 150, 67}
-   Поддержка
    -   Исходный прямоугольник: {0, 0, 100, 85}
    -   Прямоугольник назначения: {25, 0, 125, 85}

Пиксели за пределами целевого прямоугольника не изменяются, поэтому цвет фона отображается только в пределах целевого прямоугольника. Пунктирная область указывает части поверхности назначения, которые не затрагиваются Блит.

### <a name="example-5-source-rectangles"></a>Пример 5. исходные прямоугольники

Если указать исходный прямоугольник, который меньше исходного изображения, драйвер будет Блит только эту часть изображения. В этом примере исходные прямоугольники задают нижнюю правую четвертую квадрант основного видеопотока и нижнюю левую четвертую квадрант подпотока (на схеме отображаются метки хэша). Прямоугольники назначения имеют те же размеры, что и исходные прямоугольники, поэтому видео не растягивается. Исходный и конечный прямоугольники показаны на следующей схеме.

![Схема, показывающая Блит из двух исходных прямоугольников.](images/b1de4cc3-0155-40be-acac-b486e2af8c0d.gif)

На предыдущей схеме показаны следующие прямоугольники:

-   Целевой прямоугольник: {0, 0, 720, 576}
-   Основное видео:
    -   Размер исходной поверхности: {0, 0, 720, 480}
    -   Исходный прямоугольник: {360, 240, 720, 480}
    -   Прямоугольник назначения: {0, 0, 360, 240}
-   Поддержка
    -   Размер исходной поверхности: {0, 0, 640, 576}
    -   Исходный прямоугольник: {0, 288, 320, 576}
    -   Прямоугольник назначения: {400, 0, 720, 288}

### <a name="example-6-intersecting-destination-rectangles"></a>Пример 6. пересечение прямоугольников назначения

Этот пример аналогичен предыдущему, но прямоугольники назначения пересекаются. Размеры поверхности те же, что и в предыдущем примере, но исходный и конечный прямоугольники — нет. Опять же, видео обрезается, но не растягивается. Исходный и конечный прямоугольники показаны на следующей схеме.

![Диаграмма, показывающая пересекающиеся прямоугольники назначения.](images/fbe450cb-c84d-4110-9515-00f27601528e.gif)

На предыдущей схеме показаны следующие прямоугольники:

-   Целевой прямоугольник: {0, 0, 720, 576}
-   Основное видео:
    -   Размер исходной поверхности: {0, 0, 720, 480}
    -   Исходный прямоугольник: {260, 92, 720, 480}
    -   Прямоугольник назначения: {0, 0, 460, 388}
-   Поддержка
    -   Размер исходной поверхности: {0, 0, 640, 576}
    -   Исходный прямоугольник: {0, 0, 460, 388}
    -   Прямоугольник назначения: {260, 188, 720, 576}

### <a name="example-7-stretching-and-cropping-video"></a>Пример 7. растяжение и обрезка видео

В этом примере видео растягивается и обрезается. Регион размером 180 × 120 из каждого потока растягивается для покрытия области 360 x 240 в прямоугольнике назначения.

![Диаграмма, демонстрирующая растяжение и обрезку.](images/ce83529c-8545-492c-9d3e-ef221c30e326.gif)

На предыдущей схеме показаны следующие прямоугольники:

-   Целевой прямоугольник: {0, 0, 720, 480}
-   Основное видео:
    -   Размер исходной поверхности: {0, 0, 360, 240}
    -   Исходный прямоугольник: {180, 120, 360, 240}
    -   Прямоугольник назначения: {0, 0, 360, 240}
-   Поддержка
    -   Размер исходной поверхности: {0, 0, 360, 240}
    -   Исходный прямоугольник: {0, 0, 180, 120}
    -   Прямоугольник назначения: {360, 240, 720, 480}

## <a name="input-sample-order"></a>Порядок входных образцов

Параметр *псамплес* метода [**видеопроцессблт**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoprocessor-videoprocessblt) является указателем на массив входных примеров. Сначала появятся примеры из основного видеопотока, а затем — изображения подпотока в Z-порядке. Образцы должны быть помещены в массив в следующем порядке:

-   Примеры для основного видеопотока отображаются первыми в массиве в временном порядке. В зависимости от режима чередования драйверу может потребоваться один или несколько эталонных образцов из основного видеопотока. Члены **нумфорвардрефсамплес** и **Нумбакквардрефсамплес** в структуре [**DXVA2 \_ видеопроцессоркапс**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videoprocessorcaps) определяют, сколько необходимо выборок на прямой и обратной ссылке. Вызывающий объект должен предоставить эти образцы, даже если содержимое видео является прогрессивным и не требует дечередования. (Это может произойти, если к неограниченному устройству присвоено последовательное кадровое значение, например, если источник содержит сочетание кадров с чередованием и постепенной развертки.)
-   После образцов для основного видеопотока массив может содержать до 15 примеров вложенных потоков, упорядоченных в Z-порядке, снизу вверх. Подпотоки всегда прогрессивны и не нуждаются в справочных рисунках.

В любое время основной видеопоток может переключаться между чередованием и последовательным содержимым, а также может меняться число подпотоков.

Элемент **самплеформат. самплеформат** в структуре [**DXVA2 \_ видеосампле**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videosample) указывает тип изображения. Для изображений подпотока задайте для этого параметра значение DXVA2 \_ самплесубстреам. Для последовательного изображения это значение равно DXVA2 \_ самплепрогрессивефраме. Для изображений с чередованием значение зависит от макета поля.

Если драйвер требует использования образцов прямого и обратного ссылок, то в начале видеопоследовательности может быть недоступно полное количество выборок. В этом случае включите в массив *псамплес* записи, но пометьте недостающие примеры как имеющие тип DXVA2 \_ самплеункновн.

**Начальное** и **Конечное** элементы структуры [**DXVA2 \_ видеосампле**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videosample) предоставляют временное расположение каждого примера. Эти значения используются только для выборки из основного видеопотока. Для изображений подпотока задайте для обоих элементов нулевое значение.

Следующие примеры могут помочь прояснить эти требования.

### <a name="example-1"></a>Пример 1

Простейший случай возникает, когда нет подпотоков, а алгоритму разчередования не требуются эталонные образцы (**нумфорвардрефсамплес** и **нумбакквардрефсамплес** равны нулю). Примером такого алгоритма является дечередование Боба. В этом случае массив *псамплес* должен содержать одну поверхность ввода, как показано в следующей таблице.



| Индекс           | Тип поверхности        | Временное расположение |
|-----------------|---------------------|-------------------|
| *псамплес* \[ 0,0\] | Изображение с чередованием. | *T*               |



 

Значение времени *T* считается временем начала текущего кадра видео.

### <a name="example-2"></a>Пример 2

В этом примере приложение смешивает два подпотока с основным потоком. Для алгоритма дечередования не требуются эталонные образцы. В следующей таблице показано, как эти образцы упорядочены в массиве *псамплес* .



| Индекс           | Тип поверхности       | Временное расположение | Z-порядок |
|-----------------|--------------------|-------------------|---------|
| *псамплес* \[ 0,0\] | Изображение с чередованием | *T*               | 0       |
| *псамплес* \[ одного\] | Поддержка          | 0                 | 1       |
| *псамплес* \[ открыт\] | Поддержка          | 0                 | 2       |



 

### <a name="example-3"></a>Пример 3

Теперь предположим, что для алгоритма дечередования требуется один пример обратной ссылки и один пример прямой ссылки. Кроме того, предоставляется два подпотока изображений для всего пяти поверхностей. В следующей таблице показано правильное упорядочение.



| Индекс           | Тип поверхности                   | Временное расположение | Z-порядок        |
|-----------------|--------------------------------|-------------------|----------------|
| *псамплес* \[ 0,0\] | Изображение с чередованием (ссылка) | *T* − 1            | Неприменимо |
| *псамплес* \[ одного\] | Изображение с чередованием             | *T*               | 0              |
| *псамплес* \[ открыт\] | Изображение с чередованием (ссылка) | *T* + 1            | Неприменимо |
| *псамплес* \[ 3-5\] | Поддержка                      | 0                 | 1              |
| *псамплес* \[ четырех\] | Поддержка                      | 0                 | 2              |



 

Время *T* − 1 — это время начала кадра, предшествующее текущему кадру, а *t* + 1 — время начала следующего кадра.

Если поток видео переключается на прогрессивное содержимое, используя тот же режим чередования, приложение должно предоставить такое же количество выборок, как показано в следующей таблице.



| Индекс           | Тип поверхности                    | Временное расположение | Z-порядок        |
|-----------------|---------------------------------|-------------------|----------------|
| *псамплес* \[ 0,0\] | Прогрессивное изображение (ссылка) | *T* − 1            | Неприменимо |
| *псамплес* \[ одного\] | Последовательное изображение             | *T*               | 0              |
| *псамплес* \[ открыт\] | Прогрессивное изображение (ссылка) | *T* + 1            | Неприменимо |
| *псамплес* \[ 3-5\] | Поддержка                       | 0                 | 1              |
| *псамплес* \[ четырех\] | Поддержка                       | 0                 | 2              |



 

### <a name="example-4"></a>Пример 4

В начале последовательности видео образцы ссылок могут быть недоступны. В этом случае записи для отсутствующих примеров включаются в массив *псамплес* с типом Sample DXVA2 \_ самплеункновн.

При условии, что для режима разследовательной развертки требуется один и тот же пример обратной ссылки, первые три вызова [**видеопроцессблт**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoprocessor-videoprocessblt) будут иметь последовательности входных данных, показанные в следующих трех таблицах.



| Индекс           | Тип поверхности                   | Временное расположение |
|-----------------|--------------------------------|-------------------|
| *псамплес* \[ 0,0\] | Неизвестно                        | 0                 |
| *псамплес* \[ одного\] | Неизвестно                        | 0                 |
| *псамплес* \[ открыт\] | Изображение с чередованием (ссылка) | *T* + 1            |



 



| Индекс           | Тип поверхности                   | Временное расположение |
|-----------------|--------------------------------|-------------------|
| *псамплес* \[ 0,0\] | Неизвестно                        | 0                 |
| *псамплес* \[ одного\] | Изображение с чередованием             | *T*               |
| *псамплес* \[ открыт\] | Изображение с чередованием (ссылка) | *T* + 1            |



 



| Индекс           | Тип поверхности                   | Временное расположение |
|-----------------|--------------------------------|-------------------|
| *псамплес* \[ 0,0\] | Изображение с чередованием             | *T* − 1            |
| *псамплес* \[ одного\] | Изображение с чередованием             | *T*               |
| *псамплес* \[ открыт\] | Изображение с чередованием (ссылка) | *T* + 1            |



 

## <a name="related-topics"></a>См. также

<dl> <dt>

[Ускорение видео DirectX 2,0](directx-video-acceleration-2-0.md)
</dt> <dt>

[\_Пример ВИДЕОПРОК DXVA2](dxva2-videoproc-sample.md)
</dt> </dl>

 

 
