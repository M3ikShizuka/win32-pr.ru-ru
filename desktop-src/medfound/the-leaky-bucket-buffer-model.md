---
description: '&\# 0034;&\# 0034; Model — это способ моделирования требований к буферизации для плавного воспроизведения.'
ms.assetid: 2f7f80d6-3abb-462f-a571-b223a1d59da6
title: Модель буфера для контейнера утечки (Microsoft Media Foundation)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0f5a99932fb121808f6a49323360c47c09d0acbb
ms.sourcegitcommit: de72a1294df274b0a71dc0fdc42d757e5f6df0f3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "105713319"
---
# <a name="the-leaky-bucket-buffer-model-microsoft-media-foundation"></a>Модель буфера для контейнера утечки (Microsoft Media Foundation)

При потоковой передаче мультимедиа по сети декодер получает закодированные данные через теоретическую постоянную частоту (скорость передачи данных). Декодер использует эти данные для создания раскодированных выходных данных. Однако в общем случае декодер использует данные с *переменной* частотой, поскольку кодировщик может использовать переменную скорость кодирования.

Модель "сегмент утечки" — это способ моделирования требований к буферизации для плавного воспроизведения. В этой модели декодер поддерживает буфер. Закодированные данные переходят из сети в буфер и из буфера в декодер. Если буфер недостаточен, это означает, что декодер удаляет данные из буфера быстрее, чем доставляется сеть. Если буфер переполнен, это означает, что сеть доставляет данные быстрее, чем используется декодером.

В этом разделе описывается модель "сегмент утечки" буферов для кодирования и декодирования.

-   [Сегмент утечки](#the-leaky-bucket)
-   [Используемый контейнер](#the-bucket-in-use)
-   [Настройка значений сегментов с утечкой для потоков ASF](#setting-leaky-bucket-values-for-asf-streams)
-   [Значения сегментов с утечкой в мультиплексоре ASF](#leaky-bucket-values-in-the-asf-multiplexer)
-   [Обновление значений сегментов с утечкой в приемнике мультимедиа ASF](#updating-leaky-bucket-values-in-the-asf-media-sink)
-   [См. также](#related-topics)

## <a name="the-leaky-bucket"></a>Сегмент утечки

Чтобы разобраться в модели контейнеров с утечками, рассмотрим контейнер с небольшим отверстием в нижней части. Контейнер определяется тремя параметрами:

-   Емкость (B)
-   Скорость, с которой вода выходит из сегмента (R)
-   Начальная заполненность контейнера (F)

В этой метафоре контейнер является буфером:

![Иллюстрация, показывающая буфер в качестве контейнера, скорость ввода как вода, поступающего в сегмент, и скорость вывода в виде воды, проходящего через отверстие в контейнере](images/asf-components03.png)

Если вода перемещается в контейнер с точностью *R*, контейнер останется в F, так как скорость ввода равна выходной ставке. Если скорость ввода увеличивается, а *R* остается постоянным, контейнер накапливает воду. Если скорость ввода превышает *R* в течение длительного периода, в конечном итоге происходит перенаправление контейнеров. Однако скорость ввода может различаться для *R* без перетекания контейнера, при условии, что средняя скорость ввода не превышает емкость контейнера. Чем больше емкость, тем больше скорость ввода может варьироваться в пределах заданного окна времени.

В формате ASF контейнер утечки определяется тремя параметрами:

-   Средняя скорость потока в байтах в секунду, соответствующая скорости вывода (*R*)
-   Окно буфера, измеряемое в миллисекундах, соответствующее емкости контейнера (*B*).
-   Заполнение первоначального буфера, обычно равное нулю.

Скорость потока измеряет среднее число бит в секунду в закодированном потоке. В окне буфера измеряется время в миллисекундах, которое может вместить данные в буфер. Размер буфера в битах равен R \* (B/1000).

Полезные данные ASF могут ошибочно входить в сегмент утечки и в непостоянном объеме, но должны выходить из контейнера на постоянную положительную скорость. Из-за окна буфера возможны задержки между моментом, когда полезные данные попадают в контейнер и когда он остается. Максимальная задержка, которая может произойти, — *B* / *R*. Полезные данные, которые вводятся в контейнер, зависят от времени презентации и никогда не должны переполнить контейнер. Помимо времени презентации, каждая полезная нагрузка также имеет время отправки — время, когда полезные данные покидает контейнер в соответствии с скоростью. Время отправки должно быть раньше времени презентации, чтобы гарантировать, что когда поврежденный контейнер становится полным, все полезные данные остаются в контейнере до или во время презентации. Для этого время презентации смещается вперед на значение *B* / *R* (Предварительная), а время отправки начинается с нуля. Время отправки должно быть не позже времени презентации, так как это указывает на то, что полезные данные, которые были введены в контейнер слишком поздно и не могут быть добавлены в объект данных. Значение предрулона включено в [объект заголовка ASF](asf-file-structure.md) .

Для потоковой передачи без сбоев по сети, сжатые потоки в содержимом носителя должны поддерживать постоянную скорость потока в течение всего времени воспроизведения. Модель "утечка данных" в формате ASF гарантирует, что данные мультимедиа передаются по сети с постоянной скоростью. Параметры сегмента утечки указываются в объекте свойств расширенного потока [объекта заголовка ASF](asf-file-structure.md). В Microsoft Media Foundation они задаются в качестве атрибутов типа носителя, представляющего поток.

Значения сегментов с утечкой определяются как в приемнике файлов ASF, так и в базовом объекте мультиплексора ASF, а также в кодировщике Windows Media. Эти значения могут быть одинаковыми или разными. Например, рассмотрим сценарий потоковой передачи, который требует, чтобы образцы звука были доставлены позже, чем образцы видео, чтобы файл можно было передавать без задержки. Для этого в приемнике носителя может быть задано значение, превышающее значение, заданное в кодировщике Windows Media Audio.

Чтобы задать значения B/R в кодировщике, приложение должно задать свойства [**мфпкэй \_ равг**](mfpkey-ravgproperty.md), [**мфпкэй \_ Бавг**](mfpkey-bavgproperty.md), [**мфпкэй \_ рмакс**](mfpkey-rmaxproperty.md)и [**мфпкэй \_ бмакс**](mfpkey-bmaxproperty.md) . Дополнительные сведения о настройке свойств в кодировщике см. в разделе [Свойства кодировки](configuring-the-encoder.md).

## <a name="the-bucket-in-use"></a>Используемый контейнер

Целью кодировщика является обеспечение того, что содержимое никогда не переполняет буфер. Кодировщик использует скорость потока и значения окна буфера в качестве направляющих. Фактическое число бит, передаваемых за любой период времени, равное окну буфера, никогда не может превышать размер буфера в два раза больше.

Рассмотрим следующий пример: у вас есть 3-галлонный контейнер с отверстием, с помощью которого 1 галлон может поступать в минуту. Вы поместили контейнер в спигот и откроете клапан, чтобы предоставить вода с частотой 1 галлона в минуту. Вода переносится из контейнера так быстро, как это происходит, и не приводит к появлению лишних элементов в контейнере. Затем вы увеличиваете число потоков с спигот до 2 галлонов в минуту. Каждую минуту, на которую направляется вода, две галлона попадают в сегмент и 1 утечек галлонов, в сегменте остается 1 галлон. По истечении 3 минут в сегмент попадают шесть галлонов, 3 галлоны были потеряны, а контейнер полон.

На практике теоретическая максимальная скорость передачи данных через интервал, равную окну буфера, никогда не достигается. В предыдущем примере предполагается постоянная скорость передачи данных. Учитывая один и тот же 3-галлонный сегмент, можно увеличить частоту потока от спигот до 6 галлонов в минуту в течение одной минуты, а затем отключить спигот в течение двух минут. Несмотря на то, что общий объем воды, помещаемых в сегмент, находится в пределах теоретического максимума окна буфера, концентрация этого числа в одной части окна приводит к переполнению контейнера. В 6 галлонов в минуту, 3-галлонный контейнер переполняется вскоре за 30 секунд. Таким образом, фактический максимальный объем данных, которые могут быть доставлены в буфер, в течение любого интервала, равного параметру окна буфера, зависит от размера отдельных выборок и времени доставки.

До сих пор в примерах рассматривался только буфер, используемый декодером, но буфер контейнеров с утечкой также используется кодировщиком, который создает сжатое содержимое. Кодировщик выполняет любые корректировки, необходимые для алгоритмов сжатия, чтобы хранить скорость сжатых образцов в пределах границ, описанных в разделе скорость потока и окно буфера, предполагая, что образцы будут доставляться в декодер с постоянной скоростью. Контейнер кодировщика можно представить как зеркальное отображение контейнера декодера. Контейнер кодировщика заполняется по переменной частоте, определяемой размером отдельных выборок и утечек с постоянной скоростью, равной среднему значению скорости.

Рассмотрим следующий пример кодировщика и декодера, Соединенных по сети. Файл видео кодируется в 30 кадров в секунду со скоростью в 6 000 бит/с и окном буфера 3 секунды (общий размер буфера составляет 18 000 бит). Первый пример кодируется как ключевой кадр и занимает 7 000 бит. Буфер кодировщика теперь содержит 7 000 бит. Следующие 29 кадров — это все разностные кадры общего числа 3 000 бит. Таким образом, первая секунда содержимого (30 кадров) поместит заполнение буфера в 10 000 бит, если утечка не выполнялась. Мы понимаем, что скорость потока в потоке составляет 6 000 бит в секунду, поэтому после того, как первая секунда закодированного содержимого помещается в буфер кодировщика, заполнение сбрасывается на 4 000 бит. В приложении декодирования этот поток доставляется в буфер декодера с частотой 6 000 бит/сек. Через одну секунду буфер содержит 6 000 бит. Первый пример содержит 7 000 бит, поэтому буфер декодера должен быть заполнен более, прежде чем декодер начнет удалять образцы.

## <a name="setting-leaky-bucket-values-for-asf-streams"></a>Настройка значений сегментов с утечкой для потоков ASF

В сценарии кодирования файлов приложение может задать значения сегментов утечки при настройке потоков в [профиле ASF](asf-profile.md).

После создания потока и ссылки на интерфейс [**имфасфстреамконфиг**](/windows/desktop/api/wmcontainer/nn-wmcontainer-imfasfstreamconfig) потока можно задать значения с помощью следующих атрибутов:

-   [**MF \_ АСФСТРЕАМКОНФИГ \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) (средние значения сегментов с утечкой)
-   [**MF \_ АСФСТРЕАМКОНФИГ \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) (максимальное значение в контейнере с утечкой)

Дополнительные сведения о добавлении потоков и получении указателя **имфасфстреамконфиг** см. в разделе [Добавление потоковых данных в приемник файлов ASF](adding-stream-information-to-the-asf-file-sink.md).

Эти значения содержат следующий набор данных:

-   Средняя скорость потока: Возвращает среднюю скорость потока из типа выходного носителя, выбранного во время согласования типа носителя. Используйте атрибут [**" \_ \_ \_ средний байт в \_ \_ \_ секунду**](mf-mt-audio-avg-bytes-per-second-attribute.md) " (для звуковых потоков) или атрибут " [**\_ \_ Средняя \_ скорость MF MT**](mf-mt-avg-bitrate-attribute.md) " (для видеопотоков).
-   Окно буфера. Если у вас есть экземпляр кодировщика с согласованными выходными типами носителей, это значение можно обновить позже, запросив кодировщик для интерфейса [**ивмкодеклеакибуккет**](/windows/desktop/api/wmcodecdsp/nn-wmcodecdsp-iwmcodecleakybucket) и затем вызвав [**Ивмкодеклеакибуккет:: жетбуфферсизебитс**](../wmformat/iwmcodecleakybucket-getbuffersizebits.md) (вмкодеЦифацес. h, вмкодекдспууид. lib). В противном случае используйте значение по умолчанию 3000 миллисекунд.
-   Начальный размер буфера: значение 0.

Значения, предоставляемые приложением, зависят от типа кодировки и типа носителя потока. Например, для [кодирования постоянной скорости потока](constant-bit-rate-encoding.md) требуется предварительно определенная фиксированная скорость потока и окно буфера. Приложение может указать эти значения сегментов утечки, задав свойство Encoding [**мфпкэй \_ видеовиндов**](mfpkey-videowindowproperty.md) и атрибут [**MF \_ асфстреамконфиг \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) в потоке. Указанные значения окна буфера используются, чтобы убедиться, что в закодированном файле задано правильное время отправки в пакетах данных, а в объекте заголовка ASF отображается значение предкоррекции. Достаточно установить **MF \_ асфстреамконфиг \_ LEAKYBUCKET1** , так как указанные значения копируются в атрибут [**MF \_ асфстреамконфиг \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) .

Для режима 2-проходного кодирования необходимо задать оба этих атрибута, чтобы указать среднее и максимальное значения.

Для кодирования VBR приложение может запросить значения сегментов утечки, используемые кодировщиком, только после завершения этапа кодирования. Таким образом, при настройке приемника мультимедиа приложение может не задавать атрибуты или свойства, связанные с сегментами утечки. После кодирования приложение должно запрашивать кодировщик для свойств [**мфпкэй \_ равг**](mfpkey-ravgproperty.md), [**мфпкэй \_ Бавг**](mfpkey-bavgproperty.md), [**мфпкэй \_ рмакс**](mfpkey-rmaxproperty.md)и [**мфпкэй \_ бмакс**](mfpkey-bmaxproperty.md) и задавать их в приемнике носителей, чтобы точные значения отражались в объекте заголовка. Пример кода, посвященного обновлению значений для кодирования VBR, см. в разделе "Обновление свойств кодировки в приемнике файлов" раздела [Учебник: 1. передача кодировки Windows Media](tutorial--1-pass-windows-media-encoding.md).

При копировании содержимого Windows Media из источника в приемник мультимедиа без кодирования значения сегментов утечки должны быть установлены в приемнике мультимедиа.

## <a name="leaky-bucket-values-in-the-asf-multiplexer"></a>Значения сегментов с утечкой в мультиплексоре ASF

В Media Foundation значения контейнеров утечки используются [мультиплексором ASF](asf-multiplexer.md) для настройки внутренних значений сегментов утечки, которые используются для создания пакетов данных. Полезные данные содержатся в образце носителя, а ряд образцов носителей — в виде пакета данных ASF. Основываясь на значениях сегментов утечки и времени презентации, мультиплексор назначает время отправки для каждого примера носителя, чтобы скорость передачи пакетов по сети была постоянной (*R*).

Приложение не может напрямую задавать значения сегментов утечки в мультиплексоре. Значения должны быть указаны в приемнике ASF Media, который задает соответствующие значения для мультиплексора. Значения, заданные в [**MF \_ асфстреамконфиг \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) и [**MF \_ асфстреамконфиг \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) , используются мультиплексором для проверки того, что образцы, отправляемые в приемник мультимедиа ASF, создаются с использованием указанных значений.

## <a name="updating-leaky-bucket-values-in-the-asf-media-sink"></a>Обновление значений сегментов с утечкой в приемнике мультимедиа ASF

Приложение может перезаписать значения контейнеров утечки на уровне потока (заданные в профиле ASF во время создания потока), установив свойство [**мфпкэй \_ асфстреамсинк \_ Исправлено \_ леакибуккет**](mfpkey-asfstreamsink-corrected-leakybucket-property.md) в хранилище свойств приемника мультимедиа. Чтобы получить ссылку на хранилище свойств, используйте объект Контентинфо, реализованный приемником мультимедиа. Дополнительные сведения см. [в разделе Установка свойств в приемнике файла](setting-properties-in-the-file-sink.md).

**Примечание**  .  Эта операция разрешена только для звуковых потоков.

Это свойство должно быть задано после установки типа выходных данных кодировщика. В зависимости от скорости потока, заданной в типе носителя, кодировщик вычисляет размер буфера, чтобы убедиться, что созданные примеры мультимедиа никогда не перечисляют буфер. Кодировщик вносит необходимые изменения во время сжатия для сохранения скорости сжатых образцов в пределах границ, описанных в разделе скорость потока и окно буфера.

Как и атрибуты конфигурации потока для сегментов утечки, установите среднюю скорость и размер буфера, а также заполнение исходного буфера в массиве DWORD. Дополнительные сведения см. в подразделе «Установка значений сегмента утечки для потоков ASF» этого раздела.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Поддержка ASF в Media Foundation](asf-support-in-media-foundation.md)
</dt> <dt>

[Кодеки Windows Media](windows-media-codecs.md)
</dt> </dl>

 

 
