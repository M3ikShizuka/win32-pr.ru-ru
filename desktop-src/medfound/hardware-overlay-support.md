---
description: Описывает, как использовать наложение оборудования в Direct3D 9.
ms.assetid: fa9d5bf5-4c0f-471a-b639-d329b0cd89a4
title: Поддержка наложения оборудования
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f537c91bc217344206c0a23cf5ca8a14254a9c983e4ae550e96457bbb055e5d7
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119600404"
---
# <a name="hardware-overlay-support"></a>Поддержка наложения оборудования

Наложение оборудования — это выделенная область видеопамяти, которая может быть наложена на основную поверхность. При отображении оверлея не выполняется ни одна копия. Операция наложения выполняется в оборудовании без изменения данных на основной поверхности.

использование наложения оборудования для воспроизведения видео было распространено в более ранних версиях Windows, поскольку перекрытия эффективно используются для видеосодержимого с высокой частотой кадров. начиная с Windows 7 Direct3D 9 поддерживает наложение оборудования. Эта поддержка предназначена в основном для воспроизведения видео и в некоторых отношениях отличается от предыдущих API-интерфейсов DirectDraw:

-   Наложение не может быть сжато, отражено или развышено.
-   Исходные цветовые ключи и альфа-смешение не поддерживаются.
-   Наложенные наложения можно растянуть, если наложение оборудования поддерживает его. В противном случае растяжение не поддерживается. На практике не все графические драйверы поддерживают растяжение.
-   Каждое устройство поддерживает не более одного оверлея.
-   Наложение выполняется с использованием целевого цветового ключа, но среда выполнения Direct3D автоматически выбирает цвет и рисует прямоугольник назначения. Direct3D автоматически отслеживает расположение окна и обновляет расположение оверлея при каждом вызове **пресентекс** .

### <a name="creating-a-hardware-overlay-surface"></a>Создание поверхности наложения оборудования

Чтобы запросить поддержку наложения, вызовите **IDirect3D9:: жетдевицекапс**. Если драйвер поддерживает наложение оборудования, в D3DCAPS9 задается флаг **\_ оверлея D3DCAPS** **. Элемент Caps** .

Чтобы узнать, поддерживается ли конкретный формат оверлея для данного режима экрана, вызовите [**IDirect3D9ExOverlayExtension:: чеккдевицеоверлайтипе**](/windows/desktop/api/d3d9/nf-d3d9-idirect3d9exoverlayextension-checkdeviceoverlaytype).

Чтобы создать наложение, вызовите **IDirect3D9Ex:: креатедевицеекс** и укажите результат переключения **D3DSWAPEFFECT \_ оверлея** . Задний буфер может использовать формат, отличный от RGB, если он поддерживается оборудованием.

Поверхности наложения имеют следующие ограничения.

-   Приложение не может создать более одной цепочки перекрытия.
-   Наложение следует использовать в оконном режиме. Его нельзя использовать в полноэкранном режиме.
-   В интерфейсе **IDirect3DDevice9Ex** должен использоваться результат переключения оверлея. Он не поддерживается для **IDirect3DDevice9**.
-   Невозможно использовать множественную выборку.
-   Флаги **D3DPRESENT \_ Донотфлип** и **D3DPRESENT \_ флипрестарт** не поддерживаются.
-   Статистика представления недоступна для поверхности наложения.

Если оборудование не поддерживает растяжение, рекомендуется создать цепочку подкачки, большую, чем режим экрана, чтобы размер окна можно было изменять в соответствии с любыми измерениями. Повторное создание цепочки буферов не является оптимальным способом изменения размера окна, так как это может вызвать серьезные артефакты визуализации. Кроме того, из-за способа, которым графический процессор управляет памятью наложения, повторное создание цепочки буферов может привести к тому, что приложение закончит работу с видеопамяти.

### <a name="new-d3dpresent_parameters-flags"></a>Новые \_ флаги параметров D3DPRESENT

Для создания наложений определены следующие флаги **\_ параметров D3DPRESENT** .



| Флаг                                      | Описание                                                                                                                                                                        |
|-------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **\_Лимитедргб ОВЕРЛЕЯ \_ D3DPRESENTFLAG**   | Диапазон RGB — 16 – 235. Значение по умолчанию — 0 – 255. <br/> Требуется возможность **D3DOVERLAYCAPS \_ лимитедранжергб** .<br/>                                                 |
| **D3DPRESENTFLAG \_ Overlay \_ икбкр \_ BT709** | Цвета YUV используют определение BT. 709. Значение по умолчанию — BT. 601. <br/> Требуется возможность **D3DOVERLAYCAPS \_ икбкр \_ BT709** .<br/>                                      |
| **D3DPRESENTFLAG \_ Overlay \_ икбкр \_ ксвикк** | Вывод данных с помощью расширенного Икбкр (Ксвикк).<br/> Требует возможности **D3DOVERLAYCAPS \_ икбкр \_ BT601 \_ ксвикк** или **D3DOVERLAYCAPS \_ икбкр \_ \_** BT709 ксвикк.<br/> |



 

### <a name="using-hardware-overlays"></a>Использование наложения оборудования

Чтобы отобразить область наложения, приложение вызывает **IDirect3DDevice9Ex::P ресентекс**. Среда выполнения Direct3D автоматически рисует ключ цвета назначения.

Для наложений определены следующие флаги **пресентекс** .



| Флаг                              | Описание                                                                                                                                                                                                                                                                           |
|-----------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **D3DPRESENT \_ упдатеколоркэй**    | Установите этот флаг, если композиция диспетчер окон рабочего стола (DWM) отключена. Этот флаг заставляет Direct3D перерисовывать цветовую клавишу.<br/> Если DWM включен, этот флаг не является обязательным, так как Direct3D рисует ключ цвета один раз на поверхности, которая используется DWM для перенаправления.<br/> |
| **D3DPRESENT \_ хидеоверлай**       | Скрывает наложение.                                                                                                                                                                                                                                                                    |
| **D3DPRESENT \_ упдатеоверлайонли** | Обновляет наложение без изменения содержимого.<br/> Этот флаг полезен, если окно перемещается, пока видео приостановлено.<br/>                                                                                                                                           |



 

Приложение должно быть подготовлено к обработке следующих случаев:

-   Если перекрытие используется другим приложением, **пресентекс** возвращает **D3DERR \_ NOTAVAILABLE**.
-   Если окно перемещается на другой монитор, приложение должно повторно создать цепочку буферов. В противном случае, если приложение вызывает **пресентекс** для отображения наложения на другом мониторе, **пресентекс** возвращает **D3DERR \_ инвалиддевице**.
-   При изменении режима просмотра Direct3D пытается восстановить наложение. Если новый режим не поддерживает наложение, **пресентекс** возвращает **D3DERR \_ унсуппортедоверлай**.

### <a name="example-code"></a>Пример кода

В следующем примере показано, как создать поверхность наложения.


```C++
const UINT VIDEO_WIDTH = 256;
const UINT VIDEO_HEIGHT = 256;

HRESULT CreateHWOverlay(
    HWND hwnd, 
    IDirect3D9Ex *pD3D, 
    IDirect3DDevice9Ex **ppDevice
    )
{
    *ppDevice = NULL;

    D3DCAPS9                caps;
    ZeroMemory(&caps, sizeof(caps));

    HRESULT hr = pD3D->GetDeviceCaps(
        D3DADAPTER_DEFAULT,
        D3DDEVTYPE_HAL,
        &caps
        );

    if (FAILED(hr))
    {
        return hr;
    }

    // Check if overlay is supported.
    if (!(caps.Caps & D3DCAPS_OVERLAY))
    {
        return D3DERR_UNSUPPORTEDOVERLAY;
    }

    D3DOVERLAYCAPS          overlayCaps = { 0 };

    IDirect3DDevice9Ex           *pDevice = NULL;
    IDirect3D9ExOverlayExtension *pOverlay = NULL;

    // Check specific overlay capabilities.
    hr = pD3D->QueryInterface(IID_PPV_ARGS(&pOverlay));

    if (SUCCEEDED(hr))
    {
        hr = pOverlay->CheckDeviceOverlayType(
            D3DADAPTER_DEFAULT,
            D3DDEVTYPE_HAL,
            VIDEO_WIDTH,
            VIDEO_HEIGHT,
            D3DFMT_X8R8G8B8,
            NULL,
            D3DDISPLAYROTATION_IDENTITY,
            &overlayCaps
            );
    }

    // Create the overlay.
    if (SUCCEEDED(hr))
    {

        DWORD flags =   D3DCREATE_FPU_PRESERVE | 
                        D3DCREATE_MULTITHREADED | 
                        D3DCREATE_SOFTWARE_VERTEXPROCESSING;

        
        D3DPRESENT_PARAMETERS   pp = { 0 };

        pp.BackBufferWidth = overlayCaps.MaxOverlayDisplayWidth;
        pp.BackBufferHeight = overlayCaps.MaxOverlayDisplayHeight;
        pp.BackBufferFormat = D3DFMT_X8R8G8B8;
        pp.SwapEffect = D3DSWAPEFFECT_OVERLAY;
        pp.hDeviceWindow = hwnd;
        pp.Windowed = TRUE;
        pp.Flags = D3DPRESENTFLAG_VIDEO;
        pp.FullScreen_RefreshRateInHz = D3DPRESENT_RATE_DEFAULT;
        pp.PresentationInterval       = D3DPRESENT_INTERVAL_ONE;

        hr = pD3D->CreateDeviceEx(D3DADAPTER_DEFAULT, D3DDEVTYPE_HAL,
            NULL, flags, &pp, NULL, &pDevice);
    }

    if (SUCCEEDED(hr))
    {
        (*ppDevice) = pDevice;
        (*ppDevice)->AddRef();
    }

    SafeRelease(&pD3D);
    SafeRelease(&pDevice);
    SafeRelease(&pOverlay);
    return hr;
}
```



## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[API-интерфейсы видео Direct3D](direct3d-video-apis.md)
</dt> </dl>

 

 




