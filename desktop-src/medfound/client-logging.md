---
description: Ведение журнала клиента
ms.assetid: f91b48ae-3989-4c1d-929c-8ab28d7c8177
title: Ведение журнала клиента (Microsoft Media Foundation)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: cb3cb03c8026e91acd567358e7004211b7fdde4d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104262817"
---
# <a name="client-logging-microsoft-media-foundation"></a>Ведение журнала клиента (Microsoft Media Foundation)

Сетевой источник поддерживает ведение журнала клиента, что позволяет серверу мультимедиа отвести наблюдение за активностью клиентов, подключающихся к нему. Журналы клиента позволяют серверу записывать статистику подключения, подготовки к просмотру и потоковой передачи. Эти журналы могут использоваться поставщиками содержимого в различных сценариях, например, для трассировки использования сервера мультимедиа и формирования счетов, а также для предоставления подходящего содержимого в зависимости от скорости сети клиента.

Файл журнала содержит несколько записей о клиентских событиях. Каждая запись журнала содержит несколько полей, разделенных пробелами. Существует два типа журналов клиента: *отрисовка* (воспроизведение) и *потоковая передача* (получение). Так как содержимое может воспроизводиться и передаваться одновременно, клиент может отправить сочетание обоих типов данных журнала. В некоторых случаях для одного сеанса могут существовать две записи журнала. Например, если включен быстрый кэш, клиент может завершить получение потокового содержимого до завершения его подготовки к просмотру. В этом случае данные журнала потоковой передачи будут отправляться перед отрисовкой данных журнала.

Клиент отправляет данные журнала отрисовки на сервер, когда клиент меняется с любого воспроизводимого состояния (воспроизведение, перемотка вперед или назад) на воспроизводимое состояние (остановка, пауза, конец потока и начало потока). При отправке данных для журнала отрисовки подключение устанавливается непосредственно на сервер мультимедиа или настроенный прокси-сервер.

Если содержимое хранится во временном локальном кэше на компьютере, на котором выполняется клиент, клиент может прочитать файл из своего локального кэша и отправить данные журнала отрисовки, чтобы указать, что он воспроизводил содержимое. В этом случае клиент считывает файл из своего локального кэша, запись журнала подготовки отчетов не содержит никакой статистики сети, а для протокола задано значение Cache.

Клиент отправляет потоковые данные журнала на сервер, чтобы указать, как клиент получил содержимое, но не как он был визуализирован. Клиент может отправить журнал потоковой передачи до тех пор, пока клиент не завершит отрисовку содержимого.

В этом разделе не приводятся сведения обо всех полях журнала. Полный справочник см. в разделе [Структура данных журнала Windows Media](/openspecs/windows_protocols/ms-wmlog/42c620eb-0d77-4350-b070-bcd1e182fe84).

## <a name="configuring-log-fields"></a>Настройка полей журнала

Media Foundation позволяет клиенту настроить сетевой источник с помощью свойств. Приложение должно задать соответствующие свойства в хранилище свойств и передать его одному из методов сопоставителя источника. Сопоставитель источника создает сетевой источник по запросу и открывает подключение к серверу. Если соединение прошло успешно, клиент отправляет сведения о себе.

В следующей таблице описаны поля журнала и соответствующие свойства, которые приложение может установить с помощью сопоставителя источников. Эти сведения не изменяются во время сеанса.



<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Поле ведения журнала</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>c-плайерид</td>
<td>Уникальная идентификация проигрывателя. Эти сведения отправляются в начале соединения. Как правило, это идентификатор GUID клиента. Клиент может отправить эти сведения на сервер в свойстве <a href="mfnetsource-playerid-property.md"><strong>MFNETSOURCE_PLAYERID</strong></a> .<br/> Клиент отправляет эти сведения на сервер в начале соединения.<br/> Пример значения: &quot; {c579d042-CECC-11D1-bb31-00a0c9603954}&quot;<br/></td>
</tr>
<tr class="even">
<td>c-плайерверсион</td>
<td>Номер версии проигрывателя, который отправляется в начале соединения. Клиент может отправить эти сведения на сервер в свойстве <a href="mfnetsource-playerversion-property.md"><strong>MFNETSOURCE_PLAYERVERSION</strong></a> .<br/> Клиент отправляет эти сведения на сервер в начале соединения.<br/></td>
</tr>
<tr class="odd">
<td>CS (User-Agent)</td>
<td>Тип браузера, используемый, если проигрыватель внедрен в браузер. Это значение может быть задано клиентом в свойстве <a href="mfnetsource-browseruseragent-property.md"><strong>MFNETSOURCE_BROWSERUSERAGENT</strong></a> .<br/> Если проигрыватель не был внедрен, это поле относится к агенту пользователя клиента, который создал журнал. В этом случае клиент должен задать свойство <a href="mfnetsource-playeruseragent-property.md"><strong>MFNETSOURCE_PLAYERUSERAGENT</strong></a> .<br/> Клиент отправляет эти сведения на сервер в начале соединения.<br/> Пример значения: &quot; Mozilla/4.0 _ (совместимый; _MSIE_4.01; _Windows_98)&quot;<br/></td>
</tr>
<tr class="even">
<td>CS (ссылка)</td>
<td>URL-адрес веб-страницы, в которой был внедрен проигрыватель (если он был внедрен). Клиент может отправить эти сведения на сервер в свойстве <a href="mfnetsource-browserwebpage-property.md"><strong>MFNETSOURCE_BROWSERWEBPAGE</strong></a> .<br/> Клиент отправляет эти сведения на сервер в конце соединения.<br/> Пример значения: &quot; https://www.example.microsoft.com&quot ;<br/></td>
</tr>
<tr class="odd">
<td>c-хостексе</td>
<td>Для записей журнала проигрывателя — запущенной программы хоста (. exe). Например, веб-страница в браузере, приложение Microsoft Visual Basic или автономный проигрыватель. Клиент может отправить эти сведения на сервер в свойстве <a href="mfnetsource-hostexe-property.md"><strong>MFNETSOURCE_HOSTEXE</strong></a> .<br/> Клиент отправляет эти сведения на сервер в конце соединения.<br/> Примеры значений:<br/>
<ul>
<li>&quot;iexplore.exe&quot;</li>
<li>&quot;myplayer.exe&quot;</li>
</ul></td>
</tr>
<tr class="even">
<td>c-хостексевер</td>
<td>Номер версии основной программы (. exe). Клиент может отправить эти сведения на сервер в свойстве <a href="mfnetsource-hostversion-property.md"><strong>MFNETSOURCE_HOSTVERSION</strong></a> .<br/> Клиент отправляет эти сведения на сервер в конце соединения.<br/></td>
</tr>
</tbody>
</table>



 

В следующем примере кода показано, как клиентское приложение настраивает сетевой источник. В этом примере задается поле журнала c-хостексе.


```C++
// Creates a media source from a URL.
//
// This example demonstrates how to set the MFNETSOURCE_HOSTEXE
// configuration property on the network source.

HRESULT CreateMediaSourceWithLogParams(
    PCWSTR pszURL, 
    IMFMediaSource **ppSource
    )
{
    IPropertyStore *pConfig = NULL;

    // Configure the property store.
    HRESULT hr = PSCreateMemoryPropertyStore(IID_PPV_ARGS(&pConfig));

    if (SUCCEEDED(hr))
    {
        PROPERTYKEY key;
        key.fmtid =  MFNETSOURCE_HOSTEXE;
        key.pid = 0;

        PROPVARIANT var;
        var.vt = VT_LPWSTR;
        var.pwszVal = L"MyPlayer.exe";

        hr = pConfig->SetValue(key, var);
    }

    // Create the source media source.
    if (SUCCEEDED(hr))
    {
        hr = CreateMediaSource(pszURL, pConfig, ppSource);
    }

    SafeRelease(&pConfig);
    return hr;
}
```



## <a name="retrieving-network-statistics"></a>Получение статистики сети

Когда приложение вызывает один из методов сопоставителя источника, он создает источник сети, устанавливает свойства, указанные в хранилище свойств, и открывает сеанс на сервере мультимедиа. Помимо настраиваемых сведений, описанных в предыдущем разделе, дополнительные данные передаются между сервером и клиентом в начале сеанса, во время потоковой передачи и при закрытии сеанса.

Приложение может получить сетевую статистику с помощью идентификатора службы **мфнетсаурце \_ Statistics \_ Service** . Чтобы использовать эту службу, приложение может вызвать функцию [**мфжетсервице**](/windows/desktop/api/mfidl/nf-mfidl-mfgetservice) для получения хранилища свойств, содержащего сетевую статистику, в свойстве [**\_ статистики мфнетсаурце**](/windows/desktop/api/mfidl/ne-mfidl-mfnetsource_statistics_ids) . Конкретные значения можно получить, предоставив соответствующий идентификатор, определенный в перечислении **мфнетсаурце \_ Statistics \_ ID** .

В следующем примере кода показано, как использовать службу для получения числа пакетов, полученных клиентом.


```C++
HRESULT GetPacketsReceived(IMFMediaSession *pSession, DWORD *pcPackets)
{
    IPropertyStore *pProp = NULL;
    PROPVARIANT var;

    // Get the property store from the media session.
    HRESULT hr = MFGetService(
        pSession, 
        MFNETSOURCE_STATISTICS_SERVICE, 
        IID_PPV_ARGS(&pProp)
        );

    // Get the number of packets received by the client.

    if (SUCCEEDED(hr))
    {
        PROPERTYKEY key;
        key.fmtid = MFNETSOURCE_STATISTICS;
        key.pid = MFNETSOURCE_RECVPACKETS_ID;

        hr = pProp->GetValue(key, &var);
    }

    if (SUCCEEDED(hr))
    {
        *pcPackets = var.lVal;
    }

    PropVariantClear(&var);
    SafeRelease(&pProp);
    return hr;
}
```



В следующем списке описаны некоторые идентификаторы сетевой статистики, определенные в [**мфнетсаурце \_ Statistics \_ ID**](/windows/desktop/api/mfidl/ne-mfidl-mfnetsource_statistics_ids).



| Идентификатор сетевой статистики              | Описание                                                                                                                                                                                                                |
|--------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **\_идентификатор АВГБАНДВИДСБПС \_ мфнетсаурце**       | Средняя пропускная способность (в битах в секунду), с которой клиент был подключен к серверу. Значение вычисляется в течение всей продолжительности соединения.                                                              |
| **\_идентификатор БУФФЕРИНГКАУНТ \_ мфнетсаурце**        | Количество раз, которое клиент буферизован во время воспроизведения потока.                                                                                                                                                              |
| **\_идентификатор БИТЕСРЕЦЕИВЕД \_ мфнетсаурце**         | Число байтов, полученных клиентом с сервера. Это значение не включает дополнительные издержки, добавленные сетевым стеком. То же содержимое, переданное с помощью разных протоколов, может привести к различным значениям. |
| **\_идентификатор ЛИНКБАНДВИДС \_ мфнетсаурце**         | Максимальная доступная пропускная способность клиента в битах в секунду.                                                                                                                                                              |
| **\_идентификатор ЛОСТПАККЕТС \_ мфнетсаурце**           | Число пакетов, отправленных сервером, но потерянных при передаче, и никогда не воспроизводился клиентом. Значение не включает пакеты TCP или UDP.                                                                          |
| **\_идентификатор РЕКВПАККЕТС \_ мфнетсаурце**           | Число пакетов, полученных с сервера. значение не включает пакеты TCP или UDP.                                                                                                                                  |
| **\_идентификатор РЕКОВЕРЕДБЕККПАККЕТС \_ мфнетсаурце** | Потерянные в сети пакеты, которые были восстановлены и восстановлены на уровне клиента. Это значение не включает пакеты TCP или UDP.                                                                                          |
| **\_идентификатор РЕСЕНДСРЕКУЕСТЕД \_ мфнетсаурце**      | Число запросов, отправленных клиентом для получения новых пакетов. Это значение не включает пакеты TCP или UDP.                                                                                                          |
| **\_идентификатор РЕКОВЕРЕДПАККЕТС \_ мфнетсаурце**      | Число восстановленных пакетов, так как они были отправлены по протоколу UDP. Это значение не включает пакеты TCP или UDP. Это поле содержит нуль, если клиент не использует повторную отправку UDP.                                        |
| **\_идентификатор БУФФЕРПРОГРЕСС \_ мфнетсаурце**        | Процент буферов воспроизведения, заполненный во время буферизации.                                                                                                                                                              |
| **\_идентификатор протокола \_ мфнетсаурце**              | Протокол, используемый для доступа к потоку. Это может отличаться от протокола, запрошенного клиентом.                                                                                                                             |
| **\_идентификатор транспорта \_ мфнетсаурце**             | Транспортный протокол, используемый для доставки потока. Это должен быть либо UDP, либо TCP.                                                                                                                                             |



 

## <a name="related-topics"></a>См. также

<dl> <dt>

[Компоненты сетевого источника](network-source-features.md)
</dt> <dt>

[Сетевые подключения в Media Foundation](networking-in-media-foundation.md)
</dt> </dl>

 

