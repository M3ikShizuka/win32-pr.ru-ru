---
description: В этом разделе описывается написание пользовательского обработчика свойств оболочки для Microsoft Media Foundation источника мультимедиа.
ms.assetid: f8cf70ff-8324-4308-8adf-a145aa351ca9
title: Пользовательские поставщики метаданных для файлов мультимедиа
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a2ded77492d03f7b802f6b2f9c25e1009ef97f50
ms.sourcegitcommit: d75fc10b9f0825bbe5ce5045c90d4045e3c53243
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2021
ms.locfileid: "127572879"
---
# <a name="custom-metadata-providers-for-media-files"></a>Пользовательские поставщики метаданных для файлов мультимедиа

В этом разделе описывается написание пользовательского обработчика свойств оболочки для Microsoft Media Foundation источника мультимедиа.

> [!Note]  
> Общие сведения о поставщиках метаданных в Media Foundation см. в разделе [метаданные носителя](media-metadata.md). В этом разделе обсуждаются обработчики свойств оболочки. Он не описывает интерфейс метаданных версии 1, [**имфметадата**](/windows/desktop/api/mfidl/nn-mfidl-imfmetadata).

 

Метаданные тесно связаны с форматом файла. В Media Foundation форматы файлов представлены источниками мультимедиа. Если требуется поддержка метаданных для формата, который не поддерживается изначально в Media Foundation, необходимо реализовать пользовательский источник мультимедиа с помощью обработчика свойств. Обработчик свойств позволяет системе свойств оболочки эффективно считывать и записывать метаданные.

Обработчик свойства — это COM-объект, реализующий следующие интерфейсы:

-   [**IInitializeWithStream**](/windows/win32/api/propsys/nn-propsys-iinitializewithstream)
-   [**ипропертисторе**](/windows/win32/api/propsys/nn-propsys-ipropertystore)

При необходимости он также может предоставить следующий интерфейс:

-   [**ипропертисторекапабилитиес**](/windows/win32/api/propsys/nn-propsys-ipropertystorecapabilities)

Если системе свойств оболочки необходимо получить метаданные для файла, он вызывает [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) для создания обработчика свойств, а затем вызывает соответствующие методы чтения и записи в интерфейсе [**ипропертисторе**](/windows/win32/api/propsys/nn-propsys-ipropertystore) .

Конвейер Media Foundation использует несколько иной механизм, так как конвейер получает обработчик свойств непосредственно из источника мультимедиа. Вместо вызова [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) для создания обработчика свойств конвейер вызывает [**Имфжетсервице:: WebService**](/windows/desktop/api/mfidl/nf-mfidl-imfgetservice-getservice) в источнике мультимедиа, как описано в разделе [поставщики метаданных оболочки](shell-metadata-providers.md).

Чтобы создать пользовательский обработчик свойства, выполните следующие действия.

-   Реализуйте интерфейс [**имфжетсервице**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice) , чтобы предоставить [**ипропертисторе**](/windows/win32/api/propsys/nn-propsys-ipropertystore). GUID службы — это **\_ \_ \_ Служба обработчика свойств MF**.
-   Если источник мультимедиа будет использоваться удаленно, он должен также предоставлять интерфейс [**ипропертисторе**](/windows/win32/api/propsys/nn-propsys-ipropertystore) через метод **QueryInterface** источника мультимедиа в дополнение к [**имфжетсервице**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice).
-   Чтобы сделать обработчик свойств доступным системе свойств оболочки, зарегистрируйте библиотеку DLL для обработчика свойства, как описано в статье [Регистрация и распространение обработчиков свойств](../properties/prophand-reg-dist.md).
-   Источник мультимедиа регистрируется отдельно, как описано в разделе [обработчики схем и обработчики Byte-Stream](scheme-handlers-and-byte-stream-handlers.md).

### <a name="implementation-tips"></a>Советы реализации

Список ключей свойств метаданных см. в разделе [Свойства метаданных для файлов мультимедиа](metadata-properties-for-media-files.md).

Обработчики свойств должны быть быстрыми; они должны предоставлять эффективный доступ для чтения и записи к метаданным. (Рассмотрим, что оболочка может извлекать метаданные из сотен файлов.) Поэтому не вызывайте [**мфстартуп**](/windows/desktop/api/mfapi/nf-mfapi-mfstartup) из обработчика свойств. Функция **мфстартуп** вводит задержку при запуске, так как создает несколько потоков рабочей очереди и выделяет глобальную память.

В типичной реализации обработчик свойств и источник мультимедиа будут совместно использовать один и тот же код анализа. Однако источник мультимедиа использует асинхронные вызовы [**имфбитестреам**](/windows/desktop/api/mfobjects/nn-mfobjects-imfbytestream) для операций ввода-вывода, тогда как обработчик свойств использует интерфейс [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) . Media Foundation предоставляет вспомогательный объект, который создает оболочку для потока на основе **IStream** и предоставляет его в виде потока **имфбитестреам** . Чтобы создать оболочку, вызовите [**мфкреатемфбитестреамонстреам**](/windows/desktop/api/mfidl/nf-mfidl-mfcreatemfbytestreamonstream).

При обновлении метаданных рекомендуется записывать данные непосредственно в исходный поток. Эта рекомендация отличается от поведения *копирования при записи* большинства обработчиков свойств, в которых изменяется копия данных. Файлы мультимедиа могут быть очень большими, поэтому операция копирования при записи обычно слишком мала для эффективной реализации. Чтобы отключить копирование при записи, задайте параметр реестра **мануалсафесаве** , как описано в статье [Регистрация и распространение обработчиков свойств](../properties/prophand-reg-dist.md).

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Метаданные мультимедиа](media-metadata.md)
</dt> <dt>

[Источники мультимедиа](media-sources.md)
</dt> <dt>

[Запись пользовательского источника мультимедиа](writing-a-custom-media-source.md)
</dt> </dl>

 

 
