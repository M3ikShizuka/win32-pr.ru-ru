---
description: В этом разделе описано, как клиент использует преобразование Media Foundation (MFT) для обработки данных. Клиент — это все, что напрямую вызывает методы в MFT. Это может быть приложение или конвейер Media Foundation.
ms.assetid: be977d75-999e-4e57-9672-00a89246a2c1
title: Базовая модель обработки MFT
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9ca54df6d9765aaf54456c3d9dc4461a82a93d41
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104072585"
---
# <a name="basic-mft-processing-model"></a>Базовая модель обработки MFT

В этом разделе описано, как клиент использует преобразование Media Foundation (MFT) для обработки данных. *Клиент* — это все, что напрямую вызывает методы в MFT. Это может быть приложение или конвейер Media Foundation.

Прочтите этот раздел, если вы:

-   Написание приложения, выполняющего прямые вызовы к одному или нескольким МФТС.
-   Написание настраиваемой таблицы MFT и нужно понимать поведение MFT.

В этом разделе описывается модель *синхронной* обработки. В этой модели все методы обработки данных блокируются до их завершения. МФТС также может поддерживать *асинхронную* модель, которая описана в разделе [асинхронная МФТС](asynchronous-mfts.md).

-   [Базовая модель обработки](#basic-processing-model)
    -   [Создание MFT](#create-the-mft)
    -   [Получение идентификаторов потоков](#get-stream-identifiers)
    -   [Настройка типов мультимедиа](#set-media-types)
    -   [Получение требований к буферу](#get-buffer-requirements)
    -   [Обработка данных](#process-data)
-   [Расширения для базовой модели](#extensions-to-the-basic-model)
-   [IMF2DBuffer](#imf2dbuffer)
-   [Очистка MFT](#flushing-an-mft)
-   [Очистка MFT](#draining-an-mft)
-   [Примеры атрибутов](#sample-attributes)
-   [Нарушения](#discontinuities)
-   [Изменения динамического формата](#dynamic-format-changes)
-   [Потоковые события](#stream-events)
-   [См. также](#related-topics)

## <a name="basic-processing-model"></a>Базовая модель обработки

### <a name="create-the-mft"></a>Создание MFT

Существует несколько способов создания таблицы MFT.

-   Вызовите функцию [**мфтенум**](/windows/desktop/api/mfapi/nf-mfapi-mftenum) .
-   Вызовите функцию [**мфтенумекс**](/windows/desktop/api/mfapi/nf-mfapi-mftenumex) .
-   Если вы уже знакомы с идентификатором класса MFT, просто вызовите **CoCreateInstance**.

Некоторые МФТС могут предоставлять другие возможности, например специальную функцию создания.

### <a name="get-stream-identifiers"></a>Получение идентификаторов потоков

MFT имеет один или несколько *потоков*. Входные потоки получают входные данные, а выходные потоки создают выходные данные. Потоки не представляются как отдельные объекты. Вместо этого различные методы MFT принимают идентификаторы потоков в качестве параметров.

Некоторые МФТС позволяют клиенту добавлять или удалять входные потоки. Во время потоковой передачи файл MFT может добавлять или удалять выходные потоки. (Клиент не может добавлять или удалять выходные потоки.)

1.  (Необязательно.) Вызовите [**имфтрансформ:: жетстреамлимитс**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getstreamlimits) , чтобы получить минимальное и максимальное число потоков, которые может поддерживать MFT. Если минимальное и максимальное значения совпадают, MFT имеет фиксированное число потоков.
2.  Вызовите метод [**имфтрансформ:: жетстреамкаунт**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getstreamcount) , чтобы получить начальное число потоков.
3.  Вызовите метод [**имфтрансформ:: жетстреамидс**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getstreamids) , чтобы получить идентификаторы потоков. Если этот метод возвращает E \_ нотимпл, это означает, что MFT имеет фиксированное число потоков, а идентификаторы потоков начинаются с нуля.
4.  (Необязательно.) Если таблица MFT не имеет фиксированного числа потоков, вызовите [**имфтрансформ:: аддинпутстреамс**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-addinputstreams) , чтобы добавить дополнительные входные потоки, или [**Имфтрансформ::D елетеинпутстреам**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-deleteinputstream) для удаления потоков ввода. (Нельзя добавлять или удалять выходные потоки.)

### <a name="set-media-types"></a>Настройка типов мультимедиа

Прежде чем MFT сможет обработать данные, клиент должен задать типы носителей для каждого потока MFT. Для MFT может потребоваться, чтобы клиент установил входные типы перед заданием типов выходных данных, или потребовался обратный порядок (типы вывода сначала). Некоторые МФТС не имеют требования к заказу.

Таблица MFT может предоставлять список предпочтительных типов мультимедиа для потока. Кроме того, МФТС может указывать на общие форматы, которые они поддерживают, добавляя эти сведения в реестр.

Чтобы задать типы носителей, выполните следующие действия.

1.  (Необязательно.) Для каждого входного потока вызовите [**имфтрансформ:: жетинпутаваилаблетипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) , чтобы получить список предпочтительных типов для этого потока.
    -   Если этот метод возвращает \_ \_ тип преобразования MF \_ E \_ не \_ задан, необходимо сначала задать выходные типы, перейдите к шагу 3.
    -   Если метод возвращает E \_ нотимпл, то Таблица MFT не имеет списка предпочтительных входных типов; перейдите к шагу 2.
2.  Для каждого входного потока вызовите [**имфтрансформ:: сетинпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) , чтобы задать входной тип. Можно использовать тип носителя из шага 1 или тип, описывающий входные данные. Если какой бы то ни было поток возвращает \_ \_ тип преобразования MF E \_ \_ не \_ задан, перейдите к шагу 3.
3.  (Необязательно.) Для каждого выходного потока вызовите [**имфтрансформ:: жетаутпутаваилаблетипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) , чтобы получить список предпочтительных типов для этого потока.
    -   Если этот метод возвращает \_ \_ \_ неустановленный тип преобразования MF E \_ \_ , необходимо сначала задать входные типы, а затем вернуться к шагу 1.
    -   Если какой-либо поток возвращает E \_ нотимпл, то Таблица MFT не имеет списка предпочтительных типов выходных данных; перейдите к шагу 4.
4.  Для каждого выходного потока вызовите [**имфтрансформ:: сетаутпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) , чтобы задать тип выходных данных. Можно использовать тип носителя из шага 3 или тип, описывающий требуемый выходной формат.
5.  Если какие-либо входные потоки не имеют типа мультимедиа, вернитесь к шагу 1.

### <a name="get-buffer-requirements"></a>Получение требований к буферу

После того как клиент установит типы носителей, он должен получить требования к буферу для каждого потока:

-   Для каждого входного потока вызовите [**имфтрансформ:: жетинпутстреаминфо**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputstreaminfo).
-   Для каждого выходного потока вызовите [**имфтрансформ:: жетаутпутстреаминфо**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo).

### <a name="process-data"></a>Обработка данных

Таблица MFT разработана как надежный конечный автомат. Он не выполняет обратные вызовы клиенту.

1.  Вызовите [**имфтрансформ::P роцессмессаже**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) с сообщением [**\_ \_ о \_ начале \_ потоковой передачи сообщения MFT**](mft-message-notify-begin-streaming.md) . Это сообщение запрашивает основную таблицу файлов, чтобы выделить все необходимые ресурсы во время потоковой передачи.
2.  Вызовите [**имфтрансформ::P роцессинпут**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput) по крайней мере из одного входного потока для доставки примера входных данных в MFT.
3.  (Необязательно.) Вызовите [**имфтрансформ:: жетаутпутстатус**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstatus) , чтобы запросить, может ли MFT создать образец вывода. Если метод возвращает значение " \_ ОК", проверьте параметр *пдвфлагс* . Если *пдвфлагс* содержит флаг **\_ \_ \_ \_ готовности для образца состояния вывода MFT** , перейдите к шагу 4. Если *пдвфлагс* равен нулю, вернитесь к шагу 2. Если метод возвращает E \_ нотимпл, перейдите к шагу 4.
4.  Вызовите [**имфтрансформ::P роцессаутпут**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) , чтобы получить выходные данные.
    -   Если метод возвращает для **\_ преобразования MF \_ E \_ требуется \_ больше \_ входных** данных, это означает, что для MFT требуются дополнительные входные данные; вернитесь к шагу 2.
    -   Если метод возвращает **\_ \_ \_ \_ изменение потока преобразования MF E**, это означает, что число потоков вывода изменилось или изменился формат вывода. Клиенту может потребоваться запросить новые идентификаторы потоков или задать новые типы носителей. Дополнительные сведения см. в документации по [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).
5.  Если для обработки остались входные данные, перейдите к шагу 2. Если таблица MFT использовала все доступные входные данные, перейдите к шагу 6.
6.  Вызовите [**ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) с [**\_ \_ уведомлением о \_ завершении \_ \_ потока сообщения MFT**](mft-message-notify-end-of-stream.md) .
7.  Вызовите [**ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) с сообщением о [**\_ \_ \_ стоке команды сообщения MFT**](mft-message-command-drain.md) .
8.  Вызовите [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) , чтобы получить оставшиеся выходные данные. Повторите этот шаг, пока для метода не будет возвращено **\_ Преобразование MF E, \_ \_ требуется \_ больше \_ входных данных**. Это возвращаемое значение сигнализирует, что все выходные данные были потеряны из MFT. (Не обрабатывают это как условие ошибки.)

Описанная здесь последовательность сохраняет как можно меньше данных в MFT. После каждого вызова метода [**ProcessInput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput)клиент пытается получить выходные данные. Для создания одного выходного образца может потребоваться несколько примеров ввода, или один образец ввода может формировать несколько выходных образцов. Оптимальное поведение клиента заключается в вытягивание выходных образцов из MFT до тех пор, пока MFT не потребует больше входных данных.

Однако таблица MFT должна иметь возможность обрабатывать другой порядок вызовов методов клиентом. Например, клиент может просто перезвонить между вызовами [**ProcessInput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput) и [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput). Таблица MFT должна ограничивать объем вводимых данных, возвращая **MF \_ E \_ нотакцептинг** из **ProcessInput** всякий раз, когда он получает выходные данные для создания.

Порядок вызовов методов, описанных здесь, не является единственной допустимой последовательностью событий. Например, в шагах 3 и 4 предполагается, что клиент начинается с входных типов, а затем пытается получить типы выходных данных. Клиент также может отменить этот порядок и начать с выходными типами. В любом случае, если таблица MFT требует обратного порядка, она должна вернуть \_ \_ \_ \_ \_ неустановленный тип преобразования с кодом MF E.

Клиент может в любое время вызывать информационные методы, такие как [**жетинпуткурренттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputcurrenttype) и [**жетаутпутстреаминфо**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo), в любой момент во время потоковой передачи. Клиент также может попытаться изменить типы носителей в любое время. MFT должен вернуть код ошибки, если это не является допустимой операцией. Короче говоря, МФТС должен очень немного полагаться на порядок операций, Кроме того, что задокументировано в самих вызовах.

На следующей диаграмме показана последовательность процедур, описанных в этом разделе.

![Блок-схема, которая ведет от получения идентификаторов потоков посредством циклов, устанавливающих входные типы, получение входных данных и обработку выходных данных.](images/mft-processing.gif)

## <a name="extensions-to-the-basic-model"></a>Расширения для базовой модели

Кроме того, Таблица MFT может поддерживать некоторые расширения базовой потоковой модели.

-   Потоки с отложенным чтением. Если метод [**имфтрансформ:: жетаутпутстреаминфо**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) Возвращает флаг **\_ \_ \_ \_ Lazy Output потока MFT** для выходного потока, клиенту не нужно получать данные из этого потока вывода. Таблица MFT продолжит принимать входные данные, и в некоторый момент файл MFT будет отбрасывать вывод данных из этого потока. Если все выходные потоки имеют этот флаг, MFT никогда не будет принимать входные данные. Примером может быть преобразование визуализации, при котором клиент получает выходные данные только при наличии свободных циклов ЦП для отрисовки визуализации.
-   Отклоненные потоки. Если метод [**жетаутпутстреаминфо**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) Возвращает флаг, отмечающий выходной **\_ \_ поток \_ MFT** , для выходного потока, клиент может запрашивать файл MFT для отмены выходных данных, но файл MFT не будет удалять выходные данные, если это не требуется. Когда размер MFT достигает максимального входного буфера, клиент должен либо получить выходные данные, либо запросить удаление файла MFT для отмены выходных данных.
-   Необязательные потоки. Если метод [**жетаутпутстреаминфо**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) возвращает **\_ \_ \_ необязательный флаг потока вывода MFT** для выходного потока, или метод [**имфтрансформ:: жетинпутстреаминфо**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputstreaminfo) возвращает необязательный флаг **\_ входного \_ потока \_ MFT** для входного потока, этот поток является необязательным. Клиенту не нужно задавать тип носителя в потоке. Если клиент не задает тип, выбирается поток. В невыбранном потоке вывода не создаются образцы, а клиент не предоставляет буфер для потока при вызове [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput). Невыбранный входной поток не принимает входные данные. MFT может пометить все входные и выходные потоки как необязательные. Однако ожидается, что для работы MFT необходимо выбрать хотя бы один вход и один выход.
-   Асинхронная обработка. Модель асинхронной обработки была введена в Windows 7. Он описан в разделе [асинхронная МФТС](asynchronous-mfts.md).

## <a name="imf2dbuffer"></a>IMF2DBuffer

Если файл MFT обрабатывает несжатые видеоданные, он должен использовать интерфейс [**IMF2DBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imf2dbuffer) для работы с примерами буферов. Чтобы получить этот интерфейс, запросите интерфейс [**имфмедиабуффер**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) в любом буфере ввода или вывода. Не используйте этот интерфейс, если он доступен, может привести к созданию дополнительных буферных копий. Чтобы обеспечить правильное использование этого интерфейса, преобразование не должно блокировать буфер с помощью интерфейса **имфмедиабуффер** , если **IMF2DBuffer** доступен.

Дополнительные сведения об обработке видеоданных см. в разделе [несжатые Видеобуферы](uncompressed-video-buffers.md).

## <a name="flushing-an-mft"></a>Очистка MFT

*Запись* MFT приводит к тому, что MFT удаляет все входные данные. Это может привести к сбою в потоке вывода. Как правило, клиент очищает MFT перед переходом к новой точке во входном потоке или при переключении на новый входной поток, когда клиент не заботится о потере данных.

Чтобы очистить MFT, вызовите [**имфтрансформ::P роцессмессаже**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) с сообщением о [**\_ \_ команде \_ очистки сообщения MFT**](mft-message-command-flush.md) .

## <a name="draining-an-mft"></a>Очистка MFT

*Очистка* MFT приводит к тому, что MFT создает как можно больше выходных данных, так как это может быть уже отправленные входные данные. Если MFT не может создать полный образец вывода из доступных входных данных, будут удалены входные данные. Как правило, клиент приводит к стоку MFT при достижении конца исходного потока или непосредственно перед изменением формата в исходном потоке. Чтобы очистить MFT, выполните следующие действия.

1.  Вызовите [**ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) с сообщением о [**\_ \_ \_ стоке команды сообщения MFT**](mft-message-command-drain.md) . Это сообщение уведомляет основную таблицу файлов о том, что она должна доставлять как можно больше выходных данных, так как это возможно из входных данных, которые уже были отправлены.
2.  Вызовите [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) , чтобы получить выходные данные, пока метод не вернет значение **MF \_ E для \_ преобразования \_ требуется \_ больше \_ входных** данных.

Пока происходит сток MFT, он не будет принимать дополнительные входные данные.

## <a name="sample-attributes"></a>Примеры атрибутов

Входные образцы могут иметь атрибуты, которые должны быть скопированы в соответствующие выходные примеры.

-   Если таблица MFT возвращает значение **Variant \_ true** для свойства [**мфпкэй \_ ексаттрибуте \_ Supported**](mfpkey-exattribute-supported-property.md) , MFT должно скопировать атрибуты.
-   Если свойство [**мфпкэй \_ ексаттрибуте \_ Supported**](mfpkey-exattribute-supported-property.md) имеет значение **Variant \_ false** или не задано, клиент должен скопировать атрибуты.

Для MFT с одним входом и одним выходом можно использовать следующее общее правило:

-   Если каждый входной образец создает ровно один выходной пример, можно разрешить клиенту копировать атрибуты. Оставьте свойство [**мфпкэй \_ ексаттрибуте \_ Supported**](mfpkey-exattribute-supported-property.md) .
-   Если между входными примерами и выходными примерами нет соответствия "один к одному", MFT должен определить правильные атрибуты для выходных образцов. Задайте для свойства [**мфпкэй \_ ексаттрибуте \_ support**](mfpkey-exattribute-supported-property.md) значение **Variant \_ true**.

## <a name="discontinuities"></a>Нарушения

Ненепрерывность — это перерыв в потоке аудио или видео. Прекращение работы может быть вызвано удалением пакетов в сетевом подключении, повреждением данных файла, переключением из одного исходного потока в другой или широкого ряда других причин. О прекращении поддержки сообщается путем установки атрибута [**\_ прекращения мфсампликстенсион**](mfsampleextension-discontinuity-attribute.md) в первом примере после прекращения поддержки. Невозможно сообщить о ненепрерывности в середине примера. Поэтому все ненепрерывные данные должны отправляться в отдельных примерах.

Некоторые преобразования, в частности те, которые обрабатывают несжатые данные, такие как звуковые и видеоэффекты, при обработке входных данных должны игнорировать прекращения. Эти МФТС обычно предназначены для обработки непрерывных данных и должны обрабатывать все получаемые данные как непрерывные, даже после небесперебойности.

Если файл MFT игнорирует неоднородность входных данных, он по-прежнему должен установить флаг небесперебойности в образце Output, если образец выходных данных имеет ту же метку времени, что и образец input. Если образец Output имеет другую отметку времени, то файл MFT не должен распространяться на ненепрерывность. (Например, в некоторых звуковых реобразцах). Ненепрерывность в неправильном месте потока хуже, чем ненепрерывность.

Большинство декодеров не могут игнорировать прекращения, так как ненепрерывность влияет на интерпретацию следующего образца. Любая технология кодирования, использующая сжатие между кадрами, например MPEG-2, попадает в эту категорию. Некоторые схемы кодирования используют только сжатие внутри фрейма, например DV и МЖПЕГ. Эти декодеры могут спокойно игнорировать прекращения.

Преобразования, реагирующие на прекращения работы, должны как обычно выводить большую часть данных до того, как это возможно, и отменять остальные. Входной пример с флагом небесперебойности должен обрабатываться, как будто это первый пример в потоке. (Это поведение соответствует значению, указанному для сообщения о [**\_ \_ \_ стоке команды сообщения MFT**](mft-message-command-drain.md) .) Однако точные сведения будут зависеть от формата мультимедиа.

Если декодер не выполняет никаких действий по устранению небесперебойности, он должен скопировать флаг небесперебойности в выходные данные. Демультиплексоры и другие МФТС, полностью работающие с сжатыми данными, должны копировать все небесперебойные работы в свои выходные потоки. В противном случае нисходящие компоненты, возможно, не смогут правильно декодировать сжатые данные. Как правило, он почти всегда подходит для передачи непрерывных отработок, если только MFT не содержит явного кода для смягчения небесперебойности.

## <a name="dynamic-format-changes"></a>Изменения динамического формата

Форматы могут изменяться во время потоковой передачи. Например, пропорции могут меняться в середине потока видео.

Дополнительные сведения об обработке изменений потока MFT см. в разделе [Обработка изменений потока](handling-stream-changes.md).

## <a name="stream-events"></a>Потоковые события

Чтобы отправить событие в таблицу MFT, вызовите [**имфтрансформ::P роцессевент**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processevent). Если метод возвращает **MF \_ S \_ Transform \_ \_ не \_ распространяет \_ событие**, MFT возвратит событие вызывающему объекту при последующем вызове метода [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput). Если метод возвращает любое другое значение **HRESULT** , MFT не будет возвращать событие клиенту в **ProcessOutput**. В этом случае клиент несет ответственность за распространение события в следующий компонент конвейера, если это применимо. Дополнительные сведения см. в разделе [**имфтрансформ::P роцессаутпут**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).

## <a name="related-topics"></a>См. также

<dl> <dt>

[Преобразования Media Foundation](media-foundation-transforms.md)
</dt> </dl>

 

 



