---
description: В этом разделе описано, как реализовать пользовательский источник мультимедиа в Microsoft Media Foundation.
ms.assetid: 82db6f32-ad94-4563-b8bd-8a5072c5b221
title: Запись пользовательского источника мультимедиа
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8769fa16d4dcbfd3438b66f9a9e78c34274735a5
ms.sourcegitcommit: c16214e53680dc71d1c07111b51f72b82a4512d8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "105703469"
---
# <a name="writing-a-custom-media-source"></a>Запись пользовательского источника мультимедиа

В этом разделе описано, как реализовать пользовательский источник мультимедиа в Microsoft Media Foundation. Он содержит следующие подразделы:

-   [Создание дескриптора презентации](#creating-the-presentation-descriptor)
-   [Запуск источника мультимедиа](#starting-the-media-source)
    -   [Нужна](#seeking)
-   [Приостановка источника мультимедиа](#pausing-the-media-source)
-   [Создание исходных данных](#generating-source-data)
    -   [Примеры запросов](#sample-requests)
    -   [Выделение выборок](#allocating-samples)
    -   [Пробелы в потоке](#gaps-in-the-stream)
-   [Завершение работы источника мультимедиа](#shutting-down-the-media-source)
-   [Активные источники](#live-sources)
-   [См. также](#related-topics)

## <a name="creating-the-presentation-descriptor"></a>Создание дескриптора презентации

Метод [**имфмедиасаурце:: креатепресентатиондескриптор**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasource-createpresentationdescriptor) возвращает копию дескриптора представления источника. Чтобы создать дескриптор представления, необходимо выяснить число потоков в исходном содержимом и возможные форматы каждого потока. Для каждого потока создайте дескриптор потока следующим образом:

1.  Создайте массив типов мультимедиа. Каждый тип носителя в массиве представляет возможный формат для потока. Дополнительные сведения о создании типов носителей см. в разделе [типы носителей](media-types.md).
2.  Вызовите [**мфкреатестреамдескриптор**](/windows/desktop/api/mfidl/nf-mfidl-mfcreatestreamdescriptor) , чтобы создать дескриптор потока. Передайте массив типов мультимедиа. Функция возвращает указатель [**имфстреамдескриптор**](/windows/desktop/api/mfidl/nn-mfidl-imfstreamdescriptor) .
3.  Вызовите метод [**имфстреамдескриптор:: жетмедиатипехандлер**](/windows/desktop/api/mfidl/nf-mfidl-imfstreamdescriptor-getmediatypehandler) , чтобы получить обработчик типа мультимедиа дескриптора потока.
4.  Вызовите метод [**имфмедиатипехандлер:: сеткуррентмедиатипе**](/windows/desktop/api/mfidl/nf-mfidl-imfmediatypehandler-setcurrentmediatype) , чтобы задать формат потока по умолчанию. Используйте один из типов носителей, созданный на шаге 1. Как правило, следует использовать формат с самым высоким качеством.
5.  При необходимости задайте атрибуты для дескриптора потока. Список атрибутов, применяемых к дескрипторам потоков, см. в разделе [атрибуты дескриптора потока](stream-descriptor-attributes.md).

Теперь создайте дескриптор презентации:

1.  Вызовите [**мфкреатепресентатиондескриптор**](/windows/desktop/api/mfidl/nf-mfidl-mfcreatepresentationdescriptor) и передайте массив дескрипторов потока. Функция возвращает указатель [**имфпресентатиондескриптор**](/windows/desktop/api/mfidl/nn-mfidl-imfpresentationdescriptor) .
2.  Выберите Выбор потока по умолчанию, вызвав [**имфпресентатиондескриптор:: селектстреам**](/windows/desktop/api/mfidl/nf-mfidl-imfpresentationdescriptor-selectstream) , чтобы выбрать один или несколько потоков. В конфигурации по умолчанию должен быть выбран хотя бы один поток.
3.  При необходимости задайте атрибуты для дескриптора презентации. Список атрибутов, применяемых к дескрипторам потоков, см. в разделе [атрибуты дескриптора представления](presentation-descriptor-attributes.md).

Вы должны создать дескриптор представления один раз: при запуске или после того, как источник анализирует достаточное количество исходных данных для определения содержимого. Метод [**креатепресентатиондескриптор**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasource-createpresentationdescriptor) должен возвращать копию дескриптора презентации. Чтобы создать копию, вызовите [**имфпресентатиондескриптор:: Clone**](/windows/desktop/api/mfidl/nf-mfidl-imfpresentationdescriptor-clone). Возврат копии не дает клиенту изменять состояние исходного дескриптора презентации, например атрибуты или выбор потока. Однако следует иметь в виду, что **клон** создает неполную копию, поэтому клиент потенциально может изменять базовые дескрипторы потока.

## <a name="starting-the-media-source"></a>Запуск источника мультимедиа

Метод [**имфмедиасаурце:: Start**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasource-start) запускает источник мультимедиа или выполняет поиск новой позицией. Вызов метода **Start** вызывает *Поиск* , когда предыдущее состояние было приостановлено или запущено, и указано новое время начала. В противном случае метод **Start** вызывает *Запуск*. После завершения операции **запуска** отправьте следующие события.

1.  Отправка события [меневстреам](menewstream.md) для каждого нового потока, то есть каждого потока, который был выбран ранее, и теперь выбирается. Данные события являются указателем на поток.
2.  Отправляет событие [меупдатедстреам](meupdatedstream.md) для каждого ранее выбранного потока, который по-прежнему выбран. Данные события являются указателем на поток. (Не отправляйте событие для невыбранных потоков.)
3.  Если источник ищется, отправьте событие [месаурцесикед](mesourceseeked.md) . В противном случае отправьте событие [месаурцестартед](mesourcestarted.md) . Данные события — это время начала, указанное в методе [**Start**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasource-start) . Для события Месаурцестартед, если время начала равно VT \_ , установите атрибут " [**\_ Источник события MF" \_ \_ фактического \_ запуска**](mf-event-source-actual-start-attribute.md) для события. Значение атрибута — это фактическое время начала.
4.  Для каждого потока, если источник ищется, отправьте событие [местреамсикед](mestreamseeked.md) . В противном случае отправьте событие [местреамстартед](mestreamstarted.md) . Данные события — это время начала. (Источник мультимедиа может поставить в очередь событие в потоке, вызвав метод [**имфмедиаевентженератор:: куеуивент**](/windows/desktop/api/mfobjects/nf-mfobjects-imfmediaeventgenerator-queueevent) потока.)

Когда поток не выбран, завершите работу потока. В этом месте поток не должен ставить в очередь больше событий.

Формат времени для метода [**Start**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasource-start) указывается в параметре *пгуидтимеформат* . Стандартный формат времени, обозначенный **GUID \_ null**, равен 100-наносекундных единицам. Источник мультимедиа должен поддерживать этот формат времени.

### <a name="seeking"></a>Нужна

При поиске запрошенное начальное расположение может не попадать в точную границу выборки. Кроме того, для сжатого содержимого начальное расположение может находиться между опорными кадрами. Поток должен доставлять образцы из самой ранней точки, необходимой для создания несжатого образца в запрошенной начальной позиции. Для видео это означает, что начинается с предыдущего ключевого кадра. Конвейер отвечает за удаление дополнительных кадров из декодера, чтобы воспроизведение начиналось в запрошенное время.

Время начала, заданное в исходных событиях ([месаурцестартед](mesourcestarted.md), [месаурцесикед](mesourceseeked.md), [местреамстартед](mestreamstarted.md)и [местреамсикед](mestreamseeked.md)), является запрошенным временем начала (значение, заданное в методе [**Start**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasource-start) ), независимо от фактической начальной точки.

Например, предположим, что первые несколько кадров потока видео имеют следующие характеристики:



| Образец     | 1       | 2       | 3        | 4        |
|------------|---------|---------|----------|----------|
| Time       | 33 МС | 66 МС | 100 мс | 133 МС |
| Ключевой кадр? | Да     | Нет      | Нет       | Да      |



 

Если метод [**Start**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasource-start) вызывается со значением 100 миллисекунд, то источнику необходимо выводить видео, начиная с кадра 1, первого ключевого кадра до этого времени. Событие Start по-прежнему будет указывать в данных события 100 миллисекунд.

## <a name="pausing-the-media-source"></a>Приостановка источника мультимедиа

Метод [**имфмедиасаурце::P Аусе**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasource-pause) приостанавливает источник мультимедиа.

Пока источник приостановлен, поток может создавать новые примеры и сохранять их в очереди, но поток не доставляет образцы. Ниже приведены некоторые исключения из этого правила.

-   В активных источниках следует удалять данные при приостановке.
-   Если источник получает данные из сети, он может приостановить работу сервера.

Если клиент вызывает [**имфмедиастреам:: рекуестсампле**](/windows/desktop/api/mfidl/nf-mfidl-imfmediastream-requestsample) во время приостановки источника, запрос также помещается в очередь до тех пор, пока источник не будет запущен снова. Запросы не должны удаляться.

Приостановка может выполняться только в состоянии запуска. В противном случае [**приостановка**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasource-pause) должна возвращать **MF \_ E \_ Недопустимый \_ \_ переход состояния**.

## <a name="generating-source-data"></a>Создание исходных данных

Media Foundation использует *модель извлечения*, то есть потоки создают и доставляют образцы в ответ на запросы из конвейера. Поток может доставлять образцы при выполнении источника мультимедиа и выборе потока. Поток доставляет данные только в том случае, если клиент запрашивает новый пример.

### <a name="sample-requests"></a>Образец запросов

Клиент запрашивает новый пример, вызывая [**имфмедиастреам:: рекуестсампле**](/windows/desktop/api/mfidl/nf-mfidl-imfmediastream-requestsample). Ниже приведена последовательность операций.

1.  Клиент вызывает [**имфмедиастреам:: рекуестсампле**](/windows/desktop/api/mfidl/nf-mfidl-imfmediastream-requestsample). Аргумент — это указатель на необязательный объект *Token* , который клиент использует для отслеживания запроса. Клиент реализует токен. Токены должны предоставлять интерфейс **IUnknown** . Клиент также может передать указатель NULL вместо токена.
2.  Если клиент предоставил маркер, поток мультимедиа вызывает **AddRef** для маркера и помещает маркер в очередь по первому попервому поверху. Метод возвращает, а оставшиеся шаги выполняются асинхронно.

3.  Если доступны дополнительные данные, поток мультимедиа создает новый пример. (Этот шаг подробно описан в следующем разделе.)
4.  Поток мультимедиа извлекает первый токен из очереди.
5.  Если токен не равен **null**, поток мультимедиа задает атрибут [**\_ токена мфсампликстенсион**](mfsampleextension-token-attribute.md) в образце носителя. Значение атрибута является указателем на маркер.
6.  Поток мультимедиа отправляет событие [мемедиасампле](memediasample.md) . Данные события являются указателем на интерфейс [**имфсампле**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) образца.
7.  Если клиент предоставил маркер, поток мультимедиа вызывает метод **Release** для объекта Token.

Если поток мультимедиа не может выполнить запрос [**рекуестсампле**](/windows/desktop/api/mfidl/nf-mfidl-imfmediastream-requestsample) клиента, он извлекает маркер из очереди и вызывает **выпуск** для маркера, но не отправляет событие [мемедиасампле](memediasample.md) .

Клиент может использовать маркер для наблюдения за состоянием запроса. Когда клиент получает событие [мемедиасампле](memediasample.md) , он может получить маркер из примера и сопоставить его с исходным запросом. Клиент также может использовать токен для определения, удалил ли источник мультимедиа запрос. Если счетчик ссылок маркера становится равным нулю, а поток мультимедиа не отправляет событие Мемедиасампле, это означает, что запрос был удален.

В описанных здесь действиях предполагается, что метод [**рекуестсампле**](/windows/desktop/api/mfidl/nf-mfidl-imfmediastream-requestsample) реализован как асинхронная операция. Если метод является синхронным, то не нужно помещаться в очередь маркера запроса. Однако если создание данных занимает значительное время, рекомендуется асинхронный подход, например, если источник считывает данные из байтового потока.

Поток отвечает за буферизацию всех данных, которые накапливаются между вызовами [**рекуестсампле**](/windows/desktop/api/mfidl/nf-mfidl-imfmediastream-requestsample).

Когда поток мультимедиа достигает конца потока, он отправляет событие [миндофстреам](meendofstream.md) после последней выборки. После завершения каждого потока источник мультимедиа отправляет событие [миндофпресентатион](meendofpresentation.md) . После того как поток мультимедиа отправит событие Миндофстреам, метод [**рекуестсампле**](/windows/desktop/api/mfidl/nf-mfidl-imfmediastream-requestsample) возвращает **MF- \_ е \_ конец \_ \_ потока** до перезапуска источника.

### <a name="allocating-samples"></a>Выделение выборок

Когда поток готов к заполнению ожидающего запроса образца, он создает новый пример и добавляет в образец один или несколько буферов мультимедиа. Дополнительные сведения о создании буферов мультимедиа см. в разделе [буферы мультимедиа](media-buffers.md).

Поток должен задать отметку времени и длительность, если она известна. Метка времени относится к источнику. В большинстве случаев начало содержимого соответствует отметке времени, равной нулю. Например, если источник считывает данные из файла мультимедиа, то начало файла будет иметь отметку времени, равную нулю.

Метка времени в образце не обязательно равна времени презентации. Сеанс мультимедиа преобразуется из исходного времени в время представления. Для сжатых данных поток должен создать данные, начиная с ближайшего ключевого кадра до времени начала. Это позволяет декодеру доставлять фрейм, отображаемый в запрошенном времени начала. (В противном случае декодеру придется дождаться следующего ключевого кадра.)

Если скорость воспроизведения выше, чем 1,0, то в конвейере корректируется частота часов представления. Источник не корректирует отметки времени для выборок.

Источник может задавать дополнительные сведения о примере, задавая атрибуты. Список образцов атрибутов см. в разделе [Sample Attributes](sample-attributes.md).

### <a name="gaps-in-the-stream"></a>Пробелы в потоке

Если поток содержит зазор значительной длины, рекомендуется, чтобы поток отправлял событие [местреамтикк](mestreamtick.md) . Это событие уведомляет клиента о том, что образец отсутствует. Данные события — это отметка времени отсутствующего примера в единицах измерения 100-наносекундных (**VT \_ i8**). Это событие может сохранять нисходящие компоненты из ожидания для выборки, которые не будут поступать. Поток может отправить столько событий Местреамтикк, сколько необходимо, чтобы охватить разрыв в потоке.

## <a name="shutting-down-the-media-source"></a>Завершение работы источника мультимедиа

Когда клиент выполняется с помощью источника мультимедиа, он вызывает [**имфмедиасаурце:: Shutdown**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasource-shutdown). Внутри этого метода источник мультимедиа должен нарушить все циклические ссылки. Как правило, между источником мультимедиа и потоками мультимедиа будут использоваться циклические ссылки.

Если вы используете очередь событий для реализации [**имфмедиаевентженератор**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediaeventgenerator), вызовите [**Имфмедиаевенткуеуе:: Shutdown**](/windows/desktop/api/mfobjects/nf-mfobjects-imfmediaeventqueue-shutdown) в очереди событий. Этот метод завершает работу очереди событий и сигнализирует любому вызывающему объекту, который в данный момент ожидает события.

После завершения работы все методы в источнике возвращают **MF \_ E \_ Shutdown**, за исключением методов **IUnknown** .

## <a name="live-sources"></a>Активные источники

Начиная с Windows 7, Media Foundation автоматически поддерживает устройства видеозаписи аудио и видео. Для видео устройство должно предоставить минидриверу ядра (KS) в категории видеозаписи. Media Foundation использует путь PnP для перечисления устройства. Для аудио Media Foundation использует API устройства Windows мультимедиа (Ммдевице) для перечисления устройств конечных точек аудио. Если устройство соответствует этим критериям, нет необходимости реализовывать пользовательский источник мультимедиа.

Однако может потребоваться реализовать пользовательский источник мультимедиа для какого-либо другого типа устройства или другого источника данных в режиме реального времени. Существует лишь несколько различий между источником Live и другими источниками мультимедиа:

-   В методе [**имфмедиасаурце::**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasource-getcharacteristics) -Methods возвратите флаг **мфмедиасаурце в \_ \_ режиме реального времени** .
-   Первый пример должен иметь отметку времени, равную нулю.
-   Состояния событий и потоковой передачи обрабатываются так же, как источники мультимедиа, за исключением приостановленного состояния.
-   При приостановке не следует ставить в очередь образцы. Удалите все данные, созданные при приостановке.
-   Активные источники обычно не поддерживают поиск, обратную воспроизведение или управление скоростью.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Источники мультимедиа](media-sources.md)
</dt> <dt>

[Учебник. запись пользовательского источника мультимедиа](tutorial--writing-a-custom-media-source.md)
</dt> </dl>

 

 



