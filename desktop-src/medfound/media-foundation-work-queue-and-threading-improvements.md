---
description: В этом разделе описаны улучшения в Windows 8 для рабочих очередей и работе с потоками на платформе Microsoft Media Foundation.
ms.assetid: 9E2A1D94-BF82-488E-8297-D524683ABE17
title: Усовершенствования рабочей очереди и потоков
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 07b307cb00316696e075e9e9cc2a138e98e149be
ms.sourcegitcommit: c16214e53680dc71d1c07111b51f72b82a4512d8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "104081722"
---
# <a name="work-queue-and-threading-improvements"></a>Усовершенствования рабочей очереди и потоков

В этом разделе описаны улучшения в Windows 8 для рабочих очередей и работе с потоками на платформе Microsoft Media Foundation.

-   [Поведение Windows 7](#windows-7-behavior)
    -   [Рабочие очереди](#work-queues)
    -   [Поддержка MMCSS](#mmcss-support)
    -   [имфреалтимеклиент](#imfrealtimeclientex)
-   [Улучшения Windows 8](#windows-8-improvements)
    -   [Многопоточные рабочие очереди](#multithreaded-work-queues)
    -   [Рабочие очереди общей задачи](#shared-task-work-queues)
    -   [Очередь ожидания](#wait-queue)
    -   [Усовершенствования поддержки MMCSS](#enhancements-to-mmcss-support)
    -   [имфреалтимеклиентекс](#imfrealtimeclientex)
    -   [Ветви топологии](#topology-branches)
-   [Рекомендации](#recommendations)
-   [Сводка](#summary)
-   [См. также](#related-topics)

## <a name="windows-7-behavior"></a>Поведение Windows 7

В этом разделе приводится краткое описание поведения Media Foundation рабочих очередей в Windows 7.

### <a name="work-queues"></a>Рабочие очереди

Платформа Media Foundation создает несколько стандартных рабочих очередей. В качестве общего использования приложения задокументировано только два.

-   **\_стандартная очередь обратного вызова мфасинк \_ \_**
-   **\_ \_ функция long в очереди обратного вызова мфасинк \_ \_**

Приложение или компонент может распределять новые рабочие очереди путем вызова [**мфаллокатеворккуеуе**](/windows/desktop/api/mfapi/nf-mfapi-mfallocateworkqueue) или [**мфаллокатеворккуеуикс**](/windows/desktop/api/mfapi/nf-mfapi-mfallocateworkqueueex). Функция **мфаллокатеворккуеуикс** определяет два типа рабочей очереди:

-   **MF \_ Стандартный \_ ворккуеуе** создает рабочую очередь без цикла обработки сообщений.
-   **MF \_ ОКНО \_ ворккуеуе** создает рабочую очередь с циклом обработки сообщений.

Чтобы поместить рабочий элемент в очередь, вызовите [**мфпутворкитем**](/windows/desktop/api/mfapi/nf-mfapi-mfputworkitem) или [**мфпутворкитемекс**](/windows/desktop/api/mfapi/nf-mfapi-mfputworkitemex). Платформа выполняет рабочий элемент, вызывая предоставляемую вызывающим объектом реализацию [**имфасинккаллбакк**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback). В Windows 7 и более ранних версиях платформа создает по одному потоку на рабочую очередь.

### <a name="mmcss-support"></a>Поддержка MMCSS

Служба управления персоналом [класса мультимедиа](../procthread/multimedia-class-scheduler-service.md) (MMCSS) управляет приоритетами потоков, чтобы мультимедийные приложения могли получать регулярные срезы времени ЦП, не запрещая ресурсы ЦП приложениям с более низким приоритетом. Служба MMCSS определяет набор *задач* с разными профилями использования ЦП. Когда поток присоединяется к задаче MMCSS, Служба MMCSS устанавливает приоритет потока на основе нескольких факторов:

-   Базовый приоритет задачи, заданный в реестре.
-   Относительный приоритет потока, который задается во время выполнения путем вызова [**авсетммсреадприорити**](/windows/win32/api/avrt/nf-avrt-avsetmmthreadpriority).
-   Различные характеристики времени выполнения, например, находится ли приложение на переднем плане, и сколько времени ЦП потребляется потоками в каждом классе MMCSS.

Приложение может зарегистрировать рабочую очередь с помощью MMCSS, вызвав [**мфбегинрегистерворккуеуевисммксс**](/windows/desktop/api/mfapi/nf-mfapi-mfbeginregisterworkqueuewithmmcss). Эта функция принимает идентификатор рабочей очереди, класс MMCSS (имя задачи) и идентификатор задачи MMCSS. Внутри он вызывает [**авсетммсреадчарактеристикс**](/windows/win32/api/avrt/nf-avrt-avsetmmthreadcharacteristicsa) с именем задачи и идентификатором задачи. После регистрации рабочей очереди в службе MMCSS можно получить идентификатор класса и задачи, вызвав [**мфжетворккуеуеммксскласс**](/windows/desktop/api/mfapi/nf-mfapi-mfgetworkqueuemmcssclass) и [**мфжетворккуеуеммксстаскид**](/windows/desktop/api/mfapi/nf-mfapi-mfgetworkqueuemmcsstaskid).

[Сеанс мультимедиа](media-session.md) обеспечивает более высокий уровень доступа к этим API через интерфейс [**имфворккуеуесервицес**](/windows/desktop/api/mfidl/nn-mfidl-imfworkqueueservices) . Этот интерфейс предоставляет два основных метода:

| Метод                                                                                                            | Описание                                                                                                                                                                                                                                                                                   |
|-------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [**бегинрегистерплатформворккуеуевисммксс**](/windows/desktop/api/mfidl/nf-mfidl-imfworkqueueservices-beginregisterplatformworkqueuewithmmcss)   | Регистрирует рабочую очередь с помощью задачи MMCSS. Этот метод по сути является тонкой оболочкой для [**мфбегинрегистерворккуеуевисммксс**](/windows/desktop/api/mfapi/nf-mfapi-mfbeginregisterworkqueuewithmmcss), но вы можете передать **значение \_ очереди ответного вызова мфасинк \_ \_ ALL** , чтобы зарегистрировать все рабочие очереди платформы одновременно. |
| [**бегинрегистертопологиворккуеуесвисммксс**](/windows/desktop/api/mfidl/nf-mfidl-imfworkqueueservices-beginregistertopologyworkqueueswithmmcss) | Регистрирует ветвь топологии с рабочей очередью.                                                                                                                                                                                                                                         |



 

Чтобы зарегистрировать ветвь топологии, выполните следующие действия.

1.  Задайте атрибут [ \_ \_ \_ ID MF топоноде ворккуеуе](mf-toponode-workqueue-id-attribute.md) в исходном узле ветви. Используйте любое значение, определенное приложением.
2.  При необходимости задайте **\_ \_ \_ \_ класс MMCSS топоноде ворккуеуе** , чтобы присоединить рабочую очередь к задаче MMCSS.
3.  Вызовите [**бегинрегистертопологиворккуеуесвисммксс**](/windows/desktop/api/mfidl/nf-mfidl-imfworkqueueservices-beginregistertopologyworkqueueswithmmcss) в разрешенной топологии.

Сеанс мультимедиа выделяет новую рабочую очередь для каждого уникального значения [ \_ топоноде \_ ворккуеуе \_ ID](mf-toponode-workqueue-id-attribute.md). Для каждой ветви топологии асинхронные операции конвейера выполняются в рабочей очереди, назначенной ветви.

### <a name="imfrealtimeclient"></a>имфреалтимеклиент

Интерфейс [**имфреалтимеклиент**](/windows/desktop/api/mfidl/nn-mfidl-imfrealtimeclient) предназначен для компонентов конвейера, которые либо создают собственные потоки, либо используют рабочие очереди для асинхронных операций. Сеанс мультимедиа использует этот интерфейс для уведомления компонента конвейера о правильном поведении, как показано ниже.

-   Если компонент конвейера создает рабочий поток, метод [**имфреалтимеклиент:: регистерсреадс**](/windows/desktop/api/mfidl/nf-mfidl-imfrealtimeclient-registerthreads) уведомляет компонент, к которому присоединяется класс MMCSS.
-   Если компонент конвейера использует рабочую очередь, метод [**имфреалтимеклиент:: сетворккуеуе**](/windows/desktop/api/mfidl/nf-mfidl-imfrealtimeclient-setworkqueue) сообщает компоненту, какую рабочую очередь следует использовать.

Как правило, компонент конвейера использует либо поток, либо рабочую очередь для выполнения асинхронных задач, но не то и другое одновременно.

## <a name="windows-8-improvements"></a>Улучшения Windows 8

### <a name="multithreaded-work-queues"></a>Многопоточные рабочие очереди

В Windows 8 Media Foundation поддерживает новый тип рабочей очереди, называемой *многопоточной очередью*. В многопоточной очереди для отправки рабочих элементов используется пул системных потоков. Многопоточные очереди масштабируются лучше, чем предыдущие однопотоковые очереди. Например,

-   Несколько компонентов могут совместно использовать многопоточную очередь, не блокируя друг друга, требуя создания меньшего числа потоков.

-   Рабочие элементы оптимизируются, чтобы избежать переключения контекста, если событие уже задано. Это более эффективно, чем создание собственных потоков для ожидания событий.

При использовании [**имфреалтимеклиентекс**](/windows/desktop/api/mfidl/nn-mfidl-imfrealtimeclientex)приложения должны избегать использования потоков и вместо этого использовать рабочие очереди. Для этого приложения должны реализовать [**сетворккуеуикс**](/windows/desktop/api/mfidl/nf-mfidl-imfrealtimeclientex-setworkqueueex) и не использовать [**регистерсреадс**](/windows/desktop/api/mfidl/nf-mfidl-imfrealtimeclientex-registerthreadsex) и [**унрегистерсреадс**](/windows/desktop/api/mfidl/nf-mfidl-imfrealtimeclientex-unregisterthreads).

При инициализации Media Foundationной платформы создается многопоточная очередь с Мфасинк идентификатором **\_ \_ очереди \_ ответного вызова**.

Многопоточная очередь не выполняет сериализацию рабочих элементов. Каждый раз, когда поток из пула потоков становится доступным, отправляется следующий рабочий элемент в очереди. Вызывающий объект должен обеспечить правильную сериализацию работы. Чтобы упростить это, Media Foundation определяет *последовательную рабочую очередь*. Последовательная очередь создает оболочку для другой рабочей очереди, но гарантирует полное сериализованное выполнение. Следующий элемент в очереди не отправляется, пока не завершится предыдущий элемент.

Следующий код создает очередь сериализатора для многопоточной очереди платформы.


```C++
DWORD workQueueID;
hr = MFAllocateSerialWorkQueue(MFASYNC_CALLBACK_QUEUE_MULTITHREADED, &workQueueID); 
```



Несколько последовательных очередей могут переносить одну и ту же многопоточные очереди. Затем последовательные очереди используют один и тот же пул потоков, а сериализованное выполнение применяется в каждой очереди.

Стандартные рабочие очереди, существовавшие до Windows 8, теперь реализованы в виде последовательных рабочих очередей, которые создают оболочку для многопоточной очереди платформы. Это изменение сохраняет обратную совместимость.

### <a name="shared-task-work-queues"></a>Рабочие очереди общей задачи

Для правильной работы с планировщиком ядра необходимо наличие одной многопоточной рабочей очереди для каждой используемой задачи MMCSS. Платформа Media Foundation выделяет эти данные по мере необходимости, по одному на каждую задачу MMCSS на процесс. Чтобы получить общую рабочую очередь для определенной задачи MMCSS, вызовите [**мфлоккшаредворккуеуе**](/windows/desktop/api/mfapi/nf-mfapi-mflocksharedworkqueue) и укажите имя задачи. Функция ищет имя задачи в таблице. Если для этой задачи еще не существует рабочей очереди, функция выделяет новую рабочую очередь MT и немедленно присоединяет ее к задаче MMCSS. Если для этой задачи уже существует Рабочая очередь, функция возвращает идентификатор существующей рабочей очереди.

### <a name="wait-queue"></a>Очередь ожидания

*Очередь ожидания* — это специальная рабочая очередь платформы, которая ожидает оповещения о событиях. Если компоненту требуется дождаться сигнала события, он может использовать очередь ожидания вместо создания рабочего потока для ожидания события.

Чтобы использовать очередь ожидания, вызовите [**мфпутваитингворкитем**](/windows/desktop/api/mfapi/nf-mfapi-mfputwaitingworkitem). Параметры включают в себя маркер события и указатель [**имфасинкресулт**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasyncresult) . Когда событие получает сигнал, очередь ожидания вызывает обратный вызов. Очередь ожидания одной платформы. приложения не могут создавать собственные очереди ожидания.

### <a name="enhancements-to-mmcss-support"></a>Усовершенствования поддержки MMCSS

Следующие новые функции Media Foundation платформы относятся к MMCSS.



| Функция                                                                           | Описание                                                                                                                                                                                                                                                                                                                                                                                           |
|------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [**мфбегинрегистерворккуеуевисммкссекс**](/windows/desktop/api/mfapi/nf-mfapi-mfbeginregisterworkqueuewithmmcssex) | Регистрирует рабочую очередь с помощью MMCSS. Эта функция включает параметр для указания относительного приоритета потока. На внутреннем уровне это значение преобразуется в вызов [**авсетммсреадприорити**](/windows/win32/api/avrt/nf-avrt-avsetmmthreadpriority).                                                                                                                                                                               |
| [**мфжетворккуеуеммкссприорити**](/windows/desktop/api/mfapi/nf-mfapi-mfgetworkqueuemmcsspriority)                 | Запрашивает приоритет рабочей очереди.                                                                                                                                                                                                                                                                                                                                                                 |
| [**мфрегистерплатформвисммксс**](/windows/desktop/api/mfapi/nf-mfapi-mfregisterplatformwithmmcss)                 | Регистрирует все рабочие очереди платформы с помощью задачи MMCSS. Эта функция аналогична методу [**имфворккуеуесервицес:: бегинрегистерплатформворккуеуевисммксс**](/windows/desktop/api/mfidl/nf-mfidl-imfworkqueueservices-beginregisterplatformworkqueuewithmmcss) , но ее можно использовать без создания экземпляра сеанса мультимедиа. Кроме того, функция включает параметр для указания приоритета базового потока. |



 

Приложения, использующие сеанс мультимедиа, должны установить атрибут [ \_ класса топоноде \_ ворккуеуе \_ MMCSS \_ ](mf-toponode-workqueue-mmcss-class-attribute.md) в значение Audio для ветви подготовки звука. Задайте для атрибута значение "Воспроизведение" для ветви отрисовки видео.

### <a name="imfrealtimeclientex"></a>имфреалтимеклиентекс

Интерфейс [**имфреалтимеклиентекс**](/windows/desktop/api/mfidl/nn-mfidl-imfrealtimeclientex) для замены имфреалтимеклиент для компонентов конвейера, выполняющих асинхронные операции.



| Метод                                                             | Описание                                                                                                                                                                                                                    |
|--------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [**регистерсреадсекс**](/windows/desktop/api/mfidl/nf-mfidl-imfrealtimeclientex-registerthreadsex) | Уведомляет компонент о необходимости регистрации своих потоков с помощью MMCSS. Этот метод эквивалентен [**имфреалтимеклиент:: регистерсреадс**](/windows/desktop/api/mfidl/nf-mfidl-imfrealtimeclient-registerthreads), но добавляет параметр для приоритета базового потока. |
| [**сетворккуеуикс**](/windows/desktop/api/mfidl/nf-mfidl-imfrealtimeclientex-setworkqueueex)       | Уведомляет компонент об использовании определенной рабочей очереди. Этот метод эквивалентен [**имфреадтимеклиент:: сетворккуеуе**](/windows/desktop/api/mfidl/nf-mfidl-imfrealtimeclient-setworkqueue), но добавляет параметр для приоритета рабочего элемента.               |
| [**унрегистерсреадс**](/windows/desktop/api/mfidl/nf-mfidl-imfrealtimeclientex-unregisterthreads) | Уведомляет компонент о необходимости отмены регистрации своих потоков из MMCSS. Этот метод идентичен методу [**имфреалтимеклиент:: унрегистерсреадс**](/windows/desktop/api/mfidl/nf-mfidl-imfrealtimeclient-unregisterthreads) .                                       |



 

Компоненты конвейера должны использовать рабочие очереди и не должны создавать рабочие потоки по следующим причинам.

-   Рабочие очереди лучше масштабировать, так как они используют пулы потоков ОС.
-   Платформа обрабатывает сведения о регистрации рабочих очередей с помощью MMCSS.
-   Рабочий поток может легко вызвать взаимоблокировку, которую трудно отладить.

Кроме того, рекомендуется использовать рабочую очередь сериализатора, если необходимо сериализовать асинхронные операции.

### <a name="topology-branches"></a>Ветви топологии

Если атрибут [ \_ \_ \_ \_ класса MMCSS топоноде ворккуеуе (MF](mf-toponode-workqueue-mmcss-class-attribute.md) ) регистрирует ветвь топологии с помощью MMCSS, в Windows 8 сеанс мультимедиа использует рабочие очереди общего MT. В более ранних версиях Windows сеанс мультимедиа выделил новую рабочую очередь.

Для регистрации ветви топологии с помощью MMCSS определены два новых атрибута.



| attribute                                                                            | Описание                         |
|--------------------------------------------------------------------------------------|-------------------------------------|
| [\_ТОПОНОДЕ MF \_ ворккуеуе \_ с \_ приоритетом MMCSS](mf-toponode-workqueue-mmcss-priority.md) | Указывает приоритет базового потока. |
| [\_ \_ \_ приоритет элемента MF топоноде \_ ворккуеуе](mf-toponode-workqueue-item-priority.md)   | Указывает приоритет рабочего элемента.   |



 

## <a name="recommendations"></a>Рекомендации

-   Приложения, использующие сеанс мультимедиа, должны задать [для \_ \_ \_ \_ класса MMCSS топоноде ворккуеуе](mf-toponode-workqueue-mmcss-class-attribute.md) для передачи звука значение "Audio" для ветви подготовки к просмотру и "Воспроизведение" для ветви отрисовки видео.
-   Приложения, использующие сеанс мультимедиа, должны вызывать [**имфворккуеуесервицес:: бегинрегистертопологиворккуеуесвисммксс**](/windows/desktop/api/mfidl/nf-mfidl-imfworkqueueservices-beginregistertopologyworkqueueswithmmcss) в топологии.
-   Для компонентов конвейера рекомендуется использовать рабочие очереди вместо рабочих потоков. Если компонент использует либо рабочие очереди, либо рабочие потоки, реализуйте [**имфреалтимеклиентекс**](/windows/desktop/api/mfidl/nn-mfidl-imfrealtimeclientex).
-   Не создавайте частные рабочие очереди, так как это нарушает назначение рабочих очередей платформы. Используйте многопотоковую очередь платформы или последовательную очередь, которая создает оболочку для многопоточной очереди платформы.
-   Если необходимо сериализовать асинхронные операции, используйте последовательную очередь.

## <a name="summary"></a>Сводка

Следующие Media Foundation API платформы, относящиеся к потокам и рабочим очередям, являются новыми для Windows 8.

-   [\_ \_ \_ приоритет элемента MF топоноде \_ ворккуеуе](mf-toponode-workqueue-item-priority.md)
-   [\_ТОПОНОДЕ MF \_ ворккуеуе \_ с \_ приоритетом MMCSS](mf-toponode-workqueue-mmcss-priority.md)
-   [**мфаллокатесериалворккуеуе**](/windows/desktop/api/mfapi/nf-mfapi-mfallocateserialworkqueue)
-   [**мфбегинрегистерворккуеуевисммкссекс**](/windows/desktop/api/mfapi/nf-mfapi-mfbeginregisterworkqueuewithmmcssex)
-   [**мфжетворккуеуеммкссприорити**](/windows/desktop/api/mfapi/nf-mfapi-mfgetworkqueuemmcsspriority)
-   [**мфпутваитингворкитем**](/windows/desktop/api/mfapi/nf-mfapi-mfputwaitingworkitem)
-   [**MFPutWorkItem2**](/windows/desktop/api/mfapi/nf-mfapi-mfputworkitem2)
-   [**MFPutWorkItemEx2**](/windows/desktop/api/mfapi/nf-mfapi-mfputworkitemex2)
-   [**мфрегистерплатформвисммксс**](/windows/desktop/api/mfapi/nf-mfapi-mfregisterplatformwithmmcss)
-   [**мфунрегистерплатформфромммксс**](/windows/desktop/api/mfapi/nf-mfapi-mfunregisterplatformfrommmcss)
-   [**мфлоккшаредворккуеуе**](/windows/desktop/api/mfapi/nf-mfapi-mflocksharedworkqueue)
-   [**имфреалтимеклиентекс**](/windows/desktop/api/mfidl/nn-mfidl-imfrealtimeclientex)

## <a name="related-topics"></a>См. также

<dl> <dt>

[Рабочие очереди](work-queues.md)
</dt> </dl>

 

 
