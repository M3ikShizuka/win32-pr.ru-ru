---
description: Media Foundation предоставляет источник мультимедиа ASF, который приложение может использовать для представления файла ASF на уровне конвейера архитектуры.
ms.assetid: a2d2b382-d666-4a37-a6a9-0b839fbfbec3
title: Источник носителя ASF
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6b3222f32649aa5cb3f4d1d4688a9f7fb7402167e7831377fd8b04d6c879e23b
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "117881155"
---
# <a name="asf-media-source"></a>Источник носителя ASF

Media Foundation предоставляет источник мультимедиа ASF, который приложение может использовать для представления файла ASF на уровне конвейера архитектуры.

Чтобы воспроизвести файл ASF, приложение может использовать источник мультимедиа ASF для передачи данных в конвейер воспроизведения. В сценарии кодирования приложение может использовать источник мультимедиа ASF в качестве источника для преобразования в другой формат или для преобразования файла с более высоким значением битовой скорости в файл меньшей скорости без изменения формата. На уровне конвейера должен использоваться источник носителя ASF, то есть приложение должно использовать сеанс мультимедиа для управления операцией. Этот уровень доступа позволяет приложениям получать события во время выполнения сеанса мультимедиа. Чтобы получить доступ к содержимому ASF на более низком уровне, приложение должно использовать компоненты ASF уровня Вмконтаинер.

Источник мультимедиа ASF реализует интерфейс [**имфмедиасаурце**](/windows/desktop/api/mfidl/nn-mfidl-imfmediasource) , который является универсальным интерфейсом для источников мультимедиа в Media Foundation. Как и любой другой источник мультимедиа, источник мультимедиа ASF предоставляет дескриптор представления, в основном описывающий объект заголовка ASF. Кроме того, источник мультимедиа ASF предоставляет дескрипторы потоков, представляющие каждый поток в мультимедийном содержимом. Дополнительные сведения см. в разделе [Структура файлов ASF](asf-file-structure.md).

-   [Создание источника мультимедиа ASF](#creating-the-asf-media-source)
-   [Параметры конфигурации для источника мультимедиа ASF](#configuration-settings-for-the-asf-media-source)
-   [Модель объекта источника ASF Media](#asf-media-source-object-model)
-   [Службы источников ASF Media](#asf-media-source-services)
    -   [Преобразование времени и времени](#timecode-translation)
-   [Связанные темы](#related-topics)

## <a name="creating-the-asf-media-source"></a>Создание источника мультимедиа ASF

Чтобы создать источник мультимедиа ASF, приложение должно использовать [сопоставитель источника](source-resolver.md). Чтобы создать источник мультимедиа ASF, приложение должно предоставить источник, для которого сопоставитель источника создает источник мультимедиа ASF. Сведения об источнике должны быть предоставлены либо указанием URL-адреса исходного файла, либо потока байтов, содержащего носитель. Если приложение выбирает создание источника мультимедиа ASF путем указания URL-адреса, оно должно вызывать либо [**имфсаурцересолвер:: креатеобжектфромурл**](/windows/desktop/api/mfidl/nf-mfidl-imfsourceresolver-createobjectfromurl) для синхронной операции, либо **Имфсаурцересолвер:: Begin... Ендкреатеобжектфромурл** для асинхронной операции. Процесс создания источника мультимедиа из потока байтов аналогичен. Приложение должно вызывать либо [**имфсаурцересолвер:: креатеобжектфромбитестреам**](/windows/desktop/api/mfidl/nf-mfidl-imfsourceresolver-createobjectfrombytestream) для синхронной операции, либо **Имфсаурцересолвер:: Begin... Ендкреатеобжектфромбитестреам** для асинхронной операции. Эти вызовы должны указать MF \_ Resolution \_ медиасаурце в параметре *dwFlags* . Дополнительные сведения об использовании этого флага см. в разделе Использование сопоставителя источников.

Если в приложении указан URL-адрес для локального файла, строка URL-адреса может содержать путь к файлу мультимедиа или префикс "file:". Расширение имени файла должно быть ". ASF", ". WM", "L". WMA "или". wmv ". Для файла ASF в сети сопоставитель источников создает [сетевой источник](network-source-features.md), использующий источник мультимедиа ASF.

Во время создания объекта сопоставитель источника ищет список обработчиков схем и обработчиков байтов в системном реестре и загружает ближайший обработчик, который может анализировать содержимое мультимедиа, а также создавать объект источника мультимедиа, расположенный под. Независимо от метода, используемого для создания источника мультимедиа (URL-адрес и поток байтов), сопоставитель источников создает поток байтов и считывает содержимое исходного носителя в поток байтов. Дополнительные сведения см. в разделе [обработчики схем и обработчики Byte-Stream](scheme-handlers-and-byte-stream-handlers.md).

Пример кода для создания источника мультимедиа см. [в разделе Использование сопоставителя источников](using-the-source-resolver.md).

## <a name="configuration-settings-for-the-asf-media-source"></a>Параметры конфигурации для источника мультимедиа ASF

Сопоставитель источников запрашивает возможности базового потока байтов и определяет операции, разрешенные для вновь созданного источника носителя. Одна из таких возможностей — Поиск. Если операция поиска разрешена, приложение может указать режим поиска, используемый источником мультимедиа при поиске в определенной точке презентации.

Приложение может задать режим поиска, используемый источником мультимедиа во время создания объекта. После создания источника ASF Media с указанным режимом поиска его нельзя изменить в источнике мультимедиа или динамически изменить во время презентации. Параметры поиска указываются как свойства в вызове приложения к соответствующим методам сопоставителя источника, которые используются для создания источника мультимедиа. Этот набор свойств задается в хранилище свойств и передается в параметр *ппропс* . Если эти свойства не передаются, источник мультимедиа будет работать с параметрами по умолчанию. Дополнительные сведения об установке этих свойств см. [в разделе Настройка источника мультимедиа](configuring-a-media-source.md).

Если поиск разрешен, источник мультимедиа ASF поддерживает следующие режимы поиска:

-   Точное Поиск: в этом режиме источник мультимедиа ASF использует объект индекса ASF файла ASF. Если файл не содержит объект index, то поиск отключается, а другой режим используется в зависимости от свойств, заданных приложением, заданных в источнике мультимедиа.
-   Приближенное Поиск: этот режим запрашивается приложением путем передачи [**мфпкэй \_ асфмедиасаурце \_ аппрокссик**](mfpkey-asfmediasource-approxseek-property.md) в хранилище свойств в соответствующие методы сопоставителя источника. Однако приближенное Поиск используется только в том случае, если поток байтов не поддерживает поиск на основе времени. В этом режиме источник мультимедиа определяет время начала, относительное времени поиска. Если файл ASF содержит объект индекса ASF, он используется для вычисления времени начала. Приблизительное Поиск менее точен, но быстрее, чем точное Поиск, поскольку время, затрачиваемое на подготовку первой выборки в предопределенном времени начала, выполняется быстрее.
-   Итеративное Поиск: чтобы установить этот режим, приложение должно установить свойство [мфпкэй \_ асфмедиасаурце \_ итеративесикифноиндекс](mfpkey-asfmediasource-iterativeseekifnoindex.md) . Итеративное Поиск — это алгоритм поиска позиции в ASF-файле, который не содержит объект индекса ASF. В этом режиме источник мультимедиа обоценивает приблизительную оценку точки поиска, считывая смещение байтового потока. Он использует ряд приближений, основанный на средней скорости, чтобы постепенно ближе к целевому времени поиска. (Алгоритм аналогичен двоичному поиску.) Итеративное Поиск может занять больше времени, чем поиск с помощью объекта index, поэтому по умолчанию он отключен. Если задать это свойство, используйте следующие свойства, чтобы задать параметры поиска: [мфпкэй \_ асфмедиасаурце \_ итеративесик \_ Max \_ Count](mfpkey-asfmediasource-iterativeseek-max-count.md)[мфпкэй \_ асфмедиасаурце \_ итеративесик \_ \_ в \_ миллисекундах](mfpkey-asfmediasource-iterativeseek-tolerance-in-millisecond.md). Эти свойства устанавливают максимальное число итераций и допуск соответственно. Алгоритм останавливается при достижении максимального числа итераций или при обнаружении пакета, расстояние от которого до времени поиска находится в пределах указанного значения.

В двух словах, приложение имеет возможность выбрать приближенное или итеративное Поиск, если ASF-файл не содержит объект индекса ASF.

## <a name="asf-media-source-object-model"></a>Модель объекта источника ASF Media

Источник мультимедиа ASF реализует интерфейс [**имфмедиасаурце**](/windows/desktop/api/mfidl/nn-mfidl-imfmediasource) и предоставляет следующие интерфейсы. Приложение может получить ссылку на эти интерфейсы, вызвав **имфмедиасаурце:: QueryInterface** в источнике медиа ASF.



| Интерфейс                                                | Описание                                                                                                                                        |
|----------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------|
| [**имфмедиасаурце**](/windows/desktop/api/mfidl/nn-mfidl-imfmediasource)                 | Требуется для всех источников мультимедиа.                                                                                                                    |
| [**имфмедиаевентженератор**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediaeventgenerator) | Требуется для всех источников мультимедиа. Позволяет приложениям получать события из источника мультимедиа через сеанс мультимедиа.                                 |
| [**имфжетсервице**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice)                   | Запрашивает источник мультимедиа для указанного интерфейса службы.                                                                                      |
| [**ипропертисторе**](/windows/win32/api/propsys/nn-propsys-ipropertystore)               | Возвращает и задает свойства источника мультимедиа. Каждое свойство содержит описательное имя и значение.                                               |
| [**имфметадата**](/windows/desktop/api/mfidl/nn-mfidl-imfmetadata)                       | Описание метаданных для файла ASF.                                                                                                           |
| [**имфметадатапровидер**](/windows/desktop/api/mfidl/nn-mfidl-imfmetadataprovider)       | Извлекает коллекцию метаданных либо для всей презентации, либо для одного потока в презентации.                                      |
| [**имфратесуппорт**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport)                 | Запрашивает поддерживаемый диапазон поддерживаемых частот воспроизведения, включая обратную воспроизведение.                                                                |
| [**имфратеконтрол**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol)                 | Возвращает или задает скорость воспроизведения.                                                                                                                    |
| [**имфтрустединпут**](/windows/desktop/api/mfidl/nn-mfidl-imftrustedinput)               | Получает значение ITA для каждого из потоков ASF, содержащихся в источнике.                                                                                  |
| [**имфпмпклиент**](/windows/desktop/api/mfidl/nn-mfidl-imfpmpclient)                     | Позволяет источнику мультимедиа получить указатель на интерфейс [**имфпмфост**](/windows/desktop/api/mfidl/nn-mfidl-imfpmphost) , который используется для создания объектов в процессе PMP. |
| [**имфтимекодетранслате**](/windows/desktop/api/mfidl/nn-mfidl-imftimecodetranslate)     | Выполняет преобразование кода времени между обществом изображений движения и телевизионными инженерами (SMPTE) и единицами времени 100 нс.                              |



 

## <a name="asf-media-source-services"></a>Службы источников ASF Media

Источник мультимедиа ASF предоставляет различные службы, областью действия которых является файл ASF. Чтобы получить указатель на определенную службу, приложение должно использовать один из следующих идентификаторов службы в вызове [**мфжетсервице**](/windows/desktop/api/mfidl/nf-mfidl-mfgetservice). Дополнительные сведения см. в разделе [интерфейсы служб](service-interfaces.md).



| Идентификатор службы               | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|----------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| \_ \_ Служба управления скоростью \_ MF       | Используя этот идентификатор, приложение может получить указатель на интерфейсы [**имфратесуппорт**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) или [**имфратеконтрол**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol) . Используя объект Rate support, реализованный источником мультимедиа, приложение может проверить, поддерживается ли определенная частота в базовом медиа-файле ASF, также получить самую быструю и самую низкую скорость. С помощью управляющего объекта Rate приложение может получить и задать скорость воспроизведения. Если в приложении указана скорость воспроизведения, источник медиа ASF сначала проверяет, находится ли запрошенная скорость в пределах пределов скорости (определяется быстрыми и медленными), а затем устанавливает скорость. Это не проверяет переменные условия, так как скорость может измениться в зависимости от пропускной способности сети. Дополнительные сведения см. в этой [контрольной частоте](rate-control.md). |
| \_ \_ служба поставщика метаданных \_ MF  | Используя этот идентификатор, приложение может получить указатель на интерфейс [**имфметадатапровидер**](/windows/desktop/api/mfidl/nn-mfidl-imfmetadataprovider) источника ASF Media. Этот интерфейс предоставляет доступ к сведениям о файле ASF, в частности, к объектам заголовка ASF и потокам, содержащимся в содержимом носителя. Сведения о заголовке предоставляются через атрибуты дескриптора представления, а сведения о потоке — через атрибуты дескриптора потока. Дополнительные сведения об этих атрибутах см. в разделе [атрибуты Media Foundation для объектов заголовка ASF](media-foundation-attributes-for-asf-header-objects.md). Помимо информации, предоставляемой с помощью атрибутов, также существуют описательные метаданные, которые устанавливаются в качестве свойств.                                                                                                 |
| \_ \_ Служба обработчика свойств MF \_   | Используя этот идентификатор, приложение может получить указатель на интерфейс [**ипропертисторе**](/windows/win32/api/propsys/nn-propsys-ipropertystore) источника ASF Media. Хранилище свойств содержит все метаданные, связанные с файлом ASF. этот идентификатор является новым в Windows 7 и заменяет \_ \_ службу поставщика метаданных MF \_ для получения свойств метаданных.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| \_Служба статистики \_ мфнетсаурце | Дополнительные сведения см. в разделе Получение статистики сети в [журнале клиента](client-logging.md).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| Служба времени код MF \_ \_            | Используя этот идентификатор, приложение может получить указатель на интерфейс [**имфтимекодетранслате**](/windows/desktop/api/mfidl/nn-mfidl-imftimecodetranslate) источника мультимедиа. Эта реализация может использоваться для выполнения переводов кода времени, таких как преобразование кода времени SMPTE в 100-Nano Second Units and Back.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |



 

### <a name="timecode-translation"></a>Преобразование времени и времени

Источник мультимедиа ASF предоставляет службу преобразования кода времени, которая позволяет приложению преобразовывать код времени SMPTE в ближайшее время презентации (в единицах 100 нс). И наоборот, приложение также может получить код времени для запрошенного времени презентации. Служба доступна через интерфейс [**имфтимекодетранслате**](/windows/desktop/api/mfidl/nn-mfidl-imftimecodetranslate) , который реализуется источником медиа ASF. Вызов метода для этого указателя интерфейса является асинхронным, который может выполняться из основного потока приложения без блокировки пользовательского интерфейса приложения.

Ниже описана процедура преобразования кода времени.

1.  Получите указатель на интерфейс [**имфтимекодетранслате**](/windows/desktop/api/mfidl/nn-mfidl-imftimecodetranslate) источника ASF Media, вызвав [**мфжетсервице**](/windows/desktop/api/mfidl/nf-mfidl-mfgetservice) и указав идентификатор **\_ \_ службы** времени в формате MF.
2.  Вызовите [**имфтимекодетранслате:: бегинконверттимекодетохнс**](/windows/desktop/api/mfidl/nf-mfidl-imftimecodetranslate-beginconverttimecodetohns) или [**Имфтимекодетранслате:: бегинконверснстотимекоде**](/windows/desktop/api/mfidl/nf-mfidl-imftimecodetranslate-beginconverthnstotimecode) и укажите время, которое должно быть переведено. Для **бегинконверттимекодетохнс** код времени должен быть указан в виде переменной [**пропвариант**](/windows/win32/api/propidl/ns-propidl-propvariant) с типом данных **VT \_ i8** . Для метода **бегинконверснстотимекоде** требуется время в 100-наносекундных единицах в качестве типа [**мфтиме**](mftime.md) .
3.  Завершите асинхронную операцию, вызвав [**имфтимекодетранслате:: ендконверттимекодетохнс**](/windows/desktop/api/mfidl/nf-mfidl-imftimecodetranslate-endconverttimecodetohns) или **Имфтимекодетранслате:: ендконверттимекодетохнс** соответствующим образом.

Во время создания источника мультимедиа сопоставитель источника создает байтовый поток для файла, из которого источник мультимедиа считывает содержимое ASF. Чтобы преобразования времени были успешными, поток байтов, связанный с файлом ASF, должен иметь возможность поиска. в противном случае приложение получает \_ ошибку MF E \_ BYTESTREAM \_ без \_ поиска из вызова **Begin...** . Еще одно требование к преобразованию времени заключается в том, что ASF-файл, представленный источником носителя ASF, должен иметь объекты-индексы ASF. Время презентации и коды времени извлекаются из объектов ASF index, которые поддерживают все индексы и соответствующие точки поиска для ASF-файла. Для преобразования кода во время презентации ASF-файл должен содержать простой объект index. для перевода времени во время представления кода ASF-файл должен иметь объект index. Операции преобразования зависят от базового *индексатора* (компонента вмконтаинер) для анализа и чтения объекта индекса, связанного с файлом ASF. Если файл не содержит объект index, приложение асинхронно получает \_ \_ код ошибки MF E No \_ индекса.

Чтобы перевести время, запрошенное приложением, источник мультимедиа перечисляет потоки в файле и находит поток, содержащий соответствующий объект индекса ASF. Если такой поток найден, источник мультимедиа анализирует пакеты ASF потока до тех пор, пока не будет достигнут правильный код времени. После нахождения правильного примера он извлекает соответствующее время презентации или код времени из примера и возвращает его вызывающему объекту.

### <a name="script-command-support"></a>Поддержка команды сценария

При создании топологии ASF, содержащей поток скрипта, в топологию добавляется узел потока скрипта. Этот узел будет отсылать Имфсамплес в соответствующее время. Имфсампле, предоставляемый исходным узлом скрипта, хранит данные в Имфмедиабуффер, связанном с примером. Вы можете вызвать Копитобуффер в примере, чтобы получить Имфмедиабуффер, а затем вызвать блокировку буфера для получения данных. 

Полезные данные потока сценария упаковываются в буфер в виде строки типа, за которой следует значение NULL, за которым следует Командная строка, за которой следует значение NULL. Строки имеют формат Юникод в формате ASF.

Например, полезная нагрузка может выглядеть следующим образом (где \ 0 означает нуль-символ):

*URL\0http://contoso.com\0*

*Text\0This — это caption\0*



## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Компоненты ASF уровня конвейера](pipeline-layer-asf-components.md)
</dt> <dt>

[Поддержка ASF в Media Foundation](asf-support-in-media-foundation.md)
</dt> </dl>

 

 
