---
description: Приемник файлов MPEG-4 создает файлы MP4.
ms.assetid: 069b8e72-d081-466e-ac8d-c3f81c8a6f35
title: Приемник файлов MPEG-4
ms.topic: reference
ms.date: 05/31/2018
ms.openlocfilehash: 92e0175a5c21cc9f7c0186f70b37a5f94f5bf12151e606a2a441b4c75919d7e8
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119102114"
---
# <a name="mpeg-4-file-sink"></a>Приемник файлов MPEG-4

Приемник файлов MPEG-4 создает файлы MP4. Дополнительные сведения о формате файла MP4 см. в следующих документах по стандартам:

-   ISO/IEC 14496-12: *информационные технологии — Программирование звуковых визуальных объектов — часть 12: формат файла основного носителя ISO*
-   ISO/IEC 14496-14: *информационные технологии — Программирование звуковых визуальных объектов — часть 14: формат файла MP4*

> [!Note]  
> (Эти ресурсы могут быть недоступны в некоторых языках и странах.)

 

Приемник файлов MPEG-4 не инкапсулирует функциональность кодирования.

Чтобы создать приемник файлов MPEG-4, вызовите функцию [**MFCreateMPEG4MediaSink**](/windows/desktop/api/mfidl/nf-mfidl-mfcreatempeg4mediasink) . Приемник файлов MPEG-4 предоставляет следующие интерфейсы через **QueryInterface**:

-   [**имфклоккстатесинк**](/windows/desktop/api/mfidl/nn-mfidl-imfclockstatesink)
-   [**имффинализаблемедиасинк**](/windows/desktop/api/mfidl/nn-mfidl-imffinalizablemediasink)
-   [**имфжетсервице**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice)
-   [**имфмедиаевентженератор**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediaeventgenerator)
-   [**имфмедиасинк**](/windows/desktop/api/mfidl/nn-mfidl-imfmediasink)

## <a name="sample-description-box"></a>Пример окна описания

MP4 — это расширяемый формат контейнеров. Спецификация MP4 не определяет фиксированную структуру для описания типов мультимедиа в контейнере MP4. Вместо этого он определяет иерархию объектов, позволяющую определять пользовательские структуры для каждого формата. Описание формата хранится в поле "пример описания" ("стсд") для каждого потока. В поле Описание примера содержится список образцов записей. Для каждой записи примера 4-байтовый код, аналогичный набору FOURCC, определяет структуру формата.

Приемник файлов MPEG-4 может создавать образец окна описания для следующих форматов:

-   H. 264/видео с AVC
-   AAC аудио
-   Звуковые файлы в формате MP3

В других форматах поле Описание образца должно быть указано в типе носителя для каждого потока. Чтобы указать поле Описание образца, задайте следующие атрибуты типа носителя:



| attribute                                                                     | Описание                                                                                                                                                   |
|-------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [\_ \_ \_ Описание образца MPEG4 \_ MF](mf-mt-mpeg4-sample-description.md)      | Содержит пример поля описания как двоичный BLOB-объект.                                                                                                         |
| [\_ \_ \_ \_ Запись текущего примера \_ в MF MT](mf-mt-mpeg4-current-sample-entry.md) | Указывает, какие из образцов записей в поле Образец описания активны в данный момент. (Необязательно.)<br/> В настоящее время значение должно быть равно нулю.<br/> |



 

В некоторых случаях невозможно создать образец поля описания до тех пор, пока не будут закодированы все данные. Например, такие сведения, как средняя скорость потока, могут быть не известны заранее. В этом случае можно обновить тип мультимедиа с помощью интерфейса [**имфмедиатипехандлер**](/windows/desktop/api/mfidl/nn-mfidl-imfmediatypehandler) в приемнике файлов MPEG-4. Это необходимо сделать до завершения воспроизведения приемника мультимедиа.

Обычно тип мультимедиа создается вышестоящим кодировщиком. Кодировщик может создать новый тип мультимедиа во время потоковой передачи, используя динамическое изменение формата. Дополнительные сведения см. в разделе [динамические изменения формата](basic-mft-processing-model.md).

## <a name="h264avc-video"></a>H. 264/видео с AVC

Приемник файлов MPEG-4 поддерживает версию потока AVC, имеющего простейший видеопоток, с набором параметров Sequence (SPS) и набором параметров Picture (PPS) Налус, которые содержатся в 5,1 разделе «Пример описания», как определено в части 15 ISO/IEC 14496. Приемник файлов не поддерживает альтернативный метод хранения SPS/PPS Налус как отдельный простой поток набора параметров.

Приемник файлов MPEG-4 может создать поле описания, но должно быть предоставлено с помощью SPS и PPS Налус. Укажите эти сведения в типе носителя, задав атрибут [**\_ \_ \_ \_ заголовка последовательностей MF MT MPEG**](mf-mt-mpeg-sequence-header-attribute.md) . Значением атрибута является заголовок последовательности H. 264. Заголовок последовательности должен содержать Налусы SPS и PPS, разделенные на 3-байтовые или 4-байтовые начальные коды.

При необходимости при настройке приемника файла можно опустить атрибут [**\_ \_ \_ \_ заголовков последовательностей MF в формате MPEG MT**](mf-mt-mpeg-sequence-header-attribute.md) от исходного типа носителя. В этом случае необходимо позднее обновить тип носителя, чтобы включить заголовок последовательности.

Приемник файлов MPEG-4 имеет следующие требования к битстреамсу AVC:

-   Битовый поток должен соответствовать спецификации формата H. 264 в приложении B. В частности, Налус необходимо разделять либо с помощью 3-байтового, либо из 4-байтового начального кода.
-   Примеры носителей должны содержать все Налус срезов и данных, которые соответствуют одному времени презентации.
-   При записи B-кадров в файл MP4 необходимо задать метку времени презентации и отметку времени декодирования. Если в потоке есть кадр B, а метка времени декодирования не задана, модуль записи MP4 будет видеть время кадра в обратном направлении, а кадр будет удален. 

## <a name="aac-audio"></a>Звук в формате AAC

Для AAC Audio приемник файлов MPEG-4 может создать образец окна описания для следующих подтипов:

-   **Мфаудиоформат \_ AAC**
-   **МЕДИАСУБТИПЕ \_ RAW \_ AAC1**

Дополнительные сведения об этих субстипесх см. в разделе [AAC Media Types](aac-media-types.md).

Для подтипа **мфаудиоформат \_ AAC** тип мультимедиа дополнительно содержит атрибут [**\_ \_ \_ данных пользователя MF MT**](mf-mt-user-data-attribute.md) . При наличии этот атрибут является частью структуры [**хеааквавеинфо**](/windows/win32/api/mmreg/ns-mmreg-heaacwaveinfo) , которая отображается после структуры **вавеформатекс** (то есть после элемента **вфкс** ). За ним следуют данные АудиоспеЦификконфиг () в соответствии с определением ISO/IEC 14496-3. Если отсутствует **атрибут \_ \_ \_ данных пользователя MF MT** , предполагается, что используется профиль AAC с низким уровнем сложности (LC), а приемник файла MPEG-4 создает подходящий пример окна описания.

Для подтипа **медиасубтипе \_ RAW \_ AAC1** приемник мультимедиа должен содержать атрибут [**\_ \_ \_ данных пользователя MF MT**](mf-mt-user-data-attribute.md) , а атрибут должен содержать данные аудиоспеЦификконфиг ().

Приемник файлов MPEG-4 создает вариант образца AAC в формате MPEG-4 с помощью записи примера "mp4a" с Обжекттипеиндикатион = 0x40. В нем не используются типы объектов MPEG-2.

## <a name="mp3-audio"></a>Аудио в формате MP3

Для MP3 Audio приемник файлов MPEG-4 может создать пример поля описания на основе стандартного типа аудио Media. (См. раздел [типы звуковых носителей](audio-media-types.md).)

Приемник файлов MPEG-4 создает вариант с образцом MPEG-4 в поле описания образца MP3 с помощью записи примера "mp4a" с Обжекттипеиндикатион = 0x6B для звука MPEG-1.

## <a name="limitations"></a>Ограничения

-   Максимальный размер созданного файла составляет 4 ГБ. в Windows 8 поддерживаются файлы размером более 4 гбгб.
-   Приемник файлов MPEG-4 не поддерживает списки редактирования ("едтс" и "елст").

## <a name="windows-8-updates-to-mpeg-4-source-and-sink"></a>Windows 8 обновления источника и приемника MPEG-4

-   поддержка вращения чтения и записи добавлена в Windows 8 источнике и приемнике MPEG-4. это не поддерживается в источнике и приемнике Windows 7 MPEG-4.

    Источник MPEG-4 считывает угол поворота для активной видеодорожки в виде суммы угла вращения из "мвхд" и из "ткхд".

    Приемник Microsoft MPEG-4 записывает угол вращения в "ткхд", но записывает матрицу 0 градусов (Identity) в "мвхд". Обратите внимание, что приемник Microsoft MPEG-4 поддерживает только одну видеодорожку.

    Ипропертисторе считывает угол поворота только для первой видеодорожки в виде суммы угла вращения из "мвхд" и из "ткхд".

    Ипропертисторе записывает угол поворота только для первой видеодорожки в "ткхд" после того, как угол вращения изменяется в соответствии с углом вращения в "мвхд", если он существует.

-   фрагменты роликов ("moof") поддерживаются в Windows 8 источнике и приемнике MPEG-4, а "mfra" — нет.
-   H. 263 поддерживается в Windows 8 источнике MPEG-4.

    Источник MPEG-4 теперь сопоставляет два объекта FourCC "H263" и 263 "в формате MPEG-4 с типом мультимедиа **мфвидеоформат \_ H263**.

-   дополнительная поддержка fourcc добавлена для мжпег в источнике MPEG-4 Windows 8.

    Источник MPEG-4 сопоставляет фаукк из "DMB1" с типом мультимедиа **мфвидеоформат \_ мжпг**.

-   поддержка метаданных фуригана добавлена в Windows 8 источник MPEG-4.

    Источник MPEG-4 считывает метаданные фуригана из "СОАЛ", "взлетел", "соаа", "сонм" и "Соко". Ипропертисторе считывает метаданные Фуригнана через набор соответствующих PKEY.

    В следующей таблице показано сопоставление канонического имени оболочки, ключа свойства и идентификатора поля/тега в формате файла MPEG-4.

    

    | Поле                                | Ключ свойства                         | ИДЕНТИФИКАТОР тега или Box |
    |--------------------------------------|--------------------------------------|------------|
    | System. Music. Албумтитлесортоверриде  | \_ \_ Албумтитлесортоверриденая музыка PKEY  | соал       |
    | System. Music. Артистсортоверриде      | \_ \_ Артистсортоверриденая музыка PKEY      | взлетел       |
    | System. Music. Албумартистсортоверриде | \_ \_ Албумартистсортоверриденая музыка PKEY | соаа       |
    | System. Титлесортоверриде             | PKEY \_ титлесортоверриде             | сонм       |
    | System. Music. Компосерсортоверриде    | \_ \_ Компосерсортоверриденая музыка PKEY    | соко       |

    

     

-   поддержка стерео 3d atom добавлена в Windows 8 источник MPEG-4.

-   поддержка AC3 и DD + добавлена в Windows 8 источнике и приемнике MPEG-4.
-   файлы размером более 4 гб поддерживаются в Windows 8 приемника MPEG-4 для нефрагментированного MP4.
-   очистка оптимизирована в Windows 8 источнике MPEG-4.

    Чтобы сократить задержку, сведения о двух ближайших ключевых кадрах для конкретной должности предоставляются через [**имфсикинфо:: жетнеаресткэйфрамес**](/windows/desktop/api/mfidl/nf-mfidl-imfseekinfo-getnearestkeyframes). Так как ключевой кадр не имеет зависимых кадров, он представляет кадр после декодирования только одного кадра. Используйте [**имфжетсервице::-Service**](/windows/desktop/api/mfidl/nf-mfidl-imfgetservice-getservice) для получения этого интерфейса через источник мультимедиа, конвейер или приложение.

    Задайте для параметра rate (нулевое значение) в источнике MPEG-4. Если конвейер находится в режиме очистки, скорость равна нулю.

-   SPS и PPS могут храниться в образцах данных в приемнике MPEG-4.

    [MF \_ Атрибут \_ \_ транзитного спсппс MPEG4SINK](mf-mpeg4sink-spspps-passthrough.md) в приемнике MPEG-4 определен, чтобы разрешить сохранение SPS и PPS вместе со входными образцами (H. 264 Video Data). созданные зажимы mp4 доступны для воспроизведения, Windows 7 источников MPEG-4 и других.

-   SPS и PPS можно извлечь из примеров входных данных в приемнике MPEG-4.

    Если в качестве входного носителя для приемника MPEG-4 не заданы протоколы SPS и PPS с использованием [ \_ \_ \_ \_ заголовка последовательного входа MPEG MT](mf-mt-mpeg-sequence-header-attribute.md) , приемник MPEG-4 попытается извлечь SPS и PPS из входных образцов. Приемник MPEG-4 игнорирует все входные образцы, пока не найдет первый сервер SPS и PPS, так как все входные образцы без SPS и PPS не поддерживают декодирование.

-   Объемная информация в записи конфигурации AVC поддерживается для нефрагментированного MP4.
-   НАЛУ длина предоставляется для сжатых образцов H. 264 для оптимизации H. 264 ВЛД ДКСВА декодирования.

    Набор исходных файлов MPEG- [4 \_ имеет длину MF налу, \_ \_ установленную](mf-nalu-length-set.md) на выходном типе носителя **мфвидеоформат \_ H264 Single bitrate** или **мфвидеоформат \_ H264 Single bitrate**. Он задает большой двоичный [объект \_ налу \_ длины \_ MF](mf-nalu-length-information.md) для каждого выходного образца с 4-байтовой длиной налу для разных налу в одном сжатом примере.

-   Добавлена поддержка для звука MPEG2 ADTS в источнике MP4.

## <a name="requirements"></a>Требования



| Требование | Значение |
|-------------------------------------|---------------------------------------------------------|
| Минимальная версия клиента<br/> | только Windows 7 \[ настольных приложений\]<br/>              |
| Минимальная версия сервера<br/> | Windows \[Только для настольных приложений сервера 2008 R2\]<br/> |



## <a name="see-also"></a>См. также раздел

<dl> <dt>

[Источники и приемники мультимедиа](media-sources-and-sinks.md)
</dt> <dt>

[Приемники носителей](media-sinks.md)
</dt> <dt>

[Поддержка MPEG-4 в Media Foundation](mpeg-4-support-in-media-foundation.md)
</dt> <dt>

[Поддерживаемые форматы мультимедиа в Media Foundation](supported-media-formats-in-media-foundation.md)
</dt> </dl>

 

 
