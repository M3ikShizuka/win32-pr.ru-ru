---
description: В этом разделе описывается использование источника Sequencer.
ms.assetid: 7ce8dc67-02b1-4fd4-9e4d-6614fdb40620
title: Использование источника Sequencer
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e2b0607d65d02e507f576a5177ea432f3f7e0fab57c3b575fbb34240a46e91be
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118972733"
---
# <a name="using-the-sequencer-source"></a>Использование источника Sequencer

В этом разделе описывается использование [источника Sequencer](sequencer-source.md). Он содержит следующие подразделы:

-   [Обзор](#overview)
-   [Добавление топологий](#adding-topologies)
-   [Удаление топологий](#deleting-topologies)
-   [Пропуск в сегмент](#skipping-to-a-segment)
-   [Связанные темы](#related-topics)

Общие сведения о источнике Sequencer см. в разделе [сведения о источнике Sequencer](about-the-sequencer-source.md).

## <a name="overview"></a>Обзор

Источник Sequencer предоставляет следующие интерфейсы.



| Интерфейс                                                                        | Описание                                                                        |
|----------------------------------------------------------------------------------|------------------------------------------------------------------------------------|
| [**имфмедиасаурце**](/windows/desktop/api/mfidl/nn-mfidl-imfmediasource)                                         | Предоставляет универсальную функциональность источника носителя.                                        |
| [**имфсекуенцерсаурце**](/windows/desktop/api/mfidl/nn-mfidl-imfsequencersource)                                 | Позволяет приложению добавлять или удалять топологии.                               |
| [**имфмедиасаурцетопологипровидер**](/windows/desktop/api/mfidl/nn-mfidl-imfmediasourcetopologyprovider)         | Извлекает следующую топологию в очередь в сеансе мультимедиа.                         |
| [**имфмедиасаурцепресентатионпровидер**](/windows/desktop/api/mfidl/nn-mfidl-imfmediasourcepresentationprovider) | Используется сеансом мультимедиа для конечных сегментов. Приложения не используют этот интерфейс. |
| [**имфжетсервице**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice)                                           | Запрашивает источник Sequencer для [интерфейсов служб](service-interfaces.md).     |



 

Чтобы воспроизвести последовательность источников мультимедиа, выполните следующие действия.

1.  Чтобы создать источник Sequencer, вызовите функцию [**мфкреатесекуенцерсаурце**](/windows/desktop/api/mfidl/nf-mfidl-mfcreatesequencersource) .
2.  Для каждого сегмента Создайте топологию воспроизведения, как описано в разделе [Создание топологий воспроизведения](creating-playback-topologies.md). Чтобы добавить топологию в презентацию, вызовите метод [**имфсекуенцерсаурце:: аппендтопологи**](/windows/desktop/api/mfidl/nf-mfidl-imfsequencersource-appendtopology).
3.  Перед началом воспроизведения вызовите [**имфмедиасаурце:: креатепресентатиондескриптор**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasource-createpresentationdescriptor) в источнике Sequencer. Этот метод возвращает указатель на дескриптор представления для первого сегмента. Чтобы получить топологию, связанную с этим сегментом, вызовите **QueryInterface** в источнике Sequencer для интерфейса [**имфмедиасаурцетопологипровидер**](/windows/desktop/api/mfidl/nn-mfidl-imfmediasourcetopologyprovider) . Передайте дескриптор презентации в метод [**имфмедиасаурцетопологипровидер:: жетмедиасаурцетопологи**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasourcetopologyprovider-getmediasourcetopology) . Этот метод возвращает указатель на топологию.
4.  Передайте топологию первого сегмента в сеанс мультимедиа, вызвав метод [**имфмедиасессион:: Сеттопологи**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasession-settopology) сеанса мультимедиа.
5.  Запустите воспроизведение, вызвав [**имфмедиасессион:: Start**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasession-start).
6.  Когда источник Sequencer готов к выполнению в следующем сегменте, он отправляет событие [меневпресентатион](menewpresentation.md) , данные события которого являются указателем интерфейса [**имфпресентатиондескриптор**](/windows/desktop/api/mfidl/nn-mfidl-imfpresentationdescriptor) . Опять же, получите топологию для сегмента, вызвав [**жетмедиасаурцетопологи**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasourcetopologyprovider-getmediasourcetopology) в источнике Sequencer и задав топологию в сеансе мультимедиа, вызвав [**сеттопологи**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasession-settopology). Нет необходимости повторно запускать источник мультимедиа; Он будет автоматически воспроизводиться до следующего сегмента.
7.  Перед завершением работы приложения завершите работу источника Sequencer, вызвав [**имфмедиасаурце:: Shutdown**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasource-shutdown).

В следующем коде показано, как получить топологию и задать ее в сеансе мультимедиа:


```C++
// Queues the next topology on the session.

HRESULT CPlaylist::QueueNextSegment(IMFPresentationDescriptor *pPD)
{
    IMFMediaSourceTopologyProvider *pTopoProvider = NULL;
    IMFTopology *pTopology = NULL;

    //Get the topology for the presentation descriptor
    HRESULT hr = m_pSequencerSource->QueryInterface(IID_PPV_ARGS(&pTopoProvider));
    if (FAILED(hr))
    {
        goto done;
    }

    hr = pTopoProvider->GetMediaSourceTopology(pPD, &pTopology);
    if (FAILED(hr))
    {
        goto done;
    }

    //Set the topology on the media session
    m_pSession->SetTopology(NULL, pTopology);

done:
    SafeRelease(&pTopoProvider);
    SafeRelease(&pTopology);
    return hr;
}
```



Полный пример кода см. в разделе [Пример исходного кода программы Sequencer](sequencer-source-example-code.md).

## <a name="adding-topologies"></a>Добавление топологий

Источник Sequencer содержит два списка топологий: *входной список* и предэлементный *Список*.

Входной список представляет собой коллекцию топологий, соответствующих сегментам списка воспроизведения в том порядке, в котором они были добавлены приложением путем вызова [**имфсекуенцерсаурце:: аппендтопологи**](/windows/desktop/api/mfidl/nf-mfidl-imfsequencersource-appendtopology). Этот метод назначает каждой топологии уникальный *Идентификатор сегмента* типа **мфсекуенцерелементид**. Идентификатор сегмента задается как атрибут для всех узлов топологии источника. Приложение может получить идентификатор сегмента из исходного узла с помощью атрибута [ \_ \_ \_ ELEMENTID топоноде Sequence](mf-toponode-sequence-elementid-attribute.md) . Входной список может иметь дублирующиеся топологии, если приложение с именем **аппендтопологи** в одной топологии несколько раз; Однако они идентифицируются по уникальным идентификаторам сегментов.

Предустановленный список представляет собой коллекцию топологий списка входных данных, которые были инициализированы при подготовке к воспроизведению. Это позволяет сеансу мультимедиа переходить к следующей топологии без проблем, когда завершается активная топология. Приложение не может напрямую добавлять или удалять топологии из списка предустановки; Он создается источником Sequencer, если топология из входного списка выбрана для воспроизведения. В результате источник Sequencer добавляет следующую топологию из входного списка в список предустановки. После этого источник Sequencer асинхронно вызывает событие [меневпресентатион](menewpresentation.md) и передает дескриптор представления для предподготовки топологии в виде данных о событии. Приложение должно прослушивать это событие с помощью интерфейса [**Имфмедиаевентженератор**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediaeventgenerator) сеанса мультимедиа и поставить в очередь предпробную топологию в сеансе мультимедиа путем вызова [**Имфмедиасессион:: сеттопологи**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasession-settopology). Это необходимо сделать до того, как сеанс мультимедиа завершит воспроизведение активной топологии. **Сеттопологи** информирует сеанс мультимедиа о следующей топологии, которую необходимо воспроизвести после завершения воспроизведения активной топологии. Чтобы обеспечить бесперебойную треанситион, приложение должно вызвать **сеттопологи** до того, как сеанс мультимедиа завершится воспроизведением предыдущей топологии. В противном случае между сегментами будет разрыв.

Событие [меневпресентатион](menewpresentation.md) возникает при условии, что после активной топологии имеется топология. Следовательно, если входной список содержит только одну топологию или если активная топология является последней в входном списке, это событие не возникает.

Список предустановленных данных синхронизируется со списком ввода и обновляется каждый раз при добавлении или удалении топологии из входного списка.

## <a name="deleting-topologies"></a>Удаление топологий

Чтобы удалить топологию из источника Sequencer, приложение должно вызвать метод [**имфсекуенцерсаурце::D елететопологи**](/windows/desktop/api/mfidl/nf-mfidl-imfsequencersource-deletetopology) и указать идентификатор сегмента.

Перед вызовом [**делететопологи**](/windows/desktop/api/mfidl/nf-mfidl-imfsequencersource-deletetopology)приложение должно убедиться, что сеанс мультимедиа не использует топологию, которую приложение хочет удалить. Для этого необходимо выполнить оба следующих действия, прежде чем приложение вызовет **делететопологи**:

-   Получено событие [месессионтопологистатус](mesessiontopologystatus.md) с MF \_ топостатус \_ Completed для топологии, чтобы убедиться, что сеанс мультимедиа завершил воспроизведение.

-   [Месессионтопологистатус](mesessiontopologystatus.md) with MF \_ топостатус \_ Started \_ Source получен для следующей топологии, чтобы убедиться, что сеанс мультимедиа начал играть в следующую топологию, получено событие [Месессионендед](mesessionended.md) , чтобы убедиться, что сеанс мультимедиа выполняется с последней топологией в источнике Sequencer.

Если удаляемый сегмент является активной топологией, воспроизведение останавливается и источник Sequencer вызывает событие [миндофпресентатионсегмент](meendofpresentationsegment.md) . Если активная топология также является последней топологией, возникает событие [миндофпресентатион](meendofpresentation.md) .

## <a name="skipping-to-a-segment"></a>Пропуск в сегмент

Приложение может перейти к определенному сегменту в последовательности, запустив [сеанс мультимедиа](media-session.md) со смещением сегмента, как показано ниже:

1.  Вызовите функцию [**мфкреатесекуенцерсегментоффсет**](/windows/desktop/api/mfidl/nf-mfidl-mfcreatesequencersegmentoffset) , чтобы создать смещение сегмента. Укажите идентификатор сегмента в параметре *ДВИД* . (Идентификатор был возвращен методом [**имфсекуенцерсаурце:: аппендтопологи**](/windows/desktop/api/mfidl/nf-mfidl-imfsequencersource-appendtopology) при первом добавлении топологии в источник Sequencer.) Параметр *хнсоффсет* задает смещение времени относительно начала сегмента. В это время начнется воспроизведение. Для параметра *пварсегментоффсет* передайте адрес пустого **пропвариант**. При возврате функции этот **пропвариант** содержит смещение сегмента.

2.  Вызовите метод [**имфмедиасессион:: Start**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasession-start) в сеансе мультимедиа. В качестве значения параметра *пгуидтимеформат* используйте значение идентификатора GUID \_ \_ смещение сегмента формата времени MF \_ \_ . Это значение указывает на поиск по смещению сегмента. Для параметра *пварстартпоситион* передайте адрес **пропвариант** , созданный на предыдущем шаге.

В следующем примере кода показано, как перейти к началу указанного сегмента в последовательности.


```C++
// Skips to the specified segment in the sequencer source

HRESULT CPlaylist::SkipTo(DWORD index)
{
    if (index >= m_count)
    {
        return E_INVALIDARG;
    }

    MFSequencerElementId ID = m_segments[index].SegmentID;

    PROPVARIANT var;

    HRESULT hr = MFCreateSequencerSegmentOffset(ID, NULL, &var);
    
    if (SUCCEEDED(hr))
    {
        hr = m_pSession->Start(&MF_TIME_FORMAT_SEGMENT_OFFSET, &var);
        PropVariantClear(&var);
    }
    return hr;
}
```



Когда приложение выполняет поиск по сегментам, приложение получает несколько событий, так как источник Sequencer завершает текущий сегмент и готовится к воспроизведению нового сегмента. Поскольку эти события получаются асинхронно, трудно спрогнозировать точную последовательность событий. Ниже приведены эти события.

-   Источник Sequencer отправляет событие [меневпресентатион](menewpresentation.md) для нового сегмента, в который пропускается сеанс мультимедиа.

-   Когда источник Sequencer завершает активный сегмент, он отправляет событие [миндофпресентатионсегмент](meendofpresentationsegment.md) .
-   Затем источник Sequencer отменяет предпробную топологию. Это приводит к следующим событиям для отмененной топологии:

    -   Событие [месессионтопологистатус](mesessiontopologystatus.md) с \_ флагом "MF топостатус Ready" \_ .
    -   Событие [месессионтопологистатус](mesessiontopologystatus.md) с \_ \_ флагом источника MF топостатус Started \_ .
    -   Событие [миндофпресентатионсегмент](meendofpresentationsegment.md) с атрибутом " [ \_ \_ топология источника события MF \_ \_ отменено](mf-event-source-topology-canceled-attribute.md) ", чтобы указать, что топология была отменена источником Sequencer.

-   Затем источник Sequencer отправляет события для нового сегмента, включая различные события [месессионтопологистатус](mesessiontopologystatus.md) .
-   Если новый сегмент не является последним в списке, источник Sequencer обновляет предустановленный список и создает еще одну [меневпресентатион](menewpresentation.md) для новой предрулонной топологии. Сведения о топологиях в предустановочном списке см. в разделе [сведения о источнике Sequencer](about-the-sequencer-source.md).

Дополнительные сведения о событиях, отправленных источником Sequencer, можно найти в разделе [события источника Sequencer](sequencer-source-events.md).

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Создание списка воспроизведения](how-to-create-a-playlist.md)
</dt> <dt>

[Источник Sequencer](sequencer-source.md)
</dt> </dl>

 

 



