---
description: В этом разделе описывается использование рабочих очередей в Microsoft Media Foundation.
ms.assetid: 6be05df7-e8ff-4110-8f73-a62eb31fd414
title: Использование рабочих очередей
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 80c288c6aad2d6d95e99362c8479a0d75cbb5699d448c984e9a3fef317c4d16b
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "120012194"
---
# <a name="using-work-queues"></a>Использование рабочих очередей

В этом разделе описывается использование рабочих очередей в Microsoft Media Foundation.

-   [Использование рабочих очередей](#using-work-queues)
-   [Завершение работы рабочих очередей](#shutting-down-work-queues)
-   [Использование запланированных рабочих элементов](#using-scheduled-work-items)
-   [Использование периодических обратных вызовов](#using-periodic-callbacks)
-   [Связанные темы](#related-topics)

## <a name="using-work-queues"></a>Использование рабочих очередей

Рабочая очередь — это эффективный способ выполнения асинхронных операций в другом потоке. По сути, вы размещаете рабочие элементы в очереди, а очередь содержит поток, который извлекает каждый элемент из очереди и отправляет его. Рабочие элементы реализуются как обратные вызовы с помощью интерфейса [**имфасинккаллбакк**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) .

Media Foundation создает несколько стандартных рабочих очередей, называемых *рабочими очередями платформы*. Приложения также могут создавать собственные рабочие очереди, называемые *частными рабочими очередями*. Список рабочих очередей платформы см. в разделе [идентификаторы рабочей очереди](work-queue-identifiers.md). Чтобы создать частную рабочую очередь, вызовите [**мфаллокатеворккуеуе**](/windows/desktop/api/mfapi/nf-mfapi-mfallocateworkqueue). Эта функция возвращает идентификатор для новой рабочей очереди. Чтобы поместить элемент в очередь, вызовите [**мфпутворкитем**](/windows/desktop/api/mfapi/nf-mfapi-mfputworkitem) или [**мфпутворкитемекс**](/windows/desktop/api/mfapi/nf-mfapi-mfputworkitemex). В обоих случаях необходимо указать интерфейс обратного вызова.

-   [**Мфпутворкитем**](/windows/desktop/api/mfapi/nf-mfapi-mfputworkitem) принимает указатель на интерфейс [**имфасинккаллбакк**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) , а также необязательный объект состояния, который реализует **IUnknown**. Это те же параметры, которые используются в асинхронных методах, как описано в разделе [методы асинхронного обратного вызова](asynchronous-callback-methods.md). На внутреннем уровне эта функция создает объект асинхронного результата, который передается в метод [**Invoke**](/windows/desktop/api/mfobjects/nf-mfobjects-imfasynccallback-invoke) метода обратного вызова.
-   [**Мфпутворкитемекс**](/windows/desktop/api/mfapi/nf-mfapi-mfputworkitemex) принимает указатель на интерфейс [**имфасинкресулт**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasyncresult) . Этот интерфейс представляет объект асинхронного результата. Создайте этот объект, вызвав [**мфкреатеасинкресулт**](/windows/desktop/api/mfapi/nf-mfapi-mfcreateasyncresult) и указав интерфейс обратного вызова и, при необходимости, объект состояния.

В обоих случаях поток рабочей очереди вызывает метод [**имфасинккаллбакк:: Invoke**](/windows/desktop/api/mfobjects/nf-mfobjects-imfasynccallback-invoke) . Используйте метод **Invoke** для выполнения рабочего элемента.

Если несколько потоков или компонентов совместно используют одну и ту же рабочую очередь, можно вызвать [**мфлоккворккуеуе**](/windows/desktop/api/mfapi/nf-mfapi-mflockworkqueue) , чтобы заблокировать рабочую очередь, что не позволит платформе освободить ее. Для каждого вызова [**мфаллокатеворккуеуе**](/windows/desktop/api/mfapi/nf-mfapi-mfallocateworkqueue) или **Мфлоккворккуеуе** необходимо вызвать [**мфунлоккворккуеуе**](/windows/desktop/api/mfapi/nf-mfapi-mfunlockworkqueue) один раз, чтобы освободить рабочую очередь. Например, если создать новую рабочую очередь и затем заблокировать ее один раз, необходимо вызвать **мфунлоккворккуеуе** дважды, один раз для вызова **мфаллокатеворккуеуе** и один раз для вызова **мфлоккворккуеуе**.

В следующем коде показано, как создать новую рабочую очередь, поместить рабочий элемент в очередь и освободить рабочую очередь.

Дополнительные сведения о рабочих очередях в Windows 8 см. в разделе [улучшения рабочей очереди и потоков](media-foundation-work-queue-and-threading-improvements.md) .


```C++
DWORD idWorkQueue = 0;
HRESULT hr = S_OK;

// Create a new work queue.
hr = MFAllocateWorkQueue(&idWorkQueue);

// Put an item on the queue.
if (SUCCEEDED(hr))
{
    hr = MFPutWorkItem(idWorkQueue, pCallback, NULL);
}

// Wait for the callback to be invoked.
if (SUCCEEDED(hr))
{
    WaitForSingleObject(hEvent, INFINITE);
}

// Release the work queue.
if (SUCCEEDED(hr))
{
    hr = MFUnlockWorkQueue(idWorkQueue);
}
```



В этом примере предполагается, что *пкаллбакк* является указателем на интерфейс [**имфасинккаллбакк**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) приложения. Также предполагается, что обратный вызов задает обработчик событий *Хевент* . Перед вызовом [**мфунлоккворккуеуе**](/windows/desktop/api/mfapi/nf-mfapi-mfunlockworkqueue)код ожидает установки этого события.

Потоки рабочей очереди всегда создаются в процессе вызывающего объекта. В каждой рабочей очереди обратные вызовы сериализуются. Если вы вызываете [**мфпутворкитем**](/windows/desktop/api/mfapi/nf-mfapi-mfputworkitem) дважды с той же рабочей очередью, второй обратный вызов не вызывается до тех пор, пока не вернется первый обратный вызов.

## <a name="shutting-down-work-queues"></a>Завершение работы рабочих очередей

Перед вызовом [**мфшутдовн**](/windows/desktop/api/mfapi/nf-mfapi-mfshutdown)Освободите все ресурсы, используемые потоками рабочих очередей. Чтобы синхронизировать этот процесс, можно заблокировать Media Foundationную платформу, которая не позволяет функции **мфшутдовн** закрывать потоки рабочих очередей. Если **мфшутдовн** вызывается, когда платформа заблокирована, **мфшутдовн** ожидает несколько сотен миллисекунд, чтобы платформа была разблокирована. Если он не разблокирован в течение этого времени, **мфшутдовн** закрывает потоки рабочей очереди.

Реализация [**имфасинкресулт**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasyncresult) по умолчанию автоматически блокирует Media Foundationную платформу при создании результирующего объекта. Освобождение интерфейса разблокирует платформу. Поэтому вам почти никогда не придется блокировать платформу напрямую. Но при написании собственной пользовательской реализации **имфасинкресулт** следует вручную заблокировать и разблокировать платформу. Чтобы заблокировать платформу, вызовите [**мфлоккплатформ**](/windows/desktop/api/mfapi/nf-mfapi-mflockplatform). Чтобы разблокировать платформу, вызовите [**мфунлоккплатформ**](/windows/desktop/api/mfapi/nf-mfapi-mfunlockplatform). Пример см. в разделе [пользовательские асинхронные объекты Result](custom-asynchronous-result-objects.md).

После вызова [**мфшутдовн**](/windows/desktop/api/mfapi/nf-mfapi-mfshutdown)необходимо убедиться, что платформа разблокирована в течение 5-секундного периода ожидания. Для этого выпустите все [**имфасинкресулт**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasyncresult) указатели и вызовите [**мфунлоккплатформ**](/windows/desktop/api/mfapi/nf-mfapi-mfunlockplatform) , если вы заблокировали платформу вручную. Убедитесь, что освобождаются все ресурсы, используемые потоками рабочих очередей, или ваше приложение может привести к утечке памяти.

Как правило, если приложение завершает работу и освобождает каждый объект Media Foundation перед вызовом [**мфшутдовн**](/windows/desktop/api/mfapi/nf-mfapi-mfshutdown), нет необходимости беспокоиться о блокировке. Механизм блокировки просто позволяет потокам рабочей очереди корректно завершать работу после вызова **мфшутдовн**.

## <a name="using-scheduled-work-items"></a>Использование запланированных рабочих элементов

Вы можете запланировать выполнение обратного вызова по истечении заданного периода времени, вызвав [**мфсчедулеворкитем**](/windows/desktop/api/mfapi/nf-mfapi-mfscheduleworkitem) или [**мфсчедулеворкитемекс**](/windows/desktop/api/mfapi/nf-mfapi-mfscheduleworkitemex).

-   [**Мфсчедулеворкитем**](/windows/desktop/api/mfapi/nf-mfapi-mfscheduleworkitem) принимает указатель на обратный вызов, необязательный объект состояния и интервал времени ожидания.
-   [**Мфсчедулеворкитемекс**](/windows/desktop/api/mfapi/nf-mfapi-mfscheduleworkitemex) принимает указатель на объект асинхронного результата и значение времени ожидания.

Укажите время ожидания как отрицательное значение в миллисекундах. Например, чтобы запланировать вызов обратного вызова в течение 5 секунд, используйте значение − 5000. Обе функции возвращают **значение \_ ключа мфворкитем** , которое можно использовать для отмены обратного вызова, передавая его в функцию [**мфканцелворкитем**](/windows/desktop/api/mfapi/nf-mfapi-mfcancelworkitem) .

Запланированные рабочие элементы всегда используют \_ очередь ответного вызова мфасинк для \_ \_ платформы таймера.

## <a name="using-periodic-callbacks"></a>Использование периодических обратных вызовов

Функция [**мфаддпериодиккаллбакк**](/windows/desktop/api/mfapi/nf-mfapi-mfaddperiodiccallback) планирует периодически вызывать обратный вызов до тех пор, пока вы его не отмените. Интервал обратного вызова является фиксированным; приложения не могут изменить его. Чтобы узнать точный интервал, вызовите [**мфжеттимерпериодиЦити**](/windows/desktop/api/mfapi/nf-mfapi-mfgettimerperiodicity). Интервал равен 10 миллисекундам, поэтому эта функция предназначена для ситуаций, когда требуется частое «значение Tick», например реализация часов представления. Если необходимо запланировать выполнение операции реже, используйте запланированный рабочий элемент, как описано выше.

В отличие от других обратных вызовов, описанных в этом разделе, периодический обратный вызов не использует интерфейс [**имфасинккаллбакк**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) . Вместо этого используется указатель на функцию. Дополнительные сведения см. в разделе [**обратный вызов мфпериодиккаллбакк**](/windows/win32/api/mfapi/nc-mfapi-mfperiodiccallback).

Чтобы отменить периодический обратный вызов, вызовите [**мфремовепериодиккаллбакк**](/windows/desktop/api/mfapi/nf-mfapi-mfremoveperiodiccallback).

Периодические обратные вызовы используют \_ \_ \_ рабочую очередь платформы таймера очереди ответного вызова мфасинк.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Рабочие очереди](work-queues.md)
</dt> <dt>

[**мфасинкресулт**](/windows/win32/api/mfapi/ns-mfapi-mfasyncresult)
</dt> <dt>

[Усовершенствования рабочей очереди и потоков](media-foundation-work-queue-and-threading-improvements.md)
</dt> </dl>

 

 
