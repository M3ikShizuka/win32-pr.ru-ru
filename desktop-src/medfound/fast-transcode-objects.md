---
description: В этом разделе описано, как использовать API перекодировки для кодирования файла мультимедиа.
ms.assetid: 52b27359-b319-41a0-88e8-d23567420e92
title: Использование API перекодирования
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 72e32ea24ebd4803319713be5fe7789cf41c3a99733338bdfe5ad69baf7396bb
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118742482"
---
# <a name="using-the-transcode-api"></a>Использование API перекодирования

В этом разделе описано, как использовать API перекодировки для кодирования файла мультимедиа.

-   [Обзор](#overview)
-   [Создание источника мультимедиа](#creating-a-media-source)
-   [Создание профиля перекодирования](#creating-a-transcode-profile)
    -   [Атрибуты звука](#audio-attributes)
    -   [Атрибуты видео](#video-attributes)
    -   [Атрибуты контейнера](#container-attributes)
-   [Создание топологии перекодирования](#creating-a-transcode-topology)
-   [Выполнение сеанса кодирования](#running-the-encoding-session)
-   [Связанные темы](#related-topics)

## <a name="overview"></a>Обзор

Перед использованием API перекодирования приложение должно иметь следующие сведения:

-   Путь или URL-адрес существующего файла мультимедиа, который будет зашифрован повторно.
-   Имя выходного файла.
-   Тип контейнера для выходного файла, например MP4 или Advanced Streaming Format (ASF).
-   Формат кодировки параметра. Эти сведения включают в себя типы носителей, описывающие закодированные аудио и видеопотоки.

Чтобы использовать API перекодирования, приложение выполняет следующие действия.

1.  Создайте источник мультимедиа для чтения исходного файла.
2.  Создайте профиль перекодирования. Добавьте атрибуты, описывающие аудиопоток, поток видео и контейнер файлов.
3.  Используйте профиль перекодировки для создания топологии кодирования. (Дополнительные сведения о топологиях см. в разделе [о топологиях](about-topologies.md).)
4.  Задайте топологию для [сеанса мультимедиа](media-session.md).
5.  Запустите сеанс мультимедиа и дождитесь события [месессионендед](mesessionended.md) .

В оставшейся части этого раздела эти действия описаны более подробно.

## <a name="creating-a-media-source"></a>Создание источника мультимедиа

Источник мультимедиа — это объект, который считывает и анализирует исходный файл. Чтобы создать источник мультимедиа, используйте [сопоставитель источника](source-resolver.md). Пример кода можно найти в разделе [Использование сопоставителя источников](using-the-source-resolver.md).

## <a name="creating-a-transcode-profile"></a>Создание профиля перекодирования

*Профиль* перекодировки описывает формат и параметры, используемые для кодирования выходного файла. Профиль перекодировки содержит три набора атрибутов:

-   Атрибуты аудио: Опишите целевой формат аудио и параметры звукового кодировщика.
-   Атрибуты видео: Опишите целевой формат видео и параметры кодировщика видео.
-   Атрибуты контейнера: Определите тип контейнера файлов, а также некоторые глобальные параметры кодирования.

Чтобы создать профиль перекодирования, вызовите функцию [**мфкреатетранскодепрофиле**](/windows/desktop/api/mfidl/nf-mfidl-mfcreatetranscodeprofile) . Эта функция возвращает указатель на интерфейс [**имфтранскодепрофиле**](/windows/desktop/api/mfidl/nn-mfidl-imftranscodeprofile) . Исходный объект профиля пуст; Он не содержит атрибутов. Следующим шагом является добавление атрибутов, определяющих профиль.

### <a name="audio-attributes"></a>Атрибуты звука

Чтобы добавить атрибуты для аудиопотока, вызовите метод [**имфтранскодепрофиле:: сетаудиоаттрибутес**](/windows/desktop/api/mfidl/nf-mfidl-imftranscodeprofile-setaudioattributes). Эти атрибуты указывают, как кодируется звуковой поток. Если выходной файл не будет содержать аудиопоток, пропустите эти атрибуты.

Атрибуты аудио делятся на две категории:

-   Атрибуты, определяющие формат закодированного потока
-   Атрибуты, задающих другие параметры кодировки.

Атрибуты формата — это просто атрибуты типа мультимедиа, как описано в разделе [типы аудио мультимедиа](audio-media-types.md). Точный набор атрибутов формата зависит от кодировщика. (См. раздел [Поддерживаемые форматы мультимедиа в Media Foundation](supported-media-formats-in-media-foundation.md).) Ниже приведен список типовых атрибутов звукового формата.



| Атрибут Format                                                                         | Описание                                                      |
|------------------------------------------------------------------------------------------|------------------------------------------------------------------|
| [подтип MF \_ MT \_](mf-mt-subtype-attribute.md)                                           | Подтип. См. раздел [идентификаторы GUID для звуковых подтипов](audio-subtype-guids.md). |
| [\_ \_ каналы аудиосигнала MF MT \_ \_](mf-mt-audio-num-channels-attribute.md)                   | Число звуковых каналов.                                    |
| [\_ \_ звуковых образцов MF MT \_ \_ в \_ секунду](mf-mt-audio-samples-per-second-attribute.md)      | Количество звуковых выборок в секунду.                          |
| [\_ \_ Выравнивание звукового \_ блока MF MT \_](mf-mt-audio-block-alignment-attribute.md)             | Выравнивание блока.                                             |
| [\_ \_ \_ Среднее \_ число байт \_ в секунду для \_ звука MF MT](mf-mt-audio-avg-bytes-per-second-attribute.md) | Среднее число байтов в секунду (закодированная скорость).   |



 

Определены следующие параметры кодировки.



| Параметр Encoding                                                             | Описание                                                                |
|--------------------------------------------------------------------------------|----------------------------------------------------------------------------|
| [\_ \_ не разграниченияая \_ Вставка \_ кодировщика MF](mf-transcode-donot-insert-encoder.md) | Предотвращает вставку кодировщиком звукового потока в API-интерфейсе перекодировки. |
| [MF \_ \_ енкодингпрофиле](mf-transcode-encodingprofile.md)             | Указывает шаблон соответствия устройства. (Применяется только к файлам ASF.)    |
| [MF \_ \_ куалитивсспид](mf-transcode-qualityvsspeed.md)               | Задает компромисс между качеством кодирования и скоростью.                |



 

Необходимо задать атрибуты формата. Параметры кодировки необязательны.

Один из способов найти формат, совместимый с кодировщиком, — вызвать функцию [**мфтранскодежетаудиуутпутаваилаблетипес**](/windows/desktop/api/mfidl/nf-mfidl-mftranscodegetaudiooutputavailabletypes) . Требуемый кодировщик указывается подтипом. Функция возвращает коллекцию типов мультимедиа для этого кодировщика. Можно выбрать тип из списка и скопировать атрибуты в профиль. Пример кода, в котором используется такой подход, см. [в разделе Учебник. кодирование WMA-файла](tutorial--converting-an-mp3-file-to-a-wma-file.md).

### <a name="video-attributes"></a>Атрибуты видео

Чтобы добавить атрибуты для видеопотока, вызовите метод [**имфтранскодепрофиле:: сетвидеоаттрибутес**](/windows/desktop/api/mfidl/nf-mfidl-imftranscodeprofile-setvideoattributes). Эти атрибуты указывают, как кодируется поток видео. Если выходной файл не будет содержать поток видео, пропустите эти атрибуты.

Как и в случае с звуковыми атрибутами, атрибуты видео делятся на две категории:

-   Атрибуты, определяющие формат закодированного потока
-   Атрибуты, задающих другие параметры кодировки.

Атрибуты формата — это атрибуты типа мультимедиа, как описано в разделе [типы](video-media-types.md)видеоклипов. Ниже приведен список стандартных атрибутов формата видео.



| Атрибут Format                                                       | Описание                                                      |
|------------------------------------------------------------------------|------------------------------------------------------------------|
| [подтип MF \_ MT \_](mf-mt-subtype-attribute.md)                         | Подтип. См. раздел [GUID подтипа видео](video-subtype-guids.md). |
| [\_ \_ Частота кадров MF \_ MT](mf-mt-frame-rate-attribute.md)                  | Частота кадров.                                                  |
| [\_ \_ Размер пакета MF \_ MT](mf-mt-frame-size-attribute.md)                  | Размер кадра.                                                  |
| [**\_ \_ Средняя скорость MF \_ MT**](mf-mt-avg-bitrate-attribute.md)            | Средняя скорость потока.                                            |
| [пропорции MF \_ MT \_ пикселей \_ \_](mf-mt-pixel-aspect-ratio-attribute.md) | Пропорция в пикселях.                                          |



 

Определены следующие параметры кодировки.



| Параметр Encoding                                                             | Описание                                                                |
|--------------------------------------------------------------------------------|----------------------------------------------------------------------------|
| [\_ \_ не разграниченияая \_ Вставка \_ кодировщика MF](mf-transcode-donot-insert-encoder.md) | Предотвращает вставку кодировщика для видеопотока API перекодировки. |
| [MF \_ \_ енкодингпрофиле](mf-transcode-encodingprofile.md)             | Указывает шаблон соответствия устройства. (Применяется только к файлам ASF.)    |
| [MF \_ \_ куалитивсспид](mf-transcode-qualityvsspeed.md)               | Задает компромисс между качеством кодирования и скоростью.                |



 

Необходимо задать атрибуты формата. Параметры кодировки необязательны.

### <a name="container-attributes"></a>Атрибуты контейнера

Атрибуты контейнера определяют характеристики уровня файла выходного файла. Чтобы задать атрибуты контейнера, вызовите метод [**имфтранскодепрофиле:: сетконтаинераттрибутес**](/windows/desktop/api/mfidl/nf-mfidl-imftranscodeprofile-setcontainerattributes). Определены следующие атрибуты.



| attribute                                                                          | Описание                                                                                                                                            |
|------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------|
| [\_ \_ Настройка профиля для ПЕРЕкодирования MF \_](mf-transcode-adjust-profile.md)                  | Определяет параметры потока, используемые для топологии перекодирования. Можно установить флаги для использования параметров источника входных данных или использовать пользовательские атрибуты потока. |
| [MF \_ \_ контаинертипе](mf-transcode-containertype.md)                     | Задает формат выходного файла, например MP4 или ASF. На основе этого значения в топологию добавляется соответствующий приемник носителя.            |
| [\_код MF \_ пропустить \_ перенос метаданных \_](mf-transcode-skip-metadata-transfer.md) | Указывает, копируются ли метаданные из источника в выходной файл.                                                                               |
| [MF \_ \_ топологимоде](mf-transcode-topologymode.md)                       | Указывает, можно ли использовать аппаратные кодеки при кодировании.                                                                                |
| [\_Атрибут MFT фиелдофусе \_ Unlock \_](mft-fieldofuse-unlock-attribute.md)          | Разблокирует кодек с ограничениями на использование полей. Дополнительные сведения см. в разделе [ограничения использования](field-of-use-restrictions.md).              |



 

Требуется [атрибут \_ \_ КОНТАИНЕРТИПЕ для перекодирования MF](mf-transcode-containertype.md) . Другие атрибуты контейнера являются необязательными.

## <a name="creating-a-transcode-topology"></a>Создание топологии перекодирования

Топология перекодирования — это частичная топология, которая содержит источник мультимедиа, соответствующие кодеки и приемник мультимедиа. Чтобы создать топологию перекодирования, вызовите функцию [**мфкреатетранскодетопологи**](/windows/desktop/api/mfidl/nf-mfidl-mfcreatetranscodetopology) . Эта функция принимает в качестве входных данных следующие параметры:

-   Указатель на интерфейс [**имфмедиасаурце**](/windows/desktop/api/mfidl/nn-mfidl-imfmediasource) источника мультимедиа.
-   Имя выходного файла.
-   Указатель на интерфейс [**имфтранскодепрофиле**](/windows/desktop/api/mfidl/nn-mfidl-imftranscodeprofile) профиля перекодирования.

Функция возвращает указатель на интерфейс [**имфтопологи**](/windows/desktop/api/mfidl/nn-mfidl-imftopology) .

## <a name="running-the-encoding-session"></a>Выполнение сеанса кодирования

После создания топологии можно приступать к кодированию файла. На этом этапе профиль можно отменить.

1.  Вызовите [**мфкреатемедиасессион**](/windows/desktop/api/mfidl/nf-mfidl-mfcreatemediasession) , чтобы создать сеанс мультимедиа.
2.  Вызовите [**имфмедиасессион:: сеттопологи**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasession-settopology) , чтобы задать топологию для сеанса мультимедиа.
3.  Вызовите метод [**имфмедиасессион:: Start**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasession-start) , чтобы начать сеанс кодирования.
4.  Дождитесь события [месессионендед](mesessionended.md) .
5.  Вызовите метод [**имфмедиасессион:: Close**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasession-close) , чтобы закрыть сеанс мультимедиа.
6.  Дождитесь события [месессионклосед](mesessionclosed.md) .
7.  Вызов [**имфмедиасаурце:: Shutdown**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasource-shutdown).
8.  Вызов [**имфмедиасессион:: Shutdown**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasession-shutdown).

Большая часть времени, затраченного на кодирование, выполняется между шагами 3 и 4.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[API перекодирования](transcode-api.md)
</dt> <dt>

[Сведения о сеансе мультимедиа](about-the-media-session.md)
</dt> </dl>

 

 



