---
description: Мфплай — это API для создания приложений воспроизведения мультимедиа на C++.
ms.assetid: 55612f49-5995-4bdf-aa12-8a853e5a2b24
title: начало работы с Мфплай
ms.topic: reference
ms.date: 05/31/2018
ms.openlocfilehash: fd9e0405d3138a22e0d20e94849d416b29d62945
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104496800"
---
# <a name="getting-started-with-mfplay"></a>начало работы с Мфплай

\[Мфплай доступен для использования в операционных системах, указанных в разделе требования. В последующих версиях он может быть изменен или недоступен. \]

Мфплай — это API для создания приложений воспроизведения мультимедиа на C++.

В этом разделе содержатся следующие подразделы.

-   [Требования](#requirements)
-   [О Мфплай](#about-mfplay)
-   [Воспроизведение файла мультимедиа](#playing-a-media-file)
-   [Управление воспроизведением](#controlling-playback)
-   [Получение событий от проигрывателя](#receiving-events-from-the-player)
-   [Получение сведений о файле мультимедиа](#getting-information-about-a-media-file)
-   [Управление воспроизведением видео](#managing-video-playback)
-   [Ограничения Мфплай](#limitations-of-mfplay)
-   [См. также](#related-topics)

## <a name="requirements"></a>Требования

Для Мфплай требуется Windows 7.

## <a name="about-mfplay"></a>О Мфплай

Мфплай имеет простую модель программирования, предоставляя основной набор функций, которые требуются большинству приложений для воспроизведения. Приложение создает объект *Player* , управляющий воспроизведением. Для воспроизведения файла мультимедиа объект Player создает *элемент мультимедиа*, который можно использовать для получения сведений о содержимом файла мультимедиа. Приложение управляет воспроизведением с помощью методов в интерфейсе [**имфпмедиаплайер**](/windows/desktop/api/mfplay/nn-mfplay-imfpmediaplayer) объекта Player. При необходимости приложение может получать уведомления о событиях через интерфейс обратного вызова на следующей схеме показана эта процедура.

![Концептуальная схема: приложение и игрок указывают друг на друга, обе указывают на элемент мультимедиа, указывающий на файл мультимедиа](images/mfplay.png)

## <a name="playing-a-media-file"></a>Воспроизведение файла мультимедиа

Чтобы воспроизвести файл мультимедиа, вызовите функцию [**мфпкреатемедиаплайер**](/windows/desktop/api/mfplay/nf-mfplay-mfpcreatemediaplayer) .


```C++
// Global variables
IMFPMediaPlayer *g_pPlayer = NULL;

const WCHAR *sURL = L"C:\\Users\\Public\\Videos\\example.wmv";

HRESULT PlayVideo(HWND hwnd, const WCHAR* sURL)
{
    // Create the player object and play a video file.

    return MFPCreateMediaPlayer(
        sURL,
        TRUE,   // Start playback automatically?
        0,      // Flags.
        NULL,   // Callback pointer.
        hwnd,
        &g_pPlayer
        );
}
```



Функция [**мфпкреатемедиаплайер**](/windows/desktop/api/mfplay/nf-mfplay-mfpcreatemediaplayer) создает новый экземпляр объекта Player мфплай. Функция принимает следующие параметры:

-   Первый параметр — это URL-адрес открываемого файла. Это может быть локальный файл или файл на сервере мультимедиа.
-   Второй параметр указывает, запускается ли воспроизведение автоматически. Если задать для этого пареметер **значение true**, файл будет воспроизводиться, как только мфплай загрузит его.
-   Третий параметр задает различные параметры. Для параметров по умолчанию передайте ноль (0).
-   Четвертый параметр — это указатель на необязательный интерфейс обратного вызова. Этот параметр может иметь **значение NULL**, как показано ниже. Обратный вызов описан в разделе [получение событий от проигрывателя](#receiving-events-from-the-player).
-   Пятый параметр — это обработчик окна приложения. Если файл мультимедиа содержит видеопоток, то в клиентской области этого окна появится видео. Для воспроизведения только звука этот параметр может иметь **значение NULL**.

Последний параметр получает указатель на интерфейс [**имфпмедиаплайер**](/windows/desktop/api/mfplay/nn-mfplay-imfpmediaplayer) объекта Player.

Перед завершением работы приложения не забудьте освободить указатель [**имфпмедиаплайер**](/windows/desktop/api/mfplay/nn-mfplay-imfpmediaplayer) . Это можно сделать в обработчике сообщений **WM \_ Close** .


```C++
void OnClose(HWND /*hwnd*/)
{
    SafeRelease(&g_pPlayer);
    SafeRelease(&g_pPlayerCB);
    PostQuitMessage(0);
}
```



> [!Note]  
> В этом примере функция [саферелеасе](saferelease.md) используется для высвобождения указателей интерфейса.

 

Для простого воспроизведения видео это весь код, который вам нужен. В оставшейся части этого руководства будет показано, как добавить дополнительные функции, начиная с управления воспроизведением.

## <a name="controlling-playback"></a>Управление воспроизведением

Код, приведенный в предыдущем разделе, воспроизводит файл мультимедиа, пока не достигнет конца файла. Вы можете запустить воспроизведение, вызвав следующие методы в интерфейсе [**имфпмедиаплайер**](/windows/desktop/api/mfplay/nn-mfplay-imfpmediaplayer) :

-   [**Имфпмедиаплайер::P Аусе**](/windows/desktop/api/mfplay/nf-mfplay-imfpmediaplayer-pause) приостанавливает воспроизведение. Пока воспроизведение приостановлено, отображается последняя видеорамка, а звук не отображается в автоматическом режиме.
-   [**Имфпмедиаплайер:: Stop**](/windows/desktop/api/mfplay/nf-mfplay-imfpmediaplayer-stop) останавливает воспроизведение. Видео не отображается, а значение расположения воспроизведения сбрасывается до начала файла.
-   [**Имфпмедиаплайер::Pный макет**](/windows/desktop/api/mfplay/nf-mfplay-imfpmediaplayer-play) возобновляет воспроизведение после остановки или приостановки.

Следующий код приостанавливает или возобновляет воспроизведение при нажатии клавиши **пробел**.


```C++
//-------------------------------------------------------------------
// OnKeyDown
//
// Handles the WM_KEYDOWN message.
//-------------------------------------------------------------------

void OnKeyDown(HWND hwnd, UINT vk, BOOL fDown, int cRepeat, UINT flags)
{
    HRESULT hr = S_OK;

    switch (vk)
    {
    case VK_SPACE:

        // Toggle between playback and paused/stopped.
        if (g_pPlayer)
        {
            MFP_MEDIAPLAYER_STATE state = MFP_MEDIAPLAYER_STATE_EMPTY;
            
            g_pPlayer->GetState(&state);

            if (state == MFP_MEDIAPLAYER_STATE_PAUSED ||  
                state == MFP_MEDIAPLAYER_STATE_STOPPED)
            {
                g_pPlayer->Play();
            }
            else if (state == MFP_MEDIAPLAYER_STATE_PLAYING)
            {
                g_pPlayer->Pause();
            }
        }
        break;
    }
}
```



В этом примере вызывается метод [**имфпмедиаплайер::-State**](/windows/desktop/api/mfplay/nf-mfplay-imfpmediaplayer-getstate) для получения текущего состояния воспроизведения (пауза, остановка или воспроизведение), а также приостановка или возобновление соответственно.

## <a name="receiving-events-from-the-player"></a>Получение событий от проигрывателя

Мфплай использует интерфейс обратного вызова для отправки событий в приложение. Для этого обратного вызова существует две причины.

-   Воспроизведение выполняется в отдельном потоке. Во время воспроизведения могут возникнуть определенные события, например достижение конца файла. Мфплай использует обратный вызов для уведомления приложения о событии.
-   Многие методы [**имфпмедиаплайер**](/windows/desktop/api/mfplay/nn-mfplay-imfpmediaplayer) являются асинхронными, то есть они возвращаются до завершения операции. Асинхронные методы позволяют запустить операцию из потока пользовательского интерфейса, выполнение которого может занять много времени, не вызывая блокировки пользовательского интерфейса. После завершения операции Мфплай сигнализирует обратный вызов.

Чтобы получать уведомления обратного вызова, реализуйте интерфейс [**имфпмедиаплайеркаллбакк**](/windows/desktop/api/mfplay/nn-mfplay-imfpmediaplayercallback) . Этот интерфейс наследует **IUnknown** и определяет единственный метод [**онмедиаплайеревент**](/windows/desktop/api/mfplay/nf-mfplay-imfpmediaplayercallback-onmediaplayerevent). Чтобы настроить обратный вызов, передайте указатель на реализацию **имфпмедиаплайеркаллбакк** в параметре *пкаллбакк* функции [**мфпкреатемедиаплайер**](/windows/desktop/api/mfplay/nf-mfplay-mfpcreatemediaplayer) .

Ниже приведен первый пример из этого руководства, который был изменен для включения обратного вызова.


```
// Global variables.
IMFPMediaPlayer *g_pPlayer = NULL;
IMFPMediaPlayerCallback *g_pCallback = NULL;

// Call an application-defined function to create the callback object.
hr = CreateMyCallback(&g_pCallback);

// Create the player object and play a video file.

const WCHAR *sURL = L"C:\\Users\\Public\\Videos\\example.wmv";

if (SUCCEEDED(hr))
{
    hr = MFPCreateMediaPlayer(
        sURL,
        TRUE,        // Start playback automatically?
        0,           // Flags.
        g_pCallback, // Callback pointer.
        hwnd,
        &g_pPlayer
        );
}
```



Метод [**онмедиаплайеревент**](/windows/desktop/api/mfplay/nf-mfplay-imfpmediaplayercallback-onmediaplayerevent) имеет один параметр, который является указателем на структуру [**\_ \_ заголовков событий МФП**](/windows/desktop/api/mfplay/ns-mfplay-mfp_event_header) . Элемент **ивенттипе** этой структуры сообщает, какое событие произошло. Например, при запуске воспроизведения Мфплай отправляет событие **\_ \_ \_ воспроизведения типа события МФП** .

Каждый тип события имеет соответствующую структуру данных, содержащую сведения для этого события. Каждая из этих структур начинается с структуры [**\_ \_ заголовков событий МФП**](/windows/desktop/api/mfplay/ns-mfplay-mfp_event_header) . В ответном вызове приведите указатель **\_ \_ заголовка события МФП** к структуре данных, относящейся к конкретному событию. Например, если событие имеет тип **МФП \_ Play \_**, структура данных является [**\_ \_ событием МФП Play**](/windows/desktop/api/mfplay/ns-mfplay-mfp_play_event). В следующем коде показано, как справиться с этим событием в обратном вызове.


```
void STDMETHODCALLTYPE MediaPlayerCallback::OnMediaPlayerEvent(
    MFP_EVENT_HEADER *pEventHeader
    )
{
    switch (pEventHeader->eEventType)
    {
    case MFP_EVENT_TYPE_PLAY:
        OnPlay(MFP_GET_PLAY_EVENT(pEventHeader));
        break;

    // Other event types (not shown).

    }
}

// Function to handle the event.
void OnPlay(MFP_PLAY_EVENT *pEvent)
{
    if (FAILED(pEvent->header.hrEvent))
    {  
        // Error occurred during playback.
    }  
}
```



В этом примере используется [**событие \_ МФП \_ Get \_ Play**](/windows/desktop/api/mfplay/nf-mfplay-mfp_get_play_event) для приведения указателя *певенсеадер* к структуре [**событий МФП \_ Play \_**](/windows/desktop/api/mfplay/ns-mfplay-mfp_play_event) . Значение **HRESULT** из операции, вызвавшей событие, хранится в поле **хревент** структуры.

Список всех типов событий и соответствующих структур данных см. в разделе [**МФП \_ event \_ Type**](/windows/desktop/api/mfplay/ne-mfplay-mfp_event_type).

Примечание о многопоточности. по умолчанию Мфплай вызывает обратный вызов из того же потока, который вызвал [**мфпкреатемедиаплайер**](/windows/desktop/api/mfplay/nf-mfplay-mfpcreatemediaplayer). Этот поток должен иметь цикл обработки сообщений. Кроме того, можно передать **параметр МФП с \_ возможностью \_ освобождения \_ потокового \_ вызова** в параметре *креатионоптионс* **мфпкреатемедиаплайер**. Этот флаг заставляет Мфплай вызывать обратные вызовы из отдельного потока. Любой из этих параметров влияет на работу приложения. Параметр по умолчанию означает, что ваш обратный вызов не сможет выполнить никаких действий, ожидающих выполнения цикла обработки сообщений, например ожидания действия пользовательского интерфейса, так как он блокирует процедуру окна. Режим "бесплатный поток" означает, что для защиты любых данных, к которым вы обращаетесь при обратном вызове, необходимо использовать критические разделы. В большинстве случаев параметр по умолчанию является простейшим.

## <a name="getting-information-about-a-media-file"></a>Получение сведений о файле мультимедиа

При открытии файла мультимедиа в Мфплай проигрыватель создает объект, называемый *элементом мультимедиа* , представляющим файл мультимедиа. Этот объект предоставляет интерфейс [**имфпмедиаитем**](/windows/desktop/api/mfplay/nn-mfplay-imfpmediaitem) , который можно использовать для получения сведений о файле мультимедиа. Многие структуры событий Мфплай содержат указатель на текущий элемент мультимедиа. Вы также можете получить текущий элемент мультимедиа, вызвав [**имфпмедиаплайер:: жетмедиаитем**](/windows/desktop/api/mfplay/nf-mfplay-imfpmediaplayer-getmediaitem) на проигрывателе.

Два особенно полезных метода — [**имфпмедиаитем:: хасвидео**](/windows/desktop/api/mfplay/nf-mfplay-imfpmediaitem-hasvideo) и [**Имфпмедиаитем:: хасаудио**](/windows/desktop/api/mfplay/nf-mfplay-imfpmediaitem-hasaudio). Эти методы запрашивают, содержит ли источник мультимедиа видео или аудио.

Например, следующий код проверяет, содержит ли текущий файл мультимедиа поток видео.


```
IMFPMediaItem *pItem;
BOOL bHasVideo = FALSE;
BOOL bIsSelected = FALSE;

hr = g_pPlayer->GetMediaItem(TRUE, &pItem);
if (SUCCEEDED(hr))
{
    hr = pItem->HasVideo(&bHasVideo, &bIsSelected);
    pItem->Release();
}
```



Если исходный файл содержит поток видео, выбранный для воспроизведения, то для *бхасвидео* и *Бисселектед* устанавливается значение **true**.

## <a name="managing-video-playback"></a>Управление воспроизведением видео

Когда Мфплай воспроизводит видеофайл, он рисует видео в окне, которое вы указали в функции [**мфпкреатемедиаплайер**](/windows/desktop/api/mfplay/nf-mfplay-mfpcreatemediaplayer) . Это происходит в отдельном потоке, принадлежащем конвейеру воспроизведения Microsoft Media Foundation. В большинстве случаев для приложения не требуется управлять этим процессом. Однако существует две ситуации, когда приложение должно уведомлять Мфплай об обновлении видео.

-   Если воспроизведение приостановлено или остановлено, Мфплай должно быть уведомлено всякий раз, когда видеоокно приложения получает \_ сообщение WM Paint. Это позволяет Мфплай перерисовывать окно.
-   При изменении размера окна Мфплай должно быть уведомлено, чтобы можно было масштабировать видео в соответствии с новым размером окна.

Метод [**имфпмедиаплайер:: упдатевидео**](/windows/desktop/api/mfplay/nf-mfplay-imfpmediaplayer-updatevideo) обрабатывает оба варианта. Вызывайте этот метод в \_ обработчиках сообщений WM Paint и WM \_ size для окна видео.

> [!IMPORTANT]
> Вызовите функцию GDI **бегинпаинт** перед вызовом [**упдатевидео**](/windows/desktop/api/mfplay/nf-mfplay-imfpmediaplayer-updatevideo).

 


```
IMFPMediaPlayer *g_pPlayer;   // MFPlay player object

void OnSize(HWND hwnd, UINT state, int cx, int cy)
{
    HDC hdc;
    PAINTSTRUCT ps;

    if (g_pPlayer && (state == SIZE_RESTORED))
    {
        hdc = BeginPaint(hwnd, &ps);
        g_pPlayer->UpdateVideo();
         EndPaint(hwnd, &ps);
    }
}

void OnPaint(HWND hwnd)
{
    HDC hdc;
    PAINTSTRUCT ps;

    hdc = BeginPaint(hwnd, &ps);
    if (g_pPlayer)
    {
        g_pPlayer->UpdateVideo();
    }
      EndPaint(hwnd, &ps);
}
```



Если не указано иное, Мфплай отображает видео с правильными пропорциями, используя пустых при необходимости. Если вы не хотите сохранять пропорции, вызовите [**имфпмедиаплайер:: сетаспектратиомоде**](/windows/desktop/api/mfplay/nf-mfplay-imfpmediaplayer-setaspectratiomode) с флагом **мфвидеоармоде \_ None** . Это приведет к тому, что Мфплай растягивает видео для заполнения всего прямоугольника без пустых. Обычно следует использовать параметр по умолчанию и позволить Мфплай леттербокс видео. Цвет леттербокс по умолчанию — черный, но его можно изменить, вызвав [**имфпмедиаплайер:: сетбордерколор**](/windows/desktop/api/mfplay/nf-mfplay-imfpmediaplayer-setbordercolor).

## <a name="limitations-of-mfplay"></a>Ограничения Мфплай

Текущая версия Мфплай имеет следующие ограничения.

-   Мфплай не поддерживает содержимое, защищенное DRM.
-   По умолчанию Мфплай не поддерживает протоколы сетевой потоковой передачи. Дополнительные сведения см. в разделе [**имфпмедиаплайер:: креатемедиаитемфромурл**](/windows/desktop/api/mfplay/nf-mfplay-imfpmediaplayer-createmediaitemfromurl).
-   Мфплай не поддерживает списки воспроизведения на стороне сервера (Ссплс) или другие типы источников, которые воспроизводят более одного сегмента. В технических терминах Мфплай останавливает воспроизведение после первой презентации и игнорирует все события [меневпресентатион](menewpresentation.md) из источника мультимедиа.
-   Мфплай не поддерживает плавные переходы между источниками мультимедиа.
-   Мфплай не поддерживает смешивание нескольких видеопотоков.
-   Мфплай поддерживаются только форматы мультимедиа, которые поддерживаются встроенными в Media Foundation. (Сюда относятся сторонние Media Foundation компоненты, которые могут быть установлены в системе.)

## <a name="related-topics"></a>См. также

<dl> <dt>

[Использование Мфплай для воспроизведения звука и видео](using-mfplay-for-audio-video-playback.md)
</dt> </dl>

 

 



