---
description: В этом разделе описано, как преобразование Media Foundation (MFT) должно выполнять обработку изменений формата во время потоковой передачи.
ms.assetid: b0a94760-b4dd-4e50-a5ce-a1f674dde156
title: Обработка изменений в потоке
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e238073bf518bc875b7b2d536c758eab48c8502278aae6780999c7616430337e
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118974433"
---
# <a name="handling-stream-changes"></a>Обработка изменений в потоке

В этом разделе описано, как преобразование Media Foundation (MFT) должно выполнять обработку изменений формата во время потоковой передачи.

> [!IMPORTANT]
>
> Этот раздел не относится к кодировщикам. Кодировщики не должны распространять изменения формата, как описано в этом разделе. Кодировщики должны принимать только входной тип, совпадающий с настроенным типом выходных данных.

 

## <a name="overview-of-format-changes"></a>Общие сведения об изменениях формата

Обычно существует две причины, по которым формат может измениться во время потоковой передачи.

-   Клиент может переключиться в поток с новым форматом. Например, в цифровом телевизоре это может произойти из-за изменения канала.
-   В некоторых форматах видео, таких как H. 264, битовый поток может сигнализировать об изменении формата. К таким изменениям могут относиться изменения в поле превосходство, разрешение видео или пропорции пикселей.

Если тип кодировки изменится, клиенту может потребоваться удалить MFT из конвейера и заменить его другой MFT. (Например, клиенту может потребоваться поменять местами новый декодер.) Эта ситуация не рассматривается в этом разделе. В этом разделе рассматривается только тот случай, когда текущая таблица MFT может работать с новым форматом.

При изменении формата MFT может потребоваться новый тип входных данных, новый тип вывода или и то, и другое.

-   Изменения типа ввода инициируются клиентом. MFT никогда не изменяет собственный тип входных данных.
-   Изменения типа выходных данных инициируются MFT. MFT сообщает, что требуется новый тип выходных данных, и клиент согласовывает новый тип вывода с MFT.

Таким образом, возможны три разных варианта:

-   Клиент задает новый тип входных данных. Файловая Таблица MFT использует новый формат без изменения его типа вывода.
-   Клиент устанавливает новый тип входных данных, и это активирует изменение типа выходных данных.
-   Тип входных данных не изменяется, но MFT обнаруживает изменение формата в битовый поток, для которого требуется новый тип выходных данных.

## <a name="implementing-format-changes"></a>Реализация изменений формата

Оставшаяся часть этого раздела описывает, как клиент должен обработать изменение формата и как реализовать изменения формата в таблице MFT.

### <a name="output-type"></a>Тип выходных данных

Любые файлы MFT могут инициировать изменение типа выходных данных следующим образом:

1.  Клиент вызывает [**имфтрансформ::P роцессаутпут**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput). Основная таблица MFT реагирует следующим образом:
    1.  MFT не создает пример выходных данных в [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).
    2.  MFT задает флаг **\_ \_ \_ \_ \_ изменения формата буфера выходных данных MFT** в элементе **dwstatus устанавливается** структуры [**\_ \_ \_ буфера выходных данных MFT**](/windows/desktop/api/mftransform/ns-mftransform-mft_output_data_buffer) .
    3.  Метод [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) возвращает **\_ \_ \_ \_ изменение потока преобразования**, код ошибки MF E.
2.  Клиент вызывает [**имфтрансформ:: жетаутпутаваилаблетипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype). Этот метод возвращает обновленный набор выходных типов.
3.  Клиент вызывает [**сетаутпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) для установки нового типа выходных данных.
4.  Клиент возобновляет вызов метода [**ProcessInput**](/windows/desktop/api/mfidl/nf-mfidl-imfqualitymanager-notifyprocessinput) / [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).

### <a name="input-type"></a>Тип входных данных

Изменения типа входных данных инициируются клиентом, а не MFT. Если тип ввода изменяется, он может активировать изменение типа выходных данных.

Точная последовательность событий зависит от значения атрибута [**MFT, \_ поддерживающего \_ динамическое \_ \_ изменение формата**](mft-support-dynamic-format-change-attribute.md) .



| Значение     | Описание                                                     |
|-----------|-----------------------------------------------------------------|
| **FALSE** | Прежде чем клиент установит новый тип входных данных, он должен очистить MFT. |
| **TRUE**  | Клиент может задать новый тип входных данных без очистки MFT.   |



 

MFT предоставляет этот атрибут через его метод [**имфтрансформ:: InAttribute**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes) . Значение этого атрибута по умолчанию равно **false**. Если в таблице MFT не задан атрибут, значение следует рассматривать как **false**.

**\_ \_ Динамическое \_ изменение формата MFT \_ имеет значение false**

1.  Клиент отправляет сообщение о [**\_ \_ \_ стоке команды сообщения MFT**](mft-message-command-drain.md) .
2.  Клиент перейдет MFT, вызвав [**имфтрансформ::P роцессаутпут**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) до тех пор, пока **ProcessOutput** возвращает для **\_ преобразования MF E \_ \_ требуется \_ больше \_ входных данных**.
3.  Клиент вызывает [**имфтрансформ:: сетинпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) для установки нового типа входных данных.
4.  MFT проверяет тип входных данных. Если тип является недопустимым, [**сетинпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) возвращает **MF \_ E \_ инвалидмедиатипе** или другой код ошибки. В противном случае **сетинпуттипе** возвращает значение S \_ ОК.
5.  Предполагая, что входной тип является допустимым, MFT проверяет, изменяется ли тип выходных данных. Если нет, потоковая передача продолжается, и дальнейшие действия не требуются.
6.  Если тип выходных данных изменится:
    1.  Файл MFT делает текущий тип выходного носителя недействительным и обновляет список доступных типов выходных носителей.
    2.  При следующем вызове метода [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) возвращается значение **MF \_ E \_ преобразования \_ Stream \_**, как описано в предыдущем разделе.
    3.  Клиент вызывает [**имфтрансформ:: жетаутпутаваилаблетипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) , чтобы получить обновленный список типов выходных данных.
    4.  Клиент вызывает [**сетаутпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype).

**\_Поддерживается \_ динамическое \_ \_ изменение формата MFT**

1.  Клиент вызывает [**имфтрансформ:: сетинпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) для установки нового типа входных данных.
2.  MFT проверяет тип входных данных. Если тип является недопустимым, [**сетинпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) возвращает **MF \_ E \_ инвалидмедиатипе** или другой код ошибки. В противном случае **сетинпуттипе** возвращает значение S \_ ОК.
3.  Предполагая, что входной тип является допустимым, MFT проверяет, изменяется ли тип выходных данных. Если нет, потоковая передача продолжается, и дальнейшие действия не требуются.
4.  Перед изменением типа выходных данных MFT должен обработать все кэшированные входные примеры, как показано ниже.
    1.  Таблица MFT не делает ее текущим типом вывода.
    2.  MFT создает столько выходных данных, сколько можно из кэшированных входных примеров.
    3.  Необязательно, принимает ли MFT новые входные образцы во время обработки кэшированных образцов. В этом случае новые входные образцы будут использовать новый формат входных данных, поэтому MFT должен отследить точку при изменении формата.
5.  После того как MFT обработает все примеры, полученные перед изменением типа входных данных, [**имфтрансформ::P роцессаутпут**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) возвращает значение **MF \_ E \_ преобразования \_ потока \_**.
6.  Файл MFT делает текущий тип выходных данных недействительным и обновляет список доступных типов выходных носителей.
7.  Клиент согласовывает новый тип вывода, как описано выше.

[Асинхронный МФТС](asynchronous-mfts.md) должен возвращать значение **true** для атрибута [**MFT, \_ поддерживающего \_ динамическое \_ \_ изменение формата**](mft-support-dynamic-format-change-attribute.md) . При использовании асинхронной таблицы MFT клиент может предположить, что для **атрибута \_ \_ динамической настройки \_ формата \_ MFT** задано значение **true**.

Если [**\_ \_ динамическое \_ \_ изменение формата MFT**](mft-support-dynamic-format-change-attribute.md) имеет **значение true**, основное различие заключается в том, что клиенту не требуется выполнять сток MFT перед установкой нового типа входных данных. В результате тип входных данных может измениться, когда MFT удерживается на входных образцах. Очень важно, чтобы в MFT не было просто удалять эти образцы. Кроме того, тип выходных данных не может измениться, пока MFT обрабатывает все кэшированные данные.

Предыдущий абзац применяется особенно для видеодекодеров, которые могут принимать промежуточные кадры из временного порядка, и поэтому их необходимо кэшировать. Если таблица MFT не кэширует входные образцы, то сток является, по сути, отсутствием операций. В этом случае MFT может установить [**\_ \_ динамическое \_ \_ изменение формата MFT**](mft-support-dynamic-format-change-attribute.md) на **false** (или оставить атрибут неопределенным).

Кроме того, обратите внимание, что каждый MFT должен правильно работать с изменениями формата после его очистки. В [**\_ \_ динамическом атрибуте \_ \_ изменения формата MFT**](mft-support-dynamic-format-change-attribute.md) указывается, поддерживает ли MFT изменение формата без стока.

## <a name="change-in-interlace-mode"></a>Изменение в режиме чередования

Изменения в режиме чередования видео являются особым случаем, так как они не делают недействительными текущий тип носителя. Вместо этого для каждого видеокадра задается режим чередования, устанавливая атрибуты на примере носителя. Видеофайл MFT должен проверять каждый входной образец на наличие этих флагов.

Режим чересстрочная развертки может изменяться, когда поле превосходство переключается от верхнего поля к нижнему полю или когда видео переключается между последовательными и чередованиями изображений.

Дополнительные сведения см. [в разделе чередование флагов в примерах](video-interlacing.md).

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Запись пользовательского MFT](writing-a-custom-mft.md)
</dt> </dl>

 

 



