---
description: Эта статья содержит рекомендации по созданию гистограмм при декодировании видео с помощью API-интерфейсов Direct3D 11 или 12.
ms.assetid: ''
title: Гистограммы для расшифровки видео Direct3D
ms.topic: article
ms.date: 08/19/2019
ms.openlocfilehash: 6e25abd39ba95b669c2d76ced5f825ea80c4e3c6
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105719266"
---
# <a name="direct3d-video-decode-histograms"></a>Гистограммы для расшифровки видео Direct3D

Эта статья содержит рекомендации по созданию гистограмм при декодировании видео с помощью API-интерфейсов Direct3D 11 или 12.

## <a name="checking-the-video-device-for-histogram-capabilities"></a>Проверка видеоустройства на наличие возможностей гистограммы

Перед созданием гистограмм необходимо проверить, поддерживает ли текущее видеоустройство функцию гистограммы для декодирования видео.

### <a name="direct3d-12"></a>Direct3D 12

Вызовите [ID3D12VideoDevice:: чеккфеатуресуппорт](/windows/desktop/api/d3d12video/nf-d3d12video-id3d12videodevice-checkfeaturesupport) , чтобы проверить сведения о поддержке для операций декодирования видео Direct3D 12. Передайте значение **D3D12_FEATURE_VIDEO_DECODE_HISTOGRAM** из перечисления [D3D12_FEATURE_VIDEO](/windows/desktop/api/d3d12video/ne-d3d12video-d3d12_feature_video) , чтобы указать, что вы запрашиваете поддержку для гистограмм для расшифровки видео.

### <a name="direct3d-11"></a>Direct3D 11

Вызовите [ID3D11VideoDevice2:: чеккфеатуресуппорт](/windows/win32/api/d3d11_4/nf-d3d11_4-id3d11videodevice2-checkfeaturesupport) и передайте значение **D3D11_FEATURE_VIDEO_DECODER_HISTOGRAM** [D3D11_FEATURE_VIDEO](/windows/win32/api/d3d11_4/ne-d3d11_4-d3d11_feature_video) , чтобы определить, поддерживаются ли гистограммы для текущего устройства.

## <a name="enabling-histogram-during-decode"></a>Включение гистограммы во время декодирования

Коллекция данных гистограммы включает вызывающий объект, предоставляющий буферы, в которых хранятся данные гистограммы.  Пустой выходной буфер гистограммы для данного компонента указывает на то, что коллекция гистограмм отключена.

### <a name="direct3d-12"></a>Direct3D 12

Чтобы предоставить буферы вывода для получения данных гистограммы с помощью Direct3D 12, необходимо создать список команд декодирования с помощью метода [ID3D12VideoDecodeCommandList1::D ecodeframe1](/windows/win32/api/d3d12video/nf-d3d12video-id3d12videodecodecommandlist1-decodeframe1) . Этот метод принимает в качестве аргумента структуру [D3D12_VIDEO_DECODE_OUTPUT_STREAM_ARGUMENTS1](/windows/win32/api/d3d12video/ns-d3d12video-d3d12_video_decode_output_stream_arguments1) . **D3D12_VIDEO_DECODE_OUTPUT_STREAM_ARGUMENTS1** имеет поле типа [D3D12_VIDEO_DECODE_OUTPUT_HISTOGRAM](/windows/win32/api/d3d12video/ns-d3d12video-d3d12_video_decode_output_histogram), которое позволяет указать [ID3D12Resource](/windows/win32/api/d3d12/nn-d3d12-id3d12resource) , в который выводятся данные гистограммы.

### <a name="direct3d-11"></a>Direct3D 11

Интерфейс [ID3D11VideoContext3](/windows/win32/api/d3d11_4/nn-d3d11_4-id3d11videocontext3) предоставляет метод [DecoderBeginFrame1](/windows/win32/api/d3d11_4/nf-d3d11_4-id3d11videocontext3-decoderbeginframe1) , который позволяет предоставить один или несколько интерфейсов [ID3D11Buffer](/windows/win32/api/d3d11/nn-d3d11-id3d11buffer) , в которые будут выводиться данные гистограммы. [D3D11_VIDEO_DECODER_HISTOGRAM_COMPONENT](/windows/win32/api/d3d11_4/ne-d3d11_4-d3d11_video_decoder_histogram_component) для указания компонентов, для которых необходимо создавать данные гистограммы.


## <a name="buffer-format"></a>Формат буфера

Выходные данные гистограммы записываются в буфер в виде целочисленного счетчика на каждый компонент.  Формат буфера — это 32-битное значение для каждой ячейки.  Устройство может использовать битовую глубину целочисленного счетчика, размер которой меньше 32 бит, но должен иметь длину 16, 24 или 32 бит.  Если да, значение счетчика сохраняется в младших битах, а верхние неиспользуемые биты равны нулю.  Когда количество для ячейки превысит максимальное значение, устройство задает вместо этого максимальное значение. Устройства сообщают о количестве поддерживаемых ячеек, которое должно быть степенью числа 2.  Минимальное число ячеек, необходимых для устройств, поддерживающих эту функцию, — 64. 

Необходимо предоставить буфер с согласованным смещением в 256 байт и размером, который является поддерживаемым числом ячеек, умноженным на размер ячейки (4 байта) для каждого запрошенного компонента.  Расположение ячейки определяется следующим образом:

`binIndex = floor(value / [max value of channel + 1] * (countBins))`


Если формат определяет полезные биты компонента, меньший, чем число битов хранилища (например, P010 использует 10 верхних бит из 16 бит хранилища компонентов), учитываются только полезные биты (P010 обрабатывается как 10-разрядное значение). 

Видеоустройство сообщает о том, какие компоненты поддерживаются.  Если для вызывающего объекта не требуется гистограмма для данного компонента, они указывают nullptr.  Если драйвер не поддерживает гистограмму для данного компонента, то буфер гистограммы этого компонента должен быть nullptr.

Если поддерживается несколько компонентов, приложение может запросить любое сочетание компонентов для каждого кадра.  Например, если в отчетах об оборудовании поддерживаются компоненты Y, U и V, то приложение может запросить гистограмму Y только для одного кадра, гистограммы U — только для двух кадров, а гистограмма — только для кадра 3.  Они также могут запросить любое сочетание двух компонентов или всех трех компонентов.

Приложения предоставляют отдельные смещение и указатель буфера или обработчика для каждого запрошенного компонента.  Этот указатель может указывать на тот же ресурс, что и другой компонент или отдельный ресурс.  Смещение позволяет разместить несколько компонентов в одном буфере, но выходная область, заданная смещением и размером гистограммы, не должна пересекаться с другими выходными данными компонента гистограммы.  Гистограмма также может быть записана в тот же буфер, что и другое несвязанное содержимое, например при использовании в стратегии подраспределений ресурсов.


Среда выполнения D3D проверяет, что вызывающие объекты включают только гистограмму для поддерживаемых компонентов, смещенное смещение буфера и размер буфера достаточно для сообщаемого количества ячеек.


## <a name="protected-content"></a>Защищенное содержимое

Буферы гистограммы должны иметь ту же защиту поверхности, что и область вывода декодирования. Если поверхность вывода декодирования не является защищенным ресурсом, буфер гистограммы не должен быть защищенным ресурсом. Если область вывода декодирования является защищенным ресурсом, то гистограмма должна быть защищенным ресурсом.








## <a name="related-topics"></a>См. также

<dl> <dt>
[API-интерфейсы](direct3d-12-video-apis.md) 
 видео Direct3D 12 [Media Foundationое программное руководством](media-foundation-programming-guide.md)
</dt> </dl>

 

 




