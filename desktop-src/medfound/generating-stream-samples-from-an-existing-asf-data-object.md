---
description: Создание образцов потоков из существующего объекта данных ASF
ms.assetid: eb27f122-d958-495d-98ea-8befd105a9a8
title: Создание образцов потоков из существующего объекта данных ASF
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 97fb99440c3fc4721851f183b3bfc7aefafd3f652d0436b29e9cea1209ba59b4
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118974453"
---
# <a name="generating-stream-samples-from-an-existing-asf-data-object"></a>Создание образцов потоков из существующего объекта данных ASF

Объект- *Разделитель* ASF — это компонент уровня вмконтаинер, который анализирует объект данных ASF в файле ASF.

Перед передачей пакетов данных в разделитель приложение должно инициализировать, настроить и выбрать потоки в разделителе, чтобы подготовить их для процесса анализа. Дополнительные сведения см. в разделе [Создание объекта РАЗДЕЛИТЕЛЯ ASF](creating-the-asf-splitter-object.md) и [Настройка объекта разделителя ASF](configuring-the-asf-splitter-object.md).

Ниже перечислены методы, необходимые для синтаксического анализа объекта данных ASF.

-   [**Имфасфсплиттер::P арседата**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfsplitter-parsedata) , который начинает процесс анализа путем помещения в разделитель буфера, содержащего пакеты данных.
-   [**Имфасфсплиттер:: жетнекстсампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfsplitter-getnextsample) , собирающий потоковые примеры, созданные из буфера, переданного в разделитель.

## <a name="finding-the-data-offset"></a>Поиск смещения данных

Перед началом процесса анализа приложение должно располагать объект данных в файле ASF. Существует два способа получить смещение объекта данных от начала файла:

-   Перед инициализацией объекта Контентинфо можно вызвать метод [**имфасфконтентинфо:: жесеадерсизе**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfcontentinfo-getheadersize) . Для этого метода требуется буфер, который содержит первые 30 байт заголовка ASF. Он возвращает размер всего заголовка, указывающего смещение первого пакета данных. Это значение также включает размер заголовка объекта данных 50 байт.
-   После инициализации объекта Контентинфо можно получить дескриптор представления, вызвав [**имфасфконтентинфо:: женератепресентатиондескриптор**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfcontentinfo-generatepresentationdescriptor), а затем запросив дескриптор представления для атрибута [**\_ \_ \_ \_ \_ смещения начальной загрузки данных MF PD ASF**](mf-pd-asf-data-start-offset-attribute.md) . Значением этого атрибута является размер заголовка.
    > [!Note]  
    > Атрибут [**\_ \_ \_ \_ длины данных в формате MF PD ASF**](mf-pd-asf-data-length-attribute.md) в дескрипторе представления определяет длину объекта данных ASF.

     

В обоих случаях возвращаемое значение — это размер объекта заголовка плюс размер раздела заголовка объекта данных. Таким образом, полученное значение является смещением к началу пакетов данных в объекте данных ASF. После начала отправки данных в разделитель данные должны начинаться с этого смещения с начала файла ASF.

Значение смещения передается в качестве параметра в **парседата** , который начинает процесс анализа.

Объект данных делится на пакеты данных. Каждый пакет данных содержит заголовок пакета данных, который предоставляет сведения о синтаксическом анализе пакетов и полезных данных — фактические данные цифрового мультимедиа. В сценарии поиска приложению может потребоваться, чтобы разделитель начал синтаксический анализ в определенном пакете данных. Для этого можно использовать индексатор ASF для получения смещения. Индексатор возвращает значение смещения, которое начинается с границы пакета. Если индексатор не используется, убедитесь, что смещение начинается в начале заголовка пакета данных. Если в разделитель передается недопустимое смещение, например, значение не указывает на границу пакета, вызовы **парсехеадер** и **жетнекстсампле** выполняются успешно, но **жетнекстсампле** не получает никаких выборок и принимает **значение NULL** в параметре *псампле* .

Если разделитель настроен для синтаксического анализа в обратном направлении, разделитель всегда начинает анализ в конце буфера мультимедиа, который передается в **парседата**. Таким образом, для отмены синтаксического анализа в вызове **парседата** передайте смещение в параметре *кбленгс* , который задает длину данных и устанавливает *кббуффероффсет* в ноль.

## <a name="generating-samples-for-asf-data-packets"></a>Создание образцов для пакетов данных ASF

Приложение начинает процесс синтаксического анализа, передавая пакеты данных в разделитель. Входные данные для разделителя — это ряд буферов мультимедиа, содержащих все фрагменты объекта данных или. Выходные данные разделителя — это ряд примеров мультимедиа, содержащих данные пакета.

Чтобы передать входные данные в разделитель, создайте буфер мультимедиа и заполните его данными из раздела "объект данных" ASF-файла. (Дополнительные сведения о буферах мультимедиа см. в разделе [буферы мультимедиа](media-buffers.md).) Затем передайте буфер мультимедиа методу [**имфасфсплиттер::P арседата**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfsplitter-parsedata) . Также можно указать:

-   Смещение в буфере, с которого разделитель должен начать анализ. Если смещение равно нулю, анализ начинается в начале буфера. Дополнительные сведения о настройке смещения данных см. в подразделе «Поиск смещения данных» этого раздела.
-   Объем анализируемых данных. Если это значение равно нулю, разделитель анализируется до достижения конца буфера, как указано в методе [**имфмедиабуффер:: жеткуррентленгс**](/windows/desktop/api/mfobjects/nf-mfobjects-imfmediabuffer-getcurrentlength) .

Разделитель создает образцы мультимедиа, ссылаясь на данные в буферах мультимедиа. Клиент может получить выходные примеры, вызвав [**имфасфсплиттер:: жетнекстсампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfsplitter-getnextsample) в цикле, пока не будет больше данных для синтаксического анализа. Если **жетнекстсампле** возвращает \_ \_ флаг статусфлагс неполный ASF в параметре *пдвстатусфлагс* , это означает, что есть больше примеров для извлечения, и приложение может снова вызвать **жетнекстсампле** . В противном случае вызовите **парседата** , чтобы передать больше данных в разделитель. Для созданных образцов разделитель задает следующие сведения:

-   Разделитель задает отметку времени для всех создаваемых образцов. Время образца представляет время презентации и не включает в себя время предподготовки. Приложение может вызвать [**имфсампле:: жетсамплетиме**](/windows/desktop/api/mfobjects/nf-mfobjects-imfsample-getsampletime) , чтобы получить время презентации в единицах 100-наносекундных.
-   Если прерывание происходит во время создания образца, разделитель задает атрибут [**Немфсампликстенсионности \_**](mfsampleextension-discontinuity-attribute.md) в первом примере после прекращения его выполнения. Прекращение обычно вызывается отброшенными пакетами сетевого подключения, повреждением данных файлов или переключением разделителя из одного исходного потока в другой.
-   Для видео разделитель проверяет, содержит ли пример ключевой кадр. Если это так, разделитель устанавливает атрибут [**мфсампликстенсион \_ клеанпоинт**](mfsampleextension-cleanpoint-attribute.md) в образце.

Если разделитель анализирует пакеты данных, полученные с сервера мультимедиа, длина пакета может быть переменной. В этом случае клиент должен вызвать **парседата** для каждого пакета и установить атрибут [**\_ \_ границы пакета мфасфсплиттер**](mfasfsplitter-packet-boundary-attribute.md) в каждом буфере, который отправляется в разделитель. Этот атрибут указывает элементу Splitter, содержит ли буфер мультимедиа начало пакета ASF. Присвойте атрибуту **значение true** , если в буфере содержится начало нового пакета. Если буфер содержит продолжение предыдущего пакета, присвойте атрибуту **значение false**. Буферы не могут охватывать несколько пакетов.

Перед передачей новых буферов мультимедиа в разделитель приложение должно вызвать [**имфасфсплиттер:: Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfsplitter-flush). Этот метод сбрасывает разделитель и очищает любой частичный кадр, который ожидает завершения. Это полезно в сценарии поиска, когда смещение находится в другом месте.

### <a name="example"></a>Пример

В следующем примере кода показано, как анализировать пакеты данных. В этом примере выполняется анализ с начала объекта данных до конца потока и отображаются сведения о примерах, содержащих ключевые кадры. Полный пример использования этого кода см. в разделе [учебник. чтение файла ASF](tutorial--reading-an-asf-file.md).


```C++
// Parse the video stream and display information about the video samples.
//
// The current read position of the byte stream must be at the start of the ASF
// Data Object.

HRESULT DisplayKeyFrames(IMFByteStream *pStream, IMFASFSplitter *pSplitter)
{
    const DWORD cbReadSize = 2048;  // Read size (arbitrary value)

    IMFMediaBuffer *pBuffer = NULL;
    IMFSample *pSample = NULL;

    HRESULT hr = S_OK;
    while (SUCCEEDED(hr))
    {
        // The parser must get a newly allocated buffer each time.
        hr = MFCreateMemoryBuffer(cbReadSize, &pBuffer);
        if (FAILED(hr))
        {
            break;
        }

        // Read data into the buffer.
        hr = ReadFromByteStream(pStream, pBuffer, cbReadSize);
        if (FAILED(hr)) 
        {
            break; 
        }

        // Get the amound of data that was read.
        DWORD cbData;
        hr = pBuffer->GetCurrentLength(&cbData);
        if (FAILED(hr)) 
        { 
            break; 
        }

        if (cbData == 0)
        {
            break; // End of file.
        }

        // Send the data to the ASF splitter.
        hr = pSplitter->ParseData(pBuffer, 0, 0);
        SafeRelease(&pBuffer);
        if (FAILED(hr)) 
        { 
            break; 
        }

        // Pull samples from the splitter.
        DWORD parsingStatus = 0;
        do
        {
            WORD streamID;
            hr = pSplitter->GetNextSample(&parsingStatus, &streamID, &pSample);
            if (FAILED(hr)) 
            { 
                break; 
            }
            if (pSample == NULL)
            {
                // No samples yet. Parse more data.
                break;
            }
            if (IsRandomAccessPoint(pSample))
            {
                DisplayKeyFrame(pSample);
            }
            SafeRelease(&pSample);
            
        } while (parsingStatus & ASF_STATUSFLAGS_INCOMPLETE);
    }
    SafeRelease(&pSample);
    SafeRelease(&pBuffer);
    return hr;
}
```



## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Разделитель ASF](asf-splitter.md)
</dt> </dl>

 

 



