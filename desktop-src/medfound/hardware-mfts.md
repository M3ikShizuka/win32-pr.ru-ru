---
description: В этом разделе описывается написание Media Foundation преобразования (MFT), которое выступает в качестве прокси-сервера для аппаратного кодировщика, декодера или процессора цифровых сигналов (DSP).
ms.assetid: 9922d403-5d0d-433f-ad9f-c86142ac0f46
title: Оборудование МФТС
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 532fef959e2c2b5946d5a27ad98106a2e25cc77f8426c0a871e821c7298a69f4
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119724941"
---
# <a name="hardware-mfts"></a>Оборудование МФТС

> [!Note]  
> этот раздел относится к Windows 7 и более поздних версий.

 

В этом разделе описывается написание Media Foundation преобразования (MFT), которое выступает в качестве прокси-сервера для аппаратного кодировщика, декодера или процессора цифровых сигналов (DSP).

> [!IMPORTANT]
> Если аппаратный кодек использует драйвер класса мультимедиа Австреам, для него не требуется настраиваемая таблица MFT. Для этой цели Media Foundation предоставляет прокси-сервер Австреам. Сведения в этом разделе относятся только к особому случайУ, когда аппаратный кодек не использует Австреам. Дополнительные сведения см. [в разделе Поддержка аппаратных кодеков в австреам](https://msdn.microsoft.com/library/dd568169.aspx).

 

Этот раздел состоит из следующих подразделов.

-   [Введение](#introduction)
-   [Атрибуты оборудования MFT](#hardware-mft-attributes)
-   [Последовательность подтверждения оборудования](#hardware-handshake-sequence)
-   [Обработка данных](#data-processing)
-   [Парный декодер и кодировщик](#paired-decoderencoder)
-   [Связанные темы](#related-topics)

## <a name="introduction"></a>Введение

Любой аппаратный кодек, который не основан на Австреам, должен предоставлять собственный MFT для использования в качестве прокси-сервера для драйвера. Аппаратный кодек может включать несколько отдельных функциональных блоков:

-   Кодировщик
-   Показан
-   Масштабирование кадров и преобразование формата

Каждая из этих функций должна управляться отдельной таблицей MFT. Оборудование MFT не должно действовать как многозначный "транспрограммный". Вместо этого следует размещать функции кодирования в файле MFT кодировщика и декодировать функции в MFT декодера. Если оборудование обеспечивает масштабирование кадров и преобразование форматов, разместите эти функции в отдельном видеопроцессоре, зарегистрированном в категории **MFT " \_ \_ \_ обработчик видео** ". Если оборудование не поддерживает масштабирование кадров или преобразование формата, Media Foundation предоставляет обработчик видео по.

Оборудование МФТС имеет следующие общие требования.

-   Оборудование МФТС должно использовать новую модель асинхронной обработки, как описано в разделе [асинхронная МФТС](asynchronous-mfts.md).
-   Оборудование МФТС должно поддерживать динамические изменения формата, как описано в разделе [динамические изменения формата](basic-mft-processing-model.md).

## <a name="hardware-mft-attributes"></a>Атрибуты оборудования MFT

Оборудование MFT должно реализовывать следующие методы, связанные с атрибутами:

-   [**Имфтрансформ:: OutAttribute**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes): Возвращает хранилище атрибутов для глобальных атрибутов MFT.
-   [**Имфтрансформ:: жетинпутстреаматтрибутес**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputstreamattributes): Возвращает хранилище атрибутов для входного потока.
-   [**Имфтрансформ:: жетаутпутстреаматтрибутес**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreamattributes): Возвращает хранилище атрибутов для выходного потока.

Когда таблица MFT создается впервые, она должна задать следующие атрибуты в собственном хранилище глобальных атрибутов (то есть хранилищем атрибутов, возвращаемом методом [**InAttribute**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes)):



| attribute                                                                                    | Описание                                                                                                                                                                            |
|----------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [\_ \_ асинхронное преобразование MF](mf-transform-async.md)                                               | Необходимо задать значение **true**. Указывает, что MFT выполняет асинхронную обработку.                                                                                                      |
| [\_ \_ Атрибут аппаратного \_ URL-адреса перечисления MFT \_](mft-enum-hardware-url-attribute.md)                   | Содержит символьную ссылку для аппаратного устройства.<br/> Загрузчик топологии использует наличие этого атрибута для проверки того, представляет ли MFT устройство.<br/> |
| [**Основная таблица MFT \_ поддерживает \_ \_ изменение динамического формата \_**](mft-support-dynamic-format-change-attribute.md) | Необходимо задать значение **true**. Указывает, что MFT поддерживает изменения динамического формата.                                                                                                       |



 

## <a name="hardware-handshake-sequence"></a>Последовательность подтверждения оборудования

Если два МФТС представляют одно и то же физическое устройство, они могут обмениваться данными внутри оборудования, например, через аппаратную шину. Нет необходимости копировать данные в системную память, а затем обратно на устройство.

На следующей схеме МФТС, обозначенные как "A" и "B", представляют функциональные блоки в одном и том же оборудовании. Например, в сценарии перекодировки "A" может представлять аппаратный декодер, а "B" — аппаратный кодировщик. Поток данных между "A" и "B" находится в пределах оборудования. MFT с меткой "C" — это программная MFT. Поток данных из "B" в "C" использует системную память.

![Диаграмма с полями, обозначенными с помощью c, и аппаратным кодеком: a указывает на b и кодек, кодек указывает на b, а b указывает на c](images/proxy-mft.png)

Для установления аппаратного подключения два МФТС оборудования должны использовать частный канал связи. Это соединение устанавливается во время согласования формата до установки типов мультимедиа и перед первым вызовом [**ProcessInput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput). Процесс подключения работает следующим образом.

1.  Загрузчик топологии проверяет оба МФТС на наличие атрибута [ \_ \_ \_ \_ атрибута аппаратного URL-адреса перечисления MFT](mft-enum-hardware-url-attribute.md) . Обратите внимание, что он не проверяет значение этого атрибута.
2.  Если [ \_ атрибут " \_ \_ URL- \_ адрес аппаратного обеспечения перечисления MFT](mft-enum-hardware-url-attribute.md) " существует в обоих МФТС, то загрузчик топологии выполняет следующие действия:
    1.  Загрузчик топологии вызывает [**имфтрансформ:: жетаутпутстреаматтрибутес**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreamattributes) в вышестоящей MFT (а). Этот метод возвращает указатель [**имфаттрибутес**](/windows/desktop/api/mfobjects/nn-mfobjects-imfattributes) . Пусть этот указатель обозначен *пупстреам*.
    2.  Загрузчик топологии вызывает [**имфтрансформ:: жетинпутстреаматтрибутес**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputstreamattributes) в ПОДЧИНЕННОЙ таблице MFT (B). Этот вызов также возвращает указатель [**имфаттрибутес**](/windows/desktop/api/mfobjects/nn-mfobjects-imfattributes) . Пусть этот указатель обозначен *пдовнстреам*.
    3.  Загрузчик топологии задает атрибут [ \_ связанного \_ потока \_ MFT](mft-connected-stream-attribute.md) для *пдовнстреам* , вызывая [**имфаттрибутес:: сетункновн**](/windows/desktop/api/mfobjects/nf-mfobjects-imfattributes-setunknown). Значением атрибута является указатель *пупстреам* .
    4.  Загрузчик топологии задает **значение true** для [MFT, \_ подключенного к атрибуту \_ \_ \_ потока оборудования](mft-connected-to-hw-stream.md) , в *пдовнстреам* и *пупстреам*.
3.  На этом этапе подчиненная таблица MFT имеет указатель на вышестоящее хранилище атрибутов MFT, как показано на следующей схеме.

    ![схема с каждым МФТС, указывающим на свой поток, каждый поток, указывающий на его хранилище, и входное хранилище с пунктирной линией в выходное хранилище](images/proxy-mft2.png)

    > [!Note]  
    > Для ясности на этой диаграмме показаны потоки, а атрибуты хранятся как отдельные объекты, но это не является обязательным для реализации.

     

4.  В подчиненной таблице MFT для установления частного канала связи с вышестоящей MFT используется указатель [**имфаттрибутес**](/windows/desktop/api/mfobjects/nn-mfobjects-imfattributes) . Так как канал является частным, точный механизм определяется реализацией. Например, Таблица MFT может запрашивать частный COM-интерфейс.

На шаге 4 нисходящий файл MFT должен проверить, имеет ли две МФТС одно и то же физическое устройство. В противном случае они должны возвращаться к использованию системной памяти для передачи данных. Это позволит таблице MFT правильно работать с программным обеспечением МФТС и другими аппаратными устройствами.

Если подтверждение проходит, а два МФТС совместно используют закрытый канал данных, они не используют стандартную модель обработки данных (описанную в следующем разделе) в точке подключения. В частности, подчиненная таблица MFT не отправляет события [метрансформнидинпут](metransformneedinput.md) . Дополнительные сведения см. в следующем разделе этой статьи.

## <a name="data-processing"></a>Обработка данных

Если оборудование MFT использует системную память для передачи данных, этот процесс работает следующим образом.

1.  Чтобы запросить дополнительные входные данные, MFT отправляет событие [метрансформнидинпут](metransformneedinput.md) .
2.  Событие [метрансформнидинпут](metransformneedinput.md) заставляет конвейер вызывать [**Имфтрансформ::P роцессинпут**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput).
3.  Когда файл MFT содержит выходные данные, MFT отправляет событие [метрансформхавеаутпут](metransformhaveoutput.md) .
4.  Событие [метрансформхавеаутпут](metransformhaveoutput.md) заставляет конвейер вызывать [**Имфтрансформ::P роцессаутпут**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).

Дополнительные сведения см. в статье [асинхронный МФТС](asynchronous-mfts.md).

Однако если в MFT используется аппаратный канал, он не отправляет эти события в точке подключения оборудования, так как вся передача данных выполняется внутри оборудования. Поэтому конвейер не вызывает [**ProcessInput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput) или [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) в точке соединения.

Например, рассмотрим первую диаграмму в этом разделе. При данной конфигурации обработка данных будет происходить следующим образом:

1.  "A" отправляет [метрансформнидинпут](metransformneedinput.md) для запроса данных.
2.  Конвейер вызывает метод [**ProcessInput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput) для "A".
3.  "A" и "B" обрабатывают данные в оборудовании.
4.  После завершения обработки "B" отправляет событие [метрансформхавеаутпут](metransformhaveoutput.md) .
5.  Конвейер вызывает [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) для "B".

## <a name="paired-decoderencoder"></a>Парный декодер и кодировщик

Если декодер и кодировщик расположены в одной микросхеме оборудования, то при перекодировании может оказаться предпочтительным их использование вместе. То есть выбор одного из них должен привести к выбору другого в конвейере перекодирования. Чтобы убедиться, что выбраны соответствующие аппаратные кодеки, оба кодека МФТС должны предоставлять пользовательский тип мультимедиа. Чтобы создать пользовательский тип мультимедиа, сделайте следующее:

-   Задайте для атрибута " [**\_ \_ основной \_ тип MF MT**](mf-mt-major-type-attribute.md) " **мфмедиатипе \_ аудио** или **мфмедиатипе \_ видео** соответствующим образом.
-   Установите атрибут [**\_ \_ подтипа MF MT**](mf-mt-subtype-attribute.md) в значение настраиваемого идентификатора GUID.

Другие атрибуты типа являются необязательными. Декодер возвращает пользовательский тип из [**имфтрансформ:: жетаутпутаваилаблетипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype), а кодировщик возвращает пользовательский тип из метода [**Имфтрансформ:: жетинпутаваилаблетипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) . В обоих случаях пользовательский тип должен быть первой записью в списке (*двтипеиндекс* = 0).

Для работы с программными кодеками кодек должен также возвращать по крайней мере один стандартный формат, например NV12 для видео. Стандартные форматы должны отображаться после пользовательского типа (*двтипеиндекс* > 0). Если два кодека всегда должны быть парными и не могут взаимодействовать с программными кодеками, МФТС должен возвращать только пользовательский формат и не возвращать стандартные форматы.

> [!Note]  
> Если декодер не возвращает ни одного стандартного формата, его нельзя использовать для воспроизведения с [улучшенным модулем подготовки видео](enhanced-video-renderer.md). В этом случае он должен быть зарегистрирован как декодер только для кодирования. См. раздел [декодеры только для кодирования](implementing-a-codec-mft.md).

 

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Запись пользовательского MFT](writing-a-custom-mft.md)
</dt> <dt>

[Реализация MFT кодека](implementing-a-codec-mft.md)
</dt> <dt>

[Преобразования Media Foundation](media-foundation-transforms.md)
</dt> </dl>

 

 




