---
description: В этом разделе описывается, когда и как использовать приемника файлов H. 264/AVC Ремукс в формате MFT и MP4.
ms.assetid: 1DD236D9-775B-4417-BC49-BF52A6B3C8AD
title: Когда и как использовать H. 264/AVC Ремукс MFT и Sink MP4
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a6ce5b6d63a21e7a9d6b75acd29690cdeaeba5b0105dcf8d45fe0c93e6b768f3
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119357954"
---
# <a name="when-and-how-to-use-h264avc-remux-mft-and-mp4-sink"></a>Когда и как использовать H. 264/AVC Ремукс MFT и Sink MP4

В этом разделе описывается, когда и как использовать приемника файлов H. 264/AVC Ремукс в формате MFT и MP4.

## <a name="when-to-use-h264avc-remux-mft"></a>Когда следует использовать таблицу MFT Ремукс в H. 264/AVC

Формат файла MPEG-4 требует, чтобы каждый сжатый пример содержал один основной рисунок с числом NAL-единиц в правильном порядке. (См. Описание основного и обязательного порядка NAL-единиц в разделе 7.4.1.2.3, **порядок NAL-единиц и кодированных изображений и ассоциаций с единицами доступа** в спецификации H. 264 AVC.) Также требуется, чтобы каждый сжатый пример был связан с меткой времени презентации, отметкой времени декодирования и длительностью выборки.

Во многих случаях, когда приложениям нужно записывать видео H. 264/AVC в контейнер файлов MPEG-4, сжатый пример может не удовлетворять приведенным выше требованиям. Например, один сжатый пример может не содержать полного основного изображения или иметь соответствующую метку времени презентации. Вот несколько примеров приложений:

-   Запись в файл звукозаписи H. 264/AVC — простейшее видео в контейнер файлов MPEG-4.
-   Запись о камере, записанной камерой H. 264/AVC (простейшее видео в контейнере файлов MPEG-4).
-   Запись видео о видеоконференции H. 264/AVC в контейнере файлов MPEG-4.
-   Объединение двух видео в формате H. 264/AVC в MPEG-2 TS или MP4 и запись в контейнер файлов MPEG-4 с правильными штампами времени.
-   Ремукс H. 264/AVC Video из формата файлов АВЧД, MPEG-2 TS/PS в формат файлов MPEG-4.
-   Обрезать видеофайл H. 264/AVC без перекодирования.

В этом случае приложению необходимо использовать файл MFT ремукс. 264/AVC для преобразования сжатых образцов, не содержащих полного основного изображения, перед их записью в контейнер файлов MPEG-4.

## <a name="how-to-use-h264avc-remux-mft-and-mp4-sink"></a>Как использовать H. 264/AVC Ремукс MFT и Sink MP4

Задайте для параметра Тип выходного носителя источника значение **мфвидеоформат \_ H264 Single bitrate \_ ES**, указывающее, что каждый пример может не содержать полного основного изображения. Задайте тип входного носителя для приемника MP4 в **мфвидеоформат \_ H264 Single bitrate**. Таким образом, тип входного носителя MFT ремукс. 264/AVC — **мфвидеоформат \_ H264 Single bitrate \_ ES** , а тип выходных данных — **264 \_ ремукс**, который будет автоматически вставлен в сопоставитель топологии.

Длительность выборки игнорируется с помощью H. 264/AVC ремукс, так как время выборки для образца, не содержащего полное основное изображение, не имеет ясного значения. Вместо этого длительность выборки вычисляется по частоте кадров. Частота кадров вычисляется на основе параметра Sequence. Если сведения не существуют в параметре последовательности, частота кадров вычисляется на основе параметров входного типа носителя. Если сведения о частоте кадров недоступны, используется частота кадров по умолчанию 29,97 кадров/с.

H. 264/AVC ремукс MFT линейно интерполирует метки времени декодирования для каждого сжатого изображения в соответствии с частотой кадров. H. 264/AVC ремукс MFT учитывает метки времени входной презентации (PTS) во входных примерах и передает их в выходные данные, если они существуют. Он выполняет PTS интерполяцию в соответствии с частотой кадров, предыдущим PTS и порядком вывода изображения через декодированный процесс буферизации изображений (DBP), как указано в **приложении C. 4.5.3 процесс поднятия** в спецификации H. 264 AVC. Каждый пример выходных данных из файла MFT в таблице H. 264/AVC ремукс должен иметь PTS, DTS и длительность выборки. H. 264/AVC ремукс MFT также определяет изображения IDR в битовый поток и задает их как чистую точку с помощью атрибута MF [мфсампликстенсион \_ клеанпоинт](mfsampleextension-cleanpoint-attribute.md).

В настоящее время Таблица MFT ремукс. 264/AVC может поддерживать не более 64 переупорядоченных кадров. Если число переупорядоченных кадров превышает 64 с выходным кадром долгосрочной ссылки, то MFT ремукс. 264/AVC будет интерполирует неверное PTS для этого кадра и выводит кадр в неправильное время.

Чтобы создать экземпляр файла MFT ремукс в формате H. 264/AVC, задайте правильные типы входных и выходных данных в MFT-файле H. 264/AVC ремукс, задайте тип входного носителя для приемника MP4 и устраните топологию.

В следующем примере кода показано, как инициализировать журнал MFT. 264/AVC ремукс и приемник MP4.

Для H. 264/AVC ремукс MFT


```C++
hr = CoCreateInstance(
            CLSID_CMSH264RemuxMFT,
            NULL,
            CLSCTX_INPROC_SERVER,
            IID_IMFTransform,
            (void**) &pIMFTransform
            );
```



Никакая дополнительная настройка не требуется.

Для приемника MP4


```C++
IMFByteStream*  pMFBSOutputFile = NULL;
hr = MFCreateFile(
    MF_ACCESSMODE_READWRITE,
    MF_OPENMODE_DELETE_IF_EXIST,
    MF_FILEFLAGS_NONE,
    m_pszOutputFile,
    &pMFBSOutputFile);
if(FAILED(hr))
{
    Log(L"ERROR>> Failed to create output file for MP4 Sink (hr=0x%x)", hr);
    break;
}

hr = MFCreateMPEG4MediaSink(
    pMFBSOutputFile,
    (guidMajorType == MFMediaType_Video) ? pMediaType : NULL,  // pMediaType comes from the output type of the remux MFT
    (guidMajorType == MFMediaType_Audio) ? pMediaType : NULL,
    &m_pMediaSink);
if(FAILED(hr))
{
    Log(L"ERROR>> Failed to create MP4 Sink (hr=0x%x)", hr);
    break;
}
hr = m_pMediaSink->GetStreamSinkByIndex(0, &pStream);
```



## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Поддерживаемые форматы мультимедиа в Media Foundation](supported-media-formats-in-media-foundation.md)
</dt> </dl>

 

 



