---
description: 'В этом разделе обсуждаются три взаимосвязанные темы: защищенная среда, шлюз взаимодействия с мультимедиа, а также отзыв и обновление.'
ms.assetid: e88806ae-0041-4b4a-a8df-69718a651e82
title: Путь к защищенному носителю
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 7304edadf1623d41bc2f1f5c6b2b4cda2dd5f598
ms.sourcegitcommit: d75fc10b9f0825bbe5ce5045c90d4045e3c53243
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2021
ms.locfileid: "127461994"
---
# <a name="protected-media-path"></a>Путь к защищенному носителю

В этом разделе обсуждаются три взаимосвязанные темы: защищенная среда, шлюз взаимодействия с мультимедиа, а также отзыв и обновление.

-   защищенная среда (PE) — это набор технологий, которые позволяют защищенному содержимому передаваться из Windows Vista в защищенном режиме. Все компоненты в защищенной среде являются доверенными, и процесс защищен от несанкционированного доступа.
-   Путь к защищенному носителю (PMP) — это исполняемый файл, который выполняется в защищенной среде.
-   Если доверенный компонент в PE становится скомпрометированным, после завершения процесса он будет отозван. Однако корпорация Майкрософт предоставляет механизм продления для установки более новой доверенной версии компонента, когда он станет доступным.

дополнительные сведения о подписывания кода для компонентов, защищенных мультимедиа, см. в техническом документе [подпись для компонентов защищенного носителя в Windows Vista](/windows-hardware/test/hlk/).

Этот раздел состоит из следующих подразделов.

-   [Защищенная среда](#protected-environment)
-   [Структура защищенной среды](#design-of-the-protected-environment)
-   [Путь к защищенному носителю](#protected-media-path)
    -   [Входные доверенные центры](#input-trust-authorities)
    -   [Выходные данные доверенных центров](#output-trust-authorities)
    -   [Объекты политики](#policy-objects)
    -   [Создание объектов в PMP](#creating-objects-in-the-pmp)
-   [Общие сведения о согласовании политик](#overview-of-policy-negotiation)
-   [Отзыв и продление](#revocation-and-renewal)
-   [Защита выходной ссылки](#output-link-protection)
-   [Связанные темы](#related-topics)

## <a name="protected-environment"></a>Защищенная среда

Защита содержимого охватывает несколько технологий, каждая из которых пытается гарантировать, что содержимое не может использоваться способом, который не согласуется с намерением владельца содержимого или поставщика. К таким технологиям относятся защита от копирования, защита канала, условный доступ и управление цифровыми правами (DRM). Основой каждого из них является доверие: доступ к содержимому предоставляется только программным компонентам, которые соответствуют условиям использования, назначенным этому содержимому.

чтобы избежать угроз безопасности защищенного содержимого, Windows Vista и Media Foundation программное обеспечение позволяют доверенному коду выполняться в защищенной среде. PE — это набор компонентов, руководств и средств, предназначенных для повышения защиты от пиратства содержимого.

Прежде чем тщательно изучить PE, важно понимать, какие угрозы он разрабатывает для уменьшения. Предположим, что вы используете приложение мультимедиа в процессе пользовательского режима. Приложение связывается с различными динамическими библиотеками (DLL), которые содержат подключаемые модули мультимедиа, такие как декодеры. Другие процессы также выполняются в пользовательском режиме, и в ядре загружаются различные драйверы. Если механизм доверия отсутствует, существуют следующие угрозы.

-   Приложение может получить доступ к защищенному носителю напрямую или взломать память процесса.
-   Подключаемые модули могут получить доступ к содержимому напрямую или взломать память процесса.
-   Другие процессы могут взломать память процесса мультимедиа либо напрямую, либо путем внедрения кода.
-   Драйверы ядра могут заломать память процесса мультимедиа.
-   Содержимое может быть отправлено за пределы системы с незащищенным носителем. (Защита ссылок разработана для устранения этой угрозы.)

## <a name="design-of-the-protected-environment"></a>Структура защищенной среды

Защищенная среда выполняется в отдельном защищенном процессе из приложения мультимедиа. функция защищенного процесса Windows Vista останавливает доступ других процессов к защищенному процессу.

При создании защищенного процесса основные компоненты ядра определяют ненадежные компоненты и подключаемые модули, чтобы защищенная среда могла отказаться от их загрузки. Доверенный компонент — это тот, который подписан корпорацией Майкрософт соответствующим образом. Ядро также отслеживает модули, которые загружают в него, что позволяет защищенной среде прекращать воспроизведение защищенного содержимого при загрузке ненадежного модуля. Перед загрузкой компонента ядра ядро проверяет, является ли он доверенным. В противном случае доверенные компоненты, уже наявляющиеся в PE, отказывается обрабатывать защищенное содержимое. Чтобы включить эту функцию, компоненты PE периодически выполняют шифрование с помощью криптографического шифрования с ядром. При наличии ненадежного компонента режима ядра подтверждение соединения завершается неудачей и сообщает PE, что ненадежный компонент существует.

Если доверенный компонент станет скомпрометированным, после завершения процесса его можно отозвать. Корпорация Майкрософт предоставляет механизм продления для установки более новой доверенной версии, если она доступна.

## <a name="protected-media-path"></a>Путь к защищенному носителю

Путь к защищенному носителю (PMP) — это основной исполняемый файл PE для Media Foundation. PMP является расширяемой, поэтому можно поддерживать сторонние механизмы защиты содержимого.

PMP принимает защищенное содержимое и связанные политики из любого источника Media Foundation с помощью любой системы защиты содержимого, включая те, которые предоставляются сторонними производителями. Он отправляет содержимое в любой приемник Media Foundation, если приемник соответствует политикам, указанным в источнике. Он также поддерживает преобразование между источником и приемником, включая преобразования сторонних производителей, если они являются доверенными.

PMP выполняется в защищенном процессе, изолированном от приложения мультимедиа. Приложение имеет возможность обмениваться сообщениями команды и управления с PMP, но не имеет доступа к содержимому после его передачи в PMP. Этот процесс представлен на схеме ниже.

![Схема пути к защищенному носителю](images/pmp04.png)

Затененные поля представляют компоненты, которые могут быть предоставлены третьими сторонами. Все компоненты, созданные внутри защищенного процесса, должны быть подписаны и доверены.

Приложение создает экземпляр сеанса мультимедиа внутри защищенного процесса и получает указатель на сеанс службы прокси-сервера, который маршалирует указатели интерфейса в пределах границ процесса.

Источник мультимедиа можно создать в рамках процесса приложения, как показано ниже, или внутри защищенного процесса. Если источник мультимедиа создается внутри процесса приложения, источник создает прокси-сервер для самого себя в защищенном процессе.

Все остальные компоненты конвейера, такие как декодеры и приемники мультимедиа, создаются в защищенном процессе. Если эти объекты предоставляют пользовательские интерфейсы для приложений, они должны предоставить прокси-сервер или заглушку DCOM для маршалирования интерфейса.

Чтобы применить политику к защищенному содержимому при передаче через конвейер, PMP использует три типа компонентов: входные центры сертификации (ИТАС), выходные центры доверия (Отас) и объекты политик. Эти компоненты взаимодействуют для предоставления или ограничения прав на использование содержимого, а также для указания защиты ссылок, которые должны применяться при воспроизведении содержимого, например цифровой Защита содержимого с высокой пропускной способностью.

### <a name="input-trust-authorities"></a>Входные доверенные центры

Значение ITA создается доверенным источником мультимедиа и выполняет несколько функций:

-   Указывает права на использование содержимого. Права могут включать в себя право на воспроизведение содержимого, их перенос на устройство и т. д. Он определяет упорядоченный список утвержденных систем защиты выходных данных и соответствующие политики вывода для каждой системы. Объект ITA хранит эти сведения в объекте политики.
-   Предоставляет расшифровку, необходимую для расшифровки содержимого.
-   Устанавливает отношение доверия с модулем ядра в защищенной среде, чтобы обеспечить выполнение ITA в доверенной среде.

ITA связывается с отдельным потоком, содержащим защищенное содержимое. Поток может иметь только одно значение ITA, а экземпляр ITA может быть связан только с одним потоком.

### <a name="output-trust-authorities"></a>Выходные данные доверенных центров

OTA связан с надежным выходом. OTA предоставляет действие, которое может выполняться доверенным выходом для содержимого, например воспроизведением или копированием. Его роль заключается в применении одной или нескольких систем защиты выходных данных, необходимых для ITA. OTA запрашивает объект политики, предоставленный ITA, чтобы определить, какую систему защиты необходимо применить.

### <a name="policy-objects"></a>Объекты политики

Объект политики инкапсулирует требования к защите содержимого от ITA. Он используется ядром политики для согласования поддержки защиты содержимого с OTA. Отас объекты политики запросов, чтобы определить, какие системы защиты должны быть применены к каждому выходному содержимому текущего содержимого.

### <a name="creating-objects-in-the-pmp"></a>Создание объектов в PMP

Чтобы создать объект в защищенном пути носителя (PMP), [**имфмедиасаурце**](/windows/desktop/api/mfidl/nn-mfidl-imfmediasource) вызывает [**Имфпмфостапп:: активатеклассбид**](/windows/desktop/api/mfidl/nf-mfidl-imfpmphostapp-activateclassbyid)с указанным входным параметром **IStream** , форматированным следующим образом:

``` syntax
Format: (All DWORD values are serialized in little-endian order)
[GUID (content protection system guid, obtained from Windows.Media.Protection.MediaProtectionSystemId)]
[DWORD (track count, use the actual track count even if all tracks are encrypted using the same data, note that zero is invalid)]
[DWORD (next track ID, use -1 if all remaining tracks are encrypted using the same data)]
[DWORD (next track's binary data size)]
[BYTE* (next track's binary data)]
{ Repeat from "next track ID" above for each stream }
```

## <a name="overview-of-policy-negotiation"></a>Общие сведения о согласовании политик

Чтобы защищенное содержимое можно было обрабатывать в PMP, необходимо выполнить три фундаментальных требования. Во первых, защищенное содержимое должно отправляться только в доверенные выходные данные. Во-вторых, только разрешенные действия должны быть применены к потоку. В-третьих, для воспроизведения потока необходимо использовать только утвержденные системы защиты выходных данных. Подсистема политик координирует между ИТАС и Отас, чтобы обеспечить соблюдение этих требований.

самый простой способ понять процесс — это проанализировать упрощенный пример, который определяет шаги, необходимые для воспроизведения содержимого ASF, защищенного Windows Media Digital Rights Management (WMDRM).

Когда пользователь запускает приложение проигрывателя и открывает ASF-файл с защищенным звуковым потоком и защищенным видеопотоком, необходимо выполнить следующие действия.

1.  Приложение создает источник носителя ASF и сеанс защищенного пути к носителю (PMP). Media Foundation создает процесс PMP.
2.  Приложение создает частичную топологию, содержащую узел источника аудио, подключенный к модулю подготовки звука, и узел источника видео, подключенный к расширенному модулю обработки видео (Евр). Для модулей подготовки отчетов приложение не создает модуль подготовки отчетов напрямую. Вместо этого приложение создает в незащищенном процессе объект, известный как *объект активации*. PMP использует объект активации для создания модулей подготовки отчетов в защищенном процессе. (Дополнительные сведения об объектах активации см. в разделе [объекты активации](activation-objects.md).)
3.  Приложение задает частичную топологию в сеансе PMP.
4.  Сеанс PMP сериализует топологию и передает ее в узел PMP в защищенном процессе. Узел PMP отправляет топологию в модуль политики.
5.  Загрузчик топологии вызывает [**имфинпуттрустаусорити::**](/windows/desktop/api/mfidl/nf-mfidl-imfinputtrustauthority-getdecrypter) ИТАС в и вставляет его в топологию сразу же после подчинения соответствующих исходных узлов.
6.  Загрузчик топологии вставляет аудио и видеодекодеры, расположенные перед узлами дешифратора.
7.  Модуль политики сканирует вставленные узлы, чтобы определить, реализуют ли они интерфейс [**имфтрустедаутпут**](/windows/desktop/api/mfidl/nn-mfidl-imftrustedoutput) . Евр и модуль подготовки звука реализуют **имфтрустедаутпут**, так как они отправляют данные за пределами PMP.
8.  Каждый объект ITA подтверждает, что он выполняется внутри защищенного процесса, выполняя согласование криптографического соединения с модулем ядра защищенной среды.
9.  Для каждого потока модуль политики согласовывает политику путем получения объекта политики из ITA и передачи его в OTA. OTA предоставляет список систем защиты, которые она поддерживает, а объект политики указывает, какие системы защиты должны быть применены вместе с правильными параметрами. Затем OTA применяет эти параметры. Если это невозможно, содержимое блокируется.

## <a name="revocation-and-renewal"></a>Отзыв и продление

Доверенный компонент может быть отозван, если он подвергается компрометации или обнаруживается, чтобы нарушать лицензионные соглашения, с которым она была изначально доверенной. Для установки более новой, более надежной версии компонента существует механизм продления.

Надежные компоненты подписываются с помощью криптографического сертификата. Корпорация Майкрософт публикует Глобальный список отзыва (GRL), который определяет отозванные компоненты. GRL имеет цифровую подпись, чтобы обеспечить его подлинность. Владельцы содержимого могут гарантировать, что в механизме политики текущая версия GRL установлена на компьютере пользователя.

## <a name="output-link-protection"></a>Защита выходной ссылки

При просмотре содержимого видео уровня "Премиум" расшифрованные несжатые кадры перемещаются по физическому соединителю на устройство отображения. Поставщики содержимого могут потребовать, чтобы на этом этапе были защищены кадры видео, так как они перемещаются по физическому соединителю. Для этой цели существуют различные механизмы защиты, в том числе High-Bandwidth цифровые Защита содержимого (HDCP) и Дисплайпорт Защита содержимого (ДПКП). Видеоадаптер беспроводной связи применяет эти средства защиты с помощью [Output Protection Manager](output-protection-manager.md) (ОПМ). Диспетчер выходной защиты отправляет команды драйверу графики, а графический драйвер применяет все механизмы защиты ссылок, необходимые для политики.

![Схема, показывающая отношение между видео OTA и ОПМ.](images/pmp05.png)

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[О Media Foundation](about-the-media-foundation-sdk.md)
</dt> <dt>

[Архитектура Media Foundation](media-foundation-architecture.md)
</dt> <dt>

[Защита содержимого на основе GPU](gpu-based-content-protection.md)
</dt> <dt>

[Диспетчер выходной защиты](output-protection-manager.md)
</dt> <dt>

[Сеанс PMP мультимедиа](pmp-media-session.md)
</dt> </dl>

 

 
