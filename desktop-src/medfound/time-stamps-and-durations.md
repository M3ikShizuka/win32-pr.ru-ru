---
description: В этом разделе описывается, как преобразования Media Foundation должны управлять штампами времени.
ms.assetid: 4ab576ce-becd-4736-921e-e463c0dff841
title: Метки времени и длительности
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 2323c11fa0e3ec2b2b2d5ba1cefe4f5d5fa80c5b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104155311"
---
# <a name="time-stamps-and-durations"></a>Метки времени и длительности

В этом разделе описывается, как [преобразования Media Foundation](media-foundation-transforms.md) должны управлять штампами времени.

Файл MFT должен задавать как можно более точную отметку времени и продолжительность во всех выходных образцах. Для простой таблицы MFT, которая принимает один входной буфер и полностью обрабатывает его в выходном буфере, файл MFT должен просто скопировать отметку времени и длительность непосредственно из примера входных данных в образец Output. Однако многие преобразования сложнее, чем это, и могут потребовать более сложных вычислений времени вывода. Все МФТС должны соблюдать следующие основные правила.

-   Файловая Таблица MFT должна попытаться установить метку времени и длительность на всех несжатых образцах видео или звука, если для входных образцов задана точная метка времени или длительность, и их можно вычислить. Для некоторых меток времени вывода может потребоваться интерполяция, особенно для декодеров.
-   Метки времени и длительности входных образцов должны сохраняться в выходных данных как можно больше.
-   Метки времени вывода или длительности могут не соответствовать входным данным, так как MFT удерживает обратную передачу данных или разбивает выходные данные на части, размеры которых отличаются от входных. В этом случае MFT должна вычислить метку времени вывода из самого раннего входного образца, содержащего данные, используемые для создания образца выходных данных. Чтобы вычислить отметку времени вывода, добавьте метку времени для соответствующего входного образца на время, которое уже было преобразовано из этого образца. Второй пример в конце этого раздела иллюстрирует эту идею.
-   Если входные образцы имеют длительность, эта длительность должна быть сохранена. Если у входного образца нет длительности, MFT следует вычислить длительность по возможности из размера выходного буфера или скорости передачи данных, заданной типом носителя.
-   Вычисленные длительности должны быть усечены (округляются вниз), а не округляться до ближайшего приращения. У конвейера достаточно времени для обработки длительности, которые немного неточны, но для конвейера проще обрабатывалась длительность в 1% слишком короткая, чем длительность 1%. С другой стороны, нет смысла в сокращении длительности, за исключением округления.

### <a name="decoders"></a>Декодеров

Декодер преобразует сжатые пакеты в несжатые данные. Поскольку выходные данные не сжаты, декодеры имеют специальное обязательство для получения правильных меток времени и длительности. Некоторые сжатые форматы, в частности, MPEG-2, не имеют штампов времени во всех входящих пакетах и часто не имеют длительности какого-либо пакета. Для этих форматов декодер отвечает за размещение допустимой отметки времени и длительности для каждого выходного образца, суммируя неявные длительности всех выходных данных с момента последнего ввода-вывода с помощью последней отметки времени.

Для видео, если длительность недоступна в сжатом формате, декодер должен вычислить продолжительность в виде обратной величины частоты кадров, преобразованную в единицы с частотой в 100 НС и округляя вниз.

Для звукового сигнала, если длительность недоступна в сжатом формате, декодер должен вычислить продолжительность как обратную частоту выборки звука, умноженную на число выборок в выходном буфере, преобразованное в единицы в 100-наносекундных единиц и округление вниз.

Единственный раз, когда преобразование должно выводить пример без отметки времени, является то, что Таблица MFT никогда не получала метку времени на входном образце или если нет способа вычислить точную метку времени вывода из предыдущей входной метки времени.

### <a name="audio-decoders"></a>Звуковые декодеры

Для звуковых декодеров продолжительность каждого образца выходных данных вычисляется на основе частоты выборки звука и количества выборок PCM на канал в выходном буфере.

Правильный способ вычисления меток времени вывода зависит от того, содержат ли входные образцы метки времени.

Если входные образцы содержат отметки времени, декодер вычисляет метки времени вывода из меток времени ввода, как показано ниже.

-   Если каждый входной буфер содержит один или несколько полных сжатых кадров без частичных кадров, то метка времени вывода равна входной метке времени, за вычетом известной задержки декодера. Например, декодер Dolby Digital (AC-3) имеет задержку 256 примеров PCM. Например, при частоте выборки 48-кГц задержка составляет 5,33 миллисекунд (МС). Таким образом, если метка времени ввода составляет 1000 мс, то метка времени вывода составляет 1000 – 5,33 = 994,66 МС. Если входной буфер содержит более одного целого сжатого кадра, декодер выдает один выходной пример для каждого кадра во входном примере. Все выходные образцы будут правильно отмечаться метками времени, что не содержит пробелов.
-   В зависимости от формата транспорта входной буфер может содержать частичные кадры. Например, буфер может содержать часть кадра из предыдущего входного буфера, за которой следуют один или несколько полных кадров, а затем начало следующего кадра. В этом случае, как правило, предполагается, что метка времени ввода соответствует первому кадру, который начинается в буфере. (То есть, частичный кадр, запущенный в предыдущем буфере, не включается в отметку времени текущего буфера.) Соответствующим образом Вычислите отметку времени вывода.

Если входные образцы не содержат метки времени:

-   Декодер должен создавать собственные отметки времени, устанавливая нулевую отметку времени вывода.
-   Длительность выборки вычисляется на основе количества выходных выборок в буфере и частоты выборки.
-   Последующие отметки времени вычисляются на основе предыдущей метки времени и длительности: текущая метка времени + текущая длительность = Следующая отметка времени. В метках времени вывода не должно быть пробелов.

Если входной поток изначально содержит штампы времени, но по какой-либо причине не имеет отметки времени, декодер должен продолжать создавать собственные метки времени вывода, чтобы они были непрерывными и не пропасть.

Если входной поток содержит отметки времени, но при этом возникают промежутки времени, декодер просто распространяет эти пропуски. Иными словами, декодер не должен пытаться исправить несоответствующие отметки времени во входном потоке.

### <a name="mixers"></a>миксерс

> [!Note]  
> В Windows Vista конвейер Media Foundation не поддерживает МФТС с более чем одним входом. В Windows 7 поддерживаются множественные входные МФТС.

 

Микшер принимает несколько входов и смешивает их в один выход. Если входные потоки не полностью заблокированы или немного смещены по времени друг от друга, может быть неоднозначность того, какое время должно быть задано для выходных данных. Ниже приведены некоторые рекомендации в зависимости от типа носителя.

-   Аудиосигнал. При запуске или сразу после очистки или сброса звука звуковые МИКШЕРЫ должны дожидаться создания выходных образцов, пока он не получит входной образец во всех необходимых потоках ввода. На этом этапе он должен выбрать самую раннюю отметку времени первоначальных выборок, чтобы использовать их в качестве базовых для меток времени вывода. Другие потоки должны быть дополнены тишиной, чтобы отменять любое несоответствие времени. Если образец получен во необязательном входном потоке, он также должен быть разделен на вычисление. С этого момента Таблица MFT должна стремиться к созданию непрерывной и неповрежденной цепочки меток времени вывода. Как правило, MFT не должно пытаться учитывать один поток, переходящий относительно другого. Вместо этого он должен вычислять метки времени вывода на основе временной метки времени, частоты вывода и размеров буфера. Когда происходит другой сток или очистка, MFT следует сбросить ее базовые метки времени.

-   Видео. При запуске или сразу после очистки или сброса Видеомикшер должен подождать создания выходных образцов, пока он не получит входной образец во всех необходимых входных потоках. На этом этапе он должен выбрать самую раннюю отметку времени первоначальных выборок, чтобы использовать их в качестве базовых для меток времени вывода. Как правило, следует стремиться к постоянному и регулярному выходу выходных и фиксированных длительностей, даже если входные данные не являются обычными, если это необходимо для повторения входных кадров.

### <a name="encoders"></a>Кодировщики

Кодировщик преобразует несжатые аудио или видео в сжатые пакеты. Кодировщик должен следовать приведенным ниже рекомендациям.

-   Кодировщик должен следовать правилам формата выходных данных. Если формат обычно не имеет метки времени, как в MPEG-2, не каждый образец вывода должен иметь отметку времени и длительность.

-   Метки времени ввода должны сохраняться в выходном формате, если в формате есть поля для меток времени, если только более подробные сведения о времени не будут доступны из другого источника, например самого приложения.

### <a name="multiplexers"></a>Мультиплексоры

> [!Note]  
> В Windows Vista конвейер Media Foundation не поддерживает МФТС с более чем одним входом. В Windows 7 поддерживаются множественные входные МФТС.

 

Мультиплексор объединяет два разных аудио-или видеопотока в один формат чередования, например AVI или MPEG-2. Мультиплексор должен следовать следующим рекомендациям:

-   Мультиплексор должен следовать правилам формата выходных данных. Если формат обычно не имеет метки времени, как в MPEG-2, не каждый образец вывода должен иметь отметку времени и длительность.

-   Метка времени должна отражать самое раннее время, которое будет помещено в любой кадр, который начинается в этом пакете, или время первого звукового примера, который будет декодирован из этого пакета. Пропускать это правило, если оно конфликтует с соглашениями выходного формата.

### <a name="demultiplexers"></a>Демультиплексоры

Демультиплексор разделяет формат с чередованием, такой как транспорт AVI или MPEG-2, в базовые потоки аудио и видео.

Если формат содержит определенные сведения о временной метке, которые можно использовать для вычисления точных меток времени вывода на основе меток времени ввода, эти сведения следует использовать. Однако если формат содержит значения времени в совершенно другой базе, не имеющей связи с метками времени ввода, и точное смещение метки времени не может быть вычислено, то собственное значение формата не должно учитываться.

Если формат не содержит сведений о метке времени, демультиплексор должен соответствовать следующим правилам.

-   Несжатые выходные потоки должны иметь допустимые метки времени и длительности, вычисленные на основе ближайшей предыдущей метки времени ввода.

-   Сжатые выходные потоки должны иметь штампы времени только для первого выходного примера, производного от входного образца с отметкой времени. Если в образце входных данных нет отметки времени, то выходные образцы, производные от этого примера, должны иметь отметку времени. Если образец входных данных разбивается на несколько выходных образцов, только первый из них должен иметь отметку времени, а остальные не должны иметь отметки времени.

### <a name="examples"></a>Примеры

Пример 1. Предположим, что видеоизображение всегда принимает несжатый входной фрейм, применяет этот результат и копирует его в выходные данные. Он никогда не содержит никаких кадров или буферов. Эта MFT просто копирует отметку времени и продолжительность из образца входных данных в образец вывода, если они доступны, и не выполняет расчеты по времени.

Пример 2. Предположим, что звуковой результат преобразует все, кроме 10 миллисекунд (МС) каждого входного буфера, сохраняя дополнительные 10 мс для объединения со следующим буфером. Он получает поток образцов со сроком 50 мс. Время ввода показано в следующей таблице.



| Образец | Входное время | Длительность ввода | Время вывода | Длительность вывода |
|--------|------------|----------------|-------------|-----------------|
| 1      | 20         | 50             | 20          | 40              |
| 2      | 70         | 50             | 60          | 50              |
| 3      | 121        | 50             | 110         | 50              |
| 4      | 171        | 50             | 161         | 50              |



 

Обратите внимание, что 1-MS расхождение между фактической длительностью выборки 2 и подразумеваемой длительностью, основанной на следующей отметке времени (121? 70 = 51).

Поскольку таблица MFT содержит обратно 10 мс, она выводит первый 40 мс входного примера 1 в качестве образца вывода 1 с меткой времени 20 мс и длительностью 40 мс.

Пример выходных данных 2 объединяет 10 мс, которые были ранее записаны в 40 мс входного примера 2. Этому образцу присваивается метка времени 60 мс (метка времени предыдущего входного примера, 20 мс, а также длительность данных, уже обработанных из этого образца, 40ms). Ей присваивается длительность 50 мс.

Аналогичным образом в следующем примере показана метка времени 110ms (70ms + 40ms) с длительностью 50 мс.

Следующее вычисление является более интересным. Неявная отметка времени предыдущего выходного времени и длительности составит 160 мс (отметка времени 110 MS + Duration 50 мс). Однако отметка времени вывода должна быть вычислена с временной метки времени самого раннего входного примера, который перекрывает образец вывода в течение времени, а также длину всех данных, уже обработанных из этого образца. Ближайший перекрывающий пример входных данных — пример 4 (метка времени = 171), но это не самая ранняя. Самый ранний перекрывающий пример — пример 3 (метка времени = 121). При добавлении 40ms, который уже был обработан из этого образца, результат будет 161.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Запись пользовательского MFT](writing-a-custom-mft.md)
</dt> </dl>

 

 



