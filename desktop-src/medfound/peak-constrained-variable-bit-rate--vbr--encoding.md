---
description: 'В частоте переменной пиковой скорости (VBR) содержимое кодируется на заданную скорость и пиковые значения: Пиковая скорость потока и пиковое окно буфера.'
ms.assetid: bc37362e-d66d-4552-8357-d22093d5d0ad
title: Peak-Constrained кодирование переменной скорости
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 2d8a32ed6b6f90ce1e112cf5afd19f33e65f541a
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105711419"
---
# <a name="peak-constrained-variable-bit-rate-encoding"></a>Peak-Constrained кодирование переменной скорости

В частоте переменной пиковой скорости (VBR) содержимое кодируется на заданную скорость и *пиковые значения*: Пиковая скорость потока и пиковое окно буфера. Эти пиковые значения также называются *значениями пиковой утечки*. Файл кодируется в соответствии с буфером, описанным в значениях пиковой нагрузки, так что общая средняя скорость потока равна указанному значению среднего значения скорости или меньше него.

Как правило, Пиковая скорость очень высока. Кодировщик гарантирует, что указанное среднее значение скорости работы будет поддерживаться в течение потока (средняя скорость передачи >= (общий размер потока в битах/длительности потока в секундах)). Рассмотрим следующий пример: вы настраиваете поток с средним битом скорости в 16 000 бит/с, пиковой скоростью в 48 000 бит/с и пиковым окном буфера в 3 000 (3 секунды). Размер буфера, используемого для потока, составляет 144 000 бит (48 000 бит в секунду \* 3 секунды), определяемый значениями пиковой нагрузки. Кодировщик сжимает данные, чтобы они соответствовали этому буферу. Кроме того, средняя скорость потока должна составлять 16 000 или меньше. Если кодировщику необходимо создать крупные образцы для работы с сложным сегментом содержимого, можно воспользоваться большим размером буфера. Однако другие части потока должны быть закодированы с более низкой скоростью, чтобы сократить среднее до указанного уровня. Скорость кодирования с ограничением в пиковую пользу полезна для устройств воспроизведения с ограничением емкости буфера и ограничениями на скорость передачи данных. Распространенный пример — это кодировка, используемая для DVD-дисков при декодировании с помощью микросхемы устройства, где существуют ограничения по оборудованию, которые необходимо учитывать.

### <a name="configuring-the-encoder-for-peak-constrained-vbr"></a>Настройка кодировщика для Peak-Constrained VBR

Пиковая частота VBR похожа на " [неограниченное число VBR](unconstrained-variable-bit-rate--vbr--encoding.md) ", так как она ограничена средним битом скорости в течение потока. Кроме того, Пиковая нагрузка соответствует пиковому буферу. Этот буфер описывается с помощью пиковой скорости и пикового окна буфера. В этом режиме используется два прохода кодирования и обеспечивается гибкость кодировщика при кодировании отдельных выборок с соблюдением пиковых ограничений.

Конфигурация кодировщика задается с помощью значений свойств. Эти свойства определены в вмкодекдсп. h. Перед согласованием типа выходного носителя необходимо установить свойства конфигурации в кодировщике. Дополнительные сведения о настройке свойств кодировщика см. в разделе [Настройка кодировщика](configuring-the-encoder.md). На основе указанных значений свойств можно перечислить Поддерживаемые типы выходных данных VBR и выбрать требуемый тип на кодировщике [Media Foundation преобразование](media-foundation-transforms.md) (MFT) на основе средней скорости.

Для этого типа кодировки необходимо задать следующую пропертиесфор:

-   Укажите режим кодирования VBR, задав \_ для свойства мфпкэй вбренаблед значение Variant \_ true.
-   Присвойте параметру пассесусед МФПКЭЙ значение \_ 2, так как в режиме пиковой скорости используется два прохода кодирования.
-   Задайте МФПКЭЙ \_ рмакс, чтобы указать пиковую скорость, и установите мфпкэй \_ бмакс, чтобы указать пиковое окно буфера.
-   При перечислении типа выходного носителя установите флажок [**\_ \_ \_ Среднее \_ число байт \_ в \_ секунду MF MT**](mf-mt-audio-avg-bytes-per-second-attribute.md) (для звуковых потоков) или атрибут [**с \_ \_ средним \_ значением скорости MF MT**](mf-mt-avg-bitrate-attribute.md) (для видеопотоков) доступных типов выходных носителей и выберите тип выходного носителя с средней скоростью потока, ближайшей к требуемой средней скорости, которую должен поддерживать кодировщик в закодированном содержимом. Дополнительные сведения о выборе типа выходного носителя см. в разделе [Согласование типа носителя в кодировщике](media-type-negotiation-on-the-encoder.md).

> [!Note]  
> Рекомендуется установить пиковую скорость по крайней мере вдвое в два раза выше средней скорости. Если задать для пиковой скорости более низкое значение, кодировщик может закодировать содержимое как CBR, а не Пиковое ограничение VBR.

 

Чтобы получить значение окна буфера, заданное кодировщиком, вызовите **ивмкодеклеакибуккет:: жетбуфферсизебитс**, определенный в вмкодеЦифацес. h, вмкодекдспууид. lib, после сеанса кодирования. Чтобы добавить поддержку неограниченных VBR для потоков, необходимо задать это значение в атрибуте [**MF \_ асфстреамконфиг \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) (значения пиковой утечки) в объекте конфигурации потока при настройке профиля ASF.

В следующем примере кода изменяется метод Сетенкодингтипе класса Sample Ценкодер для настройки режима с пиковым ограничением VBR. Сведения об этом классе см. в разделе [пример кода кодировщика](encoder-example-code.md). Сведения о вспомогательных макросах, используемых в этом примере, см. в разделе Использование Media Foundation примеров кода.


```
//////////////////////////////////////////////////////////////////////////
//  Name: SetEncodingType
//  Description: Sets the encoding type to peak-constrained VBR mode.
//
/////////////////////////////////////////////////////////////////////////

HRESULT CEncoder::SetEncodingType(EncodeMode mode)
{
    if (!m_pMFT)
    {
        return MF_E_NOT_INITIALIZED;
    }

    HRESULT hr = S_OK;

    IPropertyStore* pProp = NULL;

    PROPVARIANT var;
    PropVariantInit(&var);

    // Query the encoder for its property store.
    CHECK_HR(hr = m_pMFT->QueryInterface(__uuidof(IPropertyStore), (void**)&pProp));
    
    if (mode == EncodeMode_VBR_Peak)
    {
        // Set the VBR property to TRUE, which indicates VBR encoding.
        var.vt = VT_BOOL;
        var.boolVal = TRUE;
        CHECK_HR(hr = pProp->SetValue(MFPKEY_VBRENABLED, var));
        PropVariantClear(&var);

        // Set number of passes.
        var.vt = VT_I4;
        var.lVal  =2;
        CHECK_HR(hr = pProp->SetValue(MFPKEY_PASSESUSED, var));
        PropVariantClear(&var);

        // Set the peak bit rate.
        var.vt = VT_I4;
        var.lVal  =48000;
        CHECK_HR(hr = pProp->SetValue(MFPKEY_RMAX, var));
        PropVariantClear(&var);

        // Set the peak buffer window.
        var.vt = VT_I4;
        var.lVal  =3000;
        CHECK_HR(hr = pProp->SetValue(MFPKEY_BMAX, var));
        PropVariantClear(&var);
    }

done:
    PropVariantClear(&var);
    SAFE_RELEASE (pProp);
    return hr;
    
}
```



## <a name="related-topics"></a>См. также

<dl> <dt>

[Типы кодирования ASF](asf-encoding-types.md)
</dt> <dt>

[Модель буфера для контейнера утечки](the-leaky-bucket-buffer-model.md)
</dt> <dt>

[Создание топологии для Two-Pass кодирования Windows Media](how-to-create-a-topology-for-2-pass-windows-media-encoding.md)
</dt> </dl>

 

 



