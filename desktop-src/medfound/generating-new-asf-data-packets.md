---
description: Создание новых пакетов данных ASF
ms.assetid: 7afa9694-c965-40e2-8549-e32ff48def2a
title: Создание новых пакетов данных ASF
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 78f3432ecf34c58247a1533adb202b75f59d770c
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104496806"
---
# <a name="generating-new-asf-data-packets"></a>Создание новых пакетов данных ASF

*МУЛЬТИПЛЕКСОР* ASF — это компонент уровня вмконтаинер, который работает с [объектом данных ASF](asf-file-structure.md) и дает приложению возможность создавать пакеты данных ASF для потока, соответствующие требованиям, определенным в объекте контентинфо.

Мультиплексор имеет один вход и один выход. Он получает пример потока, который содержит цифровые данные мультимедиа и создает один или несколько пакетов данных, которые могут быть записаны в контейнер ASF.

В следующем списке обобщены процессы создания пакетов данных ASF.

1.  Передайте входные данные в мультиплексор в [**имфасфмултиплексер::P роцесссампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).
2.  Собирайте пакеты данных путем вызова [**имфасфмултиплексер:: жетнекстпаккет**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) в цикле до тех пор, пока не будут получены все полные пакеты.
3.  После преобразования входных данных в полные пакеты в мультиплексоре могут быть ожидающие данные, которые не были получены [**жетнекстпаккет**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket). Вызовите [**имфасфмултиплексер:: Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) , чтобы паккетизе ожидающие выборки и получить их из мультиплексора, вызвав **жетнекстпаккет** еще раз.
4.  Обновите соответствующие объекты заголовка ASF, вызвав [**имфасфмултиплексер:: end**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) , чтобы отразить изменения, внесенные мультиплексором во время создания пакета данных.

На следующей схеме показана генерация пакетов данных для ASF-файла с помощью мультиплексора.

![Диаграмма, показывающая создание пакетов данных для файла ASF](images/packet.gif)

## <a name="asf-data-packet-creation"></a>Создание пакета данных ASF

После создания и инициализации мультиплексора, как описано в разделе [Создание объекта мультиплексора](creating-the-multiplexer-object.md), вызовите [**Имфасфмултиплексер::P роцесссампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) , чтобы передать входные данные мультиплексору для обработки в пакеты данных. Указанные входные данные должны находиться в образце носителя (интерфейс [**имфсампле**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) ), который может иметь один или несколько буферов мультимедиа (интерфейс [**имфмедиабуффер**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) ), содержащих данные для потока. В случае перекодировки ASF-в ASF пример входного носителя можно создать из разделителя, который создает пакетные образцы потока. Дополнительные сведения см. в статье [Разделитель ASF](asf-splitter.md).

Перед вызовом [**процесссампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample)убедитесь, что метка времени примера входного носителя является допустимым временем презентации. в противном случае **процесссампле** завершается с ошибкой и возвращает \_ \_ \_ \_ код отметок времени в виде MF E без примера.

Мультиплексор может принимать входные данные в виде сжатых или несжатых примеров мультимедиа через [**процесссампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample). Мультиплексор назначает время отправки этим образцам в зависимости от использования пропускной способности потока. Во время этого процесса мультиплексор проверяет параметры сегмента утечки (скорость потока и использование окна буфера) и может отклонить выборки, которые не соответствуют этим значениям. Пример входного носителя может привести к сбою проверки пропускной способности по одной из следующих причин:

-   Если пример входного носителя поступил в конец, так как время последней назначенной отправки превышает метку времени на этом примере носителя. [**Процесссампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) завершается сбоем и возвращает код ошибки **MF \_ E \_ \_ опоздания** .
-   Если метка времени на примере входного носителя предшествует назначенному времени отправки (это указывает на переполнение буфера). Мультиплексор может игнорировать эту ситуацию, если она настроена для корректировки скорости, задав флаг **\_ \_ автонастройки \_ мультиплексора мфасф** в процессе инициализации мультиплексора. Дополнительные сведения см. в разделе "Инициализация мультиплексора и параметры сегмента утечки" раздела [Создание объекта мультиплексора](creating-the-multiplexer-object.md). Если этот флаг не установлен и мультиплексор встречает перерасход полосы пропускания, [**процесссампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) завершается сбоем и возвращает код ошибки **\_ \_ \_ переполнения пропускной способности MF E** .

После того как мультиплексор назначает время отправки, пример входного носителя добавляется в *окно отправки*— список примеров входного носителя, упорядоченный по времени отправки и готовых к обработке в пакетах данных. Во время создания пакета данных пример входного носителя анализируется, и соответствующие данные записываются в пакет данных в качестве полезных данных. Полный пакет данных может содержать данные из одного или нескольких примеров входного носителя.

Когда новые образцы входных данных поступают в окно отправки, они добавляются в очередь до тех пор, пока не появится достаточное количество образцов носителя для формирования одного полного пакета. Данные в буферах мультимедиа, содержащиеся в примере входного носителя, не копируются в созданный пакет данных. Пакет данных хранит ссылки на входные буферы носителей до тех пор, пока не будет полностью Пакетирован пример входного носителя и не будет получен полный пакет из мультиплексора.

Если доступен полный пакет данных, его можно получить, вызвав [**имфасфмултиплексер:: жетнекстпаккет**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket). Если вы вызовите [**процесссампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) , когда готовые пакеты будут подготовлены к извлечению, происходит сбой и возвращается код ошибки **MF \_ E \_ нотакцептинг** . Это означает, что мультиплексор не может принимать больше входных данных, и для получения ожидающих пакетов необходимо вызвать **жетнекстпаккет** . В идеале, за каждым вызовом **процесссампле** должен следовать один или несколько вызовов **жетнекстпаккет** для получения полных пакетов данных. Для создания полного пакета данных может потребоваться несколько примеров входного носителя. И наоборот, данные в одном входном носителе могут охватывать несколько пакетов. Таким образом, не все вызовы **процесссампле** будут выдавать примеры выходных носителей.

Если пример входного носителя содержит ключевой кадр, указанный атрибутом [**мфсампликстенсион \_ клеанпоинт**](mfsampleextension-cleanpoint-attribute.md) , мультиплексор копирует атрибут в пакет.

## <a name="getting-asf-data-packets"></a>Получение пакетов данных ASF

Чтобы получить примеры выходных носителей для полного пакета данных, созданного мультиплексором, вызовите [**имфасфмултиплексер:: жетнекстпаккет**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) в цикле до тех пор, пока не будут оставлены выходные примеры выходных данных для пакета. Ниже перечислены варианты успеха.

-   Если доступен полный пакет данных, [**жетнекстпаккет**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) получает флаг **\_ \_ \_ неполного состояния ASF** в параметре *пдвстатусфлагс* ; параметр *ппипаккет* получает указатель на первый пакет данных. Этот метод следует вызывать, если он получает этот флаг. При каждой итерации *ппипаккет* указывает на следующий пакет в очереди.
-   Если имеется только один пакет данных, *ппипаккет* указывает на него, а флаг **\_ \_ \_ неполный флаг состояния ASF** не получен в *пдвстатусфлагс*.
-   [**Жетнекстпаккет**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) может быть выполнена без передачи пакетов данных, если мультиплексор по-прежнему находится в процессе паккетизинг и добавления пакетов данных. В этом случае *ппипаккет* указывает на **значение NULL**. Чтобы продолжить, необходимо предоставить мультиплексору дополнительные примеры входных носителей, вызвав [**процесссампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).

В следующем примере кода показана функция, которая создает пакеты данных с помощью мультиплексора. Содержимое сформированного пакета данных будет записано в поток байтов данных, выделенный вызывающим объектом.


```C++
//-------------------------------------------------------------------
// GenerateASFDataPackets
// 
// Gets data packets from the mux. This function is called after 
// calling IMFASFMultiplexer::ProcessSample. 
//-------------------------------------------------------------------

HRESULT GenerateASFDataPackets( 
    IMFASFMultiplexer *pMux, 
    IMFByteStream *pDataStream
    )
{
    HRESULT hr = S_OK;

    IMFSample *pOutputSample = NULL;
    IMFMediaBuffer *pDataPacketBuffer = NULL;

    DWORD dwMuxStatus = ASF_STATUSFLAGS_INCOMPLETE;

    while (dwMuxStatus & ASF_STATUSFLAGS_INCOMPLETE)
    {
        hr = pMux->GetNextPacket(&dwMuxStatus, &pOutputSample);

        if (FAILED(hr))
        {
            break;
        }

        if (pOutputSample)
        {
            //Convert to contiguous buffer
            hr = pOutputSample->ConvertToContiguousBuffer(&pDataPacketBuffer);
            
            if (FAILED(hr))
            {
                break;
            }

            //Write buffer to byte stream
            hr = WriteBufferToByteStream(pDataStream, pDataPacketBuffer, NULL);

            if (FAILED(hr))
            {
                break;
            }
        }

        SafeRelease(&pDataPacketBuffer);
        SafeRelease(&pOutputSample);
    }

    SafeRelease(&pOutputSample);
    SafeRelease(&pDataPacketBuffer);
    return hr;
}
```



`WriteBufferToByteStream`Функция показана в разделе [**имфбитестреам:: Write**](/windows/desktop/api/mfobjects/nf-mfobjects-imfbytestream-write).

Чтобы просмотреть полное приложение, использующее этот пример кода, см. раздел [учебник. копирование потоков ASF из одного файла в другой](tutorial--copying-asf-streams-from-one-file-to-another.md).

## <a name="post-packet-generation-calls"></a>Вызовы post Packet-Generation

Чтобы убедиться в отсутствии полных пакетов данных, ожидающих мультиплексора, вызовите [**имфасфмултиплексер:: Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush). Это заставляет мультиплексор паккетизе все выполняемые примеры мультимедиа. Приложение может получать эти пакеты в виде образцов мультимедиа через **жетнекстпаккет** в цикле до тех пор, пока не будут получены оставшиеся пакеты.

После создания всех примеров носителей вызовите метод [**имфасфмултиплексер:: end**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) , чтобы обновить объект заголовка ASF, связанный с этими пакетами данных. Объект заголовка задается путем передачи объекта Контентинфо, который использовался для инициализации мультиплексора. Этот вызов обновляет различные объекты заголовка для отражения изменений, сделанных мультиплексором во время создания пакета данных. Эти сведения включают число пакетов, длительность отправки, длительность воспроизведения и номера потоков всех потоков. Общий размер заголовка также обновляется.

Необходимо убедиться, что метод [**End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) вызывается после получения всех пакетов данных. Если в мультиплексоре находятся пакеты, ожидающие мультиплексирования **,** завершится ошибкой и будет возвращен код ошибки **MF \_ E \_ \_** . В этом случае получите ожидающий пакет, вызвав [**flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) и [**жетнекстпаккет**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) в цикле.

> [!Note]  
> Для кодирования VBR после вызова **End** необходимо задать статистику кодировки в свойствах кодировки объекта контентинфо. Дополнительные сведения об этом процессе см. в разделе "Настройка объекта Контентинфо с помощью параметров кодировщика" раздела [Настройка свойств в объекте контентинфо](setting-properties-in-the-contentinfo-object.md). В следующем списке перечислены конкретные свойства, которые необходимо задать.
>
> -   [**Мфпкэй \_ РАВГ**](mfpkey-ravgproperty.md) — это средняя скорость потока содержимого VBR.
> -   [**Мфпкэй \_ БАВГ**](mfpkey-bavgproperty.md) — это окно буфера для средней скорости потока.
> -   [**Мфпкэй \_ РМАКС**](mfpkey-rmaxproperty.md) — это Пиковая скорость содержимого VBR.
> -   [**Мфпкэй \_ БМАКС**](mfpkey-bmaxproperty.md) — пиковое окно буфера.

 

## <a name="related-topics"></a>См. также

<dl> <dt>

[Мультиплексор ASF](asf-multiplexer.md)
</dt> <dt>

[Учебник. копирование потоков ASF из одного файла в другой](tutorial--copying-asf-streams-from-one-file-to-another.md)
</dt> <dt>

[Руководство. запись файла WMA с помощью CBR Encoding](tutorial--writing-a-wma-file-by-using-cbr-encoding.md)
</dt> </dl>

 

 



