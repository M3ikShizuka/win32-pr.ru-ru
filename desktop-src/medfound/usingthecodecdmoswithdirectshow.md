---
description: Использование оконных кодеков Windows в DirectShow
ms.assetid: 5b930447-6bf2-4bb3-8dfb-05f4c1e7cd64
title: Использование оконных кодеков Windows в DirectShow
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: cb521c0e3897dc2415fbd613f97b755a146657d3
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105683076"
---
# <a name="using-the-window-media-codecs-in-directshow"></a>Использование оконных кодеков Windows в DirectShow

Объекты кодировщика аудио и видео Windows Media и декодера изначально разрабатывались и оптимизированы для работы с форматом контейнера файлов ASF и пакетом SDK Windows Media Format. Объекты кодека хорошо работают в DirectShow в определенных сценариях, а именно один проход CBR и качество потока видеопотоков с поддержкой VBR. Но если вы планируете использовать объекты кодека непосредственно в DirectShow с помощью контейнеров файлов, отличных от ASF, существуют определенные поведения и проблемы, о которых следует помнить заранее.

> [!Note]  
> Если вы собираетесь использовать автономные кодеки с DirectShow, скорее всего, их потребуется использовать как дмос. Иными словами, вы будете использовать интерфейс [**имедиаобжект**](/previous-versions/windows/desktop/api/mediaobj/nn-mediaobj-imediaobject) вместо [**имфтрансформ**](/windows/desktop/api/mftransform/nn-mftransform-imftransform).

 

## <a name="wm-audio-in-avi-files"></a>Звуковые файлы WM в AVI

DirectShow можно использовать для кодирования потоков WMA в любой формат контейнера файлов, для которого имеется фильтр мультиплексора. Однако интерфейсы аудиокодеков Windows Media Audio и Video не поддерживают WMA в AVI-файлах, так как их невозможно использовать по умолчанию фильтры воспроизведения AVI, чтобы поддерживать синхронизацию видео в файле AVI с потоком WMA. Дополнительные сведения см. [в разделе Хранение сжатых файлов мультимедиа в AVI](storingcompressedmediainavifiles.md).

В DMO для аудио кодировщика выводятся примеры различной длительности, даже если в режиме постоянной битовой скорости. Поэтому лучше работает с форматами контейнеров файлов, которые используют метки времени. AVI-файлы не предоставляют метку времени для каждого звукового примера или группы образцов. В DirectShow фильтр разделителя AVI создает штампы времени для каждой группы выборок (каждый звуковой кадр) на основе значения **навгбитесперсек** в структуре [**вавеформатекс**](/previous-versions/dd757713(v=vs.85)) в заголовке AVI-потока.

Исходя из этого вычисления подразумевается, что все звуковые примеры в потоке имеют одинаковую длительность. Однако выходные данные образцов DMO имеют неравную длительность, поэтому метки времени, применяемые разделителем AVI, неточны. Таким образом, невозможно без изменения либо разделителя AVI, либо звукового декодера DMO, чтобы использовать приложение на основе DirectShow для воспроизведения AVI-файлов с синхронизацией аудио-и видеопотоков. В некоторых случаях голосовый кодек Windows Media Audio 9 будет работать, но даже в этом случае синхронизация будет потеряна после любой операции поиска, поэтому она не будет считаться приемлемым решением.

Если у вас есть кодировщик MP3, вы можете создавать AVI-файлы с помощью WMV и MP3 для звукового потока. Такие файлы воспроизводятся и правильно ищутся в проигрывателе Windows Media и других приложениях на основе DirectShow, поскольку разделитель AVI содержит специальный код обработки для потоков MP3. Другой вариант — использовать несжатый звук PCM, хотя, очевидно, размер файла будет значительно больше, чем в сжатом звуковом потоке. Так как пример приложения DirectShow создает AVI-файлы, в нем не демонстрируется использование DMO для аудио-кодировщика.

## <a name="one-pass-encoding"></a>Однопроходная кодировка

Технология DMO для видеокодировщика легко работает в DirectShow для двух режимов кодирования: CBR и Quality. При условии соблюдения правильного порядка операций при построении графа фильтра, как показано в примере приложения, можно относительно просто поместить содержимое WMV в AVI-файл с помощью AVI-мультиплексора и средства записи файлов.

## <a name="two-pass-encoding"></a>2-проходная кодировка

Для режимов двусторонней кодировки требуется более сложный подход к построению и потоковой передаче на графе, чтобы предотвратить сброс содержимого с первого прохода DMO до начала второго прохода. В двухсторонней кодировке необходимо однократно запустить граф, чтобы DMO мог выполнить анализ предварительной обработки данных файла, а затем перемотать диаграмму и запустить ее снова, чтобы объекты DMO могли выполнять фактическую кодировку.

Когда граф переходит в состояние выполнения второго прохода, оболочка DMO устанавливает флаг небесперебойности в первом примере, так как отметка времени не является последовательной с последней меткой времени первого прохода. Если объекты DMO, которые не предназначены для работы в DirectShow таким образом, получают флаг отключения, он выполняет очистку и теряет данные, хранящиеся на первом проходе. Чтобы обойти эту ошибку, лучшим решением, скорее всего, является написание настраиваемого фильтра оболочки DMO, который не устанавливает флаг ненепрерывности при поиске графа после первого прохода. Образец видео для Windows (VfW) в этом пакете SDK демонстрирует, как выполнить двустороннюю кодировку.

## <a name="interlaced-content"></a>Содержимое с чередованием

Кодировщик WMV Encoder способен кодировать содержимое с чередованием, сохраняя чересстрочную развертку, что полезно для содержимого, записанного на ТЕЛЕВИЗОРе, а также может воспроизводиться на ТЕЛЕВИЗОРе. Однако невозможно сохранить чересстрочную развертку с помощью оболочки DMO по умолчанию, так как этот фильтр не поддерживает [**инссбуффер**](/previous-versions/windows/desktop/api/wmsbuffer/nn-wmsbuffer-inssbuffer) на входных примерах.

DMO использует этот интерфейс для получения параметров с чередованием для каждого получаемого примера. Если интерфейс не найден, как в случае с оболочкой DMO, DMO просто рассматривает входные образцы как нечересстрочнуюиеся. Для выполнения чередования кодирования в DirectShow существует несколько альтернативных вариантов. Проще всего использовать пакет SDK для серии Windows Media Format 9 либо напрямую, либо используя фильтр DirectShow модуля записи WM ASF, чтобы создать чередующийся ASF-файл. Затем можно перекодировать этот файл в другой формат. При перекодировании в формате AVI будет создан файл с чередованием, но стандартные фильтры воспроизведения AVI в формате DirectShow не будут распознать его как таковые, так как они не поддерживают [**VIDEOINFOHEADER2**](/previous-versions/windows/desktop/api/dvdmedia/ns-dvdmedia-videoinfoheader2). Другой подход заключается в написании собственного фильтра оболочки DMO, поддерживающего интерфейс [**инссбуффер**](/previous-versions/windows/desktop/api/wmsbuffer/nn-wmsbuffer-inssbuffer) .

## <a name="related-topics"></a>См. также

<dl> <dt>

[Работа с кодеками дмос](workingwithcodecdmos.md)
</dt> </dl>

 

 
