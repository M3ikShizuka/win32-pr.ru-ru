---
title: Bluetooth и Всалукупсервицебегин для обнаружения служб
description: Для обнаружения существования определенной службы на сервере Bluetooth клиенты используют функции Всалукупсервицебегин, Всалукупсервиценекст и Всалукупсервицеенд.
ms.assetid: d9961600-cdca-42ec-92eb-118b8186ed2e
keywords:
- Bluetooth и Всалукупсервицебегин для обнаружения служб Bluetooth
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 274b3beb3de7683bd43a0f99350db6e1a347f51e
ms.sourcegitcommit: ae73f4dd3cf5a3c6a1ea7d191ca32a5b01f6686b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/08/2020
ms.locfileid: "103891185"
---
# <a name="bluetooth-and-wsalookupservicebegin-for-service-discovery"></a>Bluetooth и Всалукупсервицебегин для обнаружения служб

Для обнаружения существования определенной службы на сервере Bluetooth клиенты используют функции [**всалукупсервицебегин**](/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicebegina), [**всалукупсервиценекст**](/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicenexta)и [**всалукупсервицеенд**](/windows/desktop/api/winsock2/nf-winsock2-wsalookupserviceend) . Запросы могут выполняться для локальных и удаленных адресов, но подключения могут устанавливаться только с удаленными адресами. Дескрипторы служб, обнаруженные во время этой операции, нельзя использовать для удаления службы через [**всасетсервице**](/windows/desktop/api/winsock2/nf-winsock2-wsasetservicea). Замыкание на себя не поддерживается RFCOMM.

Можно выполнить два основных типа запросов на обнаружение служб:

-   Запросы для одной или нескольких служб на локальном устройстве
-   Запросы для одной или нескольких служб на указанном одноранговом устройстве

Функция [**всалукупсервицебегин**](/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicebegina) Получает структуру [**всакуерисет**](/windows/desktop/api/winsock2/ns-winsock2-wsaquerysetw) в своем параметре *лпксрестриктионс* . **Всалукупсервицебегин** выполняет клиентский запрос на основе набора ограничений поиска, содержащихся в **всакуерисет** . Клиенты Bluetooth должны указать ограничения, перечисленные в следующей таблице, в структуре **всакуерисет** при использовании функции **всалукупсервицебегин** для запроса служб.



| ВСАКУЕРИСЕТ, элемент    | Ограничение                                                                                                                                                                                                                                                                                                                                                                     |
|-----------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **двсизе**            | Задайте значение **sizeof**([**всакуерисет**](/windows/desktop/api/winsock2/ns-winsock2-wsaquerysetw)).                                                                                                                                                                                                                                                                                                                    |
| **лпсервицеклассид**  | Задайте наиболее конкретный идентификатор UUID Bluetooth, который можно использовать для определения области запроса. Например, если задать для **лпсервицеклассид** значение UUID протокола L2CAP, то возвращаются все возвращенные службы L2CAP, фактически перечисление всех записей SD в целевом объекте. Однако при задании UUID для определенной службы возвращаются только экземпляры этой службы.<br/> |
| **двнамеспаце**       | Задайте значение **NS \_ БС**.                                                                                                                                                                                                                                                                                                                                                             |
| **двнумберофксаддрс** | Задайте значение 0.                                                                                                                                                                                                                                                                                                                                                                       |
| **лпсзконтекст**       | Укажите адрес устройства Bluetooth, с помощью которого устанавливается подключение SDP для выполнения запроса служб. Этот элемент должен быть строкой, которая преобразуется с помощью функции [**всааддресстостринг**](/windows/desktop/api/winsock2/nf-winsock2-wsaaddresstostringa) . Если указан локальный радиоадрес, выполняется поиск локальных записей SDP.<br/>                                             |
| Другие члены         | Все остальные члены структуры [**всакуерисет**](/windows/desktop/api/winsock2/ns-winsock2-wsaquerysetw) игнорируются.                                                                                                                                                                                                                                                                                        |



 

Подключение SDP к удаленному устройству не остается активным после того, как функция [**всалукупсервицебегин**](/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicebegina) завершает запрос на обслуживание; соединение прерывается до возврата **всалукупсервицебегин** . Приложения, для которых требуется подключение SDP, остаются активными после завершения запроса службы, должны указывать идентификатор UUID класса службы, к которому подключается с помощью члена **сервицеклассид** структуры [**SOCKADDR \_ БС**](/windows/desktop/api/Ws2bth/ns-ws2bth-sockaddr_bth) при выдаче вызова функции Windows Sockets [**Connect**](/windows/desktop/api/winsock2/nf-winsock2-connect) .

Флаги, перечисленные в следующей таблице, используются в параметре *двконтролфлагс* функций [**всалукупсервицебегин**](/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicebegina) и [**всалукупсервиценекст**](/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicenexta) для управления результатами запроса. **Луп \_ контейнеры** и флаги **\_ флушкаче Луп** используются функцией **всалукупсервицебегин** . остальные флаги используются в вызовах функции **всалукупсервиценекст** .

<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Результат</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>LUP_CONTAINERS</strong></td>
<td>Не должно быть задано.</td>
</tr>
<tr class="even">
<td><strong>LUP_FLUSHCACHE</strong></td>
<td>Приложения обычно должны указывать <strong>LUP_FLUSHCACHE</strong>. Этот флаг предписывает системе игнорировать все кэшированные данные и установить подключение SDP к устройству, чтобы выполнить поиск SDP. Эта некэшированная операция может занять несколько секунд (в то время как кэшированный поиск вернется быстро). Сейчас Bluetooth не выполняет упреждающее кэширование записей SDP с ближайших устройств, а сейчас не фиксирует предыдущие запросы в кэше. Поэтому приложения должны ожидать, что запросы могут не возвращать результаты (с кодом ошибки <strong>WSASERVICE_NOT_FOUND</strong>), если <strong>LUP_FLUSHCACHE</strong> не указан. В будущем могут быть улучшены кэшированные данные, доступные с помощью интерфейса сокетов Windows.</td>
</tr>
<tr class="odd">
<td><strong>LUP_RES_SERVICE</strong></td>
<td>Возвращает сведения об локальном адресе Bluetooth. Этот флаг действует только в том случае, если также указана <strong>LUP_RETURN_ADDR</strong> .</td>
</tr>
<tr class="even">
<td><strong>LUP_RETURN_NAME</strong></td>
<td>Возвращает отображаемое имя службы в элементе <strong>лпсзсервицеинстанценаме</strong> структуры <a href="/windows/desktop/api/winsock2/ns-winsock2-wsaquerysetw"><strong>всакуерисет</strong></a> для каждого вызова функции <a href="/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicenexta"><strong>всалукупсервиценекст</strong></a> .</td>
</tr>
<tr class="odd">
<td><strong>LUP_RETURN_TYPE</strong></td>
<td>Возврат идентификатора класса службы в элемент <strong>лпсервицеклассид</strong> структуры <a href="/windows/desktop/api/winsock2/ns-winsock2-wsaquerysetw"><strong>всакуерисет</strong></a> .
<blockquote>
[!Note]<br />
Использование этого флага применимо только к функции <a href="/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicebegina"><strong>всалукупсервицебегин</strong></a> . Это значение всегда равно нулю для <a href="/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicenexta"><strong>всалукупсервиценекст</strong></a>.
</blockquote>
<br/></td>
</tr>
<tr class="even">
<td><strong>LUP_RETURN_ADDR</strong></td>
<td>Возврат адреса в члене <strong>лпксабуффер</strong> для использования с вызовами функции <a href="/windows/desktop/api/winsock2/nf-winsock2-connect"><strong>Connect</strong></a> . Возвращенный адрес содержит номер порта.</td>
</tr>
<tr class="odd">
<td><strong>LUP_RETURN_BLOB</strong></td>
<td>Верните совпадающие записи SD в члене <strong>лпблоб</strong> , отформатированные в соответствии со спецификацией записи "средство распространения Bluetooth".</td>
</tr>
<tr class="even">
<td><strong>LUP_RETURN_ALL</strong></td>
<td>Возвратите все приведенные выше сведения о флагах.</td>
</tr>
<tr class="odd">
<td><strong>LUP_RETURN_COMMENT</strong></td>
<td>Верните описание службы в элемент <strong>лпсзкоммент</strong> структуры <a href="/windows/desktop/api/winsock2/ns-winsock2-wsaquerysetw"><strong>всакуерисет</strong></a> для каждого вызова функции <a href="/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicenexta"><strong>всалукупсервиценекст</strong></a> .</td>
</tr>
<tr class="even">
<td><strong>LUP_FLUSHPREVIOUS</strong></td>
<td>Пропустить следующую доступную запись и вернуть запись, следующую за ней.</td>
</tr>
</tbody>
</table>



 

## <a name="advanced-service-queries"></a>Расширенные запросы на обслуживание

Операции запроса, описанные в предыдущем разделе, можно использовать для возвращения всех результатов из одного идентификатора GUID, который должен быть достаточным для большинства приложений. Расширенный запрос позволяет приложению создать более конкретный запрос. Он предоставляет возможность сопоставлять идентификаторы UUID и атрибуты в возвращенных данных.

Чтобы выполнить расширенный запрос для служб, клиенты Bluetooth должны указать следующие ограничения в структуре [**всакуерисет**](/windows/desktop/api/winsock2/ns-winsock2-wsaquerysetw) , которая передается в параметр *лпксрестриктионс* .



| ВСАКУЕРИСЕТ, элемент   | Ограничение                                                                                                                                                                                                                                                                                                                         |
|----------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **двсизе**           | Задайте значение **sizeof**([**всакуерисет**](/windows/desktop/api/winsock2/ns-winsock2-wsaquerysetw)).                                                                                                                                                                                                                                                                        |
| **лпсзконтекст**      | Укажите адрес устройства Bluetooth, с помощью которого устанавливается подключение SDP для выполнения запроса служб. Этот элемент должен быть строкой, которая преобразуется с помощью функции [**всааддресстостринг**](/windows/desktop/api/winsock2/nf-winsock2-wsaaddresstostringa) . Если указан локальный радиоадрес, выполняется поиск локальных записей SDP.<br/> |
| **Лпблоб. Пблобдата** | Указатель на структуру [**\_ \_ службы запросов БС**](/windows/desktop/api/Ws2bth/ns-ws2bth-bth_query_service) , которая содержит все параметры, ограничивающие результаты запроса.                                                                                                                                                                                           |
| **двнамеспаце**      | Задайте значение **NS \_ БС**.                                                                                                                                                                                                                                                                                                                 |
| Другие члены        | Все остальные члены структуры [**всакуерисет**](/windows/desktop/api/winsock2/ns-winsock2-wsaquerysetw) игнорируются.                                                                                                                                                                                                                                            |



 

Следующие флаги передаются в параметре *двконтролфлагс* объекта [**всалукупсервицебегин**](/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicebegina) для управления результатами расширенного запроса.

| Flag                     | Результат                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **\_контейнеры Луп**      | Не должно быть задано.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **ЛУП \_ флушкаче**      | В приложениях обычно указывается **Луп \_ флушкаче**. Этот флаг предписывает системе игнорировать все кэшированные данные и установить подключение SDP к устройству, чтобы выполнить поиск SDP. Эта некэшированная операция может занять несколько секунд (в то время как кэшированный поиск вернется быстро). Bluetooth не выполняет упреждающее кэширование записей SDP с ближайших устройств, а также не кэширует предыдущие запросы. Поэтому приложения должны рассчитывать, что запросы могут часто не возвращать результаты (**всасервице \_ не \_ Найдено**), если не указан **Луп \_ флушкаче** . В будущем могут быть улучшены кэшированные данные, доступные с помощью интерфейса сокетов Windows. |
| **\_Служба Луп RES \_**    | Возвращает сведения об локальном адресе Bluetooth. Установка этого флага оказывает воздействие только в том случае, если также указан **Луп, \_ возвращающий обратный \_ адрес** .                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **\_имя возврата \_ Луп**    | Возврат отображаемого имени службы. Этот флаг игнорируется для **\_ запроса на \_ Поиск \_ службы SDP**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **\_тип возвращаемого значения Луп \_**    | Возвращает идентификатор класса службы. Этот флаг игнорируется для **\_ запроса на \_ Поиск \_ службы SDP**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **ЛУП \_ обратный \_ адрес**    | Возврат адреса в члене **лпксабуффер** для использования с вызовами функции [**Connect**](/windows/desktop/api/winsock2/nf-winsock2-connect) . Возвращенный адрес содержит номер порта. Этот флаг игнорируется для **\_ запроса на \_ Поиск \_ службы SDP**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **\_возвращаемый \_ BLOB-объект Луп**    | Возврат совпадающих записей SD в формате, соответствующем спецификации записи SDP по Bluetooth. Для **\_ запроса на \_ Поиск \_ службы SDP** результат в **лпблоб** для последующего вызова [**Всалукупсервиценекст**](/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicenexta) — это массив дескрипторов SDP по Bluetooth. В запросе атрибута **\_ службы \_ \_ SDP** и **\_ \_ \_ \_ запроса атрибутов поиска службы SDP** результат для каждого последующего вызова **всалукупсервиценекст** представляет собой двоичную запись SDP с поддержкой Bluetooth, атрибуты которой ограничены элементами, заданными элементом **пранже** запроса. Этот флаг необходим для **\_ \_ \_ запроса поиска службы SDP**.                                                               |
| **\_Комментарий возврата \_ Луп** | Верните описание службы в элемент **лпсзкоммент** структуры [**всакуерисет**](/windows/desktop/api/winsock2/ns-winsock2-wsaquerysetw) для каждого вызова функции [**всалукупсервиценекст**](/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicenexta) .                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **ЛУП \_ флушпревиаус**   | Пропустить следующую доступную запись и вернуть запись, следующую за ней.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |



 

На входе **лпблоб** -> **пблобдата** указывает на структуру [**\_ \_ службы запросов БС**](/windows/desktop/api/Ws2bth/ns-ws2bth-bth_query_service) , которая содержит значения, перечисленные в следующей таблице.

> [!Note]  
> Исходный запрос поиска должен иметь возможность поместиться в один пакет L2CAP. Однако ответ может быть разбит на множество пакетов L2CAP.

 



| Член            | Значение                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|-------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **type**          | Тип выполняемого поиска. Это значение может быть одним из **запросов \_ \_ поиска службы \_ SDP**, **запроса \_ \_ атрибута службы \_ SDP** или **\_ \_ \_ \_ запроса атрибута поиска службы SDP**. Каждый тип поиска связан с базовым механизмом поиска, определяемым спецификацией Bluetooth SDP. Каждый из них возвращает результаты в форме, описываемой структурой [**всакуерисет**](/windows/desktop/api/winsock2/ns-winsock2-wsaquerysetw) , которая определена ранее в этом разделе (расширенные запросы на обслуживание). |
| **сервицехандле** | Используется для поиска атрибутов. Это значение указывает маркер службы, с помощью которого запрашиваются атрибуты в элементе **пранже** .                                                                                                                                                                                                                                                                                                                                            |
| **UUID**         | Используется для поиска в службе и **сервицеаттрибуте** . Это значение указывает UUID, которые должна содержать запись, чтобы соответствовать поиску. Если в идентификаторах UUID **\_ \_ \_ запроса** требуется запрашивать меньшее число UUID, это значение задает элемент сдпкуерюуид, который сразу же следует за последним допустимым значением UUID до всех нулей.                                                                                                                                                                       |
| **нумранже**      | Используется для поиска атрибутов и **сервицеаттрибуте** . Это значение указывает количество элементов в **пранже**.                                                                                                                                                                                                                                                                                                                                                             |
| **пранже**        | Используется для поиска атрибутов и **сервицеаттрибуте** . Это значение указывает значения атрибутов, которые необходимо получить для всех совпадающих записей.                                                                                                                                                                                                                                                                                                                                        |



 

После каждого успешного вызова функции [**всалукупсервиценекст**](/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicenexta) **лпблоб** -> **пблобдата** указывает на блок данных, содержащий значения, перечисленные в следующей таблице.

| Значение                                                                                | Описание                                                                                                                                                                                                                                                                                                                                          |
|--------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **\_ \_ запрос поиска службы \_ SDP**                                                    | Массив дескрипторов записи SDP, идентичный **сервицерекордхандлелист** , определяемый средством SDP 4.5.2 для Bluetooth 1,1. Число возвращаемых дескрипторов SDP вычисляется с помощью (**лпблоб**->кбсизе)/**sizeof**(ulong). Все результаты возвращаются в одном вызове функции [**всалукупсервиценекст**](/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicenexta) . |
| **SDP \_ Запрос \_ атрибута \_ службы** для **\_ \_ поиска \_ \_ службы SDP** | Двоичная запись SDP по Bluetooth. Для **\_ \_ \_ запроса атрибута службы SDP** все результаты возвращаются в одном вызове функции [**всалукупсервиценекст**](/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicenexta) .                                                                                                                                                       |



 

> [!Note]  
> Если элемент **лпблоб** не указан во время ввода для запроса службы, служба и поиск атрибутов выполняются для службы, указанной в элементе **лпсервицеклассид** в атрибутах от 0 до 0xFFFF.

 

## <a name="related-topics"></a>См. также

<dl> <dt>

[Bluetooth и ВСАКУЕРИСЕТ для запроса на обслуживание](bluetooth-and-wsaqueryset-for-service-inquiry.md)
</dt> <dt>

[Обнаружение устройств и служб Bluetooth](discovering-bluetooth-devices-and-services.md)
</dt> <dt>

[Bluetooth и Всалукупсервиценекст](bluetooth-and-wsalookupservicenext.md)
</dt> <dt>

[Bluetooth и Всалукупсервицебегин для запроса устройства](bluetooth-and-wsalookupservicebegin-for-device-inquiry.md)
</dt> <dt>

[**\_служба запросов \_ БС**](/windows/desktop/api/Ws2bth/ns-ws2bth-bth_query_service)
</dt> <dt>

[**соединиться**](/windows/desktop/api/winsock2/nf-winsock2-connect)
</dt> <dt>

[**SOCKADDR \_ БС**](/windows/desktop/api/Ws2bth/ns-ws2bth-sockaddr_bth)
</dt> <dt>

[**всааддресстостринг**](/windows/desktop/api/winsock2/nf-winsock2-wsaaddresstostringa)
</dt> <dt>

[**всалукупсервицебегин**](/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicebegina)
</dt> <dt>

[**всалукупсервицеенд**](/windows/desktop/api/winsock2/nf-winsock2-wsalookupserviceend)
</dt> <dt>

[**всалукупсервиценекст**](/windows/desktop/api/winsock2/nf-winsock2-wsalookupservicenexta)
</dt> <dt>

[**всакуерисет**](/windows/desktop/api/winsock2/ns-winsock2-wsaquerysetw)
</dt> <dt>

[Сокеты Windows](/windows/desktop/WinSock/windows-sockets-start-page-2)
</dt> </dl>

