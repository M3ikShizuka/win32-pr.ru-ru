---
description: В этом разделе описывается воздействие расширенного формата устройств хранения на программное обеспечение, обсуждаются приложения, которые могут помочь в поддержке такого типа мультимедиа, а также рассматривается инфраструктура, появившаяся в составе Windows 7 с ПАКЕТом обновления 1 (SP1) и Windows Server 2008 R2 с пакетом обновления 1 (SP1), позволяющая разработчикам поддерживать такие типы устройств.
ms.assetid: 1D2847A7-15E9-42E0-90EB-7F43E76D3E44
title: Обновление для совместимости за счет эмуляции дисков с 512-байтовыми секторами (512e)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 94fbdce2937e2d121d892d8566755dfcb7f20f01
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104081563"
---
# <a name="512-byte-emulation-512e-disk-compatibility-update"></a>Обновление для совместимости за счет эмуляции дисков с 512-байтовыми секторами (512e)

## <a name="platform"></a>Платформа

 **Клиенты** — Windows Vista Windows 7 \| \| с пакетом обновления 1 (SP1)  
**Серверы** — windows Server 2008 \| Windows Server 2008 r2 \| Windows Server 2008 R2 с пакетом обновления 1 (SP1)  

## <a name="feature-impact"></a>Воздействие на функции

**Серьезность** — высокая  
**Частота** — высокая  









## <a name="description"></a>Описание

Плотность с областями увеличивается ежегодно, и с недавним появлением дисков объемом 3 ТБ механизмы исправления ошибок, используемые для работы с уменьшением сигнала на шум (СНР), становятся неэффективными, то есть увеличенный объем накладных расходов необходим для обеспечения использования мультимедиа. Одно из отраслевых решений для улучшения этого механизма исправления ошибок состоит в том, чтобы ввести другой формат физического носителя, который включает в себя большой размер физического сектора. Этот новый формат физического носителя называется *расширенным форматом*. Таким образом, больше не рекомендуется делать никаких предположений относительно размера сектора современных запоминающих устройств, и разработчикам необходимо изучить допущения, лежащие в основе кода, чтобы определить, есть ли последствия.

В этом разделе описывается воздействие расширенного формата устройств хранения на программное обеспечение, обсуждаются приложения, которые могут помочь в поддержке такого типа мультимедиа, а также обсуждается инфраструктура, позволяющая разработчикам поддерживать такие типы устройств. Хотя материал, представленный в этом разделе, содержит рекомендации по улучшению совместимости с дополнительными дисками формата, информация обычно применяется ко всем системам с дополнительными дисками формата. Следующие версии Windows обеспечивают поддержку запросов к физическому размеру сектора:

-   Windows 7 с Microsoft KB 982018
-   Windows 7 с пакетом обновления 1 (SP1)
-   Windows Server 2008 R2 с Microsoft KB 982018
-   Windows Server 2008 R2 с пакетом обновления 1 (SP1)
-   Windows Vista с Microsoft KB 2553708
-   Windows Server 2008 с Microsoft KB 2553708

Дополнительные сведения см. [в разделе сведения о политике поддержки Майкрософт для дисков больших секторов в Windows](https://support.microsoft.com/kb/2510009).

Чтобы получить дополнительные сведения о дисках расширенного формата, обратитесь к поставщику хранилища.

## <a name="logical-vs-physical-sector-size"></a>Логический и физический размер сектора

Одной из проблем, связанных с внесением такого изменения в формат мультимедиа, является совместимость с программным обеспечением и оборудованием, которое сейчас доступно на рынке. Как временное решение, отрасль хранения изначально представляет диски, имитирующие обычный 512-байтовый сектор, но предоставляет доступ к информации о истинном размере сектора с помощью стандартных команд ATA и SCSI. В результате эмуляции существует два размера сектора:

-   **Логический сектор**: единица, используемая для адресации логических блоков носителя. Мы также можем рассматривать его как наименьшую единицу записи, которую может принимать хранилище. Это эмуляция.

-   **Физический сектор**. единица, для которой операции чтения и записи на устройстве выполняются за одну операцию. Это единица атомарной записи.

Большинство текущих интерфейсов API Windows, таких как **ioctl \_ диска \_ Get \_ Drive \_ Geometry** , возвращают размер логического сектора, но размер физического сектора можно получить с помощью управляющего кода [ \_ \_ \_ Свойства запроса на хранение](/windows-hardware/drivers/ddi/content/ntddstor/ni-ntddstor-ioctl_storage_query_property) , с соответствующей информацией, содержащейся в поле **битесперфисикалсектор** структуры [ \_ \_ \_ дескриптора выравнивания доступа к хранилищу](/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor) . Это рассматривается более подробно далее в этой статье.

## <a name="initial-types-of-large-sector-media"></a>Начальные типы носителей больших секторов

Отрасли хранилища быстро изменяют усилия по переходу к новому расширенному типу формата хранения для носителей с размером физических секторов 4 КБ. На рынке будет выпущено два типа носителей:

-   **4 КБ в машинном** виде: этот носитель не имеет слоя эмуляции и непосредственно предоставляет 4 КБ в качестве логического и физического размера сектора. В настоящее время этот носитель не поддерживается Windows и большинством других операционных систем. Однако корпорация Майкрософт проводит исследование возможности поддержки этого типа мультимедиа в будущей версии Windows и при необходимости выдаст статью базы знаний.
-   **512-байтовая эмуляция (512e)**: этот носитель имеет слой эмуляции, как обсуждалось в предыдущем разделе, и предоставляет 512-байт в качестве логического размера (аналогично обычному диску), но обеспечивает доступ к сведениям о размере физического сектора (4 КБ). В настоящее время несколько поставщиков хранилищ поставляются на рынке. Эта общая проблема с этим новым типом носителя заключается в том, что большинство приложений и операционных систем не понимают существование физического размера сектора, что может привести к ряду проблем, которые будут рассмотрены ниже.

## <a name="how-emulation-works-read-modify-write-rmw"></a>Как работает эмуляция: чтение и изменение — запись (РМВ)

Среда хранения содержит определенную единицу, в которой можно изменить физический носитель. Это значит, что носитель может быть записан или переписан только в единицах физического размера сектора. Таким образом, операции записи, которые не выполняются на этом уровне единиц, потребуют дополнительных действий, которые мы рассмотрим в следующем примере.

В этом сценарии приложению необходимо обновить содержимое записи Датастор, расположенной в 512-байтном логическом секторе. На следующей схеме показаны шаги, необходимые для завершения записи на устройстве хранения.

![шаги, необходимые для обновления записи датастор в пределах 512-байтового логического сектора](images/512ermwsteps.png)

Как показано выше, этот процесс подразумевает некоторую работу устройства хранения, которое может привести к снижению производительности. Чтобы избежать этой дополнительной работы, необходимо обновить приложения, чтобы сделать следующее:

-   Запрос размера физического сектора.
-   Убедитесь, что операции записи согласованы с полученным физическим размером сектора.

## <a name="the-resiliency-impact-of-read-modify-write"></a>Влияние на устойчивость к чтению и изменению записи

Устойчивость говорит о том, что приложение может восстановить состояние между сеансами. Мы увидели, что необходимо для устройства хранения 512e, чтобы выполнить запись 512-байтового сектора — это цикл чтения-изменения и записи. Рассмотрим, что произойдет, если процесс перезаписи предыдущего физического сектора на носителе был прерван. Каковы последствия?

-   Так как большинство жестких дисков обновляется на месте, физический сектор, то есть часть носителя, на котором размещен физический сектор, может быть поврежден с неполными сведениями из-за частичной перезаписи. Другими словами, вы можете считать, что это может привести к потере всех 8 логических секторов (которые логически содержат физический сектор).

-   Хотя большинство приложений с хранилищем данных спроектировано с возможностью восстановления после ошибок носителя, потери восьми секторов или размещения другого способа, потери восьми записей фиксации потенциально могут привести к невозможности корректного восстановления хранилища данных. Администратору может потребоваться ручное восстановление базы данных из резервной копии или даже необходимость выполнения длительного перестроения.

-   Еще одно важное влияние заключается в том, что работа другого приложения, вызывающего цикл чтения-изменения и записи, может привести к потере данных — даже если приложение не запущено. Это просто потому, что ваши данные и данные другого приложения могут находиться в одном физическом секторе.

С учетом этого важно, чтобы программное обеспечение приложения пересмотрело все предположения, принятые в коде, и было известно о различии логического физического размера сектора, а также о некоторых интересных сценариях клиентов, обсуждаемых далее в этой статье.

Чаще всего эта проблема возникает, если приложение использует хранилище данных структуры журнала.

## <a name="avoiding-read-modify-write"></a>Предотвращение чтения и изменения — запись

Хотя некоторые поставщики хранилища могут представлять некоторые уровни устранения рисков в определенных устройствах хранения 512e, чтобы попытаться упростить производительность и устойчивость цикла чтения-изменения и записи, существует всего лишь то, что в плане рабочей нагрузки может обрабатываться лишь множество проблем. Таким образом, приложения не должны полагаться на эту опасность как долгосрочное решение.

Это решение не предназначено для устранения проблемы, но для того, чтобы приложения выполнили нужный набор действий, чтобы избежать цикла чтения-изменения и записи. В этом разделе обсуждаются распространенные сценарии, в которых приложения могут столкнуться с проблемами с большими секторами, и предлагаются способы проведения расследования по устранению неполадок.

### <a name="issue-1-the-partition-is-not-aligned-to-a-physical-sector-boundary"></a>Выпуск 1. Секция не согласована с границей физического сектора.

Когда администратор или пользователь разделяет разделы диска, первый раздел может не быть создан на границе. Это может привести к тому, что все последующие операции записи не будут выровнены по границам физического сектора. Начиная с Windows Vista с пакетом обновления 1 (SP1) и Windows Server 2008, первый раздел помещается в первую 1024 КБ диска (для дисков размером 4 ГБ или больше, в противном случае — значение, равное 64 КБ), которое соответствует границе физического сектора 4 КБ. Однако при наличии секционирования по умолчанию в Windows XP, служебная программа секционирования сторонних разработчиков или неправильное использование API-интерфейсов Windows созданные секции могут не быть согласованы с границей физического сектора. Чтобы обеспечить выравнивание, разработчикам необходимо обеспечить использование правильных API-интерфейсов. Рекомендуемые API-интерфейсы, помогающие обеспечить выравнивание разделов, описаны ниже.

API **ивдспакк:: креатеволуме** и **IVdsPack2:: CreateVolume2** не используют указанный параметр выравнивания при создании нового тома, а вместо этого используют значение выравнивания по умолчанию для операционной системы (до Windows Vista с пакетом обновления 1 (sp1) будет использовать 63 байт, а после установки пакета обновления 1 (SP1) для Windows Vista будут использоваться значения по умолчанию, указанные выше). Поэтому рекомендуется, чтобы приложения, которые должны создавать секции, использовали интерфейсы API **ивдскреатепартитионекс:: креатепартитионекс** или **Ивдсадванцеддиск:: сбой метода CreatePartition** , которые используют указанный параметр выравнивания.

Лучший способ обеспечить правильное выравнивание — это сделать это прямо при первоначальном создании секции. В противном случае приложению потребуется выполнить выравнивание при выполнении операций записи или при инициализации, что может быть очень сложным. Начиная с Windows Vista с пакетом обновления 1 (SP1), обычно это не проблема; Однако более старые версии Windows могут создавать несогласованные разделы, которые могут привести к проблемам с производительностью некоторых дополнительных дисков форматирования.

### <a name="issue-2-unbuffered-writes-not-aligned-to-physical-sector-size"></a>Выпуск 2. небуферизованные операции записи, не согласованные с физическим размером сектора

Основная проблема заключается в том, что операции записи без буферизации не будут согласованы с зарегистрированным физическим размером сектора носителя, который запускает чтение и изменение записи на диске, что может привести к проблемам с производительностью. Буферизованные записи, с другой стороны, вычисляются по размеру страницы — 4 КБ — это физический размер сектора первого поколения носителя большого сектора. Однако большинство приложений с хранилищем данных выполняют операции записи без буферизации, поэтому они должны обеспечить выполнение этих операций записи в единицах физического размера сектора.

Чтобы определить, выдает ли приложение небуферизованные операции ввода-вывода, убедитесь, что в параметре *двфлагсандаттрибутес* при вызове функции **CreateFile** не установлен флаг **\_ \_ \_ буферизации для файла** .

Более того, если в настоящее время выполняется согласование операций записи с размером сектора, то этот размер сектора, скорее всего, будет просто *логическим* размером, так как большинство существующих интерфейсов API, которые запрашивают размер сектора носителя, действительно просто запрашивают единицу адресации, то есть логический размер сектора. Размер сектора здесь — это физический размер сектора, который является реальной единицей атомарности. Ниже приведены некоторые примеры интерфейсов API, которые получают размер логического сектора.

-   **Жетдискфриспаце**, **жетдискфриспацеекс**
-   **филефсволумеинформатион**
-   Запрос **ioctl \_ ДИСК \_ " \_ получить \_ геометрию диска**", **ioctl \_ диск \_ получить \_ диск \_ Geometry \_ ex**
-   **Ивдсдиск:: Properties**, **IVdsDisk3:: GetProperties2**

**Как запросить размер физического сектора**

Корпорация Майкрософт предоставила пример кода на сайте MSDN, в котором подробно описано, как приложение может запрашивать физический размер сектора тома. Пример кода находится в папке <https://msdn.microsoft.com/library/ff800831.aspx> .

Хотя приведенный выше пример кода позволяет получить физический размер сектора тома, перед его использованием следует выполнить некоторые базовые работоспособности проверки полученного физического сектора, так как он наблюдал, что некоторые драйверы могут не возвращать данные в правильном формате:

-   Убедитесь, что сообщаемый размер физического сектора >= сообщаемый размер логического сектора. Если это не так, приложение должно использовать физический размер сектора, равный указанному размеру логического сектора.
-   Убедитесь, что сообщаемый размер физического сектора является степенью двух. Если это не так, приложение должно использовать физический размер сектора, равный указанному размеру логического сектора.
-   Если размер физического сектора составляет два значения в диапазоне от 512 до 4 КБ, следует использовать физический размер сектора, округленный к сообщенному размеру логического сектора.
-   Если размер физического сектора составляет два значения, превышающий 4 КБ, перед использованием этого значения следует оценить способность приложения справиться с этим сценарием. В противном случае следует использовать физический размер сектора, округленный до 4 КБ.

Использование этого IOCTL для получения размера физического сектора имеет несколько ограничений:

-   Требуются повышенные привилегии. Если приложение не работает с правами доступа, может потребоваться написать приложение службы Windows, как отмечалось выше.

-   Не поддерживает тома SMB. Вам также может потребоваться написать приложение службы Windows для поддержки запроса размера физического сектора на этих томах.

-   Не может быть выдан каким-либо маркером файла (запрос IOCTL должен быть выдан для маркера тома).

-   Поддерживается только в версиях Windows, перечисленных в начале этой статьи.

**Записи фиксации дополняются до 512 байт**

Приложения с хранилищем данных обычно имеют некоторую форму записи фиксации, которая либо хранит сведения об изменениях метаданных, либо поддерживает структуру хранилища данных. Чтобы гарантировать, что потери сектора не влияют на несколько записей, эта запись фиксации обычно заполняется размером сектора. При использовании диска с большим размером физического сектора приложение должно запросить физический размер сектора, как показано в предыдущем разделе, и убедиться, что каждая запись фиксации заполнена этим размером. Это не только позволяет избежать цикла чтения-изменения-записи. Это гарантирует, что в случае потери физического сектора будет потеряна только одна запись фиксации.

**Файлы журнала записываются в несогласованные фрагменты**

Операции ввода-вывода без буферизации обычно используются при обновлении или добавлении файла журнала. Существует несколько способов обеспечить правильное согласование этих обновлений:

-   Внутренняя буферизация обновлений журнала до сообщаемого размера физического сектора операционной системы и выдача записей журнала только при заполнении единицы физического сектора.
-   Использовать буферизованный ввод-вывод

### <a name="issue-3-file-formats-relying-on-512-byte-sectors"></a>Причина 3. форматы файлов, которые полагается на 512-байтовые сектора

Некоторые приложения со стандартными форматами файлов (например, VHD 1,0) могут иметь жестко запрограммированные файлы, чтобы иметь размер секторов размером 512 байт. Таким образом, операции обновления и записи в этот файл приведут к появлению на устройстве цикла чтения и изменения, что может привести к снижению производительности и устойчивости клиентов. Однако существует несколько способов предоставления поддержки для работы с носителями такого типа, например:

-   Использование буферизации для проверки выполнения операций записи в единицах физического размера сектора
-   Реализуйте внутреннее чтение, изменение и запись, которое поможет обеспечить выполнение обновлений в единицах полученного физического сектора.
-   Если возможно, заполните запись на физический сектор таким образом, что заполнение будет интерпретироваться как пустое пространство
-   Рассмотрите возможность перепроектирования новой версии структуры данных приложения с поддержкой больших секторов.

### <a name="issue-4-the-reported-physical-sector-size-can-change-between-sessions"></a>Причина 4. сообщаемый размер физического сектора может измениться между сеансами

Существует множество сценариев, в которых зарегистрированный размер физического сектора базового хранилища, на котором размещается Датастор, может измениться. Чаще всего это происходит при переносе Датастор на другой том или даже по сети. Изменение в сообщаемом размере физического сектора может быть неожиданным событием для многих приложений и может привести к невозможности повторной инициализации некоторых приложений.

Это не самый простой сценарий для поддержки, и он упоминается здесь как Совет. Следует учитывать требования к мобильности клиентов и соответствующим образом настроить поддержку, чтобы гарантировать, что клиенты не будут негативно влиять на использование носителя 512e.

## <a name="4-kb-native-media"></a>Собственный носитель объемом 4 КБ

512 — носитель эмуляции байтов используется в качестве переходного шага между 512-байтным собственным носителем и 4 КБ в машинном формате, и в ближайшее время мы планируем использовать 4 КБ машинного носителя, выпущенного после 512e. Есть несколько важных последствий с этим носителем, которые следует отметить:

-   Логические и физические размеры секторов — 4 КБ.
-   Так как уровень эмуляции отсутствует, хранилище с несогласованными операциями записи не будет выполнено.
-   Нет непопадания в скрытую устойчивость — приложения работают или не работают.

Хотя корпорация Майкрософт в настоящее время изучает поддержку этих типов носителей в будущей версии Windows и выдаст статью базы знаний, когда это уместно, разработчикам приложений следует рассмотреть возможность использования этих типов носителей с вытеснением.

## <a name="closing"></a>Закрытие

В этой статье мы обсуждали, что на больших носителях большого объема появился ряд распространенных сценариев развертывания. Мы рассмотрели влияние на производительность и устойчивость на чтение-изменение — запись, некоторые из интересных ситуаций, которые могут возникнуть в этом носителе, и набор проблем, которые могут быть вызваны с помощью программного обеспечения, что в конечном итоге влияет на конечного пользователя. Отрасль хранения быстро переходит на мультимедиа с большими размерами секторов, и очень скоро клиенты не смогут приобретать диски с традиционными 512-байтными размерами секторов.

Это активный документ, который предназначен для разработчиков, помогающих понять этот переход. Вы должны начать беседу с соответствующими организациями, с клиентами, ИТ-специалистами и поставщиками оборудования, чтобы говорить о смене сектора, а также о том, как он влияет на сценарии, важные для вас.

## <a name="links-to-other-resources"></a>Ссылки на другие ресурсы

-   **Общая поддержка Windows**: <https://support.microsoft.com/kb/2510009>
-   **Исправление для Windows 7 и Windows Server 2008 R2**: <https://support.microsoft.com/kb/982018>
-   **Исправление для Windows Vista и Windows Server 2008**: <https://support.microsoft.com/kb/2470478>
-   **Оператор поддержки HyperV**: <https://support.microsoft.com/kb/2515143>
-   **Общие сведения о ioctl \_ \_ \_ Управляющий код свойства запроса хранилища**: [https://msdn.microsoft.com/library/ff560590.aspx](/windows-hardware/drivers/ddi/ntddstor/ni-ntddstor-ioctl_storage_query_property)
-   Запрос **ioctl \_ \_ \_ Управляющий код свойства запроса хранилища**:[https://msdn.microsoft.com/library/ff800830.aspx](/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_query_property)
-   **Общие сведения о хранилище \_ \_ \_ Структура дескриптора выравнивания доступа**: [https://msdn.microsoft.com/library/ff566344.aspx](/windows-hardware/drivers/ddi/ntddstor/ns-ntddstor-_storage_access_alignment_descriptor)
-   **Описание стандартной терминологии, используемой для описания обновлений программного обеспечения Майкрософт**: <https://support.microsoft.com/kb/824684/>
-   **Пример кода WDK** с подробными сведениями о том, как извлечь сообщаемые сведения о выравнивании доступа к хранилищу из структуры **\_ \_ \_ дескриптора выравнивания доступа к хранилищу** при вызове управляющего кода **\_ \_ \_ Свойства запроса на хранение ioctl** : [/Виндовс/десктоп/АПИ/виниоктл/НС-виниоктл-storage_access_alignment_descriptor](/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor)
-   **Общие сведения о параметрах Command-Line ImageX**: <https://technet.microsoft.com/library/dd799302(WS.10).aspx>
-   **Требования к драйверу набора микросхем Intel для поддержки дисков с размером 4 КБ**: <https://www.intel.com/support/chipsets/imsm/sb/CS-031502.htm>
-   Дополнительные сведения о дисках расширенного формата см. на следующих веб-сайтах ИДЕМА:
    -   <http://idema.org/?page_id=2172>
    -   <http://idema.org/?download=7926>

 

 
