---
description: узнайте, как предотвратить утечки памяти в Windowsных приложениях для платформ Windows 7 и Windows Server 2008 R2.
ms.assetid: c5dedcab-3e6f-433f-95de-d741321c683e
title: предотвращение утечек памяти в Windows приложениях
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ef336c52ff4869ae9947b898e8a42c480be58054315de0180ec6a18f8c917f51
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118994803"
---
# <a name="preventing-memory-leaks-in-windows-applications"></a>предотвращение утечек памяти в Windows приложениях

## <a name="affected-platforms"></a>Затронутые платформы

**клиенты** — Windows 7  
**серверы** — Windows Server 2008 R2  

## <a name="description"></a>Описание

Утечки памяти — это класс ошибок, в которых приложение не может освободить память, если она больше не нужна. Со временем утечки памяти влияют на производительность как конкретного приложения, так и операционной системы. Большая утечка может привести к неприемлемому времени отклика из-за чрезмерного разбиения на страницы. В конечном итоге приложение, а также другие части операционной системы будут испытывать сбои.

Windows будет освобождать всю память, выделенную приложением при завершении процесса, поэтому кратковременные приложения не будут существенно влиять на общую производительность системы. однако утечки в долгосрочных процессах, таких как службы или даже подключаемые модули обозревателя, могут значительно повлиять на надежность системы и могут привести к принудительной перезагрузке пользователя Windows для повторного использования системы.

Приложения могут выделить память от своего имени несколькими способами. Каждый тип выделения может привести к утечке, если они не освобождаются после использования. Ниже приведены некоторые примеры распространенных шаблонов выделения.

-   Память кучи с помощью функции [**хеапаллок**](/windows/win32/api/heapapi/nf-heapapi-heapalloc) или среды выполнения C/C++ эквивалента **malloc** или **New**
-   Прямые выделения из операционной системы с помощью функции [**VirtualAlloc**](/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) .
-   Дескрипторы ядра, созданные через API kernel32, такие как [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea), [**CreateEvent**](/windows/win32/api/synchapi/nf-synchapi-createeventa)или [**CreateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread), хранят память ядра от имени приложения.
-   GDI и пользовательские дескрипторы, созданные с помощью интерфейсов API user32 и GDI32 (по умолчанию каждый процесс имеет квоту 10 000 дескрипторов).

## <a name="best-practices"></a>Советы и рекомендации

Мониторинг потребления ресурсов приложением с течением времени — это первый шаг в определении и диагностике утечек памяти. используйте Windows диспетчер задач и добавьте следующие столбцы: "размер фиксации", "дескрипторы", "объекты пользователя" и "объекты GDI". Это позволит вам создавать базовые показатели для приложения и отслеживать использование ресурсов с течением времени.

![снимок экрана, на котором показана страница "процессы" в Windows диспетчере задач.](images/preventingmemoryleaks-windowstaskmanager.gif)

Следующие средства Майкрософт предоставляют более подробную информацию и позволяют обнаруживать и диагностировать утечки для различных типов распределения в приложении:

-   системный монитор и монитор ресурсов входят в Windows 7 и могут отслеживать использование ресурсов и работать с ними на диаграмме с течением времени
-   последняя версия средство проверки приложений может диагностировать утечки кучи в Windows 7
-   умдх, который является частью средств отладки для Windows, анализирует выделение памяти кучи для данного процесса и может помочь найти утечки и другие необычные шаблоны использования
-   XPerf — это сложное средство анализа производительности с поддержкой трассировок выделения кучи.
-   Отладочная куча CRT отслеживает выделение кучи и может помочь в построении собственных функций отладки кучи.

Некоторые рекомендации по написанию кода и проектированию могут ограничивать количество утечек в коде.

-   Используйте смарт-указатели в коде C++ как для выделения кучи, так и для ресурсов Win32, таких как **маркер** ядра s. Стандартная библиотека C++ предоставляет автоматический класс **\_ ptr** для выделения кучи. Для других типов выделения потребуется написать собственные классы. Библиотека ATL предоставляет широкий набор классов для автоматического управления ресурсами как для объектов кучи, так и для дескрипторов ядра.
-   Используйте встроенные функции компилятора, такие как **\_ COM \_ ptr \_ t** , для инкапсуляции указателей COM-интерфейса в "интеллектуальные указатели" и помощи при подсчете ссылок. Существуют похожие классы для других типов данных COM: **\_ BSTR \_ t** и **\_ Variant \_ t**
-   Отслеживайте необычное использование памяти в коде .NET. Управляемый код не является незащищенным от утечек памяти. Сведения о поиске утечек GC см. в разделе ["Отслеживание утечек памяти в управляемом виде"](/archive/blogs/ricom/) .
-   Помните о шаблонах утечек в коде на стороне клиента. циклические ссылки между COM-объектами и обработчиками скриптов, такими как JScript, могут привести к большим утечкам в приложениях. ["Основные сведения и решение проблем с утечками Internet Explorer"](/previous-versions/ms976398(v=msdn.10)) содержит больше информации об этих типах утечек. Для отладки утечек памяти в коде можно использовать средство обнаружения утечек памяти JavaScript. хотя Windows Internet Explorer 8, который поставляется с Windows 7, устраняет большую часть этих проблем, старые браузеры остаются уязвимыми для этих ошибок.
-   Избегайте использования нескольких путей выхода из функции. Выделения, назначенные переменным в области видимости функции, должны освобождаться в одном конкретном блоке в конце функции.
-   Не используйте исключения в коде без высвобождения всех локальных переменных в функциях. При использовании собственных исключений Освободите все выделенные ресурсы внутри \_ \_ блока finally. При использовании исключений C++ все кучи и обработку выделений должны быть заключены в интеллектуальные указатели.
-   Не отменяйте или не инициализируйте объект [**пропвариант**](/windows/win32/api/propidlbase/ns-propidlbase-propvariant) без вызова функции [**пропвариантклеар**](/windows/win32/api/combaseapi/nf-combaseapi-propvariantclear)

## <a name="links-to-resources"></a>Ссылки на ресурсы

*Распространенные шаблоны выделения:*

-   [**Функция выделения кучи**](/windows/win32/api/heapapi/nf-heapapi-heapalloc)
-   [**Функция выделения памяти**](https://msdn.microsoft.com/library/6ewkz86d(v=VS.71).aspx)
-   [**Оператор New (C++)**](https://msdn.microsoft.com/library/kewsb8ba(v=VS.71).aspx)
-   [**Виртуальная функция выделения**](/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc)
-   [Объекты ядра](../sysinfo/kernel-objects.md)
-   [Дескрипторы объектов GDI](../sysinfo/gdi-objects.md)
-   [Дескрипторы объектов пользовательского интерфейса](../sysinfo/user-objects.md)

*Средства Майкрософт:*

-   [средство проверки приложений](application-verifier.md)
-   [Средства отладки для Windows](/windows-hardware/drivers/debugger/)
-   [Куча дампа пользовательского режима](/windows-hardware/drivers/debugger/umdh)
-   [Средство отслеживания трассировки, обработки и анализа](https://msdn.microsoft.com/performance/cc825801.aspx)
-   [Куча отладки CRT](/visualstudio/debugger/crt-debug-heap-details?view=vs-2015)

*Дополнительные ссылки:*

-   [**Автоматический \_ класс PTR**](https://msdn.microsoft.com/library/ew3fk483(v=VS.71).aspx)
-   [Классы памяти библиотеки активных шаблонов (ATL)](https://msdn.microsoft.com/library/44yh1z4f(v=VS.71).aspx)
-   [**\_\_объект COM PTR \_ t**](https://msdn.microsoft.com/library/417w8b3b(v=VS.71).aspx)
-   [**\_\_класс BSTR t**](https://msdn.microsoft.com/library/zthfhkd6(v=VS.71).aspx)
-   [**\_\_класс Variant YT**](https://msdn.microsoft.com/library/x295h94e(v=VS.71).aspx)
-   ["Отслеживание утечек памяти в управляемом виде"](/archive/blogs/ricom/)
-   [«Основные сведения и разрешение шаблонов утечек Internet Explorer»](/previous-versions/ms976398(v=msdn.10))
-   ["Детектор утечки памяти JavaScript"](/archive/blogs/gpde/new-javascript-memory-leak-detector-from-our-team)
-   [Циклическая утечка памяти (в браузерах):](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/dd361842(v=vs.85))
-   [**Оператор try-finally**](https://msdn.microsoft.com/library/yb3kz605(v=VS.71).aspx)
-   [**Структура ПРОПВАРИАНТ**](/windows/win32/api/propidlbase/ns-propidlbase-propvariant)
-   [**Функция Пропвариантклеар**](/windows/win32/api/combaseapi/nf-combaseapi-propvariantclear)

 

 
