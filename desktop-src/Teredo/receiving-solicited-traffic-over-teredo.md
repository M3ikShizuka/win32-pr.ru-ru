---
title: Получение запрошенного трафика через Teredo
description: Многие приложения, такие как Microsoft Internet Explorer и Microsoft Outlook, инициируют только подключения к Интернету.
ms.assetid: bff5d65e-050d-4b09-9982-8024612ffa6e
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 035d067afeb9c62795efb5acd0bb28adc3afcb16
ms.sourcegitcommit: 773fa6257ead6c74154ad3cf46d21e49adc900aa
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/09/2020
ms.locfileid: "104533563"
---
# <a name="receiving-solicited-traffic-over-teredo"></a>Получение запрошенного трафика через Teredo

Многие приложения, такие как Microsoft Internet Explorer и Microsoft Outlook, инициируют только подключения к Интернету. Для этих приложений [Teredo](about-teredo.md) может обеспечить бесперебойное подключение по протоколу IPv6 в отсутствие других интерфейсов IPv6. Кроме того, запрошенный трафик может быть получен через интерфейс Teredo на более ранних платформах Microsoft Windows XP с пакетом обновления 2 (SP2) и Windows Server 2003.

В следующей документации объясняется, как эти приложения достигают подключения, и обстоятельства, при которых используется Teredo.

## <a name="obtaining-a-destination-address"></a>Получение адреса назначения

Приложение пытается получить адрес назначения с помощью различных методов, таких как система доменных имен (DNS) или протокол PNRP (Peer Name Resolution Protocol). Приложение может получить несколько IP-адресов IPv4 и IPv6 с помощью этих методов. Типичные API, используемые для получения IP-адресов, включают в себя Windows XP API [**gethostbyname**](/windows/desktop/api/wsipv6ok/nf-wsipv6ok-gethostbyname) и новый [**функцию getaddrinfo**](/windows/desktop/api/ws2tcpip/nf-ws2tcpip-getaddrinfo)API Windows Vista. Например, использование API функцию getaddrinfo с параметром *\_ семейства AI* , установленным в AF \_ INET6, в качестве подсказки аддринфо/Protocol позволяет пользователю запрашивать DNS-серверы в определенном формате. API [**днскуери**](/windows/desktop/api/windns/nf-windns-dnsquery_a) с типом DNS \_ \_ AAAA можно также использовать для запроса DNS-серверов для записей AAAA.

## <a name="establishing-a-connection"></a>Установление подключения

Соединение, установленное с помощью Teredo, описывается как "неэффективное", так как оно обрабатывается как любое другое подключение IPv6. При программировании приложения не требуется особое внимание на возможность использования интерфейса Teredo. Если между интерфейсами Teredo установлено подключение, то маршрутизатор ретрансляции, стандартный интерфейс 6to4 и другие собственные интерфейсы, не требуется. Однако Teredo разработан в качестве последней технологии перехода на IPv6-подключения.

> [!Note]  
> Teredo не используется, если предоставленное имя узла разрешается только по IPv4-адресам.

 

Когда приложение пытается подключиться к месту назначения с использованием IPv6-адресов, произойдет следующее:

-   Приложение получает список IPv6-адресов, вызывая API [**жетадаптерсаддрессес**](/windows/desktop/api/iphlpapi/nf-iphlpapi-getadaptersaddresses) . Стек Windows Vista возвращает список всех интерфейсов на основе порядка сортировки, указанного в [RFC 3484](https://www.irt.org/rfc/rfc3484.htm). В результате интерфейсы IPv6 и 6to4 будут перечислены перед интерфейсом Teredo. Однако если неуправляемое подключение по протоколу IPv6 или 6to4 недоступно, то в списке будет использоваться единственный интерфейс, поддерживающий IPv6.

    Важно помнить, что приложение может использовать любой интерфейс, предоставляемый стеком Windows Vista, однако порядок, в котором возвращается список интерфейсов, чаще всего приводит к появлению последней попытки.

-   Перед тем как система Windows Vista попытается подключиться через интерфейс Teredo, операционная система гарантирует, что IPv6-адрес будет изменяться. Это делается автоматически для исходящих подключений и не является ключевым фактором для приложения. В случае, если приложение должно гарантировать стабильность адресов, можно вызвать API [**нотифистаблеуникастипаддресстабле**](/windows/desktop/api/netioapi/nf-netioapi-notifystableunicastipaddresstable) , чтобы убедиться, что адрес Teredo является стабильным.

-   Интерфейс Teredo будет пытаться подключиться к другому интерфейсу Teredo в месте назначения. Если интерфейс Teredo отсутствует, подключение устанавливается с адресом назначения машинного кода или 6to4 через ретранслятор, относящийся к конкретному узлу.

Кроме того, приложения, которые инициируют подключения к Интернету, могут получить незапрошенный трафик. Дополнительные сведения см. в статье [получение незапрошенного трафика через Teredo](receiving-unsolicited-traffic-over-teredo.md).

## <a name="using-the-wsaconnectbyname-api"></a>Использование API WSAConnectByName

Вызывая API WSAConnectByName, приложение может подключиться к конечному имени вместо указания точного IP-адреса. Стек Windows Vista предпочитает IPv6 по протоколу IPv4, и в результате все попытки подключения к IPv6-адресам будут выполняться первыми.

Вызов API WSAConnectByName сортирует все целевые IP-адреса, полученные в следующем порядке:

-   Собственный IPv6-адрес
-   IP-адрес 6to4
-   IPv4-адрес
-   Адрес Teredo

После того как адреса назначения сортируются внутри, выполняется попытка подключения к назначению на основе лучшего маршрута, доступного на локальном узле для адреса назначения. Как указано в порядке отсортированных адресов, если имя назначения разрешается в адрес IPv4 и Teredo, для установления соединения будет использоваться IPv4-адрес.

API WSAConnectByName работает внутренне для поиска наилучшего соответствия между адресами. Эта попыток основана на маршрутах, доступных на локальном узле и в адресах назначения.

Из-за текущего отсутствия ретрансляторов Teredo в Интернете подключения к собственным IPv6-адресам вряд ли будут выполняться через интерфейс Teredo. При вызове WSAConnectByName Windows Vista не будет выдавать запросы AAAA, если Teredo является единственным доступным интерфейсом с поддержкой IPv6. Это гарантирует, что собственные IPv6-адреса не будут получены в качестве назначения и что попытки подключения попытаются по протоколу IPv4, что дает наибольшую вероятность успеха. Чтобы получить IPv6-адреса, когда Teredo является единственным интерфейсом, поддерживающим IPv6, приложение должно явно использовать API Днскуери для записей AAAA.

 

 