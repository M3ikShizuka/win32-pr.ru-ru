---
title: Жизненный цикл задания BITS
description: Жизненный цикл задания BITS начинается при создании задания.
ms.assetid: b765a8ef-74bd-475e-9cd9-e9e2cf4f0305
ms.topic: article
ms.date: 11/13/2018
ms.openlocfilehash: 3182aec8eb4f4697ded8cfa5e44385e1fd34531779fa850fca8a9bbb52ac110f
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118173489"
---
# <a name="bits-job-states"></a>Состояния задания BITS
Существует четыре класса [**состояний**](/windows/desktop/api/Bits/ne-bits-bg_job_state)BITS: запуск, действие, передача и завершение. При выполнении задания оно переходит между состояниями в разных классах состояний. Когда задание находится в окончательном состоянии, оно не будет переноситься из конечного состояния и не будет отображаться в [перечислении заданий](/windows/desktop/api/bits/nf-bits-ibackgroundcopymanager-enumjobs).

## <a name="state-changing-methods"></a>Методы изменения состояния
Существует четыре метода изменения состояния для задания: [**Отмена**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-cancel), [**Завершение**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-complete), [**возобновление**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume)и [**приостановка**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-suspend). Пока задание не находится в окончательном состоянии, можно вызвать любой из методов изменения состояния. 

Метод [**Suspend**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-suspend) используется для переключения задания в состояние SUSPENDED. При приостановке задания все его передачи будут остановлены и не будут возобновлены до тех пор, пока не будет вызвано возобновление.
Уже приостановленное задание будет просто оставаться приостановленным.

Метод [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) используется для запуска приостановленного задания. Задания в состоянии ошибки или временной ошибки будут настроены для повторной попытки. Задания, которые в настоящее время находятся в состоянии действия, останутся в этом состоянии.

Метод [**Cancel**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-cancel) используется для отмены задания. Состояние будет переключаться на отменено. Все файлы, передаваемые в данный момент, не будут завершены. Все полностью переданные и частично перенесенные файлы будут удалены.

Метод [**Complete**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-complete) завершит перенос. Все полностью скачанные файлы будут сохранены; файлы, которые не были полностью переданы, будут удалены.

Чтобы переместить задание в конечное состояние и очистить его, необходимо вызвать либо Cancel, либо Complete. Задания, которые не переходят в конечное состояние, занимают системные ресурсы. В конечном итоге службы BITS автоматически отменяют старые задания. По умолчанию [жобинактивититимеаут](/windows/desktop/Bits/group-policies) отменяет задания через 90 дней.


## <a name="starting-state"></a>Начальное состояние 
Начальное состояние **приостановлено**. Здесь можно добавить файлы в задание и задать свойства задания и файла. Чтобы начать передачу задания, вызовите функцию Resume для задания. Если возобновить задание без файлов, оно вернет BG_E_EMPTY код ошибки, и задание останется приостановленным.

## <a name="action-states"></a>Состояния действий
В **очереди**, **подключении** и **передаче** состояний отображается текущее внутреннее действие задания. Задание, поставленное в очередь, готово к планированию, возможно, ожидание планировщика BITS или ожидание входа пользователя в систему. Задание, которое ПОДКЛЮЧАЕТся, пытается подключиться к серверу, чтобы начать передачу файлов. Переданное задание активно отправляет или скачивает файлы.

Состояние **временной ошибки** означает, что задание попыталось выполнить и не смогло передать файл. Это может быть вызвано причинами сетевой политики. Задание может быть заблокировано, так как текущая сеть слишком высока. Она также может быть заблокирована по причинам системы, например в режиме экономии заряда аккумулятора или игровой режим, либо из-за отсутствия подключения к Интернету. 

Задания в состоянии временной ошибки будут автоматически предприняты BITS при необходимости. Служба BITS включает значение [минимумретриделай](/windows/desktop/api/bits/nf-bits-ibackgroundcopyjob-setminimumretrydelay) и [нопрогресстимеаут](/windows/desktop/api/bits/nf-bits-ibackgroundcopyjob-setnoprogresstimeout) , которое позволяет управлять повторным выполнением задания, а также когда служба BITS прекращает повторную попытку.


## <a name="transferred-states"></a>Перенесенные состояния
Переданные состояния происходят, когда больше не требуется выполнять передачу. Необходимо либо отменить, либо завершить задание в этом состоянии. Вы также можете добавить дополнительные файлы для перемещения и вызвать Resume (), но это не является распространенной практикой.

Состояние **ошибки** возникает, когда операция перемещения выполнена (она не будет выполнена повторно), но не была полностью завершена. Все файлы должны быть успешно переданы для успешного выполнения; если таковые имеются, то задание будет содержать ошибку. Как правило, вы вызываете Cancel или Complete, чтобы переместить задание в конечное состояние. Практическая разница заключается в том, что при вызове Cancel любой успешно переданный файл будет удален, но если вызов завершен, любой успешно передаваемый файл не будет удален.

Причины в состоянии ошибки: 
* Сохранение слишком длинного состояния во ВРЕМЕННОм состоянии ошибки (за пределами параметра [нопрогресстимеаут](/windows/desktop/api/bits/nf-bits-ibackgroundcopyjob-setnoprogresstimeout) ).
* Получение BG_E_TOKEN_REQUIRED ошибки и потребовать помощи с [вспомогательными маркерами](/windows/desktop/Bits/helper-tokens-for-bits-transfer-jobs)

Распространенной практикой является перенастройка задания с ошибкой, а затем вызов Resume для повторного выполнения задания. Например, приложению может потребоваться обновить удаленное имя файла через [сетремотенаме](/windows/desktop/api/bits2_0/nf-bits2_0-ibackgroundcopyfile2-setremotename).

Переданное **состояние происходит, когда** передача выполнена и прошла успех. Чтобы завершить задание, необходимо вызвать функцию Complete. для заданий скачивания Скачанные файлы будут недоступны до тех пор, пока не будет выполнен вызов функции Complete. Исключением из этого правила являются задания, которые являются заданиями высокой производительности (и по-прежнему вызывают завершение).

## <a name="final-states"></a>Окончательные состояния
Когда задание находится в конечном состоянии, нельзя вызывать методы изменения состояния. Задание будет **подтверждено** после вызова функции Complete (), и все готовые Скачанные файлы будут доступны. Задание будет **отменено** после вызова Cancel (), и все скачанные файлы будут удалены. 


## <a name="life-cycle-of-a-bits-job"></a>Жизненный цикл задания BITS

Жизненный цикл задания BITS начинается при создании задания. Задание — это контейнер, содержащий один или несколько файлов для перемещения. Задание также имеет свойства, указывающие, как BITS передает файлы и взаимодействует с приложением. Например, можно указать приоритет задания, будь это задание отправки или загрузки, а также события, для которых необходимо получить уведомления.

После создания задания добавьте один или несколько файлов (задания отправки могут содержать только один файл) в задание и измените любые значения свойств в соответствии с вашими приложениями. При добавлении файла в задание укажите как локальное (клиент), так и удаленное (серверное) имя файла. Имя удаленного файла должно использовать протокол HTTP, HTTPS или SMB. Файлы в задании обрабатываются последовательно (сначала в, сначала исходящий трафик).

Служба BITS автоматически приостанавливает задания при их создании. Необходимо возобновить задание, чтобы активировать его в очереди на перемещение. Вы можете приостановить или возобновить задание в любое время. Возобновление задания перемещает задание из приостановленного состояния в состояние очереди. Задание остается в состоянии очереди до тех пор, пока планировщик не определит, что это задание переносит файлы. Все задания переднего плана выполняются параллельно с одним фоновым заданием. BITS обрабатывает файлы в заданиях переднего плана последовательно.

Если задача переносит файлы, задание переходит в состояние подключения, а служба BITS подключается к удаленному серверу (указанному в имени удаленного файла). Если служба BITS может подключиться к удаленному серверу, задание перемещается в состояние передачи, где оно остается до окончания временного среза, передача завершается, возникает ошибка или приложение приостанавливает задание.

Задание перемещается между состояниями, поставленными в очередь, подключением и передачей, пока служба BITS не перенесет все файлы в задании. На этом этапе задание перемещается в состояние передано. Служба BITS использует планирование циклического перебора для планирования заданий с одинаковым уровнем приоритета. Каждому заданию присваивается срез времени для обработки файлов. Если задание не завершается во время временного среза, задание возвращается в состояние очереди и активируется следующее задание в очереди. Это мешает большим заданиям блокировать небольшие задания. Задания в основном обрабатываются в порядке поступления (FIFO). Однако служба BITS не может гарантировать обработку FIFO из-за планирования с циклическим перебором, ошибок заданий и перезапусков служб.

Передаваемые файлы недоступны клиенту до тех пор, пока приложение не вызовет метод [**использованием метода ibackgroundcopyjob:: Complete**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-complete) для передачи прав владения файлами пользователю. задания Upload также передаются в переданное состояние, когда файл успешно получен сервером. задания Upload-reply передаются в переданное состояние после успешной отправки файла на сервер, и ответ от серверного приложения успешно передается клиенту.

При возникновении ошибки задание переходит в состояние неустранимой или временной ошибки. Неустранимые ошибки — это ошибки, которые не могут быть восстановлены из или из которых требуется вмешательство для исправления. Если приложение может исправить ошибку, приложение возобновляет задание, а служба BITS переместит задание в состояние очереди. Временные ошибки — это ошибки, которые могут быть устранены самостоятельно. Служба BITS повторяет задания в состоянии временной ошибки до тех пор, пока перемещение не будет выполнено или не истечет время ожидания задания. Время ожидания задания истекает, когда в течение заданного приложением периода не выполняется. Если время ожидания задания истекло, BITS перемещает задание в состояние неустранимой ошибки.

Дополнительные сведения о состояниях заданий см. в разделе [**\_ \_ состояние задания BG**](/windows/desktop/api/Bits/ne-bits-bg_job_state).
