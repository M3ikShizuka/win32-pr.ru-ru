---
title: Проверка подлинности (BITS)
description: Служба BITS поддерживает обычную проверку подлинности, проверку подлинности Passport и несколько схем проверки подлинности запросов и ответов.
ms.assetid: cfd4aec3-79d0-4971-93f8-df797e5c0f75
ms.topic: article
ms.date: 10/09/2018
ms.openlocfilehash: 9cb3d50f6689ed28889c68388969c1cb7d06ea912bc5d5ed4384f45a4e740f79
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119021292"
---
# <a name="authentication-bits"></a>Проверка подлинности (BITS)

Служба BITS поддерживает обычную проверку подлинности, проверку подлинности Passport и несколько схем проверки подлинности запросов и ответов. Если для сервера или прокси требуется проверка подлинности пользователя, используйте функцию [**IBackgroundCopyJob2:: сеткредентиалс**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) , чтобы указать учетные данные пользователя. Служба BITS использует интерфейс [CryptoAPI](/windows/desktop/SecCrypto/cryptography-portal) для защиты учетных данных.

Чтобы задать учетные данные для обычной проверки подлинности, используйте функцию [**сеткредентиалс**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) , чтобы указать имя пользователя и пароль. Следует использовать только обычную проверку подлинности с защищенными веб-сайтами https://. в противном случае имя пользователя и пароль будут видны пользователям. 

Имя пользователя и пароль можно внедрить в URL-адрес. Это не считается хорошей практикой в области безопасности и является устаревшим в RFC 3986 (раздел 3.2.1).

Для проверки подлинности с помощью [Passport](/windows/desktop/WinHttp/passport-authentication-in-winhttp) служба BITS поддерживает только явные учетные данные, а не неявные учетные данные, привязанные

Для проверки подлинности "запрос-ответ" служба BITS олицетворяет пользователя и использует [снего](../com/snego.md) для определения используемой проверки подлинности запроса/ответа, например NTLM или протокола Kerberos. Список схем "запрос/ответ", поддерживаемых BITS, см. в статье [**\_ \_ Схема проверки подлинности BG**](/windows/desktop/api/Bits1_5/ne-bits1_5-bg_auth_scheme).

Задания BITS могут завершиться ошибкой, если в виртуальном каталоге на сервере есть анонимная проверка подлинности, а другая схема проверки подлинности включена, а также для защиты виртуального каталога или загрузки файлов. Например, задание завершается с ошибкой "доступ запрещен", если в виртуальном каталоге включена анонимная и встроенная проверка подлинности, а файл содержит ACL, позволяющий только Бен чтение файла. Это происходит из-за того, что виртуальный каталог допускает анонимный доступ, поэтому IIS не выполняет явную проверку подлинности Бен (учетные данные Бен не используются для доступа к файлу и доступ запрещен).

## <a name="using-implicit-credentials"></a>Использование неявных учетных данных

Чтобы использовать неявные учетные данные пользователя (вход в систему) для проверки подлинности NTLM или Kerberos, вызовите метод [**IBackgroundCopyJob2:: сеткредентиалс**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) и задайте для членов **username** и **Password** в структуре [**\_ \_ учетных данных BG Basic**](/windows/desktop/api/Bits1_5/ns-bits1_5-bg_basic_credentials) **значение NULL**. При указании неявных учетных данных для прокси-сервера BITS также будет использовать неявные учетные данные для проверки подлинности сервера, если не указать явные учетные данные сервера

Дополнительные сведения о службах см. в статье [учетные записи служб и службы BITS](service-accounts-and-bits.md).

Можно также изменить значение реестра **LmCompatibilityLevel** или **уселмкомпат** . Однако эти значения следует изменять только в том случае, если имеется приложение, которое нельзя изменить для вызова метода [**сеткредентиалс**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) .

Службы BITS будут использовать неявные учетные данные для проверки подлинности, если значение реестра **LmCompatibilityLevel** равно двум или больше, и метод [**сеткредентиалс**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) не вызывался. Полный путь к параметру реестра **LmCompatibilityLevel** — **hKey \_ Local \_ Machine** \\ **System** \\ **CurrentControlSet** \\ **Control** \\ **LSA** \\ **LmCompatibilityLevel**.

Обратите внимание, что изменение значения реестра **LmCompatibilityLevel** может повлиять на другие приложения и службы, выполняющиеся на компьютере. Дополнительные сведения об использовании значения реестра **LmCompatibilityLevel** см. в разделе [KB147706](https://support.microsoft.com/kb/147706).

если при установке значения реестра **LMCompatibilityLevel** возникла ошибка, можно создать значение реестра **уселмкомпат** в разделе **HKEY \_ LOCAL \_ MACHINE** \\ **Software** \\ **Microsoft** \\ **Windows** \\ **CurrentVersion** \\ **BITS**. Значение реестра — DWORD. В следующей таблице перечислены возможные значения для **уселмкомпат**:

|Значение|Описание|
|-|-|
| 0     | Служба BITS будет отсылать неявные учетные данные каждый раз, когда сервер запрашивает учетные данные NTLM или Kerberos.                                                                                           |
| 1     | Служба BITS будет отсылать неявные учетные данные только в том случае, если значение реестра **LmCompatibilityLevel** клиентского компьютера больше или равно 2.<br/>     |
| 2     | Служба BITS будет отсылать неявные учетные данные только в том случае, если приложение вызвало метод [**сеткредентиалс**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) .<br/> |

Если значение реестра не существует, BITS будет использовать значение по умолчанию 2 для параметра реестра **уселмкомпат** .

## <a name="using-certificates-for-clientserver-authentication"></a>Использование сертификатов для проверки подлинности клиента и сервера

При обеспечении безопасности обмена данными между клиентом и сервером клиенты и серверы могут использовать цифровые сертификаты для взаимной проверки подлинности друг друга. BITS автоматически поддерживает проверку подлинности сервера на основе сертификатов для защищенных транспортов HTTP. Чтобы предоставить службе BITS сертификат клиента, необходимый для взаимной проверки подлинности, вызовите метод [**ибаккграундкопижобхттпоптионс:: сетклиентцертификатебид**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyid) или [**Ибаккграундкопижобхттпоптионс:: SetClientCertificateByName**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyname) .

Если веб-сайт принимает, но не требует сертификата клиента SSL, а в задании BITS не указан сертификат клиента, задание завершится ошибкой, и **\_ \_ \_ \_ \_ требуется сертификат проверки подлинности клиента WinHTTP** (0x80072f0c).

## <a name="how-to-handle-authenticated-proxy-scenarios-that-require-user-specific-settings"></a>Как работать с проверенными прокси-сценариями, требующими пользовательские параметры

При использовании BITS в среде, требующей проверки подлинности прокси-сервера при запуске в качестве учетной записи без использования учетных данных NTLM или Kerberos в сетевом домене компьютера, необходимо выполнить дополнительные действия для правильной проверки подлинности с помощью учетных данных другой учетной записи, которая имеет учетные данные в домене. Это типичный сценарий, когда код BITS выполняется как системная служба, например LocalService, NetworkService или LocalSystem, так как эти учетные записи не имеют пригодных для использования учетных данных NTLM или Kerberos.

Логика обнаружения прокси-сервера, используемая в службе BITS, выполняет следующие действия при установке маркера модуля поддержки сети ( \_ сети токенов BG \_ ):

-   Если [**использованием метода ibackgroundcopyjob:: SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) был вызван с помощью параметра **\_ \_ \_ \_ конфигурации использования прокси-сервера задания BG**, то для считывания параметров локального прокси-сервера IE используется олицетворение контекста владельца задания через [**винхттпжетиепроксиконфигфоркуррентусер**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser). начиная с Windows 10, версия 1809 (10,0; Сборка 17763), для этого шага используется удостоверение вспомогательного токена.
-   Если [**использованием метода ibackgroundcopyjob:: SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) был вызван с **\_ \_ \_ автоопределением использования прокси-сервера BG** или в параметрах IE из предварительной **\_ \_ \_ \_ конфигурации использования прокси-сервера задания BG** укажите URL-адрес автоматического обнаружения или автонастройки, выполните автоматическое обнаружение прокси-сервера или протокол автообнаружения веб-прокси с помощью [**WinHttpGetProxyForUrl**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetproxyforurl).

После этого для проверки подлинности прокси или сервера в течение всего времени используется олицетворение токена.

начиная с Windows 10, версия 1809 (10,0; Сборка 17763), прошедший проверку подлинности сценарий прокси-сервера с учетными данными пользователя упрощен.

1.  Вызовите метод [**сеткредентиалс**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) задания BITS с помощью **\_ схемы проверки подлинности BG \_ \_ Negotiate**, параметр *username* имеет значение **null**, *пароль* имеет **значение null,** а для параметра *Target* задано значение " **\_ \_ целевой \_ прокси-сервер BG auth**". Это приводит к тому, что неявные учетные данные учетной записи пользователя будут использоваться для проверки подлинности NTLM и Kerberos с прокси и сервером.
2.  Вызовите [**использованием метода ibackgroundcopyjob:: SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) с параметром **\_ \_ \_ \_ конфигурации использования прокси-сервера задания BG**.
3.  QueryInterface для [**ибитстокеноптионс**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).
4.  Олицетворение учетной записи пользователя, используемой для учетных данных NTLM/Kerberos.
5.  Вызовите [**сеселпертокен**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).
6. Вызовите [**сеселпертокенфлагс**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) с помощью **\_ токена BG \_ Network**.
7. Отменить олицетворение.
8. Продолжить настройку задания.
9. Вызовите [**возобновление**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) задания.

до Windows 10, версия 1809 (10,0; Сборка 17763). Правильная идентификация пользователя (удостоверение вспомогательного маркера) используется для обнаружения прокси-сервера на основе сети (WPAD) и проверки подлинности прокси, но фактическое обнаружение локальных параметров прокси-сервера (IE) всегда выполняется с помощью маркера владельца задания, даже если настроен вспомогательный токен. Чтобы обойти этот недостаток, можно выполнить следующие действия.

1.  Олицетворение учетной записи пользователя, используемой для учетных данных NTLM/Kerberos.
2.  Получите параметры прокси-сервера IE учетной записи пользователя, вызвав [**винхттпжетиепроксиконфигфоркуррентусер**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).
3.  Отменить олицетворение.
4.  Вызовите метод [**сеткредентиалс**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) задания BITS с помощью **\_ схемы проверки подлинности BG \_ \_ Negotiate**, параметр *username* имеет значение **null**, *пароль* имеет **значение null,** а для параметра *Target* задано значение " **\_ \_ целевой \_ прокси-сервер BG auth**". Это приводит к тому, что неявные учетные данные учетной записи пользователя будут использоваться для проверки подлинности NTLM и Kerberos с прокси и сервером.
5.  Если на шаге 2 были получены пользовательские параметры прокси-сервера (т. е. *лпсзпрокси* или *Лпсзпроксибипасс* не **равны NULL**), задайте соответствующие параметры задания вручную, используя [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) с параметром **\_ \_ \_ \_ переопределения использования прокси-сервера задания BG** .
6.  Если на шаге 2 не были получены какие-либо пользовательские параметры прокси-сервера, вызовите [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) с помощью предварительной **\_ \_ \_ настройки использования задания BG**.
7.  QueryInterface для [**ибитстокеноптионс**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).
8.  Снова олицетворять учетную запись пользователя.
9.  Вызовите [**сеселпертокен**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).
10. Вызовите [**сеселпертокенфлагс**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) с помощью **\_ токена BG \_ Network**.
11. Отменить олицетворение.
12. Продолжить настройку задания.
13. Вызовите [**возобновление**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) задания.
