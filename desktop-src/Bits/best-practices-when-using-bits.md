---
title: Рекомендации по использованию BITS
description: В этом разделе содержатся сведения, которые следует учитывать при проектировании приложения, использующего службу BITS.
ms.assetid: f4a09a80-2a85-4b59-b0fd-c23c128973f7
ms.topic: article
ms.date: 7/12/2019
ms.openlocfilehash: cbc11365cde74e092ae179c8b41562a16de9a6c36f0d85e51787a979c9332863
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119702094"
---
# <a name="best-practices-when-using-bits"></a>Рекомендации по использованию BITS

В этом разделе содержатся сведения, которые следует учитывать при проектировании приложения, использующего службу BITS.

## <a name="user-context-or-service-context"></a>Контекст пользователя или службы

Служба BITS передает файлы только в том случае, если владелец задания входит в систему на компьютере (пользователь должен войти в систему в интерактивном режиме). Служба BITS не поддерживает команду **runas** . Дополнительные сведения см. в разделе [Пользователи и сетевые подключения](users-and-network-connections.md).

Если для вашего приложения контекст пользователя не требуется, попробуйте вместо этого написать службу, работающую как LocalSystem, LocalService или NetworkService. Эти системные учетные записи всегда входят в систему, поэтому перенос не проходит пользователя. Однако если пользователь олицетворяет пользователя при создании задания, применяются правила интерактивного входа. Дополнительные сведения см. в статье [учетные записи служб и службы BITS](service-accounts-and-bits.md).

## <a name="jobs-are-persistent"></a>Задания являются постоянными

Задания остаются в очереди до тех пор, пока не будет вызван метод [**использованием метода ibackgroundcopyjob:: Complete**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-complete) или [**использованием метода ibackgroundcopyjob:: Cancel**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-cancel) . Файлы в задании недоступны пользователю до тех пор, пока не будет выполнен вызов функции **Complete**. Как правило, вызов **завершается** , когда состояние задания **\_ \_ \_ передается в состояние задания BG** и вызывается **Cancel** , когда задание находится в состоянии **\_ задания BG \_ \_ Промежуточная \_ Ошибка** или **состояние \_ задания \_ \_ BG** и больше не может быть выполнено.

Если не вызвать метод [**Complete**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-complete) или метод [**Cancel**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-cancel) в течение 90 дней (по умолчанию групповая политика [жобинактивититимеаут](group-policies.md) ), служба отменяет задание. Следует всегда вызывать метод **Complete** или **Cancel** и не полагаться на политику жобинактивититимеаут для очистки заданий. Задания, оставшиеся в очереди, могут помешать пользователям создавать другие задания при достижении предела политики Maxjobspermachine или MaxJobsPerMachine.

## <a name="when-to-use-foreground-or-background-priority"></a>Когда следует использовать приоритет переднего плана или фона

Если время выполнения задания не является критическим или пользователь находится в активном состоянии, следует всегда использовать приоритет фона. Однако бывают случаи, когда вам может потребоваться переключиться от приоритета фона к приоритету переднего плана, например, когда прокси или сервер не поддерживает заголовок Content-Range, или антивирусная программа на клиенте удаляет запрос заголовка диапазона. Переключение на приоритет переднего плана работает только для тех файлов, размер файла которых меньше 2 ГБ. Пример см. в описании реализации метода [**ибаккграундкопикаллбакк:: жоберрор**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopycallback) . Также обратите внимание, что если задание переднего плана прерывается из-за отключения сети или входа пользователя в систему, задание завершится ошибкой, так как служба BITS отправит запрос к диапазону, чтобы попытаться перезапустить передачу с места остановки.

начиная с Windows 8, необходимо настроить загрузку заданий с помощью **\_ \_ \_ динамического \_ содержимого** и **\_ \_ приоритета заданий \_ BG** , если целевые серверы не соответствуют [требованиям HTTP для загрузки BITS](http-requirements-for-bits-downloads.md). Имейте в виду, что это приведет к тому, что служба BITS перезапускает загрузку с начала, если она будет прервана (например, из-за проблем с подключением или перезагрузки системы).

Сведения о доступных приоритетах и о том, как служба BITS использует уровень приоритета для планирования заданий, см. в разделе " [**\_ \_ приоритет задания BG**](/windows/desktop/api/Bits/ne-bits-bg_job_priority)".

## <a name="transient-and-fatal-errors"></a>Временные и неустранимые ошибки

Некоторые ошибки могут быть восстановлены, а некоторые — нет. Например, ошибка «сервер недоступна» является восстанавливаемой ошибкой, а ошибка «отказано в доступе» является неустранимой ошибкой. BITS помещает устранимые ошибки в состояние временной ошибки и повторяет задание через указанный интервал. Если задание не может выполнить ход выполнения, служба BITS переместит задание в состояние неустранимой ошибки. Используйте методы [**использованием метода ibackgroundcopyjob:: сетминимумретриделай**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setminimumretrydelay) и [**использованием метода ibackgroundcopyjob:: сетнопрогресстимеаут**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setnoprogresstimeout) для управления тем, как служба BITS обрабатывает временные ошибки.

Для заданий переднего плана необходимо ограничить время, в течение которого задание остается в состоянии временной ошибки, и попытаться выполнить восстановление. Используйте метод [**сетнопрогресстимеаут**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setnoprogresstimeout) , чтобы ограничить период времени, в течение которого задание остается в состоянии временной ошибки, или принудительно перевести задание в состояние неустранимой ошибки. Если вы разрешите выполнить восстановление, используйте метод [**сетминимумретриделай**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setminimumretrydelay) , чтобы установить минимальную задержку повторных попыток в 60 секунд или вызвать метод [**использованием метода ibackgroundcopyjob:: Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) для повторной активации задания.

Дополнительные сведения см. в [**разделе \_ \_ состояние задания BG**](/windows/desktop/api/Bits/ne-bits-bg_job_state), [жизненный цикл задания BITS](life-cycle-of-a-bits-job.md)и [Обработка ошибок](handling-errors.md).

## <a name="measuring-network-bandwidth-usage"></a>Измерение использования пропускной способности сети

BITS может использовать сетевой адаптер клиента для оценки доступной пропускной способности сети. Поскольку службы BITS не могут измерять пропускную способность за пределами клиента, BITS может перегрузить канал WAN. Чтобы снизить нагрузку на канал WAN, можно использовать групповую политику **максинтернетбандвидс** для ограничения объема пропускной способности, используемой клиентом. Дополнительные сведения см. в статье [пропускная способность сети](network-bandwidth.md) и [групповые политики](group-policies.md).

При написании приложения, которое многие клиенты будут использовать для загрузки файлов с определенного сервера, следует рассмотреть схему, в которой загружаются запросы на загрузку, чтобы не перегружать сервер с запросами.

## <a name="setting-credentials-for-proxy-and-server-authentication"></a>Настройка учетных данных для проверки подлинности прокси и сервера

Если предполагается, что прокси или сервер должны требовать учетные данные пользователя, необходимо предоставить учетные данные службе BITS. Чтобы указать учетные данные, вызовите метод [**IBackgroundCopyJob2:: сеткредентиалс**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) . Служба BITS поддерживает схемы проверки подлинности Basic, Digest, Negotiate, NTLM и Passport.

Дополнительные сведения о проверке подлинности см. в разделе [Проверка подлинности](authentication.md).

## <a name="specifying-proxy-settings-for-user-accounts-and-service-accounts"></a>Указание параметров прокси-сервера для учетных записей пользователей и служб

По умолчанию служба BITS использует параметры прокси-сервера Internet Explorer пользователя. Чтобы переопределить параметры прокси-сервера Internet Explorer пользователя, вызовите метод [**использованием метода ibackgroundcopyjob:: SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) .

Параметры прокси-сервера Internet Explorer не применяются к системным учетным записям, поэтому поведение прокси-сервера по умолчанию (Предварительная **\_ \_ \_ \_ Настройка использования прокси-сервера заданий BG**) будет работать правильно только в развертываниях протокола WPAD, если не выполняются дополнительные действия по настройке. Если приложение является службой, работающей как LocalSystem, LocalService или NetworkService, рассмотрите возможность настройки вспомогательного токена для заданий BITS или явное задание правильных параметров прокси-сервера путем вызова метода [**использованием метода ibackgroundcopyjob:: SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) с **\_ \_ \_ \_ переопределением использования прокси-сервера задания BG**. В качестве альтернативы можно использовать параметры **/утил/сетиепрокси** из BitsAdmin.exe, чтобы задать параметры прокси-сервера Internet Explorer для системной учетной записи LocalSystem, LocalService или NetworkService. Дополнительные сведения см. в разделе [средство битсадмин](bitsadmin-tool.md).

Служба BITS не распознает параметры прокси-сервера, заданные с помощью файла Proxycfg.exe.

начиная с обновление Windows 10 за октябрь 2018 г. (10,0; Сборка 17763), BITS использует тот же порядок прокси-сервера, который используется WinHttp с AUTOMATIC_PROXY. При указании BG_JOB_PROXY_USAGE_PRECONFIG BITS использует более совместимый порядок. BG_JOB_PROXY_USAGE_PRECONFIG является значением по умолчанию для указания прокси-сервера HTTP.

## <a name="specifying-user-specific-settings-for-authenticating-proxies"></a>Указание параметров пользователя для проверки подлинности прокси-серверов

При использовании BITS в среде, требующей проверки подлинности прокси-сервера при запуске в качестве учетной записи без использования учетных данных NTLM или Kerberos в сетевом домене компьютера, необходимо выполнить дополнительные действия для правильной проверки подлинности с помощью учетных данных другой учетной записи, которая имеет учетные данные в домене. Это типичный сценарий, когда код BITS выполняется как системная служба, например LocalService, NetworkService или LocalSystem, так как эти учетные записи не имеют пригодных для использования учетных данных NTLM или Kerberos.

Дополнительные сведения о том, как работает проверка подлинности в этом сценарии, см. в разделе [authentication.](authentication.md)

## <a name="scalability"></a>Масштабируемость

Если в очереди находится более 100 заданий, производительность может быть снижена в зависимости от композиции задания. Служба BITS использует параметр политики [MaxJobsPerMachine](group-policies.md) для принудительного ограничения числа заданий в очереди. Приложения должны ограничивать количество их заданий приблизительно в 10 раз, чтобы несколько приложений не превышали указания по 100-Job. Как правило, приложение с большим количеством выполняемых заданий сначала отправляет 10 заданий, а затем отправляет их по мере завершения каждого задания.

Число файлов в задании также должно быть ограничено максимум 10 файлами. Если вы хотите переместить большое количество файлов для задания, рассмотрите возможность создания CAB-файла, содержащего все файлы.

## <a name="http-headers-can-be-in-any-case"></a>Заголовки HTTP могут быть в любом случае

Стандарты HTTP всегда говорят, что заголовки HTTP должны обрабатываться без учета регистра (раздел 3,2 7230). Самый последний стандарт HTTP, RFC 7540, указывает на то, что трафик HTTP/2 должен сравнивать заголовки без учета регистра и должен представлять заголовки в нижнем регистре (RFC 6540, раздел BIND 8.1.2). Даже если трафик отправляется с заголовками, отличными от нижнего регистра, прокси-серверы могут выбрать принудительное выполнение заголовков в нижнем регистре.

## <a name="avoiding-personally-identifiable-information-pii"></a>Предотвращение личных сведений (PII)

Задания BITS, включая отображаемое имя задания, описание и имена файлов, видимы всем пользователям с правами администратора. их также можно добавить в Windows телеметрии. Не следует размещать конфиденциальные данные (например, собственное имя пользователя) в сведениях о задании.
