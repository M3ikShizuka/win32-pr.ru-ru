---
title: In-Context меры предосторожности для функций-ловушек
description: По соображениям производительности разработчики клиента регистрируют функции-обработчики в контексте.
ms.assetid: 14b48920-a291-4519-b005-e559263a0e83
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8c0e319037cb1295725548b3361bf076b4b1f760
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "105710321"
---
# <a name="in-context-hook-function-precautions"></a>In-Context меры предосторожности для функций-ловушек

По соображениям производительности разработчики клиента регистрируют функции-обработчики в контексте. Однако поскольку эти функции-ловушки сопоставляются с адресным пространством сервера, разработчики клиентов и серверов должны предпринять меры предосторожности, чтобы обеспечить плавность обработки событий.

## <a name="precautions-for-client-developers"></a>Меры предосторожности для разработчиков клиентов

Разработчикам клиентов следует помнить о следующих проблемах:

-   Функции-обработчики в контексте не должны использовать много процессорного времени, так как функция-обработчик должна возвращаться до того, как серверное приложение будет продолжать работу.
-   После активации события возможно, что окно, связанное с событием, больше не существует на момент вызова функции-обработчика. Клиенты должны убедиться, что окно, связанное с событием, существует, прежде чем предпринимать любые другие действия, связанные с событием. Чтобы убедиться, что окно по-прежнему существует, клиенты [**используют функцию Microsoft**](/windows/desktop/api/winuser/nf-winuser-iswindow) Win32.
-   Если библиотека DLL, в которой определена функция-обработчик, ссылается на другую библиотеку DLL, разработчики должны убедиться, что система загружает другую библиотеку DLL. При неявной компоновке (с помощью DEF-файлов и импортов) Дополнительная библиотека DLL должна находиться либо в каталоге Windows, либо в одном из системных каталогов, таких как Windows \\ System, Windows \\ System32 или Windows \\ SysWOW64. При явной компоновке (с помощью [**LoadLibrary**](/windows/desktop/api/libloaderapi/nf-libloaderapi-loadlibrarya)) полный путь к каталогу, в котором находится дополнительная библиотека DLL, должен быть указан в вызове **LoadLibrary**.
-   Функции-обработчики в контексте могут вызвать переполнение стека при загрузке библиотеки DLL, содержащей функцию-ловушку, в 16-разрядное приложение. Эта проблема возникает потому, что 16-разрядные приложения используют фиксированный размер стека, который недостаточно велик для размещения цепочки вызовов системных функций, вызывающих вызов функции-обработчика.

## <a name="precautions-for-server-developers"></a>Меры предосторожности для разработчиков серверов

Разработчикам сервера необходимо знать, что клиентские приложения могут регистрировать функции-обработчики в контексте. Когда сервер вызывает [**нотифивиневент**](/windows/desktop/api/Winuser/nf-winuser-notifywinevent), он должен быть готов к обработке функций [**WM \_ GetObject**](wm-getobject.md) и других методов [**IAccessible**](/windows/desktop/api/oleacc/nn-oleacc-iaccessible) .

## <a name="invalid-interface-pointers"></a>Недопустимые указатели интерфейса

Когда клиент вызывает [**акцессиблеобжектфромевент**](/windows/desktop/api/Oleacc/nf-oleacc-accessibleobjectfromevent) в функции-обработчике в контексте, возвращаемый указатель интерфейса [**IAccessible**](/windows/desktop/api/oleacc/nn-oleacc-iaccessible) указывает непосредственно на код в адресном пространстве сервера. Если клиент вызывает свойство интерфейса с помощью этого указателя, то библиотека COM не участвует в упаковке (упаковка и отправка параметров интерфейса через границы процесса) или при распаковке (распаковке параметров, которые были отправлены через границы процесса) и не обнаруживают, уничтожается ли объект.

Если клиент вызывает свойство интерфейса для объекта, который уничтожается, недопустимый указатель интерфейса вызывает общую ошибку защиты в адресном пространстве сервера, пока сервер не обнаружит такую ситуацию.

Для защиты от недопустимых указателей интерфейса серверы [создают прокси-объекты](creating-proxy-objects.md) , которые заносят доступные объекты и отслеживают жизненный цикл доступных объектов. Например, когда клиент вызывает свойство [**IAccessible**](/windows/desktop/api/oleacc/nn-oleacc-iaccessible) для получения сведений об объекте, прокси-сервер проверяет, доступен ли доступный объект, и, если да, перенаправляет клиентский запрос в доступный объект. При удалении доступного объекта прокси-сервер возвращает клиенту ошибку.

 

 