---
title: Основные сведения о проблемах с потоками
description: В этом разделе описываются распространенные сценарии работы с потоками для реализации клиентов автоматизации пользовательского интерфейса Майкрософт и объясняется, как избежать проблем, которые могут возникать в случае неправильного использования потоков клиентом.
ms.assetid: 0772969a-da55-488e-8b21-7368434df8a9
keywords:
- Клиенты, проблемы с потоками модели автоматизации пользовательского интерфейса
- Клиенты, проблемы с потоками
- Клиенты, потоковая модель обработчика событий
- Клиенты, потоковая модель обработчика событий модели автоматизации пользовательского интерфейса
- Клиенты, сходство модели автоматизации пользовательского интерфейса
- Клиенты, сходство
- Автоматизация пользовательского интерфейса, проблемы с потоками
- Автоматизация пользовательского интерфейса, потоковая модель обработчика событий
- Модель автоматизации пользовательского интерфейса, сходство
- вопросы, связанные с потоками
- Потоковая модель обработчика событий
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a002132efe4055bb247c7d7290e271e153ac297e
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "104070057"
---
# <a name="understanding-threading-issues"></a>Основные сведения о проблемах с потоками

В этом разделе описываются распространенные сценарии работы с потоками для реализации клиентов автоматизации пользовательского интерфейса Майкрософт и объясняется, как избежать проблем, которые могут возникать в случае неправильного использования потоков клиентом.

В этом разделе содержатся следующие подразделы.

-   [Модель автоматизации пользовательского интерфейса и поток пользовательского интерфейса](#ui-automation-and-the-ui-thread)
-   [Потоковая модель для обработчиков событий](#threading-model-for-event-handlers)
-   [Сходство апартамента COM в 64-разрядной версии Windows](#com-apartment-affinity-on-64-bit-windows)
-   [См. также](#related-topics)

## <a name="ui-automation-and-the-ui-thread"></a>Модель автоматизации пользовательского интерфейса и поток пользовательского интерфейса

В связи с тем, что модель автоматизации пользовательского интерфейса использует сообщения Windows, конфликты могут возникать, когда клиентское приложение пытается взаимодействовать с собственным ИНТЕРФЕЙСом в потоке пользовательского интерфейса. Эти конфликты могут привести к очень низкому снижению производительности или даже вызвать зависание приложения.

Если клиентское приложение предназначено для взаимодействия со всеми элементами на рабочем столе, включая собственный пользовательский интерфейс, все вызовы автоматизации пользовательского интерфейса следует выполнять из отдельного потока. Это включает в себя поиск элементов, например с помощью [**иуиаутоматионтривалкер**](/windows/desktop/api/UIAutomationClient/nn-uiautomationclient-iuiautomationtreewalker) или метода [**Иуиаутоматионелемент:: FindAll**](/windows/desktop/api/UIAutomationClient/nf-uiautomationclient-iuiautomationelement-findall) и использование шаблонов элементов управления. Этот поток не должен владеть ни одним из окон, а должен быть потоком модели многопотокового апартамента (MTA) модели COM (в котором инициализируется COM путем вызова [CoInitializeEx](/windows/win32/api/combaseapi/nf-combaseapi-coinitializeex) с флагом " **\_ многопотоковый** ".)

Вызовы автоматизации пользовательского интерфейса можно использовать в обработчике событий автоматизации пользовательского интерфейса, так как обработчик событий всегда вызывается в потоке, не являющемся интерфейсом пользователя. Однако при подписке на события, которые могут поступать из пользовательского интерфейса клиентского приложения, необходимо выполнить вызов [**иуиаутоматион:: аддаутоматионевенсандлер**](/windows/desktop/api/UIAutomationClient/nf-uiautomationclient-iuiautomation-addautomationeventhandler)или связанного метода в потоке, отличном от пользовательского интерфейса (который также должен быть потоком MTA). Удалите обработчики событий в том же потоке.

Клиент автоматизации пользовательского интерфейса не должен использовать несколько потоков для добавления или удаления обработчиков событий. Непредвиденное поведение может возникнуть, если один или несколько обработчиков событий добавляются или удаляются в рамках одного и того же клиентского процесса.

## <a name="threading-model-for-event-handlers"></a>Потоковая модель для обработчиков событий

Клиент автоматизации пользовательского интерфейса должен использовать модель потоков COM MTA для потоков, реализующих обработчики событий. Использование модели однопотокового подразделения (STA) может вызвать такие проблемы, как предотвращение удаления клиентами обработчиков событий из потока.

## <a name="com-apartment-affinity-on-64-bit-windows"></a>Сходство апартамента COM в 64-разрядной версии Windows

В соответствии со спецификацией COM время существования удаленного объекта регулируется временем существования апартамента, в котором вызывается функция [CoCreateInstance](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) для создания объекта. Когда исходный апартамент завершает работу, удаленный объект также освобождается.

Для клиентов автоматизации пользовательского интерфейса это поведение COM может означать, что время существования удаленного вспомогательного метода 32/64 (созданного UIAutomationCore.dll), используемого 32-битным элементом, регулируется временем существования апартамента потока, создавшего элемент. Если клиент автоматизации пользовательского интерфейса маршалирует элемент в другой поток, элемент может стать недействительным при завершении работы исходного апартамента. Клиент автоматизации пользовательского интерфейса должен надлежащим образом обработать эти проблемы за счет перехвата ошибок при использовании упакованных элементов автоматизации.

Эта же ошибка может возникнуть в 32-разрядном клиенте автоматизации пользовательского интерфейса с 64-разрядными элементами.

## <a name="related-topics"></a>См. также

<dl> <dt>

**Зрения**
</dt> <dt>

[Получение элементов автоматизации пользовательского интерфейса](uiauto-obtainingelements.md)
</dt> <dt>

[Подписка на события модели автоматизации пользовательского интерфейса](uiauto-eventsforclients.md)
</dt> <dt>

[Обзор событий автоматизации пользовательского интерфейса](uiauto-eventsoverview.md)
</dt> <dt>

**Другие ресурсы**
</dt> <dt>

[СВЕДЕНИЯ: описания и работа моделей потоков OLE](https://support.microsoft.com/kb/150777)
</dt> </dl>

 

 