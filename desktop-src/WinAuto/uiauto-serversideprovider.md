---
title: Реализация поставщика автоматизации пользовательского интерфейса Server-Side
description: В этом разделе описывается реализация поставщика Microsoft UI Automation на стороне сервера для пользовательского элемента управления, написанного на языке C++.
ms.assetid: c3a919b2-8b8c-4dde-ad71-587f3845a9f5
keywords:
- Модель автоматизации пользовательского интерфейса, реализация поставщика на стороне сервера
- Автоматизация пользовательского интерфейса, реализация поставщика
- Модель автоматизации пользовательского интерфейса, реализация поставщиков на стороне сервера
- Модель автоматизации пользовательского интерфейса, реализация поставщиков
- поставщики на стороне сервера, реализация
- поставщики на стороне сервера, интерфейсы
- поставщики на стороне сервера, значения свойств
- поставщики на стороне сервера, события
- поставщики на стороне сервера, назначение нового родителя
- события, поставщики на стороне сервера
- интерфейсы, поставщики на стороне сервера
- поставщики, реализация
- Реализация поставщиков на стороне сервера
- реализация поставщиков
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e7fafbb9d03a25eb2e4713330c0622c25d17f9ff
ms.sourcegitcommit: d75fc10b9f0825bbe5ce5045c90d4045e3c53243
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2021
ms.locfileid: "127172675"
---
# <a name="implement-a-server-side-ui-automation-provider"></a>Реализация поставщика автоматизации пользовательского интерфейса Server-Side

В этом разделе описывается реализация поставщика Microsoft UI Automation на стороне сервера для пользовательского элемента управления, написанного на языке C++. Он содержит следующие подразделы:

-   [Интерфейсы поставщика](#provider-interfaces)
-   [Требуемая функциональность для поставщиков автоматизации пользовательского интерфейса](#required-functionality-for-ui-automation-providers)
-   [Значения свойств](#property-values)
-   [События от поставщиков](#events-from-providers)
-   [Навигация поставщика](#provider-navigation)
-   [Назначение нового родителя](#assigning-a-new-parent)
-   [Изменение расположения поставщика](#provider-repositioning)
-   [Отключение поставщиков](#disconnecting-providers)
-   [Связанные темы](#related-topics)

Примеры кода, демонстрирующие способы реализации поставщиков на стороне сервера, см. [в разделах с инструкциями по поставщикам автоматизации пользовательского интерфейса](uiauto-howto-topics-for-uiautomation-providers.md).

## <a name="provider-interfaces"></a>Интерфейсы поставщика

Следующие интерфейсы объектной модели (COM) предоставляют функциональные возможности для пользовательских элементов управления. Для обеспечения базовой функциональности каждый поставщик автоматизации пользовательского интерфейса должен реализовывать по крайней мере интерфейс [**иравелементпровидерсимпле**](/windows/desktop/api/UIAutomationCore/nn-uiautomationcore-irawelementprovidersimple) . Интерфейсы [**иравелементпровидерфрагмент**](/windows/desktop/api/UIAutomationCore/nn-uiautomationcore-irawelementproviderfragment) и [**иравелементпровидерфрагментрут**](/windows/desktop/api/UIAutomationCore/nn-uiautomationcore-irawelementproviderfragmentroot) являются необязательными, но должны быть реализованы для элементов сложного элемента управления, чтобы обеспечить дополнительные функциональные возможности.



| Интерфейс                                                                         | Описание                                                                                                                                                                   |
|-----------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [**иравелементпровидерсимпле**](/windows/desktop/api/UIAutomationCore/nn-uiautomationcore-irawelementprovidersimple)             | Предоставляет базовые функциональные возможности для элемента управления, размещенного в окне, включая поддержку шаблонов элементов управления и свойств.                                                         |
| [**иравелементпровидерфрагмент**](/windows/desktop/api/UIAutomationCore/nn-uiautomationcore-irawelementproviderfragment)         | Добавляет функциональные возможности для элемента в сложном элементе управления, включая навигацию в фрагменте, установку фокуса и возврат ограничивающего прямоугольника элемента.             |
| [**иравелементпровидерфрагментрут**](/windows/desktop/api/UIAutomationCore/nn-uiautomationcore-irawelementproviderfragmentroot) | Добавляет функциональные возможности для корневого элемента в сложном элементе управления, включая поиск дочернего элемента по указанным координатам и установку состояния фокуса для всего элемента управления. |



 

> [!Note]  
> В интерфейсе API модели автоматизации пользовательского интерфейса для управляемого кода эти интерфейсы формируют иерархию наследования. Это не так в C++, где интерфейсы полностью отделены.

 

Следующие интерфейсы предоставляют дополнительные функциональные возможности, но реализация является необязательной.



| Интерфейс                                                                         | Описание                                                                             |
|-----------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------|
| [**иравелементпровидерадвисивентс**](/windows/desktop/api/UIAutomationCore/nn-uiautomationcore-irawelementprovideradviseevents) | Позволяет поставщику отслеживать запросы событий.                                      |
| [**иравелементпровидерхвндоверриде**](/windows/desktop/api/UIAutomationCore/nn-uiautomationcore-irawelementproviderhwndoverride) | Включает изменение расположения элементов на основе окна в дереве автоматизации пользовательского интерфейса фрагмента. |



 

## <a name="required-functionality-for-ui-automation-providers"></a>Требуемая функциональность для поставщиков автоматизации пользовательского интерфейса

Для взаимодействия с автоматизацией пользовательского интерфейса элемент управления должен реализовать основные области функциональности, описанные в следующей таблице.



| Функциональность                                              | Реализация                                                                                                                                                                                                                                                                                                |
|------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Предоставьте поставщику модель автоматизации пользовательского интерфейса.                      | В ответ на сообщение [**WM \_ GetObject**](wm-getobject.md) , отправленное в окно управления, возвращается объект, реализующий [**иравелементпровидерсимпле**](/windows/desktop/api/UIAutomationCore/nn-uiautomationcore-irawelementprovidersimple). Для фрагментов это должен быть поставщик для корневого фрагмента.                                           |
| Укажите значения свойств.                                   | Реализуйте [**иравелементпровидерсимпле:: жетпропертивалуе**](/windows/desktop/api/UIAutomationCore/nf-uiautomationcore-irawelementprovidersimple-getpropertyvalue) для предоставления или переопределения значений.                                                                                                                                                             |
| Разрешить клиенту взаимодействовать с элементом управления.            | Реализуйте интерфейсы, поддерживающие каждый подходящий шаблон элемента управления, например [**IInvokeProvider**](/windows/desktop/api/UIAutomationCore/nn-uiautomationcore-iinvokeprovider). Возвращайте эти поставщики шаблонов элементов управления в реализации [**иравелементпровидерсимпле:: жетпаттернпровидер**](/windows/desktop/api/UIAutomationCore/nf-uiautomationcore-irawelementprovidersimple-getpatternprovider). |
| Инициируйте события.                                              | [**Уиараисеаутоматионевент**](/windows/desktop/api/UIAutomationCoreApi/nf-uiautomationcoreapi-uiaraiseautomationevent), методы [**ипроксипровидервиневентсинк**](/windows/desktop/api/UIAutomationCore/nn-uiautomationcore-iproxyproviderwineventsink).                                                                                                                                                |
| Включение навигации и фокусировки в фрагменте.              | Реализуйте [**иравелементпровидерфрагмент**](/windows/desktop/api/UIAutomationCore/nn-uiautomationcore-irawelementproviderfragment) для каждого элемента внутри фрагмента. Не требуется для элементов, которые не являются частью фрагмента.                                                                                                                         |
| Включение фокусировки и поиск дочерних элементов в фрагменте. | Реализуйте [**иравелементпровидерфрагментрут**](/windows/desktop/api/UIAutomationCore/nn-uiautomationcore-irawelementproviderfragmentroot). Не требуется для элементов, которые не являются корнями фрагментов.                                                                                                                                                          |



 

## <a name="property-values"></a>Значения свойств

Поставщики автоматизации пользовательского интерфейса для пользовательских элементов управления должны поддерживать определенные свойства, которые могут использоваться автоматизацией пользовательского интерфейса и клиентскими приложениями. Для элементов, размещенных в Windows, модель автоматизации пользовательского интерфейса может извлекать некоторые свойства из поставщика окна по умолчанию, но должна получить других из настраиваемого поставщика.

Как правило, поставщики для элементов управления на основе окон не обязательно должны предоставлять следующие свойства, идентифицируемые **PROPERTYID**:

-   [**UIA \_ баундингректанглепропертид**](uiauto-automation-element-propids.md)
-   [**UIA \_ кликкаблепоинтпропертид**](uiauto-automation-element-propids.md)
-   [**UIA \_ процессидпропертид**](uiauto-automation-element-propids.md)
-   [**UIA \_ класснамепропертид**](uiauto-automation-element-propids.md)
-   [**UIA \_ хаскэйбоардфокуспропертид**](uiauto-automation-element-propids.md)
-   [**UIA \_ исенабледпропертид**](uiauto-automation-element-propids.md)
-   [**UIA \_ искэйбоардфокусаблепропертид**](uiauto-automation-element-propids.md)
-   [**UIA \_ испассвордпропертид**](uiauto-automation-element-propids.md)
-   [**UIA \_ намепропертид**](uiauto-automation-element-propids.md)
-   [**UIA \_ рунтимеидпропертид**](uiauto-automation-element-propids.md)

Свойство Рунтимеид простого элемента или корня фрагмента, размещенного в окне, получается из окна. Однако элементы фрагментов, расположенные под корнем, например элементы списка в списке, должны предоставлять собственные идентификаторы. Дополнительные сведения см. в разделе [**иравелементпровидерфрагмент:: жетрунтимеид**](/windows/desktop/api/UIAutomationCore/nf-uiautomationcore-irawelementproviderfragment-getruntimeid).

свойство искэйбоардфокусабле должно возвращаться для поставщиков, размещенных в элементе управления Windows Forms. В этом случае поставщику окна по умолчанию может не удастся получить правильное значение.

Свойство Name обычно предоставляется поставщиком узла.

## <a name="events-from-providers"></a>События от поставщиков

Поставщики автоматизации пользовательского интерфейса должны создавать события для уведомления клиентских приложений об изменениях в состоянии пользовательского интерфейса. Для вызова событий используются следующие функции.



| Функция                                                                                   | Описание                                                                                                              |
|--------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| [**уиараисеаутоматионевент**](/windows/desktop/api/UIAutomationCoreApi/nf-uiautomationcoreapi-uiaraiseautomationevent)                  | Создает различные события, включая события, вызываемые шаблонами элементов управления.                                                   |
| [**уиараисеаутоматионпропертичанжедевент**](/windows/desktop/api/UIAutomationCoreApi/nf-uiautomationcoreapi-uiaraiseautomationpropertychangedevent) | Вызывает событие при изменении свойства модели автоматизации пользовательского интерфейса.                                                               |
| [**уиараисеструктуречанжедевент**](/windows/desktop/api/UIAutomationCoreApi/nf-uiautomationcoreapi-uiaraisestructurechangedevent)      | Вызывает событие при изменении структуры дерева автоматизации пользовательского интерфейса, например путем удаления или добавления элемента. |



 

Назначение события — уведомление клиента о том, что происходит в пользовательском интерфейсе. Поставщики должны создавать события независимо от того, активировалось ли это изменение с помощью пользовательского ввода или клиентского приложения, использующего автоматизацию пользовательского интерфейса. Например, событие, идентифицированное с помощью [**UIA \_ Invoke \_ инвокедевентид**](uiauto-event-ids.md) , должно вызываться всякий раз, когда вызывается элемент управления, либо путем прямого ввода данных пользователем, либо клиентским приложением, вызывающим метод [**иуиаутоматионинвокепаттерн:: Invoke**](/windows/desktop/api/UIAutomationClient/nf-uiautomationclient-iuiautomationinvokepattern-invoke).

Для оптимизации производительности поставщик можно выборочно вызывать события или вообще не создавать события, если отсутствует клиентское приложение, зарегистрированное для их получения. Для оптимизации используются следующие элементы API.



| API, элемент                                                                       | Описание                                                                                                                                                       |
|-----------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [**уиаклиентсарелистенинг**](/windows/desktop/api/UIAutomationCoreApi/nf-uiautomationcoreapi-uiaclientsarelistening)           | Эта функция проверяет, подписаны ли какие либо клиентские приложения на события модели автоматизации пользовательского интерфейса.                                                                 |
| [**иравелементпровидерадвисивентс**](/windows/desktop/api/UIAutomationCore/nn-uiautomationcore-irawelementprovideradviseevents) | Реализация этого интерфейса в корне фрагмента позволяет поставщику получать рекомендации, когда клиенты регистрируют и отменяют регистрацию обработчиков событий в фрагменте. |



 

> [!Note]  
> Подобно реализации подсчета ссылок в программировании COM, поставщики автоматизации пользовательского интерфейса должны обрабатывать методы [**иравелементпровидерадвисивентс:: адвисивентаддед**](/windows/desktop/api/UIAutomationCore/nf-uiautomationcore-irawelementprovideradviseevents-adviseeventadded) и [**адвисивентремовед**](/windows/desktop/api/UIAutomationCore/nf-uiautomationcore-irawelementprovideradviseevents-adviseeventremoved) , такие как [**IUnknown:: AddRef**](/windows/desktop/api/unknwn/nf-unknwn-iunknown-addref) и [**Release**](/windows/desktop/api/unknwn/nf-unknwn-iunknown-release) в интерфейсе [**IUnknown**](/windows/desktop/api/unknwn/nn-unknwn-iunknown) . Пока **адвисивентаддед** вызывал больше времени, чем **адвисивентремовед** для определенного события или свойства, поставщик должен по-прежнему вызывать соответствующие события, так как некоторые клиенты все еще ожидают прослушивание. Кроме того, поставщики автоматизации пользовательского интерфейса могут использовать функцию [**уиаклиентсарелистенинг**](/windows/desktop/api/UIAutomationCoreApi/nf-uiautomationcoreapi-uiaclientsarelistening) , чтобы определить, прослушивается ли хотя бы один клиент, и, если это так, вызвать все соответствующие события.

 

## <a name="provider-navigation"></a>Навигация поставщика

Поставщики простых элементов управления, таких как пользовательская кнопка, размещенная в окне, не нуждаются в поддержке навигации в дереве модели автоматизации пользовательского интерфейса. Переход к элементу и из него обрабатывается поставщиком по умолчанию для главного окна, которое указывается в реализации [**иравелементпровидерсимпле:: хостравелементпровидер**](/windows/desktop/api/UIAutomationCore/nf-uiautomationcore-irawelementprovidersimple-get_hostrawelementprovider). Однако при реализации поставщика сложного пользовательского элемента управления необходимо поддерживать навигацию между корневым узлом фрагмента и его потомками, а также между одноуровневыми узлами.

> [!Note]  
> Элементы фрагмента, отличные от корневого, должны возвращать **значение NULL** из [**хостравелементпровидер**](/windows/desktop/api/UIAutomationCore/nf-uiautomationcore-irawelementprovidersimple-get_hostrawelementprovider), поскольку они не размещаются непосредственно в окне, а поставщик по умолчанию не может поддерживать навигацию по ним.

 

Структура фрагмента определяется реализацией [**иравелементпровидерфрагмент:: Navigate**](/windows/desktop/api/UIAutomationCore/nf-uiautomationcore-irawelementproviderfragment-navigate). Для каждого возможного направления из каждого фрагмента этот метод возвращает объект поставщика для элемента в указанном направлении. Если в этом направлении нет элемента, метод возвращает **значение NULL**.

Корневой элемент фрагмента поддерживает переход только к дочерним элементам. Например, список возвращает первый элемент в списке, если направлением является **навигатедиректион \_ FirstChild**, и возвращает последний элемент, когда направление — **навигатедиректион \_ LastChild**. Корневой элемент фрагмента не поддерживает переходы к родителю или к родственным элементам; это обрабатывается поставщиком главного окна.

Элементы фрагмента, отличные от корневого, должны поддерживать переходы к родительскому элементу, а также любым одноуровневым и дочерним элементам.

## <a name="assigning-a-new-parent"></a>Назначение нового родителя

Всплывающие окна являются окнами верхнего уровня, и по умолчанию они отображаются в дереве модели автоматизации пользовательского интерфейса как дочерние элементы рабочего стола. Однако во многих случаях всплывающие окна логически являются потомками других элементов управления. Например, раскрывающийся список поля со списком логически является дочерним элементом поля со списком. Аналогичным образом всплывающее окно меню логически является дочерним элементом меню. Модель автоматизации пользовательского интерфейса позволяет назначить новый родительский элемент для всплывающего окна, чтобы он являлся дочерним по отношению к связанному элементу управления.

Чтобы назначить новый родительский элемент для всплывающего окна, сделайте следующее:

1.  Создайте поставщик для всплывающего окна. Для этого класс всплывающего окна должен быть известен заранее.
2.  Реализуйте все свойства и шаблоны элементов управления обычным образом для этого всплывающего окна, как будто это элемент управления в его собственном правом.
3.  Реализуйте свойство [**иравелементпровидерсимпле:: хостравелементпровидер**](/windows/desktop/api/UIAutomationCore/nf-uiautomationcore-irawelementprovidersimple-get_hostrawelementprovider) , чтобы оно возвращало значение, полученное от [**уиахостпровидерфромхвнд**](/windows/desktop/api/UIAutomationCoreApi/nf-uiautomationcoreapi-uiahostproviderfromhwnd), где параметр является маркером окна всплывающего окна.
4.  Реализуйте [**иравелементпровидерфрагмент:: Navigate**](/windows/desktop/api/UIAutomationCore/nf-uiautomationcore-irawelementproviderfragment-navigate) для всплывающего окна и его родителя, чтобы правильно обработать навигацию от логического родителя к логическим дочерним элементам и между одноуровневыми потомками.

Когда модель автоматизации пользовательского интерфейса встречает всплывающее окно, она распознает, что переход переопределяется из значения по умолчанию, и пропускает всплывающее окно, когда оно встречается в качестве дочернего элемента рабочего стола. Вместо этого узел доступен только через фрагмент.

Назначение нового родителя не подходит для случаев, когда элемент управления может размещать окно любого класса. Например, элемент управления "Главная панель" может размещать в своих диапазонах любой тип окна. Чтобы справиться с этими случаями, модель автоматизации пользовательского интерфейса поддерживает альтернативную форму перемещения окна, как описано в следующем разделе.

## <a name="provider-repositioning"></a>Изменение расположения поставщика

Фрагменты автоматизации пользовательского интерфейса могут содержать два или более элементов, каждый из которых содержится в окне. Поскольку каждое окно имеет собственный поставщик по умолчанию, который считает, что окно является дочерним по отношению к содержащему окну, дерево модели автоматизации пользовательского интерфейса по умолчанию будет показывать окна в фрагменте как дочерние элементы родительского окна. В большинстве случаев это предпочтительное поведение, но иногда это может привести к путанице, поскольку оно не соответствует логической структуре пользовательского интерфейса.

Хорошим примером служит элемент управления главной панели. Элемент управления "Главная панель" содержит полосы, каждая из которых может в свою очередь содержать элемент управления на основе окна, например панель инструментов, поле ввода или поле со списком. Поставщик окна по умолчанию для окна главной панели видит окна управления полосой как дочерние элементы, а поставщик главной панели видит их как дочерние элементы. Так как поставщик окон и поставщик главной панели работают совместно и объединяют их дочерние элементы, как полосы, так и элементы управления на основе окон отображаются как дочерние элементы элемента управления "Главная панель". Логически, однако, только полосы должны отображаться как дочерние элементы элемента управления главной панели, и каждый поставщик диапазона должен быть связан с поставщиком окна по умолчанию для элемента управления, который он содержит.

Для этого корневой поставщик фрагмента для элемента управления "Главная панель" предоставляет набор дочерних элементов, представляющих полосы. Каждый диапазон имеет один поставщик, который может предоставлять свойства и шаблоны элементов управления. В реализации [**иравелементпровидерсимпле:: хостравелементпровидер**](/windows/desktop/api/UIAutomationCore/nf-uiautomationcore-irawelementprovidersimple-get_hostrawelementprovider)поставщик диапазонов Возвращает поставщик окна по умолчанию для окна управления, которое оно получает путем вызова [**уиахостпровидерфромхвнд**](/windows/desktop/api/UIAutomationCoreApi/nf-uiautomationcoreapi-uiahostproviderfromhwnd), передавая дескриптор окна элемента управления (**HWND**). Наконец, поставщик корневого элемента фрагмента для главной панели реализует интерфейс [**иравелементпровидерхвндоверриде**](/windows/desktop/api/UIAutomationCore/nn-uiautomationcore-irawelementproviderhwndoverride) , и в его реализации [**Иравелементпровидерхвндоверриде:: жетоверридепровидерфорхвнд**](/windows/desktop/api/UIAutomationCore/nf-uiautomationcore-irawelementproviderhwndoverride-getoverrideproviderforhwnd)он возвращает соответствующий поставщик управления, содержащийся в указанном окне.

## <a name="disconnecting-providers"></a>Отключение поставщиков

Приложения обычно создают элементы управления по мере необходимости и удаляют их впоследствии. После уничтожения элемента управления ресурсы поставщика автоматизации пользовательского интерфейса, связанные с элементом управления, должны быть освобождены путем вызова метода [**уиадисконнектпровидер**](/windows/desktop/api/UIAutomationCoreApi/nf-uiautomationcoreapi-uiadisconnectprovider).

Аналогичным образом приложение должно использовать функцию [**уиадисконнекталлпровидерс**](/windows/desktop/api/UIAutomationCoreApi/nf-uiautomationcoreapi-uiadisconnectallproviders) , чтобы освободить все ресурсы модели автоматизации пользовательского интерфейса, удерживаемые всеми поставщиками в приложении, перед завершением работы.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Рекомендации программиста поставщика модели автоматизации пользовательского интерфейса](uiauto-providerportal.md)
</dt> </dl>

 

 