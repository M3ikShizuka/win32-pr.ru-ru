---
description: Дополнительные сведения о функции JetDefragment2
title: Функция JetDefragment2
TOCTitle: JetDefragment2 Function
ms:assetid: cfb190cf-8bd3-4479-a6a1-7c0c9e8c74ca
ms:mtpsurl: https://msdn.microsoft.com/library/Gg294095(v=EXCHG.10)
ms:contentKeyID: 32765710
ms.date: 04/11/2016
ms.topic: reference
api_name:
- JetDefragment2
- JetDefragment2A
- JetDefragment2W
topic_type:
- kbArticle
- apiref
api_type:
- COM
- DLLExport
api_location:
- ESENT.DLL
ROBOTS: INDEX,FOLLOW
ms.openlocfilehash: 8064ae996831f61869d74ff1fd7c0f2222257b85
ms.sourcegitcommit: 168d11879cb9fd89d26f826482725c0a626be00f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/16/2021
ms.locfileid: "105720989"
---
# <a name="jetdefragment2-function"></a>Функция JetDefragment2


_**Применимо к:** Windows | Windows Server_

## <a name="jetdefragment2-function"></a>Функция JetDefragment2

Функция **JetDefragment2** запускает и останавливает задачи дефрагментации базы данных, которые улучшают организацию данных в базе данных, с параметром обратного вызова, доступным для сообщения о ходе дефрагментации. Это делается для ограничения роста базы данных за счет более эффективного выделения места на диске в пределах базы данных. Это также позволяет сократить объем рабочего набора, гарантируя, что данные более тесно упакованы. Наконец, она может повысить производительность приложения за счет ускорения выполнения общих операций с помощью более эффективной организации данных.

**Windows XP:**  **JetDefragment2** появился в Windows XP.

**JetDefragment2** также содержит параметр функции обратного вызова, который используется для сообщения о ходе процесса дефрагментации.

Дефрагментация базы данных — это оперативная операция, которая не прерывает обычные операции с базой данных, такие как операции запроса или обновления данных. **JetDefragment2** также не копирует все существующие данные. Вместо этого он выполняет дефрагментацию базы данных на месте. Наконец, **JetDefragment2** восстанавливает внутреннее пространство базы данных для повторного использования, но не освобождает лишнее пространство для файловой системы операционной системы.

Полученный формат данных может быть гораздо более эффективным, но обычно не является оптимальным. Дефрагментация ограничена освобождением страниц базы данных для повторного использования, содержащих данные, которые уже были логически удалены. Дефрагментация также делает страницы базы данных доступными для повторного использования в некоторых случаях путем объединения данных из двух страниц, когда они могут поместиться на одной странице.

Эта операция отличается от [жеткомпакт](./jetcompact-function.md) , которая делает копию базы данных, доступную только для чтения, в очень оптимальную форму.

```cpp
JET_ERR JET_API JetDefragment2(
  __in          JET_SESID sesid,
  __in          JET_DBID dbid,
  __in          JET_PCSTR szTableName,
  __out_opt     unsigned long* pcPasses,
  __out_opt     unsigned long* pcSeconds,
  __in          JET_CALLBACK callback,
  __in          JET_GRBIT grbit
);
```

### <a name="parameters"></a>Параметры

*сесид*

Сеанс, используемый для этого вызова.

*DBID*

Дефрагментация базы данных.

*сзтабленаме*

Неиспользуемый параметр. Дефрагментация выполняется для всей базы данных, описанной по заданному ИДЕНТИФИКАТОРу базы данных.

*пкпассес*

При запуске задачи дефрагментации в оперативном режиме этот необязательный входной параметр задает максимальное количество проходов дефрагментации. При остановке задачи дефрагментации в оперативном режиме для этого дополнительного выходного буфера задается количество выполненных проходов.

Если этот параметр имеет значение NULL, число проходов оперативной дефрагментации не ограничено.

*пксекондс*

При запуске задачи дефрагментации в оперативном режиме этот необязательный входной параметр задает максимальное время для дефрагментации. При остановке задачи дефрагментации в оперативном режиме для этого необязательного выходного буфера задается продолжительность времени, используемого для дефрагментации.

Если для этого параметра задано значение NULL или *пксекондс* указывает на отрицательное значение, максимальное время дефрагментации не ограничено.

*обратный вызов*

Функция обратного вызова, которая регулярно вызывает дефрагментацию для отчета о ходе выполнения.

*грбит*

Группа битов, задающая ноль или более следующих параметров.

<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th><p>Значение</p></th>
<th><p>Значение</p></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>JET_bitDefragmentAvailSpaceTreesOnly</p></td>
<td><p>Этот параметр используется для дефрагментации свободного места, выделенного для выделения места в базе данных ESE. Пространство базы данных делится на два типа: пространство и доступное пространство. Владельцем пространства выделяется таблица или индекс, в то время как доступное место может быть готово к использованию в таблице или индексе соответственно. Доступное пространство является гораздо более динамичным поведением и требует оперативной дефрагментации больше, чем присвоено пространство или данные таблицы или индекса.</p></td>
</tr>
<tr class="even">
<td><p>JET_bitDefragmentBatchStart</p></td>
<td><p>Этот параметр используется для запуска новой задачи дефрагментации.</p></td>
</tr>
<tr class="odd">
<td><p>JET_bitDefragmentBatchStop</p></td>
<td><p>Этот параметр используется для отмены существующей запущенной задачи дефрагментации.</p></td>
</tr>
<tr class="even">
<td><p>JET_bitDefragmentBTree</p></td>
<td><p>Этот параметр используется для дефрагментации сбалансированного дерева.</p></td>
</tr>
</tbody>
</table>


### <a name="return-value"></a>Возвращаемое значение

Эта функция возвращает [JET_ERR](./jet-err.md) DataType с одним из следующих кодов возврата. Дополнительные сведения о возможных ошибках ESE см. в разделе [ошибки подсистемы хранилища](./extensible-storage-engine-errors.md) и [Параметры обработки ошибок](./error-handling-parameters.md).

<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th><p>Код возврата</p></th>
<th><p>Описание</p></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>JET_errSuccess</p></td>
<td><p>Операция выполнена успешно.</p></td>
</tr>
<tr class="even">
<td><p>JET_errClientRequestToStopJetService</p></td>
<td><p>Невозможно выполнить операцию, так как все действия в экземпляре, связанном с сеансом, были прекращены в результате вызова <a href="gg269240(v=exchg.10).md">жетстопсервице</a>.</p></td>
</tr>
<tr class="odd">
<td><p>JET_errDatabaseFileReadOnly</p></td>
<td><p>База данных, выбранная для дефрагментации, доступна только для чтения и не может быть обновлена каким-либо образом, включая дефрагментацию.</p></td>
</tr>
<tr class="even">
<td><p>JET_errDistributedTransactionAlreadyPreparedToCommit</p></td>
<td><p>Данный сеанс находится в состоянии "подготовлено к фиксации" и не может начинать новые обновления до фиксации или отката текущей транзакции.</p></td>
</tr>
<tr class="odd">
<td><p>JET_errInstanceUnavailable</p></td>
<td><p>Невозможно выполнить операцию, поскольку экземпляр, связанный с сеансом, обнаружил неустранимую ошибку, которая требует, чтобы доступ ко всем данным был отозван для защиты целостности этих данных. Эта ошибка будет возвращена только Windows XP и более поздних версий.</p></td>
</tr>
<tr class="even">
<td><p>JET_errInvalidDatabaseId</p></td>
<td><p>Заданный идентификатор базы данных не соответствует известной базе данных в экземпляре.</p></td>
</tr>
<tr class="odd">
<td><p>JET_errNotInitialized</p></td>
<td><p>Невозможно выполнить операцию, так как экземпляр, связанный с сеансом, еще не инициализирован.</p></td>
</tr>
<tr class="even">
<td><p>JET_errRestoreInProgress</p></td>
<td><p>Невозможно выполнить операцию, так как в экземпляре, связанном с сеансом, выполняется операция восстановления.</p></td>
</tr>
<tr class="odd">
<td><p>JET_errSessionSharingViolation</p></td>
<td><p>Один и тот же сеанс нельзя использовать одновременно для нескольких потоков. Эта ошибка будет возвращена только Windows XP и более поздних версий.</p></td>
</tr>
<tr class="even">
<td><p>JET_errTermInProgress</p></td>
<td><p>Невозможно выполнить операцию, так как выполняется завершение работы экземпляра, связанного с сеансом.</p></td>
</tr>
<tr class="odd">
<td><p>JET_errTransReadOnly</p></td>
<td><p>Данный сеанс имеет только права доступа только для чтения и не может запустить задачу, которая может выполнить обновление, включая дефрагментацию.</p></td>
</tr>
<tr class="even">
<td><p>JET_errVersionStoreOutOfMemory</p></td>
<td><p>Эта ошибка возникает, если настроенный размер хранилища версий недостаточно для хранения всех необработанных обновлений.</p></td>
</tr>
<tr class="odd">
<td><p>JET_wrnDefragAlreadyRunning</p></td>
<td><p>Параметр JET_bitDefragmentBatchStart был передан, но задача дефрагментации уже выполняет дефрагментацию данной базы данных.</p></td>
</tr>
<tr class="even">
<td><p>JET_wrnDefragNotRunning</p></td>
<td><p>Параметр JET_bitDefragmentBatchStop был передан, но в данный момент задача дефрагментации не выполняется.</p></td>
</tr>
</tbody>
</table>


При успешном выполнении запрошенное действие либо запуск задачи дефрагментации для заданных параметров с заданными параметрами, либо выполнение действия остановка существующей задачи дефрагментации.

В случае сбоя запрошенное действие запуска или остановки задания оперативной дефрагментации не выполняется. Другие побочные эффекты не возникают.

#### <a name="remarks"></a>Комментарии

Оперативная дефрагментация управляется параметром параметра, а также этим API. Значение системного параметра по умолчанию — JET_OnlineDefragAll. Это означает, что дефрагментация включена для всех поддерживаемых структур данных. Однако с помощью [жетсетсистемпараметер](./jetsetsystemparameter-function.md)можно отключить оперативную дефрагментацию или выборочно включить ее только для деревьев пространства базы данных, только для потоковых файлов или любого сочетания этих параметров. Если параметр системы для автономной дефрагментации находится в устаревшем параметре, **JetDefragment2** будет рассматривать этот параметр как JET_OnlineDefragAll.

Для каждой базы данных может выполняться не более одной задачи. Задача выполняется как поток в процессе размещения ESE.

Сеанс, используемый для запуска задачи дефрагментации в сети, можно впоследствии использовать для операций с базой данных во время выполнения задачи дефрагментации, так как задача дефрагментации выделяет собственный сеанс. Данный сеанс используется только для проверки разрешений, связанных с начальным сеансом задачи, и фактически не используется для самих операций дефрагментации.

#### <a name="requirements"></a>Требования

<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="odd">
<td><p><strong>Клиент</strong></p></td>
<td><p>Требуется Windows Vista или Windows XP.</p></td>
</tr>
<tr class="even">
<td><p><strong>Server</strong></p></td>
<td><p>Требуется Windows Server 2008 или Windows Server 2003.</p></td>
</tr>
<tr class="odd">
<td><p><strong>Header</strong></p></td>
<td><p>Объявлено в ESENT. h.</p></td>
</tr>
<tr class="even">
<td><p><strong>Библиотека</strong></p></td>
<td><p>Используйте ESENT. lib.</p></td>
</tr>
<tr class="odd">
<td><p><strong>КОМПОНОВКИ</strong></p></td>
<td><p>Требуется ESENT.dll.</p></td>
</tr>
<tr class="even">
<td><p><strong>Юникод</strong></p></td>
<td><p>Реализуется как <strong>JetDefragment2W</strong> (Юникод) и <strong>JetDefragment2A</strong> (ANSI).</p></td>
</tr>
</tbody>
</table>


#### <a name="see-also"></a>См. также:

[JET_ERR](./jet-err.md)  
[JET_SESID](./jet-sesid.md)  
[жеткомпакт](./jetcompact-function.md)  
[жетдефрагмент](./jetdefragment-function.md)  
[жетсетсистемпараметер](./jetsetsystemparameter-function.md)  
[жетстопсервице](./jetstopservice-function.md)
