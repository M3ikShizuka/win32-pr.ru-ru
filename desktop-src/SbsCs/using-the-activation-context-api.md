---
description: Приложения могут управлять контекстом активации путем непосредственного вызова функций контекста активации.
ms.assetid: 606147a8-435d-43d4-8fb5-79d2d1a8d870
title: Использование API контекста активации
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 62b3aec5b7840e70e8fae93575e65c2f06668936
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104144491"
---
# <a name="using-the-activation-context-api"></a>Использование API контекста активации

Приложения могут управлять [контекстом активации](activation-contexts.md) путем непосредственного вызова функций контекста активации. Контексты активации — это структуры данных в памяти. Система может использовать сведения в контексте активации для перенаправления приложения для загрузки конкретной версии DLL, экземпляра объекта COM или пользовательской версии окна. Дополнительные сведения см. в разделе [Справочник по контексту активации](activation-context-reference.md).

Прикладной программный интерфейс (API) можно использовать для управления контекстом активации и создания объектов с именованием версий с [манифестами](manifests.md). В следующих двух сценариях показано, как приложение может управлять контекстом активации путем непосредственного вызова функций контекста активации. Однако в большинстве случаев управление контекстом активации осуществляется системой. Разработчикам приложений и поставщикам сборок обычно не требуется вызывать стек для управления контекстом активации.

-   Процессы и приложения, которые реализуют слои косвенного обращения или диспетчеризации.

    Например, пользователь управляет контекстами активации в цикле событий. При каждом доступе к окну, например при перемещении указателя мыши на окно, вызывается [**активатеакткткс**](/windows/desktop/api/Winbase/nf-winbase-activateactctx) , который активирует текущий контекст активации для ресурса, как показано в следующем фрагменте кода.

    <dl> Обработайте Хакткткс;  
    CreateWindow ();  
    ...  
    Жеткуррентакткткс (&Акткткс);  
    ...  
    Релеасеакткткс (&Акткткс);  
    </dl>

    В следующем фрагменте кода функция API активирует соответствующие контексты активации перед вызовом [**каллвиндовпрок**](/windows/win32/api/winuser/nf-winuser-callwindowproca). При вызове **каллвиндовпрок** он использует этот контекст для передачи сообщения в Windows. По завершении всех операций с ресурсами функция деактивирует контекст.

    <dl> ULONG \_ ptr улпкукие;  
    Обработайте Хакткткс;  
    If (Активатеакткткс (Хакткткс, &Улпкукие))  
    {  
    ...  
    Каллвиндовпрок (...);  
    ...  
    Деактиватеакткткс (0, Улпкукие);  
    }  
    </dl>

-   Уровень диспетчеризации делегирования.

    Этот сценарий применяется к руководителям, управляющим несколькими сущностями с общим уровнем API, например диспетчером драйверов. Хотя это и еще не реализовано, в качестве примера можно привести драйвер ODBC.

    В этом сценарии средний уровень может обрабатывать привязки сборок. Чтобы получить драйвер привязки для конкретной версии, издатели должны предоставить манифест и указать зависимости от конкретных компонентов в этом манифесте. Базовое приложение не выполняет динамическую привязку к компонентам; во время выполнения диспетчер драйверов управляет вызовами. При вызове драйвера ODBC на основе строки подключения он загружает соответствующий драйвер. Затем он создает контекст активации, используя сведения в файле манифеста сборки.

    Без манифеста действием по умолчанию для драйвера является использование того же контекста, который указан в приложении — в данном примере это версия 2 библиотеки MSVCRT. Поскольку манифест существует, устанавливается отдельный контекст активации. При запуске драйвера ODBC он привязывается к версии 1 сборки MSVCRT.

    Каждый раз, когда диспетчер драйверов вызывает слой диспетчеризации, например для получения следующего набора данных, он использует соответствующие сборки на основе контекста активации. Это показано в следующем фрагменте кода.

    <dl> Обработайте Хакткткс;  
    ULONG \_ ptr улпкукие;  
    АКТКТКС Акткткстокреате = {...};  
    Хакткткс = Креатеакткткс (&Акткткстокреате);  
    ...;  
    If (Активатеакткткс (Хакткткс, &Улпкукие))  
    {  
    ...  
    Коннектдб (...);  
    Деактиватеакткткс (0, Улпкукие);  
    }  
    ...  
    Релеасеакткткс (Хакткткс);  
    </dl>

 

 
