---
description: Память, принадлежащая процессу, неявно защищается его частным виртуальным адресным пространством.
ms.assetid: 70ded07a-7be6-4189-a1ae-281917f42a1e
title: Защита памяти
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: bd30df8084c91a62c28414f4a8142397ee777e52
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104156882"
---
# <a name="memory-protection"></a>Защита памяти

Память, принадлежащая процессу, неявно защищается его частным виртуальным адресным пространством. Кроме того, Windows обеспечивает защиту памяти с помощью аппаратного обеспечения виртуальной памяти. Реализация этой защиты зависит от процессора, например, кодовые страницы в адресном пространстве процесса могут быть помечены только для чтения и защищены от изменения потоками пользовательского режима.

Полный список атрибутов см. в разделе [константы защиты памяти](memory-protection-constants.md).

## <a name="copy-on-write-protection"></a>Защита от копирования при записи

Защита от копирования при записи — это оптимизация, которая позволяет нескольким процессам сопоставлять свои виртуальные адресные пространства таким образом, что они совместно используют физическую страницу, пока один из процессов не изменит страницу. Это часть метода, называемого *отложенным вычислением*, который позволяет системе экономить физическую память и время, не выполняя операции до абсолютной необходимости.

Например, предположим, что два процесса загружают страницы из одной и той же библиотеки DLL в виртуальные пространства памяти. Эти страницы виртуальной памяти сопоставлены с одними и теми же страницами физической памяти для обоих процессов. Если ни один из процессов не выполняет запись на эти страницы, они могут сопоставляться с теми же физическими страницами и предоставлять к ним общий доступ, как показано на следующей схеме.

![поля и стрелки страниц Process 1 и 2, сопоставленные с одинаковой физической памятью](images/mem1.png)

Если процесс 1 записывает данные на одну из этих страниц, содержимое физической страницы копируется на другую физическую страницу, а таблица виртуальной памяти обновляется для процесса 1. Оба процесса теперь имеют свой собственный экземпляр страницы в физической памяти. Таким образом, один процесс не может выполнить запись на общую физическую страницу, и для просмотра изменений другим процессом.

![поля и стрелки процессов и перераспределение физической памяти](images/mem2.png)

## <a name="loading-applications-and-dlls"></a>Загрузка приложений и библиотек DLL

При загрузке нескольких экземпляров одного приложения на основе Windows каждый экземпляр выполняется в собственном защищенном виртуальном адресном пространстве. Однако дескрипторы экземпляров (*HINSTANCE*) обычно имеют одинаковое значение. Это значение представляет базовый адрес приложения в его виртуальном адресном пространстве. Если каждый экземпляр можно загрузить в базовый адрес по умолчанию, он может сопоставляться с другими экземплярами и совместно использовать одни и те же физические страницы, используя защиту от копирования при записи. Система позволяет этим экземплярам совместно использовать одни и те же физические страницы, пока один из них не изменит страницу. Если по какой бы то ни было причине не удается загрузить один из этих экземпляров в нужный базовый адрес, он получает собственные физические страницы.

Библиотеки DLL создаются с базовым адресом по умолчанию. Каждый процесс, использующий библиотеку DLL, попытается загрузить библиотеку DLL в своем собственном адресном пространстве по виртуальному адресу по умолчанию для библиотеки DLL. Если несколько приложений могут загрузить библиотеку DLL по виртуальному адресу по умолчанию, они могут использовать одни и те же физические страницы для библиотеки DLL. Если по какой-либо причине процессу не удается загрузить библиотеку DLL по адресу по умолчанию, то библиотека DLL загружается в другое место. Защита от копирования при записи принудительно копирует некоторые страницы библиотеки DLL на разные физические страницы для этого процесса, поскольку исправления для инструкций перехода записываются в страницы библиотеки DLL, и для этого процесса они будут отличаться. Если раздел кода содержит много ссылок на раздел данных, это может привести к тому, что весь раздел кода будет скопирован на новые физические страницы.

 

 



