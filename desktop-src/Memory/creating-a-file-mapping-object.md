---
description: Первым шагом при сопоставлении файла является открытие файла путем вызова функции CreateFile.
ms.assetid: e00d8742-b717-419c-902c-9a286d75d8aa
title: Создание объекта сопоставления файлов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 65badc2af8aed5211c2f5c590fc0998019dae264
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104345365"
---
# <a name="creating-a-file-mapping-object"></a>Создание объекта сопоставления файлов

Первым шагом при сопоставлении файла является открытие файла путем вызова функции [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea) . Чтобы другие процессы не могут выполнять запись в часть сопоставленного файла, следует открыть файл с монопольным доступом. Кроме того, этот обработчик файлов должен оставаться открытым до тех пор, пока процессу больше не требуется объект сопоставления файлов. Простой способ получить эксклюзивный доступ — указать ноль в параметре *Фдвшаремоде* **CreateFile**. Маркер, возвращаемый **CreateFile** , используется функцией [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) для создания объекта сопоставления файлов.

Функция [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) возвращает маркер объекта сопоставления файлов. Этот маркер будет использоваться при [создании представления файлов](creating-a-file-view.md) для доступа к общей памяти. При вызове **CreateFileMapping** указывается имя объекта, число байтов, которое должно быть сопоставлено из файла, а также разрешение на чтение и запись для сопоставленной памяти. Первый процесс, вызывающий **CreateFileMapping** , создает объект сопоставления файлов. Процессы, вызывающие **CreateFileMapping** для существующего объекта, получают маркер существующего объекта. Вы можете определить, был ли успешно вызван в **CreateFileMapping** создание или открытие объекта сопоставления файлов путем вызова функции [**GetLastError**](/windows/win32/api/errhandlingapi/nf-errhandlingapi-getlasterror) . **GetLastError** **не возвращает \_ ошибку** в процесс создания, и **Ошибка \_ уже \_ существует** для последующих процессов.

Функция [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) завершается ошибкой, если флаги доступа конфликтуют с указанными при открытии файла функцией [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea) . Например, для чтения и записи в файл:

-   Укажите **универсальные значения \_ чтения** и **универсальные \_ записи** в параметре *фдвакцесс* [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea).
-   Укажите значение **\_ ReadWrite для страницы** в параметре *фдвпротект* объекта [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga).

Создание объекта сопоставления файлов не фиксирует физическую память, а только резервирует его.

## <a name="file-mapping-size"></a>Размер сопоставления файлов

Размер объекта сопоставления файлов не зависит от размера сопоставляемого файла. Однако если объект сопоставления файлов больше, чем файл, система расширяет файл до возврата [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) . Если объект сопоставления файлов меньше, чем файл, система сопоставляется только с указанным числом байтов из файла.

Параметры *двмаксимумсизехигх* и *двмаксимумсизелов* [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) позволяют указать число байтов, которое должно быть сопоставлено с файлом:

-   Если размер файла не должен изменяться (например, при сопоставлении файлов, предназначенных только для чтения), вызовите [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) и укажите ноль для *двмаксимумсизехигх* и *двмаксимумсизелов*. При этом создается объект сопоставления файлов, размер которого совпадает с размером файла. В противном случае необходимо вычислить или оценить размер готового файла, так как объекты сопоставления файлов являются статическими в размере. После создания их размер не может быть увеличен или уменьшен. Попытка выполнить прикарту файла с нулевой длиной таким образом завершается ошибкой с кодом ошибки, **\_ \_ недопустимым в файле**. Программы должны проверять файлы с нулевой длиной и отклонять такие файлы.

-   Размер объекта сопоставления файлов, поддерживаемого именованным файлом, ограничен дисковым пространством. Размер представления файлов ограничен самым большим доступным непрерывным блоком незарезервированной виртуальной памяти. Это не более 2 ГБ виртуальной памяти, уже зарезервированной процессом.

Размер объекта сопоставления файлов, который вы выбрали, определяет, насколько далеко в файле можно просмотреть сведения о сопоставлении памяти. Если вы создаете объект сопоставления файлов размером 500 КБ, у вас есть доступ только к первой 500 КБ файла, независимо от размера файла. Так как это не требует каких-либо системных ресурсов создавать объект сопоставления файлов большего размера, создайте объект сопоставления файлов, который является размером файла (задайте параметры *двмаксимумсизехигх* и *двмаксимумсизелов* [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) как ноль), даже если вы не планируете просматривать файл целиком. Стоимость системных ресурсов состоит в создании представлений и доступе к ним.

Если нужно просмотреть часть файла, которая не начинается с начала файла, необходимо создать объект сопоставления файлов. Этот объект представляет собой размер части файла, которую необходимо просмотреть, а также смещение в файле.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Создание представления в файле](creating-a-view-within-a-file.md)
</dt> </dl>

 

 
