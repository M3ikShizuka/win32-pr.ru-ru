---
title: Сведения о реализации WOW64
description: Эмулятор WOW64 работает в пользовательском режиме.
ms.assetid: 93daf9d0-dfdb-42c3-8c3d-397b21991e83
keywords:
- WOW64 64-разрядное программирование Windows, переменные среды
- WOW64 64-разрядное программирование Windows, реализация
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4c7d095369b883171e39bffd4dc629b7f80a7f39
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "104134062"
---
# <a name="wow64-implementation-details"></a>Сведения о реализации WOW64

Эмулятор WOW64 работает в пользовательском режиме. Он предоставляет интерфейс между 32-разрядной версией Ntdll.dll и ядром процессора и перехватывает вызовы ядра. Эмулятор WOW64 состоит из следующих библиотек DLL:

-   Wow64.dll предоставляет основную инфраструктуру эмуляции и Преобразователи для функций Ntoskrnl.exe точки входа.
-   Wow64Win.dll предоставляет преобразователи для функций Win32k.sys точки входа.
-   (только x64) Wow64Cpu.dll обеспечивает поддержку для запуска программ x86 на x64.
-   (Только для Intel Itanium) IA32Exec. bin содержит программный эмулятор x86.
-   (Только Intel Itanium) Wowia32x.dll предоставляет интерфейс между IA32Exec. bin и WOW64.
-   (Только ARM64) xtajit.dll содержит эмулятор программного обеспечения x86.
-   (Только ARM64) wowarmw.dll обеспечивает поддержку запуска программ ARM32 на ARM64.

Эти библиотеки DLL, а также 64-разрядная версия Ntdll.dll являются единственными 64-разрядными двоичными файлами, которые можно загрузить в 32-разрядный процесс. В Windows 10 на ARM двоичные файлы ЧПЕ (скомпилированные гибридные переносимые исполняемые файлы) также могут быть загружены в 32-разрядный процесс x86.

При запуске Wow64.dll загружает версию x86 Ntdll.dll (или версию ЧПЕ, если она включена) и выполняет свой код инициализации, который загружает все необходимые 32-разрядные библиотеки DLL. Почти все 32-разрядные библиотеки DLL являются немодифицированными копиями 32-разрядных двоичных файлов Windows, хотя некоторые из них загружаются как ЧПЕ по соображениям производительности. Некоторые из этих библиотек DLL ведут себя по-разному для WOW64, чем в 32-разрядной Windows, обычно потому что они совместно используют память с 64-разрядными компонентами системы. Все адресное пространство пользовательского режима свыше 32-разрядного предела резервируется системой. Дополнительные сведения см. [в разделе Использование производительности и памяти в эмуляторе WOW64](performance-and-memory-consumption.md).

Вместо использования последовательности вызовов системной службы x86, 32-разрядных двоичных файлов, которые делают системные вызовы, перестраиваются для использования пользовательской последовательности вызова. Эта последовательность вызова недорога для перехвата WOW64, так как она полностью находится в пользовательском режиме. При обнаружении пользовательской последовательности вызовов ЦП WOW64 возвращается в собственный 64-разрядный режим и вызывается в Wow64.dll. Преобразователь выполняется в пользовательском режиме, чтобы снизить воздействие на 64-разрядное ядро и снизить риск ошибки в преобразователе, которая может привести к сбою в режиме ядра, повреждению данных или бреши в безопасности. Преобразователи извлекают аргументы из 32-битного стека, расширяют их до 64 бит, а затем выполняют собственный системный вызов.

## <a name="environment-variables"></a>Переменные среды

При создании 32-разрядного процесса с помощью 64-разрядного процесса или при создании 64-bit процесса в 32-разрядном процессе WOW64 устанавливает переменные среды для созданного процесса, как показано в следующей таблице.



| Процесс                   | Переменные среды                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|---------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 64-разрядный процесс<br/> | \_Архитектура процессора = amd64 или \_ архитектура процессора = ia64 или \_ архитектура процессора = ARM64<br/> ProgramFiles =% ProgramFiles%<br/> ProgramW6432 =% ProgramFiles%<br/> CommonProgramFiles =% CommonProgramFiles%<br/> CommonProgramW6432 =% CommonProgramFiles%<br/> Windows **server 2008, Windows Vista, Windows server 2003 и Windows XP:** Переменные среды ProgramW6432 и CommonProgramW6432 были добавлены начиная с Windows 7 и Windows Server 2008 R2. <br/> |
| 32-разрядный процесс<br/> | \_Архитектура процессора = x86<br/> ПРОЦЕССОР \_ ARCHITEW6432 =% \_ архитектура процессора%<br/> ProgramFiles =% ProgramFiles (x86)%<br/> ProgramW6432 =% ProgramFiles%<br/> CommonProgramFiles =% CommonProgramFiles (x86)%<br/> CommonProgramW6432 =% CommonProgramFiles%<br/>                                                                                                                                                                                                                  |



 

## <a name="global-hooks"></a>Глобальные перехватчики

Функцию [**сетвиндовшукекс**](/windows/win32/api/winuser/nf-winuser-setwindowshookexa) можно использовать для внедрения библиотеки DLL в другой процесс при соблюдении следующих условий.

-   32-разрядную библиотеку DLL можно внедрить только в 32-разрядный процесс, а 64-разрядную библиотеку DLL можно внедрить только в 64-разрядный процесс. Невозможно внедрить 32-разрядную библиотеку DLL в 64-разрядный процесс или наоборот.
-   32-разрядные и 64-разрядные библиотеки DLL должны иметь разные имена.
-   Архитектуры библиотеки DLL и процесса должны совпадать. Например, нельзя внедрить 32-разрядную DLL x86 в процесс с 32-разрядной ARM.

Дополнительные сведения см. в разделе [**сетвиндовшукекс**](/windows/win32/api/winuser/nf-winuser-setwindowshookexa).

Имейте в виду, что в потоке, в котором установлен обработчик, а не поток, обрабатывающий обработчик, можно вызывать такие возможности, как ввод в **\_ Журнал \***, что позволяет использовать **\_ оболочку** и низкоуровневые обработчики. **\_** **\_** Для этих обработчиков возможно, что будут вызываться как 32-разрядные, так и 64-разрядные обработчики, если 32-разрядный обработчик впереди в цепочке прерываний до 64-разрядного обработчика. Дополнительные сведения см. [в разделе Использование перехватчиков](../winmsg/using-hooks.md).

 

