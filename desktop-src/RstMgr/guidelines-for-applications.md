---
title: Рекомендации для приложений
description: приложения, работающие на Windows Vista и Windows Server 2008, должны соблюдать эти рекомендации, чтобы диспетчер перезапуска мог завершить работу и перезапустить приложения, если это необходимо для установки обновлений.
ms.assetid: 97b1df63-65a9-47b4-891b-e4a754882b89
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9624f578a04267b94bde41bbdf8e3312e7b8ae0f4fb84280212ea51c2db7e2f7
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119010132"
---
# <a name="guidelines-for-applications"></a>Рекомендации для приложений

приложения, работающие на Windows Vista и Windows Server 2008, должны соблюдать эти рекомендации, чтобы диспетчер перезапуска мог завершить работу и перезапустить приложения, если это необходимо для установки обновлений. Службы могут использовать рекомендации, описанные в разделе [рекомендации по службам](guidelines-for-services.md).

-   Диспетчер перезапуска запрашивает завершение работы приложений GUI, отправляя уведомление [**WM \_ куерендсессион**](/windows/desktop/Shutdown/wm-queryendsession) с параметром *lParam* , равным **ENDSESSION \_ клосеапп** (0x1). Приложения не должны завершать работу при получении сообщения **WM \_ куерендсессион** , поскольку другое приложение может быть не готово к завершению работы. Приложения GUI должны прослушивать сообщение **\_ куерендсессион WM** и возвращать значение **true** , если приложение готово к завершению работы и перезапуску. Если приложение не возвращает значение **false**, диспетчер перезапуска отправляет сообщение [**WM \_ ENDSESSION**](/windows/desktop/Shutdown/wm-endsession) с параметром *lParam* , установленным в значение **ENDSESSION \_ клосеапп** (0x1), а параметр *wParam* имеет значение **true**. Приложения должны завершать работу только при получении сообщения **WM \_ ENDSESSION** . Диспетчер перезапуска также отправляет сообщение [**о \_ закрытии WM**](../winmsg/wm-close.md) для приложений графического пользовательского интерфейса, которые не завершают работу при получении **WM \_ ENDSESSION**. Если любое приложение графического пользовательского интерфейса отвечает на сообщение **WM \_ куерендсессион** , возвращая значение **false**, завершение работы отменяется. Однако при принудительном завершении работы приложение завершается независимо.
-   Когда приложение GUI получает сообщение [**WM \_ ENDSESSION**](/windows/desktop/Shutdown/wm-endsession) , оно должно подготовиться к завершению работы в течение заданного периода ожидания. Как минимум, приложения должны подготовиться, сохранив данные пользователя и сведения о состоянии, необходимые после перезагрузки. Рекомендуется периодически сохранять данные пользователей и их состояние.
-   Диспетчер перезапуска отправляет уведомление **о \_ \_ событии CTRL C** в консольные приложения, которые должны быть выключены и перезапущены. Когда консольное приложение получает уведомление **о \_ \_ событии CTRL C** , приложение должно предпринять действия, необходимые для подготовки к завершению работы в течение заданного периода ожидания. Как минимум, консольные приложения должны определить функцию [*хандлерраутине*](/windows/console/handlerroutine) для управления уведомлением **о \_ \_ событии CTRL C** и сохранить все данные пользователя и сведения о состоянии, которые понадобятся после перезагрузки. Рекомендуется периодически сохранять данные пользователей и их состояние.
-   Если какие бы то ни было приложения не завершаются в ответ на сообщения о завершении работы, установщики могут использовать параметр **рмфорцешутдовн** функции [**рмшутдовн**](/windows/desktop/api/RestartManager/nf-restartmanager-rmshutdown) для принудительного завершения работы приложений. Когда установщик задает принудительное завершение работы, диспетчер перезапуска пытается очистить приложения, отправляя сообщения о завершении работы, но принудительно завершит их работу в случае сбоя. Приложения GUI и консольные приложения можно принудительно завершить, чтобы обеспечить установку критического обновления для системы безопасности. Так как это может привести к утере данных, приложения должны выполнять обработку сообщений о завершении работы и завершать работу при необходимости.
-   Приложения должны зарегистрироваться для перезапуска с помощью функции [**регистераппликатионрестарт**](/windows/desktop/api/winbase/nf-winbase-registerapplicationrestart) . Диспетчер перезапуска может перезапустить только те приложения, которые были зарегистрированы для перезапуска. Это единственный способ, с помощью которого диспетчер перезапуска может определить команду командной строки, которая будет использоваться при перезапуске приложения. Если приложение должно повторно открываться с некоторым сохраненным состоянием или данными, эти сведения должны быть добавлены в команду командной строки, зарегистрированную для приложения.
    > [!Note]  
    > Если перезапущенное приложение должно выполняться в том же каталоге, в котором он выполнялся до завершения работы, приложение должно сохранить сведения о каталоге, а затем перейти к каталогу после перезапуска.

     

    > [!Note]  
    > Функция [**рмрестарт**](/windows/desktop/api/RestartManager/nf-restartmanager-rmrestart) не перезапускает приложения, которые не выполняются в качестве пользователя, выполнившего вход в систему. Например, функция **рмрестарт** не перезапускает приложения, запущенные с помощью команды **запуска от имени** , которая не выполняется как пользователь, выполнивший вход в систему. Эти приложения необходимо перезапустить вручную.

     

-   Когда диспетчер перезапуска определяет, что для установки обновления требуется перезагрузка системы, она не завершает работу приложений и служб. Вместо этого он оставляет установщик, чтобы решить, когда следует запланировать перезагрузку системы и установить обновление. Установщики могут снизить нагрузку на пользователей, вызванные обновлениями, требующими перезагрузки системы, с помощью функции [**ExitWindowsEx**](/windows/desktop/api/winuser/nf-winuser-exitwindowsex) с флагом **евкс \_ рестартаппс** или функции [**инитиатешутдовн**](/windows/desktop/api/winreg/nf-winreg-initiateshutdowna) с флагом **Shutdown \_ рестартаппс** . Использование этих флагов гарантирует, что приложения, зарегистрированные для перезапуска, перезапускаются после перезагрузки системы, что снижает влияние на пользователя.

 

 