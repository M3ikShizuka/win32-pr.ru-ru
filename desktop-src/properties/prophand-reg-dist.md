---
description: в этой статье объясняется, как зарегистрировать и распространить обработчики свойств для работы с системой свойств Windows.
ms.assetid: E6E81E04-9CC1-4df5-9A87-DE0CBD177356
title: Регистрация и распространение обработчиков свойств
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ce53f0805c4db5efe38e77ba4e7d1ab5b331c83f
ms.sourcegitcommit: ecd0ba4732f5264aab9baa2839c11f7fea36318f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/07/2021
ms.locfileid: "113481929"
---
# <a name="registering-and-distributing-property-handlers"></a>Регистрация и распространение обработчиков свойств

в этом разделе объясняется, как создавать и регистрировать обработчики свойств для работы с системой свойств Windows.

Этот раздел организован следующим образом:

-   [Регистрация и распространение обработчиков свойств](#registering-and-distributing-property-handlers)
-   [Вопросы производительности и надежности для обработчиков свойств](#performance-and-reliability-considerations-for-property-handlers)
    -   [Рекомендации по повышению производительности и надежности](#guidelines-for-performance-and-reliability)
-   [См. также](#related-topics)

## <a name="registering-and-distributing-property-handlers"></a>Регистрация и распространение обработчиков свойств

После реализации обработчика свойств он должен быть зарегистрирован, а расширение имени файла должно быть связано с обработчиком. В следующем примере с расширением. рецепт показаны необходимые записи реестра.

```
HKEY_CLASSES_ROOT
   CLSID
      {50d9450f-2a80-4f08-93b9-2eb526477d1a}
         (Default) = Recipe Property Handler
         ManualSafeSave [REG_DWORD] = 00000001
         InProcServer32
            (Default) = C:\\SDK\\PropertyHandlerSample\\bin\\RecipeHandlers.dll
            ThreadingModel = Apartment
HKEY_LOCAL_MACHINE
   SOFTWARE
      Microsoft
         Windows
            CurrentVersion
               PropertySystem
                  PropertyHandlers
                     .recipe
                        (Default) = {50d9450f-2a80-4f08-93b9-2eb526477d1a}
```

Обработчики свойств для определенного типа файлов обычно распространяются вместе с приложениями, которые создают файлы этого типа или управляют ими. Однако следует также подумать о том, чтобы обработчики свойств были доступны независимо от этих приложений для поддержки индексации типа файлов в серверных сценариях, где обработчики свойств используются индексатором, но их сопутствующие приложения не требуются. Если вы создаете автономный пакет установки для обработчика свойств, убедитесь, что он включает в себя следующее:

-   Сведения о регистрации обработчика свойства, указанные в разделе [Регистрация и распространение обработчиков свойств]().
-   Регистрация для типа файлов и всех файлов схемы, которые должны быть установлены, чтобы разрешить клиентам доступ ко всем функциям обработчика свойств.

## <a name="performance-and-reliability-considerations-for-property-handlers"></a>Вопросы производительности и надежности для обработчиков свойств

Обработчики свойств вызываются для каждого файла на определенном компьютере. Они обычно вызываются в следующих случаях:

-   Во время индексирования файла. Это выполняется вне процесса в изолированном процессе с ограниченными правами.
-   при доступе к файлам в Windows Explorer с целью чтения и записи значений свойств. Это выполняется в процессе.

### <a name="guidelines-for-performance-and-reliability"></a>Рекомендации по повышению производительности и надежности

В любой момент времени у пользователя могут быть десятки тысяч файлов любого типа (включая вас) на своих компьютерах, а также доступ к этим файлам или их изменение в любое время. Так как обработчики свойств часто вызываются для поддержки этих операций доступа и изменения, характеристики производительности и надежности обработчика свойств в занятых средах с высоким уровнем параллельности очень важны.

При разработке и тестировании обработчика свойств учитывайте следующие рекомендации.

-   **Перечисление свойств**

    Обработчики свойств должны иметь очень быстрое время отклика при перечислении их свойств. Чтобы обеспечить быстрое время отклика, следует избегать вычислений с интенсивным использованием памяти для значений свойств, поиска в сети или поиска ресурсов, отличных от самого файла.

-   **Запись свойств на месте**

    Если возможно, при работе с файлами среднего размера или большими размерами (несколько сотен КБ или больше) формат файла должен быть упорядочен таким образом, чтобы чтение или запись значений свойств не требовало считывания всего файла с диска. даже если требуется найти файл, его не следует считывать в памяти целиком, поскольку это приводит к чрезмерному работе рабочего набора Windows Explorer или Windows индексатора поиска по мере того, как они пытаются получить доступ к этим файлам или индексировать их. Дополнительные сведения см. в разделе [инициализация обработчиков свойств](./building-property-handlers-property-handlers.md).

    Одна из полезных методик этого заключается в том, чтобы заполнить заголовок файла дополнительным пространством, чтобы при следующем написании значения свойства можно было записать его на месте без необходимости перезаписи всего файла. Для этого требуются функции Мануалсафесаве. Этот подход подразумевает некоторый дополнительный риск того, что операция записи файла может быть прервана во время записи (из-за сбоя системы или потери питания), но поскольку размеры свойств обычно небольшие, вероятность такого прерывания аналогична небольшому, и выигрыш в производительности, который можно реализовать посредством записи свойств на месте, считается достаточно значительным, чтобы выровнять этот дополнительный риск. Даже поэтому следует тщательно протестировать реализацию, чтобы гарантировать, что файлы не будут повреждены в случае возникновения сбоя в ходе операции записи.

    Наконец, при реализации записи свойств на месте с помощью Мануалсафесаве иногда невозможно выполнить операцию на месте, и весь поток должен быть перезаписан в любом случае. Для упрощения перезаписи поток, предоставленный во время инициализации обработчика, поддерживает интерфейс [**идестинатионстреамфактори**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-idestinationstreamfactory) . Интерфейс **идестинатионстреамфактори** позволяет реализациям обработчиков получать временный поток для записи; когда все операции записи завершаются и вызывается метод [**идестинатионстреамфактори:: жетдестинатионстреам**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-idestinationstreamfactory-getdestinationstream) , этот поток используется для полной замены исходного файлового потока. При использовании целевого потока исходный файловый поток должен обрабатываться как доступный только для чтения, так как он будет заменен потоком назначения после вызова метода **идестинатионстреамфактори:: жетдестинатионстреам** .

-   **Выбор модели COM-потоков**

    Чтобы повысить эффективность обработчика свойств, необходимо указать, что он использует модель COM-потоков `Both` . это обеспечивает прямой доступ из апартаментов STA (например, проводника Windows) и подразделений агента передачи сообщений (например, процесс сеарчпротоколхост в Windows поиска), что позволяет избежать издержек при маршалировании в этих средах. Для достижения полной выгоды от `Both` потоковой модели все службы, от которых зависит обработчик, также должны быть обработаны так, `Both` чтобы избежать какого бы то ни было маршалирования в вызовах этих компонентов. Проверьте документацию по этим конкретным службам, чтобы убедиться, что они используют эту потоковую модель.

-   **Параллелизм обработчиков свойств**

    Обработчики свойств и интерфейс [**ипропертисторе**](/windows/win32/api/propsys/nn-propsys-ipropertystore) предназначены для последовательного доступа, а не одновременный доступ. Windows обозреватель, индексатор поиска Windows и все остальные вызовы обработчика свойств из Windows codebase гарантируют это использование. Сторонние стороны не должны использовать обработчик свойств одновременно, но это поведение не гарантировано. Кроме того, несмотря на то, что шаблон вызова должен быть последовательным, вызовы могут поступать в разные потоки (например, когда объект вызывается удаленно через COM RPC, как происходит в индексаторе). Поэтому реализации обработчика свойств должны поддерживать вызов в различных потоках, и в идеале не следует наблюдать некорректные эффекты при параллельном вызове. Так как предполагаемый шаблон вызова является последовательным, для удовлетворения этих требований в большинстве случаев достаточно тривиальных реализаций, использующих критическую секцию. Можно избежать блокировки параллельных вызовов, используя функцию [**трентеркритикалсектион**](/windows/win32/api/synchapi/nf-synchapi-tryentercriticalsection) для обнаружения и неудачных одновременных вызовов.

-   **Параллелизм файлов**

    Обработчики свойств часто используются в сценариях, где несколько приложений одновременно обращаются к файлу. Следовательно, обработчик и приложения должны управлять параллелизмом, указывая соответствующие режимы совместного использования при открытии файла. Они также должны знать доступ, указываемый другими приложениями и для управления случаями, когда доступ запрещен. Лучше всего, если все потребители указывают широкие режимы совместного использования, чтобы разрешить другим пользователям одновременный доступ к файлу, но при этом необходимо управлять проблемами согласованности. Решения о наиболее подходящих режимах совместного использования, которые следует использовать, должны быть сделаны в контексте сообщества приложений, обращающихся к файлу.

    Файловые системы позволяют приложениям открывать файлы таким образом, чтобы они могли контролировать, может ли файл открываться другими приложениями. Режимы общего доступа обеспечивают доступ на чтение, запись и удаление. Система свойств поддерживает подмножество этих режимов общего доступа, описанных в следующей таблице.

    

    | Режим доступа                     | Режим общего доступа                             |
    |---------------------------------|------------------------------------------|
    | запись                           | Запрет других модулей чтения и записи           |
    | Write (Енаблешаредениврите)    | Включение других средств чтения, запрет других модулей записи |
    | Только для чтения (по умолчанию)             | Включение других средств чтения, запрет других модулей записи |
    | Только для чтения (Енаблешаредениноне) | Включение других модулей чтения и записи         |

    

     

    Обработчики свойств, открытые для **записи** (GPS \_ ReadWrite), отклоняют другие модули чтения и записи. Обработчики могут использовать поведение, которое позволяет читателям, указывая `EnableShareDenyWrite` флаг (включение чтения) при регистрации.

    Обработчики свойств, открытые для **чтения** ( \_ по умолчанию GPS), по умолчанию позволяют другим читателям, но запрещают другие модули записи. Обработчики могут отказаться от включения других средств записи, указав `EnableShareDenyNone` флаг в его регистрации. Это означает, что обработчик может успешно справиться с ситуацией, при которой содержимое файла изменяется во время чтения файла обработчиком.

    Определения флагов см. в разделе [**жетпропертисторефлагс**](/windows/win32/api/propsys/ne-propsys-getpropertystoreflags).

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Основные сведения о обработчиках свойств](./building-property-handlers-properties.md)
</dt> <dt>

[Использование имен видов](./building-property-handlers-user-friendly-kind-names.md)
</dt> <dt>

[Использование списков свойств](./building-property-handlers-property-lists.md)
</dt> <dt>

[Инициализация обработчиков свойств](./building-property-handlers-property-handlers.md)
</dt> <dt>

[Рекомендации и вопросы и ответы по обработчикам свойств](./prophand-bestprac-faq.yml)
</dt> </dl>

 

 
