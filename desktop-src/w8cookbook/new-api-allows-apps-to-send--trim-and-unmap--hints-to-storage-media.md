---
title: Новый API позволяет приложениям отсылать подсказки "обрезать и отменить сопоставление" на носитель хранилища
description: Новый API позволяет приложениям отправить \ 0034; Обрезать и отменить сопоставление \ 0034; указания на носитель для хранения данных
ms.assetid: DDBC3592-BD4D-4826-83FE-387564DA07E8
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9e043c1188bda790b4ed151e8a79e1f7b4c6f0f9
ms.sourcegitcommit: d75fc10b9f0825bbe5ce5045c90d4045e3c53243
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2021
ms.locfileid: "127247651"
---
# <a name="new-api-allows-apps-to-send-trim-and-unmap-hints-to-storage-media"></a>Новый API позволяет приложениям отсылать подсказки "обрезать и отменить сопоставление" на носитель хранилища

## <a name="platforms"></a>Платформы

**клиенты** — Windows 8  
**серверы** — Windows Server 2012  


## <a name="description"></a>Описание

Указания TRIM уведомляют диск о том, что определенные ранее выделенные секторы больше не требуются приложению и могут быть очищены. Обычно это используется в том случае, если приложение создает большой объем памяти с помощью файла, а затем самостоятельно управляет выделением для файла (например, файлов виртуального жесткого диска).

**Что такое TRIM?**

Твердотельные накопители (SSD) обычно являются блочными устройствами флэш-памяти. Это означает, что когда данные записываются на SSD, они не могут быть перезаписаны на месте и должны быть записаны в любом месте до тех пор, пока блок не будет удален сборщиком мусора. Так как SSD не имеет внутреннего механизма для определения того, что определенные блоки удаляются и требуются другие. Единственным моментом, когда SSD может пометить сектор "грязный", является то, что он переносится. В других случаях, например при удалении файла, SSD оставляет эти секторы, так как удаление выполняется только в виде основной таблицы файлов (MFT), а не в виде операции со всеми секторами файла. в Windows 7 мы представили стандартный способ связи с SSDs о секторах, которые больше не требуются. Эта команда определена в [спецификации T13](https://www.t13.org/Standards/Default.aspx?DocumentType=3) как команда Trim; NTFS отправляет команду TRIM для некоторых обычных встроенных операций, таких как "DeleteFile".

**Другие способы обрезки в мире хранилища**

как и в случае с твердотельными накопителями, сети хранения данных (san), а также новые реализации Windows 8 компонентов программных пространств используют подсказки команд TRIM для управления пространствами в тонко подготовленных средах. San и программные пространства выделяют регионы хранения в размере больше секторов или кластеров (от 1 МБ до 1 ГБ). Когда они получают указания по УСЕЧЕНию для размера выделения (или больше размера выделения), SAN/SSD может отменить выделение региона для освобождения места для других файлов. Обычно они передают все подсказки по обрезке базовому носителю (SSD или HDD), чтобы они могли потреблять свободное пространство по мере необходимости. Обычно они не перемещают данные для отмены распределения регионов, а также не отслеживают области обрезки до освобожденных регионов (если регион пуст).

С тонкой подготовкой сети SAN используют передаваемые им указания по УСЕЧЕНию для снижения общего объема физической памяти, что снижает затраты. [Спецификация T10 SCSI](https://www.t10.org) определяет команду "Отмена сопоставления" (аналогично команде Trim); Эта команда применима ко всем типам хранилищ, включая жесткие диски, твердотельные накопители и другие. Команда отмена сопоставления помогает удалить физические блоки из выделения SAN.

## <a name="how-to-use-the-new-api"></a>Как использовать новый API


```
#define FSCTL_FILE_LEVEL_TRIM CTL_CODE(FILE_DEVICE_FILE_SYSTEM, 130, METHOD_BUFFERED, FILE_WRITE_DATA)

Where 
typedef struct _EXTENT_PAIR {
    ULONGLONG Offset;
    ULONGLONG Length;
} EXTENT_PAIR, *PEXTENT_PAIR;

typedef struct _FILE_LEVEL_TRIM {
    //
    // A count of how many Offset:Length pairs are given
    //
    DWORD PairCount;
    //
    // All the pairs.
    //
    EXTENT_PAIR Pairs[1];
} FILE_LEVEL_TRIM, *PFILE_LEVEL_TRIM;
```



УСЕЧЕНИЕ файла передается через буфер, если это возможно или асинхронно (без буферизации) для команды DSM IOCTL устройства. Она сопоставлена с командой TRIM для устройств ATA и командой отмены сопоставления для устройств SCSI. Код УСЕЧЕНИЯ файла отправляет регионы по одному согласно указанным выше экстентам.

УСЕЧЕНИЕ файлов не ждет возврата с устройства, так как команды TRIM и undefined определены как подсказки для базового носителя хранилища и коды возврата не ожидаются.

**Сквозной рабочий процесс:**

1.  Обрезать файл вызова
    1.  УСЕЧЕНИЕ файла. проверяет входные данные на наличие ошибок
    2.  УСЕЧЕНИЕ файлов разбивает экстенты на регионы LCN
    3.  УСЕЧЕНИЕ файла округляет вверх и вниз по неправильным регионам, передаваемым в TRIM
    4.  УСЕЧЕНИЕ файлов очищает записи в кэше, связанные с областями УСЕЧЕНИЯ
    5.  УСЕЧЕНИЕ файлов передает IOCTL \_ DSM (Trim) на регион
2.  УСЕЧЕНИЕ файла Возвращает или ошибку
    1.  Проверка на наличие ошибок выполняется по допустимости входных данных
    2.  Если допустимы только некоторые экстенты, то для полного вызова API возвращается одна ошибка.

**Варианты использования**

**Виртуальный жесткий диск-потребитель (VHD), подключенный к SSD:**

Виртуальный жесткий диск изначально монтируется на чисто неиспользуемом носителе. По мере использования виртуального жесткого диска VHD использует части носителя хранилища для файлов и т. д. При удалении файлов на носителе эти файлы не удаляются из SSD, так как полный виртуальный жесткий диск хранится в виде одного файла на SSD. Среда Hyper-V вызывает УСЕЧЕНИЕ файлов для всех регионов, удаленных при выполнении Delete-file в среде VHD. Усечения файлов \_ преобразуются в SSD, чтобы можно было оптимизировать производительность SSD.

**Потребительский виртуальный жесткий диск, подключенный к виртуальной сети SAN с тонкой подготовкой:**

Виртуальный жесткий диск изначально монтируется на одной минимальной версии среды с тонкой подготовкой. По мере того как файлы хранятся на виртуальном жестком диске, объем хранилища VHD увеличивается на несколько слоев. При удалении файлов на виртуальном жестком диске этот файл обращается \_ к базовой виртуальной сети SAN с тонкой подготовкой. Если обрезка больше, чем гранулярность слоев, SAN теперь может удалить коллекцию и, таким образом, уменьшить объем виртуального жесткого диска в этой сети SAN.

если виртуальный жесткий диск находится на сервере Windows 8, оптимизатор служба хранилища также будет отсылать обрезки, чтобы уменьшить объем памяти виртуального жесткого диска в подключенном виртуальном жестком диске.

## <a name="tests"></a>Тесты

В более ранних выпусках операционной системы нет сопоставимых API. Фактический интерфейс API не должен влиять на производительность, хотя носитель для хранения данных (Если реализован правильно) может улучшить производительность записи. API следует использовать очень осторожно; передаваться только те экстенты, которые больше не нужны, так как эти экстенты будут окончательно удалены с носителя хранилища.

## <a name="resources"></a>Ресурсы

-   [Спецификация T13](http://www.t13.org/Standards/Default.aspx?DocumentType=3)
-   [Спецификация T10 SCSI](https://www.t10.org/)

 

 




