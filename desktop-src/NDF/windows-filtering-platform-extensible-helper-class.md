---
title: Windows Расширяемый вспомогательный класс платформы фильтрации
description: платформа фильтрации Windows (WFP) включает в себя вспомогательный класс инфраструктуры диагностики сети, называемый вспомогательным классом платформы фильтрации (ффк).
ms.assetid: 006ea30c-8682-4a3d-803a-73dba5162696
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ff972beffebb44b33eb68a0439193307639522738ac1f8766845404c03d3cd9c
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119065214"
---
# <a name="windows-filtering-platform-extensible-helper-class"></a>Windows Расширяемый вспомогательный класс платформы фильтрации

[платформа фильтрации Windows (WFP)](/windows/desktop/FWP/windows-filtering-platform-start-page) включает в себя вспомогательный класс инфраструктуры диагностики сети, называемый вспомогательным классом платформы фильтрации (ффк). ФФК может помочь определить основные причины проблем с подключением, вызванных WFP. Сторонние разработчики брандмауэра могут реализовать собственные вспомогательные классы NDF. Расширяемость ФФК позволяет вызывать эти вспомогательные классы сторонних разработчиков во время диагностики.

В этом разделе предполагается знание [API WFP](/windows/desktop/FWP/windows-filtering-platform-start-page).

## <a name="why-extend-the-fphc"></a>Зачем расширять ФФК?

Все разработчики, которые пишут приложения, вызывающие API WFP, должны написать вспомогательный класс NDF, расширяющий ФФК.

ФФК может опознать WFP как причину проблемы с подключением. Если доступно, ФФК также может опознать поставщика, создавшего фильтр, который блокирует сетевой трафик. ФФК передает эти сведения в NDF, который, в свою очередь, может уведомлять пользователя о том, что WFP вызывает проблему с подключением, и дает имя поставщика, блокирующего трафик.

Однако ФФК не может предложить пользователю корректирующее действие и не может указать причину, по которой фильтр блокирует трафик для пользователя. Только расширение ФФК может выполнять эти задачи.

Рассмотрим стороннее приложение брандмауэра, вызывающее API WFP. Если брандмауэр стороннего разработчика реализует расширение ФФК, можно реализовать настраиваемые действия для обработки проблем с подключением, обнаруженных NDF. Когда NDF выполняет диагностику того, что приложение заблокировано брандмауэром стороннего разработчика, расширение ФФК может справиться с блокирующим событием. Одним из способов, которым расширение ФФК может справиться с событием, является предоставление пользователю запроса на разблокировку программы с помощью брандмауэра и последующее разблокирование программы после подтверждения пользователя. Кроме того, расширение ФФК может справиться с событием, уведомляя пользователя о причине блокировки приложения, например о том, что приложение было заблокировано, так как оно было признано вредоносным по в брандмауэре.

## <a name="about-wfp-diagnostics"></a>О диагностике WFP

При вызове NDF для диагностики сетевой проблемы обратитесь к вспомогательным классам, чтобы определить причину проблемы. Если вспомогательный класс более высокого уровня определяет, что сбой сети может быть вызван WFP, он создает гипотезу для ФФК на основе доступной информации. NDF передает эту гипотезу в виде нескольких атрибутов событий в ФФК. Эти атрибуты подробно описаны в разделе [атрибуты событий ФФК](#windows-filtering-platform-extensible-helper-class) ниже.

Сетевую проблему можно описать как проблему подключения, влияющую на конкретную попытки подключения. Например, пользователь случайно заблокировал приложение, непреднамеренно нажимая кнопку **запретить**. Затем брандмауэр блокирует привязку приложения к любому порту. Пользователь, не зная, почему приложение заблокирован, может попытаться диагностировать проблему с помощью точки входа, предлагаемой приложением. ФФК просматривает журналы, и при обнаружении совпадения он извлекает идентификатор фильтра и идентификатор поставщика этого фильтра. На этом этапе ФФК знает, кто является владельцем этого фильтра, и будет передавать диагностический процесс соответствующему вспомогательному классу для дальнейшей диагностики.

Наиболее свежее событие в журналах событий WFP, соответствующее атрибутам, выбирается в соответствии с сетевой проблемой. Если соответствующие события не найдены и когда событие произошло в журнале WFP, ФФК указывает NDF, что он работоспособен. Если соответствующие события не найдены, а журналы WFP не содержат время возникновения события, ФФК возвращает неопределенное состояние в NDF.

Если сопоставленное событие найдено, ФФК использует идентификатор поставщика фильтра, который вызывал событие для идентификации поставщика правила безопасности, которое блокирует подключение. Затем ФФК проверяет, существует ли расширение вспомогательного класса для этого поставщика. Если он найден, ФФК создает гипотезу для этого поставщика, а затем NDF вызывает расширение. Расширение должно возвращать пользователю полезные сведения о диагностике и восстановлении.

## <a name="helper-class-registration"></a>Регистрация вспомогательного класса

Расширение ФФК должно быть зарегистрировано, как описано в статье [Регистрация расширений вспомогательного класса ndf](registering-ndf-helper-class-extensions.md). Разработчики, реализующие вспомогательный класс, должны зарегистрировать свои расширения, чтобы гарантировать, что при необходимости расширение вызывается NDF. *Атрибут сопоставления* , описанный ниже, должен храниться в реестре в разделе **HKLM \\ System \\ CurrentControlSet \\ Control \\ нетдиагфкс** \\ *ИмяПоставщика* \\ **хостдллс** \\ *DLL-библиотеки вспомогательного класса* \\ **хелперклассес** \\ *имя вспомогательного класса* \\ **матчаттрибутес**.

В следующей таблице показан атрибут сопоставления, используемый для задания гипотезы, используемой в диагностике в журнале событий WFP. 

| Имя       | Тип    | Описание                                                                                                                                                                                                                                                                                                 |
|------------|---------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ProviderID | REG \_ SZ | Идентификатор GUID расширения ФФК. Это значение должно совпадать с идентификатором GUID поставщика WFP. <br/> В этой строке учитывается регистр. Он должен храниться в реестре в верхнем регистре с заключенными фигурными скобками и дефисами. Например, {C200E360-38C5-11CE-AE62-08002B2B79EF} является допустимым параметром ProviderID.<br/> |



 

Если значение ProviderID фильтра блокировки совпадает с зарегистрированным вспомогательным классом, ФФК информирует службу NDF о необходимости вызова этого вспомогательного класса, тем самым расширяя возможности диагностики ФФК.

## <a name="fphc-event-attributes"></a>Атрибуты событий ФФК

В следующей таблице перечислены атрибуты событий, связанные с каждым сопоставленным событием. Каждый атрибут события хранится в структуре [**вспомогательного \_ атрибута**](/windows/win32/api/ndattrib/ns-ndattrib-helper_attribute) . Эти атрибуты передаются NDF в ФФК при обнаружении соответствующего события. Они могут передаваться в расширения ФФК.



| attribute     | [**Атрибут \_ Значение типа**](/windows/win32/api/ndattrib/ne-ndattrib-attribute_type) | Описание                                                                                                                               |
|---------------|-------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------|
| GUID поставщика | ПО \_ идентификатору GUID                                        | Идентификатор GUID поставщика, связанного с фильтром.                                                                                      |
| Timestamp     | в \_ строке октета \_                               | Буфер типа FILETIME, указывающий время возникновения события. Эта отметка времени может использоваться для уникальной идентификации события. |
| иппротокол    | В \_ UINT32                                      | Протокол транспортного уровня в формате UINT8.                                                                                            |
| локаладдр     | по адресу \_ SOCKADDR                                    | Локальный IP-адрес и порт, хранимые в структуре [**DIAG \_ SOCKADDR**](/windows/win32/api/ndattrib/ns-ndattrib-diag_sockaddr) .                                             |
| RemoteAddr    | по адресу \_ SOCKADDR                                    | Удаленный IP-адрес и порт, хранимые в структуре [**DIAG \_ SOCKADDR**](/windows/win32/api/ndattrib/ns-ndattrib-diag_sockaddr) .                                            |
| userId        | в \_ строке октета \_                               | Буфер типа SID, представляющий UserID. Если userId имеет длину 0, идентификатор безопасности недоступен.                                        |
| appId         | в \_ строке                                      | Буфер, в котором хранится полученный идентификатор приложения. Если appId имеет значение L "", идентификатор приложения недоступен.        |



 

## <a name="handling-fphc-events"></a>Обработка событий ФФК

Прежде чем предложить пользователю сведения о диагностике и восстановлении, расширение ФФК должно собрать больше данных, чем предоставлено в уведомлениях ФФК. Эти данные могут быть получены из [функций управления событиями WFP](/windows/desktop/FWP/fwp-mgmt-functions). Эти функции демонстрируются в примере [отображения событий NET](/windows/desktop/FWP/displaying-net-events) .

В пакет SDK входит пример более подробного управления событиями. исходный код для примера можно найти в расположении установки пакета sdk в разделе C: \\ Program files \\ Microsoft sdks \\ Windows \\ <version number> \\ samples \\ нетдс \\ WFP \\ диажевентс. пакет SDK для Windows Vista доступен в [центре загрузки](https://www.microsoft.com/downloads/details.aspx?FamilyID=f26b1aa4-741a-433a-9be5-fa919850bdbf).

## <a name="built-in-fphc-diagnostics"></a>Встроенная диагностика ФФК

При отсутствии расширения ФФК ФФК может диагностировать сценарии, перечисленные ниже. Большинство сбоев подключения, которые можно диагностировать с помощью ФФК, возникают, так как брандмауэры блокируют трафик. Сценарии IPsec менее распространены.

В следующей таблице показаны некоторые сценарии, приводящие к сбоям подключения, которые можно диагностировать с помощью ФФК, а также описание и сведения об исправлении, передаваемые NDF.



| Сценарий                   | Описание низкого уровня работоспособности                                                                                                               | Сведения об исправлении                   |
|----------------------------|--------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------|
| Брандмауэр Drop              | Параметры брандмауэра на этом компьютере блокируют подключение.                                                                  | Проверьте параметры брандмауэра.       |
| Сбой основного режима          | Невозможно подключиться из-за несоответствия политики безопасности IPsec.                                                                     | Обратитесь к владельцу политики IPsec.      |
| Сбой быстрого режима         | Невозможно подключиться из-за несоответствия политики безопасности IPsec.                                                                     | Обратитесь к владельцу политики IPsec.      |
| Сбой в пользовательском режиме          | Невозможно подключиться из-за несоответствия политики безопасности IPsec.                                                                     | Обратитесь к владельцу политики IPsec.      |
| Сбой учетных данных         | Невозможно подключиться, так как корневой центр сертификации (ЦС) на этом компьютере не совпадает с корневым ЦС на удаленном компьютере. | Обновите доверенный корневой сертификат. |
| Сертификат с истекшим сроком действия        | Срок действия сертификата, используемого для проверки подлинности IPsec, истек.                                                                           | Запросите сертификат.               |
| Другие сбои сертификатов | Не найден допустимый сертификат для проверки подлинности IPsec.                                                                          | Запросите сертификат.               |
| Сбой Kerberos           | Компьютер не является частью этого домена.                                                                                             | Присоединение этого компьютера к домену.      |
| Общий ключ              | Сбросьте все общие ключи.                                                                                                            | Сбросьте все общие ключи.            |



 

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Платформа фильтрации Windows](/windows/desktop/FWP/windows-filtering-platform-start-page)
</dt> <dt>

[Проектирование расширений вспомогательных классов NDF](designing-ndf-helper-class-extensions.md)
</dt> <dt>

[Регистрация расширений вспомогательного класса NDF](registering-ndf-helper-class-extensions.md)
</dt> <dt>

[Примеры классов поддержки NDF](ndf-helper-class-examples.md)
</dt> </dl>

 

