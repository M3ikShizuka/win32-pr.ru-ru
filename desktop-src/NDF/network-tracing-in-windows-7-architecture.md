---
title: Сетевая трассировка в архитектуре Windows 7
description: На рисунке ниже показана базовая архитектура трассировки сети в Windows 7.
ms.assetid: b3023469-0f98-451c-b39f-c3eae771eacc
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 41221ebf434c05a8c9b7c8489e861128029b5320
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "105672401"
---
# <a name="network-tracing-in-windows-7-architecture"></a>Трассировка сети в Windows 7: архитектура

На рисунке ниже показана базовая архитектура трассировки сети в Windows 7.

![Схема архитектуры трассировки сети](images/ut1.png)

Трассировка сети использует платформу трассировки событий для Windows (ETW), доступную в Windows. Сетевые компоненты (такие как Winsock, TCP/IP, NDIS, пакетная запись и т. д.) регистрируются как поставщики трассировки событий Windows и выдают события, связанные с работой сети. Любое записываемое действие значимости может быть событием, регистрируемым в ETW. Трассировку для этих сетевых компонентов и захватов пакетов можно включить с помощью контекста **трассировки Netsh** , который выступает в качестве контроллера ETW.

Созданные трассировки собираются в файле журнала трассировки событий (ETL). Затем эти ETL-файлы можно проанализировать с помощью ряда средств, таких как сетевой монитор 3,2 и более поздних версий, Просмотр событий, **netsh trace Convert** или Tracerpt.exe.

Каждое событие ETW имеет общий заголовок, в котором ETW хранит такие сведения, как свойства событий, метки времени и ИДЕНТИФИКАТОРы действий. (Дополнительные сведения об идентификаторах действий см. [в разделе Написание связанных событий в сквозном сценарии](../etw/writing-related-events-in-an-end-to-end-scenario.md)). Идентификатор действия используется для корреляции событий. В пользовательском режиме идентификаторы действий хранятся в потоках, и все события, регистрируемые в одном потоке, автоматически помечаются одним и тем же ИДЕНТИФИКАТОРом действия. В режиме ядра идентификатор действия должен быть явно передан при записи события в журнал. По умолчанию ETL-файлы сопоставляются с событиями группировки по конкретным идентификаторам действий.

Дополнительные сведения о событиях Windows и ETW см. в разделе [события Windows](../events/windows-events.md).

## <a name="etw-components-in-network-tracing"></a>Компоненты ETW в трассировке сети

Трассировка сети использует ETW в качестве основного механизма трассировки, чтобы предоставить сведения о том, что делают сетевые подсистемы. В ETW есть четыре основных компонента: сеансы трассировки событий, поставщики событий, контроллеры событий и потребители событий.

Буферизация и ведение журнала происходят в *сеансах трассировки событий*, которые принимают события от поставщиков и создают файлы трассировки.

*Поставщик событий* — это логическая сущность, которая записывает события в сеансы ETW. Поставщик событий может быть приложением пользовательского режима, управляемым приложением, драйвером или любой другой сущностью программного обеспечения. Поставщики событий регистрируются в ETW и записывают события из различных точек в коде, вызывая API ведения журнала ETW. Из-за растущего инструментария событий во многих компонентах операционной системы даже простое приложение или сценарий в Windows будет содержать несколько компонентов, которые являются поставщиками событий.

*Контроллер событий* запускает и останавливает сеансы трассировки событий и включает поставщиков. Когда поставщик событий динамически включается приложением контроллера событий, поставщик отправляет события в определенный сеанс трассировки событий, назначенный контроллером событий. Каждое событие, отправленное поставщиком событий в сеанс трассировки событий, состоит из фиксированного заголовка, который содержит метаданные события и любые дополнительные пользовательские данные, регистрируемые поставщиком.

*Потребитель событий* — это приложение, которое считывает файлы журнала или прослушивает сеанс трассировки событий для событий в реальном времени и обрабатывает их. Одним из примеров потребителей событий является Microsoft Network Monitor 3,2, который включает возможность чтения и просмотра файлов журнала, созданных функцией трассировки сети в Windows 7.

События доставляются потребителям событий в хронологическом порядке, и существуют различные приложения-потребители событий, отображающие события в определенных форматах. Когда событие регистрируется в сеансе, ETW добавляет дополнительные сведения в заголовок события, включая метку времени, идентификатор процесса и потока, номер процессора и данные о загрузке ЦП потока ведения журнала. Затем эти данные передаются потребителям событий, а также пользовательским данным, включенным в поставщик.

Поставщики, использующие новые [API ведения журнала событий](/windows/win32/api/evntprov/nf-evntprov-eventwrite) , должны предоставить XML-файл, который называется [манифестом события](../wes/eventschema-schema.md). Этот файл предоставляет метаданные для определения всех пользовательских данных и макета сведений о событиях, записываемых поставщиком. Затем потребительское приложение общего назначения использует API [-интерфейсы вспомогательных данных трассировки (TDH)](/windows/win32/api/tdh/) для получения метаданных события, расшифровки событий и их вывода.

Благодаря трассировке сети в Windows 7 сервер событий и сторона потребителя включают в себя комплексную поддержку трассировки на основе сценариев, интегрированную с общими возможностями диагностики и поддержки Windows. Сценарий определяет коллекцию поставщиков событий, участвующих в сценарии. На стороне "контроллер событий" и "потребитель" определяются сценарии (контексты), где можно использовать трассировку, включая соответствующие поставщики для заданных сценариев в сетевых компонентах. Сторона поставщика событий включает стандартизированные события трассировки сети из различных компонентов в сетевом стеке, которые можно связать с помощью идентификаторов действий ETW. Поставщики используют общую схему сети, которая стандартизует использование концепций ETW, таких как ключевые слова, уровни, задачи и коды операций. Схема также определяет события, которые являются общими для многих сетевых компонентов, таких как события ошибок, события удаления пакетов, события схемы и события перехода состояния.

 

 