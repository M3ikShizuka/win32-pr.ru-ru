---
title: Опрос изменений с помощью элемента управления DirSync
description: Элемент управления Active Directory Directory Synchronization (DirSync) — это расширение LDAP-сервера, которое позволяет приложению выполнять поиск объектов, измененных с момента предыдущего состояния, в разделе каталога.
ms.assetid: f77caeb3-bfc9-4ae6-8d1d-73f4ee554336
ms.tgt_platform: multiple
keywords:
- Опрос изменений с помощью элемента управления DirSync AD
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8c3d105757d39bc25bd10df21ab68c4d1d1202be
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/17/2020
ms.locfileid: "103789504"
---
# <a name="polling-for-changes-using-the-dirsync-control"></a>Опрос изменений с помощью элемента управления DirSync

Элемент управления Active Directory Directory Synchronization (DirSync) — это расширение LDAP-сервера, которое позволяет приложению выполнять поиск объектов, измененных с момента предыдущего состояния, в разделе каталога.

Используйте элемент управления DirSync через интерфейс ADSI, указав параметры поиска **\_ сеарчпреф \_ DirSync в ADS** при использовании [**IDirectorySearch**](/windows/desktop/api/iads/nn-iads-idirectorysearch). Дополнительные сведения и пример кода см. в разделе [пример кода с использованием ADS \_ сеарчпреф \_ DIRSYNC](example-code-using-ads-searchpref-dirsync.md). Можно также выполнить поиск DirSync с помощью API LDAP. Ниже описана реализация интерфейса ADSI, большинство из которых также применимо непосредственно к использованию LDAP, за исключением случаев, описанных в конце этого раздела.

При выполнении поиска DirSync передается элемент данных (cookie) конкретного поставщика, который определяет состояние каталога во время предыдущего поиска DirSync. При первом поиске вы передаете файл cookie со значением NULL, и поиск возвращает все объекты, соответствующие фильтру. Поиск также возвращает допустимый файл cookie. Сохраните файл cookie в том же хранилище, которое синхронизируется с сервером Active Directory. При последующих операциях поиска получите файл cookie из хранилища и передайте его в поисковый запрос. Результаты поиска теперь включают только те объекты и атрибуты, которые изменились с момента предыдущего состояния, определенного файлом cookie. Поиск также возвращает новый файл cookie для хранения в следующем поиске.

В следующей таблице перечислены параметры поиска, которые может указывать запрос поиска клиента.



| Параметр          | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|--------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| База поиска | База поиска DirSync должна быть корнем раздела каталога, который может быть разделом домена, разделом конфигурации или Секцией схемы.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| Область              | Область поиска DirSync должна быть **\_ \_ поддеревом области объявлений**, то есть всем поддеревом секции. Имейте в виду, что при поиске в разделе предметной области поддерево включает в себя заголовки, но не содержимое разделов конфигурации и схемы. Для опроса изменений в области меньшего размера используйте метод **USNChanged** вместо DirSync.                                                                                                                                                                                                                                                                                                                                                                                 |
| Фильтр             | Можно указать любой допустимый фильтр поиска. Для первоначального поиска с нулевым файлом cookie результаты включают все объекты, соответствующие фильтру. Для последующих поисков с допустимым файлом cookie результаты поиска включают только те объекты, которые соответствуют фильтру и были изменены после состояния, указанного в файле cookie. Дополнительные сведения о фильтрах поиска см. [в разделе Создание фильтра запросов](creating-a-query-filter.md).                                                                                                                                                                                                                                                                                                                |
| Атрибуты         | Можно указать список атрибутов, возвращаемых при возникновении изменений. Для каждого объекта первоначальные результаты включают все запрошенные атрибуты, заданные для объекта. Последующие результаты поиска включают только указанные атрибуты, которые были изменены. Неизмененные атрибуты не включаются в результаты поиска. В реализации ADSI результаты поиска всегда содержат **objectGUID** и **instanceType** каждого объекта. Кроме того, указанный список атрибутов выступает в качестве дополнительного фильтра: первоначальные результаты поиска включают только объекты, для которых установлен хотя бы один из указанных атрибутов. последующие поисковые запросы включают только те объекты, в которых изменился один или несколько атрибутов (добавленные или удаленные значения). |



 

Кроме того, имейте в виду, что:

-   Для добавочного поиска рекомендуется выполнить привязку к тому же контроллеру домена, который использовался в предыдущем поиске, то есть КОНТРОЛЛЕРом домена, создавшим файл cookie. Если один и тот же контроллер домена недоступен, дождитесь его завершения или выполните привязку к новому контроллеру домена и выполните полную синхронизацию. Сохраните DNS-имя контроллера домена в дополнительном хранилище с помощью файла cookie.

    Файл cookie, созданный одним контроллером домена, можно передать другому контроллеру домена, содержащему реплику того же раздела каталога. Не существует шанса, что клиент будет пропускать изменения с помощью файла cookie с одного контроллера домена на другом. Однако возможно, что результаты поиска с нового контроллера домена могут содержать сведения об изменениях старого контроллера домена. в некоторых случаях новый контроллер домена может возвращать все объекты и атрибуты, как и при полной синхронизации. Клиент должен просто сделать свою базу данных в соответствии с полученными результатами поиска для любого вызова DirSync, то есть обрабатывали все добавочные результаты, как если бы они были последними состояниями. Не имеет значения, было ли рассмотрено изменение до или даже переход к предыдущему состоянию, так как повторные добавочные синхронизации будут согласованы по сравнению.

-   При переименовании или перемещении объекта его дочерние объекты (если таковые имеются) не включаются в результаты поиска, несмотря на то, что изменились различающиеся имена дочерних объектов. Аналогично, при изменении наследуемого ACE в дескрипторе безопасности объекта дочерние объекты объекта не включаются в результаты поиска, даже если изменились дескрипторы безопасности дочерних объектов.
-   Используйте атрибут **objectGUID** для обнаружения объектов, на которые отписываются объекты. **ObjectGUID** каждого объекта остается неизменным независимо от места перемещения объекта в пределах леса.
-   Имейте в виду, что результаты поиска DirSync указывают состояние объектов в реплике раздела каталога на момент поиска. Это означает, что изменения, внесенные в другие контроллеры домена, не будут включены, если они не были реплицированы на целевой контроллер домена. Это также означает, что атрибуты объекта могли измениться несколько раз с момента предыдущего поиска DirSync, но поиск будет показывать только конечное состояние, а не последовательность изменений.
-   В реализации ADSI приложение должно управлять файлом cookie как непрозрачным и не делать никаких предположений относительно внутренней организации или ценности.
-   Имейте в виду, что клиент сохраняет файлы cookie, длину файлов cookie и DNS-имя контроллера домена в том же хранилище, которое содержит синхронизированные данные объекта. Это гарантирует, что файлы cookie и другие параметры будут синхронизированы с данными объекта, если хранилище восстанавливается из резервной копии.
-   Чтобы получить атрибут [**парентгуид**](/windows/desktop/ADSchema/a-parentguid) , который создается для элемента управления DirSync, также необходимо запросить атрибут [**Name**](/windows/desktop/ADSchema/a-name) .

Чтобы использовать элемент управления DirSync, вызывающий объект должен иметь право "Directory Get Changes", назначенное в корне отслеживаемой секции. По умолчанию это право назначается учетным записям администратора и LocalSystem на контроллерах домена. У вызывающего объекта также должна быть права на расширенный контроль доступа [**DS-Replication-Get-Changes**](/windows/desktop/ADSchema/r-ds-replication-get-changes) . Дополнительные сведения о реализации механизма отслеживания изменений для приложений, которые должны выполняться под учетной записью, не имеющей этого права, см. в разделе [опрос изменений с помощью USNChanged](polling-for-changes-using-usnchanged.md). Дополнительные сведения о привилегиях см. в разделе [привилегии](/windows/desktop/SecAuthZ/privileges).

## <a name="retrieving-deleted-objects-with-a-dirsync-search"></a>Получение удаленных объектов с помощью поиска DirSync

Результаты поиска в **ADS \_ сеарчпреф \_ DIRSYNC** автоматически включают удаленные объекты (захоронения), соответствующие заданному фильтру поиска. Однако фильтр поиска, который будет сопоставлять объект в режиме реального времени, может не соответствовать объекту после его удаления. Это обусловлено тем, что объекты-захоронения сохранены только подмножество атрибутов, имеющихся в исходном объекте. Например, для объектов User обычно используется следующий фильтр.


```C++
(&(objectClass=user)(objectCategory=person))
```



Атрибут **objectCategory** удаляется при удалении объекта, поэтому приведенный выше фильтр не будет соответствовать ни одному из объектов-захоронений. И наоборот, атрибут **objectClass** сохраняется для объектов-захоронений, поэтому фильтр "(objectClass = User)" будет соответствовать удаленным пользовательским объектам.

Список атрибутов, указываемый с помощью поиска DirSync, также выступает в качестве фильтра. Результаты поиска включают только те объекты, в которых один или несколько указанных атрибутов были изменены с момента предыдущего поиска DirSync. Если список атрибутов не включает атрибуты, которые хранятся на отметках полного удаления, результаты поиска не будут включать отметки полного удаления. Чтобы справиться с этим, запросите все атрибуты, указав список атрибутов со значением NULL. или же можно запросить атрибут **IsDeleted** , задать значение **true** для всех объектов-захоронений. Атрибуты захоронения имеют бит 0x8, заданный в атрибуте **searchFlags** определения **attributeSchema** .

Дополнительные сведения см. в разделе [получение удаленных объектов](retrieving-deleted-objects.md).

## <a name="ldap-implementation-of-the-dirsync-control"></a>Реализация LDAP элемента управления DirSync

Можно также выполнить поиск DirSync с помощью API LDAP с элементом управления [ \_ \_ DirSync \_ сервера LDAP](/previous-versions/windows/desktop/ldap/ldap-server-dirsync-oid) . При использовании API LDAP также укажите для LDAP- [ \_ сервера \_ Расширенное \_ DN \_ OID](/previous-versions/windows/desktop/ldap/ldap-server-extended-dn-oid) и [сервер LDAP \_ \_ Отображение \_ удаленных \_ ](/previous-versions/windows/desktop/ldap/ldap-server-show-deleted-oid) элементов управления OID. \_ \_ Управляющий элемент расширенного DN-объекта LDAP-сервера \_ \_ позволяет поисковому протоколу LDAP вернуть расширенную форму различающегося имени, включающее **objectGUID** и **objectSid** для объектов субъекта безопасности, таких как пользователи, группы и компьютеры. Сервер LDAP \_ \_ отображает \_ Удаленный \_ элемент управления OID, в результате чего результаты поиска включаются в данные удаленных объектов. Имейте в виду, что эти элементы управления автоматически включаются в реализацию ADSI.

 

 