---
title: взаимная проверка подлинности в службе сокетов Windows с SCP
description: В подразделах этого раздела приведены примеры кода, демонстрирующие выполнение взаимной проверки подлинности со службой, которая публикует себя с помощью точки подключения службы (SCP).
ms.assetid: f730464c-95ac-4285-960c-18862f6f7852
ms.tgt_platform: multiple
keywords:
- взаимная проверка подлинности в службе сокетов Windows с помощью SCP AD
- Active Directory, использование, взаимная проверка подлинности, Windows служба сокетов с SCP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: be8f3e65b044198c5ebf703b1c62ac03eb07a4d57b6bc5dcf7c5463247815f1b
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119025772"
---
# <a name="mutual-authentication-in-a-windows-sockets-service-with-scp"></a>взаимная проверка подлинности в службе сокетов Windows с SCP

В подразделах этого раздела приведены примеры кода, демонстрирующие выполнение взаимной проверки подлинности со службой, которая публикует себя с помощью точки подключения службы (SCP). примеры основаны на службе сокетов Microsoft Windows, которая использует пакет SSPI для выполнения согласования взаимной проверки подлинности между клиентом и службой. Используйте следующие процедуры для реализации взаимной проверки подлинности в этом сценарии.

**Регистрация имен участников-служб в каталоге при установке службы**

1.  Вызовите функцию [**дсжетспн**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsgetspna) , чтобы создать имена субъектов-служб (SPN) для службы.
2.  Вызовите функцию [**дсвритеаккаунтспн**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dswriteaccountspna) , чтобы зарегистрировать имена участников-служб в учетной записи службы или компьютера, в контексте которой будет выполняться служба. Этот шаг должен выполняться администратором домена. исключением является то, что служба, работающая под учетной записью LocalSystem, может зарегистрировать свое имя участника-службы в форме " <service class> / <host> " в учетной записи компьютера узла службы.

**Проверка конфигурации при запуске службы**

-   Убедитесь, что соответствующие имена участников-служб зарегистрированы в учетной записи, от имени которой запущена служба. Дополнительные сведения см. в разделе [задачи обслуживания учетной записи входа](logon-account-maintenance-tasks.md).

**Проверка подлинности службы при запуске клиента**

1.  Получение данных подключения из точки подключения службы службы.
2.  Установите соединение со службой.
3.  Вызовите функцию [**дсмакеспн**](/windows/desktop/api/Dsparse/nf-dsparse-dsmakespna) , чтобы составить имя субъекта-службы. Составьте имя субъекта-службы из известной строки класса службы и данные, полученные из точки подключения службы. Эти данные включают имя узла сервера, на котором запущена служба. Имейте в виду, что имя узла должно быть DNS-именем.
4.  Используйте пакет безопасности SSPI для выполнения проверки подлинности:
    1.  Вызовите функцию [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) , чтобы получить учетные данные клиента.
    2.  Передайте учетные данные клиента и имя участника-службы в функцию [**InitializeSecurityContext**](../SecAuthN/initializesecuritycontext--general.md) , чтобы создать большой двоичный объект безопасности для отправки в службу для проверки подлинности. Установите флаг **\_ \_ взаимной проверки \_ подлинности ISC** , чтобы запросить взаимную проверку подлинности.
    3.  Exchange большие двоичные объекты со службой до завершения проверки подлинности.
5.  Проверьте возвращенную маску возможностей для флага **\_ \_ взаимной проверки \_ подлинности ISC** , чтобы убедиться, что была выполнена взаимная проверка подлинности.
6.  Если проверка подлинности прошла успешно, необходимо обмениваться данными с аутентифицированной службой. Используйте цифровое подписывание, чтобы гарантировать, что сообщения между клиентом и службой не были изменены. Если требования к производительности не являются серьезными, используйте шифрование. Дополнительные сведения и пример кода, демонстрирующий использование функций [**макесигнатуре**](/windows/desktop/api/sspi/nf-sspi-makesignature), [**VerifySignature**](/windows/desktop/api/sspi/nf-sspi-verifysignature), [**ЕНКРИПТМЕССАЖЕ**](../SecAuthN/encryptmessage--general.md)и [**декриптмессаже**](../SecAuthN/decryptmessage--general.md) в пакете SSPI, см. в разделе [обеспечение целостности связи во время Exchange сообщений](/windows/desktop/SecAuthN/ensuring-communication-integrity-during-message-exchange).

**Проверка подлинности клиента службой при подключении клиента**

1.  Загрузите пакет безопасности SSPI, поддерживающий взаимную проверку подлинности.
2.  При подключении клиента используйте пакет безопасности для выполнения проверки подлинности:
    1.  Вызовите функцию [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) , чтобы получить учетные данные службы.
    2.  Передайте учетные данные службы и большой двоичный объект, полученный от клиента, в функцию [**AcceptSecurityContext**](../SecAuthN/acceptsecuritycontext--general.md) , чтобы создать большой двоичный объект безопасности для отправки обратно клиенту.
    3.  Exchange большие двоичные объекты с клиентом до завершения проверки подлинности.
3.  Проверьте возвращенную маску возможностей для флага **\_ \_ взаимной проверки \_ подлинности ASC RET** , чтобы убедиться, что была выполнена взаимная проверка подлинности.
4.  Если проверка подлинности прошла успешно, то обмен данными с аутентифицированным клиентом проходит. Используйте цифровые подписи и шифрование, если нет проблем с производительностью.

Дополнительные сведения и пример кода для этого сценария взаимной проверки подлинности см. в следующих статьях:

-   [проверка подлинности клиента службы сокетов Windows на основе SCP](how-a-client-authenticates-an-scp-based-windows-sockets-service.md)
-   [составление и регистрация имен участников-служб для службы сокетов Windows на основе SCP](composing-and-registering-spns-for-an-scp-based-windows-sockets-service.md)
-   [проверка подлинности клиента службой сокетов Windows](how-a-windows-sockets-service-authenticates-a-client.md)

Дополнительные сведения см. в разделе:

-   [Публикация с точками подключения службы](publishing-with-service-connection-points.md)
-   [Документация по SSPI](/windows/desktop/SecAuthN/sspi)
-   [Windows Документация по сокетам](/windows/desktop/WinSock/windows-sockets-start-page-2)

 

 