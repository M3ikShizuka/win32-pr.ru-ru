---
description: Диспетчер управления службами (SCM) управляет службой, отправляя события управления службами в подпрограммы обработчика управления службами.
ms.assetid: 86e04b43-5f6f-409e-ac18-d7efada4d3d3
title: Многопоточные службы
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5795a170f912050d115537407fcb491305a35ba3
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105664200"
---
# <a name="multithreaded-services"></a>Многопоточные службы

Диспетчер управления службами (SCM) управляет службой, отправляя события управления службами в подпрограммы обработчика управления службы. Служба должна своевременно реагировать на события управления, чтобы диспетчер SCM мог контролировать состояние службы. Кроме того, состояние службы должно соответствовать описанию состояния, которое получает диспетчер SCM.

Из-за этого механизма связи между службой и SCM необходимо соблюдать осторожность при использовании нескольких потоков в службе. Когда служба передается службе SCM, она должна ждать завершения всех потоков, прежде чем сообщить службе SCM о том, что служба остановлена. В противном случае SCM может стать запутанным о состоянии службы и может не завершить работу правильно.

SCM должен получать уведомления о том, что служба отвечает на событие остановки управления и выполняется в процессе остановки службы. SCM считает, что служба выполняется, если служба отвечает (через [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus)) в течение времени (Подсказка ожидания), указанной в предыдущем вызове **сбой SetServiceStatus**, а контрольная точка обновляется так, чтобы она превышала контрольную точку, указанную в предыдущем вызове **сбой SetServiceStatus**.

Если служба сообщает SCM о том, что служба остановлена до того, как все потоки завершились, возможно, SCM будет интерпретировать это как противоречие. Это может привести к состоянию, в котором служба не может быть остановлена или перезапущена.

 

 



