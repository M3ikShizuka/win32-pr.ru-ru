---
description: Служба может зарегистрироваться для запуска или остановки при возникновении события триггера.
ms.assetid: ca02a3ae-b16a-4427-b6db-b935c9cf23b3
title: События триггера службы
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 67b6c219f91668af3372cf6c50b005d544a2544232d83e2e215d50a194db95b8
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "117967267"
---
# <a name="service-trigger-events"></a>События триггера службы

Служба может зарегистрироваться для запуска или остановки при возникновении события триггера. Это устраняет необходимость запуска служб при запуске системы или для опроса или активного ожидания события в службах. Служба может запускаться при необходимости, а не запускать автоматически независимо от того, есть ли у вас работа. Примеры предопределенных событий триггера включают поступление устройства указанного класса интерфейса устройства или доступность конкретного порта брандмауэра. служба также может зарегистрироваться для создания пользовательского события триггера, созданного с помощью [трассировки событий для поставщика Windows](../etw/event-tracing-portal.md) (ETW).

**Windows server 2008, Windows Vista, Windows Server 2003 и Windows XP:** события триггера службы не поддерживаются до Windows Server 2008 R2 и Windows 7.

Триггер состоит из типа события триггера, подтипа события триггера, действия, выполняемого в ответ на событие триггера, и (для определенных типов событий триггера) одного или нескольких элементов данных, относящихся к триггеру. Вместе с подтипами и элементами данных, зависящими от триггеров, указываются условия для уведомления службы о событии. Формат элемента данных зависит от типа события триггера. элемент данных может быть двоичными данными, строкой или многострочной. Строки должны быть в Юникоде. Строки ANSI не поддерживаются.

Для регистрации событий триггера служба вызывает [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) со **\_ \_ \_ сведениями о триггере конфигурации службы** и предоставляет [**\_ \_ информационную структуру триггера службы**](/windows/desktop/api/winsvc/ns-winsvc-service_trigger_info) . Структура **\_ \_ сведений о триггере службы** указывает на массив структур [**\_ триггеров служб**](/windows/desktop/api/winsvc/ns-winsvc-service_trigger) , каждый из которых указывает один триггер.

Заданное действие триггера принимается, если условие триггера имеет значение true при запуске системы или если условие триггера принимает значение true во время работы системы. Например, если служба регистрируется для запуска при наличии определенного устройства, служба запускается при запуске системы, если устройство уже подключено к компьютеру. Служба запускается при появлении устройства, когда пользователь подключается к устройству во время работы системы.

Если триггер содержит элементы данных, относящиеся к триггеру, действие триггера выполняется только в том случае, если элемент данных, сопровождающий событие Trigger, соответствует одному из элементов данных, указанных в службе с триггером. Сопоставление двоичных данных выполняется побитовым сравнением. Сопоставление строк не учитывает регистр. Если элемент данных является многострочным, все строки в многострочной строке должны совпадать.

Когда служба запускается в ответ на событие триггера, служба получает в качестве аргумента *argv* в своей функции обратного вызова функцию " **\_ \_ Started \_ " триггера службы** \[ \] . [](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) *Argv* \[ 0 \] всегда является коротким именем службы.

Служба, которая регистрируется для запуска в ответ на событие триггера, может прекращать свою работу после истечения времени простоя, когда служба не работает. Служба, которая останавливается, должна быть подготовлена к обработке запросов контроля **\_ \_ тригжеревент управления службами** , поступающих во время остановки службы. SCM отправляет запрос на **Управление \_ \_ тригжеревент управления службой** всякий раз, когда возникает новое событие триггера, когда служба находится в состоянии выполняется. Чтобы избежать потери событий триггера, служба должна возвращать **ошибку \_ завершения работы \_ \_** для любого управляющего запроса **\_ \_ тригжеревент управления службой** , который поступает во время перехода службы из состояния выполнения в остановленную. Это дает диспетчеру управления службами команду ставить в очередь события триггера и дожидаться перехода службы в остановленное состояние. Затем SCM выполняет действие, связанное с событием триггера в очереди, например запуск службы.

Когда служба будет готова к обработке событий триггера, она задается в параметре **\_ Accept \_ тригжеревент** в элементах управления — принимает маску в вызове [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus). Обычно это делается, когда служба вызывает **сбой SetServiceStatus** с **\_ работающей службой**. После этого диспетчер SCM выдает запрос на **\_ \_ тригжеревент управления службой** для каждого события триггера, помещенного в очередь, пока очередь не будет пуста.

Служба, в которой запущены зависимые службы, не может быть остановлена в ответ на событие триггера.

В условиях нехватки памяти не гарантируется выполнение запросов триггера и триггера.

Используйте функцию [**QueryServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-queryserviceconfig2a) для получения конфигурации события триггера службы.

Средство SC (sc.exe) можно использовать для настройки или запроса событий триггера службы в командной строке. Используйте параметр **тригжеринфо** , чтобы настроить службу для запуска или завершения в ответ на событие триггера. Используйте параметр **ктригжеринфо** для запроса конфигурации триггера службы.

В следующем примере выполняется запрос конфигурации триггера службы W32Time, которая настроена на запуск при присоединении компьютера к домену, и останавливается, когда компьютер покидает домен.

``` syntax
C:\>sc qtriggerinfo w32time
[SC] QueryServiceConfig2 SUCCESS

SERVICE_NAME: w32time

        START SERVICE
          DOMAIN JOINED STATUS         : 1ce20aba-9851-4421-9430-1ddeb766e809 [DOMAIN JOINED]
        STOP SERVICE
          DOMAIN JOINED STATUS         : ddaf516e-58c2-4866-9574-c3b615d42ea1 [NOT DOMAIN JOINED]
```

В следующем примере выполняется запрос конфигурации триггера для службы ввода планшета, которая настроена на запуск при появлении устройства HID с **идентификатором GUID** {4d1e55b2-f16f-11CF-88cb-001111000030} и любым из указанных идентификаторов устройств HID.

``` syntax
C:\>sc qtriggerinfo tabletinputservice
[SC] QueryServiceConfig2 SUCCESS

SERVICE_NAME: tabletinputservice

        START SERVICE
          DEVICE INTERFACE ARRIVAL     : 4d1e55b2-f16f-11cf-88cb-001111000030 [INTERFACE CLASS GUID]
            DATA                       : HID_DEVICE_UP:000D_U:0001
            DATA                       : HID_DEVICE_UP:000D_U:0002
            DATA                       : HID_DEVICE_UP:000D_U:0003
            DATA                       : HID_DEVICE_UP:000D_U:0004
```

 

 
