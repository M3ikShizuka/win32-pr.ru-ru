---
description: Чтобы запустить службу или службу драйвера, программа управления службами использует функцию StartService.
ms.assetid: 7d2ee779-1554-436a-a65c-f0322745f46a
title: Запуск службы
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 17901987581b6a2680e0a70cfe2e0ed80472d293cbe32932f768e9133b6a058d
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118888703"
---
# <a name="service-startup"></a>Запуск службы

Чтобы запустить службу или службу драйвера, программа управления службами использует функцию [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) . Функция **StartService** завершается ошибкой, если база данных заблокирована. В этом случае программа управления службой должна подождать несколько секунд и вызвать функцию **StartService** еще раз. Он может проверить текущее состояние блокировки базы данных, вызвав функцию [**куерисервицелоккстатус**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicelockstatusa) .

Если программа управления службами запускает службу, она может использовать функцию [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) для указания массива аргументов, передаваемых в функцию [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) службы. Функция **StartService** возвращает после создания нового потока для выполнения функции **ServiceMain** . Программа управления службами может получить состояние недавно запущенной службы в структуре [**\_ состояния службы**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) , вызвав функцию [**куерисервицестатус**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) . Во время инициализации элемент **двкуррентстате** должен находиться \_ \_ в состоянии ожидания запуска службы. Элемент **двваисинт** — это интервал времени в миллисекундах, указывающий, как долго программа управления службами должна ожидать перед вызовом **куерисервицестатус** . Когда инициализация завершится, служба изменится **двкуррентстате** на "Служба \_ запущена".

Диспетчер управления службами не поддерживает передачу пользовательских переменных среды в службу при запуске. Кроме того, диспетчер управления службами не обнаруживает и не передает изменения переменных среды, так как служба выполняется. Вместо того, чтобы сделать службу зависимой от переменной среды, используйте значения реестра или аргументы [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) .

Ниже приведен упрощенный обзор того, что происходит при запуске обычной службы диспетчером управления службами.

-   SCM считывает путь службы из реестра и готовится к запуску службы. Это включает в себя получение блокировки службы. Любая попытка запуска другой службы во время удержания блокировки службы будет заблокирована до тех пор, пока не будет снята блокировка службы.
-   SCM запускает процесс и ожидает, пока не завершится завершение работы дочернего процесса (что указывает на сбой), или сообщает о \_ состоянии запуска службы.
-   Приложение выполняет очень простую инициализацию и вызывает функцию [**сбой StartServiceCtrlDispatcher**](/windows/desktop/api/Winsvc/nf-winsvc-startservicectrldispatchera) .
-   [**Сбой StartServiceCtrlDispatcher**](/windows/desktop/api/Winsvc/nf-winsvc-startservicectrldispatchera) подключается к диспетчеру управления службами и запускает второй поток, который вызывает функцию [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) для службы. **ServiceMain** должен как можно быстрее сообщить о том, что служба \_ работает.
-   Когда диспетчер управления службами уведомляется о том, что служба запущена, она освобождает блокировку службы.

Если служба не обновляет состояние в течение 80 секунд, а также Последнее указание Wait, диспетчер управления службами определит, что служба перестала отвечать на запросы. Диспетчер управления службами регистрирует событие и останавливает службу.

Если программа запускает службу драйвера, функция [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) возвращает значение после завершения инициализации драйвера устройства.

Дополнительные сведения см. в разделе [Запуск службы](starting-a-service.md).

 

 
