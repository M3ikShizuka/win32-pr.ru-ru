---
description: Когда программа управления службой запрашивает выполнение новой службы, диспетчер управления службами (SCM) запускает службу и отправляет запрос на запуск диспетчеру управления.
ms.assetid: e55e056f-7628-4e3d-9aea-b55c371b4287
title: Функция ServiceMain службы
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ed50f0f378f348415e56827a09fcf17eea7fc330
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103999391"
---
# <a name="service-servicemain-function"></a>Функция ServiceMain службы

Когда программа управления службой запрашивает выполнение новой службы, диспетчер управления службами (SCM) запускает службу и отправляет запрос на запуск диспетчеру управления. Диспетчер управления создает новый поток для выполнения функции [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) для службы. Пример см. в разделе [написание функции ServiceMain](writing-a-servicemain-function.md).

Функция [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) должна выполнять следующие задачи:

1.  Инициализируйте все глобальные переменные.
2.  Немедленно вызовите функцию [**регистерсервицектрлхандлер**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) , чтобы зарегистрировать функцию [**обработчика**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) для обработки управляющих запросов для службы. Возвращаемое значение **регистерсервицектрлхандлер** — это *обработчик состояния службы* , который будет использоваться в вызовах для уведомления SCM о состоянии службы.
3.  Выполните инициализацию. Если время выполнения кода инициализации должно быть очень коротким (менее одной секунды), инициализацию можно выполнить непосредственно в [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona).

    Если время инициализации должно быть длиннее одной секунды, служба должна использовать один из следующих методов инициализации:

    -   Вызовите функцию [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) , чтобы сообщить службе о запуске службы, \_ но не принимать элементы управления, пока не завершится инициализация. Эта служба делает это, вызывая **сбой SetServiceStatus** с параметром **ДВКУРРЕНТСТАТЕ** , чтобы служба \_ выполнялась, а **двконтролсакцептед** — значение 0 в структуре [**\_ состояния службы**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) . Это гарантирует, что SCM не будет отсылать управляющие запросы службе, прежде чем она будет готова и освободит SCM для управления другими службами. Этот подход к инициализации рекомендуется для повышения производительности, особенно для служб автозапуска.
    -   Служба отчетов \_ \_ ожидает запуска, не принимает элементы управления и укажите указание ожидания. Если код инициализации службы выполняет задачи, которые должны занимать больше времени, чем начальное значение указания Wait, код должен периодически вызывать функцию [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) (возможно, с измененным указанием о дождитесь), чтобы указать, что выполняется. Не забудьте вызвать **сбой SetServiceStatus** только в том случае, если инициализация продвигается. В противном случае SCM может ожидать перехода службы в \_ состояние выполнения, предполагая, что служба выполняется и блокирует запуск других служб. Не вызывайте **сбой SetServiceStatus** из отдельного потока, если вы не уверены, что поток, выполняющий инициализацию, действительно делает ход выполнения.

        Служба, использующая такой подход, также может задавать значение контрольной точки и периодически увеличивать значение при продолжительной инициализации. Программа, запускающая службу, может вызвать [**куерисервицестатус**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) или [**куерисервицестатусекс**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatusex) , чтобы получить Последнее значение контрольной точки из SCM и использовать значение для передачи пользователю добавочного хода выполнения.

4.  По завершении инициализации вызовите [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) , чтобы настроить состояние службы на "Служба \_ запущена" и указать элементы управления, которые служба должна принять. Список элементов управления см. в разделе Структура [**\_ состояния службы**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) .
5.  Выполните задачи службы или, если нет ожидающих задач, верните управление вызывающему объекту. Любые изменения в состоянии службы гарантируют вызов [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) для сообщения о новых сведениях о состоянии.
6.  Если во время инициализации или запуска службы произошла ошибка, служба должна вызвать [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) , чтобы настроить состояние службы на \_ Ожидание службы, \_ Если очистка будет длительной. После завершения очистки вызовите **сбой SetServiceStatus** , чтобы установить состояние службы \_ остановлено с последнего потока для завершения. Не забудьте задать члены **двсервицеспеЦифицекситкоде** и **DwWin32ExitCode** структуры [**\_ состояния службы**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) , чтобы определить ошибку.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Написание функции ServiceMain](writing-a-servicemain-function.md)
</dt> </dl>

 

 
