---
description: 'Дополнительные сведения: полный пример службы'
ms.assetid: a3aeea9b-09c0-4834-892a-c378b67402f4
title: Полный пример службы
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a1f3f5fc0fb59342841a9d1f1280475ace12c54998d59e5f36a19557f0ccc5c3
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118888335"
---
# <a name="the-complete-service-sample"></a>Полный пример службы

Темы в этом разделе образуют полный пример службы:

-   [Sample.MC](sample-mc.md) (содержит сообщения об ошибках)
-   [SVC. cpp](svc-cpp.md) (содержит код службы)
-   [Свкконфиг. cpp](svcconfig-cpp.md) (содержит код конфигурации службы)
-   [Свкконтрол. cpp](svccontrol-cpp.md) (содержит код управления службами)

## <a name="building-the-service"></a>Создание службы

Следующая процедура описывает, как создать службу и зарегистрировать БИБЛИОТЕКУ сообщений о событиях.

**Создание службы и регистрация библиотеки DLL сообщений о событиях**

1.  Создайте библиотеку DLL сообщений из Sample.mc, выполнив следующие действия.
    1.  **MC-U sample.mc**
    2.  **RC-r Sample. RC**
    3.  **Link-DLL--out:sample.dll Sample. Res**
2.  Создавайте Svc.exe, SvcConfig.exe и SvcControl.exe из SVC. cpp, Свкконфиг. cpp и Свкконтрол. cpp соответственно.
3.  Создайте раздел реестра **hKey \_ локальный \_ компьютер \\ System \\ CurrentControlSet \\ Services \\ EventLog \\ \\ SvcName** и добавьте в этот раздел следующие значения реестра.

    | Значение                              | Тип       | Описание                                                                                                        |
    |------------------------------------|------------|--------------------------------------------------------------------------------------------------------------------|
    | **Евентмессажефиле**  =  *\_ путь к библиотеке DLL* | REG \_ SZ    | Путь к библиотеке DLL, содержащей только ресурсы, которые содержат строки, которые служба может записать в журнал событий.               |
    | **Типессуппортед** = 0x00000007    | REG \_ DWORD | Битовая маска, указывающая Поддерживаемые типы событий. Значение 0x000000007 указывает, что поддерживаются все типы. |

    

     

## <a name="testing-the-service"></a>Тестирование службы

В следующей процедуре описывается тестирование службы.

**Проверка службы**

1.  В панели управления запустите приложение **службы** . (В следующих шагах используйте клавишу F5, чтобы обновить отображение после выполнения команды, которая изменяет сведения в приложении **служб** .)
2.  Выполните следующую команду, чтобы установить службу:

    **Установка SVC**

    Служба в консоли производит запись "служба успешно установлена", если операция выполняется успешно, или в противном случае — сообщение об ошибке.

    Если установка службы будет выполнена, служба отобразится в приложении **службы** . Обратите внимание, что для **Name** задано значение "SvcName", **Описание** и **состояние** пусты, а для **типа запуска** задано значение "вручную".

3.  Выполните следующую команду, чтобы запустить службу:

    **свкконтрол запустить SvcName**

    Если операция выполнена, программа управления службой запишет "Ожидание запуска службы..." а затем "служба успешно запущена" на консоли. В противном случае программа записывает сообщение об ошибке в консоль.

    Если служба успешно запускается, для параметра **Status** задается значение "запущено". Код функции [*ServiceMain*](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) выполняется SCM. При возникновении ошибки служба будет записывать сообщение об ошибке в журнал событий. Это сообщение содержит имя функции, которая завершилась ошибкой, и код ошибки, возвращенный в случае сбоя.

4.  Выполните следующую команду, чтобы обновить описание службы:

    **свкконфиг описание SvcName**

    Программа настройки службы записывает сообщение "описание службы успешно обновлено" на консоль, если операция выполнена успешно, или в противном случае — сообщения об ошибке.

    Если обновление завершилось с ошибкой, в поле **Описание** задается значение "это описание теста".

5.  Выполните следующую команду, чтобы запросить конфигурацию службы:

    **свкконфиг запрос SvcName**

    Программа настройки службы записывает сведения о конфигурации службы в консоль при условии, что операция завершилась с ошибкой, или в противном случае — сообщение об ошибке.

6.  Чтобы изменить список DACL службы, выполните следующую команду:

    **свкконтрол DACL SvcName**

    Программа настройки службы выполняет запись "DACL службы успешно обновлена" на консоль, если операция выполнена успешно, или в противном случае — сообщение об ошибке.

7.  Чтобы отключить службу, выполните следующую команду:

    **свкконфиг отключить SvcName**

    Программа настройки службы в консоли выполняет запись "служба отключена успешно", если операция выполняется успешно, или в противном случае — сообщение об ошибке.

    Если служба успешно отключена, для параметра **Тип запуска** задается значение Disabled (отключено).

8.  Чтобы включить службу, выполните следующую команду:

    **свкконфиг включить SvcName**

    Программа настройки службы в консоли записывает "служба успешно включена", если операция выполняется успешно, или в противном случае — сообщение об ошибке.

    Если служба успешно включена, для параметра **Тип запуска** устанавливается значение вручную.

9.  Чтобы отключить службу, выполните следующую команду:

    **свкконтрол останавливает SvcName**

    Если операция завершится с ошибкой, программа управления службой запишет "ожидание службы ожидается..." а затем "служба успешно остановлена" на консоли. В противном случае программа записывает сообщение об ошибке в консоль.

    Если служба завершается успешно, **состояние** остается пустым.

    Если не удается завершить работу службы, программа управления службой записывает в журнал событий сообщение об ошибке, содержащее имя функции, которая завершилась ошибкой, и код ошибки, возвращенный в случае сбоя.

10. Выполните следующую команду, чтобы удалить службу:

    **свкконфиг удалить SvcName**

    Программа настройки службы записывает "служба успешно удалена" на консоль, если операция выполняется успешно, или в противном случае — сообщение об ошибке.

    Если служба успешно удалена, она больше не отображается в приложении **службы** . (Обратите внимание, что при попытке удалить службу, которая не остановлена, операция завершается с ошибкой, но для параметра **Тип запуска** устанавливается значение "отключено", а запись службы будет удалена при перезапуске системы или при завершении работы службы с помощью диспетчера задач.)

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Использование служб](using-services.md)
</dt> </dl>

 

 
