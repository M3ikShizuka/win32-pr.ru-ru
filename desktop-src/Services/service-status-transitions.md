---
description: Служба отвечает за отправку отчетов об изменениях состояния в диспетчер управления службами (SCM).
ms.assetid: 74a85730-6667-46fe-ae12-26561ccedb73
title: Переходы состояния службы
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 7039caf68ee7d9da93e86e1760e49df87667da8c16eb5ca6693cfdc7db7def2e
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "117967326"
---
# <a name="service-state-transitions"></a>Переходы состояния службы

Служба отвечает за отправку отчетов об изменениях состояния в диспетчер управления службами (SCM). Программы управления службами и система могут определить состояние службы только из SCM, поэтому важно, чтобы служба правильно вымогла сообщить о своем состоянии. Служба сообщает свое состояние, вызывая функцию [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) с указателем на полностью инициализированную структуру [**\_ состояния службы**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) . Элемент **двкуррентстате** структуры содержит состояние службы, которое необходимо сообщить.

Начальное состояние службы — "Служба \_ остановлена". Когда SCM запускает службу, он устанавливает для состояния службы значение \_ Ожидание запуска службы \_ и вызывает функцию [*ServiceMain*](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) службы. Затем служба завершает свою инициализацию, используя один из методов, описанных в разделе [Service ServiceMain Function](service-servicemain-function.md). После того как служба завершит свою инициализацию и готова начать получение управляющих запросов, служба вызывает [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) для службы отчетов \_ и указывает управляющие запросы, которые служба готова принять. Переход от начала службы \_ в \_ ожидании службы \_ указывает на средства SCM и наблюдения за службами, которые были успешно запущены службой. Если служба сообщает о состоянии, отличном от \_ запущенной службы, средства SCM или наблюдения за службами могут пометить службу как неудачную.

SCM отправляет в службу только указанные управляющие запросы (за исключением \_ запроса на контроль службы \_ , который всегда отправляется). Список запросов Control, которые может принять служба, см. в разделе **двконтролсакцептед** элемента структуры [**\_ состояния службы**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) . Сведения о регистрации для получения событий устройства см. в описании функции [**регистердевиценотификатион**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) .

Состояние службы обычно изменяется в результате обработки управляющего запроса. Управляющие запросы, которые приводят к изменению состояния \_ службы \_ , включают остановку управления службами, \_ \_ приостановку управления службами, а также \_ продолжение управления службами \_ . Если служба должна выполнить длительную обработку для обработки любого из этих запросов, она должна создать дополнительный поток для выполнения длительной обработки и сообщить соответствующему состоянию ожидания в SCM. (для обеспечения лучшей производительности Windows Vista и более поздних версий Windows для этой цели служба должна использовать рабочий поток из [пула потоков](/windows/desktop/ProcThread/thread-pools) .) После завершения длительной обработки служба должна сообщить о завершенном переходе состояния. Дополнительные сведения об обработке управляющих запросов см. в разделе [функция обработчика управления службами](service-control-handler-function.md).

Допустимы только определенные переходы состояния службы. На следующей диаграмме показаны допустимые переходы.

![допустимые переходы состояния службы](images/service-status-transitions.png)

Состояние службы, сообщаемое SCM, определяет, как SCM взаимодействует со службой. Например, если служба сообщает о \_ \_ ожидании остановки службы, SCM не передает дальнейшие управляющие запросы службе, так как это состояние указывает на завершение работы службы. Следующее состояние, сообщаемое службой, должно быть \_ остановлено, так как это единственное допустимое состояние после \_ ожидания остановки службы \_ . Однако если служба сообщает о недействительном переходе, SCM не завершает вызов.

На следующей диаграмме приведены более подробные сведения о переходах состояния службы, включая запросы элементов управления, инициированные программой управления службами (клиентом службы), и [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) вызовы, которые служба делает для передачи изменений состояния в SCM. Как упоминалось ранее, SCM отправляет только управляющие запросы, которые она указала, поэтому служба может не получить все запросы, показанные на схеме.

![Подробности о переходах состояния службы ](images/service-status-flow-diagram.png)

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[**ControlService**](/windows/desktop/api/Winsvc/nf-winsvc-controlservice)
</dt> <dt>

[**контролсервицеекс**](/windows/desktop/api/Winsvc/nf-winsvc-controlserviceexa)
</dt> <dt>

[**Сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus)
</dt> </dl>

 

 
