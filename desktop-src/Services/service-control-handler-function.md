---
description: Каждая служба имеет обработчик управления, функцию обработчика, которая вызывается диспетчером управления, когда процесс службы получает управляющий запрос от программы управления службами.
ms.assetid: 437334ed-05fa-4ab6-aab3-dc2739113e19
title: Функция обработчика управления службой
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1303bff45421ee7206d02be9ee30066324648823
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105662354"
---
# <a name="service-control-handler-function"></a>Функция обработчика управления службой

Каждая служба имеет обработчик управления, функцию [**обработчика**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) , которая вызывается диспетчером управления, когда процесс службы получает управляющий запрос от программы управления службами. Поэтому эта функция выполняется в контексте диспетчера управления. Пример см. в разделе [написание функции обработчика элемента управления](writing-a-control-handler-function.md).

Служба вызывает функцию [**регистерсервицектрлхандлер**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) или [**регистерсервицектрлхандлерекс**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlerexa) для регистрации функции обработчика управления службой.

При вызове обработчика управления службами Служба должна вызвать функцию [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) , чтобы сообщить о своем состоянии SCM только в том случае, если обработка управляющего кода приводит к изменению состояния службы. Если обработка управляющего кода не приводит к изменению состояния службы, нет необходимости вызывать **сбой SetServiceStatus**.

Программа управления службами может отсылать управляющие запросы с помощью функции [**ControlService**](/windows/desktop/api/Winsvc/nf-winsvc-controlservice) . Все службы должны принять и обработать Управление службой, чтобы выполнить **\_ \_ опрос** управляющего кода. Вы можете включить или отключить принятие других управляющих кодов, вызвав [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus). Чтобы получить управляющий код **\_ \_ девицеевент управления службой** , необходимо вызвать функцию [**регистердевиценотификатион**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) . Службы также могут выполнять дополнительные определяемые пользователем управляющие коды.

Если служба принимает **\_ управляющий код \_ остановки управления службой** , она должна остановиться при получении, перейдя в режим **\_ \_ ожидания остановки службы** или **\_ остановленное состояние службы** . После того как SCM отправит Этот управляющий код, он не будет отправлять другие управляющие коды.

**Windows XP:** Если служба не возвращает **\_ сообщение об ошибке и не** запускается, она по мере продолжения получает управляющие коды. Это поведение изменилось начиная с Windows Server 2003 и Windows XP с пакетом обновления 2 (SP2).

Обработчик управления должен возвращать значение в течение 30 секунд, или SCM возвращает ошибку. Если служба должна выполнить длительную обработку, когда служба выполняет обработчик управления, он должен создать дополнительный поток для выполнения длительной обработки, а затем вернуться из обработчика управления. Это предотвращает привязки к диспетчеру управления для службы. Например, при обработке запроса на завершение для службы, которая занимает много времени, создайте другой поток для обработки процесса завершения. Обработчик управления должен просто вызвать [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) с сообщением **о \_ \_ завершении ожидания службы** и вернуть.

Когда пользователь завершает работу системы, все обработчики управления, которые вызвали [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) со **службой, \_ принимают \_** код управления для предварительного завершения работы **службы \_ управления \_ службами** . Диспетчер управления службами ждет, пока служба не остановится или не истечет указанное значение времени ожидания для предварительного завершения (это значение можно задать с помощью функции [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) ). Этот управляющий код следует использовать только в особых обстоятельствах, так как служба, которая обрабатывает это уведомление, блокирует завершение работы системы до тех пор, пока служба не прекратит работу или не истечет время ожидания перед завершением.

После завершения уведомлений о завершении работы все обработчики управления, которые вызвали [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) с кодом управления " **\_ принять \_ Завершение работы службы** ", получают управляющий код **\_ \_ завершения работы управления службой** . Они получают уведомления в том порядке, в котором они отображаются в базе данных установленных служб. По умолчанию служба имеет приблизительно 20 секунд на выполнение задач очистки до завершения работы системы. По истечении этого времени завершение работы системы продолжается независимо от того, завершено ли завершение работы службы. Обратите внимание, что если система остается в состоянии завершения работы (не перезапускается или не отключено), служба продолжит работу.

Если службе требуется больше времени для очистки, она отправляет **\_ ожидающие** сообщения о состоянии, а также указание ожидания, поэтому контроллеру службы известно, как долго следует ожидать перед отправкой отчетов в систему о завершении завершения работы службы. Однако, чтобы предотвратить остановку завершения работы службы, существует ограничение на время ожидания в контроллере службы. Если служба завершает работу через оснастку "службы", ограничение составляет 125 секунд или 125 000 миллисекунд. При перезагрузке операционной системы предельное значение времени указывается в значении **ваиттокиллсервицетимеаут** (в миллисекундах) следующего раздела реестра:

**\_ \_ \\ \\ Элемент управления CurrentControlSet системы hKey локального компьютера \\**

> [!IMPORTANT]
> Служба не должна пытаться увеличить предельное время, изменив это значение. Если необходимо задать **ваиттокиллсервицетимеаут** вручную, значение должно быть в миллисекундах.

Клиентам требуется быстрое завершение работы операционной системы. Например, если компьютер, работающий под управлением ИБП, не может завершить работу до того, как ИБП выполнит питание, данные могут быть потеряны. Поэтому службы должны выполнять свои задачи по очистке как можно быстрее. Рекомендуется уменьшить объем несохраненных данных путем регулярного сохранения данных, отслеживания данных, сохраняемых на диске, и сохранения несохраненных данных при завершении работы. Так как работа компьютера завершается, не следует тратить время на освобождение выделенной памяти или других системных ресурсов. Если необходимо уведомить сервер о выходе из системы, сократите время, затрачиваемое на ожидание ответа, так как сетевые проблемы могут задержать завершение работы службы.

Обратите внимание, что во время завершения работы службы по умолчанию SCM не учитывает зависимости. SCM перечисляет список выполняющихся служб и отправляет команду **\_ \_ завершения работы управления службой** . Таким образом, может произойти сбой службы, так как другая служба, от которой она зависит, уже остановлена.

Чтобы задать порядок завершения работы служб вручную, создайте значение реестра из множества строк, содержащее имена служб в том порядке, в котором они должны быть выключены, и назначьте их значению **прешутдовнордер** ключа управления следующим образом:

**HKEY \_ локальный \_ компьютер \\ система \\ CurrentControlSet \\ элемент управления \\ прешутдовнордер = "порядок завершения работы"**

Чтобы задать порядок завершения работы зависимых служб приложения, используйте функцию [**сетпроцессшутдовнпараметерс**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setprocessshutdownparameters) . SCM использует эту функцию, чтобы дать обработчику 0x1E0 приоритет. SCM отправляет уведомления **о \_ \_ завершении работы управления службой** при вызове обработчика управления и ожидает завершения работы служб перед возвратом из обработчика управления.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Написание функции обработчика элемента управления](writing-a-control-handler-function.md)
</dt> </dl>

 

 
