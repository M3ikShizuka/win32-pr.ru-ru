---
description: Hyper-V использует служба теневого копирования томов (VSS) для резервного копирования и восстановления виртуальных машин.
ms.assetid: 94C67F22-658D-49DD-9588-6BB4FCF7ADA9
title: Резервное копирование и восстановление виртуальных машин
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6f9cf6d5b80a4c7392fb38e893a4fafad3f90435
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105683434"
---
# <a name="backing-up-and-restoring-virtual-machines"></a>Резервное копирование и восстановление виртуальных машин

Hyper-V использует служба теневого копирования томов (VSS) для резервного копирования и восстановления виртуальных машин. Если службы интеграции резервного копирования (моментального снимка тома) установлены в операционной системе на виртуальной машине, то устанавливается инициатор запроса VSS, который позволит модулям записи VSS в гостевой операционной системе участвовать в резервной копии виртуальной машины. Дополнительные сведения см. в следующих разделах:

-   [Резервное копирование виртуальных машин](#backing-up-the-virtual-machines)
-   [Восстановление виртуальных машин](#restoring-the-virtual-machines)
-   [Отказоустойчивая кластеризация и Hyper-V VSS](#failover-clustering-and-hyper-v-vss)
-   [Сведения о модуле записи VSS Hyper-V](#details-on-the-hyper-v-vss-writer)
-   [См. также](#related-topics)

## <a name="backing-up-the-virtual-machines"></a>Резервное копирование виртуальных машин

Hyper-V использует один из двух механизмов резервного копирования каждой виртуальной машины. Механизм резервного копирования по умолчанию называется методом "сохраненное состояние", где виртуальная машина переводится в сохраненное состояние во время обработки события Препарефорснапшот, моментальные снимки берутся из соответствующих томов, а виртуальная машина возвращается в предыдущее состояние во время обработки события моментального снимка.

Другой механизм резервного копирования называется методом "моментальный снимок дочерней виртуальной машины", который использует VSS внутри дочерней виртуальной машины для участия в резервной копии. Для поддержки метода "моментальный снимок дочерней виртуальной машины" должны быть выполнены все следующие условия.

-   Служба интеграции резервного копирования (моментальный снимок тома) установлена и запущена на дочерней виртуальной машине. Имя службы — "инициатор запроса теневого копирования тома Hyper-V".
-   Дочерняя виртуальная машина должна находиться в состоянии выполняется.
-   В качестве расположения файла моментального снимка для виртуальной машины выбран тот же том, что и VHD-файлы виртуальной машины.
-   Все тома на дочерней виртуальной машине являются базовыми дисками, а динамические диски отсутствуют.
-   Все диски на дочерней виртуальной машине должны использовать файловую систему, поддерживающую моментальные снимки (например, NTFS).

Как правило, процесс резервного копирования виртуальных машин аналогичен описанному в [разделе Общие сведения об обработке резервной копии в VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss). Уникальное поведение возникает, когда модуль записи VSS Hyper-V (компонент службы управления виртуальными машинами Hyper-V) обрабатывает событие Препарефорснапшот. Если резервная копия была выполнена с помощью метода "моментальный снимок дочерней виртуальной машины", то выполняется дополнительная обработка, но она не видна дочерней виртуальной машине.

В следующей процедуре описывается, как выполнять резервное копирование виртуальных машин.

**Архивация виртуальных машин**

1.  Для каждой виртуальной машины в метаданных модуля записи, если используется метод "сохраненное состояние", виртуальная машина переводится в сохраненное состояние. Для виртуальных машин, использующих метод "моментальный снимок дочерней виртуальной машины", служба запроса теневого копирования томов Hyper-V на дочерней виртуальной машине обрабатывает резервную копию, как описано в статье [Общие сведения об обработке резервной копии в VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss). Все события VSS на дочерней виртуальной машине происходят во время обработки события Препарефорснапшот в операционной системе узла.
2.  После того как все виртуальные машины будут помещены в сохраненное состояние или были созданы моментальные снимки, модуль записи VSS Hyper-V Возвращает событие Препарефорснапшот. Не выполняется обработка модулем записи VSS Hyper-V во время событий замораживания и разморозки.
3.  Когда модуль записи VSS Hyper-V обрабатывает событие моментального снимка, виртуальные машины, для которых было выполнено резервное копирование с помощью метода "сохраненное состояние" и были переведены в сохраненное состояние, модуль записи VSS Hyper-V возвращается в состояние, в котором они находились до начала резервного копирования. Для виртуальных машин, резервная копия которых была создана с помощью метода "моментальный снимок дочерней виртуальной машины", образ VHD-файлов, для которых были созданы моментальные снимки, будет возвращен в моментальный снимок, сделанный во время обработки события Препарефорснапшот. Эта обработка выполняется независимо от модулей записи VSS на дочерних виртуальных машинах, поэтому создаваемые моментальные снимки должны быть восстановлены в автоматическом виде. (Служба **VSS \_ VOLSNAP attr не устанавливает \_ \_ \_ Автовосстановление** в контексте.)

Частичные резервные копии не поддерживаются. Если какой-либо виртуальной машине не удается создать моментальный снимок, резервное копирование виртуальных машин не выполняется.

> [!Note]  
> Диски с передаваемыми и iSCSI не видны операционной системе узла и, следовательно, не поддерживаются модулем записи VSS Hyper-V. Резервное копирование этих томов должно выполняться полностью на виртуальной машине.

 

## <a name="restoring-the-virtual-machines"></a>Восстановление виртуальных машин

Восстановление виртуальных машин полностью выполняется операционной системой узла; модули записи VSS на дочерних виртуальных машинах не задействованы.

В следующей процедуре описывается восстановление виртуальных машин.

**Восстановление виртуальных машин**

1.  Во время обработки события предварительного восстановления модуль записи VSS Hyper-V отключает и удаляет все виртуальные машины, которые будут восстановлены.
2.  После того как все модули записи VSS обрабатывали событие, выполняемое перед восстановлением, файлы восстанавливаются.
3.  Во время обработки события Restore модуль записи VSS Hyper-V вызывает метод [**ивсскомпонент:: жетфилересторестатус**](/windows/desktop/api/vswriter/nf-vswriter-ivsscomponent-getfilerestorestatus) . Если возвращается не **все службы VSS \_ RS \_**, модуль записи VSS Hyper-V вызывает метод [**сетвритерфаилуре**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-setwriterfailure) и возвращает **false** из метода [**онпостресторе**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-onpostrestore) .
4.  Для каждой восстановленной виртуальной машины модуль записи VSS Hyper-V регистрирует виртуальную машину в службе управления Hyper-V. Если виртуальная машина восстанавливается в расположение, не используемое по умолчанию, в расположении по умолчанию, связанном с этим расположением, создается символьная ссылка.
5.  Для каждого восстановленного виртуального жесткого диска расположение сравнивается с указанным для этой виртуальной машины значением. Если расположение отличается, конфигурация обновляется в соответствии с соответствующим расположением.
6.  Конфигурация сети обновлена. Если виртуальные коммутаторы, к которым подключена виртуальная машина, в момент выхода из резервной копии все еще завершаются, создаются новые порты, которые подключаются к виртуальной машине.

## <a name="failover-clustering-and-hyper-v-vss"></a>Отказоустойчивая кластеризация и Hyper-V VSS

Модуль записи VSS Hyper-V не учитывает виртуальные машины, которые являются частью отказоустойчивого кластера. Во время резервного копирования метода "сохраненное состояние" и всех восстановлений виртуальная машина будет переведена в сохраненное состояние или полностью удалена. Это будет рассматриваться как сбой службы кластеров и привести к отработки отказа приложений на этих узлах на другие узлы. Чтобы избежать этого во время резервного копирования "сохраненного состояния", состояние виртуальной машины необходимо сохранить с помощью службы кластеризации. Чтобы избежать этой ситуации во время восстановления, необходимо перевести ресурсы виртуальной машины в автономный режим.

## <a name="details-on-the-hyper-v-vss-writer"></a>Сведения о модуле записи VSS Hyper-V

Имя модуля записи: Microsoft Hyper-V модуль записи VSS

Идентификатор модуля записи: 66841CD4-6DED-4F4B-8F17-FD23F8DDC3DE

## <a name="related-topics"></a>См. также

<dl> <dt>

[Общие сведения об обработке резервной копии в VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss)
</dt> <dt>

[Общие сведения об обработке восстановления в VSS](/windows/desktop/VSS/overview-of-processing-a-restore-under-vss)
</dt> </dl>

 

 
