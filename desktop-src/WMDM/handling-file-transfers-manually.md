---
title: Обработка передачи файлов вручную
description: Обработка передачи файлов вручную
ms.assetid: ff94191b-a0f2-4118-996c-d040f214fb9b
keywords:
- Диспетчер устройств Windows Media, ручная передача файлов
- Диспетчер устройств, ручная передача файлов
- Руководство по программированию, передача файлов вручную
- Классические приложения, ручная передача файлов
- Создание приложений диспетчер устройств Windows Media, ручная передача файлов
- ручная передача файлов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a2bf12404e8cd83b6f0c0e4f1c8ec8b0b7bda205
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "103792853"
---
# <a name="handling-file-transfers-manually"></a>Обработка передачи файлов вручную

Приложение может реализовать интерфейс [**ивмдмоператион**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdmoperation) для управления частью процесса чтения или записи. При чтении с устройства реализация позволяет приложению принимать блоки необработанных данных из файла устройства. При записи на устройство оно позволяет приложению отсылать блоки необработанных данных в файл на устройстве.

В операциях чтения и записи метод [**ивмдмоператион:: трансферобжектдата**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-transferobjectdata) передает данные между компьютером и устройством. Чтобы определить направление передачи данных, приложение должно установить флаг, когда Windows Media диспетчер устройств вызывает [**BeginRead**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginread) или [**BeginWrite**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginwrite). При вызове метода [**End**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-end) приложение должно сбросить этот флаг.

> [!Note]  
> Если поставщик услуг и устройство правильно реализуют [**IMDSPObject2**](/windows/desktop/api/mswmdm/nn-mswmdm-imdspobject2), сначала будет вызван метод [IWMDMOperation3:: трансферобжектдатаонклеарчаннел](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation3-transferobjectdataonclearchannel) приложения, если он реализован. Этот метод является более эффективным способом передачи данных. **Трансферобжектдатаонклеарчаннел** обрабатывается так же, как **трансферобжектдата**, за исключением того, что данные никогда не шифруются и не имеют значений Mac для проверки.

 

В следующих разделах описывается процесс чтения и записи, когда приложение реализует **ивмдмоператион**.

**Чтение с устройства**

При чтении файла с устройства Windows Media диспетчер устройств вызывает следующие методы **ивмдмоператион** по порядку:

-   [**BeginRead**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginread) Вызывается для уведомления приложения о начале чтения с устройства.
-   [**Трансферобжектдата**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-transferobjectdata) Вызывается один или несколько раз. Обработка данных описывается в следующих шагах.
    1.  **Трансферобжектдата** получает буфер, *PData*, размер *пдвсизе* байт, заполненный данными и Mac для проверки входящих данных.
    2.  Приложение проверяет входящие параметры с помощью MAC-адреса входящих данных.
    3.  Приложение расшифровывает и считывает большую часть данных в *pData* , как это возможно, и изменяет возвращаемое значение *пдвсизе* , чтобы указать, сколько байтов было фактически считано.
    4.  Приложение расшифровывает данные с помощью [**ксекуречаннелклиент::D екриптпарам**](/previous-versions/bb231586(v=vs.85)), сохраняет их или использует при необходимости.
    5.  **Трансферобжектдата** возвращает S \_ ОК.
    6.  Windows Media диспетчер устройств по-своему вызывает **трансферобжектдата** до тех пор, пока приложение не прочитает все данные из файла, или приложение возвращает вмдм \_ E \_ \_ отменено для отмены операции (в этом случае чтение отменяется, а Windows Media Диспетчер устройств вызывает **End**).
-   [**Конец**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-end) Вызывается для уведомления приложения о завершении чтения с устройства.

**Запись на устройство**

При записи файла на устройство Windows Media диспетчер устройств вызывает следующие методы **ивмдмоператион** по порядку:

-   [**Жетобжектнаме**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-getobjectname) Вызывается, чтобы разрешить приложению указывать имя нового хранилища. Этот метод вызывается только в том случае, если приложение не указало имя в методе **INSERT** .
-   [**Жетобжектаттрибутес**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-getobjectattributes) Вызывается, чтобы разрешить приложению указывать атрибуты для нового хранилища на устройстве.
-   [**BeginWrite**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginwrite) Вызывается для уведомления о начале записи на устройство.
-   [**Жетобжекттоталсизе**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-getobjecttotalsize) Вызывается для получения общего размера объекта, записываемого на устройство, для обеспечения оптимизации передачи, а также для предоставления Windows Media диспетчер устройств возможность отмены передачи, если файл слишком велик для устройства.
-   [**Трансферобжектдата**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-transferobjectdata) Вызывается один или несколько раз. Обработка данных описывается в следующих шагах.
    1.  **Трансферобжектдата** получает указатель на буфер размера *пдвсизе* байт.
    2.  Приложение получает блок данных для отправки на устройство, обычно путем считывания данных из файла и заполняет полученный буфер размером до *пдвсизе* байт. Он должен изменить *пдвсизе* (при необходимости), чтобы отобразить количество байтов, добавленных в буфер.
    3.  Приложение создает MAC для всех параметров метода.
    4.  Приложение шифрует данные в буфере с помощью [**ксекуречаннелклиент:: енкриптпарам**](/previous-versions/bb231587(v=vs.85)).
    5.  **Трансферобжектдата** возвращает " \_ ОК", чтобы указать, что имеется больше данных, или "ложь", \_ чтобы указать, что больше нет данных. Если приложение возвращает ВМДМ \_ \_ \_ отменено пользователем, операция записи отменяется, а диспетчер устройств Windows Media выполнит вызов **End**.
    6.  Windows Media диспетчер устройств по мере необходимости вызывает **трансферобжектдата** , пока приложение возвращает значение S \_ ОК.
-   [**Конец**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-end) Вызывается для уведомления о завершении записи на устройство.

Пример кода см. в разделе [Шифрование и расшифровка](encryption-and-decryption.md).

## <a name="related-topics"></a>См. также

<dl> <dt>

[**Создание приложения диспетчер устройств Windows Media**](creating-a-windows-media-device-manager-application.md)
</dt> </dl>

 

 