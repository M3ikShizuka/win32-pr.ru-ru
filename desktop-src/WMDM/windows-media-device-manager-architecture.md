---
title: Архитектура диспетчер устройств Windows Media
description: Архитектура диспетчер устройств Windows Media
ms.assetid: 3c1b2da4-559d-427b-b502-5ef8dc055a8e
keywords:
- Диспетчер устройств Windows Media, архитектура
- Диспетчер устройств, архитектура
- Архитектура диспетчер устройств Windows Media
- Windows Media диспетчер устройств, классические приложения
- Диспетчер устройств, классические приложения
- Диспетчер устройств Windows Media, поставщики услуг
- Диспетчер устройств, поставщики услуг
- Диспетчер устройств Windows Media, подключаемые модули
- Диспетчер устройств, подключаемые модули
- Классические приложения, архитектура Windows Media диспетчер устройств
- поставщики услуг, архитектура диспетчер устройств Windows Media
- подключаемые модули, архитектура диспетчер устройств Windows Media
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9fda87e4ed4bce2c82bbb9c0863c119851965940
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "104253002"
---
# <a name="windows-media-device-manager-architecture"></a>Архитектура диспетчер устройств Windows Media

Windows Media диспетчер устройств позволяет приложению или подключаемому модулю взаимодействовать с устройством. Приложения могут запрашивать метаданные устройства, перечислять и исследовать подключенные устройства, отправлять или получать объекты (папки, файлы, списки воспроизведения и т. д.). Windows Media диспетчер устройств предоставляет один интерфейс API вызывающему приложению независимо от типа устройства (MTP или класс массового хранения, поставщики услуг, созданные на базе версии 10 или поставщики услуг, созданные на более ранних версиях Windows Media диспетчер устройств).

Windows Media диспетчер устройств выступает в качестве посредника для трех основных компонентов системы: приложения, которое делает запросы (для получения информации, чтения или записи данных и т. д.); защищенный поставщик содержимого — компонент, который обрабатывает взаимодействие с файлами, защищенными с помощью DRM; и поставщик услуг, который получает запросы от приложения и взаимодействует с устройством для выполнения этих запросов. Как приложение, так и поставщик службы построены на Windows Media диспетчер устройств SDK.

На следующей схеме показано, как приложение для настольных компьютеров взаимодействует с устройством с помощью Windows Media диспетчер устройств 11.

![Схема, показывающая приложение, взаимодействующее с четырьмя устройствами различных типов.](images/wmdm-device-communication.gif)

На предыдущей схеме показано приложение, взаимодействующее с четырьмя различными типами устройств, каждое из которых имеет собственный поставщик услуг. Каждый поставщик услуг предназначен для взаимодействия с устройством определенного типа. на этой схеме показаны три предоставленные корпорацией Майкрософт поставщики услуг (универсальные драйверы классов для устройств класса запоминающих носителей, устройства RAPI и устройства MTP), а также пользовательский поставщик услуг для собственного устройства, созданного третьим лицом. При подключении устройства диспетчер устройств Windows Media создает экземпляр поставщика служб, зарегистрированного для этого устройства. Поставщики услуг получают запросы от приложения через Windows Media диспетчер устройств интерфейсы, которые они реализуют, используют соответствующие драйверы для взаимодействия с устройством и возвращают соответствующие результаты. Связь между поставщиком службы и устройством выходит за пределы домена Windows Media диспетчер устройств.

Поставщики услуг невидимы для приложения; приложение видит только список "устройства", так как Windows Media диспетчер устройств предоставляет стандартный набор методов и интерфейсов для всех устройств. Если производитель создает настраиваемого поставщика услуг, он должен обрабатывать все стандартные методы диспетчер устройств Windows Media, если приложения могут использовать устройство.

На этой схеме также показан модуль безопасного поставщика содержимого (SCP). Этот модуль отвечает за обработку содержимого, защищенного с использованием управления цифровыми правами (DRM). Корпорация Майкрософт предоставляет модуль SCP, который может работать с файлами WMA и WMV, защищенными с помощью DRM. Если приложение или устройство планирует работать с другими защищенными форматами, оно должно предоставить собственный модуль SCP. Ни приложение, ни поставщик услуг не взаимодействует с SCP напрямую.

Как приложение, так и поставщик службы построены на диспетчер устройств Windows Media, который направляет вызовы между приложением и соответствующим поставщиком служб для устройства; поставщик услуг отвечает за взаимодействие непосредственно с устройством. Диспетчер устройств Windows Media выполняет некоторые действия (например, перечисление подключенных устройств, маршрутизацию вызовов и обработку проверки компонентов); Однако большая часть работы выполняется поставщиком услуг, который получает запросы от приложения и взаимодействует с устройством.

Приложение на основе Windows Media диспетчер устройств может взаимодействовать с устройствами и поставщиками услуг, созданными на более ранних версиях Windows Media диспетчер устройств; Однако эти старые устройства будут выполняться с помощью 9 компонентов серии (не показаны) и не будут поддерживать новейшие функции, в частности более расширенную технологию управления цифровыми правами.

Архитектура устройства

На следующей схеме показана упрощенная иерархия устройств и хранилищ, отображаемых приложением с помощью диспетчер устройств Windows Media.

![Схема, показывающая хранилища на устройстве.](images/wmdm-basic-device-layout.gif)

На предыдущей схеме показана упрощенная версия подключенного флэш-накопителя, как показано в приложении Windows Media диспетчер устройств. Устройство флэш-памяти имеет атрибуты и свойства, такие как серийный номер и поддерживаемые конфигурации формата. Непосредственный дочерний элемент устройства Flash — это корневой объект хранилища, который содержит папку, содержащую изображение и песню.

Приложение перечисляет список подключенных устройств, вызывая метод перечисления, предоставляемый корневым интерфейсом [**ивмдевицеманажер**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdevicemanager) . Устройства представлены с помощью [**ивмдмдевице**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdmdevice) (или производного) интерфейса. Этот интерфейс предоставляет методы для получения имени устройства, возможностей форматирования, серийного номера и т. д., а также метода, который перечисляет *хранилища* на устройстве. В Windows Media диспетчер устройств хранилище — это объект любого типа на устройстве, независимо от того, является ли он фактическим BLOB-объектом данных. Например, звуковые файлы, текстовые файлы, папки, списки воспроизведения, хранящиеся в виде файлов, и списки воспроизведения, хранящиеся в виде метаданных, считаются хранилищами, даже если папки и элементы метаданных, вероятно, не представляют физический файл. Тип (или формат) хранилища можно получить путем вызова методов [**InAttribute**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmstorage-getattributes) (или [**метаданных**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmstorage3-getmetadata), запросив формат хранилища).

Хранилища на устройстве хранятся иерархически, а все устройства имеют корневое хранилище. Каждое хранилище может содержать ноль или более дочерних объектов, перечисленное путем вызова метода [**ивмдмстораже:: енумстораже**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmstorage-enumstorage) хранилища.

Обратите внимание, что каждое хранилище на схеме имеет связанные с ним атрибуты и метаданные (не все значения показаны). Атрибуты являются простыми, логическими сведениями, которые часто описывают управление или сведения для навигации (например, "содержит папки&quot; или &quot;может удалять"), тогда как метаданные могут быть строковыми значениями, числами или сложными сведениями (например, возможностями отрисовки). Атрибуты описываются достаточно ограниченным набором флагов, определенных пакетом SDK, и извлекаются путем вызова [**ивмдмстораже:: inattributes**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmstorage-getattributes) или [**IWMDMStorage2:: GetAttributes2**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmstorage2-getattributes2). Значения метаданных извлекаются с помощью уникального имени; пакет SDK определяет ряд значений метаданных, которые должны поддерживать устройства, но устройства могут определять собственные [константы метаданных](metadata-constants.md). Однако если устройство или поставщик услуг определяет новую константу метаданных, приложения не смогут запрашивать или задавать это значение, если разработчикам приложений не известно о новой константе. Поставщик услуг должен поддерживать [**IWMDMStorage3**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdmstorage3) или более позднюю версию для поддержки получения или установки метаданных. Дополнительные сведения см. в разделе [Получение и Настройка метаданных и атрибутов](getting-and-setting-metadata-and-attributes.md).

Поставщики услуг

Поставщик услуг выступает в качестве середины между приложением и устройством. Поставщик услуг является невидимым для разработчика приложения, поэтому разработчику приложения не нужно ничего знать о разработке поставщика услуг. Однако это поставщик услуг, который выполняет работу по взаимодействию с устройством.

Поставщик услуг — это COM-библиотека DLL, созданная на основе Windows Media диспетчер устройств, которая получает запросы от приложения и взаимодействует с устройством для выполнения этих операций. Обмен данными с настольным приложением осуществляется диспетчер устройств Windows Media. связь с устройством находится под контролем поставщика услуг.

Поставщик услуг получает от приложения запросы для перечисления содержимого устройства, запросов для возможностей устройств, запросов на чтение или запись данных и т. д. Это должно быть достаточно для того, чтобы правильно понять структуру устройства, чтобы она могла отправить команды в правильном формате и протоколе. Он также должен иметь возможность скрывать особые требования для конкретных устройств, такие как требуемое расширение файлов для списков воспроизведения, чтобы приложениям не требовалось знать эти требования для использования устройства.

Корпорация Майкрософт предоставляет несколько поставщиков услуг для стандартных типов устройств, включая универсальные устройства MTP, устройства класса запоминающих устройств и устройства RAPI. Единственная причина, по которой конструктору устройств необходимо создать пользовательский поставщик услуг, — если устройство имеет некоторые особые или необычные требования к хранению данных, которые поставщики стандартных служб не обрабатывали, например, если файлы должны храниться в определенных расположениях, а операционная система устройства не обрабатывает это автоматически.

При подключении устройства к компьютеру операционная система создает по одному экземпляру соответствующего поставщика услуг для каждого приложения Windows Media диспетчер устройств. Если запускается второе приложение диспетчер устройств Windows Media, будет загружен второй экземпляр поставщика услуг. Однако каждый поставщик услуг может работать с несколькими устройствами. Это показано на схеме ниже.

![Схема, на которой показаны два устройства MTP, взаимодействующие с двумя приложениями.](images/wmdm-sp-to-device.gif)

На предыдущей схеме показаны два разных приложения, взаимодействующие с двумя устройствами MTP. Устройства используют один и тот же класс поставщика услуг, но каждое приложение имеет собственный экземпляр одного и того же поставщика услуг. Каждый экземпляр поставщика услуг взаимодействует с устройствами. Разные экземпляры поставщика услуг не знают друг о друга.

Многие методы приложений имеют метод поставщика услуг с соответствующим именем. Когда приложение вызывает метод, Windows Media диспетчер устройств направляет вызов соответствующему методу поставщика услуг (хотя сначала он может выполнить некоторые дополнительные внутренние действия). Например, когда приложение вызывает [**IWMDMDevice3:: Property**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmdevice3-getproperty), Windows Media Диспетчер устройств направляет этот вызов в реализацию [**IMDSPDevice3::**](/windows/desktop/api/mswmdm/nf-mswmdm-imdspdevice3-getproperty)поставщика услуг. (Большинство интерфейсов приложений начинаются с ИВМДМ, а соответствующий интерфейс поставщика услуг начинается с ИМДСП). Ожидается, что поставщик услуг обрабатывает этот вызов метода и возвращает соответствующий результат.

Приложение не будет напрямую изучать устройство или взаимодействовать с ним (если оно не вызывает [**IWMDMDevice3::D евицеиоконтрол**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmdevice3-deviceiocontrol) или [**Ивмдмстораже:: сендопакуекомманд**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmstorage-sendopaquecommand)); приложение взаимодействует с поставщиком услуг, который должен представлять устройство самым логичным и простым способом. Когда приложение запрашивает сведения об устройстве или перечисляет объекты на устройстве, поставщик услуг запрашивает устройство соответствующим образом и получает и возвращает соответствующие сведения. Она может предоставлять организацию файлов на устройстве иначе, чем она физически хранится на устройстве, если это уместно. Однако оно предоставляет устройство, оно должно быть согласованным логическим способом, чтобы приложение было находить необходимое для него действие и обрабатывать отправляемые им команды. Хороший поставщик услуг скрывает странностой для конкретного устройства, например, если устройство физически сохраняет список воспроизведения в виде файла с пользовательским расширением файла, поставщик услуг должен добавить это расширение автоматически при создании приложением списка воспроизведения на устройстве. При создании объекта списка воспроизведения приложению не следует предполагать, что оно должно иметь соответствующее расширение.

Поставщики служб выполняются внутри процесса вызывающего приложения. Единственным исключением является поставщик службы MTP, который выполняется в собственном процессе. По этой причине существует некоторый риск того, что заблокированный поставщик услуг вызовет блокировку вызывающего приложения. Поэтому поставщики услуг должны быть надежными и предотвращать блокировку, а приложения должны быть спроектированы таким образом, чтобы предотвратить зависание, если конкретный вызов метода не возвращает быстрое возвращение.

## <a name="related-topics"></a>См. также

<dl> <dt>

[**начало работы**](getting-started.md)
</dt> </dl>

 

 




