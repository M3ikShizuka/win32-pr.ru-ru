---
description: В этом разделе описывается, как выполнить печать из встроенной программы Windows Desktop.
ms.assetid: C1EDBE38-9D18-41BB-961C-12CF2283C639
title: Настольное приложение для печати
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: cbecbac997d000f50e7c912e57be42cc8fe239b3
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105664343"
---
# <a name="desktop-app-printing"></a>Настольное приложение для печати

В этом разделе описывается, как выполнить печать из встроенной программы Windows Desktop.

## <a name="overview"></a>Обзор

Чтобы обеспечить оптимальное взаимодействие с пользователем при печати из собственной программы Windows, программа должна быть разработана для печати из выделенного потока. В собственной программе Windows программа отвечает за управление событиями и сообщениями пользовательского интерфейса. Операции печати могут потребовать периодов интенсивных вычислений по мере подготовки содержимого приложения для принтера, что может помешать программе реагировать на взаимодействие с пользователем, если эта обработка выполняется в том же потоке, что и обработка событий пользователем.

Если вы уже знакомы с написанием многопоточной собственной программы Windows, вы сразу переходите к [способу печати из приложения Windows](how-to--print-from-a-windows-application.md) и научитесь добавлять в программу функции печати.

### <a name="basic-windows-program-requirements"></a>Основные требования к программе Windows

Для лучшей производительности и скорости реагирования программы не следует выполнять обработку задания печати программы в потоке, обрабатывающем взаимодействие с пользователем.

Такое разделение печати от взаимодействия с пользователем влияет на то, как программа управляет данными приложения. Прежде чем приступить к написанию приложения, необходимо тщательно разобраться с этими последствиями. В следующих разделах описаны основные требования к обработке печати в отдельном потоке программы.

### <a name="windows-program-basics"></a>Основные сведения о программе Windows

Собственная программа Windows должна предоставить главную процедуру окна для обработки сообщений окна, получаемых от операционной системы. Каждое окно в программе Windows имеет соответствующую функцию **WndProc** , которая обрабатывает эти сообщения окна. Поток, в котором выполняется эта функция, называется пользовательским интерфейсом или потоком интерфейса.

**Используйте ресурсы для строк.**  
Используйте строковые ресурсы из файла ресурсов программы, а не строковые константы для строк, которые могут потребоваться изменить при поддержке другого языка. Чтобы программа могла использовать строковый ресурс в качестве строки, программа должна извлечь ресурс из файла ресурсов и скопировать его в буфер локальной памяти. Это требует дополнительного программирования в начале, но позволяет упростить изменение, перевод и локализацию программы в будущем.  
**Обработка данных по шагам.**  
Обработайте задание печати на шагах, которые могут быть прерваны. Такая схема позволяет пользователю отменить длительную операцию обработки до ее завершения и помешает программе блокировать другие программы, которые могут выполняться одновременно.  
**Используйте данные пользователя Window.**  
Для печати приложений часто используются несколько окон и потоков. Чтобы обеспечить доступность данных между потоками и шагами обработки без использования статических, глобальных переменных, сослаться на структуры данных по указателю на данные, который является частью окна, в котором они используются.  


В следующем примере кода показана Главная точка входа для приложения печати. В этом примере показано, как использовать строковые ресурсы вместо строковых констант, а также показан основной цикл обработки сообщений, который обрабатывает сообщения окна программы.


```C++
int APIENTRY 
wWinMain(
        HINSTANCE hInstance, 
        HINSTANCE hPrevInstance, 
        LPWSTR lpCmdLine, 
        int nCmdShow
)
{
    UNREFERENCED_PARAMETER(hPrevInstance);
    UNREFERENCED_PARAMETER(lpCmdLine);

    MSG msg;
    HACCEL hAccelTable;
    HRESULT hr = S_OK;

    // Register the main window class name
    WCHAR szWindowClass[MAXIMUM_RESOURCE_STRING_LENGTH];            
    LoadString(
        hInstance, 
        IDC_PRINTSAMPLE, 
        szWindowClass, 
        MAXIMUM_RESOURCE_STRING_LENGTH);
    MyRegisterClass(hInstance, szWindowClass);

    // Perform application initialization:
    if (!InitInstance (hInstance, nCmdShow))
    {
        // Unable to initialize this instance of the application
        //  so display error message and exit
        MessageBoxWithResourceString (
            hInstance, 
            GetDesktopWindow(), 
            IDS_ERROR_INSTINITFAIL, 
            IDS_CAPTION_ERROR, 
            (MB_OK | MB_ICONEXCLAMATION));
        return FALSE;
    }    
    
    // Init COM for printing interfaces
    if (FAILED(hr = CoInitializeEx(0, COINIT_MULTITHREADED)))
    {
        // Unable to initialize COM
        //  so display error message and exit
        MessageBoxWithResourceString (
            hInstance, 
            GetDesktopWindow(), 
            IDS_ERROR_COMINITFAIL, 
            IDS_CAPTION_ERROR, 
            (MB_OK | MB_ICONEXCLAMATION));
        return FALSE;
    }

    hAccelTable = LoadAccelerators(
                    hInstance, 
                    MAKEINTRESOURCE(IDC_PRINTSAMPLE));

    // Main message handling loop
    while (GetMessage(&msg, NULL, 0, 0))
    {
        if (!TranslateAccelerator(msg.hwnd, hAccelTable, &msg))
        {
            TranslateMessage(&msg);
            DispatchMessage(&msg);
        }
    }

    // Uninitialize (close) the COM interface
    CoUninitialize();

    return (int) msg.wParam;
}
```



### <a name="document-information"></a>Сведения о документе

Встроенные программы Windows, предназначенные для печати, должны быть предназначены для многопоточной обработки. Одним из требований многопоточного проектирования является защита элементов данных программы, чтобы они были надежными для одновременного использования несколькими потоками. Можно защитить элементы данных с помощью объектов синхронизации и организовать данные, чтобы избежать конфликтов между потоками. В то же время программа должна предотвращать изменения в данных программы во время ее печати. Пример программы использует несколько различных многопоточных методик программирования.

 **События синхронизации**  
Пример программы использует события, дескрипторы потоков и функции ожидания для синхронизации обработки между потоком печати и основной программой, а также для указания того, что данные используются.  
**Сообщения Windows, относящиеся к приложению**  
Пример программы использует сообщения окна для конкретного приложения, чтобы сделать программу более совместимой с другими программами Windows. Разбиение обработки на небольшие шаги и постановка в очередь этих шагов в цикле окон сообщений упрощает управление обработкой в Windows без блокировки других приложений, которые могут также выполняться на компьютере.  
**Структуры данных**  
Пример программы не написан на объектно-ориентированном стиле, использующем объекты и классы, хотя элементы данных группируются в структуры данных. В примере не используется объектно-ориентированный подход, чтобы не допустить того, что один подход лучше или хуже другого.  
Функции и структуры данных примера программы можно использовать в качестве отправной точки при проектировании программы. Если вы решили спроектировать объектно-ориентированную программу или нет, важно помнить, что необходимо сгруппировать связанные элементы данных, чтобы их можно было безопасно использовать в разных потоках при необходимости.  


### <a name="printer-device-context"></a>Контекст устройства печати

При печати может потребоваться отобразить содержимое, которое будет напечатано в контексте устройства. [Инструкции. Извлечение контекста печатающего устройства](retrieving-a-printer-device-context.md) описание различных способов получения контекста устройства печати.

## <a name="related-topics"></a>См. также



[Печать из приложения Windows](how-to--print-from-a-windows-application.md)


 

 



