---
description: DLL может дополнительно указывать функцию точки входа.
ms.assetid: ec035fc6-0a6f-4e52-a4cc-8d7a25a94366
title: Функция Entry-Point библиотеки Dynamic-Link
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b6289f705a11dad58eca8b047ba469ee07320dedef762024cbfa04046a0677f6
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "117815842"
---
# <a name="dynamic-link-library-entry-point-function"></a>Функция Entry-Point библиотеки Dynamic-Link

DLL может дополнительно указывать функцию точки входа. При наличии система вызывает функцию точки входа каждый раз, когда процесс или поток загружает или выгружает библиотеку DLL. Его можно использовать для выполнения простых задач инициализации и очистки. Например, он может настроить локальное хранилище потока при создании нового потока и очистить его после завершения потока.

Если библиотека DLL связывается с библиотекой времени выполнения C, она может предоставить функцию точки входа и предоставить отдельную функцию инициализации. Дополнительные сведения см. в документации по библиотеке времени выполнения.

Если вы предоставляете собственную точку входа, см. раздел Функция [**DllMain**](dllmain.md) . Имя **DllMain** — это заполнитель для определяемой пользователем функции. Необходимо указать фактическое имя, используемое при сборке библиотеки DLL. Дополнительные сведения см. в документации, входящей в состав средств разработки.

## <a name="calling-the-entry-point-function"></a>Вызов функции Entry-Point

Система вызывает функцию точки входа каждый раз, когда происходит одно из следующих событий:

-   Процесс загружает библиотеку DLL. Для процессов, использующих динамическую компоновку во время загрузки, Библиотека DLL загружается во время инициализации процесса. Для процессов, использующих связывание во время выполнения, Библиотека DLL загружается до возврата [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) или [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) .
-   Процесс выгружает библиотеку DLL. Библиотека DLL выгружается, когда процесс завершается или вызывается функция [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) , а счетчик ссылок становится нулевым. Если процесс завершается в результате выполнения функции [**терминатепроцесс**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) или [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) , система не вызывает функцию точки входа DLL.
-   Новый поток создается в процессе, который загрузил библиотеку DLL. Функцию [**дисаблесреадлибрарикаллс**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) можно использовать для отключения уведомлений при создании потоков.
-   Поток процесса, который загрузил библиотеку DLL, завершается нормально, но не использует [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) или [**терминатепроцесс**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess). Когда процесс выгружает библиотеку DLL, функция точки входа вызывается только один раз для всего процесса, а не один раз для каждого существующего потока процесса. [**Дисаблесреадлибрарикаллс**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) можно использовать для отключения уведомлений о завершении потоков.

Только один поток за раз может вызвать функцию точки входа.

Система вызывает функцию точки входа в контексте процесса или потока, который вызвал вызов функции. Это позволяет библиотеке DLL использовать свою функцию точки входа для выделения памяти в виртуальном адресном пространстве вызывающего процесса или для открытия дескрипторов, доступных процессу. Функция точки входа также может выделить память, которая является закрытой для нового потока, используя локальное хранилище потока (TLS). дополнительные сведения о локальном хранилище потоков см. в разделе [local служба хранилища потока](/windows/desktop/ProcThread/thread-local-storage).

## <a name="entry-point-function-definition"></a>Определение функции Entry-Point

Функция точки входа DLL должна быть объявлена с соглашением о вызовах Standard-Call. Если точка входа DLL не объявлена должным образом, Библиотека DLL не загружается, а система отображает сообщение, указывающее, что точка входа DLL должна быть объявлена с помощью WINAPI.

В теле функции можно выполнять любое сочетание следующих сценариев, в которых была вызвана точка входа DLL:

-   Процесс загружает библиотеку DLL (**\_ \_ Подключение к процессу DLL**).
-   Текущий процесс создает новый поток (**\_ \_ присоединение потока DLL**).
-   Поток завершается обычным образом **( \_ \_ Отключение потока DLL**).
-   Процесс выгружает библиотеку DLL (**\_ \_ отсоединение процесса DLL**).

Функция точки входа должна выполнять только простые задачи инициализации. Он не должен вызывать функцию [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) или [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) (или функцию, которая вызывает эти функции), так как это может создавать циклы зависимостей в порядке загрузки DLL. Это может привести к тому, что библиотека DLL будет использоваться до того, как система выполнила свой код инициализации. Аналогичным образом функция точки входа не должна вызывать функцию [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) (или функцию, которая вызывает **FreeLibrary**) во время завершения процесса, так как это может привести к тому, что библиотека DLL будет использоваться после того, как система выполнит свой код завершения.

Поскольку Kernel32.dll гарантированно загружается в адресное пространство процесса при вызове функции точки входа, вызов функций в Kernel32.dll не приводит к тому, что библиотека DLL будет использоваться до выполнения кода инициализации. Поэтому функция точки входа может создавать [объекты синхронизации](/windows/desktop/Sync/synchronization-objects) , такие как критические разделы и мьютексы, и использовать TLS, так как эти функции находятся в Kernel32.dll. Не рекомендуется вызывать функции реестра, например, так как они находятся в Advapi32.dll.

Вызов других функций может привести к проблемам, которые трудно диагностировать. Например, вызов функций User, Shell и COM может вызвать ошибки нарушения прав доступа, так как некоторые функции в их библиотеках DLL вызывают функцию [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) для загрузки других компонентов системы. И наоборот, вызов этих функций во время завершения может вызвать ошибки нарушения прав доступа, так как соответствующий компонент может быть уже выгружен или неинициализирован.

В следующем примере показано, как структурировать функцию точки входа DLL.

``` syntax
BOOL WINAPI DllMain(
    HINSTANCE hinstDLL,  // handle to DLL module
    DWORD fdwReason,     // reason for calling function
    LPVOID lpReserved )  // reserved
{
    // Perform actions based on the reason for calling.
    switch( fdwReason ) 
    { 
        case DLL_PROCESS_ATTACH:
         // Initialize once for each new process.
         // Return FALSE to fail DLL load.
            break;

        case DLL_THREAD_ATTACH:
         // Do thread-specific initialization.
            break;

        case DLL_THREAD_DETACH:
         // Do thread-specific cleanup.
            break;

        case DLL_PROCESS_DETACH:
         // Perform any necessary cleanup.
            break;
    }
    return TRUE;  // Successful DLL_PROCESS_ATTACH.
}
```

## <a name="entry-point-function-return-value"></a>Entry-Point возвращаемое значение функции

Когда вызывается функция точки входа библиотеки DLL из-за загрузки процесса, функция возвращает **значение true** , чтобы указать на успешное выполнение. Для процессов, использующих связывание во время загрузки, возвращаемое значение **false** приводит к сбою инициализации процесса и завершению процесса. Для процессов, использующих связывание во время выполнения, возвращаемое значение FALSE приводит к тому, что функция [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) или [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) возвращает **значение NULL**, означающее сбой. (Система немедленно вызывает функцию точки входа с **\_ \_ отсоединением процесса DLL** и выгружает библиотеку DLL.) Возвращаемое значение функции точки входа не учитывается, если функция вызывается по какой-либо другой причине.

 

 
