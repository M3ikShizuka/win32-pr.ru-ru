---
description: Хранилище сертификатов является центральным для всех операций управления сертификатами.
ms.assetid: e5c7c882-cbfc-4343-952c-b13c67326756
title: Расширение функциональных возможностей Цертопенсторе
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4cce198578cc482ba0488bd97ae0f1d7f923511b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104560832"
---
# <a name="extending-certopenstore-functionality"></a>Расширение функциональных возможностей Цертопенсторе

[*Хранилище сертификатов*](../secgloss/c-gly.md) является центральным для всех операций управления сертификатами. Функциональность функции [**цертопенсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certopenstore) можно расширить с помощью устанавливаемой (или зарегистрированной) функции поставщика хранилища сертификатов. Общие сведения об установке и регистрации функций для использования с CryptoAPI см. в разделе [Общие сведения о OID](oid-overview.md).

> [!Note]  
> Пользовательские хранилища сертификатов не переносятся автоматически при выполнении автоматических развертываний. Чтобы перенести пользовательские хранилища сертификатов, необходимо создать манифест для переноса пользовательских хранилищ и использовать средство миграции пользовательской среды Windows (USMT). Средство USMT доступно для загрузки в центре загрузки Майкрософт по адресу <https://www.microsoft.com/download/details.aspx?id=10837> .

 

[**Цертопенсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certopenstore) открывает пустое хранилище в памяти и вызывает функцию поставщика хранилища (если она зарегистрирована или установлена) с помощью [*идентификатора объекта*](../secgloss/o-gly.md) (OID), переданного в параметре *лпсзсторепровидер* . Список стандартных типов поставщиков, предоставляемых с помощью CryptoAPI, см. в разделе **цертопенсторе**.

Функция поставщика хранилища копирует свои сертификаты и [*списки отзыва сертификатов*](../secgloss/c-gly.md) (CRL) в хранилище в памяти, заданное *хцертстореным* обработчиком. Новая функция поставщика хранилища может использовать любые функции хранилища сертификатов CryptoAPI, такие как, [**цертаддцертификатеконтексттосторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certaddcertificatecontexttostore) или [**цертаддсериализеделементтосторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certaddserializedelementtostore), чтобы добавить свои сертификаты и списки отзыва сертификатов в хранилище в памяти. Кроме того, функция Store-provider при необходимости возвращает значения для всех элементов данных структуры [**\_ \_ Prov \_ info хранилища сертификатов**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_store_prov_info) . Функция должна обновить эту структуру только в том случае, если она поддерживает дополнительные функции обратного вызова. Например, если хранилище должно быть хранилищем только для чтения, то поддержка других функций обратного вызова, вероятно, не потребуется. Дополнительные сведения и прототипы возможных функций обратного вызова см. в разделе [функции обратного вызова поставщика хранилища сертификатов](cryptography-functions.md).

Хранилище TrustedPeople на пользователя ограничено стандартными физическими хранилищами. Вы не можете расширить TrustedPeople хранилище "на пользователя". Однако можно расширить хранилище TrustedPeople локального компьютера.

**Windows XP и Windows Server 2003:** Хранилище TrustedPeople на пользователя не ограничено предопределенными физическими хранилищами.

Одним из элементов данных структуры [**\_ \_ Prov \_ info хранилища сертификатов**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_store_prov_info) является массив *ргпвсторепровфунк* . Если функция поставщика хранилища должна поддерживать одну или несколько функций обратного вызова, она должна предоставлять указатели для этого массива. Эти указатели должны указывать на функции обратного вызова, которые будут использоваться для других действий хранилища сертификатов (например, закрытие хранилища). На следующем рисунке показан поток этого процесса.

![функции цертопенсторе](images/openstor.png)

Как показано на следующем рисунке, после открытия хранилища другие функции CryptoAPI (например, [**цертклосесторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certclosestore)) используют массив указателей для доступа к функциям обратного вызова, выполняющим предполагаемую задачу. Определение [**\_ \_ \_ информационной структуры Prov хранилища**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_store_prov_info) сертификатов и прототипов функций обратного вызова по умолчанию, предоставляемых с помощью CryptoAPI, показаны в [функциях обратного вызова поставщика хранилища сертификатов](cryptography-functions.md).

![функции цертклосесторе](images/closstor.png)

API-интерфейсы магазина позволяют поставщику услуг магазина поддерживать сертификаты, списки отзыва сертификатов и [*списков доверия сертификатов*](../secgloss/c-gly.md) (CTL) за пределами кэша хранилища (например, внешней базы данных сертификатов, например, предоставленной базой данных Microsoft Certificate Server).

[**Цертопенсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certopenstore) отправляет через параметр *Псзсторепровидер* в соответствующую [**цертдллопенсторепров**](/windows/win32/api/Wincrypt/nc-wincrypt-pfn_cert_dll_open_store_prov_func) функцию устанавливаемого поставщика. Поставщик возвращает сведения в параметре *псторепровинфо* , который указывает на структуру [**\_ \_ Prov \_ info хранилища сертификатов**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_store_prov_info) . Структура **\_ \_ \_ сведений о Prov хранилища сертификатов** содержит элемент **двсторепровфлагс** . \_ \_ \_ Был добавлен флаг внешнего флага хранилища сертификатов Prov, позволяющий \_ поставщику указать, что сертификаты, списки отзыва сертификатов и списки CTL являются внешними по отношению к кэшу хранилища.

[**Цертдллопенсторепров**](/windows/win32/api/Wincrypt/nc-wincrypt-pfn_cert_dll_open_store_prov_func) возвращает массив функций обратного вызова. Поставщик может реализовать следующие функции обратного вызова:

-   \_ \_ Prov \_ закрытие Func хранилища \_ сертификатов
-   сертификат \_ хранилища сертификатов \_ Prov \_ Чтение \_ сертификата \_ Func
-   \_хранилище сертификатов \_ Prov \_ запись \_ сертификата \_ Func
-   \_хранилище сертификатов \_ Prov \_ удалить \_ сертификат \_ Func
-   \_хранилище сертификатов \_ Prov \_ Set \_ CERT \_ Property \_ Func
-   \_хранилище сертификатов \_ Prov \_ Чтение \_ CRL \_ Func
-   \_хранилище сертификатов \_ Prov \_ запись \_ CRL \_ Func
-   \_хранилище сертификатов \_ Prov \_ удалить \_ CRL \_ Func
-   \_хранилище сертификатов \_ Prov \_ задать \_ \_ свойство CRL \_ Func
-   \_хранилище сертификатов \_ Prov \_ Чтение \_ CTL \_ Func
-   \_хранилище сертификатов \_ Prov \_ запись \_ CTL \_ Func
-   \_хранилище сертификатов \_ Prov \_ удалить \_ CTL \_ Func
-   \_хранилище сертификатов \_ Prov \_ задать \_ \_ свойство CTL \_ Func

При обращении к \_ сертификату записи, записи \_ списка отзыва сертификатов и записи \_ функций обратного вызова CTL, если \_ \_ установлен флаг Prov Write для хранилища сертификатов \_ \_ \_ , верхние 16 разрядов параметра *dwFlags* содержат значение *двадддиспоситион* . Для поддержки внешних хранилищ поставщик может реализовать следующие функции обратного вызова:

-   \_хранилище сертификатов \_ Prov \_ найти \_ сертификат \_ Func
-   \_хранилище сертификатов \_ Prov \_ бесплатный \_ Поиск \_ сертификата \_ Func
-   \_хранилище сертификатов \_ Prov \_ получения \_ \_ Свойства сертификата \_ Func
-   \_хранилище сертификатов \_ Prov \_ найти \_ CRL \_ Func
-   \_хранилище сертификатов \_ Prov \_ бесплатный \_ Поиск \_ CRL \_ Func
-   \_ \_ Prov \_ получения \_ свойства CRL хранилища \_ сертификатов \_ Func
-   \_хранилище сертификатов \_ Prov \_ найти \_ CTL \_ Func
-   \_хранилище сертификатов \_ Prov \_ бесплатный \_ Поиск \_ CTL \_ Func
-   \_ \_ Prov \_ получения \_ Свойства CTL хранилища \_ сертификатов \_ Func

Функции обратного вызова сертификата имеют следующие сигнатуры:

``` syntax
typedef struct _CERT_STORE_PROV_FIND_INFO {
    DWORD               cbSize;
    DWORD               dwMsgAndCertEncodingType;
    DWORD               dwFindFlags;
    DWORD               dwFindType;
    const void          *pvFindPara;
} CERT_STORE_PROV_FIND_INFO, *PCERT_STORE_PROV_FIND_INFO;
typedef const CERT_STORE_PROV_FIND_INFO CCERT_STORE_PROV_FIND_INFO,
    *PCCERT_STORE_PROV_FIND_INFO;

typedef BOOL (WINAPI *PFN_CERT_STORE_PROV_FIND_CERT)(
        IN HCERTSTOREPROV hStoreProv,
        IN PCCERT_STORE_PROV_FIND_INFO pFindInfo,
        IN PCCERT_CONTEXT pPrevCertContext,
        IN DWORD dwFlags,
        IN OUT void **ppvStoreProvFindInfo,
        OUT PCCERT_CONTEXT *ppProvCertContext
        );

typedef BOOL (WINAPI *PFN_CERT_STORE_PROV_FREE_FIND_CERT)(
        IN HCERTSTOREPROV hStoreProv,
        IN PCCERT_CONTEXT pCertContext,
        IN void *pvStoreProvFindInfo,
        IN DWORD dwFlags
        );

typedef BOOL (WINAPI *PFN_CERT_STORE_PROV_GET_CERT_PROPERTY)(
        IN HCERTSTOREPROV hStoreProv,
        IN PCCERT_CONTEXT pCertContext,
        IN DWORD dwPropId,
        IN DWORD dwFlags,
        OUT void *pvData,
        IN OUT DWORD *pcbData
        );
```

Сигнатуры для функций обратного вызова списка отзыва сертификатов и CTL идентичны с указателем на [**\_ контекст сертификата**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_context) , замененным указателем на [**\_ контекст списка отзыва сертификатов**](/windows/win32/api/Wincrypt/ns-wincrypt-crl_context) или [**\_ контекст CTL**](/windows/win32/api/Wincrypt/ns-wincrypt-ctl_context).

\_Обратный вызов Find Certificate вызывается при перечислении, поиске или добавлении сертификатов API-интерфейсам хранилища. *ппревцертконтекст* и *Ппвсторепровфиндинфо* имеют значение **null** для инициации нового поиска. Возвращенный *ппвсторепровфиндинфо* передается обратно при следующем поиске, когда он может быть освобожден поставщиком. Поставщик может задать все, некоторые или ни одно из свойств сертификата. Поставщик имеет возможность отложить до \_ \_ вызова свойства Get CERT. Рекомендуется, чтобы поставщики установили максимально возможное количество свойств, чтобы разрешить копирование в другое хранилище.

В [**цертфиндцертификатеинсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certfindcertificateinstore)поддерживаются следующие типы поиска сертификатов:

-   \_Поиск сертификата \_
-   \_Поиск сертификата \_ по \_ хэшу SHA1
-   \_Поиск сертификата \_ MD5 \_ hash
-   \_свойство поиска \_ сертификатов
-   \_Поиск \_ открытого \_ ключа сертификата
-   \_Поиск \_ имени субъекта \_ в сертификате
-   \_найти \_ attr субъекта \_ в сертификате
-   \_Поиск \_ имени издателя \_ сертификата
-   СЕРТИФИКАТ поиска с атрибутом \_ \_ Issuer \_
-   \_Поиск \_ и определение субъекта \_ \_ в str
-   Поиск в выпуске " \_ \_ \_ строка темы \_ W"
-   \_Поиск сертификата \_ \_ — строка \_ издателя
-   \_Поиск сертификата \_ — \_ строка \_ издателя
-   \_Спецификация поиска \_ ключа \_ сертификата
-   \_Поиск \_ ЕНХКЭЙ \_ использования сертификата

\_Обратный вызов Find CERT вызывается для каждого из перечисленных выше типов поиска. Параметры, передаваемые в [**цертфиндцертификатеинсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certfindcertificateinstore) , копируются непосредственно в \_ хранилище сертификатов \_ Prov \_ найти \_ структуру сведений перед \_ вызовом функции "найти сертификат". Дополнительные сведения о значениях полей для различных типов поиска в \_ структуре Certificate Store \_ Prov \_ Find \_ info см. в разделе **цертфиндцертификатеинсторе**.

Следующие типы поиска сертификатов поддерживают API [**цертжетсубжектцертификатефромсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certgetsubjectcertificatefromstore) и [**цертжетиссуерцертификатефромсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certgetissuercertificatefromstore) и помогают определить, существует ли уже сертификат в хранилище перед добавлением:

-   СЕРТИФИКАТ \_ поиска \_ субъекта \_ сертификата
-   \_Поиск \_ поставщика \_ сертификата
-   \_Поиск \_ существующего сертификата

Для сертификата \_ Поиск \_ субъекта \_ сертификата параметр *пвфиндпара* указывает на структуру [**\_ сведений о сертификате**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_info) , содержащую издателя и серийный номер субъекта. Для сертификата \_ найти \_ издатель \_ , *пвфиндпара* указывает на структуру [**\_ контекста сертификата**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_context) субъекта. \_ \_ Чтобы найти существующий сертификат, *пвфиндпара* указывает на **\_ контекст** сертификата, чтобы проверить его существование в хранилище.

Обратный вызов по БЕСПЛАТНОму \_ поиску сертификата \_ вызывается, когда сертификат, возвращенный функцией \_ обратного вызова find CERT, не был освобожден с помощью в последующем следующем поиске \_ сертификата, поэтому значение [*счетчика ссылок*](../secgloss/r-gly.md) уменьшается до нуля или освобождается вызовом [**цертклосесторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certclosestore). Перед вызовом функции обратного вызова CLOSE все сертификаты, возвращенные функцией обратного вызова FIND Certificate, \_ должны быть освобождены для поставщика путем передачи в вызов обратного вызова по поиску \_ сертификата или вызова бесплатного запроса на \_ Поиск \_ сертификата. То же относится и к ответным вызовам CRL и CTL.

\_ \_ Обратный вызов свойства Get CERT вызывается методом [**цертжетцертификатеконтекстпроперти**](/windows/win32/api/Wincrypt/nf-wincrypt-certgetcertificatecontextproperty) , если не удается найти указанное свойство для параметра *пцертконтекст* . Это справедливо и для свойства GET \_ CRL \_ и получения \_ Свойства CTL \_ .

\_Обратный вызов Find CRL вызывается, когда API-интерфейсы хранилища перечисляют или получают списки отзыва сертификатов и перед добавлением списка отзыва сертификатов. Будут определены следующие типы поиска CRL:

Для списка отзыва сертификатов \_ \_ , выпущенного \_ , *пвфиндпара* является указателем [**на \_ контекст сертификата**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_context) поставщика CRL. Для списка CRL Find Exists \_ \_ *пвфиндпара* — это указатель на [**\_ контекст**](/windows/win32/api/Wincrypt/ns-wincrypt-crl_context) списка отзыва сертификатов, чтобы определить, существует ли он в магазине.

\_Обратный вызов Find CTL вызывается при перечислении или поиске списков CTL в API-интерфейсах магазина. В [**цертфиндктлинсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certfindctlinstore)поддерживаются следующие типы поиска CTL:

-   CTL " \_ найти \_ все"
-   CTL \_ " \_ найти \_ хэш SHA1"
-   CTL \_ " \_ найти \_ хэш MD5"
-   \_Поиск по \_ использованию CTL
-   CTL " \_ найти \_ тему"
-   CTL " \_ найти \_ существующий"

\_Обратный вызов Find CTL вызывается для каждого из перечисленных выше типов поиска. Параметры, передаваемые в [**цертфиндктлинсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certfindctlinstore) , копируются непосредственно в \_ хранилище сертификатов \_ Prov \_ найти \_ структуру сведений перед вызовом \_ обратного вызова find CTL. Дополнительные сведения о значениях полей для различных типов поиска в \_ структуре Certificate Store \_ Prov \_ Find \_ info см. в разделе **цертфиндктлинсторе**.

Список CTL " \_ найти \_ существующий CTL" позволяет определить, существует ли уже этот CTL в магазине перед добавлением списка доверия сертификатов.

Для CTL " \_ найти \_ существующий" *пвфиндпара* является указателем на структуру [**\_ контекста CTL**](/windows/win32/api/Wincrypt/ns-wincrypt-ctl_context) CTL, чтобы определить, существует ли он в хранилище.

 

 
