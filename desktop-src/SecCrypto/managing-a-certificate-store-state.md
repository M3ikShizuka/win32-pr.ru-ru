---
description: Несколько функций предоставляют службы для управления состоянием хранилища сертификатов.
ms.assetid: bae3d693-31b3-4c1d-9a8f-0dafa8bb6897
title: Управление состоянием хранилища сертификатов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 75cbbb41691b66abfa2d49d669b13ec7fd438bd4ae503bf944d9e4923f647f29
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119425674"
---
# <a name="managing-a-certificate-store-state"></a>Управление состоянием хранилища сертификатов

Несколько функций предоставляют службы для управления [*состоянием*](../secgloss/s-gly.md) [*хранилища сертификатов*](../secgloss/c-gly.md) .

Чтобы получить доступ к сертификатам, хранилище сертификатов, в котором они хранятся, необходимо открыть с помощью вызова [**цертопенсторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) или [**цертопенсистемсторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopensystemstorea).

Обычно хранилище сертификатов открывается в кэшированной памяти. Это может быть новое хранилище или его содержимое, которое можно загрузить из локального реестра, реестра на удаленном компьютере, файла на диске, \# сообщения PKCS 7 или другого источника.

Функции хранилища сертификатов CryptoAPI также позволяют магазину хранить сертификаты вне кэшированной памяти в, например, во внешней базе данных сертификатов, например в базе данных Microsoft Certificate Server.

Один из параметров функции [**цертопенсторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) , *лпсзсторепровидер,* определяет тип открытого хранилища и поставщика, используемого для открытия этого хранилища. Примеры открытия хранилищ сертификатов с помощью различных поставщиков см. [в примере кода C для открытия хранилищ сертификатов](example-c-code-for-opening-certificate-stores.md).

[**Цертклосесторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) закрывает хранилище сертификатов. При закрытии хранилища сертификатов для каждого из контекстов сертификатов в этом хранилище уменьшается [*число ссылок*](../secgloss/r-gly.md) , уменьшенное на единицу. Память освобождается для сертификатов, количество ссылок которых равно нулю.

Установка \_ \_ \_ флага принудительного закрытия хранилища сертификата \_ с помощью [**цертклосесторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) закрывает хранилище сертификатов и освобождает память для всех его контекстов сертификатов независимо от их счетчика ссылок. В некоторых случаях, например в многопоточных программах, это нежелательно. Если установлен \_ \_ \_ флаг проверки закрытия сертификата \_ , хранилище закрывается, но функция возвращает значение предупреждения, если память по-прежнему выделяется для сертификатов, счетчик ссылок которых не был уменьшен до нуля. Если число ссылок на сертификат больше нуля, то дубликат этого контекста сертификата не был освобожден. Для освобождения открытых сертификатов используйте [**цертфрицертификатеконтекст**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecertificatecontext), [**цертфрикрлконтекст**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecrlcontext)и [**цертфриктлконтекст**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreectlcontext) .

> [!Note]
> [*Контекст сертификата*](../secgloss/c-gly.md) представляет собой структуру [**\_ контекста типа CERT**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_context) , имеющую, помимо прочих членов, указатель на закодированный [*BLOB-объект сертификата*](../secgloss/c-gly.md) и указатель на структуру [**\_ сведений о сертификате**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_info) . Структура **\_ сведений о** сертификате содержит наиболее значимые данные сертификата. Дополнительные сведения о [*сертификате*](../secgloss/c-gly.md), [*списке отзыва сертификатов*](../secgloss/c-gly.md) (CRL) и структурах контекста [*списка доверия сертификатов*](../secgloss/c-gly.md) (CTL) см. [в разделе Кодирование и декодирование контекста сертификата](encoding-and-decoding-a-certificate-context.md).
> 
> Каждый контекст сертификата также содержит [*счетчик ссылок*](../secgloss/r-gly.md) , указывающий количество назначенных копий адреса контекста. Каждый раз, когда контекст сертификата дублируется каким-либо образом, его счетчик ссылок увеличивается на единицу. Каждый раз при освобождении указателя на контекст сертификата число ссылок в контексте сертификата уменьшается на единицу. Когда количество ссылок в контексте сертификата достигает нуля, память, удерживаемая в контексте, освобождается. Память, выделенная для контекста сертификата, также освобождается, если этот контекст находится в хранилище, а хранилище закрыто с помощью \_ \_ \_ флага принудительного закрытия сертификата \_ . Если память для контекста освобождается и указатели на этот контекст все еще используются, эти указатели больше не являются допустимыми.

 

[**Цертдупликатесторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certduplicatestore) увеличивает [*число ссылок*](../secgloss/r-gly.md) в магазине.

[**Цертсавесторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsavestore) сохраняет содержимое хранилища в файл на диске или в область памяти;

[**Цертконтролсторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) управляет хранилищем, когда оно открыто. Приложение с открытым хранилищем может получать уведомления, когда сохраненное состояние этого хранилища изменилось другим процессом. Это может произойти, если новые сертификаты были скопированы в хранилище локального компьютера с компьютера, на котором выполняется управление доменами.

При обнаружении изменений кэшированное хранилище может повторно синхронизировать свое кэшированное хранилище в соответствии с сохраненным состоянием хранилища. [**Цертконтролсторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) также поддерживает процесс, который копирует изменения кэшированного хранилища в постоянное хранилище, если эти изменения в кэшированном хранилище не сохраняются автоматически.

Контексты сертификатов, схожие с хранилищем сертификатов, могут иметь расширенные свойства. [**Цертсетсторепроперти**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsetstoreproperty) добавляет расширенные свойства в хранилище сертификатов. [**Цертжетсторепроперти**](/windows/desktop/api/Wincrypt/nf-wincrypt-certgetstoreproperty) извлекает все свойства, заданные в хранилище сертификатов. В настоящее время единственным предопределенным свойством хранилища сертификатов является локализованное имя хранилища.

 

 
