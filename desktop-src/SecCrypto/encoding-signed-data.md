---
description: Описывает процедуру кодирования подписанного сообщения.
ms.assetid: 40d1c417-6d88-4421-920f-8b40d88d28ce
title: Кодирование подписанных данных
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 43e5c3ab338c4e7b251416f1a488747eb0c9b897c1fa02082afcb580cb12341b
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119874852"
---
# <a name="encoding-signed-data"></a>Кодирование подписанных данных

[*Подписанные данные*](../secgloss/s-gly.md) состоят из содержимого любого типа и [*хэшей*](../secgloss/h-gly.md) зашифрованных сообщений с содержимым от одного или нескольких подписывающих. Полученный хэш может подтвердить, что исходное сообщение не было изменено с момента подписания и что определенные лица или сущности подписаны данным.

На следующем рисунке показана процедура кодирования подписанного сообщения. Эти шаги описаны в списке, приведенном на рисунке.

Сообщение может иметь несколько подписывающих, алгоритмов хэширования и сертификатов. На рисунке показаны только сертификаты, [*списки отзыва*](../secgloss/c-gly.md)сертификатов и [*списки CTL*](../secgloss/c-gly.md) , которые могут использовать один и тот же процесс. Они помещаются на иллюстрации, где отображаются сертификаты.

![кодирование подписанного сообщения](images/signmsg2.png)

Общий процесс кодирования [*подписанных данных*](../secgloss/s-gly.md) выглядит следующим образом.

**Кодирование подписанных данных**

1.  Данные создаются (при необходимости) и получает указатель на него.
2.  Откроется [*хранилище сертификатов*](../secgloss/c-gly.md) , содержащее сертификат подписавших.
3.  Получен закрытый ключ для сертификата. Для сертификата необходимо задать два свойства, прежде чем использовать его. Один из них используется для привязки сертификата к конкретному CSP и, в пределах этого CSP, к конкретному [*контейнеру*](../secgloss/k-gly.md)закрытого ключа. Другой используется для указания того, какой алгоритм хэширования следует использовать при вызове операции [*хэширования*](../secgloss/h-gly.md) . Их необходимо задать только один раз.
4.  Свойство сертификата определяет хэш-алгоритм.
5.  Хэш данных создается путем отправки данных с помощью функции хэширования.
6.  Подпись создается путем шифрования хэша с помощью закрытого ключа, полученного с помощью свойства сертификата.
7.  В готовое подписанное сообщение включаются следующие данные:
    -   Исходные данные для подписи
    -   Алгоритмы хэширования
    -   Сигнатуры
    -   Структуры сведений о подписавшем, включая идентификатор подписавший (поставщик сертификата и серийный номер).
    -   Сертификаты подписавший (необязательно)

Эта процедура иллюстрирует простой вариант. Более сложные случаи включают в себя атрибуты, прошедшие проверку подлинности, которые включены в сообщение. Если тип содержимого является любым, но строкой **байта** , или существует по крайней мере один атрибут, прошедший проверку подлинности, и любой тип данных, необходимы два стандартных атрибута проверки подлинности: тип содержимого (Data) и хэш содержимого. В этих обстоятельствах [*CryptoAPI*](../secgloss/c-gly.md) автоматически предоставляет эти два обязательных атрибута. Низкоуровневые функции облагают атрибуты, прошедшие проверку подлинности, шифруют хэш-код с помощью закрытого ключа и предоставляют его в качестве сигнатуры.

Используйте низкоуровневые функции обработки сообщений для выполнения перечисленных задач с помощью следующей процедуры.

**Кодирование подписанного сообщения**

1.  Создайте или извлеките содержимое.
2.  Получение поставщика служб шифрования.
3.  Получение сертификатов подписавших.
4.  Инициализируйте [**структуру \_ \_ \_ сведений о кодировке КМСГ для подписания**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signer_encode_info) .
5.  Инициализируйте [**структуру \_ \_ \_ сведений о кодировании со знаком КМСГ**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) .
6.  Вызовите [**криптмсгкалкулатинкодедленгс**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) , чтобы получить размер BLOB-объекта закодированного сообщения. Выделите память для нее.
7.  Вызовите [**криптмсгопентоенкоде**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), передав КМСГ, \_ подписанный на *двмсгтипе* , и указатель на [**КМСГ \_ подписанные \_ \_ сведения о кодировке**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) для *пвмсженкодеинфо* , чтобы получить маркер открытого сообщения.
8.  Вызовите [**криптмсгупдате**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), передав маркер, полученный на шаге 7, и указатель на данные, которые должны быть подписаны и закодированы. Эту функцию можно вызывать столько раз, сколько необходимо для завершения процесса кодирования.
9.  Вызовите [**криптмсгжетпарам**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), передав маркер, полученный на шаге 7, и соответствующие типы параметров для доступа к нужным закодированным данным. Например, передайте значение \_ параметра КМСГ Content \_ param, чтобы получить указатель на все сообщение [*PKCS \# 7*](../secgloss/p-gly.md) .

    Если результат этой кодировки будет использоваться в качестве [*внутренних данных*](../secgloss/i-gly.md) для другого закодированного сообщения, например сообщения, упакованного в оболочку, \_ \_ \_ необходимо передать параметр параметра КМСГ исходного содержимого. Пример, демонстрирующий это, см. в разделе [альтернативный код для кодирования запечатанного сообщения](alternate-code-for-encoding-an-enveloped-message.md).

10. Закройте сообщение, вызвав [**криптмсгклосе**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).

Результатом этой процедуры является закодированное сообщение, содержащее исходные данные, зашифрованный хэш данных (сигнатура) и сведения о подписавшем. Также имеется указатель на требуемый закодированный BLOB-объект.

Сведения о кодировании C см. в разделе [Пример программы c: подписывание, кодирование, декодирование и проверка сообщения](example-c-program-signing-encoding-decoding-and-verifying-a-message.md).

 

 
