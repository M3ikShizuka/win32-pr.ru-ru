---
description: Показывает, как отправить зашифрованное сообщение.
ms.assetid: 928b1863-7a54-4bf0-b447-85b8c2868bcd
title: Обмен ключами сеансов вручную
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b0114f8173084126a72519d291158f15f3e1c171
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104552169"
---
# <a name="manual-session-key-exchanges"></a>Обмен ключами сеансов вручную

> [!Note]  
> В процедуре, описанной в этом разделе, предполагается, что пользователи (или клиенты CryptoAPI) уже имеют собственный набор [*пар открытого и закрытого ключей*](../secgloss/p-gly.md) , а также получили [*открытые ключи*](../secgloss/p-gly.md)друг друга.

 

На следующем рисунке показано, как использовать эту процедуру для отправки зашифрованного сообщения.

![Отправка зашифрованного сообщения](images/capi04.png)

Этот подход уязвим по крайней мере для одной из распространенных форм атак. Перехватчик может получать копии одного или нескольких зашифрованных сообщений и зашифрованных ключей. Затем через некоторое время перехватчик может отправить одно из этих сообщений получателю, и получатель не сможет узнать, что сообщение не получено непосредственно от исходного отправителя. Этот риск можно уменьшить за счет отметки времени всех сообщений или с помощью серийных номеров.

Самым простым способом отправки зашифрованных сообщений другому пользователю является отправка сообщения, зашифрованного с помощью случайного ключа сеанса, и ключа сеанса, зашифрованного с помощью [*открытого ключа*](../secgloss/k-gly.md)получателя.

Ниже приведены действия по отправке зашифрованного ключа сеанса.

**Отправка зашифрованного ключа сеанса**

1.  Создайте случайный [*сеансовый ключ*](../secgloss/s-gly.md) с помощью функции [**криптженкэй**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptgenkey) .
2.  Шифрование сообщения с помощью ключа сеанса. Эта процедура обсуждается в разделе [Шифрование и расшифровка данных](data-encryption-and-decryption.md).
3.  Экспортируйте ключ сеанса в [*большой двоичный объект ключа*](../secgloss/k-gly.md) с помощью функции [**криптекспорткэй**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptexportkey) , указав, что ключ должен быть зашифрован с помощью открытого ключа пользователя для обмена ключами.
4.  Отправьте зашифрованное сообщение и зашифрованный ключевой BLOB-объект пользователю назначения.
5.  Конечный пользователь импортирует большой двоичный объект ключа в свой CSP с помощью функции [**криптимпорткэй**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptimportkey) . При этом ключ сеанса будет автоматически расшифрован, если на шаге 3 был указан открытый ключ для обмена ключами конечного пользователя.
6.  Затем конечный пользователь может расшифровать сообщение с помощью ключа сеанса, следуя процедуре, описанной в разделе [Шифрование и расшифровка данных](data-encryption-and-decryption.md).

 

 
