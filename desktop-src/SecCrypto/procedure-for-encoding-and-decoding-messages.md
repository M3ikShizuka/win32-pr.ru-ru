---
description: Сведения о процедуре кодирования общего сообщения.
ms.assetid: 554cab0d-cfa2-46a7-80d9-f41430eb4b47
title: Процедура кодирования и декодирования сообщений
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 49da09c2318fffd3d1c92d6012055172709609a7
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105683268"
---
# <a name="procedure-for-encoding-and-decoding-messages"></a>Процедура кодирования и декодирования сообщений

Процедура кодирования общего сообщения выглядит следующим образом.

**Кодирование сообщения**

1.  Инициализируйте соответствующие структуры данных для требуемого типа данных.
2.  Вызовите [**криптмсгопентоенкоде**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), передав необходимые аргументы. Если при вызове **криптмсгопентоенкоде** данные, которые должны быть предоставлены [**криптмсгупдате**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate) , уже закодированы в сообщении, передайте соответствующий идентификатор объекта в *псзиннерконтентобжид* (например, "1.2.840.113549.1.7.2" для сзоид \_ RSA \_ signedData). Если *псзиннерконтентобжид* имеет **значение NULL**, то предполагается, что тип [*внутреннего содержимого*](../secgloss/i-gly.md) не был ранее закодирован и обрабатывается соответствующим образом.
3.  Вызовите [**криптмсгупдате**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate) столько раз, сколько необходимо для завершения сообщения. При последнем вызове задайте для параметра *ФФинал* **значение true**. (Дополнительные сведения см. в разделе **криптмсгупдате**).
4.  Вызовите [**криптмсгжетпарам**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam) , чтобы получить указатель на нужные параметры, например содержимое. Для кодирования простых, общих данных используйте \_ параметр содержимого КМСГ \_ для *двпарамтипе*.
5.  Закройте сообщение, вызвав [**криптмсгклосе**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).

Эта процедура приводит к получению закодированного сообщения типа, указанного в вызовах функции.

Ниже приведена процедура декодирования общего сообщения.

**Расшифровка сообщения**

1.  Определите длину, необходимую буферу для хранения закодированных данных, с помощью [**криптмсгкалкулатинкодедленгс**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength).
2.  Вызовите [**криптмсгопентодекоде**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentodecode), передав необходимые аргументы. Чтобы обеспечить совместимость с Internet Explorer версии 3,0, предоставляется параметр *двмсгтипе* . Подписанные данные, созданные в Internet Explorer 3,0, не содержат сведений о заголовке. Таким образом, если такое сообщение извлекается из сигнатур файлов, тип сообщения должен передаваться в функцию. Если в параметр *двмсгтипе* передается ноль, функция будет считывать тип сообщений из заголовка сообщения. Если заголовок отсутствует, вызов функции завершится ошибкой. В случае успешного выполнения возвращается маркер открытого сообщения.
3.  Вызовите [**криптмсгупдате**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate) один раз. Это приводит к тому, что в зависимости от типа сообщений в сообщении будут выполняться соответствующие действия.
4.  Для дополнительной обработки сообщения, например дополнительной расшифровки или проверки подписи, вызовите [**криптмсгконтрол**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcontrol), передав нужное действие в *двктрлтипе*.
5.  Вызовите [**криптмсгжетпарам**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam) , чтобы получить указатель на нужные параметры, например содержимое. Чтобы декодировать простые общие данные, используйте \_ параметр КМСГ содержимого \_ для параметра *двпарамтипе* .
6.  Вызовите [**криптмсгклосе**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose) , чтобы закрыть сообщение.

Пример, в котором реализованы эти шаги, см. в разделе [Пример программы C: кодирование и декодирование данных](example-c-program-encoding-and-decoding-data.md). Процедуры и пример, демонстрирующий процесс кодирования, декодирования и проверки подписи подписанного сообщения, см. в разделе [Пример программы C: подписывание, кодирование, декодирование и проверка сообщения](example-c-program-signing-encoding-decoding-and-verifying-a-message.md).

 

 
