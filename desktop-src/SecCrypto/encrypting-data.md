---
description: Описывает действия по шифрованию сообщения с использованием базовых криптографических функций.
ms.assetid: 34167767-96c5-4a20-b629-07e4d036b4d1
title: Шифрование данных
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 44db44db08268241e399107d8af4088dac3c0c2e
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104562867"
---
# <a name="encrypting-data"></a>Шифрование данных

В следующей процедуре описываются действия, которые необходимо выполнить для шифрования сообщения с использованием базовых криптографических функций. Для шифрования сообщений с использованием \# стандартов PKCS 7 см. раздел [низкоуровневые функции сообщений](cryptography-functions.md) и [упрощенные функции сообщений](cryptography-functions.md).

**Шифрование сообщения**

1.  Создайте сеансовый ключ с помощью функции [**криптженкэй**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptgenkey) .

    При выполнении этого вызова создается случайный ключ и возвращается маркер, чтобы ключ можно было использовать для шифрования и расшифровки данных. На этом этапе также указывается используемый алгоритм шифрования. Поскольку интерфейс CryptoAPI не позволяет приложениям использовать алгоритмы открытого ключа для шифрования данных большого объема, укажите симметричный алгоритм, например RC2 или RC4, с помощью вызова [**криптженкэй**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptgenkey) .

2.  Кроме того, можно использовать функцию [**криптдеривекэй**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptderivekey) для преобразования пароля в ключ, подходящий для шифрования.

    Если приложению необходимо зашифровать сообщение, чтобы любой пользователь с указанным паролем мог расшифровать данные, используйте [**криптдеривекэй**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptderivekey) для преобразования пароля в ключ, подходящий для шифрования.

    > [!Note]  
    > В этом случае эта функция вызывается вместо функции [**криптженкэй**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptgenkey) , а последующие вызовы [**криптекспорткэй**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptexportkey) не требуются.

     

3.  При необходимости задайте дополнительные криптографические свойства ключа с помощью функции [**криптсеткэйпарам**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptsetkeyparam) .

    После создания ключа дополнительные криптографические свойства ключа можно задать с помощью функции [**криптсеткэйпарам**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptsetkeyparam). Эта функция позволяет шифровать разные разделы файла с другими ключевыми Salt-файлами и предоставляет способ изменения режима шифрования или вектора инициализации ключа. Эти параметры можно использовать для обеспечения соответствия шифрования определенному стандарту шифрования данных.

4.  Зашифруйте данные в файле с помощью функции [**криптенкрипт**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptencrypt) .

    Функция [**криптенкрипт**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptencrypt) принимает сеансовый ключ, созданный на предыдущем шаге, и шифрует буфер данных.

    > [!Note]  
    > При шифровании данных данные могут быть немного расширены алгоритмом шифрования. Приложение отвечает за запоминание длины зашифрованных данных, чтобы впоследствии можно было указать правильную длину для функции [**криптдекрипт**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptdecrypt) .

     

5.  При необходимости используйте функцию [**криптекспорткэй**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptexportkey) , чтобы разрешить текущему пользователю расшифровывать данные в будущем.

    Чтобы разрешить текущему пользователю расшифровывать данные в будущем, функция [**криптекспорткэй**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptexportkey) используется для сохранения ключа дешифрования в зашифрованном виде (BLOB-объект ключа), который можно расшифровать только с помощью закрытого ключа пользователя. Для этой функции требуется открытый ключ обмена ключами пользователя для этой цели, который можно получить с помощью функции [**криптжетусеркэй**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptgetuserkey) . Функция **криптекспорткэй** вернет большой двоичный объект ключа, который должен храниться в приложении для использования при расшифровке файла.

> [!Note]  
> Если приложение имеет сертификаты (или открытые ключи) для других пользователей, оно может Разрешите другим пользователям расшифровать файл, выполнив вызовы [**криптекспорткэй**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptexportkey) для каждого пользователя, который должен получить доступ. Возвращаемые ключевые большие двоичные объекты должны храниться в приложении, как показано на шаге 5.

 

## <a name="creating-an-encrypted-message"></a>Создание зашифрованного сообщения

Упрощенные функции сообщений упрощают шифрование и расшифровку данных. На следующем рисунке показаны отдельные задачи, которые необходимо выполнить для шифрования сообщения. Шаги описаны в следующем списке.

![Шифрование сообщения](images/encmsg.png)

**Шифрование сообщения**

1.  Возвращает указатель на сообщение с открытым текстом.
2.  Создание симметричного ключа (сеанса).
3.  Шифрование данных сообщения с помощью симметричного ключа и указанного алгоритма шифрования.
4.  Откройте хранилище сертификатов.
5.  Получение сертификата получателя.
6.  Получите открытый ключ из сертификата получателя.
7.  С помощью открытого ключа получателя зашифруйте симметричный ключ.
8.  Получите идентификатор получателя из сертификата получателя.
9.  Включите в сообщение с цифровой подписью следующие сведения: алгоритм шифрования данных, зашифрованные данные, зашифрованный симметричный ключ и идентификатор получателя.

 

 



