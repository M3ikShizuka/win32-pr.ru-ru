---
description: Показывает, как можно использовать функции резервного копирования служб сертификатов, чтобы восстановить и восстановить базу данных служб сертификатов и связанные с ней файлы.
ms.assetid: f4914f45-629d-4f24-8328-d7f27e8a0062
title: Восстановление служб сертификатов из резервной копии
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8f5adf46d802194909397a3b70483b3cf43bb409
ms.sourcegitcommit: d75fc10b9f0825bbe5ce5045c90d4045e3c53243
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2021
ms.locfileid: "127469825"
---
# <a name="restoring-certificate-services-from-backup"></a>Восстановление служб сертификатов из резервной копии

В следующем сценарии показано, как можно использовать функции резервного копирования служб сертификатов, чтобы восстановить и восстановить базу данных служб сертификатов и связанные с ней файлы. Процесс восстановления включает запись файлов, содержащихся в резервном наборе данных на диск. Вы можете восстановить несколько резервных наборов данных (одна полная резервная копия, а также ноль или более добавочных резервных копий), но все операции восстановления должны быть выполнены до начала процесса. Процесс восстановления включает в себя воспроизведение файлов журнала службами сертификации для обеспечения согласованности базы данных и файлов журнала, обеспечивая целостность базы данных. Этот сценарий иллюстрирует вызовы функций для восстановления резервных наборов данных и информирования служб сертификатов о параметрах восстановления.

Перед реализацией этого сценария должна существовать существующая полная резервная копия базы данных служб сертификации.

1.  Загрузка библиотеки Certadm.dll в память (путем вызова [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).
2.  Извлеките адрес каждой из необходимых функций в Certadm.dll (с помощью [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)). Используйте эти адреса при вызове функций на оставшихся этапах.
3.  Вызовите [**цертсрвиссерверонлине**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) , чтобы определить, находятся ли службы сертификатов в сети. Если службы сертификатов работают, завершите ее, прежде чем продолжать работу. Для успешного выполнения операции восстановления службы сертификатов не должны находиться в оперативном режиме.
4.  Вызовите [**цертсрвресторепрепаре**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestorepreparew) , чтобы начать сеанс восстановления. Итоговый обработчик контекста резервного копирования служб сертификации будет использоваться несколькими другими функциями.
5.  Определите путь к расположению базы данных. Во время резервного копирования это значение было бы доступно из вызова [**цертсрвресторежетдатабаселокатионс**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw); Это значение должно храниться в составе резервной копии.
6.  Создайте карту восстановления, указав имя восстановленной базы данных. Для указания схемы восстановления используется структура восстановления схемы базы данных служб сертификатов (КСЕДБ \_ рстмапв). Задайте элемент \_ **пвсздатабасенаме** кседб Рстмапв и \_ элемент **рстмапв** кседб пвсзневдатабасенаме в соответствии с расположением базы данных, определенным на шаге 5. Кроме того, если восстановленная база данных должна иметь имя, отличное от имени базы данных резервного копирования, задайте \_ для элемента **пвсзневдатабасенаме** кседб рстмапв имя новой базы данных.
7.  Если необходимо, чтобы изменения, внесенные в базу данных после выполнения резервного копирования, не применялись повторно после завершения восстановления базы данных (в ходе восстановления базы данных, выполненной во время следующего запуска служб сертификации), удалите файлы из активной базы данных целевого сервера и каталогов журналов.
8.  Скопируйте файлы, содержащиеся в полной резервной копии, в активную базу данных и каталоги журналов целевого сервера.
9.  Вызовите [**цертсрвресторерегистер**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw) , чтобы зарегистрировать операцию восстановления для полной резервной копии. **Цертсрвресторерегистер** использует карту восстановления, указанную на шаге 6. **Цертсрвресторерегистер** также указывает расположение резервной копии базы данных и журналов. Вызов **цертсрвресторерегистер** приведет к принудительной попытке службы сертификатов выполнить операцию восстановления при следующем запуске. Он также предотвращает обработку запросов сертификатов службами сертификации до завершения восстановления.
10. Вызовите [**цертсрвресторерегистеркомплете**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete), тем самым завершая действие регистрации, начатое на шаге 8. Обратите внимание, что регистрация операции восстановления является инструкцией, которую службы сертификации должны следовать при запуске. Фактическое восстановление будет выполняться только после запуска служб сертификатов.
11. Для каждого восстанавливаемого добавочного резервного копирования скопируйте файлы, содержащиеся в добавочной резервной копии, в активный каталог журнала целевого сервера, затем вызовите [**цертсрвресторерегистер**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw), а затем — вызов [**цертсрвресторерегистеркомплете**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete). Регистрация добавочных резервных копий для восстановления может выполняться в любом порядке, но только набор файлов для одной добавочной резервной копии должен быть скопирован на сервер перед каждым вызовом в **цертсрвресторерегистер**.
12. Скопируйте динамические файлы служб сертификатов на целевой сервер. Динамические файлы были бы обнаружены во время резервного копирования при вызове [**цертсрвбаккупжетдинамикфилелист**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) . Может потребоваться отключить службу веб-публикаций, чтобы разрешить перезапись динамических файлов.
13. Вызовите [**цертсрвресторинд**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreend) , чтобы завершить сеанс восстановления.
14. Запустите приложение служб сертификатов вручную (или дождитесь его следующей перезагрузки, чтобы он автоматически запускался). При запуске служб сертификатов будет определена, была ли зарегистрирована операция восстановления. Если операция восстановления была зарегистрирована, Служба сертификатов начнет восстановление. Службы сертификатов не будут обрабатывать запросы на сертификаты до завершения операции восстановления.

> [!Note]  
> После завершения восстановления важно создать новую полную резервную копию базы данных служб сертификации. Это необходимо для усечения восстановленных файлов журнала и для создания базового резервного набора данных для будущих восстановлений. Резервные копии, выполненные после восстановления, нельзя смешивать с резервными копиями (полными или добавочными), выполненными перед восстановлением. то есть после восстановления базы данных служб сертификатов и ее последующего состояния нельзя использовать резервные копии перед восстановлением, чтобы восстановить базу данных в это последующее состояние.

 

 

 
