---
title: Транспортный режим обнаружения согласований
description: Для сценария политики IPsec "режим транспорта обнаружения согласования" требуется защита режима транспорта IPsec для всего соответствующего входящего трафика и запрос защиты IPsec для сопоставления исходящего трафика.
ms.assetid: c08d9d03-7d77-43c2-8468-964b498b45f8
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: df9477d18f2fe478f5c885c071f47d0bf2baaad8
ms.sourcegitcommit: ebd3ce6908ff865f1ef66f2fc96769be0aad82e1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/19/2020
ms.locfileid: "103890477"
---
# <a name="negotiation-discovery-transport-mode"></a>Транспортный режим обнаружения согласований

Для сценария политики IPsec "режим транспорта обнаружения согласования" требуется защита режима транспорта IPsec для всего соответствующего входящего трафика и запрос защиты IPsec для сопоставления исходящего трафика. Поэтому исходящие подключения могут переключаться на незашифрованный текст, а входящие — нет.

Если эта политика используется, когда хост-компьютер пытается создать новое исходящее подключение и отсутствует существующее сопоставление безопасности IPsec, соответствующее этому трафику, узел отправляет пакеты в виде открытого текста и запускает согласование IKE или AuthIP. В случае успешности согласования подключение обновляется до защищенного IPsec. В противном случае соединение остается в виде открытого текста. После защиты с помощью IPsec соединение не может быть переустановлено на незашифрованный текст.

Транспортный режим обнаружения согласований обычно используется в средах, в которых используются компьютеры с поддержкой IPsec и без IPsec.

Пример возможных режимов транспортного режима обнаружения согласования: "защита всего трафика одноадресных данных, за исключением ICMP, использование транспортного режима IPsec и Включение обнаружения согласований".

Чтобы реализовать этот пример программно, используйте следующую конфигурацию платформы WFP.

<dl>

**В ФВПМ \_ слоя \_ " \_ V {4 \| 6} Настройка политики согласования mm"**  

1.  Добавьте один или оба следующих контекста поставщика политики MM.  
    -   Для IKE — контекст поставщика политики типа **фвпм \_ IPSec \_ IKE \_ mm \_**.
    -   Для AuthIP — контекст поставщика политики типа **фвпм \_ IPSec \_ AuthIP \_ mm \_**.

    > [!Note]  
    > Будет согласовываться общий модуль ключа, и будет применена соответствующая политика MM. AuthIP — предпочтительный модуль создания ключей, если поддерживаются IKE и AuthIP.

     

2.  Для каждого контекста, добавленного на шаге 1, добавьте фильтр со следующими свойствами. 
    | Свойство Filter        | Значение                                            |
    |------------------------|--------------------------------------------------|
    | Условия фильтрации   | Пустой. Весь трафик будет соответствовать фильтру.        |
    | **провидерконтексткэй** | Идентификатор GUID контекста поставщика MM, добавленного на шаге 1. |

        

**На уровне \_ фвпм \_ IPSec \_ V {4 \| 6} Настройте политику СОГЛАСОВАНия QM и EM**  

1.  Добавьте один или оба следующих контекста поставщика политики транспортного режима QM и установите флаг [**\_ политики IPSec \_ \_ ND \_ Secure**](/windows/desktop/api/Ipsectypes/ns-ipsectypes-ipsec_transport_policy0) .  
    -   Для IKE — контекст поставщика политики типа ФВПМ \_ IPSec \_ IKE \_ QM \_ Transport \_ .
    -   Для AuthIP — контекст поставщика политики типа ФВПМ \_ IPSec \_ AuthIP \_ QM \_ Transport \_ . Этот контекст может дополнительно содержать политику согласования расширенного режима AuthIP (EM).

    > [!Note]  
    > Будет выполнено согласование общего модуля ключа, и будет применена соответствующая политика QM. AuthIP — предпочтительный модуль создания ключей, если поддерживаются IKE и AuthIP.

     

2.  Для каждого контекста, добавленного на шаге 1, добавьте фильтр со следующими свойствами. 
    | Свойство Filter        | Значение                                            |
    |------------------------|--------------------------------------------------|
    | Условия фильтрации   | Пустой. Весь трафик будет соответствовать фильтру.        |
    | **провидерконтексткэй** | Идентификатор GUID контекста поставщика QM, добавленного на шаге 1. |

        

**На \_ \_ входящем \_ транспортном транспорте уровня фвпм \_ V {4 \| 6} Настройте правила фильтрации входящих пакетов.**  

1.  Добавьте фильтр со следующими свойствами. 
    | Свойство Filter                                                   | Значение                                                                                              |
    |-------------------------------------------------------------------|----------------------------------------------------------------------------------------------------|
    | **Фвпм \_ Условие \_ фильтрации \_ \_ \_ типа ЛОКАЛЬНОГО IP-адреса условия** | [нлатуникаст](/windows/win32/api/nldef/ne-nldef-nl_address_type)                                      |
    | **Action. Type**                                                   | **\_ \_ Завершение вызова действия \_ FWP**                                                              |
    | **Action. Каллауткэй**                                             | **ФВПМ \_ выноска \_ \_ входящего \_ транспорта IPSec \_ V {4 \| 6}**                                              |
    | **равконтекст**                                                    | [**\_Безопасность контекста фвпм \_ IPSec для \_ входящего \_ \_ подключения PERSIST \_**](filter-context-identifiers.md) |

        
2.  Исключите ICMP-трафик из IPsec, добавив фильтр со следующими свойствами.
    | Свойство Filter                                                   | Значение                                                                      |
    |-------------------------------------------------------------------|----------------------------------------------------------------------------|
    | **Фвпм \_ Условие \_ фильтрации \_ \_ \_ типа ЛОКАЛЬНОГО IP-адреса условия** | нлатуникаст                                                                |
    | **Фвпм \_ Условие фильтрации \_ IP- \_ протокола условия**             | **Иппрото \_ ICMP {V6}** эти константы определены в Winsock2. h.<br/> |
    | **Action. Type**                                                   | **\_разрешение действия \_ FWP**                                                    |
    | **weight**                                                        | [**\_ \_ исключения IKE для диапазона веса \_ фвпм \_**](filter-weight-identifiers.md)  |

        

**На уровне \_ \_ исходящего \_ транспорта фвпм Layer \_ V {4 \| 6} Настройте правила фильтрации исходящих пакетов.**  

1.  Добавьте фильтр со следующими свойствами.
    | Свойство Filter                                                   | Значение                                                                                     |
    |-------------------------------------------------------------------|-------------------------------------------------------------------------------------------|
    | **Фвпм \_ Условие \_ фильтрации \_ \_ \_ типа ЛОКАЛЬНОГО IP-адреса условия** | нлатуникаст                                                                               |
    | **Action. Type**                                                   | **\_ \_ Завершение вызова действия \_ FWP**                                                     |
    | **Action. Каллауткэй**                                             | **\_Исходящий транспорт IPSec для фвпм выноски \_ \_ \_ \_ V {4 \| 6}**                                    |
    | **равконтекст**                                                    | [**ФВПМ \_ контекст \_ IPSec для \_ исходящей \_ согласованности \_ обнаружения**](filter-context-identifiers.md) |

        
2.  Исключите ICMP-трафик из IPsec, добавив фильтр со следующими свойствами.
    | Свойство Filter                                                   | Значение                                                                      |
    |-------------------------------------------------------------------|----------------------------------------------------------------------------|
    | **Фвпм \_ Условие \_ фильтрации \_ \_ \_ типа ЛОКАЛЬНОГО IP-адреса условия** | нлатуникаст                                                                |
    | **Фвпм \_ Условие фильтрации \_ IP- \_ протокола условия**             | **Иппрото \_ ICMP {V6}** эти константы определены в Winsock2. h.<br/> |
    | **Action. Type**                                                   | **\_разрешение действия \_ FWP**                                                    |
    | **weight**                                                        | **\_ \_ исключения IKE для диапазона веса \_ фвпм \_**                                   |

        

**На уровне \_ фвпм \_ \_ Проверка подлинности \_ recv \_ Accept \_ V {4 \| 6} Настройте правила фильтрации входящих подключений.**  

1.  Добавьте фильтр со следующими свойствами. Этот фильтр разрешает входящие попытки подключения только в том случае, если они защищены протоколом IPsec. 
    | Свойство Filter                                                   | Значение                                                        |
    |-------------------------------------------------------------------|--------------------------------------------------------------|
    | **Фвпм \_ Условие \_ фильтрации \_ \_ \_ типа ЛОКАЛЬНОГО IP-адреса условия** | нлатуникаст                                                  |
    | **Action. Type**                                                   | **\_ \_ Завершение вызова действия \_ FWP**                        |
    | **Action. Каллауткэй**                                             | **ФВПМ \_ выноска \_ IPSec для \_ входящего трафика \_ инициирующее \_ безопасное \_ V {4 \| 6}** |

        
2.  Исключите ICMP-трафик из IPsec, добавив фильтр со следующими свойствами.
    | Свойство Filter                                                   | Значение                                                                      |
    |-------------------------------------------------------------------|----------------------------------------------------------------------------|
    | **Фвпм \_ Условие \_ фильтрации \_ \_ \_ типа ЛОКАЛЬНОГО IP-адреса условия** | нлатуникаст                                                                |
    | **Фвпм \_ Условие фильтрации \_ IP- \_ протокола условия**             | **Иппрото \_ ICMP {V6}** эти константы определены в Winsock2. h.<br/> |
    | **Action. Type**                                                   | **\_разрешение действия \_ FWP**                                                    |
    | **weight**                                                        | **\_ \_ исключения IKE для диапазона веса \_ фвпм \_**                                   |

        

</dl>

## <a name="related-topics"></a>См. также

<dl> <dt>

[Пример кода: использование транспортного режима](using-transport-mode.md)
</dt> <dt>

[Уровни ALE](ale-layers.md)
</dt> <dt>

[**Встроенные идентификаторы выноски**](built-in-callout-identifiers.md)
</dt> <dt>

[Условия фильтрации](filtering-conditions.md)
</dt> <dt>

[**Фильтрация идентификаторов слоя**](management-filtering-layer-identifiers-.md)
</dt> <dt>

[**ФВПМ \_ ACTION0**](/windows/desktop/api/Fwpmtypes/ns-fwpmtypes-fwpm_action0)
</dt> <dt>

[**\_ \_ тип контекста поставщика \_ фвпм**](/windows/desktop/api/Fwpmtypes/ne-fwpmtypes-fwpm_provider_context_type)
</dt> </dl>

 

