---
title: Управление объектами
description: в этом разделе рассматривается правильное использование типов объектов API платформы фильтрации Windows (WFP).
ms.assetid: 2625ef9a-0e62-4e21-ba93-047965d0d782
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: c5cb51d4e78049d7911a4a5ed265091e05bc1cbb00ce470e332d59dd23c6026d
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119068854"
---
# <a name="object-management"></a>Управление объектами

в этом разделе рассматривается правильное использование типов объектов API платформы фильтрации Windows (WFP).

## <a name="sessions"></a>Сеансы

API WFP ориентирован на сеанс, и большинство вызовов функций выполняются в контексте сеанса. Новый сеанс клиента создается путем вызова [**FwpmEngineOpen0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmengineopen0). Сеанс завершается либо при вызове клиентом [**FwpmEngineClose0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmengineclose0) , либо при завершении клиентского процесса. Когда сеанс уничтожается либо по назначению, либо с помощью очистки RPC, базовый модуль фильтрации (BFE) сначала прерывает существующую транзакцию.

При создании нового сеанса вызывающий объект может создать динамический сеанс путем передачи динамического флага [**\_ \_ флага сеанса \_ фвпм**](/windows/desktop/api/Fwpmtypes/ns-fwpmtypes-fwpm_session0) в [**FwpmEngineOpen0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmengineopen0). Все объекты, добавленные во время динамического сеанса, автоматически удаляются по окончании сеанса.

## <a name="transactions"></a>Transactions

API WFP является транзакционным, и большинство вызовов функций выполняется в контексте транзакции. Вызывающие объекты могут использовать [**FwpmTransactionBegin0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmtransactionbegin0), [**FwpmTransactionCommit0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmtransactioncommit0)и [**FwpmTransactionAbort0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmtransactionabort0) для явного управления транзакциями. Однако если вызов функции выполняется за пределами явной транзакции, он будет выполнен в неявной транзакции. Если транзакция выполняется, то при завершении сеанса она автоматически прерывается. Неявные транзакции никогда не прерываются.

Транзакции доступны только для чтения или для чтения и записи и обеспечивают строгую целостность изолированной устойчивой ([ACID](../cossdk/acid-properties.md)) семантики.

Каждый сеанс клиента одновременно может иметь только одну транзакцию. Если вызывающий объект пытается начать вторую транзакцию перед фиксацией или прерыванием первой транзакции, процедура BFE возвращает ошибку.

Если операция завершается ошибкой в ходе транзакции, она не влияет на общее состояние транзакции. Например, предположим, что клиент начинает транзакцию и успешно вызывает [**FwpmFilterAdd0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmfilteradd0) три раза перед тем, как четвертый вызов завершается неудачей. Теперь у клиента есть возможность:

-   Прерывание транзакции. в этом случае ни один из фильтров не будет добавлен.
-   Фиксация транзакции. в этом случае будут добавлены первые три фильтра.
-   Продолжение работы с дополнительными операциями, включая потенциально повторное выполнение неудачных [**FwpmFilterAdd0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmfilteradd0).

При начале транзакции BFE будет ожидать истечения срока действия [**ткснваиттимеаутинмсек**](/windows/desktop/api/Fwpmtypes/ns-fwpmtypes-fwpm_session0) сеанса, чтобы получить блокировку. Если блокировка не получена в течение этого времени, то получение блокировки (и вызов [**FwpmTransactionBegin0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmtransactionbegin0) ) завершится ошибкой. Это предотвращает неопределенное завершение ответа клиентов. Если клиент не указал время ожидания блокировки, по умолчанию он равен 15 секундам.

Каждая транзакция также имеет время ожидания блокировки. Это максимальное время, в течение которого может владеть блокировка. Если владелец не снимает блокировку в течение этого времени, транзакция принудительно прерывается, что приводит к освобождению блокировки. Время ожидания блокировки не настраивается. Он бесконечен для вызывающих объектов в режиме ядра и один час для вызывающих методов пользовательского режима. Если транзакция принудительно прерывается, следующий вызов, выполненный в этой транзакции, завершится с ошибкой **FWP \_ E \_ транзакция \_**.

## <a name="object-lifetimes"></a>Время существования объекта

Объекты могут иметь одно из четырех возможных значений времени существования:

-   Dynamic — объект является динамическим, только если он добавлен с помощью динамического обработчика сеанса. Динамические объекты становятся активными до тех пор, пока они не будут удалены или не завершится сеансом-владельцем.
-   Static — объекты по умолчанию статичны. Статические объекты находятся в рабочем режиме до тех пор, пока они не будут удалены, BFE прекращается или система завершает работу.
-   Persistent — постоянные объекты создаются путем передачи соответствующего **\_ \* \_ \_ постоянного** флага фвпм в функцию **\* Add0 фвпм** . Постоянные объекты, пока они не будут удалены.
-   Встроенные, встроенные объекты предопределены с помощью BFE и не могут быть добавлены или удалены. Они бесконечно прожить.

Фильтры в режиме ядра можно пометить как фильтры времени загрузки, передав соответствующий флаг в [**FwpmFilterAdd0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmfilteradd0). Фильтры времени загрузки добавляются в систему при запуске драйвера TCP/IP и удаляются после завершения инициализации BFE. Постоянные объекты добавляются при запуске BFE.

Во многих случаях поставщик политики может не требовать принудительного применения его постоянной политики, если поставщик был отключен. при добавлении поставщика вызывающий объект может указать необязательное имя службы Windows. При добавлении постоянных объектов вызывающий может дополнительно указать поставщика, который "владеет" этим объектом. при запуске службы BFE добавляет в систему только постоянные объекты, если они не связаны с поставщиком, или у связанного поставщика нет Windows имени службы, либо для связанной Windows службы задан автоматический запуск.

## <a name="object-associations"></a>Ассоциации объектов

Некоторые объекты имеют ссылки на другие объекты. Например, фильтр всегда ссылается на слой и может ссылаться на выноску и контекст поставщика. Объекты не могут ссылаться на объекты, которые могут иметь более короткое время существования. Таким же, динамический объект не может ссылаться на динамический объект из другого сеанса. Статический объект не может ссылаться на динамический объект. Постоянный объект не может ссылаться на динамический объект, статический объект или постоянный объект, принадлежащий другому поставщику.

Объект нельзя удалить, пока не будут удалены все объекты, ссылающиеся на него.

## <a name="luids-and-guids"></a>LUID и идентификаторы GUID

Все объекты API WFP в пользовательском режиме (ФВПМ) идентифицируются глобальным уникальным идентификатором (**GUID**) и ссылаются на другие объекты по их **идентификаторам GUID**. **Идентификатор GUID** должен быть уникальным только в пределах типа объекта. Например, фильтр и контекст поставщика могут иметь один и тот же **GUID**, но два фильтра не могут. При добавлении нового объекта вызывающие объекты могут назначить **идентификатор GUID** объекта или оставить его инициализированным нулем и позволить BFE назначить **идентификатор GUID**.

Все объекты API WFP в режиме ядра (ФВПС) идентифицируются локально уникальным идентификатором (**LUID**) и ссылаются на другие объекты по их LUID. Переключение с **GUID** на **LUID** позволяет WFP сохранять нестраничный пул и оптимизировать обработку во время выполнения. Ширина **LUID** зависит от типа объекта и диапазонов от **UINT16** до **UINT64**. **LUID** всегда назначается BFE.

 

 