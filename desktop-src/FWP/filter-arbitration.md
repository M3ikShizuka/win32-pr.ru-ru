---
title: Арбитраж фильтра
description: арбитраж фильтра — это логика, встроенная в Windowsную платформу фильтрации (WFP), которая используется для определения того, как фильтры взаимодействуют друг с другом при принятии решений о фильтрации сетевого трафика.
ms.assetid: d097f307-113e-4dc3-ad59-ddfb85061583
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 7640e94440cf040d9ca51b6c639dc66e3e8a767024d6dbcd01b9c0cd2b87a24b
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118151196"
---
# <a name="filter-arbitration"></a>Арбитраж фильтра

арбитраж фильтра — это логика, встроенная в Windowsную платформу фильтрации (WFP), которая используется для определения того, как фильтры взаимодействуют друг с другом при принятии решений о фильтрации сетевого трафика.

## <a name="filter-arbitration-behaviors"></a>Фильтрация поведения арбитража

Следующие поведения характеризуются системой арбитража фильтра:

-   Весь трафик можно проверить. Трафик не может обходить фильтры на заданном слое.
-   Трафик может блокироваться фильтром выноски с помощью **запрета** , даже если он разрешен фильтром с более высоким приоритетом.
-   Несколько поставщиков могут проверять трафик на одном и том же уровне. Например, брандмауэр, за которым следуют фильтры системы обнаружения вторжений, или IPsec, исследуя фильтры качества обслуживания (QoS), могут проверять трафик на одном и том же уровне.

## <a name="filtering-model"></a>Модель фильтрации

Каждый слой фильтра делится на подуровни, упорядоченные по приоритету (также называемый весом). Сетевой трафик проходит по подслоям с наивысшего приоритета до самого низкого приоритета. Создание и управление Подслоями осуществляется разработчиками с помощью API WFP.

В каждом подуровне фильтры упорядочиваются по весу. Сетевой трафик выдается для сопоставления фильтров от наивысшего веса до нижнего веса.

Алгоритм арбитража фильтра применяется ко всем подслоям в пределах слоя, и решение о фильтрации будет принято после оценки всех вложенных слоев. Это обеспечивает несколько возможностей сопоставления.

Во вложенном слое арбитраж фильтра выполняется следующим образом:

-   Вычисление списка совпадающих фильтров, упорядоченных по весу, от высшего к меньшему.
-   Проверять соответствие фильтров по порядку до тех пор, пока не будет возвращен "разрешить" или "блок" (фильтры могут также возвращать "Continue") или пока список не будет исчерпан.
-   Пропустите оставшиеся фильтры и верните действие из последнего вычисленного фильтра.

В пределах слоя арбитраж фильтра выполняется следующим образом:

-   Выполняйте арбитраж фильтра на каждом подуровне в порядке убывания приоритета.
-   Оцените все подслои, даже если подслой с более высоким приоритетом решил блокировать трафик.
-   Возврат результирующего действия на основе правил политики, описанных в следующем разделе.

На схеме ниже показан пример конфигурации вложенного слоя. Внешние поля представляют слои. Внутренние поля представляют вложенные слои, содержащие фильтры. Подстановочный знак ( \* ) в фильтре означает, что весь трафик соответствует фильтру.

![Пример конфигурации подслоя](images/fwp-sub-config2.png)

Единственный способ обойти фильтр — если фильтр более высокого веса разрешает или блокирует трафик в пределах одного подслоя. И наоборот, один из способов гарантировать, что фильтр всегда видит весь трафик внутри слоя, — добавить вложенный слой, содержащий один фильтр, который соответствует всему трафику.

## <a name="configurable-override-policy"></a>Настраиваемая политика переопределения

Правила, описанные ниже, управляют решениями по арбитражу в пределах слоя. Эти правила используются обработчиком фильтров для определения того, какой из действий подслоя применяется к сетевому трафику.

Базовая политика выглядит следующим образом.

-   Действия оцениваются в порядке приоритета дочерних слоев с наивысшим приоритетом до самого низкого.
-   "Block" переопределяет "разрешить".
-   "Block" является окончательным (не может быть переопределен) и останавливает вычисление. Пакет отбрасывается.

Базовая политика не поддерживает сценарий исключения, которое не переопределяется брандмауэром. Типичные примеры сценариев такого типа:

-   Порт удаленного администрирования должен быть открыт даже при наличии брандмауэра стороннего производителя.
-   Компоненты, требующие открытия портов для работы (например, универсальный самонастраивающийся UPnP). Если администратор явно включил компонент, брандмауэр не должен автоматически блокировать трафик.

Для поддержки описанных выше сценариев решение о фильтрации должно быть сложнее переопределять, чем другое решение по фильтрации путем управления разрешением на переопределение действия. Это разрешение реализуется как флаг **\_ \_ \_ записи фвпс right** , и он задается отдельно для каждого фильтра.

Алгоритм оценки сохраняет текущее действие ("разрешить" или "блокировать") вместе с флагом **записи фвпс \_ right \_ Action \_** . Флаг определяет, может ли подслой с более низким приоритетом переопределять действие. Если установить или сбросить флаг **\_ \_ \_ записи Фвпс right** в структуре [фвпс \_ классифицировать \_ OUT0](/windows/win32/api/fwpstypes/ns-fwpstypes-fwps_classify_out0) , то поставщик определяет, как действия могут быть переопределены. Если установлен флаг, это означает, что действие можно переопределить. Если флаг отсутствует, действие не может быть переопределено.



| Действие | Разрешить переопределение ( \_ \_ \_ задано право записи действия фвпс) | Описание                                                                                                          |
|--------|----------------------------------------------------|----------------------------------------------------------------------------------------------------------------------|
| Разрешение | Да                                                | Трафик может быть заблокирован на другом подслое. Это называется мягким предоставлением.<br/>                            |
| Разрешение | нет                                                 | Трафик можно заблокировать на другом подслое только с помощью **запрета** выноски. Это называется жесткое разрешение.<br/> |
| Блокировать  | Да                                                | Трафик может быть разрешен на другом подслое. Это называется мягким блоком.<br/>                           |
| Блокировать  | Нет                                                 | Невозможно разрешить трафик на другом подуровне. Это называется жестким блоком.<br/>                        |



 

Действие фильтра можно задать, задав для члена **типа** в Structure [**Фвпм \_ ACTION0**](/windows/desktop/api/Fwpmtypes/ns-fwpmtypes-fwpm_action0) значение **FWP \_ Action \_** или **FWP \_ Action \_**. Наряду с типом действия фильтр также предоставляет флаг флага **\_ фильтра фвпм \_ \_ очистить \_ действие \_ вправо**. Если этот флаг сброшен, тип действия является жестким и не может быть переопределен, за исключением случаев, когда жесткое разрешение переопределяется с помощью **запрета** , как описано выше. в противном случае он является мягким, который может быть переопределен с помощью действия с высоким приоритетом.

В следующей таблице приведено поведение по умолчанию для действий фильтра и выноски.

| Действие         | Поведение по умолчанию |
|----------------|------------------|
| Разрешение фильтра  | Мягкое разрешение      |
| Разрешается выноска | Мягкое разрешение      |
| Блок фильтра   | Жесткая блокировка       |
| Блок выноски  | Мягкая блокировка       |



 

**Запрет** — это действие "Block", возвращаемое фильтром при сбросе флага **\_ \_ \_ записи фвпс right** , прежде чем вызывать фильтр. **Запрет** блокирует трафик, который был разрешен с жестким разрешением.

При выдаче **запрета** это указывает на конфликт в конфигурации. Чтобы устранить конфликт, выполняются следующие действия.

-   Трафик блокируется.
-   Создается событие аудита.
-   Создается уведомление.
    > [!Note]  
    > Уведомление получается всеми сущностями, которые подписаны на него. Обычно это включает брандмауэр (для обнаружения неверных конфигураций) или приложения (для обнаружения переопределения их конкретного фильтра).

     

    > [!Note]  
    > При переопределении фильтра "жесткое разрешение" не создается ни один обязательный пользовательский интерфейс (UI). Уведомления переопределения отправляются любому поставщику, зарегистрированному для получения, что позволяет брандмауэрам или приложениям, создавшим фильтры "разрешить", отображать пользовательский интерфейс, запрашивающий действия пользователя. В пользовательском интерфейсе платформы нет значения для этих событий переопределения, так как независимые поставщики программного обеспечения, которые не хотят автоматически блокировать, могут сделать это путем регистрации в другом месте в WFP или (менее предпочтительно) обрабатывайте всю логику в драйвере вызова. Независимым поставщикам программного обеспечения, которые считают, что пользователи запрашиваются, должны быть в порядке с учетом взаимодействия с пользователем и создания собственного пользовательского интерфейса.

     

Описанные выше действия по устранению рисков гарантируют, что фильтр "жесткое разрешение" не переопределяется автоматически с помощью "блочного" фильтра, и в нем рассматривается ситуация, когда порт удаленного администрирования не может быть заблокирован брандмауэром. Для автоматического переопределения фильтров «жесткое разрешение» брандмауэр должен добавить свои фильтры в подуровне с более высоким приоритетом.

> [!Note]  
> Поскольку не существует перекрестного разрешения, трафик, разрешенный с помощью "жесткое разрешение", по-прежнему может блокироваться на другом уровне. Ответственность за трафик на каждом уровне при необходимости гарантируется автором политики.

 

Пользовательские приложения, запрашивающие порты, которые нужно открыть, добавляют переопределяемые фильтры в подслой с низким приоритетом. Брандмауэр может подписываться на фильтр добавить события уведомлений и добавить фильтр сопоставления после проверки пользователя (или политики).

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Назначение весов фильтрам](filter-weight-assignment.md)
</dt> </dl>

 

