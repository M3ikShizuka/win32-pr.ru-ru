---
title: Гарантированное шифрование
description: В сценарии политики IPsec с гарантированным шифрованием требуется шифрование IPsec для всего соответствующего трафика. Эта политика должна быть указана в сочетании с одним из параметров политики транспортного режима.
ms.assetid: 68758f0c-f134-4b7a-820a-313e2a82f280
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: dbffa3d78a9e178850f3afaa4d6b7fa9831be875
ms.sourcegitcommit: 78b64f3865e64768b5319d4f010032ee68924a98
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/13/2021
ms.locfileid: "107314647"
---
# <a name="guaranteed-encryption"></a>Гарантированное шифрование

В сценарии политики IPsec с гарантированным шифрованием требуется шифрование IPsec для всего соответствующего трафика. Эта политика должна быть указана в сочетании с одним из параметров политики транспортного режима.

Гарантированное шифрование обычно используется для шифрования конфиденциального трафика на уровне приложения.

Примером возможного сценария шифрования является защита всего трафика одноадресных данных, за исключением ICMP, использование транспортного режима IPsec, Включение обнаружения согласований и обязательное шифрование для всего одноадресного трафика, соответствующего TCP-порту 5555.

Чтобы реализовать этот пример программно, используйте следующую конфигурацию платформы WFP.

<dl>

**В ФВПМ \_ Layer \_ IKEEXT \_ V {4 \| 6} Настройка политики согласования mm**  

1.  Добавьте один или оба следующих контекста поставщика политики MM.  
    -   Для IKE — контекст поставщика политики типа ФВПМ \_ IPSec \_ IKE \_ mm \_ .
    -   Для AuthIP — контекст поставщика политики типа ФВПМ \_ IPSec \_ AuthIP \_ mm \_ .

    > [!Note]  
    > Будет согласовываться общий модуль ключа, и будет применена соответствующая политика MM. AuthIP — предпочтительный модуль создания ключей, если поддерживаются IKE и AuthIP.

     

2.  Для каждого контекста, добавленного на шаге 1, добавьте фильтр со следующими свойствами.

    | Свойство Filter        | Значение                                            |
    |------------------------|--------------------------------------------------|
    | Условия фильтрации   | Пустой. Весь трафик будет соответствовать фильтру.        |
    | **провидерконтексткэй** | Идентификатор GUID контекста поставщика MM, добавленного на шаге 1. |

        

**На уровне \_ фвпм \_ IPSec \_ V {4 \| 6} Настройка политики СОГЛАСОВАНия QM и EM**  

1.  Добавьте один или оба следующих контекста поставщика политики транспортного режима QM и установите флаг [**\_ политики IPSec \_ \_ ND \_ Secure**](/windows/desktop/api/Ipsectypes/ns-ipsectypes-ipsec_transport_policy0) .  
    -   Для IKE — контекст поставщика политики типа **фвпм \_ IPSec \_ IKE \_ QM \_ Transport \_**.
    -   Для AuthIP — контекст поставщика политики типа **фвпм \_ IPSec \_ AuthIP \_ QM \_ Transport \_**. Этот контекст может дополнительно содержать политику согласования расширенного режима AuthIP (EM).

    > [!Note]  
    > Будет выполнено согласование общего модуля ключа, и будет применена соответствующая политика QM. AuthIP — предпочтительный модуль создания ключей, если поддерживаются IKE и AuthIP.

     

2.  Для каждого контекста, добавленного на шаге 1, добавьте фильтр со следующими свойствами.

    | Свойство Filter        | Значение                                            |
    |------------------------|--------------------------------------------------|
    | Условия фильтрации   | Пустой. Весь трафик будет соответствовать фильтру.        |
    | **провидерконтексткэй** | Идентификатор GUID контекста поставщика QM, добавленного на шаге 1. |

        

**На уровне \_ фвпм \_ входящий \_ транспорт \_ V {4 \| 6} Настройка входящих правил фильтрации для каждого пакета**  

1.  Добавьте фильтр со следующими свойствами. 

    | Свойство Filter                                               | Значение                                                                                              |
    |---------------------------------------------------------------|----------------------------------------------------------------------------------------------------|
    | Условие \_ \_ \_ \_ фильтрации типа локального IP-адреса условия \_ фвпм | [нлатуникаст](/windows/win32/api/nldef/ne-nldef-nl_address_type)                                      |
    | **Action. Type**                                               | **\_ \_ Завершение вызова действия \_ FWP**                                                              |
    | **Action. Каллауткэй**                                         | **ФВПМ \_ выноска \_ \_ входящего \_ транспорта IPSec \_ V {4 \| 6}**                                              |
    | **равконтекст**                                                | [**\_Безопасность контекста фвпм \_ IPSec для \_ входящего \_ \_ подключения PERSIST \_**](filter-context-identifiers.md) |

        
2.  Исключите ICMP-трафик из IPsec, добавив фильтр со следующими свойствами.

    | Свойство Filter                                                   | Значение                                                                      |
    |-------------------------------------------------------------------|----------------------------------------------------------------------------|
    | **Фвпм \_ Условие \_ фильтрации \_ \_ \_ типа ЛОКАЛЬНОГО IP-адреса условия** | нлатуникаст                                                                |
    | **Фвпм \_ Условие фильтрации \_ IP- \_ протокола условия**             | **Иппрото \_ ICMP {V6}** эти константы определены в Winsock2. h.<br/> |
    | **Action. Type**                                                   | **\_разрешение действия \_ FWP**                                                    |
    | **weight**                                                        | [**\_ \_ исключения IKE для диапазона веса \_ фвпм \_**](filter-weight-identifiers.md)  |

        

**На уровне \_ \_ исходящего \_ транспорта уровня фвпм \_ V {4 \| 6} Настройка правил фильтрации исходящих пакетов для каждого пакета**  

1.  Добавьте фильтр со следующими свойствами.

    | Свойство Filter                                                   | Значение                                                                                     |
    |-------------------------------------------------------------------|-------------------------------------------------------------------------------------------|
    | **Фвпм \_ Условие \_ фильтрации \_ \_ \_ типа ЛОКАЛЬНОГО IP-адреса условия** | нлатуникаст                                                                               |
    | **Action. Type**                                                   | **\_ \_ Завершение вызова действия \_ FWP**                                                     |
    | **Action. Каллауткэй**                                             | **\_Исходящий транспорт IPSec для фвпм выноски \_ \_ \_ \_ V {4 \| 6}**                                    |
    | **равконтекст**                                                    | [**ФВПМ \_ контекст \_ IPSec для \_ исходящей \_ согласованности \_ обнаружения**](filter-context-identifiers.md) |

        
2.  Исключите ICMP-трафик из IPsec, добавив фильтр со следующими свойствами.

    | Свойство Filter                                                   | Значение                                                                      |
    |-------------------------------------------------------------------|----------------------------------------------------------------------------|
    | **Фвпм \_ Условие \_ фильтрации \_ \_ \_ типа ЛОКАЛЬНОГО IP-адреса условия** | нлатуникаст                                                                |
    | **Фвпм \_ Условие фильтрации \_ IP- \_ протокола условия**             | **Иппрото \_ ICMP {V6}** эти константы определены в Winsock2. h.<br/> |
    | **Action. Type**                                                   | **\_разрешение действия \_ FWP**                                                    |
    | **weight**                                                        | **\_ \_ исключения IKE для диапазона веса \_ фвпм \_**                                   |

        

**На уровне \_ фвпм \_ \_ Проверка подлинности \_ recv \_ Accept \_ V {4 \| 6} Настройка входящих правил фильтрации для подключения**  

1.  Добавьте фильтр со следующими свойствами. Этот фильтр разрешает входящие попытки подключения только в том случае, если они защищены протоколом IPsec. 

    | Свойство Filter                                                   | Значение                                                        |
    |-------------------------------------------------------------------|--------------------------------------------------------------|
    | **Фвпм \_ Условие \_ фильтрации \_ \_ \_ типа ЛОКАЛЬНОГО IP-адреса условия** | нлатуникаст                                                  |
    | **Action. Type**                                                   | **\_ \_ Завершение вызова действия \_ FWP**                        |
    | **Action. Каллауткэй**                                             | **ФВПМ \_ выноска \_ IPSec для \_ входящего трафика \_ инициирующее \_ безопасное \_ V {4 \| 6}** |

        
2.  Исключите ICMP-трафик из IPsec, добавив фильтр со следующими свойствами.

    | Свойство Filter                                                   | Значение                                                                      |
    |-------------------------------------------------------------------|----------------------------------------------------------------------------|
    | **Фвпм \_ Условие \_ фильтрации \_ \_ \_ типа ЛОКАЛЬНОГО IP-адреса условия** | нлатуникаст                                                                |
    | **Фвпм \_ Условие фильтрации \_ IP- \_ протокола условия**             | **Иппрото \_ ICMP {V6}** эти константы определены в Winsock2. h.<br/> |
    | **Action. Type**                                                   | **\_разрешение действия \_ FWP**                                                    |
    | **weight**                                                        | **\_ \_ исключения IKE для диапазона веса \_ фвпм \_**                                   |

        
3.  Добавьте фильтр со следующими свойствами. Этот фильтр разрешит только входящие подключения к TCP-порту 5555, если они зашифрованы.

    | Свойство Filter                                                   | Значение                                                                                                 |
    |-------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------|
    | **Фвпм \_ Условие \_ фильтрации \_ \_ \_ типа ЛОКАЛЬНОГО IP-адреса условия** | нлатуникаст                                                                                           |
    | **Фвпм \_ Условие фильтрации \_ IP- \_ протокола условия**             | **Иппрото \_ TCP** Эта константа определена в Winsock2. h.<br/>                                    |
    | **Фвпм \_ Условие \_ фильтрации \_ локальных \_ портов IP-адреса условия**          | 5555                                                                                                  |
    | **Action. Type**                                                   | **\_ \_ Завершение вызова действия \_ FWP**                                                                 |
    | **Action. Каллауткэй**                                             | **ФВПМ \_ выноска \_ IPSec для \_ входящего трафика \_ инициирующее \_ безопасное \_ V {4 \| 6}**                                          |
    | **равконтекст**                                                    | [**для \_ \_ \_ подключения к набору ALE контекста фвпм \_ \_ требуется \_ \_ шифрование IPSec**](filter-context-identifiers.md) |

        

**На сайте ФВПМ \_ Layer Authentication \_ \_ \_ \_ Connection V {4 \| 6} Настройка правил фильтрации исходящих подключений для каждого подключения**

-   Добавьте фильтр со следующими свойствами. Этот фильтр разрешает только исходящие подключения с TCP-порта 5555, если они зашифрованы.

    | Свойство Filter                                                   | Значение                                                                                                 |
    |-------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------|
    | **Фвпм \_ Условие \_ фильтрации \_ \_ \_ типа ЛОКАЛЬНОГО IP-адреса условия** | нлатуникаст                                                                                           |
    | **Фвпм \_ Условие фильтрации \_ IP- \_ протокола условия**             | **Иппрото \_ TCP** Эта константа определена в Winsock2. h.<br/>                                    |
    | **Фвпм \_ Условие \_ фильтрации \_ локальных \_ портов IP-адреса условия**          | 5555                                                                                                  |
    | **Action. Type**                                                   | **\_ \_ Завершение вызова действия \_ FWP**                                                                 |
    | **Action. Каллауткэй**                                             | **ФВПМ \_ выноска \_ \_ ALE IPSec \_ Connect \_ V {4 \| 6}**                                                       |
    | **равконтекст**                                                    | [**для \_ \_ \_ подключения к набору ALE контекста фвпм \_ \_ требуется \_ \_ шифрование IPSec**](filter-context-identifiers.md) |

      

  
</dl>

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Пример кода: использование транспортного режима](using-transport-mode.md)
</dt> <dt>

[Уровни ALE](ale-layers.md)
</dt> <dt>

[**Встроенные идентификаторы выноски**](built-in-callout-identifiers.md)
</dt> <dt>

[Условия фильтрации](filtering-conditions.md)
</dt> <dt>

[**Фильтрация идентификаторов слоя**](management-filtering-layer-identifiers-.md)
</dt> <dt>

[**ФВПМ \_ ACTION0**](/windows/desktop/api/Fwpmtypes/ns-fwpmtypes-fwpm_action0)
</dt> <dt>

[**\_ \_ тип контекста поставщика \_ фвпм**](/windows/desktop/api/Fwpmtypes/ne-fwpmtypes-fwpm_provider_context_type)
</dt> </dl>

 

