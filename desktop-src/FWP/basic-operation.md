---
title: Операция WFP
description: Windows Платформа фильтрации (WFP) выполняет свои задачи, интегрируя следующие базовые уровни сущностей, фильтры, оболочки и выноски.
ms.assetid: bf88ace7-1160-434b-9be0-3f9db6aa2e87
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8254ed468b856392477a643ce13f2b609245031f7363865b8c93ccfda64ba9fa
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119015392"
---
# <a name="wfp-operation"></a>Операция WFP

Windows Платформа фильтрации (WFP) выполняет свои задачи, интегрируя следующие основные сущности: *слои*, *фильтры*, *оболочки совместимости* и *выноски*.

## <a name="layers"></a>Слои

*Слой* — это контейнер, управляемый обработчиком фильтров, функция которого заключается в упорядочении фильтров по наборам. Слой не является модулем в сетевом стеке. Каждый слой имеет схему, определяющую тип фильтров, которые могут быть добавлены к нему. Дополнительные сведения см. [в разделе условия фильтрации, доступные на каждом слое фильтрации](filtering-conditions-available-at-each-filtering-layer.md) .

Слои могут содержать вложенные слои для управления конфликтующими требованиями фильтра, например "блокировать TCP-порты выше 1024" и "открыть порт 1080". Правила управления конфликтами фильтрации определяются посредством [арбитража фильтра](filter-arbitration.md).

WFP содержит набор [встроенных подслоев](management-filtering-sublayer-identifiers.md). Каждый слой наследует все встроенные подслои. Пользователи также могут добавлять собственные подслои.

Список уровней обработчика фильтров представлен в разделе "справочные данные" раздела [**Фильтрация идентификаторов слоев**](management-filtering-layer-identifiers-.md).

## <a name="filters"></a>Фильтры

*Фильтр* — это правило, которое сопоставляется с входящими или исходящими пакетами. Правило сообщает обработчику фильтрации, что следует делать с пакетом, в том числе вызов модуля выноски для проверки глубокого пакета или потока. Например, фильтр может указать "блокировать трафик с TCP-портом, превышающим 1024" или "вызывать ИДЕНТИФИКАТОРы для всего незащищенного трафика".

Фильтр времени загрузки — это фильтр, который применяется во время загрузки, как только запускается драйвер стека TCP/IP (tcpip.sys). Фильтр времени загрузки отключается при запуске BFE. Фильтр помечается как время загрузки, устанавливая флаг [**\_ \_ \_ буттиме фильтра Фвпм**](/windows/desktop/api/Fwpmtypes/ns-fwpmtypes-fwpm_filter0) при вызове [**FwpmFilterAdd0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmfilteradd0) .

Фильтр времени выполнения — это фильтр, который применяется после запуска BFE. Фильтр времени выполнения может быть статическим, динамическим или постоянным в зависимости от того, как он был создан. Дополнительные сведения о различных типах фильтров времени выполнения и их времени существовании см. в разделе [Управление объектами](object-management.md) .

## <a name="shims"></a>Оболочек совместимости

*Оболочка совместимости* — это компонент режима ядра, который позволяет фильтровать решения с помощью классификации по слоям механизма фильтрации. Каждая оболочка совместимости классифицируется по одному или нескольким слоям. например, оболочка совместимости модуля транспортного уровня является классификатором входящего транспортного уровня, уровня исходящего транспорта, а также Подключение и Receive-Accept уровней для первого пакета потока.

По мере того, как пакеты, потоки и события проходят по сетевому стеку, оболочки совместимости анализируют их для извлечения и значения классификаторов, а затем вызывают механизм фильтрации, чтобы вычислить их в фильтрах на заданном слое. Обработчик фильтров может вызвать одну или несколько выносок в рамках классификации. Оболочки совместимости выполняют фактическое удаление пакетов, потоков и событий на основе результатов классификации, выполняемой механизмом фильтрации.

## <a name="callouts"></a>Выноски

*Выноска* — это набор функций, предоставляемых драйвером и используемый для специализированной фильтрации. Они используются для анализа и обработки пакетов, таких как проверка на наличие вирусов, родительский контроль для поиска нежелательного содержимого, анализа данных пакетов для средств мониторинга. Некоторые выноски, например драйвер преобразования сетевых адресов (NAT), встроены в операционную систему. Другие, такие как внешний контрольный вызов HTTP или вызов системы обнаружения вторжений (IDS), могут предоставляться независимыми поставщиками программного обеспечения (ISV). Функции выноски вызываются обработчиком фильтров, когда соответствующий фильтр выноски сопоставляется с заданным слоем.

Выноски могут быть зарегистрированы в любом из уровней ядра WFP. Выноски могут возвращать действие ("блокировать", "разрешить" и, при выполнении проверки потока, "отложить", "требуется больше данных", "удалить подключение"), а также изменять и защищать входящий и исходящий сетевой трафик.

После регистрации внешнего вызова с помощью обработчика фильтров он может получить сетевой трафик для обработки. Трафик может представлять собой пакеты, потоки или события в зависимости от слоя. Агент приложения или брандмауэра вызывает передачу трафика в выноску, добавляя фильтр с действием "Выноска", ИДЕНТИФИКАТОРом выноски которого является идентификатор вызова. В выносках можно указать обработчику фильтров, что следует вернуть "Block" или "разрешить" в оболочку совместимости. Кроме того, выноски могут возвращать "Continue", чтобы разрешить другим фильтрам обработку пакета.

Один драйвер выноски может предоставлять несколько вызовов.

Прежде чем можно будет использовать выноску, необходимо добавить (WITH [**FwpmCalloutAdd0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmcalloutadd0)) и зарегистрировать (WITH [фвпскаллаутрегистер](/windows-hardware/drivers/ddi/_netvista/)). Перед созданием фильтров, ссылающихся на выноску, требуется вызов **FwpmCalloutAdd0** . Вызов Фвпскаллаутрегистер требуется, прежде чем WFP сможет вызвать вызов, когда будут сопоставлены фильтры выноски. По умолчанию фильтры, которые ссылаются на вызываемые, но еще не зарегистрированные в обработчике фильтров, обрабатываются как фильтры блокировки. Порядок вызова **FwpmCalloutAdd0** и фвпскаллаутрегистер не имеет значения. Постоянная выноска должна быть добавлена только один раз и должна быть зарегистрирована при каждом запуске драйвера, реализующего выноску (например, после перезагрузки).

## <a name="classification"></a>Классификация

Классификация — это процесс применения фильтров к сетевому трафику (пакету, потоку или событию), чтобы определить результат "разрешить" или "блокировать" для этого трафика. Для одного пакета, потока или события существует один вызов классификации для каждого уровня.

Во время классификации свойства (например, исходный адрес) пакета, потока или события сравниваются с условиями фильтра, заданными для фильтров на уровне, где вызывается классификация. При обнаружении совпадений используется алгоритм [арбитража фильтра](filter-arbitration.md) для определения результата процесса классификации.

Запрос классификации активируется оболочкой совместимости.

Действия классификации могут быть либо:

-   Разрешение
-   Блокировать
-   Выноска
    -   Разрешение
    -   Блокировать
    -   Продолжить
    -   Которого
    -   Требуются дополнительные данные
    -   Удалить соединение

## <a name="wfp-operation"></a>Операция WFP

Во время загрузки, как только запускается драйвер стека TCP/IP (tcpip.sys), механизм фильтрации режима ядра применяет политику безопасности системы с помощью фильтров времени загрузки.

Когда модуль базовой фильтрации (BFE) запускается в пользовательском режиме, к платформе добавляются постоянные фильтры, фильтры времени загрузки отключаются, а уведомления отправляются в те драйверы выноски, которые подписаны с помощью [FwpmBfeStateSubscribeChanges0](/windows-hardware/drivers/ddi/fwpmk/nf-fwpmk-fwpmbfestatesubscribechanges0). Уведомления отправляются сразу после завершения инициализации BFE. Теперь платформа готова к регистрации для вызовов и для добавления объектов времени выполнения.

Переход со времени загрузки на постоянные фильтры может составлять несколько секунд или даже дольше на медленных компьютерах. Он является атомарным, поэтому, если у поставщика есть как время загрузки, так и постоянный фильтр, окно никогда не будет отображаться, если ни один из них не действует.

После запуска BFE фильтры времени выполнения могут добавляться агентами брандмауэра или пользовательскими решениями брандмауэра. Процедура BFE обрабатывает эти фильтры и отправляет их на соответствующий уровень обработчика фильтров для принудительного применения. BFE также принимает параметры проверки подлинности и отправляет эти параметры в модули ключей IPsec (IKE/AuthIP). Дополнительные сведения см. в разделе [конфигурация IPSec](ipsec-configuration.md) .

В любое время фильтры и параметры проверки подлинности можно добавлять, удалять или изменять в системе через интерфейс RPC, предоставляемый процедурой BFE. Дочерние слои и модули выноски также можно добавлять или удалять.

Поток данных:

1.  Пакет поступает в сетевой стек.
2.  Сетевой стек находит и вызывает оболочку совместимости.
3.  Оболочка совместимости вызывает процесс классификации на определенном уровне.
4.  Во время классификации фильтры сопоставляются, а результирующее действие принимается. (См. раздел [арбитраж фильтров](filter-arbitration.md).)
5.  Если во время процесса классификации сопоставлены все фильтры выноски, вызываются соответствующие выноски.
6.  Оболочка совместимости действует на заключительное решение по фильтрации (например, удаление пакета).

Поток исходящих данных соответствует аналогичному шаблону.

В следующих разделах описывается работа WFP.

-   [Потоки TCP-пакетов](tcp-packet-flows.md)
-   [Потоки UDP-пакетов](udp-packet-flows.md)
-   [Арбитраж фильтра](filter-arbitration.md)

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Объектная модель](object-model.md)
</dt> <dt>

[Управление объектами](object-management.md)
</dt> </dl>

 

 