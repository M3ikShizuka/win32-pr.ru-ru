---
title: SA вручную
description: Сценарий политики IPsec для сопоставления безопасности вручную позволяет вызывающим объектам обходить встроенные модули ключей IPsec (IKE и AuthIP), напрямую указывая SAs IPsec для защиты любого сетевого трафика.
ms.assetid: 2bcc0b40-ca43-43c6-b1e4-b64426ef7ff4
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: beeef4486e3a07dea2e83d924c2354a3dabca241
ms.sourcegitcommit: 78b64f3865e64768b5319d4f010032ee68924a98
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/13/2021
ms.locfileid: "107314577"
---
# <a name="manual-sa"></a>SA вручную

Сценарий политики IPsec для сопоставления безопасности вручную позволяет вызывающим объектам обходить встроенные модули ключей IPsec (IKE и AuthIP), напрямую указывая SAs IPsec для защиты любого сетевого трафика.

Пример возможного ручного сопоставления безопасности: "добавить пару IPsec SA для защиты всего трафика одноадресных данных между IP-адресами 1.1.1.1 & 2.2.2.2, за исключением ICMP, с использованием транспортного режима IPsec".

> [!Note]  
> Следующие шаги должны выполняться на обоих компьютерах с соответствующим образом настроенными IP-адресами.

 

Чтобы реализовать этот пример программно, используйте следующую конфигурацию платформы WFP.

<dl>

**На уровне \_ фвпм \_ входящий \_ транспорт \_ V {4 \| 6} Настройка входящих правил фильтрации для каждого пакета**  

1.  Добавьте фильтр со следующими свойствами. 

    | Свойство Filter                                                   | Значение                                                         |
    |-------------------------------------------------------------------|---------------------------------------------------------------|
    | **Фвпм \_ Условие \_ фильтрации \_ \_ \_ типа ЛОКАЛЬНОГО IP-адреса условия** | [нлатуникаст](/windows/win32/api/nldef/ne-nldef-nl_address_type) |
    | **\_ \_ локальный IP- \_ \_ адрес условия фвпм**                           | Соответствующий локальный адрес (1.1.1.1 или 2.2.2.2).           |
    | **\_ \_ Удаленный IP- \_ \_ адрес условия фвпм**                          | Соответствующий удаленный адрес (1.1.1.1 или 2.2.2.2).          |
    | **Action. Type**                                                   | **\_ \_ Завершение вызова действия \_ FWP**                         |
    | **Action. Каллауткэй**                                             | **ФВПМ \_ выноска \_ \_ входящего \_ транспорта IPSec \_ V {4 \| 6}**         |

        
2.  Исключите ICMP-трафик из IPsec, добавив фильтр со следующими свойствами. 

    | Свойство Filter                                                   | Значение                                                                      |
    |-------------------------------------------------------------------|----------------------------------------------------------------------------|
    | **Фвпм \_ Условие \_ фильтрации \_ \_ \_ типа ЛОКАЛЬНОГО IP-адреса условия** | нлатуникаст                                                                |
    | **Фвпм \_ Условие фильтрации \_ IP- \_ протокола условия**             | **Иппрото \_ ICMP {V6}** эти константы определены в Winsock2. h.<br/> |
    | **Action. Type**                                                   | **\_разрешение действия \_ FWP**                                                    |
    | **weight**                                                        | [**\_ \_ исключения IKE для диапазона веса \_ фвпм \_**](filter-weight-identifiers.md)  |

        

**На уровне \_ \_ исходящего \_ транспорта уровня фвпм \_ V {4 \| 6} Настройка правил фильтрации исходящих пакетов для каждого пакета**  

1.  Добавьте фильтр со следующими свойствами. 

    | Свойство Filter                                                   | Значение                                                  |
    |-------------------------------------------------------------------|--------------------------------------------------------|
    | **Фвпм \_ Условие \_ фильтрации \_ \_ \_ типа ЛОКАЛЬНОГО IP-адреса условия** | нлатуникаст                                            |
    | **Фвпм \_ Условие \_ фильтрации \_ локального \_ IP-адреса условия**       | Соответствующий локальный адрес (1.1.1.1 или 2.2.2.2).    |
    | **Фвпм \_ Условие \_ фильтрации \_ удаленных \_ IP-адресов условия**      | Соответствующий удаленный адрес (1.1.1.1 или 2.2.2.2).   |
    | **Action. Type**                                                   | **\_ \_ Завершение вызова действия \_ FWP**                  |
    | **Action. Каллауткэй**                                             | **\_Исходящий транспорт IPSec для фвпм выноски \_ \_ \_ \_ V {4 \| 6}** |

        
2.  Исключите ICMP-трафик из IPsec, добавив фильтр со следующими свойствами. 

    | Свойство Filter                                                   | Значение                                                                      |
    |-------------------------------------------------------------------|----------------------------------------------------------------------------|
    | **Фвпм \_ Условие \_ фильтрации \_ \_ \_ типа ЛОКАЛЬНОГО IP-адреса условия** | нлатуникаст                                                                |
    | **Фвпм \_ Условие фильтрации \_ IP- \_ протокола условия**             | **Иппрото \_ ICMP {V6}** эти константы определены в Winsock2. h.<br/> |
    | **Action. Type**                                                   | **\_разрешение действия \_ FWP**                                                    |
    | **weight**                                                        | **\_ \_ исключения IKE для диапазона веса \_ фвпм \_**                                   |

        

**Настройка входящих и исходящих сопоставлений безопасности**

1.  Вызовите [**IPsecSaContextCreate0**](/windows/desktop/api/Fwpmu/nf-fwpmu-ipsecsacontextcreate0), указав параметр *аутбаундтраффик* , содержащий IP-адреса 1.1.1.1 & 2.2.2.2, и **ипсекфилтерид** в качестве LUID фильтра выноски IPSec исходящего транспортного уровня, добавленного выше.
2.  Вызовите [**IPsecSaContextGetSpi0**](/windows/desktop/api/Fwpmu/nf-fwpmu-ipsecsacontextgetspi0)с параметром *ID* , содержащим идентификатор контекста, возвращенный из [**IPsecSaContextCreate0**](/windows/desktop/api/Fwpmu/nf-fwpmu-ipsecsacontextcreate0), и параметр *жетспи* , содержащий IP-адреса 1.1.1.1 & 2.2.2.2, и **ипсекфилтерид** в качестве LUID фильтра выноски IPSec транспортного уровня, добавленного выше. Возвращенное значение SPI предназначено для использования в качестве SPI входящего SA на локальном компьютере и в качестве исходящего SPI сопоставления безопасности на соответствующем удаленном компьютере. Оба компьютера должны использовать некоторые нестандартные средства для обмена значениями SPI.
3.  Вызовите [**IPsecSaContextAddInbound0**](/windows/desktop/api/Fwpmu/nf-fwpmu-ipsecsacontextaddinbound0)с параметром *ID* , содержащим идентификатор контекста, возвращенный из [**IPsecSaContextCreate0**](/windows/desktop/api/Fwpmu/nf-fwpmu-ipsecsacontextcreate0), и параметр *ИНБАУНДБУНДЛЕ* , описывающий свойства входящего пакета SA (входящего SA, тип преобразования, типы алгоритмов, ключи и т. д.).
4.  Вызовите [**IPsecSaContextAddOutbound0**](/windows/desktop/api/Fwpmu/nf-fwpmu-ipsecsacontextaddoutbound0)с параметром *ID* , содержащим идентификатор контекста, возвращенный из [**IPsecSaContextCreate0**](/windows/desktop/api/Fwpmu/nf-fwpmu-ipsecsacontextcreate0), и параметр *аутбаундбундле* , описывающий свойства исходящего пакета SA (например, исходящий SPI SA, тип преобразования, типы алгоритмов, ключи и т. д.).

  
</dl>

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Пример кода: ключ SA вручную](manual-sa-keying.md)
</dt> <dt>

[**Встроенные идентификаторы выноски**](built-in-callout-identifiers.md)
</dt> <dt>

[**Фильтрация идентификаторов слоя**](management-filtering-layer-identifiers-.md)
</dt> <dt>

[**ФВПМ \_ ACTION0**](/windows/desktop/api/Fwpmtypes/ns-fwpmtypes-fwpm_action0)
</dt> </dl>

 

