---
title: Сценарий 1. пример времени ожидания HTTP с использованием трассировки ETW и команд Netsh
description: С помощью трассировки ETW поток данных через компонент API сервера HTTP можно проверить для диагностики проблем.
ms.assetid: b6b24161-c3da-4972-b49f-c545da2fc81e
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: aa50f438aca664651b24db822f2b9e3a30da4682
ms.sourcegitcommit: 37f276b5d887a3aad04b1ba86e390dea9d87e591
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/04/2021
ms.locfileid: "104558346"
---
# <a name="scenario-1-http-timeout-example-using-etw-tracing-and-netsh-commands"></a>Сценарий 1. пример времени ожидания HTTP с использованием трассировки ETW и команд Netsh

С помощью трассировки ETW поток данных через компонент API сервера HTTP можно проверить для диагностики проблем. Например, пользователи веб-приложения могут видеть сообщения об ошибках в браузере, которые веб-страница не может отобразить. На сервере, на котором размещено веб-приложение, специалист по ИТ также видит запись времени ожидания подключения в журнале ошибок HTTP, как показано на рис. 1 ниже. Журнал ошибок HTTP можно найти в следующем каталоге:% WINDIR% \\ system32 \\ файл_журнала \\ хттперр \\ .

![Снимок экрана: командное окно Netsh H T P, в котором отображается журнал ошибок H t t P для времени ожидания.](images/httperrorlog.png)

Рис. 1. журнал ошибок HTTP для времени ожидания

## <a name="generating-an-etw-trace-report"></a>Создание отчета трассировки событий Windows

Чтобы создать отчет трассировки событий Windows для компонента API сервера HTTP, выполните приведенные ниже действия из командной строки. В этом примере трассировка выполняется на сервере, так как на нем размещается веб-приложение.

В приведенных ниже шагах создается трассировка с именем Httptrace. ETL, а затем производится преобразование трассировки в CSV-файл с именем httptrace.csv. Как показано ниже, поставщик ETW для API-сервера HTTP называется Microsoft-Windows-Хттпсервице. Параметр командной строки 0xFFF указывает, что должны быть захвачены все события ETW для этого поставщика.

**Создание отчета трассировки событий Windows**

1.  Запустите трассировку ETW для компонента API HTTP-сервера: l **ogman.exe Start Httptrace-p Microsoft-Windows-Хттпсервице 0xFFFF-o Httptrace. ETL-ETS**
2.  Воспроизведите ошибку, чтобы ее можно было записать в трассировку. В этом примере доступ к веб-приложению осуществляется с клиентского компьютера, что приводит к отображению на клиенте сообщения "**не удается отобразить страницу**".
3.  Теперь, когда эта ошибка воспроизведена, завершите трассировку: **logman.exe Httptrace-ETS**
4.  Преобразование отчета в формат CSV: **tracerpt.exe Httptrace. ETL-of CSV-o httptrace.csv**
5.  Просмотр отчета о трассировке. Выдержка из трассировки CSV показана ниже в таблице 1.

## <a name="viewing-the-trace-and-diagnosing"></a>Просмотр трассировки и диагностика

Полученный CSV-файл для трассировок можно просмотреть в Excel или в любом средстве, поддерживающем формат CSV. В таблице 1 ниже показаны фрагменты из образца файла трассировки (httptrace.csv). В отчете трассировки в столбце "уровень" отображается запись со значением "3", которое соответствует предупреждению в ETW. Компонент API сервера HTTP соответствует уровням ETW, определенным в следующей статье: ( https://msdn2.microsoft.com/library/aa382793.aspx) . Ниже перечислены уровни ETW.



| Level | Значение      |
|-------|--------------|
| 1     | Критически важно     |
| 2     | Ошибка        |
| 3     | Предупреждение      |
| 4     | инфоматионал |
| 5     | Подробный      |



 

С этим предупреждением тип события (столбец типа) сообщает "Коннтимедаут". В последующих столбцах для события Коннтимеаут для конкретного таймера, срок действия которого истек, указывается значение Timer \_ коннектионидле. Обратите внимание, что столбец с \_ записью "Timer коннектионидле" не включен в таблицу для краткости, и во избежание выдержки несмежных столбцов.



| Имя события                    | Тип            | Идентификатор события | Версия | Канал | Level |
|-------------------------------|-----------------|----------|---------|---------|-------|
| евенттраце                    | Header          | 0        | 2       | 0       | 0     |
| Microsoft-Windows-Хттпсервице | чгурлгрппроп   | 28       | 0       | 16      | 4     |
| Microsoft-Windows-Хттпсервице | аддурл          | 31       | 0       | 16      | 4     |
| Microsoft-Windows-Хттпсервице | чгреккуеуепроп | 30       | 0       | 16      | 4     |
| Microsoft-Windows-Хттпсервице | чгурлгрппроп   | 28       | 0       | 16      | 4     |
| Microsoft-Windows-Хттпсервице | чгсрвсеспроп   | 29       | 0       | 16      | 4     |
| Microsoft-Windows-Хттпсервице | чгсрвсеспроп   | 29       | 0       | 16      | 4     |
| Microsoft-Windows-Хттпсервице | коннконнект     | 21       | 0       | 16      | 4     |
| Microsoft-Windows-Хттпсервице | коннидассгн     | 22       | 0       | 16      | 4     |
| Microsoft-Windows-Хттпсервице | рекврек         | 1        | 0       | 16      | 4     |
| Microsoft-Windows-Хттпсервице | Синтаксический анализ           | 2        | 0       | 16      | 4     |
| Microsoft-Windows-Хттпсервице | логфилеврите    | 51       | 0       | 16      | 4     |
| Microsoft-Windows-Хттпсервице | коннклеануп     | 24       | 0       | 16      | 4     |
| Microsoft-Windows-Хттпсервице | коннтимедаут    | 53       | 0       | 16      | 3     |



 

Таблица 1. Выдержка из образца отчета трассировки для проблемы с таймером

В этом примере срок действия (Коннтимеаут) таймера заголовка (Timer \_ коннектионидле) является причиной того, что конечные пользователи видят сообщение "страница не может быть отображена" в своих веб-клиентах. Возможные причины истечения времени ожидания могут быть вызваны медленной отправкой веб-клиентов из-за медленных подключений. Для решения этой проблемы значение времени ожидания можно изменить с помощью команд Netsh.

## <a name="adjusting-timeout-through-netsh-and-verifying-the-solution"></a>Настройка времени ожидания с помощью команды netsh и проверка решения

Команды Netsh для HTTP, перечисленные ниже, позволяют ИТ-специалистам просматривать и настраивать значения параметров в компоненте API сервера HTTP. Изменения с помощью команд Netsh HTTP влияют на все серверные приложения, размещенные компонентом API сервера HTTP для этого компьютера. Эти изменения сохраняются во всех перезапусках компонента и перезагрузке компьютера. Команды netsh HTTP доступны в Windows Vista и Windows Server 2008 и заменяют средство HttpCfg.exe пакета ресурсов Windows Server 2003 при работе в Windows Vista и Windows Server 2008. В этом сценарии мы будем изменять значение времени ожидания, а затем подтверждаю решение. Таймеры существуют в компоненте API сервера HTTP для обеспечения доступности и защиты от чрезмерного использования неправильно настроенным или злонамеренным пользователем. Настройка таймеров из значений по умолчанию должна быть тщательно оценена с возможной атакой DoS.

В этом примере веб-клиенты находятся за сетевым подключением, что приводит к \_ событию таймера ETW коннектионидле. После рассмотрения причины истечения времени ожидания и балансировки с влиянием на нагрузку сервера принимается решение увеличить значения времени ожидания до 240 секунд. Вы можете просмотреть и настроить таймер с помощью следующей процедуры.

**Настройка таймера простаивающих подключений (Timer \_ коннектионидле) с помощью команды netsh**

1.  На сервере откройте окно командной строки с повышенными привилегиями и выполните следующие действия, чтобы просмотреть и настроить значение времени ожидания. Снимок экрана команды netsh HTTP показан на рис. 2 ниже.
2.  Показывать текущие значения времени ожидания: **netsh http показывать время ожидания**
3.  Настройте \_ значение времени ожидания Коннектионидле таймера. В этом примере значение изменяется на 240 секунд: **netsh http Add timeout тимеауттипе = idleconnectiontimeout значение = 240**

![командное окно netsh http](images/netshhttpcommand.png)

Рис. 2. командное окно Netsh HTTP

После настройки значения времени ожидания перезапустите процедуры диагностики ETW. Если условие ошибки исправлено, трассировка ETW больше не должна показывать время ожидания с уровнем трассировки событий Windows "3" для таймера простоя подключения.

 

 




