---
title: Проверка подлинности (API сервера HTTP)
description: Начиная с версии 2,0 API сервера HTTP выполняет проверку подлинности на стороне сервера для приложения.
ms.assetid: e8e41e8e-1b10-4747-b18e-763e0752ade4
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: c4e3c35dc4e244fd51af42bb3c52d225d233364f61fc79a8127ef450e84016fe
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "120078364"
---
# <a name="authentication-http-server-api"></a>Проверка подлинности (API сервера HTTP)

Некоторым серверным приложениям требуется проверка подлинности клиента для доступа к ресурсам и HTTP-запросам службы. Начиная с версии 2,0 API сервера HTTP выполняет проверку подлинности на стороне сервера для приложения. В API сервера HTTP версии 1,0 серверному приложению пришлось реализовать собственную проверку подлинности. Ниже перечислены некоторые преимущества проверки подлинности, выполняемые API-сервером HTTP.

-   Приложения могут работать с низким уровнем привилегий, тем самым уменьшая риски безопасности.
-   Проверка подлинности выполняется в режиме ядра, тем самым уменьшая переходы из пользовательского режима в режим ядра во время проверки подлинности.
-   Проверка подлинности, выполненная в режиме ядра, позволяет серверным приложениям работать с разными учетными записями пользователей. В версии 1,0 все приложения на компьютере должны работать под одной и той же учетной записью пользователя для проверки подлинности в имени участника-службы (SPN).
-   Подтверждение проверки подлинности NTLM не сбрасывается, если рабочий процесс перезапускается в процессе подтверждения.

Чтобы воспользоваться преимуществами проверки подлинности версии 2,0, приложение включит схемы проверки подлинности, применяемые API-сервером HTTP, к URL-адресам, для которых приложение зарегистрировано. Проверку подлинности можно включить в сеансе сервера или группе URL-адресов. Группа URL-адресов наследует схемы проверки подлинности, включенные сеансом сервера, если ни одна из них не задана в группе URL-адресов. API сервера HTTP поддерживает следующие схемы:

-   Согласование
-   NTLM
-   Digest (дайджест)
-   Basic

Серверное приложение также может реализовывать схемы проверки подлинности, не поддерживаемые API-сервером HTTP. API сервера HTTP отправляет запросы в приложение для схем проверки подлинности, которые не поддерживаются, или для схем, которые не были включены приложением.

### <a name="enabling-authentication"></a>Включение аутентификации

Серверное приложение включает и настраивает проверку подлинности в сеансе сервера или группе URL-адресов с помощью функций [**хттпсетсерверсессионпроперти**](/windows/desktop/api/Http/nf-http-httpsetserversessionproperty) или [**хттпсетурлграуппроперти**](/windows/desktop/api/Http/nf-http-httpseturlgroupproperty) следующим образом:

1.  Приложение включает проверку подлинности, указывая **хттпсервераусентикатионпроперти** в параметре *Property* [**хттпсетсерверсессионпроперти**](/windows/desktop/api/Http/nf-http-httpsetserversessionproperty) или [**хттпсетурлграуппроперти**](/windows/desktop/api/Http/nf-http-httpseturlgroupproperty).
2.  Приложение задает параметры конфигурации в структуре [**\_ \_ \_ сведений о проверке подлинности HTTP-сервера**](/windows/desktop/api/Http/ns-http-http_server_authentication_info) в параметре *ппропертинформатион* [**хттпсетсерверсессионпроперти**](/windows/desktop/api/Http/nf-http-httpsetserversessionproperty) или [**хттпсетурлграуппроперти**](/windows/desktop/api/Http/nf-http-httpseturlgroupproperty). В приложении указываются включенные схемы проверки подлинности, отключено ли кэширование учетных данных NTLM, а также предоставляются основные и дайджест-параметры в структуре **\_ \_ \_ сведений о проверке подлинности сервера HTTP** .

### <a name="authentication-procedure"></a>Процедура проверки подлинности

Чтобы инициировать проверку подлинности HTTP-сервера, приложение включает свойство проверки подлинности, прежде чем первый запрос поступит в очередь запросов. Следующие шаги являются стандартным потоком обработки для проверки подлинности запроса.

1.  Приложение включает проверку подлинности. См. предыдущий раздел "Включение проверки подлинности".
    > [!Note]  
    > Клиент отправляет запрос, не прошедший проверку подлинности. API сервера HTTP передает запрос серверному приложению и позволяет ему создать первоначальную задачу 401. API HTTP-сервера включает структуру данных [**HTTP- \_ запроса \_ AUTH \_**](/windows/desktop/api/Http/ns-http-http_request_auth_info) , внедренную в структуру [**HTTP- \_ запросов**](/previous-versions/windows/desktop/legacy/aa364545(v=vs.85)) . Элемент **аусстатус** указывает на **хттпаусстатуснотаусентикатед**

     

2.  Приложение проверяет элемент **аусстатус** структуры [**HTTP- \_ запроса \_ AUTH \_**](/windows/desktop/api/Http/ns-http-http_request_auth_info) , чтобы определить, прошел ли запрос проверку подлинности. Если запрос не прошел проверку подлинности, приложение может обслуживать запрос как анонимный или отправить первоначальный запрос проверки подлинности 401.
3.  Если приложение обслуживает запрос как анонимное, оно обрабатывает запрос и отправляет окончательный ответ клиентскому приложению, как если бы проверка подлинности не была задействована.
4.  Если вместо этого приложение требует проверки подлинности, оно отправляет первоначальный запрос 401 с одним или несколькими WWW-Authenticate заголовками, которые указывают на доступные схемы для клиента. Приложение должно использовать структуру [**HTTP с \_ несколькими \_ известными \_ заголовками**](/windows/desktop/api/Http/ns-http-http_multiple_known_headers) для создания необходимого набора заголовков при отправке в ответ нескольких заголовков проверки подлинности.
    > [!Note]
    >
    > Клиент повторно отправляет запрос с заголовком авторизации для схемы, выбранной из набора доступных схем, указанных серверным приложением в первом ответе 401.
    >
    > API сервера HTTP проверяет заголовок авторизации запроса на авторизацию, чтобы определить, включена ли схема. Если это так, то API сервера HTTP выполняет проверку подлинности и обрабатывает все промежуточные запросы и сообщения 401-Response, пока подтверждение проверки подлинности не будет завершено.
    >
    > Когда API сервера HTTP завершает попытку проверки подлинности, он отправляет приложению запрос с результатами попытки проверки подлинности в структуре данных [**HTTP- \_ запроса \_ AUTH \_**](/windows/desktop/api/Http/ns-http-http_request_auth_info) , возвращаемой с запросом. Если попытка проверки подлинности завершается неудачей по одной из следующих причин, HTTP-API сервера не передает запрос приложению:
    >
    > -   В случае сбоя подтверждения подлинности из-за внутренней ошибки API сервера HTTP, такой как сбой выделения памяти, API сервера HTTP создает ответ 503 (служба недоступна) и отправляется обратно клиенту.
    > -   Если обнаружен неправильно сформированный заголовок авторизации, например заголовок без имени схемы или неправильно сформированная кодировка Base64 для учетных данных клиента, то API-интерфейс сервера HTTP создает ответ 400 (недопустимый запрос) и отправляется обратно клиенту.

     

5.  Серверное приложение просматривает элемент **аусстатус** структуры [**HTTP- \_ запроса \_ \_**](/windows/desktop/api/Http/ns-http-http_request_auth_info) Authentication, чтобы определить, была ли проверка подлинности успешной. При сбое проверки подлинности API сервера HTTP включает ошибку, возвращенную из [AcceptSecurityContext](/previous-versions/windows/embedded/ms937012(v=msdn.10)) в члене **Секстатус** структуры **HTTP- \_ запроса \_ AUTH \_** . Если попытка проверки подлинности завершается неудачей из-за неправильных учетных данных, приложение может создать еще одну ошибку 401 с нужным заголовком WWW-Authenticate или может обслужить запрос как анонимный.
6.  Если проверка подлинности прошла успешно, приложение использует маркер, указанный в структуре [**\_ \_ \_ сведений о проверке подлинности HTTP-запроса**](/windows/desktop/api/Http/ns-http-http_request_auth_info) , для олицетворения клиента и доступа к ресурсам. Маркер доступа, возвращаемый в приложение, является допустимым, пока идентификатор запроса является допустимым, что обычно происходит до тех пор, пока приложение не завершит ответ на запрос. Однако срок действия маркера может истечь в течение этого периода, и приложению может потребоваться отправить клиенту еще одну проблему 401.
7.  Приложение отправляет окончательный ответ в 200 ОК и должен закрыть маркер маркера доступа.
    > [!Note]  
    > API сервера HTTP добавляет данные взаимной проверки подлинности к последнему ответу 200 ОК, если он был создан во время подтверждения подлинности.

     

### <a name="ntlm-null-sessions"></a>Сеансы NTLM NULL

Обратите внимание, что сеанс NTLM NULL, указанный в окончательном контексте безопасности, не рассматривается как аутентифицированный. В этом случае запрос отправляется в приложение с ошибкой Хттпаусстатусфаилуре в структуре [**\_ \_ \_ сведений о проверке подлинности HTTP-запроса**](/windows/desktop/api/Http/ns-http-http_request_auth_info) , и приложение может отправить еще одну задачу 401.

### <a name="preemptive-authentication"></a>Приоритетная аутентификация

В соответствии с протоколом HTTP после того, как клиент установил проверку подлинности для ресурса, он может заранее отсылать соответствующий заголовок авторизации с последовательными запросами для ресурса, не дожидаясь запроса 401 с сервера. Если схема, указанная в заголовке авторизации, по-прежнему включена приложением и поддерживается API HTTP-сервера, HTTP-сервер попытается выполнить проверку подлинности без отправки запроса приложению. Когда приложение получает этот тип запроса, прошедшего проверку подлинности, он может отказаться от запроса и повторно создать первоначальный запрос на 401 или службу, чтобы запрос прошел проверку подлинности.

### <a name="mutual-authentication"></a>Взаимная проверка подлинности

Данные взаимной проверки подлинности создаются, когда схема согласования используется во время подтверждения и разрешается в Kerberos, а клиент запрашивает взаимную проверку подлинности. Данные взаимной проверки подлинности автоматически вставляются API HTTP-сервера в последнем ответе 200 ОК, отправленном серверным приложением. По умолчанию API сервера HTTP не передает данные взаимной проверки подлинности в серверное приложение, так как оно автоматически обрабатывает отправку. Однако если серверное приложение включает флаг Рецеивемутуалаус в структуре [**\_ \_ \_ сведений о проверке подлинности HTTP-сервера**](/windows/desktop/api/Http/ns-http-http_server_authentication_info) в конфигурации, то данные взаимной проверки подлинности передаются в приложение в структуре данных проверки подлинности [**HTTP- \_ запроса \_ \_**](/windows/desktop/api/Http/ns-http-http_request_auth_info) , внедренной в [**HTTP- \_ запрос**](/previous-versions/windows/desktop/legacy/aa364545(v=vs.85)), прошедший проверку В этом случае приложение должно отправить данные взаимной проверки подлинности с завершающим ответом 200 ОК. Если один компьютер обслуживает несколько сайтов, все сайты компьютера используют для взаимной проверки подлинности учетные данные учетной записи локального компьютера в домене.

 

 
