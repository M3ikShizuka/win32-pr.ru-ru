---
description: Инфраструктуры одноранговых схем и одноранговых групп позволяют приложениям напрямую подключаться к одному узлу (графике) или члену (группированию), а затем напрямую обмениваться данными с узлом. Это соединение называется прямым соединением.
ms.assetid: 65f3d3a5-c015-4724-b9ed-45af7fde7a45
title: Прямые подключения
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e357b3a4ebc765a013de05234bc8fc9be20943d9
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105663355"
---
# <a name="direct-connections"></a>Прямые подключения

Инфраструктуры одноранговых схем и одноранговых групп позволяют приложениям напрямую подключаться к одному узлу (графике) или члену (группированию), а затем напрямую обмениваться данными с узлом. Это соединение называется **прямым соединением**.

## <a name="direct-connections-using-the-peer-graphing-infrastructure"></a>Прямые подключения с помощью инфраструктуры одноранговых диаграмм

Прежде чем можно будет установить прямое соединение между двумя узлами в графе, оба узла должны быть зарегистрированы для **события \_ \_ \_ прямого \_ подключения однорангового графа** . Для получения данных через прямое подключение узлы также должны быть зарегистрированы для события « **\_ \_ \_ входные \_ данные события однорангового графа** ».

**Одноранговая сеть \_ \_ \_ Прямое \_ соединение с событием Graph** — это событие, которое уведомляет приложение о том, успешно ли выполнена или неудачная попытка прямого подключения. Фактическое состояние успеха или сбоя вызова [**пирграфопендиректконнектион**](/windows/desktop/api/P2P/nf-p2p-peergraphopendirectconnection) возвращается в структуре [**\_ \_ \_ данных события однорангового графа**](/windows/desktop/api/P2P/ns-p2p-peer_graph_event_data) .

Чтобы создать прямое соединение, приложение вызывает [**пирграфопендиректконнектион**](/windows/desktop/api/P2P/nf-p2p-peergraphopendirectconnection), а затем передает в граф маркер, указатель на удостоверение другого узла, участвующего в соединении, и указатель на структуру IPv6-адреса для участвующего узла. Идентификатор узла и IPv6-адрес, указанные в вызове **пирграфопендиректконнектион** , должны быть зарегистрированы для события **с \_ \_ \_ \_ данными о событиях однорангового графа** или не могут получать данные, отправленные вызывающим одноранговым узлом. При успешном выполнении **пирграфопендиректконнектион** возвращает идентификатор 64-битного соединения. Однако одноранговый узел должен ожидать событие **\_ \_ \_ прямого \_ подключения одноранговой группы** , прежде чем идентификатор прямого подключения может быть идентифицирован как допустимый.

После установления соединения и подтверждения допустимого идентификатора соединения приложение может вызвать [**пирграфсенддата**](/windows/desktop/api/P2P/nf-p2p-peergraphsenddata) , чтобы отправить данные по соединению, заданному ДОПУСТИМЫм идентификатором соединения, к участвующему одноранговому узлу — Если участвующий кэширующий узел зарегистрирован для события одноэлементных **\_ \_ \_ \_ данных однорангового графа** . Непрозрачные данные доступны как структура [**\_ данных однорангового узла**](/windows/desktop/api/P2P/ns-p2p-peer_data) в [**\_ \_ \_ данных**](/windows/desktop/api/P2P/ns-p2p-peer_event_incoming_data) одноранговых событий, возвращенных событием **\_ \_ \_ входящих \_ данных события однорангового графа** .

Если соединение не требуется, приложение вызывает [**пирграфклоседиректконнектион**](/windows/desktop/api/P2P/nf-p2p-peergraphclosedirectconnection) с маркером графа и идентификатором соединения.

## <a name="direct-connections-using-the-peer-grouping-infrastructure"></a>Прямые соединения с использованием инфраструктуры однорангового группирования

Прямые соединения в инфраструктуре одноранговых групп обрабатываются аналогично инфраструктуре одноранговых диаграмм.

Прежде чем можно будет установить прямое соединение между двумя членами в группе, оба члена должны зарегистрироваться для события **\_ \_ \_ прямого \_ соединения с событием одноранговой группы** . Если члену группы требуется получать данные через прямое соединение, член группы также должен зарегистрироваться для события **\_ \_ \_ входящих \_ данных события одноранговой группы** .

**Одноранговая сеть \_ \_ \_ Прямое \_ соединение с событием группы** — это событие, которое уведомляет приложение о том, успешно ли выполнена или неудачная попытка прямого подключения. Фактическое состояние успеха или сбоя вызова [**пирграупопендиректконнектион**](/windows/desktop/api/P2P/nf-p2p-peergroupopendirectconnection) возвращается в структуре [**PEER_GROUP_EVENT_DATA**](/windows/win32/api/p2p/ns-p2p-peer_group_event_data-r1) .

Чтобы создать прямое соединение, приложение вызывает [**пирграупопендиректконнектион**](/windows/desktop/api/P2P/nf-p2p-peergroupopendirectconnection), а затем передает в группу маркер, указатель на удостоверение другого члена, который будет участвовать в этом соединении, и указатель на структуру IPv6-адреса для участвующего члена. Элемент, удостоверение и IPv6-адрес которого указаны в вызове **пирграупопендиректконнектион** , должен быть зарегистрирован для **события \_ \_ \_ входящих \_ данных события одноранговой группы** , или член не может получать данные, отправленные вызывающим одноранговым узлом. **Пирграупопендиректконнектион** возвращает 64-разрядный идентификатор соединения при успешном выполнении. Однако одноранговый узел должен дождаться возникновения события **\_ \_ \_ прямого \_ подключения однорангового графа** , прежде чем идентификатор прямого подключения сможет быть идентифицирован как допустимый.

После установления соединения и подтверждения допустимого идентификатора соединения приложение может вызвать [**пирграупсенддата**](/windows/desktop/api/P2P/nf-p2p-peergroupsenddata) для отправки данных через соединение, заданное ДОПУСТИМЫм идентификатором соединения, на участвующего в качестве участника, если участвующий кэширующий узел зарегистрирован для события **\_ \_ \_ входящих \_ данных одноранговой группы** . Непрозрачные данные доступны в виде [**структуры \_ данных одноранговых узлов**](/windows/desktop/api/P2P/ns-p2p-peer_data) в [**\_ \_ \_ данных**](/windows/desktop/api/P2P/ns-p2p-peer_event_incoming_data) одноранговых событий, возвращенных событием **\_ \_ \_ входящих \_ данных события одноранговой группы** .

Если соединение не требуется, приложение вызывает [**пирграупклоседиректконнектион**](/windows/desktop/api/P2P/nf-p2p-peergroupclosedirectconnection) с маркером группы и идентификатором соединения.

## <a name="example-of-a-direct-connection-for-graphing"></a>Пример прямого подключения для построения диаграмм


```C++
#include <p2p.h>

#pragma comment(lib, "p2pgraph.lib")

//-----------------------------------------------------------------------------
// Function: CreateDirectConnection
//
// Purpose:  Demonstrate how to create a direct connection.
//
// Arguments:
//           hGraph - the graph in which to create the connection
//           pwzId  - the peer identification string
//
// Returns:  ULONGLONG - the connection id or 0
//

ULONGLONG CreateDirectConnection(HGRAPH hGraph, PCWSTR pwzId)
{
    HRESULT   hr = S_OK;

    ULONGLONG ullConnection = 0; // the connection id to return

    HPEERENUM hPeerEnum = NULL;
 
    hr = PeerGraphEnumNodes(hGraph, pwzId, &hPeerEnum);

    if (SUCCEEDED(hr))
    {
        ULONG cItem = 1; // want only one matching result

        PEER_NODE_INFO ** ppNodeInfo = NULL;

        hr = PeerGraphGetNextItem(hPeerEnum, &cItem, (PVOID**) &ppNodeInfo);

        if (SUCCEEDED(hr))
        {
            if ((cItem > 0) && (NULL != ppNodeInfo))
            {
                if ((*ppNodeInfo)->cAddresses > 0)
                {
                    hr = PeerGraphOpenDirectConnection(hGraph, pwzId,
                            &(*ppNodeInfo)->pAddresses[0], &ullConnection);
                }
                PeerGraphFreeData(ppNodeInfo);
            }
        }
        PeerGraphEndEnumeration(hPeerEnum);
    }
    return ullConnection;
}

```



 

 



