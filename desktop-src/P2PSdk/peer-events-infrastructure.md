---
description: Одноранговая инфраструктура использует события для уведомления приложений об изменениях, произошедших в одноранговой сети, например об узле, который добавляется или удаляется из графа.
ms.assetid: a056da1c-b8f9-4dad-8df9-df24c6b359b7
title: Инфраструктура событий одноранговых узлов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a889f59e4429e64258c047dfbf0249bb4dca125bfc3f9d659e6042dd40be9443
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119775954"
---
# <a name="peer-events-infrastructure"></a>Инфраструктура событий одноранговых узлов

Одноранговая инфраструктура использует события для уведомления приложений об изменениях, произошедших в одноранговой сети, например об узле, который добавляется или удаляется из графа. Инфраструктуры одноранговых схем и одноранговых групп используют инфраструктуру событий.

## <a name="receiving-peer-event-notification"></a>Получение уведомления о событии однорангового узла

Одноранговый узел может зарегистрироваться для получения уведомлений при изменении атрибута диаграммы или группы или при возникновении определенного однорангового события. Одноранговые приложения вызывают функцию [**пирграфрегистеревент**](/windows/desktop/api/P2P/nf-p2p-peergraphregisterevent) или [**пирграупрегистеревент**](/windows/desktop/api/P2P/nf-p2p-peergroupregisterevent) и передают в одноранговую инфраструктуру обработчик событий, созданный ранее путем вызова функции [**CreateEvent**](graphing-reference-links.md). Одноранговая инфраструктура использует дескриптор для сигнализации приложения о том, что произошло событие однорангового узла.

Приложение также передает ряд структур [**\_ \_ \_ регистрации**](/windows/desktop/api/P2P/ns-p2p-peer_group_event_registration) [**\_ \_ событий \_**](/windows/desktop/api/P2P/ns-p2p-peer_graph_event_registration) одноранговых групп, которые указывают на одноранговую инфраструктуру конкретные события одноранговых узлов, для которых приложение запрашивает уведомления. Приложение также должно точно указать, сколько структур передается.

## <a name="peer-graphing-events"></a>События одноранговой диаграммы

Приложение одноранговых диаграмм может зарегистрироваться для получения уведомлений о 9 одноранговых событиях графа. Имя каждого события предшествует **\_ \_ \_ событию однорангового графа**, например **\_ \_ \_ изменение состояния однорангового графа**. Если не указано иное, сведения об изменении извлекаются с помощью [**пирграфжетевентдата**](/windows/desktop/api/P2P/nf-p2p-peergraphgeteventdata).

-   **Одноранговая сеть \_ \_Состояние события графа \_ \_ изменилось** указывает, что состояние диаграммы изменено, например, узел синхронизирован с графиком.
-   **Одноранговая сеть \_ \_ \_ \_ Изменение свойства события Graph** указывает на изменение свойства диаграммы или группы, например, изменение понятного имени графа.
    > [!Note]  
    > Приложение должно вызвать [**пирграфжетпропертиес**](/windows/desktop/api/P2P/nf-p2p-peergraphgetproperties) для получения измененных сведений.

     

-   **Одноранговая сеть \_ \_ \_ \_ Изменение записи о событии Graph** означает, что запись изменена, например, запись удаляется.
-   **Одноранговая сеть \_ \_ \_ Прямое \_ соединение с событием Graph** означает, что прямое соединение изменилось, например, если узел подключен.
-   **Одноранговая сеть \_ \_ \_ \_ Подключение соседа о событии Graph** указывает на изменение соединения с соседним узлом, например с подключением узла.
-   **Одноранговая сеть \_ \_ \_ Поступающие \_ данные события Graph** указывают, что данные были получены от прямого или соседнего соединения.
-   **Одноранговая сеть \_ \_ \_ \_ Требуется подключение к событию графа** указывает, что для инфраструктуры диаграмм требуется новое соединение.
    > [!Note]  
    > Вызов [**пирграфконнект**](/windows/desktop/api/P2P/nf-p2p-peergraphconnect) подключается к новому узлу. Вызов [**пирграфжетевентдата**](/windows/desktop/api/P2P/nf-p2p-peergraphgeteventdata) не возвращает данные.

     

-   **Одноранговая сеть \_ \_ \_ \_ Изменение узла событий Graph** означает, что сведения о присутствии узла изменены, например, изменился IP-адрес.
-   **Одноранговая сеть \_ Событие ГРАФа \_ \_ синхронизировано** указывает на то, что конкретный тип записи является синхронизированным.

Когда приложение получает уведомление о возникновении однорангового события, приложение вызывает [**пирграфжетевентдата**](/windows/desktop/api/P2P/nf-p2p-peergraphgeteventdata)и передает маркер однорангового события, возвращенный [**пирграфрегистеревент**](/windows/desktop/api/P2P/nf-p2p-peergraphregisterevent). Одноранговая инфраструктура возвращает указатель на структуру [**\_ \_ \_ данных события однорангового графа**](/windows/desktop/api/P2P/ns-p2p-peer_graph_event_data) , которая содержит запрошенные данные. Эта функция должна вызываться до тех пор, пока не будут возвращены **\_ \_ \_ \_ данные события для однорангового узла** .

После того как приложению не требуется уведомление о событии однорангового узла, приложение вызывает либо [**пирграфунрегистеревент**](/windows/desktop/api/P2P/nf-p2p-peergraphunregisterevent), либо передает маркер однорангового события, возвращенный [**пирграфрегистеревент**](/windows/desktop/api/P2P/nf-p2p-peergraphregisterevent) при регистрации приложения.

## <a name="handling-graph-connection-referrals"></a>обработка ссылок Graph соединений

При вызове [**пирграфконнект**](/windows/desktop/api/P2P/nf-p2p-peergraphconnect) одноранговый узел уведомляется об успешном или неуспешном выполнении через событие **\_ \_ \_ \_ соединения соседа асинхронного однорангового графа** . Если соединение не удалось из-за конкретных проблем с сетью (например, неправильно настроенного брандмауэра), возникает **событие \_ \_ \_ \_ подключения соседа однорангового графа** , при этом состояние подключения установлено в **одноранговое \_ соединение \_ не удалось**.

Тем не менее, когда одноранговый узел получает ссылку при попытке подключения к занятому узлу, на Соединенном одноранговом узле создается **\_ \_ \_ \_ Подключение к соседнему объекту графа однорангового** узла, при этом состояние подключения установлено в **одноранговое \_ соединение \_**. Соединительный узел может называться другим узлом, который сам по себе занят и может отправить ссылку, а на подключенном одноранговом узле порождается то же событие и состояние. Эта цепочка ссылок, приводящая **\_ к \_ ошибкам однорангового подключения** , может продолжаться до тех пор, пока не будет исчерпано максимальное число попыток подключения. Одноранговый узел не имеет механизма для определения разницы между полной попыткой соединения и ссылкой соединения.

Для решения этой проблемы разработчики должны использовать события изменения состояния однорангового графа, чтобы определить, выполнено ли попытка подключения. Если событие не получено в течение определенного промежутка времени, приложение может предположить, что подключенный одноранговый узел упоминается и что одноранговое приложение должно считать попытку подключения неудачной.

## <a name="peer-grouping-events"></a>События группирования одноранговых узлов

Приложение однорангового группирования может зарегистрироваться для получения уведомлений о 8 одноранговых событиях. Каждое имя события предшествует **\_ \_ событию \_ одноранговой группы**, например **\_ \_ \_ \_ изменилось состояние события одноранговой группы**. Если не указано иное, сведения об изменении извлекаются с помощью [**пирграупжетевентдата**](/windows/desktop/api/P2P/nf-p2p-peergroupgeteventdata).

-   **Одноранговая сеть \_ \_ \_ \_ Изменение состояния события группы** означает, что состояние группы изменилось. Возможны два значения состояния: **\_ \_ \_ Ожидание состояния одноранговой группы**, которое указывает, что группа не имеет соединений и ожидает наличия новых участников; и **состояние одноранговой \_ группы \_ \_ имеет соединения**, что означает, что у группы есть хотя бы одно соединение. Это значение состояния может быть получено путем вызова [**пирграупжетстатус**](/windows/desktop/api/P2P/nf-p2p-peergroupgetstatus) после возникновения этого события.
-   **Одноранговая сеть \_ \_ \_ \_ Изменение свойства события группы** указывает на то, что свойства группы были изменены или обновлены создателем группы.
-   **Одноранговая сеть \_ \_ \_ \_ Изменение записи о событии группы** означает, что была выполнена операция записи. Это событие возникает, когда одноранговый узел, участвующий в группе, публикует, обновляет или удаляет запись. Например, это событие возникает, когда приложение разговора отправляет сообщение разговора.
-   **Одноранговая сеть \_ \_Член события \_ группы \_ изменился** указывает, что состояние элемента в группе изменилось. Изменения состояния включают:
    -   **Одноранговая сеть \_ УЧАСТНИК \_ подключен**. Одноранговый узел подключен к группе.
    -   **Одноранговая сеть \_ ЧЛЕН \_ отключен**. Одноранговый узел отключен от группы.
    -   **Одноранговая сеть \_ \_ПРИСОЕДИНЕН участник**. Сведения о новых членстве опубликованы для однорангового узла.
    -   **Одноранговая сеть \_ ЭЛЕМЕНТ \_ обновлен**. Одноранговый узел обновлен новыми данными, например новым IP-адресом.
-   **Одноранговая сеть \_ \_ \_ \_ Подключение к соседнему узлу события группы**. Узлы, которые будут участвовать в подключениях соседей в группе, должны зарегистрироваться для этого события. Обратите внимание, что регистрация для этого события не позволяет одноранговому узлу принимать данные. Регистрация для этого события гарантирует получение уведомления только при получении запроса на подключение соседа.
-   **Одноранговая сеть \_ \_ \_ прямое \_ соединение с событием группы**. Узлы, которые будут участвовать в прямых подключениях в группе, должны зарегистрироваться для этого события. Обратите внимание, что регистрация для этого события не позволяет одноранговому узлу принимать данные. Регистрация для этого события гарантирует получение уведомления только при получении запроса на прямое подключение.
-   **Одноранговая сеть \_ ГРУППИРОВАНие \_ \_ входящих \_ данных событий**. Узлы, которые будут принимать данные через соседа или прямое подключение, должны регистрироваться для этого события. При возникновении этого события непрозрачные данные, передаваемые другим участвующим одноранговым узлом, могут быть получены путем вызова [**пирграупжетевентдата**](/windows/desktop/api/P2P/nf-p2p-peergroupgeteventdata). Обратите внимание, что для получения этого события узел должен быть ранее зарегистрирован для **\_ \_ \_ \_ подключения к соседнему** узлу события **одноранговой \_ группы \_ \_ \_** .
-   **Одноранговая сеть \_ \_ \_ \_ не удалось установить соединение с событием группы**. Не удалось установить соединение по какой-либо причине. При возникновении этого события данные не предоставляются, и [**пирграупжетевентдата**](/windows/desktop/api/P2P/nf-p2p-peergroupgeteventdata) не должен вызываться.

Когда приложение получает уведомление о возникновении однорангового события ( **\_ \_ \_ \_ не удалось подключиться к событию одноранговой группы**), приложение вызывает [**пирграупжетевентдата**](/windows/desktop/api/P2P/nf-p2p-peergroupgeteventdata)и передает маркер однорангового события, возвращенный [**пирграупрегистеревент**](/windows/desktop/api/P2P/nf-p2p-peergroupregisterevent). Одноранговая инфраструктура возвращает указатель на структуру [**\_ \_ \_ данных события одноранговой группы**](/windows/win32/api/p2p/ns-p2p-peer_group_event_data-r1) , которая содержит запрошенные данные. Эта функция должна вызываться до тех пор, пока не будут возвращены **\_ \_ \_ \_ данные события для однорангового узла** . Если приложению больше не требуется уведомление для однорангового события, необходимо выполнить вызов [**пирграупунрегистеревент**](/windows/desktop/api/P2P/nf-p2p-peergroupunregisterevent), передав маркер однорангового события, возвращенный **пирграупрегистеревент** , при регистрации приложения для конкретного события.

## <a name="example-of-registering-for-peer-graphing-events"></a>Пример регистрации для событий одноранговой диаграммы

В следующем примере кода показано, как выполнить регистрацию с помощью событий одноранговых диаграмм.


```C++
//-----------------------------------------------------------------------------
// Function: RegisterForEvents
//
// Purpose:  Registers the EventCallback function so it can be called for only
//           the events that are specified.
//
// Returns:  HRESULT
//
HRESULT RegisterForEvents()
{
    HPEEREVENT  g_hPeerEvent = NULL;        // The one PeerEvent handle
    HANDLE      g_hEvent = NULL;            // Handle signaled by Graphing when we have an event
    HRESULT hr = S_OK;
    PEER_GRAPH_EVENT_REGISTRATION regs[] = {
        { PEER_GRAPH_EVENT_RECORD_CHANGED, 0 },
        { PEER_GRAPH_EVENT_NODE_CHANGED,   0 },
        { PEER_GRAPH_EVENT_STATUS_CHANGED, 0 },
        { PEER_GRAPH_EVENT_DIRECT_CONNECTION, 0 },
        { PEER_GRAPH_EVENT_INCOMING_DATA, 0 },
    };

    g_hEvent = CreateEvent(NULL, FALSE, FALSE, NULL);
    if (g_hEvent == NULL)
    {
        wprintf(L"CreateEvent call failed.\n");
        hr = E_OUTOFMEMORY;
    }
    else
    {
        hr = PeerGraphRegisterEvent(g_hGraph, g_hEvent, celems(regs), regs,  &g_hPeerEvent);
        if (FAILED(hr))
        {
           wprintf(L"PeerGraphRegisterEvent call failed.\n");
            CloseHandle(g_hEvent);
            g_hEvent = NULL;
        }
    }

    if (SUCCEEDED(hr))
    {
        if (!RegisterWaitForSingleObject(&g_hWait, g_hEvent, EventCallback, NULL, INFINITE, WT_EXECUTEDEFAULT))
        {
            hr = HRESULT_FROM_WIN32(GetLastError());
            wprintf(L"Could not set up event callback.\n");
            CloseHandle(g_hEvent);
            g_hEvent = NULL;
        }
    }

    return hr;
}
```



 

 



