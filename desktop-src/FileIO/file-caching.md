---
description: Windows кэширует файловые данные, которые считываются с дисков и записываются на диски.
ms.assetid: 0865c741-63e3-4246-ba69-801b02153e4a
title: Кэширование файлов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1a14fb668af16cfb8a4e42b59b25b73ecefbb7cb
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103912867"
---
# <a name="file-caching"></a>Кэширование файлов

По умолчанию Windows кэширует данные файлов, которые считываются с дисков и записываются на диски. Это означает, что операции чтения считывают файловые данные из области в системной памяти, которая называется кэшем системных файлов, а не с физического диска. Соответственно, при операциях записи данные файлов записываются в системный файловый кэш, а не на диск. Такой тип кэша называется кэшем обратной записи. Управление кэшированием осуществляется для каждого файлового объекта.

Кэширование выполняется в направлении *диспетчера кэша*, которое постоянно работает во время работы Windows. Данные файлов в кэше системных файлов записываются на диск с интервалами, определенными операционной системой, и память, ранее используемая этими данными файлов, освобождается — это называется *сбросом* кэша. Политика задержки записи данных в файл и удерживает ее в кэше до тех пор, пока кэш не будет сброшен, а диспетчер кэша запустится с интервалом времени завершения. Время записи на диск блока данных частично зависит от длительности его хранения в кэше, а также от времени, прошедшего с момента последнего обращения к этим данным при выполнении операции чтения. Это гарантирует, что данные файлов, которые часто считываются, останутся доступными в системном файловом кэше максимально долго.

Этот процесс кэширования данных файлов показан на следующем рисунке.

![процесс кэширования файловых данных](images/fig3.png)

Как показано сплошными стрелками на предыдущем рисунке, область данных размером 256 КБ считывается в области кэша 256 КБ в системном адресном пространстве при первом запросе диспетчером кэша во время операции чтения файла. Затем процесс пользовательского режима копирует данные из этого слота в свое собственное адресное пространство. Завершив обращение к данным, процесс записывает измененные данные в тот же слот в системном кэше. На рисунке это обозначено пунктирной стрелкой между адресным пространством процесса и системным кэшем. Когда диспетчер кэша определит, что данные больше не понадобятся в течение определенного промежутка времени, они записывают измененные данные обратно в файл на диске, как показано стрелкой пунктира между системным кэшем и диском.

Количество операций ввода-вывода, которые предлагает кэширование файловых данных, зависит от размера считываемых или записываемых блоков файловых файлов. Когда большие блоки файловых данных считываются и записываются, скорее всего, для завершения операции ввода-вывода будет необходимо чтение и запись с диска. Производительность операций ввода-вывода будет все более нарушена, так как выполняется больше операций ввода-вывода.

В таких ситуациях кэширование может быть отключено. Это делается во время открытия файла путем передачи **\_ флага файла \_ без \_ буферизации** в качестве значения параметра *двфлагсандаттрибутес* [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea). Если кэширование отключено, все операции чтения и записи напрямую обращаются к физическому диску. Однако метаданные файла могут по-прежнему кэшироваться. Чтобы записать метаданные на диск, используйте функцию [**FlushFileBuffers**](/windows/desktop/api/FileAPI/nf-fileapi-flushfilebuffers) .

Частота, с которой происходит запись в систему, является важным фактором, позволяющим сбалансировать производительность системы с надежностью системы. Если система записывает кэш слишком часто, количество операций записи большого объема может значительно снизить производительность системы. Если система не записывается достаточно часто, то вероятность будет выше, когда кэш будет исчерпан из-за превышения объема памяти или внезапного сбоя системы (например, потери питания компьютера) перед очисткой. В последнем случае кэшированные данные будут потеряны.

Чтобы обеспечить правильное количество операций очистки, диспетчер кэша создает процесс каждую секунду с именем отложенной записи. Процесс отложенной записи помещает в очередь одну восьмую страниц, которые не были недавно записаны для записи на диск. Он постоянно оценивает объем данных, записываемых на диск, для оптимальной производительности системы, а также в том случае, если больше данных необходимо записать в очередь больше данных. Отложенные модули записи не сбрасывают временные файлы, поскольку предполагается, что они будут удалены приложением или системой.

Некоторые приложения, например антивирусная программа, занимают немедленный сброс операций записи на диск. Windows обеспечивает такую возможность благодаря кэшированию с возможностью записи. Процесс обеспечивает кэширование сквозного чтения для определенной операции ввода-вывода путем передачи **\_ флага файла \_ Write \_ через** флаг в вызов [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea). При включенном кэшировании с возможностью записи данные по-прежнему записываются в кэш, но диспетчер кэша записывает данные сразу на диск, а не задерживает задержку с помощью модуля отложенной записи. Процесс также может принудительно выполнить сброс открытого файла, вызвав функцию [**FlushFileBuffers**](/windows/desktop/api/FileAPI/nf-fileapi-flushfilebuffers) .

Метаданные файловой системы всегда кэшируются. Таким образом, для сохранения любых изменений метаданных на диске файл должен быть сброшен или открыт с **\_ флагом файла \_ Write \_** by.

 

 



