---
description: Операция блочного клона указывает файловой системе копировать диапазон байт файлов от имени приложения.
ms.assetid: E18E8D79-3985-40B8-A4C5-A73A21E5C527
title: Блокировать клонирование
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b33aa1c1eee693b6ed4b502aedc6da6176ece3e9
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104546703"
---
# <a name="block-cloning"></a>Блокировать клонирование

Операция *блочного клона* указывает файловой системе копировать диапазон байт файлов от имени приложения. Конечный файл может совпадать с исходным файлом или отличаться от него.

Файловая система управляет сопоставлениями [кластеров и экстентов](clusters-and-extents.md)и может выполнять копирование путем изменения номера виртуального кластера (VCN) на сопоставления номеров логических кластеров (LCN) как операции с недорогими метаданными вместо чтения и записи базовых данных файла. Это позволяет быстрее завершить копирование и выдает меньше операций ввода-вывода в базовое хранилище. Более того, несколько файлов теперь могут совместно использовать логические кластеры после клонирования блока, сохраняя емкость, не сохраняя идентичные кластеры несколько раз на диске.

Операция блочной клонирования не нарушает изоляцию, предоставленную между файлами. После завершения клонирования блока записи в исходный файл не отображаются в месте назначения или наоборот.

Клонирование блоков доступно только для типа [файловой системы ReFS](/windows/desktop/w8cookbook/resilient-file-system--refs-) , начиная с Windows Server 2016.

## <a name="block-cloning-on-refs"></a>Блокировать клонирование в ReFS

ReFS на Windows Server 2016 реализует клонирование блоков путем повторного сопоставления логических кластеров (т. е. физических расположений на томе) из исходного региона в целевой. Затем для обеспечения изоляции между этими регионами используется механизм выделения и записи. Исходный и конечный регионы могут находиться в одном или разных файлах.

Для этой реализации требуется, чтобы начальные и конечные смещения файлов были согласованы с границами кластера. В ReFS на Windows Server 2016 размер кластеров по умолчанию составляет 4 КБ, но при необходимости можно установить значение 64 КБ. Размер кластера является набором параметров на уровне всего тома во время форматирования.

## <a name="restrictions-and-remarks"></a>Ограничения и примечания

-   Исходный и конечный регионы должны начинаться и заканчиваться на границе кластера.
-   Размер клонированной области должен быть меньше 4 ГБ.
-   Регион назначения не должен превышать конец файла. Если приложению нужно расширить целевой объект с клонированными данными, сначала необходимо вызвать [**SetEndOfFile**](/windows/desktop/api/FileAPI/nf-fileapi-setendoffile).
-   Если исходная и конечная области находятся в одном файле, они не должны пересекаться. (Приложение может выполнить процедуру, разделив операцию клонирования блока на несколько клонов блоков, которые больше не перекрываются.)
-   Исходный и конечный файлы должны размещаться на одном томе ReFS.
-   Исходный и конечный файлы должны иметь одинаковые параметры [**потоков целостности**](file-attribute-constants.md) (то есть потоки целостности должны быть включены в обоих файлах или отключены в обоих файлах).
-   Если исходный файл разреженные, конечный файл также должен быть разреженным.
-   Операция клонирования блока приведет к нарушению общих уступающей блокировок (также известных как [оппортунистической блокировки уровня 2](types-of-opportunistic-locks.md)).
-   Том ReFS должен быть отформатирован в Windows Server 2016, и если используется отказоустойчивая кластеризация Windows, функциональный уровень кластеризации должен быть Windows Server 2016 или более поздней версии во время форматирования.

## <a name="example"></a>Пример

Предположим, что у нас есть два файла: X и Y, каждый из которых состоит из трех различных регионов. Каждая область файла хранится в отдельном регионе тома. Файловая система хранит набор знаний, на который ссылается каждый из этих регионов тома в одной области файла:

![перед клонированием](images/before-clone.png)

Теперь предположим, что приложение создает операцию блочного клонирования из файла X, в регионах файлов A и B, в файл Y на смещении, где в настоящее время находится. Будет получено следующее состояние файловой системы:

![После клонирования](images/after-clone.png)

Данные в регионах A и B были фактически дублируются из файла X в файл Y путем изменения сопоставлений VCN и LCN в томе ReFS. Области диска, на которых находятся резервные регионы A и B, не были прочитаны, а также не были сохранены в дисках старые регионы E и F, перезаписанные во время операции.

Файлы X и Y теперь совместно используют логические кластеры на диске. Это отражено в счетчиках ссылок, показанных в таблице. Общий доступ приводит к снижению емкости тома, чем в случае дублирования регионов A и B на базовом томе.

Теперь предположим, что приложение перезаписывает регион а в файле X. ReFS создает копию, которая теперь будет вызывать G. ReFS, затем сопоставляет G с файлом X и применяет изменения. Это сохраняет изоляцию между файлами. Счетчики ссылок обновляются соответствующим образом:

![После изменения записи](images/after-modifying-write.png)

После изменения записи, регион б по-прежнему будет совместно использоваться на диске. Обратите внимание, что если область A больше кластера, только измененный кластер будет дублирован, а оставшееся часть останется общей.

## <a name="related-topics"></a>См. также

<dl> <dt>

[**ДУБЛИРОВАНие \_ данных экстентов \_**](/windows/desktop/api/WinIoCtl/ns-winioctl-duplicate_extents_data)
</dt> <dt>

[**ФСКТЛ \_ дубликаты \_ экстентов \_ в \_ файл**](/windows/win32/api/winioctl/ni-winioctl-fsctl_duplicate_extents_to_file)
</dt> </dl>

 

 
