---
description: Описывает уровень 1, уровень 2, пакетную обработку и фильтрацию уступающей блокировки.
ms.assetid: 06136348-0c08-4e9c-9c96-fd3af33cbdc0
title: Типы уступающей блокировки
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a755a6ff766f5d19e13d4b269c1ba4bb9803e934
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103912308"
---
# <a name="types-of-opportunistic-locks"></a>Типы уступающей блокировки

Операции оппортунистической блокировки работают с четырьмя типами уступающей блокировки: уровень 1, уровень 2, пакетная обработка и фильтр. *Эксклюзивные уступающей блокировки* — это блокировки уровня 1, пакетной службы и фильтра. Если поток имеет монопольную блокировку на файл, он также не может иметь блокировку уровня 2 для одного и того же файла.

## <a name="level-1-opportunistic-locks"></a>Оппортунистической блокировки уровня 1

Оппортунистическая блокировка уровня 1 для файла позволяет клиенту заранее прочитать файл и кэшировать данные из файла в локальной среде. При условии, что у клиента есть единственный доступ к файлу, нет опасности для согласования данных в предоставлении оппортунистической блокировки уровня 1.

После открытия файла клиент может запрашивать уступающую блокировку уровня 1. Если ни один другой клиент (или другой поток в том же клиенте) не открыл файл, сервер может предоставить уступающую блокировку. Затем клиент может кэшировать чтение и запись данных из файла локально. Если файл открыт другим клиентом, сервер отказывается от уступающей блокировки, а клиент не выполняет локальное кэширование. (Сервер может отказаться от оппортунистической блокировки по другим причинам, например без поддержки уступающей блокировки).

Когда сервер открывает файл, у которого уже есть оппортунистическая блокировка уровня 1, сервер проверяет состояние общего доступа к файлу до того, как он прервет блокировку уровня 1. Если сервер нарушает блокировку после проверки, то время, которое клиент с бывшей блокировкой тратит на очистку кэша записи, — время ожидания клиента, запрашивающего файл. Этот расход означает, что при открытии файлов, открытых многими клиентами, следует избегать уступающей блокировки уровня 1.

Тем не менее, поскольку сервер проверяет состояние общего доступа до того, как оно нарушает блокировку, в случае, когда сервер отклоняет открытый запрос из-за конфликта общего доступа, сервер не нарушает блокировку. Например, если вы открыли файл, отклонили общий доступ для операций записи и получили блокировку уровня 1, сервер отклоняет запрос другого клиента на открытие файла для записи, прежде чем он даже проверит блокировку файла. В этом случае оппортунистическая блокировка не разбивается.

Пример того, как работает оппортунистическая блокировка уровня 1, см. в разделе пример оппортунистической блокировки уровня 1. Дополнительные сведения о нарушении уступающей блокировки см. в разделе [разбиение уступающей блокировки](breaking-opportunistic-locks.md).

## <a name="level-2-opportunistic-locks"></a>Оппортунистической блокировки уровня 2

Оппортунистическая блокировка уровня 2 информирует клиента о том, что существует несколько параллельных клиентов файла и что он еще не изменил его. Эта блокировка позволяет клиенту выполнять операции чтения и получать атрибуты файлов с помощью кэшированной или упреждающего чтения локальной информации, но клиент должен отправить на сервер все остальные запросы (например, операции записи). Приложение должно использовать уступающую блокировку уровня 2, если предполагается, что другие приложения могут записывать файлы в случайном режиме или в случайном порядке или последовательного чтения файла.

Оппортунистическая блокировка уровня 2 очень похожа на фильтр оппортунистической блокировки. В большинстве случаев приложение должно использовать уступающую блокировку уровня 2. Используйте блокировку фильтра только в том случае, если не нужно, чтобы операции чтения приводили к нарушениям в режиме общего доступа в промежутке времени между открытием файла приложением и получением блокировки. Дополнительные сведения см. в разделе Фильтрация уступающей блокировки и [ответ сервера на открытые запросы к заблокированным файлам](server-response-to-open-requests-on-locked-files.md).

Дополнительные сведения о нарушении уступающей блокировки см. в разделе [разбиение уступающей блокировки](breaking-opportunistic-locks.md).

## <a name="batch-opportunistic-locks"></a>Оппортунистической блокировки пакетной службы

Оппортунистическая блокировка пакетной службы управляет вакансиями и закрытием файлов. Например, при выполнении пакетного файла пакетный файл может быть открыт и закрыт один раз для каждой строки файла. Пакетная оппортунистическая блокировка открывает пакетный файл на сервере и сохраняет его открытым. По мере того, как обработчик команд открывает и закрывает пакетный файл, перенаправитель сети перехватывает команды Open и Close. Все, что получает сервер, — это команды поиска и чтения. Если клиент также выполняет чтение заранее, сервер получает определенный запрос на чтение не более одного раза.

При открытии файла, который уже содержит пакетную блокировку, сервер проверяет состояние общего доступа к файлу после нарушения блокировки. Эта проверка дает владельцу блокировки шанс завершить очистку своего кэша и закрыть этот файл. Попытка операции открытия, выполняемой во время проверки общего доступа, не приводит к сбою проверки общего доступа, если блокировка снимает блокировку.

Пример работы оппортунистической блокировки пакетной службы см. в разделе пример оппортунистической блокировки пакетной службы. Дополнительные сведения о нарушении уступающей блокировки см. в разделе [разбиение уступающей блокировки](breaking-opportunistic-locks.md).

## <a name="filter-opportunistic-locks"></a>Фильтрация уступающей блокировки

Фильтр оппортунистической блокировки блокирует файл, чтобы его нельзя было открыть для записи или удаления. Все клиенты должны иметь возможность совместно использовать файл. Блокировки фильтров позволяют приложениям выполнять неагрессивные операции фильтрации данных файлов (например, код, открывающий компилятор или программу каталогизации).

Фильтр оппортунистической блокировки отличается от уступающей блокировки уровня 2 тем, что она позволяет открытым операциям чтения выполнять операции без нарушения общего доступа в промежутке времени между открытием файла приложением и получением блокировки. Бесполезное применение фильтра — это лучшая блокировка, когда важно разрешить другим клиентам доступ на чтение. В других случаях приложение должно использовать уступающую блокировку уровня 2. Фильтр оппортунистической блокировки отличается от оппортунистической блокировки пакетной службы тем, что она не допускает, чтобы несколько закрываемых и закрывающих сторон были обработаны перенаправлением сети, как это делает Пакетная блокировка.

Приложение должно запрашивать фильтр оппортунистической блокировки файла в три этапа:

1.  Используйте функцию [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) , чтобы открыть в файле маркер с параметром *десиредакцесс* , которому присвоено значение 0, указывающее на отсутствие доступа, а параметру *двшаремоде* — флаг **\_ \_ чтения общей папки** , чтобы разрешить общий доступ для чтения. Полученный на этом этапе маркер называется маркером блокировки.
2.  Запросите блокировку этого маркера с помощью управляющего кода [**\_ \_ фильтрации \_ запросов фсктл**](/windows/win32/api/winioctl/ni-winioctl-fsctl_request_filter_oplock) .
3.  Когда блокировка будет предоставлена, используйте [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) , чтобы снова открыть файл с параметром *десиредакцесс* , равным **универсальному флагу \_ Read** . Задайте для параметра *двшаремоде* значение флаг **\_ \_ чтения общей папки** , чтобы разрешить другим пользователям читать файл, пока он открыт, с помощью флага **\_ \_ удаления общей папки** , чтобы разрешить другим пользователям пометить файл для удаления, пока он открыт, или оба. Полученный на этом этапе маркер называется маркером чтения.

Используйте маркер чтения для чтения или записи содержимого файла.

При открытии файла, у которого уже есть фильтр оппортунистической блокировки, сервер прерывает блокировку, а затем проверяет состояние общего доступа к файлу. Эта проверка дает клиенту, который удерживает бывшую уступающую блокировку, возможность отменять любые кэшированные данные и подтверждать перерыв. Операция открытия, выполняемая во время этой проверки общего доступа, не приводит к сбою проверки общего доступа, если предыдущая блокировка снимает блокировку. Файловая система находится в абэйанце операции открытия до тех пор, пока владелец блокировки не закроет как маркер чтения, так и маркер блокировки. После этого запрос на открытие другого клиента может быть продолжен.

Дополнительные сведения о нарушении уступающей блокировки см. в разделе [разбиение уступающей блокировки](breaking-opportunistic-locks.md).

 

 
