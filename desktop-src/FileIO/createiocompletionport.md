---
description: Создает порт завершения ввода-вывода и связывает его с заданным маркером файла или создает порт завершения ввода-вывода, который еще не связан с маркером файла, что позволяет выполнить сопоставление позже.
ms.assetid: 40cb47fc-7b15-47f6-bee2-2611d4686053
title: Функция CreateIoCompletionPort (Иоапи. h)
ms.topic: reference
ms.date: 05/31/2018
topic_type:
- APIRef
- kbSyntax
api_name:
- CreateIoCompletionPort
api_type:
- DllExport
api_location:
- Kernel32.dll
- API-MS-Win-Core-io-l1-1-0.dll
- KernelBase.dll
- MinKernelBase.dll
- API-MS-Win-Core-io-l1-1-1.dll
- api-ms-win-downlevel-kernel32-l1-1-0.dll
ms.openlocfilehash: b85ec931e740de192655ada091a990cd97180b6f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105683561"
---
# <a name="createiocompletionport-function"></a>Функция CreateIoCompletionPort

Создает порт завершения ввода-вывода и связывает его с заданным маркером файла или создает порт завершения ввода-вывода, который еще не связан с маркером файла, что позволяет выполнить сопоставление позже.

Связывание экземпляра открытого файла с портом завершения ввода-вывода позволяет процессу получить уведомление о завершении асинхронных операций ввода-вывода с использованием этого маркера файла.

> [!Note]
>
> Термин используемый здесь *описатель файла* означает абстракцию системы, представляющую перекрывающиеся конечные точки ввода-вывода, а не только файл на диске. В качестве дескрипторов файлов можно использовать любые системные объекты, поддерживающие перекрывающиеся операции ввода-вывода, такие как конечные точки сети, TCP-сокеты, именованные каналы и слоты почты. Дополнительные сведения см. в разделе "Примечания".

 

## <a name="syntax"></a>Синтаксис


```C++
HANDLE WINAPI CreateIoCompletionPort(
  _In_     HANDLE    FileHandle,
  _In_opt_ HANDLE    ExistingCompletionPort,
  _In_     ULONG_PTR CompletionKey,
  _In_     DWORD     NumberOfConcurrentThreads
);
```



## <a name="parameters"></a>Параметры

<dl> <dt>

*FileHandle* \[ окне\]
</dt> <dd>

Открытый маркер файла или **недопустимое \_ \_ значение Handle**.

Этот обработчик должен быть объектом, поддерживающим перекрывающиеся операции ввода-вывода.

Если указан маркер, он должен быть открыт для завершения ввода-вывода с перекрытием. Например, при использовании функции [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) для получения маркера необходимо указать флаг **\_ \_ OVERLAPPED для флага File** .

Если указано **недопустимое \_ \_ значение Handle** , функция создает порт завершения ввода-вывода, не связывая его с маркером файла. В этом случае параметр *ексистингкомплетионпорт* должен иметь **значение NULL** , а параметр *комплетионкэй* игнорируется.

</dd> <dt>

*Ексистингкомплетионпорт* \[ в необязательное\]
</dt> <dd>

Указатель на существующий порт завершения ввода-вывода или **значение NULL**.

Если этот параметр указывает существующий порт завершения ввода-вывода, функция связывает его с маркером, указанным параметром *FileHandle* . При успешном выполнении функция возвращает маркер существующего порта завершения ввода-вывода. Он не создает новый порт завершения ввода-вывода.

Если этот параметр имеет **значение NULL**, функция создает новый порт завершения ввода-вывода и, если параметр *FileHandle* является допустимым, связывает его с новым портом завершения ввода-вывода. В противном случае связь с обработчиком файлов не выполняется. При успешном выполнении функция возвращает маркер в новый порт завершения ввода-вывода.

</dd> <dt>

*Комплетионкэй* \[ окне\]
</dt> <dd>

Определяемый пользователем ключ завершения для каждого обработчика, включенный в каждый пакет завершения ввода-вывода для указанного маркера файла. Дополнительные сведения см. в разделе "Замечания".

</dd> <dt>

*Нумберофконкуррентсреадс* \[ окне\]
</dt> <dd>

Максимальное число потоков, которые операционная система может разрешить одновременно обрабатывать пакеты завершения ввода-вывода для порта завершения ввода-вывода. Этот параметр не учитывается, если параметр *ексистингкомплетионпорт* имеет **значение**, отличное от NULL.

Если этот параметр равен нулю, система разрешает столько параллельно выполняющихся потоков, сколько процессоров в системе.

</dd> </dl>

## <a name="return-value"></a>Возвращаемое значение

Если функция выполнена успешно, возвращаемое значение является маркером для порта завершения ввода-вывода:

-   Если параметр *ексистингкомплетионпорт* имеет **значение NULL**, возвращаемое значение является новым маркером.

-   Если параметр *ексистингкомплетионпорт* был допустимым маркером порта завершения ввода-вывода, возвращаемое значение имеет тот же маркер.

-   Если параметр *FileHandle* является допустимым маркером, этот маркер файла теперь связан с возвращенным портом завершения ввода-вывода.

Если функция завершается ошибкой, возвращается значение **null**. Чтобы получить расширенные сведения об ошибке, вызовите функцию [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror) .

## <a name="remarks"></a>Комментарии

Система ввода-вывода может дать инструкции отправить пакеты уведомлений о завершении ввода-вывода в порты завершения ввода-вывода, где они помещаются в очередь. Функция **CreateIoCompletionPort** предоставляет эту функцию.

Порт завершения ввода-вывода и его обработчик связаны с процессом, который его создал, и не может совместно работать между процессами. Однако один и тот же обработчик может совместно работать между потоками в одном процессе.

**CreateIoCompletionPort** можно использовать в трех различных режимах:

-   Создайте только порт завершения ввода-вывода, не связав его с маркером файла.
-   Свяжите существующий порт завершения ввода-вывода с маркером файла.
-   Создание и сопоставление в одном вызове.

Чтобы создать порт завершения ввода-вывода, не связывая его, присвойте параметру *FileHandle* **неверное \_ \_ значение Handle**, параметр *ексистингкомплетионпорт* — **null**, а параметр *комплетионкэй* — нуль (который в данном случае игнорируется). Задайте для параметра *нумберофконкуррентсреадс* требуемое значение параллелизма для нового порта завершения ввода-вывода или нуль для значения по умолчанию (число процессоров в системе).

В качестве маркера, переданного в параметре *FileHandle* , можно использовать любой обработчик, поддерживающий перекрывающиеся операции ввода-вывода. Чаще всего это маркер, Открытый функцией [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) с помощью флага **File \_ Flag \_ OVERLAPPED** (например, файлы, слоты почты и каналы). Объекты, созданные другими функциями, такими как [**Socket**](/windows/desktop/api/winsock2/nf-winsock2-socket) , также могут быть связаны с портом завершения ввода-вывода. Пример использования сокетов см. в разделе [**акцептекс**](/windows/desktop/api/mswsock/nf-mswsock-acceptex). Маркер может быть связан только с одним портом завершения ввода-вывода, и после создания связи этот обработчик остается связанным с этим портом завершения ввода-вывода, пока он не будет закрыт.

Дополнительные сведения о теории портов завершения ввода-вывода, использовании и связанных функциях см. в разделе [порты завершения ввода-вывода](i-o-completion-ports.md).

Несколько дескрипторов файлов можно связать с одним портом завершения ввода-вывода, вызвав **CreateIoCompletionPort** несколько раз с одним и тем же дескриптором порта завершения ввода-вывода в параметре *ексистингкомплетионпорт* и при каждом другом дескрипторе файла в параметре *FileHandle* .

Используйте параметр *комплетионкэй* , чтобы помочь приложению определить, какие операции ввода-вывода завершены. Это значение не используется **CreateIoCompletionPort** для функционального управления; Вместо этого он прикрепляется к файлу, указанному в параметре *FileHandle* во время связи с портом завершения ввода-вывода. Этот ключ завершения должен быть уникальным для каждого файла, и он прилагается к обработчику файлов во время внутреннего процесса очереди завершения. Он возвращается в вызове функции [**жеткуеуедкомплетионстатус**](/windows/win32/api/ioapiset/nf-ioapiset-getqueuedcompletionstatus) при получении пакета завершения. Параметр *комплетионкэй* также используется функцией [**PostQueuedCompletionStatus**](postqueuedcompletionstatus.md) для постановки в очередь собственных пакетов завершения специального назначения.

После того как экземпляр открытого маркера связан с портом завершения ввода-вывода, он не может использоваться в функции [**реадфиликс**](/windows/desktop/api/FileAPI/nf-fileapi-readfileex) или [**вритефиликс**](/windows/desktop/api/FileAPI/nf-fileapi-writefileex) , поскольку эти функции имеют собственные механизмы асинхронного ввода-вывода.

Не рекомендуется совместно использовать один и тот же маркер файла, связанный с портом завершения ввода-вывода, с помощью наследования или вызова функции [**дупликатехандле**](/windows/desktop/api/handleapi/nf-handleapi-duplicatehandle) . Операции, выполняемые с такими повторяющимися дескрипторами, формируют уведомления о завершении. Рекомендуется соблюдать осторожность.

Обработчик порта завершения ввода-вывода и все файлы, связанные с этим конкретным портом завершения ввода-вывода, называются *ссылками на порт завершения ввода*-вывода. Порт завершения ввода-вывода освобождается при отсутствии ссылок на него. Поэтому все эти дескрипторы должны быть должным образом закрыты, чтобы освободить порт завершения ввода-вывода и связанные с ним системные ресурсы. После выполнения этих условий закройте обработчик порта завершения ввода-вывода, вызвав функцию [**CloseHandle**](/windows/desktop/api/handleapi/nf-handleapi-closehandle) .

В Windows 8 и Windows Server 2012 эта функция поддерживается следующими технологиями.



| Технология                                           | Поддерживается      |
|------------------------------------------------------|----------------|
| Протокол SMB 3,0<br/>   | Да<br/> |
| Прозрачная отработка отказа SMB 3,0 (ОТРАБОТКА отказа)<br/>        | Да<br/> |
| SMB 3,0 с масштабируемыми файловыми ресурсами (SO)<br/>   | Да<br/> |
| Общий том кластераная файловая система (CsvFS)<br/> | Да<br/> |
| Восстанавливаемая файловая система (ReFS)<br/>              | Да<br/> |



 

## <a name="requirements"></a>Требования



| Требование | Значение |
|-------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Минимальная версия клиента<br/> | \[Приложения UWP для классических приложений Windows XP \|\]<br/>                                                                                                                                                                                                                                                       |
| Минимальная версия сервера<br/> | \[Приложения UWP для классических приложений Windows Server 2003 \|\]<br/>                                                                                                                                                                                                                                              |
| Header<br/>                   | <dl> <dt>Иоапи. h (включение Windows. h); </dt> <dt>Винбасе. h в Windows server 2008 R2, Windows 7, Windows server 2008, Windows Vista, Windows server 2003 и Windows XP (включая Windows. h)</dt> </dl> |
| Библиотека<br/>                  | <dl> <dt>Kernel32.lib</dt> </dl>                                                                                                                                                                                                                  |
| DLL<br/>                      | <dl> <dt>Kernel32.dll</dt> </dl>                                                                                                                                                                                                                  |



## <a name="see-also"></a>См. также раздел

<dl> <dt>

**Обзорные разделы**
</dt> <dt>

[Функции управления файлами](file-management-functions.md)
</dt> <dt>

[Порты завершения ввода-вывода](i-o-completion-ports.md)
</dt> <dt>

[Использование заголовков Windows](/windows/desktop/WinProg/using-the-windows-headers)
</dt> <dt>

[Сокеты Windows 2](/windows/desktop/WinSock/windows-sockets-start-page-2)
</dt> <dt>

**Функции**
</dt> <dt>

[**акцептекс**](/windows/desktop/api/mswsock/nf-mswsock-acceptex)
</dt> <dt>

[**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea)
</dt> <dt>

[**дупликатехандле**](/windows/desktop/api/handleapi/nf-handleapi-duplicatehandle)
</dt> <dt>

[**жеткуеуедкомплетионстатус**](/windows/win32/api/ioapiset/nf-ioapiset-getqueuedcompletionstatus)
</dt> <dt>

[**жеткуеуедкомплетионстатусекс**](getqueuedcompletionstatusex-func.md)
</dt> <dt>

[**PostQueuedCompletionStatus**](postqueuedcompletionstatus.md)
</dt> <dt>

[**реадфиликс**](/windows/desktop/api/FileAPI/nf-fileapi-readfileex)
</dt> <dt>

[**вритефиликс**](/windows/desktop/api/FileAPI/nf-fileapi-writefileex)
</dt> </dl>

 

