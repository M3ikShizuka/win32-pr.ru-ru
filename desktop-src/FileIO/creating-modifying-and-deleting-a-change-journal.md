---
description: Администраторы могут создавать, удалять и повторно создавать журналы изменений.
ms.assetid: 26cbacc2-d26b-434b-91b5-31aedc96da13
title: Создание, изменение и удаление журнала изменений
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e3d4cf9a597baa14fc929028eab262479da30797a2e423b779083f028927ce50
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118150870"
---
# <a name="creating-modifying-and-deleting-a-change-journal"></a>Создание, изменение и удаление журнала изменений

Администраторы могут создавать, удалять и повторно создавать журналы изменений. Администратор должен удалить журнал, если текущее значение порядкового номера обновления (USN) приближается к максимально возможному значению USN, как указано элементом **максусн** структуры [**\_ \_ данных журнала USN**](/windows/desktop/api/WinIoCtl/ns-winioctl-usn_journal_data_v0) . Администратор может также удалить и повторно создать журнал изменений, чтобы освободить место на диске. Для выполнения этой операции и всех остальных непрограммных операций с журналом изменений требуются права системного администратора. То есть необходимо быть членом группы администраторов.

Чтобы создать или изменить журнал изменений на указанном томе программным путем, используйте управляющий код [**фсктл \_ Create \_ USN \_**](/windows/win32/api/winioctl/ni-winioctl-fsctl_create_usn_journal) .

При создании нового или изменении существующего журнала изменений файловая система NTFS устанавливает сведения для этого журнала изменений из сведений в структуре [**\_ \_ \_ данных журнала USN**](/windows/desktop/api/WinIoCtl/ns-winioctl-create_usn_journal_data) , которая [**фсктл \_ создать \_ \_ журнал USN**](/windows/win32/api/winioctl/ni-winioctl-fsctl_create_usn_journal) . **Создание \_ \_ \_ Данные журнала USN** имеют элементы **MaximumSize** и **аллокатионделта**.

**MaximumSize** — это максимальный целевой размер журнала изменений в байтах. Журнал изменений может увеличиваться больше этого значения, но в файловой системе NTFS контрольные точки файловой системы NTFS проверяют журнал и обрезают его, если его размер превышает значение **MaximumSize** плюс значение **аллокатионделта**. (В контрольных точках файловой системы NTFS операционная система записывает записи в файл журнала файловой системы NTFS, который позволяет файловой системе NTFS определить, какая обработка необходима для восстановления после сбоя.)

**Аллокатионделта** — число байтов, добавленных к концу и удаляемых из начала журнала изменений при каждом выделении или освобождении памяти. Иными словами, выделение и освобождение выполняются в единицах этого размера. Целое число, кратное размеру кластера, является разумным значением для этого члена.

Если администратор изменяет существующий журнал изменений таким образом, чтобы он имел более крупное значение **MaximumSize** , например если слишком часто выполняется повторное индексирование тома, журнал изменений просто получает новые записи, пока не превысит новый максимальный размер.

Чтобы удалить журнал изменений, используйте управляющий [**код \_ удаления \_ \_ журнала USN фсктл**](/windows/win32/api/winioctl/ni-winioctl-fsctl_delete_usn_journal) . При использовании этой операции она проходит по всем файлам на томе и сбрасывает USN для каждого файла в ноль. Затем операция удаляет существующий журнал изменений. Эта операция сохраняется по перезапуску системы до ее завершения. Любая попытка чтения, создания или изменения журнала изменений во время этого процесса завершается ошибкой с кодом ошибки **« \_ \_ Удаление журнала \_ \_ ошибок**».

Вы также можете использовать управляющий код [**фсктл \_ DELETE \_ USN \_**](/windows/win32/api/winioctl/ni-winioctl-fsctl_delete_usn_journal) , чтобы определить, выполняется ли удаление, запущенное другим процессом. Например, приложение, когда оно запускается, может определить, выполняется ли удаление. Поскольку операции удаления журналов сохраняются при перезапуске системы, службы и приложения, запущенные при перезагрузке системы, должны проверить текущее удаление.

Журналы изменений не обязательно создаются при запуске. Чтобы создать журнал изменений, администратор может сделать это явным образом или запустить другую службу, для которой требуется журнал изменений.

 

 
