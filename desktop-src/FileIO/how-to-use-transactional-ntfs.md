---
description: Управление дескрипторами файлов транзакций в транзакционной NTFS.
ms.assetid: 29879a3f-14b4-462c-a001-46c3c3eb74d1
title: Как использовать транзакционную NTFS
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 43681f0d5b27f0db03d8b6c44564b792fce4b467
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105684369"
---
# <a name="how-to-use-transactional-ntfs"></a>Как использовать транзакционную NTFS

## <a name="transacted-file-handles"></a>Транзакционные дескрипторы файлов

Транзакционная NTFS (TxF) привязывает файловый обработчик к транзакции. Для операций, которые работают с маркером (например, функции [**ReadFile**](/windows/desktop/api/FileAPI/nf-fileapi-readfile) и [**WriteFile**](/windows/desktop/api/FileAPI/nf-fileapi-writefile) ), фактический вызов функции API не изменяется. Для операций с файлами, которые принимают имя, для этих операций существуют явные транзакционные функции. Например, вместо вызова функции [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea)вызовите [**креатефилетрансактед**](/windows/desktop/api/WinBase/nf-winbase-createfiletransacteda). При этом создается файловый обработчик транзакций, который затем может использоваться для всех файловых операций, требующих маркера. Все последующие операции, использующие этот обработчик, являются транзакционными операциями.

## <a name="basic-txf-usage"></a>Основные сведения об использовании TxF

Приведенная ниже последовательность действий представляет собой наиболее простой способ использования TxF. Более сложные сценарии также поддерживаются по усмотрению конструктора приложений.

1.  Создайте транзакцию путем вызова функции KTM [**CreateTransaction**](/windows/desktop/api/ktmw32/nf-ktmw32-createtransaction) или с помощью интерфейса **IKernelTransaction** [координатор распределенных транзакций](/previous-versions/windows/desktop/mscs/distributed-transaction-coordinator) (DTC).
2.  Получение обрабатываемых файлов транзакций путем вызова [**креатефилетрансактед**](/windows/desktop/api/WinBase/nf-winbase-createfiletransacteda).
3.  При необходимости измените файлы с помощью транзакционных файлов (file handles).
4.  Закройте все дескрипторы файлов транзакций, связанные с транзакцией, созданной на шаге 1.
5.  Зафиксируйте или прервать транзакцию, вызвав соответствующую функцию KTM или DTC.

## <a name="key-points-of-the-txf-programming-model"></a>Основные моменты модели программирования TxF

Модель программирования TxF имеет следующие ключевые моменты, которые необходимо учитывать при разработке приложения TxF:

-   Настоятельно рекомендуется, чтобы приложение закрывало все дескрипторы файлов транзакций перед фиксацией или откатом транзакции. Система делает недействительными все обработанные дескрипторы транзакций при завершении транзакции. Любая операция, кроме Close, выполненная для транзакционного обработчика после завершения транзакции, возвращает следующую ошибку: **\_ \_ \_ \_ недопустимый обработчик ошибок**.
-   Файл просматривается как единица хранения. Поддерживаются частичные обновления и полная перезапись файлов. Несколько транзакций не могут одновременно изменять один и тот же файл.
-   Отображаемые в памяти операции ввода-вывода прозрачны и соответствуют обычным файловым операциям ввода-вывода. Приложение должно очистить и закрыть открытый раздел перед фиксацией транзакции. Невыполнение этого действия может привести к частичному изменению сопоставленного файла в рамках транзакции. Если это не сделано, происходит сбой отката.

## <a name="common-programming-errors"></a>Распространенные ошибки программирования

При разработке транзакционных приложений могут возникать следующие распространенные ошибки.

-   Использование маркера файла после завершения транзакции.
-   Не удается закрыть дескрипторы для удаленных файлов и каталогов перед фиксацией транзакции, что предотвратит выполнение операций удаления. Это событие должно произойти перед выполнением фиксации для того, чтобы операция удаления считалась частью транзакции. Это обусловлено тем, что система фактически не удаляет файл до тех пор, пока не будет закрыт последний его обработчик, даже если операция не является транзакционной, как часть подсистемы ввода-вывода Windows.
-   Не удается выполнить откат транзакций, инициированных системой, что может произойти в любое время; Например, транзакция откатывается, если ресурсы системы исчерпаны.

 

 
