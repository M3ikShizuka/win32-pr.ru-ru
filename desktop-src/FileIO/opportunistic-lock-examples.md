---
description: Схемы представлений сетевого трафика для уступающей блокировки уровня 1, оппортунистической блокировки пакетной службы и фильтра оппортунистической блокировки.
ms.assetid: 78830113-b18e-40c7-8ec4-8896dbc58030
title: Примеры оппортунистической блокировки
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ae8b8a0c5b04897ddc2fc8f2e3bdec20f2fdb02d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104545711"
---
# <a name="opportunistic-lock-examples"></a>Примеры оппортунистической блокировки

В следующих примерах показано перемещение данных и сообщений SMB при внесении и нарушении уступающей блокировки. Обратите внимание, что клиенты могут кэшировать данные атрибутов файлов, а также данные файлов.

Также обратите внимание, что эти примеры основаны на ситуациях, когда клиентские приложения запрашивают уступающей блокировку с удаленных серверов. Эти процессы автоматически инициируются сетевым перенаправительм и удаленным сервером — прямое участие в клиентских приложениях или приложениях отсутствует. Процессы, описанные в этих примерах, можно обобщить в ситуации, когда локальные клиентские приложения напрямую запрашивают уступающей блокировку из локальной файловой системы, за исключением того, что обмен данными по сети не выполняется.

## <a name="level-1-opportunistic-lock"></a>Оппортунистическая блокировка уровня 1

На следующей схеме показано представление сетевого трафика для оппортунистической блокировки уровня 1 на файл. Стрелки указывают направление перемещения данных, если таковые имеются.



| Событие | Клиент X                                          | Сервер                                   | Клиент Y                                          |
|-------|---------------------------------------------------|------------------------------------------|---------------------------------------------------|
| 1     | Открывает файл, запрашивает блокировку уровня 1 = =>          |                                          |                                                   |
| 2     |                                                   | <= = предоставление оппортунистической блокировки уровня 1 |                                                   |
| 3     | Выполняет операции чтения, записи и других операций = => |                                          |                                                   |
| 4     |                                                   |                                          | <= = запросы на открытие файла                      |
| 5     |                                                   | <= = разрывает уступающую блокировку         |                                                   |
| 6     | Отменяет данные упреждающего чтения                          |                                          |                                                   |
| 7     | Записывает данные = =>                                |                                          |                                                   |
| 8     | Отправляет сообщение "Close" или "Done" = =>            |                                          |                                                   |
| 9     |                                                   | Открытые операции = =>              |                                                   |
| 10    | Выполняет операции чтения, записи и других операций = => |                                          | <= = выполняет операции чтения, записи и других операций |



 

В событии 1 клиент X открывает файл и в ходе операции открытия запрашивает оппортунистической блокировки уровня 1 для файла. В событии 2 сервер предоставляет блокировку уровня 1, так как никакой другой клиент не открывает файл. Клиент переходит к файлу обычным способом в событии 3.

В событии 4 Клиент Y пытается открыть файл и запрашивает уступающую блокировку. Сервер видит, что этот файл открыт на клиенте X. Сервер игнорирует запрос Y, в то время как клиент X очищает все данные записи и отменяет его кэш чтения для файла.

Сервер принудительно очищает X, отправляя в X сообщение SMB, разбивая оппортунистическая блокировку, событие 5. Клиент X "без уведомления" отменяет все данные, которые были прочитаны. Иными словами, этот процесс не создает сетевого трафика. В событии 7 клиент X записывает все кэшированные данные записи на сервер. Когда клиент X выполняет запись кэшированных данных на сервер, клиент X отправляет на сервер сообщение «Close» или «done», событие 8.

После того как сервер получил уведомления о том, что клиент X запустил свой кэш записи на сервере или закрыл файл, сервер может открыть файл для клиента Y в событии 9. Поскольку сервер теперь имеет два клиента с одним и тем же файлом, он предоставляет оппортунистическая блокировку ни для одного из них. Оба клиента продолжают считывать данные из файла и один или ни одной записи в файл.

## <a name="batch-opportunistic-lock"></a>Оппортунистическая блокировка пакетной службы

На следующей схеме показано представление сетевого трафика оппортунистической блокировки пакетной службы. Стрелки указывают направление перемещения данных, если таковые имеются.



| Событие | Клиент X                               | Сервер                                 | Клиент Y                                          |
|-------|----------------------------------------|----------------------------------------|---------------------------------------------------|
| 1     | Открывает файл, запрашивает блокировку пакета = => |                                        |                                                   |
| 2     |                                        | <= = предоставляет уступающую пакетную блокировку |                                                   |
| 3     | Чтение файла = =>                      |                                        |                                                   |
| 4     |                                        | <= = отправка данных                      |                                                   |
| 5     | Закрывает файл                            |                                        |                                                   |
| 6     | Открытие файла                             |                                        |                                                   |
| 7     | Выполняет поиск данных                      |                                        |                                                   |
| 8     | Считывает данные = =>                      |                                        |                                                   |
| 9     |                                        | <= = отправка данных                      |                                                   |
| 10    | Закрывает файл                            |                                        |                                                   |
| 11    |                                        |                                        | <= = открывает файл                                 |
| 12    |                                        | <= = разрывает уступающую блокировку       |                                                   |
| 13    | Закрывает файл = =>                     |                                        |                                                   |
| 14    |                                        | Открытые операции = =>            |                                                   |
| 15    |                                        |                                        | <= = выполняет операции чтения, записи и других операций |



 

В оппортунистической блокировке пакетной службы клиент X открывает файл, событие 1, а сервер предоставляет пакетную блокировку Client X в событии 2. Клиент X пытается считать данные, событие 3, на которое сервер отвечает на данные, событие 4.

В событии 5 показана оппортунистическая блокировка пакета на работе. Приложение на клиенте X закрывает файл. Однако перенаправитель сети отфильтровывает операцию закрытия и не передает сообщение закрытия, тем самым выполняя «Silent» закрытие. Это может сделать сетевой перенаправитель, так как клиент X имеет единственного владельца файла. Позже, в событии 6, приложение повторно откроет файл. Опять же, потоки данных в сети отсутствуют. С точки зрения сервера этот клиент открыл файл с момента создания события 2.

События 7, 8 и 9 показывают обычное направление сетевого трафика. В событии 10 происходит еще одно автоматическое закрытие.

В событии 11 клиент Y пытается открыть файл. Сервер имеет представление о том, что клиент X открыт, несмотря на то, что приложение на клиенте X его закрыло. Таким образом, сервер отправляет сообщение, разбивая оппортунистической блокировки на клиент X. Клиент X теперь отправляет сообщение о закрытии по сети, событие 13. Событие 14 следует за тем, как сервер открывает файл для клиента Y. Приложение на клиенте X закрыло файл, поэтому он больше не передает на сервер или с сервера для этого файла. Клиент Y начинает передачу данных обычным образом в событии 15.

Между временем, когда клиент X получает блокировку файла в событии 2 и Последнее закрытие в событии 13, все данные файлов, кэшированные клиентом, являются допустимыми, несмотря на операции открытия и закрытия приложения. Однако после разрыва оппортунистической блокировки кэшированные данные не могут считаться допустимыми.

## <a name="filter-opportunistic-lock"></a>Фильтрация уступающей блокировки

На следующей схеме показано представление сетевого трафика для фильтра оппортунистической блокировки. Стрелки указывают направление перемещения данных, если таковые имеются.



| Событие | Клиент X                                | Сервер                   | Клиент Y                    |
|-------|-----------------------------------------|--------------------------|-----------------------------|
| 1     | Открывает файл без прав доступа = => |                          |                             |
| 2     |                                         | <= = открывает файл    |                             |
| 3     | Запросов блокировки фильтра = =>              |                          |                             |
| 4     |                                         | <= = предоставление блокировки       |                             |
| 5     | Открывает файл для чтения = =>           |                          |                             |
| 6     |                                         | <= = повторно открывает файл  |                             |
| 7     | Считывает данные с помощью маркера чтения = => |                          |                             |
| 8     |                                         | <= = отправка данных        |                             |
| 9     |                                         | <= = отправка данных        |                             |
| 10    |                                         | <= = отправка данных        |                             |
| 11    |                                         |                          | <= = открывает файл       |
| 12    |                                         | Открывает файл = =>    |                             |
| 13    |                                         |                          | <= = блокировка фильтра запросов |
| 14    |                                         | Запрещает блокировку фильтра = => |                             |
| 15    |                                         |                          | <= = чтение данных           |
| 16    |                                         | Отправляет данные = =>        |                             |
| 17    | Чтение (кэшированных) данных                     |                          |                             |
| 18    | Закрывает файл = =>                      |                          |                             |
| 19    |                                         |                          | <= = закрывает файл          |



 

В случае оппортунистической блокировки «фильтр» клиент X открывает файл, событие 1, а сервер отвечает на событие 2. Затем клиент запрашивает фильтр оппортунистической блокировки в событии 3, за которым следует сервер, предоставляющий уступающую блокировку в событии 4. Затем клиент X снова открывает файл для чтения в событии 5, в которое сервер отвечает на событие 6. Затем клиент пытается считать данные, на которые сервер отвечает на данные, событие 8.

В событии 9 показан фильтр "оппортунистическая блокировка" на работе. Сервер считывает данные перед клиентом и отправляет их по сети, даже если клиент не запрашивал его. Клиент кэширует данные. В событии 10 сервер также ожидает будущий запрос данных и отправляет клиенту другую часть файла для кэширования.

В событии 11 и 12 другой клиент, Y, открывает файл. Клиент Y также запрашивает уступающую блокировку фильтра. В событии 14 сервер отклоняет его. В событии 15 клиент Y запрашивает данные, которые сервер отправляет в событии 16. Ни один из этих элементов не влияет на клиент X. В любой момент времени другой клиент может открыть этот файл для доступа на чтение. Никакой другой клиент не влияет на блокировку фильтра клиента X.

В событии 17 показана пересчитанные данные клиентом X. Однако, поскольку сервер уже отправил данные и кэширует его, трафик не пересекает сеть.

В этом примере клиент X никогда не пытается прочитать все данные в файле, поэтому упреждающее чтение, обозначенное событиями 9 и 10, считается незанятым. то есть данные никогда не используются. Это приемлемая утрата, так как упреждающее чтение ускоряют приложение.

В событии 18 клиент X закрывает файл. Перенаправитель сети клиента отменяет кэшированные данные. Сервер закрывает файл.

 

 



