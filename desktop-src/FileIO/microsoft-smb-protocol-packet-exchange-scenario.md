---
description: Пример обмена пакетами протокола SMB (Майкрософт) между клиентом и сервером.
ms.assetid: f831d0de-0e38-4141-811c-892a1b5c4037
title: Сценарий обмена пакетами протокола SMB (Майкрософт)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e8a03e2f75b00aa93e629b3e698631c5efde4694
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104343192"
---
# <a name="microsoft-smb-protocol-packet-exchange-scenario"></a>Сценарий обмена пакетами протокола SMB (Майкрософт)

В этом разделе приводится пример обмена пакетами протокола SMB (Майкрософт) между клиентом и сервером. Следующие шаги являются обзором процесса.

1.  Клиент и сервер устанавливают сеанс NetBIOS.
2.  Клиент и сервер согласовывают диалект протокола SMB (Майкрософт).
3.  Клиент входит в систему на сервере.
4.  Клиент подключается к общей папке на сервере.
5.  Клиент открывает файл в общей папке.
6.  Клиент считывает данные из файла.

Во-первых, клиент может установить полное дуплексное TCP-соединение с сервером. Затем клиент создает и отправляет пакет запроса сеанса NetBIOS через TCP-соединение. Если пакет был отформатирован правильно, сервер возвращает пакет, содержащий сообщение с подтверждением того, что сеанс был установлен. После этого клиент отправляет на сервер первые пакеты протокола SMB Microsoft.



|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Пакет 1: \_ \_ согласование SMB com**<br/> **Направление:** С клиента на сервер<br/> **Описание:** Клиент запрашивает, что сервер согласовывает диалект протокола SMB Microsoft. В пакет входит список строк, определяющих диалекты, с которыми может работать клиент.<br/>                                                                                                                                                                                                                                                                                                                                   |
| **Пакет 2. \_ \_ согласование SMB com**<br/> **Направление:** От сервера к клиенту<br/> **Описание:** Сервер отвечает на запрос клиента, чтобы определить диалект протокола Microsoft SMB, который будет использоваться в сеансе. Возвращаемый пакет также включает 8-байтовую случайную строку, которая будет использоваться на следующем шаге для проверки подлинности клиента в процессе входа в систему.<br/>                                                                                                                                                                                                                                   |
| **Пакет 3. \_ \_ \_ андкс установки сеанса com \_ SMB**<br/> **Направление:** С клиента на сервер<br/> **Описание:** Этот пакет содержит сведения о возможностях клиента, поэтому этот пакет необходимо отправить, даже если сервер реализовал только безопасность на уровне общего доступа.<br/> **Пакет 3. \_ \_ \_ андкс установки сеанса com \_ SMB**<br/> **Направление:** От сервера к клиенту<br/> **Описание:** Если запрос или ответ принимается сервером, в пакет, возвращаемый клиенту, включается действительный идентификатор UID. Если оно не принято, сервер возвратит код ошибки в этом пакете и отклонит доступ.<br/> |
| **Пакет 4. \_ \_ \_ Подключение андкс к ДЕРЕВу com SMB \_**<br/> **Направление:** С клиента на сервер<br/> **Описание:** Клиент запрашивает доступ к общей папке. Пакет содержит полностью указанный путь к общей папке в формате UNC.<br/>                                                                                                                                                                                                                                                                                                                                                                                             |
| **Пакет 5. \_ \_ \_ Подключение андкс к ДЕРЕВу com SMB \_**<br/> **Направление:** От сервера к клиенту<br/> **Описание:** Если предоставлен доступ к общей папке, сервер возвращает 16-разрядный идентификатор дерева (TID), соответствующий общему ресурсу в этом пакете. Если общая папка не существует или у пользователя недостаточно учетных данных для доступа к общей папке, сервер возвратит код ошибки в этом пакете и отклонит доступ к общей папке.<br/>                                                                                                                                                                                                 |
| **Пакет 6. SMB \_ COM \_ Open \_ андкс**<br/> **Направление:** С клиента на сервер<br/> **Описание:** Клиент запрашивает у сервера открытие файла в общей папке от имени клиента. Этот пакет содержит имя открываемого файла.<br/>                                                                                                                                                                                                                                                                                                                                                                   |
| **Пакет 7: SMB \_ COM \_ Open \_ андкс**<br/> **Направление:** От сервера к клиенту<br/> **Описание:** Если доступ к файлу предоставлен, сервер возвращает идентификатор запрошенного файла. Если файл не существует или у пользователя недостаточно учетных данных для доступа к файлу, сервер возвратит код ошибки в этом пакете и отклонит доступ к файлу.<br/>                                                                                                                                                                                                                                                  |
| **Пакет 8: SMB \_ COM \_ Read \_ андкс**<br/> **Направление:** С клиента на сервер<br/> **Описание:** Клиент запрашивает у сервера чтение данных из открытого файла от имени клиента и возвращает эти данные клиенту. Идентификатор файла, полученный клиентом при открытии файла, включается в этот пакет, чтобы определить открытый файл, из которого сервер должен считывать данные.<br/>                                                                                                                                                                                                                   |
| **Пакет 9: SMB \_ COM \_ Read \_ андкс**<br/> **Направление:** От сервера к клиенту<br/> **Описание:** Сервер возвращает запрошенные данные файла в этом пакете. Здесь возникает ошибка, которая вряд ли предоставила доступ к серверу, общей папке и файлу. Однако это может произойти в некоторых ситуациях. Например, если доступ к общей папке изменяется с момента открытия файла и с момента его считывания.<br/>                                                                                                                                                                                                      |



 

> [!Note]  
> Если вы реализуете CIFS, который не поддерживает уведомления об изменениях, Windows не может поддерживать необработанный обработчик в файловой системе, а подключение SMB может исчезнуть без уведомления.

 

 

 




