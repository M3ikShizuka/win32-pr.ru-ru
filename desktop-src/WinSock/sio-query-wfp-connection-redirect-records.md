---
description: Управляющий код получает запись перенаправления для принятого подключения TCP/IP для использования службой перенаправления платформы фильтрации Windows.
ms.assetid: E0D7CC1A-8F93-45A0-9543-3F2ACAF352F5
title: Код элемента управления SIO_QUERY_WFP_CONNECTION_REDIRECT_RECORDS
ms.topic: reference
ms.date: 05/20/2019
req.target-min-winverclnt: Windows Vista [desktop apps only]
req.target-min-winversvr: Windows Server 2008 [desktop apps only]
api_location:
- mstcpip.h
ms.openlocfilehash: 2389914d29bd403a33e23065c29f549a01adbb67
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105719457"
---
# <a name="sio_query_wfp_connection_redirect_records-control-code"></a>Код элемента управления SIO_QUERY_WFP_CONNECTION_REDIRECT_RECORDS

## <a name="description"></a>Описание

Управляющий **запрос SIO для \_ запроса на \_ \_ \_ Перенаправление подключения \_ WFP** получает запись перенаправления для принятого подключения TCP/IP для использования службой перенаправления платформы фильтрации Windows (WFP).

Чтобы выполнить эту операцию, вызовите функцию [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **вспиоктл** со следующими параметрами.

```cpp
int WSAIoctl(
  (socket) s,             // descriptor identifying a socket
  SIO_QUERY_WFP_CONNECTION_REDIRECT_RECORDS, // dwIoControlCode
  NULL,                         // lpvInBuffer
  0,                            // cbInBuffer
  (LPVOID) lpvOutBuffer,         // output buffer
  (DWORD) cbOutBuffer,       // size of output buffer
  (LPDWORD) lpcbBytesReturned,    // number of bytes returned
  (LPWSAOVERLAPPED) lpOverlapped,   // OVERLAPPED structure
  (LPWSAOVERLAPPED_COMPLETION_ROUTINE) lpCompletionRoutine,  // completion routine
);
```

```cpp
int WSAIoctl(
  (socket) s,             // descriptor identifying a socket
  SIO_QUERY_WFP_CONNECTION_REDIRECT_RECORDS, // dwIoControlCode
  NULL,                         // lpvInBuffer
  0,                            // cbInBuffer
  (LPVOID) lpvOutBuffer,         // output buffer
  (DWORD) cbOutBuffer,       // size of output buffer
  (LPDWORD) lpcbBytesReturned,    // number of bytes returned
  (LPWSAOVERLAPPED) lpOverlapped,   // OVERLAPPED structure
  (LPWSAOVERLAPPED_COMPLETION_ROUTINE) lpCompletionRoutine,  // completion routine
);
```

## <a name="parameters"></a>Параметры

### <a name="s"></a>s

Дескриптор, идентифицирующий сокет.

### <a name="dwiocontrolcode"></a>двиоконтролкоде

Управляющий код для операции.
Используйте **SIO \_ для \_ запроса \_ \_ \_ записей перенаправления подключения WFP** для этой операции.

### <a name="lpvinbuffer"></a>лпвинбуффер

Указатель на входной буфер.
Этот параметр не используется для этой операции.

### <a name="cbinbuffer"></a>кбинбуффер

Размер входного буфера в байтах.
Этот параметр не используется для этой операции.

### <a name="lpvoutbuffer"></a>лпваутбуффер

Указатель на выходной буфер.
Этот параметр должен указывать на тип данных **ulong** , если параметры *лповерлаппед* и *лпкомплетионраутине* имеют **значение NULL**.

### <a name="cboutbuffer"></a>кбаутбуффер

Размер выходного буфера в байтах.
Этот параметр должен быть не меньше размера типа данных **ulong** .

### <a name="lpcbbytesreturned"></a>лпкббитесретурнед

Указатель на переменную, которая получает размер данных, хранящихся в выходном буфере, в байтах.

Если выходной буфер слишком мал, вызов завершается ошибкой, [**всажетластеррор**](/windows/desktop/api/winsock/nf-winsock-wsagetlasterror) возвращает [**всаеинвал**](windows-sockets-error-codes-2.md), а параметр *лпкббитесретурнед* указывает на значение **DWORD** , равное нулю.

Если *лповерлаппед* имеет значение **null**, то значение **DWORD** , на которое указывает параметр *лпкббитесретурнед* , возвращаемое при успешном вызове, не может быть нулевым.

Если параметр *лповерлаппед* имеет значение, отличное от **null** , для перекрывающихся сокетов, то операции, которые не могут быть выполнены немедленно, будут инициированы, а завершение будет указано позже.
Значение **DWORD** , на которое указывает возвращаемый параметр *лпкббитесретурнед* , может быть равно нулю, так как размер хранимых данных не может быть определен до завершения операции перекрытия.
Окончательное состояние завершения можно получить, если при выполнении операции будет получен сигнал о соответствующем методе завершения.

### <a name="lpvoverlapped"></a>лпвоверлаппед

Указатель на структуру [**всаоверлаппед**](/windows/desktop/api/winsock2/ns-winsock2-wsaoverlapped) .

Если *сокеты были созданы* без атрибута OVERLAPPED, параметр *лповерлаппед* игнорируется.

Если *конструктор* был открыт с атрибутом OVERLAPPED и параметр *Лповерлаппед* не равен **null**, операция выполняется как перекрытый (асинхронная) операция.
В этом случае параметр *лповерлаппед* должен указывать на допустимую структуру [**всаоверлаппед**](/windows/desktop/api/winsock2/ns-winsock2-wsaoverlapped) .

Для операций с перекрытием функция [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **вспиоктл** возвращает значение немедленно, и соответствующий метод завершения получает сигнал о завершении операции.
В противном случае функция не возвращает значение до тех пор, пока операция не будет завершена или произойдет ошибка.

### <a name="lpcompletionroutine"></a>лпкомплетионраутине

Тип: \_ In_opt \_ [ **LPWSAOVERLAPPED_COMPLETION_ROUTINE**](/windows/win32/api/winsock2/nc-winsock2-lpwsaoverlapped_completion_routine)

Указатель на подпрограммы завершения, вызываемую при завершении операции (игнорируется для сокетов без перекрытия).

### <a name="lpthreadid"></a>лпсреадид

Указатель на структуру [**всасреадид**](/windows/desktop/api/ws2spi/ns-ws2spi-wsathreadid) , которая будет использоваться поставщиком при последующем вызове [**впукуеуеапк**](/windows/desktop/api/ws2spi/nf-ws2spi-wpuqueueapc).
Поставщик должен хранить указанную [**всасреадид**](/windows/desktop/api/ws2spi/ns-ws2spi-wsathreadid) структуру (а не указатель на то же значение) до тех пор, пока функция [**впукуеуеапк**](/windows/desktop/api/ws2spi/nf-ws2spi-wpuqueueapc) не вернет значение.

**Примечание**  .  Этот параметр применяется только к функции **вспиоктл** .

### <a name="lperrno"></a>лперрно

Указатель на код ошибки.

**Примечание**  .  Этот параметр применяется только к функции **вспиоктл** .

## <a name="return-value"></a>Возвращаемое значение

Если операция завершается успешно, функция [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **вспиоктл** возвращает ноль.

Если операция завершается ошибкой или находится в состоянии ожидания, функция [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **Вспиоктл** возвращает **\_ ошибку сокета**.
Чтобы получить расширенные сведения об ошибке, вызовите [**всажетластеррор**](/windows/desktop/api/winsock/nf-winsock-wsagetlasterror).

| Код ошибки | Значение |
|------------|---------|
| **Ошибка \_ недостаточного \_ буфера** | Область данных, переданная в системный вызов, слишком мала. Эта ошибка возвращается, если буфер, на который указывает параметр *лпваутбуффер* с размером буфера, переданным в параметре *кбаутбуффер* , слишком мал. Требуемый размер буфера будет возвращен в параметре *лпкббитесретурнед* . |
| **WSA_IO_PENDING** | Операция перекрытия успешно инициирована, и ее завершение будет указано позже. |
| **WSA_OPERATION_ABORTED** | Операция перекрытия была отменена из-за замыкания сокета или выполнения команды ioctl **SIO_FLUSH** . |
| **WSAEFAULT** | Параметр *лпваутбуффер*, *лпкббитесретурнед*, *лповерлаппед* или *лпкомплетионраутине* полностью не содержится в допустимой части адресного пространства пользователя. |
| **всаеинпрогресс** | Функция вызывается при выполнении обратного вызова. |
| **всаеинтр** | Операция блокирования была прервана. |
| **всаеинвал** | Параметр *двиоконтролкоде* не является допустимой командой, или указан недопустимый входной параметр, либо команда неприменима к указанному типу сокета. Эта ошибка возвращается, если параметр *кбаутбуффер* меньше, чем размер типа данных **ulong** . |
| **WSAENETDOWN** | Сбой сетевой подсистемы. |
| **всаенопротупт** | Параметр сокета не поддерживается для указанного протокола. |
| **WSAENOTCONN** | *Сокеты не* подключены. |
| **всаенотсокк** | Дескриптор *s* не является сокетом. |
| **всаеопнотсупп** | Указанная команда IOCTL не поддерживается. Эта ошибка возвращается в том случае, если поставщик транспорта не поддерживает **\_ запросы \_ перенаправления запросов WFP на \_ \_ Перенаправление \_ запроса** в службе защиты доступа к сети. |

## <a name="remarks"></a>Комментарии

**Запросы SIO \_ на \_ \_ \_ Перенаправление соединений \_ WFP** поддерживаются в Windows 8, Windows Server 2012 и более поздних версиях операционной системы.

WFP обеспечивает доступ к пути обработки пакетов TCP/IP, где входящие и исходящие пакеты могут быть проверены или изменены перед тем, как разрешить их обработку.
Коснувшись пути обработки TCP/IP, независимые поставщики программного обеспечения могут более легко создавать брандмауэры, антивирусные программы, программное обеспечение диагностики и другие типы приложений и служб.
WFP предоставляет компоненты пользовательского режима и режима ядра, позволяющие сторонним поставщикам программного обеспечения участвовать в принятии решений о фильтрации, выполняемых на нескольких уровнях стека протоколов TCP/IP и всей операционной системы.
Функция перенаправления подключения WFP позволяет драйверу ядра вызова WFP перенаправлять подключение локально в процесс пользовательского режима, выполнять проверку содержимого в пользовательском режиме и пересылать проверенное содержимое с помощью другого подключения к исходному назначению.

**Запросы SIO \_ на \_ \_ \_ Перенаправление подключений \_ WFP запрашивают записи** , а несколько других связанных запросов ioctl являются компонентами пользовательского режима, которые позволяют нескольким ПРИЛОЖЕНИЯМ-посредникам подключений на основе WFP проверять один и тот же поток трафика в совместном режиме.
Каждый агент проверки может безопасно повторно проверить сетевой трафик, который уже был проверен другим агентом проверки.
При наличии нескольких прокси-серверов (например, разработанных разными поставщиками программного обеспечения) подключение, используемое одним прокси-сервером для обмена данными с конечным местом назначения, может быть перенаправлено вторым прокси-сервером, а новое соединение снова будет перенаправлено исходным прокси-сервером.
Без отслеживания подключений исходное соединение может никогда не достичь конечного места назначения, так как оно зависает в бесконечном цикле прокси-сервера.

**Записи о перенаправлении подключений в протоколе SIO используют запросы на \_ \_ \_ \_ \_ перенаправление запросов WFP** , чтобы обеспечить отслеживание подключений через посредника при перенаправленных соединениях сокетов.
Эта функция WFP упрощает отслеживание записей перенаправления из первоначального перенаправления соединения к конечному подключению.

Служба перенаправления запросов с помощью **запроса суперконтроллера ввода-вывода по \_ запросу \_ WFP \_ \_ \_** использует протокол IOCTL, чтобы получить запись перенаправления из принятого соединения пакетов TCP/IP (например, подключенный сокет для сокета TCP или UDP-сокета), перенаправленный на него в режиме ядра, зарегистрированном на **ALE_CONNECT_REDIRECT** уровнях в драйвере режима ядра.
**Запрос SIO \_ \_ \_ \_ \_ контекста перенаправления подключения WFP** используется службой перенаправления на основе WFP для получения контекста перенаправления для записи перенаправления из принятого соединения TCP/IP (например, подключенный сокет для сокета TCP или UDP-сокета), перенаправленный в него вспомогательной выноской, зарегистрированной на уровнях **\_ \_ перенаправления подключения ALE** .
Контекст перенаправления — это необязательный контекст, выделенный драйвером, который используется, если текущее состояние перенаправления соединения заключается в том, что соединение было перенаправлено вызывающей службой перенаправления или если соединение было ранее перенаправлено вызывающей службой перенаправления, но позднее перенаправлено другой службой перенаправления.
Для соединения с прокси-сервером TCP служба перенаправления передает полученную запись перенаправления в сокет TCP, который используется для прокси-сервера с исходным содержимым, используя **\_ \_ \_ \_ \_ записи перенаправления подключения** с помощью SIO.

Когда служба перенаправления перенаправляет сокет, отличный от TCP (например, UDP), записи перенаправления, возвращаемые **\_ \_ \_ \_ \_ записями перенаправления подключения к** службе "SIO", указывают на службу перенаправления, используя структуру [**Всамсг**](/windows/desktop/api/ws2def/ns-ws2def-wsamsg) , используемую с функцией [**LPFN_WSARECVMSG (всареквмсг)**](/windows/win32/api/mswsock/nc-mswsock-lpfn_wsarecvmsg) .
Элемент управления структуры [**всамсг**](/windows/desktop/api/ws2def/ns-ws2def-wsamsg) будет иметь cmsg_type в структуре **всакмсгхдр** , для которой задано значение **\_ \_ перенаправления \_ IP-соединения**.
При принятии перенаправлений, отличных от TCP, параметр [**LPFN_WSARECVMSG (всареквмсг)**](/windows/win32/api/mswsock/nc-mswsock-lpfn_wsarecvmsg) должен быть предоставлен службой перенаправления.

Для трафика, отличного от TCP, запись перенаправления перенаправляется с помощью структуры [**всамсг**](/windows/desktop/api/ws2def/ns-ws2def-wsamsg) с функцией [**всасендмсг**](/windows/desktop/api/winsock2/nf-winsock2-wsasendmsg) .

Обратите внимание, что для трафика, отличного от TCP, только пакет, создающий поток, будет содержать **\_ \_ \_ запись перенаправления IP-подключения**.
В результате, только первый пакет с прокси-сервером должен включить эти сведения с помощью функции [**LPFN_WSARECVMSG (всареквмсг)**](/windows/win32/api/mswsock/nc-mswsock-lpfn_wsarecvmsg) .

Так как запись перенаправления WFP является BLOB-объектом данных переменной длины, вызывающий объект может либо предоставить большой выходной буфер (байтовый буфер 1 024, на который указывает параметр *лпваутбуффер* ), либо передать размер буфера вывода в параметре *кбаутбуффер* , равном 0, чтобы запросить размер буфера, необходимый для хранения возвращенного большого двоичного объекта.
Если размер выходного буфера недостаточно для хранения данных, функции [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **Вспиоктл** возвращают **ошибку, \_ недостаточную для \_ буфера** , и требуемый размер буфера будет возвращен в значение, на которое указывает параметр *лпкббитесретурнед* .

Приложению, вызывающему [**SIO_QUERY_WFP_CONNECTION_REDIRECT_CONTEXT**](sio-query-wfp-connection-redirect-context.md) , не нужно понимать большой двоичный объект, содержащий полученный контекст перенаправления.
Это непрозрачный большой двоичный объект данных, которые приложению необходимо извлечь и передать обратно в новый сокет.

## <a name="see-also"></a>См. также раздел

[**Параметры сокета IPPROTO_IP**](/windows/desktop/winsock/ipproto-ip-socket-options)

[**SIO_QUERY_WFP_CONNECTION_REDIRECT_CONTEXT**](sio-query-wfp-connection-redirect-context.md)

[**фиксатор**](/windows/desktop/api/winsock2/nf-winsock2-socket)

[**всажетластеррор**](/windows/desktop/api/winsock2/nf-winsock2-wsagetlasterror)

[**всажетоверлаппедресулт**](/windows/desktop/api/winsock2/nf-winsock2-wsagetoverlappedresult)

[**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl)

[**всамсг**](/windows/desktop/api/ws2def/ns-ws2def-wsamsg)

[**всаоверлаппед**](/windows/desktop/api/winsock2/ns-winsock2-wsaoverlapped)

[**LPFN_WSARECVMSG (Всареквмсг)**](/windows/win32/api/mswsock/nc-mswsock-lpfn_wsarecvmsg)

[**всасендмсг**](/windows/desktop/api/winsock2/nf-winsock2-wsasendmsg)

[**всасоккета**](/windows/desktop/api/winsock2/nf-winsock2-wsasocketa)

[**всасоккетв**](/windows/desktop/api/winsock2/nf-winsock2-wsasocketw)
