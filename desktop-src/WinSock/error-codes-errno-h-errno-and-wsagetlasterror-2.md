---
description: В приложениях Winsock коды ошибок извлекаются с помощью функции Всажетластеррор, подстановка сокетов Windows для функции Windows GetLastError.
ms.assetid: cb73fc92-74bd-4c8b-a1c0-6daf4d298aa1
title: Коды ошибок — "ошибка", "h_errno" и "Всажетластеррор"
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 31b547e0b580599aaec27a0b77bfad0ffaa8966e
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105701537"
---
# <a name="error-codes---errno-h_errno-and-wsagetlasterror"></a>Коды ошибок — код возврата, h \_ и всажетластеррор

В приложениях Winsock коды ошибок извлекаются с помощью функции [**всажетластеррор**](/windows/desktop/api/winsock/nf-winsock-wsagetlasterror) , подстановка сокетов Windows для функции Windows [**GetLastError**](/windows/win32/api/errhandlingapi/nf-errhandlingapi-getlasterror) . Коды ошибок, возвращаемые сокетами Windows, похожи на константы кода ошибки сокета UNIX, но все константы имеют префикс WSA. Таким образом, в приложениях Winsock возвращается код ошибки ВСАЕВАУЛДБЛОКК, а в приложениях UNIX возвращается код ошибки ЕВАУЛДБЛОКК.

Коды ошибок, заданные сокетами Windows, не предоставляются *через переменную* "код ошибки". Кроме того, для класса **жетксбии** функций коды ошибок не становятся доступными через переменную *h н. \_* Функция [**всажетластеррор**](/windows/desktop/api/winsock/nf-winsock-wsagetlasterror) предназначена для обеспечения надежного способа для потока в многопоточном процессе получения сведений об ошибках для каждого потока.

Для совместимости с BIND UNIX (BSD) ранние версии Windows (Windows 95 с обновлением Windows Socket 2 и Windows 98, например) переопределяют регулярные константы BIND, обычно находящиеся в *обновлении* в формате "сбой Windows Socket". Например, ЕКОННРЕФУСЕД был определен как **всаеконнрефусед** в файле заголовка *Winsock. h* . В последующих версиях Windows (Windows NT 3,1 и более поздних версий) эти определения были добавлены в комментарий, чтобы избежать конфликтов с использованием файла с параметром "переключать *. h* " в Microsoft C/C++ и Visual Studio.

Заголовочный файл *Winsock2. h* , входящий в состав пакета средств разработки программного обеспечения (SDK) для платформы Microsoft Windows, пакета SDK и Visual Studio, по-прежнему содержит заметку в виде блока \# ifdef 0 и \# endif, который определяет коды ошибок сокета BSD так же, как и константы WSA. Их можно использовать для обеспечения некоторой совместимости с программированием сокетов UNIX, BSD и Linux. Для совместимости с BSD приложение может изменить параметр *Winsock2. h* и раскомментировать этот блок. Однако разработчикам приложений настоятельно не рекомендуется раскомментировать этот блок, так как из-за неизбежного возникновения конфликтов с ошибкой возврата *. h* в большинстве приложений. Кроме того, ошибки сокета BSD определяются как значения, отличные от используемых в программах UNIX, BSD и Linux. Разработчикам приложений настоятельно рекомендуется использовать постоянные ошибки WSA в приложениях сокетов.

Эти определения остаются в комментарии в заголовке *Winsock2. h* в \# блоке ifdef 0 и \# endif. Если разработчик приложения настаивает на использовании кодов ошибок BSD для совместимости, то приложение может включить строку в форму:


```C++
#include <windows.h>

#define errno WSAGetLastError()
```



Это позволяет сетевому коду, написанному для использования глобального кода, правильно работать в *среде с одним* потоком. Есть некоторые очень серьезные недостатки. Если исходный файл включает в себя код, который проверяет, что используется *как для* сокетов, так и для функций, не являющихся сокетами, этот механизм использовать нельзя. Более того, приложению не может быть *присвоено новое значение.* (В сокетах Windows для этой цели может использоваться функция [**всасетластеррор**](/windows/desktop/api/winsock/nf-winsock-wsasetlasterror) .)

Типичный стиль BSD


```C++
r = recv(...);
if (r == -1
    && errno == EWOULDBLOCK)
    {...}
```



Предпочтительный стиль


```C++
r = recv(...);
if (r == -1       /* (but see below) */
    && WSAGetLastError() == EWOULDBLOCK)
    {...}
```



Несмотря на то, что для обеспечения совместимости предоставляются константы ошибок, соответствующие сокетам Berkeley 4,3, приложениям настоятельно рекомендуется использовать определения кодов ошибок WSA. Это обусловлено тем, что коды ошибок, возвращаемые определенными функциями сокетов Windows, относятся к стандартному диапазону кодов ошибок, как определено в Microsoft C ©. Таким образом, более эффективной версией предыдущего фрагмента исходного кода является:


```C++
r = recv(...);
if (r == -1       /* (but see below) */
    && WSAGetLastError() == WSAEWOULDBLOCK)
    {...}
```



Исходная спецификация Winsock 1,1, определенная в 1995, рекомендует набор кодов ошибок и список возможных ошибок, которые могут быть возвращены в результате каждой функции. Windows Sockets 2 добавил функции и функции с другими кодами ошибок сокетов Windows, возвращаемыми в дополнение к тем, которые перечислены в исходной спецификации Winsock. В течение времени были добавлены дополнительные функции для улучшения использования Winsock для разработчиков. Например, добавлены новые функции службы имен (например,[**функцию getaddrinfo**](/windows/desktop/api/Ws2tcpip/nf-ws2tcpip-getaddrinfo) и [**жетнамеинфо**](/windows/desktop/api/Ws2tcpip/nf-ws2tcpip-getnameinfo)), поддерживающие IPv6 и IPv4 в Windows XP и более поздних версиях. Некоторые из старых функций службы имен с протоколом IPv4 (например, класс **жетксбии** функций) являются устаревшими.

Полный список возможных кодов ошибок, возвращаемых функциями сокетов Windows, приведен в разделе [коды ошибок сокетов Windows](windows-sockets-error-codes-2.md).

## <a name="related-topics"></a>См. также

<dl> <dt>

[Обработка ошибок Winsock](handling-winsock-errors.md)
</dt> <dt>

[Перенос приложений сокета в Winsock](porting-socket-applications-to-winsock.md)
</dt> <dt>

[Коды ошибок сокетов Windows](windows-sockets-error-codes-2.md)
</dt> <dt>

[Вопросы программирования Winsock](winsock-programming-considerations.md)
</dt> </dl>

 

 
