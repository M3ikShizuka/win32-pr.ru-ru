---
description: Сокеты Windows 2 представляют перекрывающиеся операции ввода-вывода и требуют, чтобы все поставщики транспорта поддерживали эту возможность.
ms.assetid: 90d49171-e211-4426-aa56-88aaeac7c578
title: Перекрывающиеся входные и выходные данные
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0d8caa13dd3d50e4f0fdaa1b92fa8e99afd8e2e1
ms.sourcegitcommit: 3d9dce1bd6c84e2b51759e940aa95aa9b459cd20
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/04/2021
ms.locfileid: "103914239"
---
# <a name="overlapped-inputoutput"></a>Перекрывающиеся входные и выходные данные

Сокеты Windows 2 представляют перекрывающиеся операции ввода-вывода и требуют, чтобы все поставщики транспорта поддерживали эту возможность. Перекрывающиеся операции ввода-вывода можно выполнять только для сокетов, созданных с помощью функции [**вспсоккет**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket) с \_ \_ установленным флагом WSA Flag OVERLAPPED, и следовать модели, установленной в Windows.

Для получения, клиент использует [**вспрекв**](/previous-versions/windows/hardware/network/ff566309(v=vs.85)) или [**вспреквфром**](/previous-versions/windows/desktop/legacy/ms742287(v=vs.85)) для предоставления буферов, в которые должны быть получены данные. Если один или несколько буферов были опубликованы до тех пор, пока данные были получены сетью, то данные будут помещаться в буфер пользователя сразу по мере их поступления и, таким образом, избежать операции копирования, которая в противном случае будет невозможна. Если данные поступают, когда буферы приема уже были отправлены, они немедленно копируются в буфер пользователя. Если данные поступают, когда приложение не посылает буферы приема, поставщик услуг применяет синхронный стиль операции, где входящие данные помещаются в буфер внутренне до тех пор, пока клиент не выдает вызов Receive и, таким образом, предоставляет буфер, в который могут быть скопированы данные. Исключением является то, что приложение использовало [**вспсетсоккопт**](/previous-versions/windows/hardware/network/ff566318(v=vs.85)) для установки размера принимающего буфера равным нулю. В этом случае надежные протоколы разрешают получение данных только при публикации буферов приложений, а данные по ненадежным протоколам будут потеряны.

На отправляющей стороне клиенты используют [**вспсенд**](/previous-versions/windows/hardware/network/ff566316(v=vs.85)) или [**вспсендто**](/previous-versions/windows/desktop/legacy/ms742291(v=vs.85)) для предоставления указателей на заполненные буферы, а затем не занимают буферы каким бы то ни было, пока сеть не запотребляет содержимое буфера.

Перекрывающиеся вызовы Send и Receive немедленно возвращают. Возвращаемое значение, равное нулю, указывает, что операция ввода-вывода завершилась немедленно и что соответствующее указание завершения уже произошло. То есть связанный объект события был сигнальным, или подпрограмма завершения была поставлена в очередь через [**впукуеуеапк**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuqueueapc). Возвращаемое значение ошибки СОКЕТа \_ , связанное с кодом ошибки, \_ ожидающим ввода-вывода WSA \_ , указывает, что операция перекрытия была успешно инициирована, и что последующее указание будет предоставлено при использовании буферов отправки или при заполнении буферов приема. Любой другой код ошибки указывает на то, что операция перекрытия не была успешно инициирована и не будет предпринята ни одна индикация завершения.

Операции отправки и получения могут быть перекрывающиеся. Функции Receive могут вызываться несколько раз для отправки буферов получения при подготовке входящих данных, а функции отправки могут вызываться несколько раз, чтобы поставить в очередь несколько буферов для отправки. Обратите внимание, что хотя последовательность перекрывающихся буферов отправки будет отправлена в указанном порядке, соответствующие события завершения могут происходить в другом порядке. Аналогично, на принимающей стороне буферы будут заполняться в том порядке, в котором они указаны, но события завершения могут происходить в другом порядке.

Функция отложенного завершения операций перекрывающегося ввода-вывода также доступна для [**вспиоктл**](/previous-versions/windows/hardware/network/ff566296(v=vs.85)).

## <a name="delivering-completion-indications"></a>Доставка обработок завершения

Поставщики служб имеют два способа указать выполнение перекрытия: установка объекта события, указанного клиентом, или вызов подпрограммы завершения, указанной клиентом. В обоих случаях структура данных [**всаоверлаппед**](/windows/desktop/api/Winsock2/ns-winsock2-wsaoverlapped)связана с каждой операцией перекрытия. Эта структура выделяется клиентом и используется для указания, какой объект события (если таковой имеется) должен быть установлен при завершении. Структура **всаоверлаппед** может использоваться поставщиком услуг как место для хранения маркера в результатах (например, число переданных байтов, обновленные флаги, коды ошибок и т. д.) для определенной перекрывающейся операции. Чтобы получить эти результаты, клиенты должны вызвать [**вспжетоверлаппедресулт**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspgetoverlappedresult), передав указатель на соответствующую структуру OVERLAPPED.

Если для конкретного перекрывающегося запроса ввода-вывода выбрано указание о завершении на основе события, подпрограммы [**вспжетоверлаппедресулт**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspgetoverlappedresult) могут быть использованы клиентами для опроса или ожидания завершения операции перекрытия. Если для конкретного перекрывающегося запроса ввода-вывода выбрана индикация завершения на основе процедуры завершения, доступен только параметр опроса **вспжетоверлаппедресулт** . Кроме того, клиент может использовать другие средства для ожидания (например, использование [**всаваитформултипливентс**](/windows/desktop/api/Winsock2/nf-winsock2-wsawaitformultipleevents)), пока соответствующий объект события не сообщит о том, или если в поставщике службы вызвана указанная подпрограмма завершения. После того как было указано завершение, клиент может вызвать **вспжетоверлаппедресулт**, предполагаю, что вызов будет выполнен немедленно.

## <a name="invoking-socket-io-completion-routines"></a>Вызов подподпрограмм завершения ввода-вывода сокетов

Если параметр *лпкомплетионраутине* для перекрывающейся операции имеет значение, отличное от **null**, то поставщик услуг должен выполнять поиск вызова указанной клиентом подпрограммы завершения по завершении перекрывающейся операции. Так как подпрограммы завершения должны выполняться в контексте того же потока, который инициировал операцию перекрытия, он не может быть вызван непосредственно от поставщика услуг. Ws2 \_32.DLL предлагает механизм асинхронного вызова процедур (APC) для упрощения вызова подпрограмм завершения.

Поставщик услуг упорядочивает функцию для выполнения в надлежащем потоке, вызывая [**впукуеуеапк**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuqueueapc). Эту функцию можно вызывать из любого контекста процесса и потока, даже контекста, отличного от потока и процесса, который использовался для инициирования перекрывающегося операции.

[**Впукуеуеапк**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuqueueapc) принимает в качестве входных параметров указатель на структуру [**всасреадид**](/windows/desktop/api/Ws2spi/ns-ws2spi-wsathreadid) , указатель на функцию APC для вызова и 32-разрядное значение контекста, которое впоследствии передается функции APC. Поставщики услуг всегда предоставляются с указателем на правильную структуру **всасреадид** через параметр *лпсреадид* для перекрывающейся функции. Поставщик должен хранить структуру **всасреадид** локально и указать указатель на эту копию структуры **всасреадид** в качестве входного параметра для **впукуеуеапк**. После возврата функции **впукуеуеапк** поставщик может удалить свою копию **всасреадид**.

Процедура [**впукуеуеапк**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuqueueapc) просто ставит достаточно сведений в очередь, чтобы вызвать указанную функцию APC с заданными параметрами, но не вызывает ее. Когда целевой поток переходит в состояние ожидания с предупреждением, эти сведения выводятся из очереди и вызывается функция APC в этом целевом потоке и контексте процесса. Так как механизм APC поддерживает только одно значение 32-разрядного контекста, функция APC сама по себе не может представлять собой подпрограммы завершения, заданную клиентом, в которой используются дополнительные параметры. Поставщик услуг должен вместо этого указать указатель на собственную функцию APC, которая использует предоставленное значение контекста для доступа к необходимой информации о перекрытой операции, а затем вызывает указанную клиентом подпрограммы завершения.

Для поставщиков услуг, в которых компонент пользовательского режима реализует перекрывающиеся операции ввода-вывода, обычно используется механизм APC следующим образом:

-   По завершении операции ввода-вывода поставщик выделяет небольшой буфер и упаковывает его в указатель на процедуру завершения, предоставляемую клиентом, и значения параметров, которые передаются в процедуру.
-   Он помещает APC в очередь, указывая указатель на буфер как значение контекста и собственную промежуточную процедуру в качестве целевой процедуры.
-   Когда целевой поток в конечном итоге переходит в состояние ожидания с оповещением, промежуточная процедура поставщика услуг вызывается в правильном контексте потока.
-   Промежуточная процедура просто распаковать параметры, освобождает буфер и вызывает предоставляемую клиентом процедуру завершения.
-   Для поставщиков услуг, где компонент режима ядра реализует перекрывающиеся операции ввода-вывода, типичная реализация аналогична, за исключением того, что реализация будет использовать стандартные интерфейсы ядра для постановки в очередь APC.

Описание соответствующих интерфейсов ядра лежит вне области спецификации Windows Sockets 2.

> [!Note]  
> Поставщики услуг должны разрешить клиентам Windows Sockets 2 вызывать операции Send и Receive в контексте подпрограммы завершения ввода-вывода и гарантировать, что подпрограммы завершения ввода-вывода не будут вложены.

 

В некоторых обстоятельствах для многоуровневого поставщика услуг может потребоваться инициировать и завершить перекрывающиеся операции из внутреннего рабочего потока. В этом случае [**всасреадид**](/windows/desktop/api/Ws2spi/ns-ws2spi-wsathreadid) будет недоступен во входящем вызове функции. Интерфейс поставщика услуг предоставляет метод [**впуопенкуррентсреад**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuopencurrentthread)для получения **всасреадид** для текущего потока. Если этот **всасреадид** больше не нужен, его ресурсы должны возвращаться путем вызова [**впуклосесреад**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuclosethread).

 

 
