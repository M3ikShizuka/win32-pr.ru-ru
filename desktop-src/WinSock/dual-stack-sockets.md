---
description: Для поддержки IPv4 и IPv6 в Windows XP с пакетом обновления 1 (SP1) и Windows Server 2003 приложение должно создать два сокета, один сокет для использования с IPv4 и один сокет для использования с IPv6.
ms.assetid: 7ae49081-ffb5-4eee-b488-2541398e7acc
title: Dual-Stack сокеты для IPv6-приложений Winsock
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 943d8150586bcf14a905ab32dcacaea63b7d6982
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105701538"
---
# <a name="dual-stack-sockets-for-ipv6-winsock-applications"></a>Dual-Stack сокеты для IPv6-приложений Winsock

Для поддержки IPv4 и IPv6 в Windows XP с пакетом обновления 1 (SP1) и Windows Server 2003 приложение должно создать два сокета, один сокет для использования с IPv4 и один сокет для использования с IPv6. Эти два сокета должны обрабатываться отдельно приложением.

В Windows Vista и более поздних версиях предусмотрена возможность создания одного сокета IPv6, который может поддерживать как трафик IPv6, так и IPv4. Например, будет создан сокет прослушивания TCP для IPv6, переведен в режим двойного стека и привязан к порту 5001. Этот сокет с двойным стеком может принимать подключения от TCP-клиентов IPv6, подключающихся к порту 5001, а также от клиентов IPv4 TCP, подключающихся к порту 5001. Эта функция позволяет значительно упростить проектирование приложений и снизить издержки ресурсов, необходимые для размещения операций на двух отдельных сокетах.

## <a name="creating-a-dual-stack-socket"></a>Создание сокета Dual-Stack

По умолчанию сокет IPv6, созданный в Windows Vista и более поздних версиях, работает только по протоколу IPv6. Чтобы установить сокет IPv6 в сокет с двумя стеками, необходимо вызвать функцию [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) с параметром сокета **IPv6 \_ V6ONLY** , чтобы присвоить этому параметру значение 0, прежде чем сокет будет привязан к IP-адресу. Если параметр сокета **IPv6 \_ V6ONLY** имеет значение 0, сокет, созданный для семейства адресов **AF \_ INET6** , можно использовать для отправки и получения пакетов по адресу IPv6 или сопоставленному IPv4-адресу.

## <a name="ip-addresses-with-a-dual-stack-socket"></a>IP-адреса с сокетом Dual-Stack

Для сокетов с двумя стеками всегда требуется IPv6-адреса. Возможность взаимодействия с IPv4-адресом требует использования формата IPv4, сопоставленного с IPv6. Все адреса IPv4 должны быть представлены в формате IPv6-адресов, сопоставленном с IPv4, что позволяет приложению только для IPv6 взаимодействовать с узлом IPv4. Формат IPv6-адресов, сопоставленный с IPv4, позволяет представить адрес IPv4 узла IPv4 в качестве адреса IPv6. Адрес IPv4 кодируется в младшие биты 32 IPv6-адреса, а старшие биты 96 содержат фиксированный префикс 0:0: 0:0: 0: FFFF. Формат IPv6-адреса, сопоставленный с IPv4, указан в RFC 4291. Дополнительные сведения см. в разделе [www.ietf.org/rfc/rfc4291.txt](https://tools.ietf.org/html/rfc4291). Макрос IN6ADDR \_ SETV4MAPPED в *мсткпип. h* можно использовать для преобразования адреса IPv4 в требуемый формат IPv6-адресов, сопоставленный с IPv4.

Если основной протокол фактически является IPv4, адрес IPv4 сопоставляется с форматом IPv6-адресов, сопоставленным с IPv4. Это поле Family в структуре [SOCKADDR](sockaddr-2.md) указывает на AF \_ INET6, но адрес IPv6, сопоставленный с IPv4, кодируется в структуре IPv6-адресов. Для сокета с двойным стеком в режиме прослушивания все принятые подключения IPv4 будут возвращать IPv4-адрес IPv6. Для сокета с двумя стеками, который подключается к назначению IPv4, структура SOCKADDR, передаваемая в Connect, должна быть IPv6-адресом, сопоставленным с IPv4. Приложения должны соблюдать осторожность при обработке этих IPv4-адресов IPv6 соответствующим образом и использовать их только с двойными сокетами стека. Если IP-адрес передается в обычный сокет IPv4, адрес должен быть обычным адресом IPv4, а не IPv4-адресом IPv6.

## <a name="potential-issues-using-a-dual-stack-socket"></a>Потенциальные проблемы при использовании сокета Dual-Stack

Потенциальная ловушка для приложений — получение IPv6-адреса, сопоставленного с IPv4, на сокете с двумя стеками, а затем попытка использовать возвращенный IP-адрес в другом сокете только для IPv6. Например, функции [**жетсоккнаме**](/windows/desktop/api/winsock/nf-winsock-getsockname) или [**жетпирнаме**](/windows/desktop/api/winsock/nf-winsock-getpeername) могут возвращать адрес IPv6, сопоставленный с IPv4, при использовании в сокете с двумя стеками. Если возвращаемый IPv4-адрес IPv6 затем используется на другом сокете, для которого не задано двойное стек (только сокет IPv6, который является поведением по умолчанию при создании сокета), любое использование этого сокета только для IPv6 с адресом IPv6, сопоставленным с IPv4, завершится ошибкой. Формат IPv6-адреса, сопоставленный с IPv4, можно использовать только для сокета с двумя стеками.

Если для приложения с двойным стеком требуется функция [**LPFN_WSARECVMSG (всареквмсг)**](/windows/win32/api/mswsock/nc-mswsock-lpfn_wsarecvmsg) , возвращающая сведения о пакете в структуре [**всамсг**](/windows/desktop/api/Ws2def/ns-ws2def-wsamsg) для датаграмм, полученных по протоколу IPv4, то параметр сокета [IP \_ пктинфо](ip-pktinfo.md) должен быть установлен в значение true на сокете. Если только параметр [IPv6 \_ пктинфо](ipv6-pktinfo.md) имеет значение true для сокета, сведения о пакете будут предоставлены для датаграмм, полученных по протоколу IPv6, но могут не предоставляться для датаграмм, полученных по протоколу IPv4.

Если приложение пытается установить параметр сокета [IP \_ пктинфо](ip-pktinfo.md) для сокета датаграмм с двойным стеком и протокол IPv4 отключен в системе, то функция [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) завершится ошибкой, а [**всажетластеррор**](/windows/desktop/api/winsock/nf-winsock-wsagetlasterror) вернет ошибку [всаеинвал](windows-sockets-error-codes-2.md). Эта же ошибка также возвращается функцией **сетсоккопт** в результате других ошибок. Если приложение пытается установить \_ параметр сокета IP-уровня иппрото на сокете с двойным стеком и завершается с помощью [всаеинвал](windows-sockets-error-codes-2.md), то приложение должно определить, отключена ли на локальном компьютере IPv4. Один из методов, который можно использовать для определения того, включен или отключен протокол IPv4, заключается в вызове функции [**Socket**](/windows/desktop/api/Winsock2/nf-winsock2-socket) с параметром *AF* , установленным в AF \_ INET для попытки и создания сокета IPv4. Если функция **сокета** завершается с ошибкой и **Всажетластеррор** возвращает ошибку [всаеафносуппорт](windows-sockets-error-codes-2.md), это означает, что протокол IPv4 не включен. В этом случае ошибка функции **сетсоккопт** при попытке установить \_ параметр сокета IP-пктинфо может быть проигнорирована приложением. В противном случае при попытке установить \_ параметр сокета IP пктинфо следует считать непредвиденной ошибкой.

Для сокета с двойным стеком при отправке датаграмм с помощью функции [**всасендмсг**](/windows/desktop/api/winsock2/nf-winsock2-wsasendmsg) и в приложении требуется указать конкретный локальный IP-адрес, который будет использоваться, метод, который будет обрабатывать это, зависит от IP-адреса назначения. При отправке на адрес назначения IPv4 или IPv6-адрес назначения, сопоставленный с IPv4, один из объектов данных элемента управления, переданных в структуру [**всамсг**](/windows/desktop/api/Ws2def/ns-ws2def-wsamsg) , на который указывает параметр *лпмсг* , должен содержать [**в структуре \_ пктинфо**](/windows/desktop/api/Ws2ipdef/ns-ws2ipdef-in_pktinfo) , содержащую локальный адрес IPv4, который следует использовать для отправки. При отправке на IPv6-адрес назначения, который не является адресом IPv6, сопоставленным с IPv4, один из объектов данных элемента управления, переданных в структуру **всамсг** , на который указывает параметр *лпмсг* , должен содержать структуру [**in6 \_ Пктинфо**](/windows/desktop/api/Ws2ipdef/ns-ws2ipdef-in6_pktinfo) , содержащую локальный исходный адрес IPv6, который следует использовать для отправки.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Рекомендации по IPv6 для приложений Windows Sockets](ipv6-guide-for-windows-sockets-applications-2.md)
</dt> <dt>

[Изменение структур данных для IPv6 Winsock Аппикатионс](changing-data-structures-2.md)
</dt> <dt>

[Вызовы функций для IPv6-приложений Winsock](function-calls-2.md)
</dt> <dt>

[Использование жестко закодированных IPv4-адресов](use-of-hardcoded-ipv4-addresses-2.md)
</dt> <dt>

[Проблемы с пользовательским интерфейсом для IPv6-приложений Winsock](user-interface-issues-2.md)
</dt> <dt>

[Базовые протоколы для IPv6-приложений Winsock](underlying-protocols-2.md)
</dt> <dt>

[**жетпирнаме**](/windows/desktop/api/winsock/nf-winsock-getpeername)
</dt> <dt>

[**жетсоккнаме**](/windows/desktop/api/winsock/nf-winsock-getsockname)
</dt> <dt>

[**в \_ пктинфо**](/windows/desktop/api/Ws2ipdef/ns-ws2ipdef-in_pktinfo)
</dt> <dt>

[**in6 \_ пктинфо**](/windows/desktop/api/Ws2ipdef/ns-ws2ipdef-in6_pktinfo)
</dt> <dt>

[IP- \_ пктинфо](ip-pktinfo.md)
</dt> <dt>

[\_ПКТИНФО IPv6](ipv6-pktinfo.md)
</dt> <dt>

[**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt)
</dt> <dt>

[**LPFN_WSARECVMSG (Всареквмсг)**](/windows/win32/api/mswsock/nc-mswsock-lpfn_wsarecvmsg)
</dt> <dt>

[**всасендмсг**](/windows/desktop/api/winsock2/nf-winsock2-wsasendmsg)
</dt> </dl>

 

 
