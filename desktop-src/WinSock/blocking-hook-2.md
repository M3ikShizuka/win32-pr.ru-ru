---
description: Хотя этот механизм достаточно для простых приложений, он не поддерживает сложные требования к диспетчеризации сообщений для более сложных приложений, таких как использование модели многодокументного интерфейса (MDI).
ms.assetid: e4558e71-bbec-415a-a7c2-9025a4d6c474
title: Блокирующий обработчик
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 2dcd098692784a662456c990a238bd309db0c321
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105711043"
---
# <a name="blocking-hook"></a>Блокирующий обработчик

Хотя этот механизм достаточно для простых приложений, он не поддерживает сложные требования к диспетчеризации сообщений для более сложных приложений, таких как использование модели многодокументного интерфейса (MDI). Для таких приложений обработчик блокировки конкретного потока может быть установлен приложением. Он будет вызван поставщиком услуг вместо обработчика блокировки по умолчанию, описанного выше. Поставщик услуг должен получить указатель на обработчик блокировки для каждого потока из \_32.dll Ws2, вызвав [**впукуериблоккингкаллбакк**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuqueryblockingcallback). Если приложение не установило собственный обработчик блокировки, будет возвращен указатель на блокирующую функцию-ловушку по умолчанию.

Поставщик услуг Windows Sockets не может предположить, что предоставляемый приложением блокирующий обработчик позволяет продолжать обработку сообщений в качестве блокирующего обработчика по умолчанию. Некоторые приложения не допускают возможность повторного использования сообщений во время выполнения блокирующей операции. Такая функция блокировки приложения будет просто возвращать **значение false**. Если поставщик услуг зависит от сообщений для своей внутренней операции, он может выполнить **PeekMessage**(хмивнд...) перед выполнением обработчика блокировки приложения, чтобы он мог получать собственные сообщения, не влияя на остальную часть системы.

Не установлен обработчик блокировки по умолчанию в многопоточных версиях Windows с вытеснением. Это связано с тем, что другие процессы не блокируются, если одно приложение ожидает завершения операции (и, следовательно, не вызывает **PeekMessage** или yield, что приводит к тому **, что приложение** выдает процессор в окнах без вытеснений). Когда поставщик услуг вызывает [**впукуериблоккингкаллбакк**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuqueryblockingcallback) , будет возвращен пустой указатель, указывающий, что поставщик должен использовать встроенные функции блокировки операционной системы. Однако, чтобы сохранить обратную совместимость, предоставляемый приложением блокирующий обработчик по-прежнему может быть установлен на основе каждого потока в Windows.

Поставщик услуг Winsock вызывает блокирующий ловушку только в том случае, если выполняются все следующие условия: подпрограммы, которые определены как возможность блокировки, указанный сокет является блокирующим, и запрос не может быть выполнен немедленно. Если используются только неблокирующие сокеты и [**вспасинкселект**](/previous-versions/windows/desktop/legacy/ms742267(v=vs.85)) / [**вспевентселект**](/previous-versions/windows/hardware/network/ff566287(v=vs.85)) вместо [**вспселект**](/previous-versions/windows/desktop/legacy/ms742289(v=vs.85)) , блокирующий обработчик никогда не будет вызываться.

> [!Note]  
> Если в течение времени, когда псеудоблоккинг используется для блокировки потока, для потока получено сообщение Windows, существует риск, что поток попытается выдать другой вызов Winsock. В связи с тем, что сложность управления этим условием безопасно, спецификация Windows Sockets 1,1 не позволяла это поведение. Данный поток не является допустимым для выполнения нескольких вложенных вызовов функций Winsock. Для конкретного потока допускается только один невыполненный вызов функции. Все вложенные вызовы функции Winsock завершаются ошибкой с ошибкой ВСАЕИНПРОГРЕСС. Следует подчеркнуть, что это ограничение применяется как к блокирующей, так и к неблокирующей операциям, но только в средах Windows Sockets 1,1. Существует несколько исключений из этого правила, включая две функции, позволяющие приложению определить, выполняется ли операция псеудоблоккинг, а также отменить такую операцию, если это необходимо. Они описаны в следующем разделе.

 

 

 
