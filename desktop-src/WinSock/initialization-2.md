---
description: Ws2 \_32.dll загружает библиотеку DLL интерфейса поставщика услуг в систему, используя стандартные механизмы загрузки динамических библиотек Microsoft Windows и инициализирует ее путем вызова вспстартуп.
ms.assetid: 6df28d93-8757-45b3-8f05-86381c3be64e
title: Инициализация
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 76570fe401fb064047581a60a4340daf71b5a583034baf67b8e9b830ccae0dc7
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "120097874"
---
# <a name="initialization"></a>Инициализация

*Ws2 \_32.dll* загружает библиотеку DLL интерфейса поставщика услуг в систему, используя стандартные механизмы загрузки динамических библиотек Microsoft Windows и инициализирует ее путем вызова [**вспстартуп**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup). Обычно это активируется приложением, вызывающим [**сокет**](/windows/desktop/api/Winsock2/nf-winsock2-socket) или [**всасоккет**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa) , для создания нового сокета, который будет связан с поставщиком услуг, DLL интерфейса которого в данный момент не загружен в память. Путь к библиотеке DLL интерфейса каждого поставщика услуг хранится в *Ws2 \_32.dll* на момент установки поставщика служб. Дополнительные сведения см. в разделе [функции установки и настройки](installation-and-configuration-functions-2.md) .

Со временем для библиотек DLL, приложений и поставщиков служб Winsock могут существовать разные версии. Новые версии могут определять новые функции и новые параметры для структур данных, а также битовые параметры и т. д. Поэтому номера версий указывают, как интерпретировать различные структуры данных.

Чтобы обеспечить оптимальное смешивание и сопоставление различных версий приложений, версий Ws2 \_32.dll и версий поставщиков услуг разных поставщиков, SPI предоставляет механизм согласования версий для использования между *Ws2 \_32.dll* и поставщиками служб. Это согласование версий обрабатывается с помощью [**вспстартуп**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup). По сути, *Ws2 \_32.dll* передает поставщику услуг наиболее высокие номера версий, с которыми она совместима. Поставщик услуг сравнивает это с собственным поддерживаемым диапазоном номеров версий. Если эти диапазоны перекрываются, поставщик услуг возвращает значение в перекрывающейся части диапазона в результате согласования. Обычно это должно быть наибольшее возможное значение. Если диапазоны не пересекаются, эти две стороны несовместимы и функция возвращает ошибку.

[**Вспстартуп**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) должен вызываться по крайней мере один раз каждым клиентским процессом и может вызываться несколько раз с помощью Ws2 \_32.dll или других сущностей. Для каждого успешного вызова **вспстартуп** должен быть вызван соответствующий [**вспклеануп**](/previous-versions/windows/hardware/network/ff566270(v=vs.85)) . Поставщик услуг должен поддерживать счетчик ссылок для каждого процесса. При каждом вызове **вспстартуп** вызывающая сторона может указать любой номер версии, поддерживаемый DLL-библиотекой SP.

Поставщик услуг должен хранить указатель на таблицу диспетчеризации отправки клиента, которая получается как параметр [**вспстартуп**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) для каждого процесса. Если заданный процесс вызывает **вспстартуп** несколько раз, поставщик услуг должен использовать только самый последний переданный указатель на таблицу диспетчеризации.

В рамках процесса инициализации поставщика услуг Ws2 \_32.dll извлекает таблицу диспетчеризации поставщика услуг через параметр *лппроктабле* , чтобы получить точки входа для остальных функций SPI, указанных в этом документе.

Использование таблицы диспетчеризации (в отличие от обычных механизмов DLL для доступа к точкам входа) служит двум целям:

-   Более удобно использовать32.dll Ws2, \_ так как для обнаружения всего набора точек входа можно выполнить один вызов.
-   Он позволяет использовать многоуровневые поставщики услуг, сформированные в цепочках протоколов, для повышения эффективности работы.

## <a name="initializing-protocol-chains"></a>Инициализация цепочек протоколов

Во время установки структуры [**протокола \_ всапротокол**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) для цепочки протоколов также указывается путь к первому многоуровневый поставщику в цепочке. При инициализации цепочки протоколов \_32.dll Ws2 использует этот путь для загрузки библиотеки DLL поставщика, а затем вызывает [**вспстартуп**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup). Так как **вспстартуп** содержит указатель на структуру **\_ сведений о всапротокол** цепочки как один из параметров, многоуровневые поставщики могут определить тип цепочки, в которую они инициализируются, а также идентификатор следующего более низкого слоя в цепочке. Многоуровневый поставщик затем, в свою очередь, загрузит следующий поставщик протокола в цепочку и инициализирует его с помощью вызова **вспстартуп** и т. д. Каждый раз, когда следующий более низкий уровень является другим многоуровневый поставщиком, в вызове **вспстартуп** должна быть ссылка на структуру **\_ сведений о всапротокол** цепочки. Если следующий более низкий уровень является базовым протоколом (обозначает конец цепочки), структура **\_ сведений всапротокол** цепочки больше не распространяется вниз. Вместо этого текущий слой должен ссылаться на структуру **всапротокол \_ info** , соответствующую протоколу, который должен использовать базовый поставщик. Поэтому базовый поставщик не имеет представления о вовлечении в цепочку протоколов.

Таблица диспетчеризации, предоставленная любым указанным многоуровневый поставщиком, во многих случаях дублирует точки входа базового поставщика. Многоуровневый поставщик будет вставлять свои точки входа только для тех функций, в которые ей нужно напрямую участвовать. Однако следует отметить, что при вызове [**вспстартуп**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) на следующем более низком уровне цепочки протоколов необходимо, чтобы многоуровневый поставщик не изменил содержимое таблицы исзываемого вызова. эти вызовы должны быть сделаны непосредственно в библиотеке DLL Windows sockets 2.

 

 
