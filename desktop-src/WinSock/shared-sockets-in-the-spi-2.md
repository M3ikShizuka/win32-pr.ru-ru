---
description: Общий доступ к сокету в сокетах Windows (Winsock).
ms.assetid: dad31820-6f60-4c3b-9cdf-e301a5ffce48
title: Общие сокеты в SPI
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 21ff0d8f73d2bd9de942d17de7f9564158d1810c
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103898806"
---
# <a name="shared-sockets-in-the-spi"></a>Общие сокеты в SPI

Совместное использование сокетов между процессами в сокетах Windows реализуется следующим образом. Исходный процесс вызывает [**вспдупликатесоккет**](/previous-versions/windows/hardware/network/ff566282(v=vs.85)) для получения специальной структуры [**\_ сведений о всапротокол**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) . Он использует некоторый механизм межпроцессного взаимодействия (IPC) для передачи содержимого этой структуры в целевой процесс. Затем целевой процесс использует структуру **\_ сведений всапротокол** в вызове [**вспсоккет**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket). Дескриптор сокета, возвращаемый этой функцией, будет дополнительным дескриптором сокета для базового сокета, который, таким же, становится общим.

Ответственность за выполнение любых операций, необходимых в исходном контексте процесса, и создание структуры [**\_ сведений о всапротокол**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) , которая будет распознана при последующем отображении в качестве параметра для [**вспсоккет**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket) в контексте целевых процессов, несет поставщик услуг. Элемент **двпровидерресервед** структуры **\_ сведений о всапротокол** доступен для использования поставщиком услуг и может использоваться для хранения полезных сведений о контексте, включая дубликаты маркеров.

Этот механизм предназначен для использования как для многопоточных, так и для многопотоковых версий Windows с вытеснением. Обратите внимание, что сокеты могут совместно использоваться потоками в данном процессе без использования функции [**вспдупликатесоккет**](/previous-versions/windows/hardware/network/ff566282(v=vs.85)) , так как дескриптор сокета является допустимым во всех потоках процесса.

Как описано в разделе [выделение дескрипторов](descriptor-allocation-2.md)разделов, при выделении новых дескрипторов сокетов поставщики IFS должны вызывать [**впумодифифшандле**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpumodifyifshandle) и поставщиков, не применяющих IFS, должны вызывать [**впукреатесоккесандле**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpucreatesockethandle).

Один из возможных сценариев для установки и использования общего сокета в режиме передачи показан в следующей таблице.

| Процесс-источник                                                                                                                          | IPC    | Процесс назначения                                                           |
|-----------------------------------------------------------------------------------------------------------------------------------------|--------|-------------------------------------------------------------------------------|
| 1) [**вспсоккет**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket), [**вспконнект**](/previous-versions/windows/hardware/network/ff566275(v=vs.85))                                                                 |        |                                                                               |
| 2) запросы целевого идентификатора процесса.                                                                                                  | ==> |                                                                               |
|                                                                                                                                         |        | 3) получает идентификатор процесса и отвечает на запросы.                          |
| 4) получает идентификатор процесса.                                                                                                         | <== |                                                                               |
| 5) вызывает [**вспдупликатесоккет**](/previous-versions/windows/hardware/network/ff566282(v=vs.85)) для получения специальной структуры [**\_ сведений о всапротокол**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) . |        |                                                                               |
| 6) отправка **структуры \_ сведений о всапротокол** в целевой объект.                                                                                     |        |                                                                               |
|                                                                                                                                         | ==> | 7) получает [**структуру \_ сведений о всапротокол**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) .        |
|                                                                                                                                         |        | 8) вызывает [**вспсоккет**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket) для создания общего дескриптора сокета. |
|                                                                                                                                         |        | 9) использует общий сокет для обмена данными.                                       |
| 10) [ **вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))                                                                                          | <== |                                                                               |



 

 

 
