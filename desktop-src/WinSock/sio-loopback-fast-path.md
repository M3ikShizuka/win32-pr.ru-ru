---
description: Управляющий код настраивает сокет TCP для более низкой задержки и более быстрых операций в интерфейсе замыкания на себя.
ms.assetid: 4F7A6454-E3ED-4529-A531-B0640B0767EF
title: Код элемента управления SIO_LOOPBACK_FAST_PATH
ms.topic: reference
ms.date: 05/20/2019
req.target-min-winverclnt: Windows Vista [desktop apps only]
req.target-min-winversvr: Windows Server 2008 [desktop apps only]
api_location:
- mstcpip.h
ms.openlocfilehash: 8650cd267d321569aca584e7195fb1bdb79c83a33d931e59e8db37521b8933a3
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "117740413"
---
# <a name="sio_loopback_fast_path-control-code"></a>Код элемента управления SIO_LOOPBACK_FAST_PATH

## <a name="description"></a>Описание

код контрольного кода для **\_ замыкания на себя SIO \_ FAST \_ пути** настраивает TCP-сокет для более низкой задержки и более быстрые операции в интерфейсе замыкания на себя.

**Важно!**  **\_ \_ \_ путь FAST замыкания на себя SIO** является устаревшим и не рекомендуется использовать в коде.

Чтобы выполнить эту операцию, вызовите функцию [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **вспиоктл** со следующими параметрами.

```cpp
int WSAIoctl(
  (socket) s,             // descriptor identifying a socket
  SIO_LOOPBACK_FAST_PATH,                // dwIoControlCode
  (LPVOID) lpvInBuffer,   // pointer to a Boolean value
  (DWORD) cbInBuffer,    // size, in bytes, of the input buffer
  (LPVOID) lpvOutBuffer,         // pointer to output buffer
  (DWORD) cbOutBuffer,       // size of output buffer
  (LPDWORD) lpcbBytesReturned,    // number of bytes returned
  (LPWSAOVERLAPPED) lpOverlapped,   // OVERLAPPED structure
  (LPWSAOVERLAPPED_COMPLETION_ROUTINE) lpCompletionRoutine,  // completion routine
);
```

```cpp
int WSPIoctl(
  (socket) s,             // descriptor identifying a socket
  SIO_LOOPBACK_FAST_PATH,                // dwIoControlCode
  (LPVOID) lpvInBuffer,   // pointer to a Boolean value
  (DWORD) cbInBuffer,           // size, in bytes, of the input buffer
  (LPVOID) lpvOutBuffer,         // pointer to output buffer
  (DWORD) cbOutBuffer,       // size of output buffer
  (LPDWORD) lpcbBytesReturned,    // number of bytes returned
  (LPWSAOVERLAPPED) lpOverlapped,   // OVERLAPPED structure
  (LPWSAOVERLAPPED_COMPLETION_ROUTINE) lpCompletionRoutine,  // completion routine
  (LPWSATHREADID) lpThreadId,   // a WSATHREADID structure
  (LPINT) lpErrno   // a pointer to the error code.
);
```

## <a name="parameters"></a>Параметры

### <a name="s"></a>s

Дескриптор, идентифицирующий сокет.

### <a name="dwiocontrolcode"></a>двиоконтролкоде

Управляющий код для операции.
для этой операции используйте **\_ петлевой \_ FASTный \_ путь** .

### <a name="lpvinbuffer"></a>лпвинбуффер

Указатель на входной буфер.
Этот параметр содержит указатель на логическое значение, указывающее, следует ли настроить сокет для выполнения операций быстрого замыкания на себя.

### <a name="cbinbuffer"></a>кбинбуффер

Размер входного буфера в байтах.

### <a name="lpvoutbuffer"></a>лпваутбуффер

Указатель на выходной буфер.
Этот параметр не используется для этой операции.

### <a name="cboutbuffer"></a>кбаутбуффер

Размер выходного буфера в байтах.
Этот параметр должен иметь значение 0.

### <a name="lpcbbytesreturned"></a>лпкббитесретурнед

Указатель на переменную, которая получает размер данных, хранящихся в выходном буфере, в байтах.

Если выходной буфер слишком мал, вызов завершается ошибкой, [**всажетластеррор**](/windows/desktop/api/winsock/nf-winsock-wsagetlasterror) возвращает [**всаеинвал**](windows-sockets-error-codes-2.md), а параметр *лпкббитесретурнед* указывает на значение **DWORD** , равное нулю.

Если *лповерлаппед* имеет значение **null**, то значение **DWORD** , на которое указывает параметр *лпкббитесретурнед* , возвращаемое при успешном вызове, не может быть нулевым.

Если параметр *лповерлаппед* имеет значение, отличное от **null** , для перекрывающихся сокетов, то операции, которые не могут быть выполнены немедленно, будут инициированы, а завершение будет указано позже.
Значение **DWORD** , на которое указывает возвращаемый параметр *лпкббитесретурнед* , может быть равно нулю, так как размер хранимых данных не может быть определен до завершения операции перекрытия.
Окончательное состояние завершения можно получить, если при выполнении операции будет получен сигнал о соответствующем методе завершения.

### <a name="lpvoverlapped"></a>лпвоверлаппед

Указатель на структуру [**всаоверлаппед**](/windows/desktop/api/winsock2/ns-winsock2-wsaoverlapped) .

Если *сокеты были созданы* без атрибута OVERLAPPED, параметр *лповерлаппед* игнорируется.

Если *конструктор* был открыт с атрибутом OVERLAPPED и параметр *Лповерлаппед* не равен **null**, операция выполняется как перекрытый (асинхронная) операция.
В этом случае параметр *лповерлаппед* должен указывать на допустимую структуру [**всаоверлаппед**](/windows/desktop/api/winsock2/ns-winsock2-wsaoverlapped) .

Для операций с перекрытием функция [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **вспиоктл** возвращает значение немедленно, и соответствующий метод завершения получает сигнал о завершении операции.
В противном случае функция не возвращает значение до тех пор, пока операция не будет завершена или произойдет ошибка.

### <a name="lpcompletionroutine"></a>лпкомплетионраутине

Тип: \_ In_opt \_ [ **LPWSAOVERLAPPED_COMPLETION_ROUTINE**](/windows/win32/api/winsock2/nc-winsock2-lpwsaoverlapped_completion_routine)

Указатель на подпрограммы завершения, вызываемую при завершении операции (игнорируется для сокетов без перекрытия).

### <a name="lpthreadid"></a>лпсреадид

Указатель на структуру [**всасреадид**](/windows/desktop/api/ws2spi/ns-ws2spi-wsathreadid) , которая будет использоваться поставщиком при последующем вызове [**впукуеуеапк**](/windows/desktop/api/ws2spi/nf-ws2spi-wpuqueueapc).
Поставщик должен хранить указанную [**всасреадид**](/windows/desktop/api/ws2spi/ns-ws2spi-wsathreadid) структуру (а не указатель на то же значение) до тех пор, пока функция [**впукуеуеапк**](/windows/desktop/api/ws2spi/nf-ws2spi-wpuqueueapc) не вернет значение.

**Примечание**  .  Этот параметр применяется только к функции **вспиоктл** .

### <a name="lperrno"></a>лперрно

Указатель на код ошибки.

**Примечание**  .  Этот параметр применяется только к функции **вспиоктл** .

## <a name="return-value"></a>Возвращаемое значение

Если операция завершается успешно, функция [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **вспиоктл** возвращает ноль.

Если операция завершается ошибкой или находится в состоянии ожидания, функция [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **Вспиоктл** возвращает **\_ ошибку сокета**.
Чтобы получить расширенные сведения об ошибке, вызовите [**всажетластеррор**](/windows/desktop/api/winsock/nf-winsock-wsagetlasterror).

| Код ошибки | Значение |
|------------|---------|
|**\_ожидается ввод-вывод WSA \_** | Выполняется перекрывающаяся операция ввода-вывода. Это значение возвращается в том случае, если операция перекрытия была успешно инициирована и ее завершение будет указано позже. |
| **\_Операция WSA \_ прервана** | Операция ввода-вывода прервана из-за завершения потока или запроса приложения. Эта ошибка возвращается, если перекрывающаяся операция была отменена из-за закрытия сокета или выполнения команды **\_ ioctl Flush суперконтроллера** ввода/вывода. |
| **всаеакцес** | Предпринята попытка доступа к сокету методом, запрещенным его разрешениями на доступ. Эта ошибка возникает при нескольких условиях для постоянных резервирований портов, которые включают следующее: у пользователя отсутствуют необходимые права администратора на локальном компьютере, или приложение не работает в расширенной оболочке как встроенное администратор ( `RunAs administrator` ). |
| **WSAEFAULT** | Система обнаружила недопустимый адрес указателя при попытке использовать аргумент указателя в вызове. Эта ошибка возвращается параметром *лпвинбуффер*, *лпваутбуффер*, *лпкббитесретурнед*, *лповерлаппед* или *лпкомплетионраутине* , который полностью не содержится в допустимой части адресного пространства пользователя. |
| **всаеинпрогресс** | В данный момент выполняется блокирующая операция. Эта ошибка возвращается, если функция вызывается при выполнении обратного вызова. |
| **всаеинтр** | Операция блокировки была прервана вызовом [**всаканцелблоккингкалл**](/windows/desktop/api/winsock2/nf-winsock2-wsacancelblockingcall). Эта ошибка возвращается в случае прерывания блокирующей операции. |
| **всаеинвал** | Указан недопустимый аргумент. Эта ошибка возвращается, если параметр *двиоконтролкоде* не является допустимой командой или указан недопустимый входной параметр, либо команда неприменима к указанному типу сокета. |
| **WSAENETDOWN** | Операция на сокете обнаружила отключение сети. Эта ошибка возвращается в случае сбоя сетевой подсистемы. |
| **всаенотсокк** | Предпринята попытка выполнить операцию для объекта, который не является сокетом. Эта ошибка возвращается, если дескриптор *s* не является сокетом. |
| **всаеопнотсупп** | Предпринятая операция не поддерживается для типа объекта, на который указывает ссылка. Эта ошибка возвращается, если указанная команда IOCTL не поддерживается. эта ошибка также возвращается, если в поставщике транспорта не поддерживается **\_ замыкание на себя с обратной связью SIO \_ FAST \_ пути** IOCTL. |

## <a name="remarks"></a>Remarks

приложение может использовать петлевой порт **SIO \_ \_ FAST \_ пути** IOCTL, чтобы уменьшить задержку и повысить производительность операций замыкания на себя на сокете TCP.
Этот запрос IOCTL запрашивает использование в стеке TCP/IP специального быстрого пути для операций замыкания на себя на этом сокете.
запрос IOCTL FAST с помощью **\_ обратного замыкания на себя \_ \_** можно использовать только с сокетами TCP.
Этот запрос IOCTL должен использоваться на обеих сторонах сеанса замыкания на себя.
Быстрый путь TCP замыкания на себя поддерживается с помощью интерфейса замыкания на себя IPv4 или IPv6.

Сокет, который планирует инициировать запрос на соединение, должен применить этот IOCTL перед выполнением запроса на соединение.
Поэтому сокет, используемый функцией [**Connect**](/windows/desktop/api/winsock2/nf-winsock2-connect), [**коннектекс**](/windows/desktop/api/mswsock/nc-mswsock-lpfn_connectex), [**всаконнект**](/windows/desktop/api/winsock2/nf-winsock2-wsaconnect), [**всаконнектбилист**](/windows/desktop/api/winsock2/nf-winsock2-wsaconnectbylist)или [**WSAConnectByName**](/windows/desktop/api/winsock2/nf-winsock2-wsaconnectbynamew) для инициации подключения, должен применить этот запрос IOCTL, чтобы использовать быстрый путь для операций замыкания на себя.

Сокет, прослушивающий запрос на соединение, должен применить этот IOCTL перед принятием подключения.
Поэтому сокет, используемый функцией Listen, должен применить этот запрос IOCTL, чтобы все принимаемые сокеты использовали быстрый путь для замыкания на себя.
Все сокеты, возвращаемые функцией Listen и передаваемые функции [**Accept**](/windows/desktop/api/winsock2/nf-winsock2-accept), [**акцептекс**](/windows/desktop/api/winsock/nf-winsock-acceptex)или [**всаакцепт**](/windows/desktop/api/winsock2/nf-winsock2-wsaaccept) , будут помечены для использования специального быстрого пути для операций замыкания на себя.

Когда приложение устанавливает подключение через интерфейс замыкания на себя, используя быстрый путь, все пакеты во время существования соединения должны использовать быстрый путь.

применение **\_ FAST замыкания контроллера SIO \_ \_** к сокету, которое будет подключено к пути, отличному от замыкания на себя, не будет действовать.

Эта оптимизация замыкания на себя TCP приводит к передаче пакетов через транспортный уровень (TL) вместо традиционных замыканий на себя через сетевой уровень.
Эта оптимизация повышает задержку для пакетов замыкания на себя.
После того как приложение перейдет в режим подключения, чтобы использовать быстрый путь замыкания на себя, все пакеты будут следовать пути замыкания на себя.
Для обратной связи, перегрузка и удаление пакетов не ожидаются.
Понятие контроля перегрузки и надежной доставки в TCP будет ненужным.
Однако это не верно для управления потоком.
Без управления потоком отправитель может перегрузить буфер приема, что приведет к ошибочному поведению TCP-сигнала.
Управление потоком в пути оптимизации замыкания на себя TCP осуществляется путем размещения запросов send в очереди.
Когда буфер Receive заполнен, стек TCP/IP гарантирует, что отправка не будет завершена до тех пор, пока очередь не будет обслуживать управление потоком.

для соединений с быстрым путем замыкания на себя по протоколу TCP при наличии вызова платформы фильтрации Windows (WFP) для данных подключения необходимо использовать неоптимизированный медленный путь для замыкания на себя.
Поэтому фильтры WFP не будут использовать этот новый быстрый путь замыкания на себя.
если фильтр WFP включен, система будет использовать этот путь, даже если был установлен параметр **\_ обратной передачи SIO \_ FAST \_ пути** IOCTL.
Это гарантирует, что приложения пользовательского режима обладают полными возможностями безопасности WFP.

по умолчанию в качестве **\_ \_ \_ пути FAST замыкания контроллера SIO** отключено.

только подмножество параметров сокета TCP/IP поддерживается при использовании **\_ обратной передачи SIO \_ FAST \_ пути** IOCTL, чтобы включить быстрый путь замыкания на сокет.
В список поддерживаемых параметров входят следующие.

* **\_срок жизни IP**
* **IP- \_ адрес рассылки, \_ Если**
* **\_Одноадресные \_ ПРЫЖКи IPv6**
* **\_Одноадресная рассылка IPv6, \_ Если**
* **\_V6ONLY IPv6**
* **Поэтому \_ условное \_ принятие**
* **Итак, \_ ексклусивеаддрусе**
* **Итак \_ , \_ масштабируемость портов**
* **Итак, \_ рквбуф**
* **Итак, \_ реусеаддр**
* **\_БСДУРЖЕНТ TCP**

## <a name="see-also"></a>См. также раздел

[**Параметры сокета IPPROTO_IP**](/windows/desktop/winsock/ipproto-ip-socket-options)

[**Параметры сокета IPPROTO_IPV6**](/windows/desktop/winsock/ipproto-ipv6-socket-options)

[**Параметры сокета IPPROTO_TCP**](/windows/desktop/winsock/ipproto-tcp-socket-options)

[**фиксатор**](/windows/desktop/api/winsock2/nf-winsock2-socket)

[**Параметры сокета SOL_SOCKET**](/windows/desktop/winsock/sol-socket-socket-options)

[**всажетластеррор**](/windows/desktop/api/winsock2/nf-winsock2-wsagetlasterror)

[**всажетоверлаппедресулт**](/windows/desktop/api/winsock2/nf-winsock2-wsagetoverlappedresult)

[**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl)

[**всаоверлаппед**](/windows/desktop/api/winsock2/ns-winsock2-wsaoverlapped)

[**всасоккета**](/windows/desktop/api/winsock2/nf-winsock2-wsasocketa)

[**всасоккетв**](/windows/desktop/api/winsock2/nf-winsock2-wsasocketw)
