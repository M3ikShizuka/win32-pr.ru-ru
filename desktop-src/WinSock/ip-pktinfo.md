---
description: Позволяет приложению включать или отключать возврат сведений о пакетах функцией Всареквмсг на сокете IPv4.
ms.assetid: C6246899-0220-4F88-B43B-CED1B1FF7DC3
title: Параметр IP_PKTINFO Socket (Ws2ipdef. h)
ms.topic: reference
ms.date: 05/31/2018
ms.openlocfilehash: 56ba653b4ece11086706493b920e1ed650b66eecdd6e788a5edfe259cf9eb9f0
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "120097794"
---
# <a name="ip_pktinfo-socket-option"></a>IP- \_ пктинфо сокета

\_Параметр сокета IP пктинфо позволяет приложению включать или отключать возврат сведений о пакетах функцией [**LPFN_WSARECVMSG (всареквмсг)**](/windows/win32/api/mswsock/nc-mswsock-lpfn_wsarecvmsg) на сокете IPv4.

Чтобы запросить состояние этого параметра сокета, вызовите функцию [**жетсоккопт**](/windows/desktop/api/winsock/nf-winsock-getsockopt) . Чтобы установить этот параметр, вызовите функцию [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) со следующими параметрами.

## <a name="socket-option-value"></a>Значение параметра сокета

Константа, представляющая этот параметр сокета, составляет 19.

## <a name="syntax"></a>Синтаксис


```C++
int getsockopt(
  (SOCKET) s,      // descriptor identifying a socket 
  (int) IPPROTO_IP,   // level
  (int) IP_PKTINFO, // optname
  (char *) optval, // output buffer,
  (int) optlen,  // size of output buffer
);
```




```C++
int setsockopt(
  (SOCKET) s,      // descriptor identifying a socket 
  (int) IPPROTO_IP,   // level
  (int) IP_PKTINFO, // optname
  (char *) optval, // input buffer,
  (int) optlen,  // size of input buffer
);
```



## <a name="parameters"></a>Параметры

<dl> <dt>

*s* \[ в\]
</dt> <dd>

Дескриптор, идентифицирующий сокет.

</dd> <dt>

*уровень* \[ окне\]
</dt> <dd>

Уровень, на котором определен параметр. Для этой операции используйте **\_ IP-адрес иппрото** .

</dd> <dt>

*optname* \[ окне\]
</dt> <dd>

Параметр сокета, для которого необходимо получить или задать значение. \_Для этой операции используйте IP-пктинфо.

</dd> <dt>

*оптвал* \[ заполняет\]
</dt> <dd>

Указатель на буфер, содержащий значение для устанавливаемого параметра. Этот параметр должен указывать на буфер, который больше или равен размеру значения **DWORD** .

Это значение рассматривается как логическое значение с 0, которое указывает **false** (отключено), и ненулевое значение, указывающее на значение **true** (включено).

</dd> <dt>

*оптлен* \[ в, out\]
</dt> <dd>

Указатель на размер (в байтах) буфера *оптвал* . Этот размер должен быть больше или равен размеру значения **DWORD** .

</dd> </dl>

## <a name="return-value"></a>Возвращаемое значение

Если операция завершается успешно, функция [**жетсоккопт**](/windows/desktop/api/winsock/nf-winsock-getsockopt) или [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) возвращает ноль.

Если операция завершается неудачно, возвращается значение ошибки СОКЕТа \_ и можно получить конкретный код ошибки, вызвав [**всажетластеррор**](/windows/desktop/api/winsock/nf-winsock-wsagetlasterror).



| Код ошибки                                                                                                                                              | Значение                                                                                                                                                                                                                                                    |
|---------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <dl> <dt>**[WSANOTINITIALISED](windows-sockets-error-codes-2.md)**</dt> </dl> | Перед использованием этой функции должен быть выполнен успешный вызов [**сбой WSAStartup**](/windows/desktop/api/winsock/nf-winsock-wsastartup) .<br/>                                                                                                                                                     |
| <dl> <dt>**[WSAENETDOWN](windows-sockets-error-codes-2.md)**</dt> </dl>             | Сбой сетевой подсистемы.<br/>                                                                                                                                                                                                               |
| <dl> <dt>**[WSAEFAULT](windows-sockets-error-codes-2.md)**</dt> </dl>                 | Один из параметров *оптвал* или *оптлен* указывает на память, которая не находится в допустимой части адресного пространства пользователя. Эта ошибка также возвращается, если значение, на которое указывает параметр *оптлен* , меньше, чем размер значения **DWORD** .<br/> |
| <dl> <dt>**[всаеинпрогресс](windows-sockets-error-codes-2.md)**</dt> </dl>       | выполняется блокировка Windows сокеты 1,1, или поставщик услуг все еще обрабатывает функцию обратного вызова.<br/>                                                                                                                            |
| <dl> <dt>**[всаеинвал](windows-sockets-error-codes-2.md)**</dt> </dl>                 | Указан недопустимый аргумент. Эта ошибка возвращается, если параметр *уровня* неизвестен или недопустим. в Windows Vista и более поздних версиях эта ошибка также возвращается, если сокет находился в переходном состоянии.<br/>                                     |
| <dl> <dt>**[всаенопротупт](windows-sockets-error-codes-2.md)**</dt> </dl>       | Параметр неизвестен или не поддерживается указанным семейством протоколов. Эта ошибка возвращается, если параметр *типа* для дескриптора сокета, переданного в параметре *s* , не **Сокк \_ дграм** или **Сокк \_ RAW**. <br/>                          |
| <dl> <dt>**[всаенотсокк](windows-sockets-error-codes-2.md)**</dt> </dl>             | Дескриптор не является сокетом.<br/>                                                                                                                                                                                                                 |



 

## <a name="remarks"></a>Remarks

Функция [**жетсоккопт**](/windows/desktop/api/winsock/nf-winsock-getsockopt) , вызываемая с \_ параметром сокета IP пктинфо, позволяет приложению определить, должны ли сведения о пакете возвращаться функцией [**LPFN_WSARECVMSG (всареквмсг)**](/windows/win32/api/mswsock/nc-mswsock-lpfn_wsarecvmsg)для сокета IPv4.

Функция [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) , вызываемая с \_ параметром сокета IP пктинфо, позволяет приложению включать или отключать возврат сведений о пакетах функцией [**LPFN_WSARECVMSG (всареквмсг)**](/windows/win32/api/mswsock/nc-mswsock-lpfn_wsarecvmsg) . Параметр IP \_ пктинфо для сокета по умолчанию отключен (имеет значение **false**).

Если этот параметр сокета включен на сокете IPv4 типа **Сокк \_ Дграм** или **сокк \_ RAW**, функция [**LPFN_WSARECVMSG (всареквмсг)**](/windows/win32/api/mswsock/nc-mswsock-lpfn_wsarecvmsg) возвращает сведения о пакете в структуре [**всамсг**](/windows/desktop/api/Ws2def/ns-ws2def-wsamsg) , на которую указывает параметр *лпмсг* . Один из объектов данных элемента управления в возвращенной структуре **всамсг** будет содержать структуру [**в \_ пктинфо**](/windows/desktop/api/Ws2ipdef/ns-ws2ipdef-in_pktinfo) , используемую для хранения полученных сведений об адресе пакета.

Для датаграмм, полученных функцией [**LPFN_WSARECVMSG (всареквмсг)**](/windows/win32/api/mswsock/nc-mswsock-lpfn_wsarecvmsg) по протоколу IPv4, элемент **управления** полученной структуры [**всамсг**](/windows/desktop/api/Ws2def/ns-ws2def-wsamsg) будет содержать структуру [**всабуф**](/windows/desktop/api/ws2def/ns-ws2def-wsabuf) , содержащую структуру **всакмсгхдр** . Элемент **\_ уровня КМСГ** этой структуры **всакмсгхдр** будет содержать **иппрото \_ IP**, член **\_ типа КМСГ** этой структуры будет содержать **IP- \_ пктинфо**, а элемент **\_ данных КМСГ** будет содержать [**в \_ пктинфо**](/windows/desktop/api/Ws2ipdef/ns-ws2ipdef-in_pktinfo) структуру, используемую для хранения полученной информации об адресе пакета IPv4. Адресом IPv4 в структуре **в \_ Пктинфо** является IPv4-адрес, с которого получен пакет.

Для сокета датаграмм с двумя стеками, если приложению требуется функция [**LPFN_WSARECVMSG (всареквмсг)**](/windows/win32/api/mswsock/nc-mswsock-lpfn_wsarecvmsg) , возвращающая сведения о пакете в структуре [**всамсг**](/windows/desktop/api/Ws2def/ns-ws2def-wsamsg) для датаграмм, полученных по протоколу IPv4, то \_ параметр сокета IP пктинфо должен быть установлен в значение true на сокете. Если только параметр [IPv6 \_ пктинфо](ipv6-pktinfo.md) имеет значение true для сокета, сведения о пакете будут предоставлены для датаграмм, полученных по протоколу IPv6, но могут не предоставляться для датаграмм, полученных по протоколу IPv4.

Если приложение пытается установить \_ параметр сокета IP пктинфо для сокета датаграмм с двойным стеком и протокол IPv4 отключен в системе, то функция [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) завершится ошибкой, а [**всажетластеррор**](/windows/desktop/api/winsock/nf-winsock-wsagetlasterror) вернет ошибку [всаеинвал](windows-sockets-error-codes-2.md). Эта же ошибка также возвращается функцией **сетсоккопт** в результате других ошибок. Если приложение пытается установить \_ параметр сокета IP-уровня иппрото на сокете с двойным стеком и завершается с помощью [всаеинвал](windows-sockets-error-codes-2.md), то приложение должно определить, отключена ли на локальном компьютере IPv4. Один из методов, который можно использовать для определения того, включен или отключен протокол IPv4, заключается в вызове функции [**Socket**](/windows/desktop/api/Winsock2/nf-winsock2-socket) с параметром *AF* , установленным в AF \_ INET для попытки и создания сокета IPv4. Если функция **сокета** завершается с ошибкой и **Всажетластеррор** возвращает ошибку [всаеафносуппорт](windows-sockets-error-codes-2.md), это означает, что протокол IPv4 не включен. В этом случае ошибка функции **сетсоккопт** при попытке установить \_ параметр сокета IP-пктинфо может быть проигнорирована приложением. В противном случае при попытке установить \_ параметр сокета IP пктинфо следует считать непредвиденной ошибкой.

Обратите внимание, что заголовочный файл *Ws2ipdef. h* автоматически включается в *Ws2tcpip. h* и никогда не должен использоваться напрямую.

## <a name="requirements"></a>Requirements (Требования)



| Требование | Значение |
|-------------------------------------|------------------------------------------------------------------------------------------------------------|
| Минимальная версия клиента<br/> | Windows \[Только классические приложения XP\]<br/>                                                                |
| Минимальная версия сервера<br/> | Windows Только для \[ настольных приложений сервера 2003\]<br/>                                                       |
| Заголовок<br/>                   | <dl> <dt>Ws2ipdef. h (включение Ws2tcpip. h)</dt> </dl> |



## <a name="see-also"></a>См. также

<dl> <dt>

[Сокеты с двумя стеками](dual-stack-sockets.md)
</dt> <dt>

[**жетсоккопт**](/windows/desktop/api/winsock/nf-winsock-getsockopt)
</dt> <dt>

[**в \_ пктинфо**](/windows/desktop/api/Ws2ipdef/ns-ws2ipdef-in_pktinfo)
</dt> <dt>

[**\_Параметры IP-сокета иппрото**](ipproto-ip-socket-options.md)
</dt> <dt>

[\_ПКТИНФО IPv6](ipv6-pktinfo.md)
</dt> <dt>

[**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt)
</dt> <dt>

[**фиксатор**](/windows/desktop/api/Winsock2/nf-winsock2-socket)
</dt> <dt>

[**всамсг**](/windows/desktop/api/Ws2def/ns-ws2def-wsamsg)
</dt> <dt>

[**LPFN_WSARECVMSG (Всареквмсг)**](/windows/win32/api/mswsock/nc-mswsock-lpfn_wsarecvmsg)
</dt> </dl>

 

 
