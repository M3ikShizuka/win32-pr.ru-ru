---
description: Необработанный сокет — это тип сокета, который обеспечивает доступ к базовому поставщику транспорта.
ms.assetid: 4cbe5505-75e7-454f-9e6b-f38bdc60bf6d
title: Необработанные сокеты TCP/IP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 34ef8600c7b1a6c1bc5b2f7b5b210ca2d56f90069b0afce88c83ca45e9cfad8f
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119733394"
---
# <a name="tcpip-raw-sockets"></a>Необработанные сокеты TCP/IP

Необработанный сокет — это тип сокета, который обеспечивает доступ к базовому поставщику транспорта. В этом разделе рассматриваются только необработанные сокеты и протоколы IPv4 и IPv6. Это связано с тем, что большинство других протоколов с исключением ATM не поддерживает необработанные сокеты. Чтобы использовать необработанные сокеты, приложение должно иметь подробную информацию об используемом базовом протоколе.

Поставщики служб Winsock для IP-протокола могут поддерживать *тип* сокета **Сокк \_ RAW**. поставщик Windows sockets 2 для TCP/IP, включенный в Windows, поддерживает этот тип **сокк \_ необработанного** сокета.

Существует два основных типа таких необработанных сокетов:

-   Первый тип использует известный тип протокола, записанный в IP-заголовке, который распознается поставщиком службы Winsock. Примером первого типа сокета является сокет для протокола ICMP (тип протокола IP = 1) или протокол ICMPv6 (IP протокола Type = 58).
-   Второй тип позволяет указать любой тип протокола. Примером второго типа будет экспериментальный протокол, который не поддерживается напрямую поставщиком службы Winsock, например протоколом передачи управления потоком (SCTP).

## <a name="determining-if-raw-sockets-are-supported"></a>Определение поддержки необработанных сокетов

Если поставщик услуг Winsock поддерживает **Сокк \_ необработанные** сокеты для \_ семейств адресов AF inet или AF \_ INET6, тип сокета **Сокк \_ RAW** должен включаться в структуру [**всапротокол \_ info**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) , возвращаемую функцией [**всаенумпротоколс**](/windows/desktop/api/Winsock2/nf-winsock2-wsaenumprotocolsa) для одного или нескольких доступных поставщиков транспорта.

Элемент **иаддрессфамили** в структуре [**\_ сведений о всапротокол**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) должен указывать AF \_ inet или AF \_ INET6, а элемент **исоккеттипе** структуры всапротокол должен **указать \_** **Сокк \_ RAW** для одного из поставщиков транспорта.

Элемент **ипротокол** структуры [**\_ info Всапротокол**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) может иметь значение **ипрото \_ IP**. Элемент **ипротокол** структуры **\_ info всапротокол** также может иметь нулевое значение, если поставщик услуг позволяет приложению использовать тип **\_ необработанного** сокета Сокк для других сетевых протоколов, отличных от протокола Интернета для семейства адресов.

Другие члены в структуре [**\_ сведений всапротокол**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) указывают другие свойства поддержки протокола для **Сокк \_ RAW** и указывают, как должен обрабатываться сокет **Сокк \_ RAW** . Эти другие члены **всапротокол \_ сведений** для **Сокк \_ RAW** обычно указывают, что протокол является бесустановленным, ориентированным на сообщения, поддерживает широковещательную или многоадресную рассылку (XP1 \_ без подключения, XP1 \_ \_ , ориентированную на сообщения, \_ поддержку поддержки XP1 \_ , а XP1 \_ поддерживает \_ бит MULTIPOINT) и может иметь максимальный размер сообщения 65 467 байт.

в Windows XP и более поздних версиях можно использовать команду *NetSh.exe* , чтобы определить, поддерживаются ли необработанные сокеты. Следующая команда из окна CMD выводит данные из каталога Winsock в консоли:

**Netsh Winsock показывать каталог**

Выходные данные будут содержать список, содержащий некоторые данные из структур [**всапротокол \_ info**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) , поддерживаемых на локальном компьютере. Найдите термин RAW/IP или RAW/IPv6 в поле Описание, чтобы найти протоколы, поддерживающие необработанные сокеты.

## <a name="creating-a-raw-socket"></a>Создание необработанного сокета

Чтобы создать сокет типа **Сокк \_ RAW**, вызовите функцию [**Socket**](/windows/desktop/api/Winsock2/nf-winsock2-socket) или [**всасоккет**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa) с параметром *AF* (семейство адресов), для которого задано значение AF \_ inet или AF \_ INET6, параметру *Type* задано значение **Сокк \_ RAW**, а параметру *протокола* задано значение требуемого номера протокола. Параметр *протокола* становится значением протокола в IP-заголовке (например, SCTP — 132).

> [!Note]  
> Приложение не может указывать нуль (0) в качестве параметра *протокола* для функций [**Socket**](/windows/desktop/api/Winsock2/nf-winsock2-socket), [**всасоккет**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa)и [**вспсоккет**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket) , если для параметра *Type* задано значение **Сокк \_ RAW**.

 

Необработанные сокеты предоставляют возможность управлять базовым транспортом, поэтому их можно использовать для вредоносных целей, представляющих угрозу безопасности. таким образом, только члены группы "администраторы" могут создавать сокеты типа сокк \_ RAW на Windows 2000 и более поздних версиях.

## <a name="send-and-receive-operations"></a>Операции отправки и получения

Когда приложение создает сокет типа **Сокк \_ RAW**, этот сокет можно использовать для отправки и получения данных. Все пакеты, отправленные или полученные на сокете типа **Сокк \_ RAW** , обрабатываются как датаграммы на неподключенном сокете.

К операциям по **Сокк \_ необработанным** сокетам применяются следующие правила.

-   Функция [**SendTo**](/windows/desktop/api/winsock/nf-winsock-sendto) или [**всасендто**](/windows/desktop/api/Winsock2/nf-winsock2-wsasendto) обычно используется для отправки данных на сокет типа **Сокк \_ RAW**. Адресом назначения может быть любой допустимый адрес в семействе адресов сокета, включая широковещательный или многоадресный адрес. Чтобы отправить широковещательный адрес, приложение должно использовать [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) с таким образом, чтобы \_ вещание было включено. В противном случае **SendTo** или **всасендто** завершится ошибкой с кодом ошибки [всаеакцес](windows-sockets-error-codes-2.md). Для IP-адреса приложение может отправить на любой адрес многоадресной рассылки (без участия в группе).
-   При отправке данных IPv4 приложение имеет возможность указать, следует ли указывать заголовок IPv4 в начале исходящей датаграммы для пакета. Если для параметра **IP- \_ хдринкл** Socket задано значение true для сокета IPv4 (семейство адресов AF \_ iNet), приложение должно предоставить заголовок IPv4 в исходящих данных для операций отправки. Если этот параметр сокета имеет значение false (значение по умолчанию), то заголовок IPv4 не должен включаться в исходящие данные для операций отправки.
-   При отправке данных IPv6 приложение имеет возможность указать, следует ли указывать заголовок IPv6 в начале исходящей датаграммы для пакета. Если параметр сокета **\_ хдринкл IPv6** имеет значение true для сокета IPv6 (семейство адресов AF \_ INET6), приложение должно предоставить заголовок IPv6 в исходящих данных для операций отправки. Значение по умолчанию для этого параметра — false. Если этот параметр сокета имеет значение false (значение по умолчанию), то заголовок IPv6 не должен включаться в исходящие данные для операций отправки. Для IPv6 не нужно включать заголовок IPv6. Если сведения доступны с помощью функций сокета, то заголовок IPv6 не следует включать, чтобы избежать проблем совместимости в будущем. Эти проблемы обсуждаются в RFC 3542, опубликованных IETF. Использование параметра сокета **\_ хдринкл IPv6** не рекомендуется и может быть устаревшим в будущем.
-   Функция [**реквфром**](/windows/desktop/api/winsock/nf-winsock-recvfrom) или [**всареквфром**](/windows/desktop/api/Winsock2/nf-winsock2-wsarecvfrom) обычно используется для получения данных на сокете типа **Сокк \_ RAW**. Обе эти функции имеют возможность вернуть исходный IP-адрес, с которого был отправлен пакет. Полученные данные — это датаграмма неподключенного сокета.
-   Для IPv4 (семейство адресов AF \_ iNet) приложение получает заголовок IP-адреса в начале каждой полученной датаграммы независимо от параметра **IP- \_ хдринкл** Socket.
-   Для IPv6 (семейство адресов AF \_ INET6) приложение получает все после последнего заголовка IPv6 в каждой полученной датаграмме независимо от параметра сокета **IPv6 \_ хдринкл** . Приложение не получает заголовки IPv6, используя необработанный сокет.
-   Полученные датаграммы копируются во все **\_ необработанные** сокеты Сокк, которые отвечают следующим условиям:

    -   Номер протокола, указанный в параметре *протокола* при создании сокета, должен соответствовать номеру протокола в IP-заголовке полученной датаграммы.
    -   Если для сокета определен локальный IP-адрес, он должен соответствовать адресу назначения, указанному в заголовке IP полученной датаграммы. Приложение может указать локальный IP-адрес, вызвав функцию [**BIND**](/windows/desktop/api/winsock/nf-winsock-bind) . Если для сокета не указан локальный IP-адрес, датаграммы копируются в сокет независимо от IP-адреса назначения в IP-заголовке полученной датаграммы.
    -   Если для сокета определен внешний адрес, он должен соответствовать адресу источника, указанному в заголовке IP полученной датаграммы. Приложение может указать внешний IP-адрес, вызвав функцию [**Connect**](/windows/desktop/api/Winsock2/nf-winsock2-connect) или [**всаконнект**](/windows/desktop/api/Winsock2/nf-winsock2-wsaconnect) . Если для сокета не указан внешний IP-адрес, датаграммы копируются в сокет независимо от IP-адреса источника в IP-заголовке полученной датаграммы.

Важно понимать, что некоторые сокеты типа **Сокк \_ RAW** могут принимать много непредусмотренных датаграмм. Например, программа PING может создать сокет типа **Сокк \_ RAW** для отправки эхо-запросов ICMP и получения ответов. Хотя приложение ожидает ответа ICMP, все остальные ICMP-сообщения (такие как узел ICMP, \_ НЕдоступные) также могут доставляться в это приложение. Кроме того, если **несколько \_ необработанных** сокетов Сокк открыты на компьютере одновременно, одни и те же датаграммы могут быть доставлены всем открытым сокетам. Приложение должно иметь механизм для распознавания интересующих датаграмм и пропускать все остальные. Для программы PING такой механизм может включать проверку IP-заголовка Received для уникальных идентификаторов в заголовке ICMP (например, идентификатор процесса приложения).

> [!Note]  
> Для использования сокета типа **Сокк \_ RAW** требуются права администратора. Пользователи, запускающие приложения Winsock, использующие необработанные сокеты, должны быть членами группы "Администраторы" на локальном компьютере, в противном случае вызовы необработанных сокетов завершатся ошибкой с кодом [всаеакцес](windows-sockets-error-codes-2.md). в Windows Vista и более поздних версиях доступ к необработанным сокетам применяется при создании сокета. в более ранних версиях Windows доступ к необработанным сокетам применяется во время других операций сокета.

 

## <a name="common-uses-of-raw-sockets"></a>Распространенные способы использования необработанных сокетов

Одним из распространенных способов использования необработанных сокетов являются приложения для устранения неполадок, требующие подробного анализа пакетов и заголовков IP. Например, необработанный сокет можно использовать с SIO \_ РКВАЛЛ ioctl, чтобы обеспечить получение сокетом всех пакетов IPv4 или IPv6, передаваемых через сетевой интерфейс. Дополнительные сведения см. в справочнике по [**SIO \_ рквалл**](/previous-versions/windows/desktop/legacy/ee309610(v=vs.85)) .

## <a name="limitations-on-raw-sockets"></a>Ограничения для необработанных сокетов

в Windows 7, Windows Vista, Windows XP с пакетом обновления 2 (sp2) и Windows XP с пакетом обновления 3 (sp3) возможность отправки трафика через необработанные сокеты ограничена несколькими способами:

-   Данные TCP не могут быть отправлены через необработанные сокеты.
-   UDP-датаграммы с недопустимым исходным адресом не могут быть отправлены через необработанные сокеты. IP-адрес источника для любой исходящей датаграммы UDP должен существовать в сетевом интерфейсе, или датаграмма удалена. Это изменение было сделано, чтобы ограничить способность вредоносного кода создавать распределенные атаки типа "отказ в обслуживании" и ограничивает возможность отправки ложных пакетов (пакетов TCP/IP с подложным исходным IP-адресом).
-   Вызов функции [**BIND**](/windows/desktop/api/winsock/nf-winsock-bind) с необработанным сокетом для \_ протокола TCP иппрото не разрешен.
    > [!Note]  
    > Функция [**BIND**](/windows/desktop/api/winsock/nf-winsock-bind) с необработанным сокетом разрешена для других протоколов ( \_ например, ИППРОТО IP, ИППРОТО \_ UDP или иппрото \_ SCTP).

     

указанные выше ограничения не относятся к Windows server 2008 R2, Windows Server 2008, Windows Server 2003 или к версиям операционной системы, предшествующим Windows XP с пакетом обновления 2 (SP2).

> [!Note]  
> реализация TCP/IP в корпорации майкрософт на Windows может открыть необработанный сокет UDP или TCP на основе указанных выше ограничений. Другие поставщики Winsock могут не поддерживать использование необработанных сокетов.

 

Существуют дополнительные ограничения для приложений, использующих сокет типа **Сокк \_ RAW**. Например, все приложения, прослушивающие конкретный протокол, получат все пакеты, полученные для этого протокола. Это может быть нежелательным для нескольких приложений, использующих протокол. Это также не подходит для высокопроизводительных приложений. чтобы избежать этих проблем, может потребоваться написать Windows драйвер сетевого протокола (драйвер устройства) для конкретного сетевого протокола. в Windows Vista и более поздних версиях Winsock Kernel (WSK) — новый интерфейс сетевого программирования, не зависящий от транспорта, может использоваться для записи драйвера сетевого протокола. в Windows Server 2003 и более ранних версиях для поддержки сетевого протокола можно написать поставщик TDI (TDI) и библиотеку DLL модуля поддержки Winsock. Затем сетевой протокол будет добавлен в каталог Winsock как поддерживаемый протокол. Это позволяет нескольким приложениям открывать сокеты для этого конкретного протокола, и драйвер устройства может контролировать, какой сокет получает определенные пакеты и ошибки. сведения о создании поставщика сетевых протоколов см. в разделах WSK и TDI в комплекте Windows Driver Kit (WDK).

Приложениям также необходимо учитывать влияние параметров брандмауэра на отправку и получение пакетов с помощью необработанных сокетов.

 

 
