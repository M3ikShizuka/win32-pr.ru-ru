---
description: Важно отличать подключение к сокету и закрытие сокета.
ms.assetid: f076b1ec-6b96-4386-8519-4728e0a2b1ff
title: Корректное завершение работы, устаревшие параметры и замыкание сокета в SPI
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 743cae48977421c08611c79053520799420e9e72
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104541578"
---
# <a name="graceful-shutdown-linger-options-and-socket-closure-in-the-spi"></a>Корректное завершение работы, устаревшие параметры и замыкание сокета в SPI

Важно отличать подключение к сокету и закрытие сокета. Завершение работы подключения через сокет включает обмен сообщениями протокола между двумя конечными точками, которые в дальнейшем называются последовательностями завершения работы. Два общих класса последовательностей завершения работы определяются: корректное и аварийное. При корректном завершении работы все данные, которые были поставлены в очередь, но еще не переданы, могут быть отправлены до закрытия соединения. При аварийном завершении работы все неотправленные данные теряются. Вхождение последовательности завершения работы (мягкое или аварийное) можно также использовать для предоставления \_ индикации закрытия для связанных приложений, указывающих на то, что выполняется завершение работы. При закрытии сокета, с другой стороны, прекращается выделение маркера сокета, чтобы приложение больше не ссылалось на сокет или не использовало его каким-либо образом.

В сокетах Windows для запуска последовательности завершения работы можно использовать как функцию [**вспшутдовн**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) , так и функцию [**вспсенддисконнект**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) , а функция [**вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) используется для освобождения дескрипторов сокетов и высвобождения связанных ресурсов. Однако иногда возникает путаница, связанная с тем, что функция **вспклосесоккет** будет неявно вызывать последовательность завершения работы, если она еще не была выполнена. На самом деле, это довольно распространенный подход к программированию, основанный на этой функции, и использовать **вспклосесоккет** для инициации последовательности завершения работы и освобождения маркера сокета.

Для упрощения этого использования интерфейс сокетов предоставляет элементы управления через механизм параметров сокета, позволяющий программисту указать, должна ли неявная или аварийная последовательность завершения работы быть ненужной, а также должна ли функция завершаться немедленно, а не завершаться немедленно), чтобы обеспечить время для корректного завершения работы.

Устанавливая соответствующие значения для параметров сокета \_ до конца и поэтому \_ донтлинжер, можно получить следующие типы поведения с помощью функции [**вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) .

-   Прерванная последовательность завершения работы, немедленное возвращение из [**вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)).
-   Корректное завершение работы, задержка возврата до завершения любой последовательности завершения или истечения указанного интервала времени. Если интервал времени истекает до завершения корректной последовательности завершения работы, происходит аварийная последовательность завершения работы и [**вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) возвращает.
-   Корректное завершение работы, возвращение немедленно и разрешение завершения последовательности завершения в фоновом режиме. Это поведение установлено по умолчанию. Однако обратите внимание, что приложение не имеет способа узнать, когда завершается последовательность корректного завершения работы.

Один из способов, который можно использовать для снижения вероятности возникновения проблем во время отключения соединения, не полагается на неявное завершение работы, инициированное [**вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)). Вместо этого используется одна из двух явных функций завершения работы ([**вспшутдовн**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) или [**вспсенддисконнект**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85))). Это, в свою очередь, приведет к тому, \_ что в одноранговом приложении будет получено уведомление о закрытии, указывающее, что все ожидающие данные получены. Чтобы проиллюстрировать это, в следующей таблице показаны функции, которые будут вызываться клиентскими и серверными компонентами приложения, где клиент отвечает за инициирование корректного завершения работы.

| На стороне клиента                                                                                                                         | На сервере                                                                                                  |
|-------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------|
| (1) вызывает [**вспшутдовн**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) (*s*, SD \_ Send), чтобы сообщить о завершении сеанса и что у клиента больше нет данных для отправки. |                                                                                                              |
|                                                                                                                                     | (2) получает демон демо- \_ Close, что указывает на выполнение корректного завершения работы и получение всех данных.        |
|                                                                                                                                     | (3) отправка оставшихся данных ответа.                                                                       |
| (5) получает данные о \_ чтении и вызове onrecv для получения данных ответа, отправленных сервером.                                                         | (4) вызывает [**вспшутдовн**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85))(*s*, SD \_ Send), чтобы указать серверу, что больше нет данных для отправки. |
| (5) получает \_ уведомление о закрытии демона.                                                                                                  | (4) вызывает [ **вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))                                                      |
| (6) вызывает [ **вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))                                                                              |                                                                                                              |



 

Последовательность времени сохраняется на шаге (1) к шагу (6) между клиентом и сервером. за исключением шагов (4) и (5), которые имеют только местное значение времени в том смысле, что шаг (5) соответствует шагу (5) на стороне клиента, а шаг (4) соответствует шагу (4) на стороне сервера без отношения времени с удаленной стороной.

 

 
