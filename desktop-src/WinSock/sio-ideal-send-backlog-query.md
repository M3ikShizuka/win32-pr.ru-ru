---
description: Код элемента управления извлекает оптимальное значение невыполненной работы по отправке для базового соединения.
ms.assetid: 03fe964b-26f7-4af7-83bf-62cc877d01a8
title: Код элемента управления SIO_IDEAL_SEND_BACKLOG_QUERY
ms.topic: reference
ms.date: 05/20/2019
req.target-min-winverclnt: Windows Vista [desktop apps only]
req.target-min-winversvr: Windows Server 2008 [desktop apps only]
api_location:
- mstcpip.h
ms.openlocfilehash: 440e42477a8939a62eeb84b800c0fd8feead5aab
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105719626"
---
# <a name="sio_ideal_send_backlog_query-control-code"></a>Код элемента управления SIO_IDEAL_SEND_BACKLOG_QUERY

## <a name="description"></a>Описание

Управляющий код для **\_ \_ \_ \_ запроса невыполненной работы SIO** получает оптимальное значение невыполненной отправки (ISB) для базового соединения.

Чтобы выполнить эту операцию, вызовите функцию [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **вспиоктл** со следующими параметрами.

```cpp
int WSAIoctl(
  (socket) s,             // descriptor identifying a socket
  SIO_IDEAL_SEND_BACKLOG_QUERY, // dwIoControlCode
  NULL,                         // lpvInBuffer
  0,                            // cbInBuffer
  (LPVOID) lpvOutBuffer,         // output buffer
  (DWORD) cbOutBuffer,       // size of output buffer
  (LPDWORD) lpcbBytesReturned,    // number of bytes returned
  (LPWSAOVERLAPPED) lpOverlapped,   // OVERLAPPED structure
  (LPWSAOVERLAPPED_COMPLETION_ROUTINE) lpCompletionRoutine,  // completion routine
);
```

```cpp
int WSPIoctl(
  (socket) s,             // descriptor identifying a socket
  SIO_IDEAL_SEND_BACKLOG_QUERY, // dwIoControlCode
  NULL,                         // lpvInBuffer
  0,                            // cbInBuffer
  (LPVOID) lpvOutBuffer,         // output buffer
  (DWORD) cbOutBuffer,       // size of output buffer
  (LPDWORD) lpcbBytesReturned,    // number of bytes returned
  (LPWSAOVERLAPPED) lpOverlapped,   // OVERLAPPED structure
  (LPWSAOVERLAPPED_COMPLETION_ROUTINE) lpCompletionRoutine,  // completion routine
  (LPWSATHREADID) lpThreadId,   // a WSATHREADID structure
  (LPINT) lpErrno   // a pointer to the error code.
);
```

## <a name="parameters"></a>Параметры

### <a name="s"></a>s

Дескриптор, идентифицирующий сокет.

### <a name="dwiocontrolcode"></a>двиоконтролкоде

Управляющий код для операции.
Используйте **оптимальный для этой операции \_ \_ \_ \_ запрос на отработку невыполненной работы по SIO** .

### <a name="lpvinbuffer"></a>лпвинбуффер

Указатель на входной буфер.
Этот параметр не используется для этой операции.

### <a name="cbinbuffer"></a>кбинбуффер

Размер входного буфера в байтах.
Этот параметр не используется для этой операции.

### <a name="lpvoutbuffer"></a>лпваутбуффер

Указатель на выходной буфер.
Этот параметр должен указывать на тип данных **ulong** , если параметры *лповерлаппед* и *лпкомплетионраутине* имеют **значение NULL**.

### <a name="cboutbuffer"></a>кбаутбуффер

Размер выходного буфера в байтах.
Этот параметр должен быть не меньше размера типа данных **ulong** .

### <a name="lpcbbytesreturned"></a>лпкббитесретурнед

Указатель на переменную, которая получает размер данных, хранящихся в выходном буфере, в байтах.

Если выходной буфер слишком мал, вызов завершается ошибкой, [**всажетластеррор**](/windows/desktop/api/winsock/nf-winsock-wsagetlasterror) возвращает [**всаеинвал**](windows-sockets-error-codes-2.md), а параметр *лпкббитесретурнед* указывает на значение **DWORD** , равное нулю.

Если *лповерлаппед* имеет значение **null**, то значение **DWORD** , на которое указывает параметр *лпкббитесретурнед* , возвращаемое при успешном вызове, не может быть нулевым.

Если параметр *лповерлаппед* имеет значение, отличное от **null** , для перекрывающихся сокетов, то операции, которые не могут быть выполнены немедленно, будут инициированы, а завершение будет указано позже.
Значение **DWORD** , на которое указывает возвращаемый параметр *лпкббитесретурнед* , может быть равно нулю, так как размер хранимых данных не может быть определен до завершения операции перекрытия.
Окончательное состояние завершения можно получить, если при выполнении операции будет получен сигнал о соответствующем методе завершения.

### <a name="lpvoverlapped"></a>лпвоверлаппед

Указатель на структуру [**всаоверлаппед**](/windows/desktop/api/winsock2/ns-winsock2-wsaoverlapped) .

Если *сокеты были созданы* без атрибута OVERLAPPED, параметр *лповерлаппед* игнорируется.

Если *конструктор* был открыт с атрибутом OVERLAPPED и параметр *Лповерлаппед* не равен **null**, операция выполняется как перекрытый (асинхронная) операция.
В этом случае параметр *лповерлаппед* должен указывать на допустимую структуру [**всаоверлаппед**](/windows/desktop/api/winsock2/ns-winsock2-wsaoverlapped) .

Для операций с перекрытием функция [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **вспиоктл** возвращает значение немедленно, и соответствующий метод завершения получает сигнал о завершении операции.
В противном случае функция не возвращает значение до тех пор, пока операция не будет завершена или произойдет ошибка.

### <a name="lpcompletionroutine"></a>лпкомплетионраутине

Тип: \_ In_opt \_ [ **LPWSAOVERLAPPED_COMPLETION_ROUTINE**](/windows/win32/api/winsock2/nc-winsock2-lpwsaoverlapped_completion_routine)

Указатель на подпрограммы завершения, вызываемую при завершении операции (игнорируется для сокетов без перекрытия).

### <a name="lpthreadid"></a>лпсреадид

Указатель на структуру [**всасреадид**](/windows/desktop/api/ws2spi/ns-ws2spi-wsathreadid) , которая будет использоваться поставщиком при последующем вызове [**впукуеуеапк**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuqueueapc).
Поставщик должен хранить указанную [**всасреадид**](/windows/desktop/api/ws2spi/ns-ws2spi-wsathreadid) структуру (а не указатель на то же значение) до тех пор, пока функция [**впукуеуеапк**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuqueueapc) не вернет значение.

**Примечание**  .  Этот параметр применяется только к функции **вспиоктл** .

### <a name="lperrno"></a>лперрно

Указатель на код ошибки.

**Примечание**  .  Этот параметр применяется только к функции **вспиоктл** .

## <a name="return-value"></a>Возвращаемое значение

Если операция завершается успешно, функция [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **вспиоктл** возвращает ноль.

Если операция завершается ошибкой или находится в состоянии ожидания, функция [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **Вспиоктл** возвращает **\_ ошибку сокета**.
Чтобы получить расширенные сведения об ошибке, вызовите [**всажетластеррор**](/windows/desktop/api/winsock/nf-winsock-wsagetlasterror).

| Код ошибки | Значение |
|------------|---------|
| **\_ожидается ввод-вывод WSA \_** | Операция перекрытия успешно инициирована, и ее завершение будет указано позже. |
| **\_Операция WSA \_ прервана** | Перекрывающаяся операция была отменена из-за закрытия сокета или выполнения команды ioctl **\_ flush суперконтроллера** ввода/вывода. |
| **WSAEFAULT** | Параметр *лпвинбуффер*, *лпваутбуффер*, *лпкббитесретурнед*, *лповерлаппед* или *лпкомплетионраутине* не полностью содержится в допустимой части адресного пространства пользователя. |
| **всаеинпрогресс** | Функция вызывается при выполнении обратного вызова. |
| **всаеинтр** | Операция блокирования была прервана. |
| **всаеинвал** | Параметр *двиоконтролкоде* не является допустимой командой, или указан недопустимый входной параметр, либо команда неприменима к указанному типу сокета. Эта ошибка возвращается, если параметр *кбаутбуффер* меньше, чем размер типа данных **ulong** .
| **WSAENETDOWN** | Сбой сетевой подсистемы. |
| **всаенопротупт** | Параметр сокета не поддерживается для указанного протокола. |
| **WSAENOTCONN** | Сокеты не подключены. |
| **всаенотсокк** | Дескриптор *s* не является сокетом. |
| **всаеопнотсупп** | Указанная команда IOCTL не поддерживается. Эта ошибка возникает, если поставщик транспорта не поддерживает запрос IOCTL для **\_ \_ \_ невыполненной работы \_ SIO** . Эта ошибка также возвращается при попытке использовать запрос IOCTL для **\_ оптимального \_ \_ \_ запроса невыполненной работы по отправке** через сокет датаграмм. |

## <a name="remarks"></a>Комментарии

В Windows Server 2008, Windows Vista с пакетом обновления 1 (SP1) и более поздних версиях операционной системы поддерживается запрос IOCTL для **\_ оптимального использования \_ \_ \_ запросов на отработку SIO** .

При отправке данных через TCP-соединение с помощью сокетов Windows важно обеспечить достаточное количество необработанных данных (отправленных, но еще не подтвержденных) в TCP для достижения максимальной пропускной способности.
Оптимальное значение объема данных, необходимых для достижения наилучшей пропускной способности для подключения TCP, называется идеальным размером невыполненной отправки (ISB).
Значение ISB является функцией произведения задержки пропускной способности подключения TCP и полученного окна приема получателя (а также частично перегрузки в сети).

Значение ISB для каждого подключения доступно в реализации протокола TCP в Windows Server 2008, Windows Vista с пакетом обновления 1 (SP1) и более поздних версиях операционной системы.
**\_ Оптимальный \_ \_ \_ запрос на отработку невыполненной работы по отправке SIO** может использоваться приложением для получения уведомления при динамическом изменении значения ISB для соединения.

В Windows Server 2008, Windows Vista с пакетом обновления 1 (SP1) и более поздних версиях операционной системы для ориентированных на поток сокетов, находящихся в подключенном состоянии, поддерживается [**\_ \_ \_ \_ изменение невыполненной работы SIO**](sio-ideal-send-backlog-change.md) и **\_ оптимальный \_ \_ \_ запрос на отработку невыполненной** работы.

Диапазон значений ISB для TCP-соединения теоретически может иметь размер от 0 до 16 мегабайт.

Обычное [**\_ \_ \_ \_ изменение невыполненной работы суперконтроллера**](sio-ideal-send-backlog-change.md) ввода-вывода **и \_ оптимальный \_ \_ запрос на отработку невыполненной работы по \_ запросу** ioctl основаны на методе Send, используемом приложениями.
Обсуждаются два распространенных варианта.

Приложения, выполняющие один блокирующий или неблокирующий запрос на отправку, обычно полагаются на внутреннюю буферизацию отправки через Winsock для достижения достаточной пропускной способности.
Ограничение буфера отправки для данного соединения управляется параметром **\_ сндбуф** Socket.
Для блокирующего и неблокирующего метода Send ограничение буфера отправки определяет, сколько данных остается в TCP.
Если значение ISB для соединения превышает предел буфера отправки, то пропускная способность соединения не будет оптимальной.
Чтобы повысить пропускную способность, приложения могут установить ограничение буфера отправки на основе результата запроса ISB, так как в соединении происходят уведомления об изменениях ISB.

Для приложений, использующих перекрывающиеся методы отправки с несколькими ожидающими запросами на отправку, объем данных, оставшихся в TCP, определяется ограничением буфера отправки в Winsock и общим объемом данных, содержащихся в необработанных перекрывающихся запросах Send.
В этом случае приложения должны использовать значение ISB, чтобы определить, сколько необработанных запросов на отправку следует хранить, и каков размер данных для каждого запроса на отправку.
В идеале приложение должно попытаться удовлетворить следующее уравнение:

`ISB value == send buffer limit + (number of simultaneous overlapped send requests * data length per send request)`

Обратите внимание на то, что использование функции ISB IOCTL через TCP-сокеты в приведенном выше случае может привести к увеличению использования памяти в Exchange для повышения пропускной способности при подключении с высокой пропускной способностью.
Реализация TCP в Windows будет регулировать значения ISB по мере необходимости на основе общего использования системной памяти.

**\_ Оптимальный \_ \_ \_ запрос на отработку невыполненной работы по отправке суперконтроллера** ввода-вывода разрешен только для сокета потока, который находится в подключенном состоянии.
В противном случае функция [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **вспиоктл** завершится с ошибкой **всаенотконн**.

Любой запрос IOCTL может блокироваться неограниченно в зависимости от реализации поставщика услуг.
Если приложение не допускает блокировку в вызове функции [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **вспиоктл** , перекрывающиеся операции ввода-вывода будут рекомендованы для ioctl, которые, скорее всего, блокируются.

**\_ Наилучший \_ \_ \_ запрос на отработку невыполненной работы по отправке SIO** , скорее всего, не блокируется, поэтому он обычно вызывается синхронно с параметрами *Лповерлаппед* и *лпкомплетионраутине* , установленными в **null**.

**\_ Наилучший \_ запрос на \_ \_ отработку отказа при отправке запросов** ioctl может завершиться сбоем, если операция **всаеинтр** или **WSA \_ \_ прервана** в следующих случаях:

Подключение TCP корректно отключается в направлении отправки.
Это может произойти в результате вызова функции Shutdown с тем, как для параметра установлено значение **SD \_ Send**, вызов функции **Дисконнектекс** или вызов функции **TransmitFile** или **трансмитпаккетс** с параметром *DwFlags* , для которого задано значение **tf \_ Disconnect** или **tf \_ reмногократного использования**.
Подключение TCP сброшено или прервано.
Запрос отменяется диспетчером ввода-вывода.

Две встроенные функции-оболочки для этих IOCTL определены в файле заголовка *Ws2tcpip. h* .
Рекомендуется использовать эти встроенные функции вместо того, чтобы использовать [**\_ оптимальное \_ \_ \_ изменение невыполненной работы SIO**](sio-ideal-send-backlog-change.md) и **\_ \_ \_ невыполненную \_** работу по запросу IOCTL.

Встроенная функция-оболочка для [**\_ идеального \_ \_ \_ изменения невыполненной работы по отправке SIO**](sio-ideal-send-backlog-change.md) — функция **идеалсендбакклогнотифи** .

Встроенная функция-оболочка для **\_ \_ \_ \_ запроса на отработку невыполненной работы суперконтроллера** ввода-вывода с помощью ioctl — это функция **идеалсендбакклогкуери** .

Динамическая отправка буфера для протокола TCP была добавлена в Windows 7 и Windows Server 2008 R2.
По умолчанию динамическая буферизация отправки для TCP включена, если только приложение не задает для сокета потока параметр **so \_ сндбуф** .

Использование Netsh — это рекомендуемый метод для запроса или настройки динамической буферизации отправки для TCP.

Текущее значение для динамической буферизации отправки для TCP можно получить с помощью следующей команды:

`netsh winsock show autotuning`

Динамическую буферизацию отправки для TCP можно отключить с помощью следующей команды:

`netsh winsock set autotuning off`

Динамическую буферизацию отправки для TCP можно включить с помощью следующей команды:

`netsh winsock set autotuning on`

Хотя это не рекомендуется, можно отключить буферизацию динамической отправки из приложения, задав для следующего параметра реестра значение 0:

`HKEY_LOCAL_MACHINE\SYSTEM\Current Control Set\Services\AFD\Parameters\DynamicSendBufferDisable`

При изменении значения для динамической буферизации отправки с помощью NetSh.exe или изменения значения реестра компьютер должен быть перезагружен, чтобы изменения вступили в силу.

Благодаря динамической буферизации отправки в Windows 7 и Windows Server 2008 R2 использование оптимальных запросов на [**\_ \_ \_ отработку невыполненной работы \_**](sio-ideal-send-backlog-change.md) и **\_ \_ \_ \_ запроса на отработку невыполненной работы** SIO требуется только в особых обстоятельствах.

## <a name="see-also"></a>См. также раздел

[**SIO_IDEAL_SEND_BACKLOG_CHANGE**](sio-ideal-send-backlog-change.md)

[**фиксатор**](/windows/desktop/api/winsock2/nf-winsock2-socket)

[**всажетластеррор**](/windows/desktop/api/winsock/nf-winsock-wsagetlasterror)

[**всажетоверлаппедресулт**](/windows/desktop/api/winsock2/nf-winsock2-wsagetoverlappedresult)

[**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl)

[**всаоверлаппед**](/windows/desktop/api/winsock2/ns-winsock2-wsaoverlapped)

[**всасоккета**](/windows/desktop/api/winsock2/nf-winsock2-wsasocketa)

[**всасоккетв**](/windows/desktop/api/winsock2/nf-winsock2-wsasocketw)
