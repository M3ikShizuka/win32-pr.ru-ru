---
description: Предназначен для того, чтобы приложение решило принимать входящие подключения через сокет прослушивания.
ms.assetid: 964683eb-5dfc-4441-abb7-315be8b89a19
title: Параметр SO_CONDITIONAL_ACCEPT Socket (Ws2def. h)
ms.topic: reference
ms.date: 05/31/2018
ms.openlocfilehash: badfdd1f8aac49ae05fa6b77dadb2561ba5ea02f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105702734"
---
# <a name="so_conditional_accept-socket-option"></a>Поэтому \_ Условный \_ вариант принятия сокета

Вариант **\_ условного \_ приема** сокета позволяет приложению решить, принимать ли входящее подключение через сокет прослушивания.

## <a name="socket-option-value"></a>Значение параметра сокета

Константа, представляющая этот параметр сокета, — 0x3002.

## <a name="syntax"></a>Синтаксис


```C++
int setsockopt(
  (SOCKET) s,      // descriptor identifying a socket 
  (int) SOL_SOCKET,   // level
  (int) SO_CONDITIONAL_ACCEPT, // optname
  (char *) optval,         // input buffer,
  (int) optlen,       // size of input buffer
);
```



## <a name="parameters"></a>Параметры

<dl> <dt>

*s* \[ в\]
</dt> <dd>

Дескриптор, идентифицирующий сокет.

</dd> <dt>

*уровень* \[ окне\]
</dt> <dd>

Уровень, на котором определен параметр. Для выполнения этой операции используйте **\_ сокет Sol** .

</dd> <dt>

*optname* \[ окне\]
</dt> <dd>

Параметр сокета, для которого задается значение. Используйте для этой операции **\_ условное \_ принятие** .

</dd> <dt>

*оптвал* \[ заполняет\]
</dt> <dd>

Указатель на буфер, содержащий значение для устанавливаемого параметра. Этот параметр должен указывать на буфер, который больше или равен размеру значения **DWORD** .

Это значение рассматривается как логическое значение с 0, которое указывает **false** (отключено), и ненулевое значение, указывающее на значение **true** (включено).

</dd> <dt>

*оптлен* \[ в, out\]
</dt> <dd>

Указатель на размер (в байтах) буфера *оптвал* . Этот размер должен быть больше или равен размеру значения **DWORD** .

</dd> </dl>

## <a name="return-value"></a>Возвращаемое значение

Если операция завершается успешно, [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) возвращает ноль.

Если операция завершается неудачно, возвращается значение ошибки СОКЕТа \_ и можно получить конкретный код ошибки, вызвав [**всажетластеррор**](/windows/desktop/api/winsock/nf-winsock-wsagetlasterror).



| Код ошибки                                                                                                                                              | Значение                                                                                                                                                                                                                                                    |
|---------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <dl> <dt>**[WSANOTINITIALISED](windows-sockets-error-codes-2.md)**</dt> </dl> | Перед использованием этой функции должен быть выполнен успешный вызов [**сбой WSAStartup**](/windows/desktop/api/winsock/nf-winsock-wsastartup) .<br/>                                                                                                                                                     |
| <dl> <dt>**[WSAENETDOWN](windows-sockets-error-codes-2.md)**</dt> </dl>             | Сбой сетевой подсистемы.<br/>                                                                                                                                                                                                               |
| <dl> <dt>**[WSAEFAULT](windows-sockets-error-codes-2.md)**</dt> </dl>                 | Один из параметров *оптвал* или *оптлен* указывает на память, которая не находится в допустимой части адресного пространства пользователя. Эта ошибка также возвращается, если значение, на которое указывает параметр *оптлен* , меньше, чем размер значения **DWORD** .<br/> |
| <dl> <dt>**[всаеинпрогресс](windows-sockets-error-codes-2.md)**</dt> </dl>       | Выполняется блокировка вызова Windows Sockets 1,1, или поставщик услуг все еще обрабатывает функцию обратного вызова.<br/>                                                                                                                            |
| <dl> <dt>**[всаеинвал](windows-sockets-error-codes-2.md)**</dt> </dl>                 | Неизвестный или недопустимый параметр *уровня* . Эта ошибка также возвращается, если сокет уже находится в состоянии прослушивания.<br/>                                                                                                                        |
| <dl> <dt>**[всаенопротупт](windows-sockets-error-codes-2.md)**</dt> </dl>       | Параметр неизвестен или не поддерживается указанным семейством протоколов.<br/>                                                                                                                                                                          |
| <dl> <dt>**[всаенотсокк](windows-sockets-error-codes-2.md)**</dt> </dl>             | Дескриптор не является сокетом.<br/>                                                                                                                                                                                                                 |



 

## <a name="remarks"></a>Комментарии

Функция [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) , вызываемая с применением **\_ условного \_** сокета Accept, позволяет приложению решить, принимать ли входящие подключения через сокет прослушивания. Параметр условного принятия для сокета по умолчанию отключен (имеет значение **false**).

Если этот параметр сокета включен, стек TCP не принимает подключения автоматически. Он ожидает, когда приложение покажет, что оно принимает подключение с помощью условного обратного вызова Accept, зарегистрированного с помощью функции [**всаакцепт**](/windows/desktop/api/Winsock2/nf-winsock2-wsaaccept) . После получения запроса на подключение Winsock вызывает условный обратный вызов accept, зарегистрированный приложением. Только если условный обратный вызов accept возвращает значение **CF \_ Accept** , будет уведомлять транспорт о необходимости полного принятия подключения.

Если для параметра **so \_ условного \_ приема** сокета задано значение включено (значение **true**), это имеет несколько побочных эффектов для сокета:

-   Это приведет к отключению встроенной защиты от атак SYN стека TCP, так как теперь приложение принимает владение для приема подключений.
-   Это эффективно отключает журнал ожидания прослушивания, так как соединения не принимаются от имени прослушивающего сокета. Соединение никогда не будет полностью принято до тех пор, пока приложение не полностью примет использование механизма **\_ разпринятия CF** .
-   Это также означает, что приложение всегда должно находиться в состоянии, чтобы вы быстро обрабатывал обратные вызовы Accept для принятия подключения. Если приложение занято выполнением другой обработки, то на стороне клиента может истекает время ожидания, прежде чем приложение действительно примет подключение. Это ведет к плохому интерфейсу клиента.

Как правило, основная причина, по которой приложения используют условное принятие, — проверка исходного IP-адреса или порта, используемого подключающимся клиентом, а затем принятие решения о принятии или отклонении подключения. Однако приложения, скорее всего, будут работать лучше, если \_ \_ не включен условный вариант принятия, и приложение разрешит работу стека TCP и невыполненной работы в ожидании. Затем, когда приложение обрабатывает принятое подключение, если оно имеет неверный IP-адрес или порт источника, приложение может просто закрыть сокет. Недостаток безопасности этого поведения заключается в том, что теперь клиент подтвердил, что приложение прослушивает IP-адрес и порт, так как он принудительно закрыл ранее принятое подключение. Тем не менее недостатками является включение **\_ условного \_ принятия, что** обычно перевешивает это ограничение.

Функция [**жетсоккопт**](/windows/desktop/api/winsock/nf-winsock-getsockopt) , вызываемая с применением **\_ условного \_** сокета Accept, позволяет приложению получить текущее состояние условного приема, хотя эта функция обычно не используется. Если приложению необходимо включить условное применение в сокете, оно просто вызывает функцию [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) , чтобы включить параметр.

Обратите внимание, что файл заголовка *Ws2def. h* автоматически включается в *Winsock2. h* и никогда не должен использоваться напрямую.

## <a name="requirements"></a>Требования



| Требование | Значение |
|-------------------------------------|----------------------------------------------------------------------------------------------------------|
| Минимальная версия клиента<br/> | Только для \[ классических приложений Windows Vista\]<br/>                                                           |
| Минимальная версия сервера<br/> | \[Только для настольных приложений Windows Server 2008\]<br/>                                                     |
| Header<br/>                   | <dl> <dt>Ws2def. h (включение Winsock2. h)</dt> </dl> |



## <a name="see-also"></a>См. также раздел

<dl> <dt>

[**жетсоккопт**](/windows/desktop/api/winsock/nf-winsock-getsockopt)
</dt> <dt>

[**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt)
</dt> <dt>

[**всаакцепт**](/windows/desktop/api/Winsock2/nf-winsock2-wsaaccept)
</dt> </dl>

 

 




