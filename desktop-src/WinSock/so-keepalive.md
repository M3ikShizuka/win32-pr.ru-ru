---
description: Разрабатывается, чтобы приложение позволяло использовать пакеты проверки активности для подключения через сокет.
ms.assetid: d6da7761-7a09-4c91-9737-550590a773b3
title: Параметр SO_KEEPALIVE Socket (Ws2def. h)
ms.topic: reference
ms.date: 05/31/2018
ms.openlocfilehash: 2d3590b8813f584aad16896a5b990baa2e3ad5607b76a13bd987d87961ee5f6f
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "120097474"
---
# <a name="so_keepalive-socket-option"></a>SO, \_ параметр сокета KeepAlive

**Таким образом \_** , параметр сокета KeepAlive позволяет приложению включить пакеты проверки активности для подключения через сокет.

Чтобы запросить состояние этого параметра сокета, вызовите функцию [**жетсоккопт**](/windows/desktop/api/winsock/nf-winsock-getsockopt) . Чтобы установить этот параметр, вызовите функцию [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) со следующими параметрами.

## <a name="socket-option-value"></a>Значение параметра сокета

Константа, представляющая этот параметр сокета, — 0x0008.

## <a name="syntax"></a>Синтаксис


```C++
int getsockopt(
  (SOCKET) s,      // descriptor identifying a socket 
  (int) SOL_SOCKET,   // level
  (int) SO_KEEPALIVE, // optname
  (char *) optval, // output buffer,
  (int) optlen,  // size of output buffer
);
```




```C++
int setsockopt(
  (SOCKET) s,      // descriptor identifying a socket 
  (int) SOL_SOCKET,   // level
  (int) SO_KEEPALIVE, // optname
  (char *) optval, // input buffer,
  (int) optlen,  // size of input buffer
);
```



## <a name="parameters"></a>Параметры

<dl> <dt>

*s* \[ в\]
</dt> <dd>

Дескриптор, идентифицирующий сокет.

</dd> <dt>

*уровень* \[ окне\]
</dt> <dd>

Уровень, на котором определен параметр. Для выполнения этой операции используйте **\_ сокет Sol** .

</dd> <dt>

*optname* \[ окне\]
</dt> <dd>

Параметр сокета, для которого задается значение. Используйте для этой операции **\_ KeepAlive** .

</dd> <dt>

*оптвал* \[ заполняет\]
</dt> <dd>

Указатель на буфер, содержащий значение для устанавливаемого параметра. Этот параметр должен указывать на буфер, который больше или равен размеру значения **DWORD** .

Это значение рассматривается как логическое значение с 0, которое указывает **false** (отключено), и ненулевое значение, указывающее на значение **true** (включено).

</dd> <dt>

*оптлен* \[ в, out\]
</dt> <dd>

Указатель на размер (в байтах) буфера *оптвал* . Этот размер должен быть больше или равен размеру значения **DWORD** .

</dd> </dl>

## <a name="return-value"></a>Возвращаемое значение

Если операция завершается успешно, [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) возвращает ноль.

Если операция завершается неудачно, возвращается значение ошибки СОКЕТа \_ и можно получить конкретный код ошибки, вызвав [**всажетластеррор**](/windows/desktop/api/winsock/nf-winsock-wsagetlasterror).



| Код ошибки                                                                                                                                              | Значение                                                                                                                                                                                                                                                    |
|---------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <dl> <dt>**[WSANOTINITIALISED](windows-sockets-error-codes-2.md)**</dt> </dl> | Перед использованием этой функции должен быть выполнен успешный вызов [**сбой WSAStartup**](/windows/desktop/api/winsock/nf-winsock-wsastartup) .<br/>                                                                                                                                                     |
| <dl> <dt>**[WSAENETDOWN](windows-sockets-error-codes-2.md)**</dt> </dl>             | Сбой сетевой подсистемы.<br/>                                                                                                                                                                                                               |
| <dl> <dt>**[WSAEFAULT](windows-sockets-error-codes-2.md)**</dt> </dl>                 | Один из параметров *оптвал* или *оптлен* указывает на память, которая не находится в допустимой части адресного пространства пользователя. Эта ошибка также возвращается, если значение, на которое указывает параметр *оптлен* , меньше, чем размер значения **DWORD** .<br/> |
| <dl> <dt>**[всаеинпрогресс](windows-sockets-error-codes-2.md)**</dt> </dl>       | выполняется блокировка Windows сокеты 1,1, или поставщик услуг все еще обрабатывает функцию обратного вызова.<br/>                                                                                                                            |
| <dl> <dt>**[всаеинвал](windows-sockets-error-codes-2.md)**</dt> </dl>                 | Неизвестный или недопустимый параметр *уровня* . в Windows Vista и более поздних версиях эта ошибка также возвращается, если сокет находился в переходном состоянии.<br/>                                                                                                 |
| <dl> <dt>**[всаенопротупт](windows-sockets-error-codes-2.md)**</dt> </dl>       | Параметр неизвестен или не поддерживается указанным семейством протоколов. Эта ошибка возвращается, если дескриптор сокета, переданный в параметре *s* , был для сокета датаграммы.<br/>                                                                   |
| <dl> <dt>**[всаенотсокк](windows-sockets-error-codes-2.md)**</dt> </dl>             | Дескриптор не является сокетом.<br/>                                                                                                                                                                                                                 |



 

## <a name="remarks"></a>Remarks

Функция [**жетсоккопт**](/windows/desktop/api/winsock/nf-winsock-getsockopt) , вызываемая с поддержкой протокола **so \_** , позволяет приложению получить текущее состояние параметра KeepAlive, хотя эта функция обычно не используется. Если приложению необходимо включить пакеты KeepAlive на сокете, оно просто вызывает функцию [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) , чтобы включить параметр.

Функция [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) , вызванная с параметром сокета **\_ KeepAlive** , позволяет приложению включить пакеты поддержания активности для подключения через сокет. Параметр **so \_ KeepAlive** для сокета по умолчанию отключен (имеет значение **false**).

Если этот параметр сокета включен, стек TCP отправляет пакеты проверки активности, когда для подключения не были получены пакеты данных или подтверждения в течение интервала. Дополнительные сведения о параметре проверки активности см. в разделе 4.2.3.6 ( *требования для узлов Интернета) — уровни взаимодействия* , указанные в RFC 1122, доступны на [веб-сайте IETF](https://www.ietf.org/rfc/rfc1122.txt). (Этот ресурс может быть доступен только на английском языке.)

Поэтому параметр сокета **\_ KeepAlive** действителен только для протоколов, которые поддерживают понятие поддержания активности (протоколы, ориентированные на подключение). Для TCP время ожидания проверки активности по умолчанию составляет 2 часа, а интервал проверки активности равен 1 секунде. Количество зондов проверки активности по умолчанию зависит от версии Windows.

Управляющий код [**\_ \_ Валс поддержки SIO**](/previous-versions/windows/desktop/legacy/dd877220(v=vs.85)) может использоваться для включения или отключения проверки активности и настройки времени ожидания и интервала для одного соединения. Если для проверки активности включена поддержка поддержания **активности \_ , то** параметры TCP по умолчанию используются для времени ожидания проверки активности и интервала, если эти значения не были изменены с помощью **SIO \_ KeepAlive \_ Валс**.

Значение времени ожидания проверки активности по умолчанию для всей системы может быть управляемым с помощью параметра реестра [KeepAliveTime](/previous-versions/windows/it-pro/windows-server-2003/cc782936(v=ws.10)) , который принимает значение в миллисекундах. Значение интервала проверки активности по умолчанию может быть управляемым с помощью параметра реестра [keepAliveInterval](/previous-versions/windows/it-pro/windows-server-2003/cc758083(v=ws.10)) , который принимает значение в миллисекундах.

в Windows Vista и более поздних версиях количество проверок активности (повторных передач данных) устанавливается равным 10 и не может быть изменено.

в Windows Server 2003, Windows XP и Windows 2000 значение по умолчанию для параметра число зондов проверки активности равно 5. Количество зондов проверки активности может быть управляемым с помощью параметров реестра [TcpMaxDataRetransmissions](/previous-versions/windows/it-pro/windows-server-2003/cc780586(v=ws.10)) и [пптпткпмаксдатаретрансмиссионс](/previous-versions/windows/it-pro/windows-server-2003/cc775408(v=ws.10)) . Число зондов проверки активности устанавливается равным большему из двух значений раздела реестра. Если это число равно 0, зонды проверки активности не будут отправляться. Если это число превышает 255, то оно корректируется на 255.

в Windows Vista и более поздних версиях параметр **SO \_ KEEPALIVE** socket можно задать только с помощью функции [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) , если сокет находится в известном состоянии, а не в переходном состоянии. Для протокола TCP значение параметра сокета **\_ KeepAlive** должно быть установлено перед вызовом функции Connect ([**Connect**](/windows/desktop/api/Winsock2/nf-winsock2-connect), [**Коннектекс**](/windows/desktop/api/Mswsock/nc-mswsock-lpfn_connectex), [**всаконнект**](/windows/desktop/api/Winsock2/nf-winsock2-wsaconnect), [**всаконнектбилист**](/windows/desktop/api/Winsock2/nf-winsock2-wsaconnectbylist)или [**WSAConnectByName**](/windows/desktop/api/Winsock2/nf-winsock2-wsaconnectbynamea)) или после фактического завершения запроса на подключение. Если функция Connect была вызвана асинхронно, это требует ожидания завершения соединения, прежде чем пытаться установить параметр **so для протокола \_ KeepAlive** . Если приложение пытается установить параметр " **таким \_ образом** сокета KeepAlive", когда запрос на подключение все еще обрабатывается, функция **сетсоккопт** завершится ошибкой и возвратит [всаеинвал](windows-sockets-error-codes-2.md).

в Windows Server 2003, Windows XP и Windows 2000, поэтому параметр сокета **\_ KEEPALIVE** можно задать с помощью функции [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) , если сокет является переходным состоянием (запрос на соединение все еще выполняется), а также как известное состояние.

Обратите внимание, что файл заголовка *Ws2def. h* автоматически включается в *Winsock2. h* и никогда не должен использоваться напрямую.

## <a name="requirements"></a>Requirements (Требования)



| Требование | Значение |
|-------------------------------------|----------------------------------------------------------------------------------------------------------|
| Минимальная версия клиента<br/> | Windows 2000 Professional \[только классические приложения\]<br/>                                               |
| Минимальная версия сервера<br/> | Windows 2000 Server \[только классические приложения\]<br/>                                                     |
| Заголовок<br/>                   | <dl> <dt>Ws2def. h (включение Winsock2. h)</dt> </dl> |



## <a name="see-also"></a>См. также

<dl> <dt>

[**жетсоккопт**](/windows/desktop/api/winsock/nf-winsock-getsockopt)
</dt> <dt>

[**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt)
</dt> <dt>

[KeepAliveTime](/previous-versions/windows/it-pro/windows-server-2003/cc782936(v=ws.10))
</dt> <dt>

[KeepAliveInterval](/previous-versions/windows/it-pro/windows-server-2003/cc758083(v=ws.10))
</dt> <dt>

[пптпткпмаксдатаретрансмиссионс](/previous-versions/windows/it-pro/windows-server-2003/cc775408(v=ws.10))
</dt> <dt>

[**фиксатор**](/windows/desktop/api/Winsock2/nf-winsock2-socket)
</dt> <dt>

[**\_Валс KeepAlive для проверки SIO \_**](/previous-versions/windows/desktop/legacy/dd877220(v=vs.85))
</dt> <dt>

[TcpMaxDataRetransmissions](/previous-versions/windows/it-pro/windows-server-2003/cc780586(v=ws.10))
</dt> <dt>

[**всажетластеррор**](/windows/desktop/api/winsock/nf-winsock-wsagetlasterror)
</dt> </dl>

 

 
