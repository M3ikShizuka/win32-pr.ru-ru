---
description: Управляющий код позволяет сокету принимать все пакеты IPv4 или IPv6, передаваемые через сетевой интерфейс.
ms.assetid: 1c198a70-6669-4599-bd9a-ffc26c9fe1d0
title: Код элемента управления SIO_RCVALL
ms.topic: reference
ms.date: 05/20/2019
req.target-min-winverclnt: Windows Vista [desktop apps only]
req.target-min-winversvr: Windows Server 2008 [desktop apps only]
api_location:
- mstcpip.h
ms.openlocfilehash: ddff631f1fa4b6b9f9af74f71e2b1eb38a2bf48e
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105719341"
---
# <a name="sio_rcvall-control-code"></a>Код элемента управления SIO_RCVALL

## <a name="description"></a>Описание
Управляющий код **SIO \_ рквалл** позволяет сокету принимать все пакеты IPv4 или IPv6, передаваемые через сетевой интерфейс.

Чтобы выполнить эту операцию, вызовите функцию [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **вспиоктл** со следующими параметрами.

```cpp
int WSAIoctl(
  (socket) s,            // descriptor identifying a socket
  SIO_RCV_ALL,                       // dwIoControlCode
  NULL,                              // lpvInBuffer0,                                 // cbInBuffer
  NULL,                              // lpvOutBuffer output buffer
  (DWORD) cbOutBuffer,            // size of output buffer  
  (LPDWORD) lpcbBytesReturned,    // number of bytes returned
  (LPWSAOVERLAPPED) lpOverlapped, // OVERLAPPED structure
  (LPWSAOVERLAPPED_COMPLETION_ROUTINE) lpCompletionRoutine,  // completion routine
);
```

```cpp
int WSAIoctl(
  (socket) s,            // descriptor identifying a socket
  SIO_RCV_ALL,                       // dwIoControlCode
  NULL,                              // lpvInBuffer
  0,                                 // cbInBuffer
  NULL,                              // lpvOutBuffer output buffer
  (DWORD) cbOutBuffer,            // size of output buffer  
  (LPDWORD) lpcbBytesReturned,    // number of bytes returned
  (LPWSAOVERLAPPED) lpOverlapped, // OVERLAPPED structure
  (LPWSAOVERLAPPED_COMPLETION_ROUTINE) lpCompletionRoutine,  // completion routine
);
```

## <a name="parameters"></a>Параметры

### <a name="s"></a>s

Дескриптор, идентифицирующий сокет.

### <a name="dwiocontrolcode"></a>двиоконтролкоде

Управляющий код для операции.
Для этой операции используйте **SIO \_ рквалл** .

### <a name="lpvinbuffer"></a>лпвинбуффер

Указатель на входной буфер, который должен содержать значение параметра.
Возможные значения параметра **SIO \_ рквалл** ioctl указаны в перечислении **RCVALL_VALUE** , определенном в файле заголовка *мсткпип. h* .

Ниже приведены возможные значения для **SIO \_ рквалл** .

| Значение | Значение |
|-------|---------|
| **РКВАЛЛ \_** | Отключите этот параметр, чтобы сокет не получал все пакеты IPv4 или IPv6, передаваемые через сетевой интерфейс. |
| **РКВАЛЛ \_** | Включите этот параметр, чтобы сокет получал все пакеты IPv4 или IPv6, передаваемые через сетевой интерфейс. Этот параметр включает неизбирательный режим на плате сетевого интерфейса (NIC), если сетевой адаптер поддерживает неизбирательный режим. В сегменте локальной сети с сетевым концентратором сетевая карта, поддерживающая неизбирательный режим, захватывает весь трафик IPv4 или IPv6 в локальной сети, включая трафик между другими компьютерами в одном сегменте локальной сети. Все захваченные пакеты (IPv4 или IPv6, в зависимости от сокета) будут переданы в необработанный сокет. Этот параметр не будет захватывать другие пакеты (например, пакеты ARP, IPX и NetBEUI) в интерфейсе. NetMon использует тот же режим для сетевого интерфейса, но не использует этот параметр для записи трафика. |
| **РКВАЛЛ \_ соккетлевелонли** | Эта функция в настоящее время не реализована, поэтому установка этого параметра не влияет на. |
| **РКВАЛЛ \_ иплевел** | Включите этот параметр, чтобы сокет IPv4 или IPv6 получал все пакеты на уровне IP-адресов, передаваемых через сетевой интерфейс. Этот параметр не включает неизбирательный режим на плате сетевого интерфейса. Этот параметр влияет только на обработку пакетов на уровне IP-адреса. Сетевая карта по-прежнему получает только пакеты, направленные на настроенные адрес рассылки и адреса многоадресной рассылки. Тем не менее, сокет с включенным параметром будет получать не только пакеты, направленные на определенные IP-адреса, но и все пакеты IPv4 или IPv6, получаемые сетевым адаптером. Этот параметр не записывает другие пакеты (например, пакеты ARP, IPX и NetBEUI), полученные через интерфейс. |

### <a name="cbinbuffer"></a>кбинбуффер

Размер входного буфера в байтах.
Этот параметр должен быть больше или равен размеру значения перечисления **RCVALL_VALUE** , на которое указывает параметр *лпвинбуффер* .

### <a name="lpvoutbuffer"></a>лпваутбуффер

Указатель на выходной буфер.
Этот параметр не используется для этой операции.

### <a name="cboutbuffer"></a>кбаутбуффер

Размер выходного буфера в байтах.
Этот параметр не используется для этой операции.

### <a name="lpcbbytesreturned"></a>лпкббитесретурнед

Указатель на переменную, которая получает размер данных, хранящихся в выходном буфере, в байтах.
Этот параметр не используется для этой операции.

### <a name="lpvoverlapped"></a>лпвоверлаппед

Указатель на структуру [**всаоверлаппед**](/windows/desktop/api/winsock2/ns-winsock2-wsaoverlapped) .

Если *сокеты были созданы* без атрибута OVERLAPPED, параметр *лповерлаппед* игнорируется.

Если *конструктор* был открыт с атрибутом OVERLAPPED и параметр *Лповерлаппед* не равен **null**, операция выполняется как перекрытый (асинхронная) операция.
В этом случае параметр *лповерлаппед* должен указывать на допустимую структуру [**всаоверлаппед**](/windows/desktop/api/winsock2/ns-winsock2-wsaoverlapped) .

Для операций с перекрытием функция [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **вспиоктл** возвращает значение немедленно, и соответствующий метод завершения получает сигнал о завершении операции.
В противном случае функция не возвращает значение до тех пор, пока операция не будет завершена или произойдет ошибка.

### <a name="lpcompletionroutine"></a>лпкомплетионраутине

Тип: \_ In_opt \_ [ **LPWSAOVERLAPPED_COMPLETION_ROUTINE**](/windows/win32/api/winsock2/nc-winsock2-lpwsaoverlapped_completion_routine)

Указатель на подпрограммы завершения, вызываемую при завершении операции (игнорируется для сокетов без перекрытия).

### <a name="lpthreadid"></a>лпсреадид

Указатель на структуру [**всасреадид**](/windows/desktop/api/ws2spi/ns-ws2spi-wsathreadid) , которая будет использоваться поставщиком при последующем вызове [**впукуеуеапк**](/windows/desktop/api/ws2spi/nf-ws2spi-wpuqueueapc).
Поставщик должен хранить указанную [**всасреадид**](/windows/desktop/api/ws2spi/ns-ws2spi-wsathreadid) структуру (а не указатель на то же значение) до тех пор, пока функция [**впукуеуеапк**](/windows/desktop/api/ws2spi/nf-ws2spi-wpuqueueapc) не вернет значение.

**Примечание**  .  Этот параметр применяется только к функции **вспиоктл** .

### <a name="lperrno"></a>лперрно

Указатель на код ошибки.

**Примечание**  .  Этот параметр применяется только к функции **вспиоктл** .

## <a name="return-value"></a>Возвращаемое значение

Если операция завершается успешно, функция [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **вспиоктл** возвращает ноль.

Если операция завершается ошибкой или находится в состоянии ожидания, функция [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **Вспиоктл** возвращает **\_ ошибку сокета**.
Чтобы получить расширенные сведения об ошибке, вызовите [**всажетластеррор**](/windows/desktop/api/winsock/nf-winsock-wsagetlasterror).

| Код ошибки | Значение |
|------------|---------|
| **\_ожидается ввод-вывод WSA \_** | Операция перекрытия успешно инициирована, и ее завершение будет указано позже. |
| **\_Операция WSA \_ прервана** | Операция перекрытия была отменена из-за замыкания сокета или выполнения команды ioctl **SIO_FLUSH** . |
| **WSAEFAULT** | Параметр *лповерлаппед* или *лпкомплетионраутине* не полностью содержится в допустимой части адресного пространства пользователя. |
| **всаеинпрогресс** | Функция вызывается при выполнении обратного вызова. |
| **всаеинтр** | Операция блокирования была прервана. |
| **всаеинвал** | Параметр *двиоконтролкоде* не является допустимой командой, или указан недопустимый входной параметр, либо команда неприменима к указанному типу сокета. Эта ошибка также возвращается, если параметр *кбинбуффер* меньше, чем `sizeof(UCHAR)` параметр *лпвинбуффер* или указывает на значение, которое не является значением перечисления **RCVALL_VALUE** . Эта ошибка также может возвращаться, если не удается найти сетевой интерфейс, связанный с сокетом. Это может произойти, если сетевой интерфейс, связанный с сокетом, удаляется или удаляется (например, удаляется сетевое устройство PCMCIA или USB). |
| **WSAENETDOWN** | Сбой сетевой подсистемы. |
| **WSAENOBUFS** | Нет доступного места в буфере. |
| **всаенопротупт** | Параметр сокета не поддерживается для указанного протокола. |
| **всаенотсокк** | Дескриптор *s* не является сокетом. |
| **всаеопнотсупп** | Указанная команда IOCTL не поддерживается. Эта ошибка возвращается, если поставщик транспорта не поддерживает **SIO \_ рквалл** IOCTL. |

## <a name="remarks"></a>Комментарии

В Windows 2000 и более поздних версиях операционной системы поддерживается **SIO \_ рквалл** IOCTL.

**SIO \_ рквалл** ioctl позволяет сокету принимать все пакеты IPv4 или IPv6 в сетевом интерфейсе.
Маркер сокета, передаваемый функции [**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl) или **вспиоктл** , должен быть одним из следующих:

* Сокет IPv4, созданный с семейством адресов, равным AF_INET, тип сокета, установленный в SOCK_RAW, и протокол, для которого задано значение IPPROTO_IP.
* Сокет IPv6, созданный с семейством адресов, равным AF_INET6, тип сокета, установленный в SOCK_RAW, и протокол, для которого задано значение IPPROTO_IPV6.

Дополнительные сведения об необработанных сокетах см. в разделе [**необработанные сокеты TCP/IP**](/windows/desktop/winsock/tcp-ip-raw-sockets-2).

Сокет также должен быть привязан к явному локальному интерфейсу IPv4 или IPv6, что означает, что вы не можете выполнить привязку к **адресу \_** или **in6addr \_ любому** из них.

После привязки сокета и успешного завершения функции IOCTL вызовы функций [**всарекв**](/windows/desktop/api/winsock2/nf-winsock2-wsarecv) или [**recv**](/windows/desktop/api/winsock/nf-winsock-recv) возвращают IPv4-датаграммы, проходящие через данный интерфейс IPv4, или возвращают IPv6 датаграмм, передаваемых через данный интерфейс IPv6.
Обратите внимание, что необходимо указать достаточно большой буфер.
При настройке этого IOCTL будут записываться только пакеты IPv4 или IPv6 для заданного интерфейса.
Этот запрос IOCTL не будет захватывать другие пакеты (например, пакеты ARP, IPX и NetBEUI) в интерфейсе.

Сокет, привязанный к определенному локальному интерфейсу с помощью ioctl **\_ рквалл** , будет принимать только пакеты, передаваемые через этот интерфейс.
Он не будет получать пакеты, полученные на другом интерфейсе, и пересылаться в другом интерфейсе, отличном от сокета с подключением **SIO \_ рквалл** IOCTL.

В Windows Server 2008 и более ранних версиях параметр **\_ Рквалл ioctl SIO** не будет записывать локальные пакеты, отправленные из сетевого интерфейса.
Это включает пакеты, полученные на другом интерфейсе, и перенаправляли сетевой интерфейс, указанный для **SIO \_ рквалл** IOCTL.

В Windows 7 и Windows Server 2008 R2 это было изменено, так что также фиксируются локальные пакеты, отправленные из сетевого интерфейса.
Это относится к пакетам, полученным в другом интерфейсе, и последующем пересылке сетевого интерфейса, привязанного к сокету, с помощью интерфейса **SIO \_ рквалл** IOCTL.

Для установки этого IOCTL требуются права администратора на локальном компьютере.

Эта функция иногда называется неизбирательным режимом.
Любое прямое изменение от применения этого параметра к одному интерфейсу, а затем к другому интерфейсу с одним вызовом с помощью этого IOCTL не поддерживается.
Приложение должно сначала использовать этот запрос IOCTL, чтобы отключить поведение первого интерфейса, а затем использовать этот запрос IOCTL для включения поведения в новом интерфейсе.

## <a name="see-also"></a>См. также раздел

[**фиксатор**](/windows/desktop/api/winsock2/nf-winsock2-socket)

[**Необработанные сокеты TCP/IP**](/windows/desktop/winsock/tcp-ip-raw-sockets-2)

[**всажетластеррор**](/windows/desktop/api/winsock2/nf-winsock2-wsagetlasterror)

[**всажетоверлаппедресулт**](/windows/desktop/api/winsock2/nf-winsock2-wsagetoverlappedresult)

[**всаиоктл**](/windows/desktop/api/winsock2/nf-winsock2-wsaioctl)

[**всаоверлаппед**](/windows/desktop/api/winsock2/ns-winsock2-wsaoverlapped)

[**всасоккета**](/windows/desktop/api/winsock2/nf-winsock2-wsasocketa)

[**всасоккетв**](/windows/desktop/api/winsock2/nf-winsock2-wsasocketw)
