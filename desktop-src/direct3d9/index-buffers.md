---
description: Индексные буферы, представленные интерфейсом IDirect3DIndexBuffer9, представляют собой буферы памяти, содержащие индексные данные.
ms.assetid: baa60cd1-a1f0-4dbe-b934-aeb1a5c6b784
title: Буферы индексов (Direct3D 9)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 7151fae6deb72a0c569d269c80e5b13bf946f9d0
ms.sourcegitcommit: d75fc10b9f0825bbe5ce5045c90d4045e3c53243
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2021
ms.locfileid: "127264488"
---
# <a name="index-buffers-direct3d-9"></a>Буферы индексов (Direct3D 9)

Индексные буферы, представленные интерфейсом [**IDirect3DIndexBuffer9**](/windows/win32/api/d3d9helper/nn-d3d9helper-idirect3dindexbuffer9) , представляют собой буферы памяти, содержащие индексные данные. Индексные данные (или индексы) являются целочисленными смещениями в буферах вершин и используются для отрисовки примитивов с помощью метода [**IDirect3DDevice9::D равиндекседпримитиве**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawindexedprimitive) .

Буфер вершин содержит вершины; соответственно, можно рисовать буферы вершин с помощью индексированных примитивов и без них. Однако, поскольку буфер индексов содержит индексы, невозможно использовать буфер индексов без соответствующего буфера вершин. (В качестве побочной заметки [**IDirect3DDevice9::D равиндекседпримитивеуп**](/windows/desktop/api) и [**IDirect3DDevice9::D равпримитивеуп**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitiveup) — это единственные методы рисования, которые рисуются без индекса или буфера вершин.)

## <a name="index-buffer-description"></a>Описание буфера индексов

Буфер индексов описывается с рассмотрением его возможностей: где он находится в памяти, поддерживает ли он чтение и запись, тип и число индексов, которые он может содержать. Эти признаки хранятся в структуре [**D3DINDEXBUFFER \_ DESC**](d3dindexbuffer-desc.md) .

Описания буферов индексов сообщают приложению, как был создан существующий буфер. Вы предоставляете пустую конструкцию для описания, которую система заполняет перечислением возможностей ранее созданного буфера индексов.

-   Элемент Format описывает формат поверхности данных буфера индекса.
-   Тип определяет тип ресурса буфера индекса.
-   Член структуры использования содержит общие флаги возможностей. Флаг D3DUSAGE \_ софтварепроцессинг указывает, что буфер индексов используется для обработки вершин программного обеспечения. Наличие \_ флага D3DUSAGE WRITEONLY в использовании указывает на то, что память буфера индекса используется только для операций записи. Это освобождает драйвер для размещения данных индекса в оптимальном расположении в памяти для быстрой обработки и подготовки к просмотру. Если флаг D3DUSAGE \_ WRITEONLY не используется, драйвер, скорее всего, поместит данные в расположение, неэффективное для операций чтения. Это пожертвует некоторую скорость обработки и отрисовки. Если этот флаг не указан, то предполагается, что приложения выполняют операции чтения и записи данных в буфере индекса.
-   Pool указывает класс памяти, выделенный для буфера индекса. Флаг D3DPOOL \_ системмем указывает, что система создала буфер индексов в системной памяти.
-   Элемент size сохраняет размер данных буфера вершин в байтах.
-   Последний параметр Пшаредхандле не используется. Задайте для него **значение NULL**.

## <a name="index-processing-requirements"></a>Требования к обработке индексов

Производительность операций обработки индексов сильно зависит от расположения буфера индексов в памяти и от типа используемого устройства отрисовки. Приложения управляют выделением памяти для буферов индексов при их создании. Если \_ установлен флаг D3DPOOL системмем Memory, буфер индекса создается в системной памяти. При \_ использовании флага памяти D3DPOOL по умолчанию драйвер устройства определяет, где лучше всего выделяется память для буфера индекса, часто называемую оптимальным для драйвера памятью. Оптимальным для драйвера памятью может быть локальная видеопамять, Нелокальная видеопамять или системная память.

Установка \_ флага поведения D3DUSAGE софтварепроцессинг при вызове метода [**IDirect3DDevice9:: креатеиндексбуффер**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createindexbuffer) указывает, что буфер индекса должен использоваться с программной обработкой вершин. Этот флаг необходим для обработки вершин в смешанном режиме (D3DCREATE \_ Mixed \_ вертекспроцессинг) при использовании обработки вершин программного обеспечения.

Приложение может записывать индексы непосредственно в буфер индексов, выделенный в оптимальном для драйвера участке памяти. Этот метод предотвращает избыточную операцию копирования на более позднем этапе. Этот прием оказывается менее полезен, если приложение снова считывает данные из буфера индексов, поскольку операции чтения, выполняемые хостом из оптимального для драйвера участка памяти, могут проходить очень медленно. Таким образом, если приложению необходимо выполнять чтение данных во время обработки или выполнять беспорядочную запись данных в буфер, размещение буфера индексов в памяти системы может стать оптимальным вариантом.

> [!Note]  
> Всегда используйте D3DPOOL \_ по умолчанию, за исключением случаев, когда вы не хотите использовать видеопамять или большие объемы памяти, заблокированной страничным каналом, когда драйвер помещает буферы вершин или индексы в память AGP.

 

## <a name="create-an-index-buffer"></a>Создание буфера индекса

Создайте объект буфера индекса, вызвав метод [**IDirect3DDevice9:: креатеиндексбуффер**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createindexbuffer) , который принимает шесть параметров.

-   Первый параметр указывает длину буфера индекса в байтах.
-   Второй параметр — это набор элементов управления использованием. Помимо прочего, его значение определяет, могут ли вершины, на которые ссылаются индексы, содержать сведения об обрезке. Чтобы повысить производительность, укажите D3DUSAGE \_ донотклип, когда отсечение не требуется.

    Флаг D3DUSAGE \_ софтварепроцессинг можно задать при обработке вершин в смешанном режиме или на уровне программного обеспечения (D3DCREATE \_ Mixed \_ вертекспроцессинг/D3DCREATE \_ Software \_ вертекспроцессинг) для этого устройства включена. D3DUSAGE \_ софтварепроцессинг должен быть установлен для использования буферов с обработкой вершин программного обеспечения в смешанном режиме, но не должен быть установлен для наилучшей производительности при использовании аппаратной обработки индекса в смешанном режиме (D3DCREATE \_ Hardware \_ вертекспроцессинг). Однако параметр D3DUSAGE \_ софтварепроцессинг является единственным, если один буфер используется одновременно с аппаратной и программной обработкой вершин. D3DUSAGE \_ софтварепроцессинг разрешен для смешанных и программных устройств.

    Можно принудительно использовать буферы вершин и индексов в системной памяти, указав D3DPOOL \_ системмем, даже если обработка индекса выполняется в оборудовании. Это способ избежать чрезмерно больших объемов памяти, заблокированных страницей, когда драйвер помещает эти буферы в память AGP.

-   Третьим параметром является либо D3DFMT \_ INDEX16, либо D3DFMT \_ INDEX32 в перечислимом типе [D3DFORMAT](d3dformat.md) , который указывает размер каждого индекса.

-   Четвертый параметр является членом перечислимого типа [**D3DPOOL**](./d3dpool.md) , который указывает системе, где в памяти следует разместить новый буфер индекса.

-   Последний параметр, который [**IDirect3DDevice9:: креатеиндексбуффер**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createindexbuffer) принимает, является адресом переменной, которая заполнена указателем на новый интерфейс [**IDirect3DIndexBuffer9**](/windows/win32/api/d3d9helper/nn-d3d9helper-idirect3dindexbuffer9) объекта buffer вершин, если вызов завершается с ошибкой.

В следующем примере кода C++ показано, что создание буфера индекса может выглядеть в коде.


```
/*
 * For the purposes of this example, the d3dDevice variable is the 
 * address of an IDirect3DDevice9 interface exposed by a 
 * Direct3DDevice object, g_IB is a variable of type 
 * LPDIRECT3DINDEXBUFFER9.
 */

if( FAILED( d3dDevice->CreateIndexBuffer( 16384 *sizeof(WORD),
           D3DUSAGE_WRITEONLY, D3DFMT_INDEX16, D3DPOOL_DEFAULT, 
           &g_IB, NULL ) ) )
    return E_FAIL;
```



## <a name="access-an-index-buffer"></a>Доступ к буферу индекса

Объекты буфера индексов позволяют приложениям напрямую обращаться к памяти, выделенной для данных индекса. Можно получить указатель на буферную память буфера путем вызова метода [**IDirect3DIndexBuffer9:: Lock**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dindexbuffer9-lock) , а затем получить доступ к памяти по мере необходимости для заполнения буфера новыми данными индекса или для чтения содержащихся в нем данных. Метод Lock принимает четыре параметра. Первый, *оффсеттолокк*, является смещением данных индекса. Второй параметр — это размер данных индекса, измеряемый в байтах. Третьим параметром, принятым методом **IDirect3DIndexBuffer9:: Lock** , *ппбдата*, является адрес указателя байта, заполненного указателем на данные индекса, если вызов выполнен.

Последний параметр, *Флаги* сообщает системе о том, как должна быть заблокирована память. Его можно использовать для указания того, как приложение обращается к данным в буфере. Укажите константы для параметра *flags* в соответствии с тем, как приложение будет получать доступ к данным индекса. Это позволяет драйверу заблокировать память и обеспечить максимальную производительность, исходя из требуемого типа доступа. Используйте \_ флаг D3DLOCK ReadOnly, если приложение будет считывать только из буферной памяти индекса. Включение этого флага позволяет Direct3D оптимизировать свои внутренние процедуры для повышения эффективности, учитывая, что доступ к памяти будет доступен только для чтения.

После заполнения или считывания данных индекса вызовите метод [**IDirect3DIndexBuffer9:: Unlock**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dindexbuffer9-unlock) , как показано в следующем примере кода.


```
// This code example assumes the m_pIndexBuffer is a variable of type 
// LPDIRECT3DINDEXBUFFER9 and that g_Indices has been properly 
// initialized with indices.

// To fill the index buffer, you must lock the buffer to gain 
// access to the indices. This mechanism is required because index
// buffers may be in device memory.

VOID* pIndices;

if( FAILED( m_pIndexBuffer->Lock( 
      0,                 // Fill from start of the buffer
      sizeof(g_Indices), // Size of the data to load
      BYTE**)&pIndices,  // Returned index data
      0 ) ) )            // Send default flags to the lock
{
    SAFE_RELEASE(m_pIndexBuffer);
    return E_FAIL;
}

memcpy( pIndices, g_Indices, sizeof(g_Indices) );
m_pIndexBuffer->Unlock();
```



> [!Note]
>
> Если вы создаете буфер индекса с \_ флагом D3DUSAGE WRITEONLY, не используйте \_ флаг блокировки D3DLOCK ReadOnly. Используйте флаг D3DLOCK \_ ReadOnly, если приложение будет считывать только из буферной памяти индекса. Включение этого флага позволяет Direct3D оптимизировать свои внутренние процедуры для повышения эффективности, учитывая, что доступ к памяти будет доступен только для чтения.
>
> Сведения об использовании D3DLOCK \_ Discard или D3DLOCK \_ нуверврите для параметра *flags* метода [**IDirect3DIndexBuffer9:: Lock**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dindexbuffer9-lock) см. в разделе [Оптимизация производительности (Direct3D 9)](performance-optimizations.md).

 

В C++, так как вы напрямую обращаетесь к памяти, выделенной для буфера индекса, убедитесь, что приложение правильно обращается к выделенной памяти. В противном случае вы рискуете выявление недействительной памяти. Используйте индекс формата индекса, используемого приложением для перехода от одного индекса в выделенном буфере к другому.

Получите сведения о буфере индекса, вызвав метод [**IDirect3DIndexBuffer9:: DESC**](/windows/desktop/api) . Этот метод заполняет члены структуры [**D3DINDEXBUFFER \_ DESC**](d3dindexbuffer-desc.md) сведениями о буфере индекса.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Ресурсы Direct3D](direct3d-resources.md)
</dt> <dt>

[Отрисовка из буферов вершин и индексов (Direct3D 9)](rendering-from-vertex-and-index-buffers.md)
</dt> <dt>

[Буферы вершин (Direct3D 9)](vertex-buffers.md)
</dt> </dl>

 

 
