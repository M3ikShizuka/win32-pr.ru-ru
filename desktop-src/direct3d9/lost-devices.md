---
description: Устройство Direct3D может быть в рабочем состоянии или потерянном состоянии.
ms.assetid: dc4326ba-2ebc-4bca-8fba-02d8db739b8f
title: Потерянные устройства (Direct3D 9)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a808cb113f5c2fd35a741e0efc7c6b8af9e127df
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "104341832"
---
# <a name="lost-devices-direct3d-9"></a>Потерянные устройства (Direct3D 9)

Устройство Direct3D может быть в рабочем состоянии или потерянном состоянии. Рабочее — это обычное состояние устройства, в котором устройство запускается и отображает все отрисованные элементы, как ожидается. Устройство выполняет переход в состояние потеряно, когда некоторое событие, например потеря фокуса клавиатуры в приложении в полноэкранном режиме, приводит к невозможности отрисовки. Потерянное состояние характеризуется незаметным сбоем всех операций отрисовки; это означает, что методы отрисовки могут возвращать коды успешного завершения, даже если операции отрисовки завершились сбоем. В этом случае код ошибки D3DERR \_ девицелост возвращается [**IDirect3DDevice9::P**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present)повторной отправки.

Согласно изначальному замыслу исчерпывающий набор сценариев, в которых устройство может перейти в потерянное состояние, не определен. В число самых распространенных примеров входит потеря фокуса, например при нажатии пользователем клавиш ALT+TAB или при инициализации диалогового окна системы. Устройства также могут быть потеряны из-за события управления питанием, или когда другое приложение пытается выполнить операцию в полноэкранном режиме. Кроме того, любая ошибка из [**IDirect3DDevice9:: Reset**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-reset) переводит устройство в состояние «утеряно».

Все методы, которые являются производными от [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown), гарантированно будут работать после потери устройства. После потери устройства каждая функция обычно имеет следующие три варианта действий.

-   Сбой с D3DERR \_ девицелост. Это означает, что приложению нужно определить, что устройство было потеряно, чтобы приложение знало, что что-то не происходит должным образом.
-   При автоматическом сбое, возврате S \_ OK или любых других кодов возврата. Если функция не выполняется автоматически, приложение не может различить результат "успешно" и "неудачный".
-   Функция возвращает код возврата.



|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Различия между Direct3D 9 и Direct3D 9Ex:<br/> Устройство Direct3D 9 возвращает D3DERR \_ девицелост. После возврата из [**IDirect3DDevice9::P**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present)повторной отправки, поведение эмуляции больше не будет работать, и все последующие вызовы будут завершаться сбоем, пока устройство не будет успешно сброшено.<br/> Устройство Direct3D 9Ex никогда не возвращает D3DERR \_ девицелост, но может возвращать новые сообщения о состоянии (см. раздел [изменения поведения устройства](dx9lh.md)).<br/> |



 

## <a name="responding-to-a-lost-device"></a>Реакция на потерю устройства

Потеря устройства должна привести к повторному созданию ресурсов (включая ресурсы видеопамяти) после его сброса. Если устройство потеряно, приложение отправляет запрос устройству, чтобы определить, можно ли восстановить его рабочее состояние. Если это невозможно, приложение ожидает, пока устройство не сможет быть восстановлено.

Если устройство можно восстановить, приложение подготавливает устройство путем уничтожения всех ресурсов видеопамяти и цепочек буферов. Затем приложение вызывает метод [**IDirect3DDevice9:: Reset**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-reset) . Reset — единственный метод, который действует при потере устройства, и является единственным методом, с помощью которого приложение может изменить устройство с состояния потери на рабочее. Сброс завершится ошибкой, если приложение не освободит все ресурсы, выделенные в D3DPOOL \_ по умолчанию, включая те, которые были созданы методами [**IDirect3DDevice9:: Креатерендертаржет**](/windows/desktop/api) и [**IDirect3DDevice9:: креатедепсстенЦилсурфаце**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createdepthstencilsurface) .

В большинстве случаев при высокой частоте вызовов Direct3D не возвращается никакой информации о том, было ли устройство потеряно. Приложение может продолжать вызывать методы отрисовки, такие как [**IDirect3DDevice9::D равпримитиве**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive), без получения уведомления о потерянном устройстве. Внутри системы эти операции отменяются, пока устройство не вернется в рабочее состояние.

Приложение может определить, что делать при обнаружении потерянного устройства, запросив возвращаемое значение метода [**IDirect3DDevice9:: тесткуперативелевел**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-testcooperativelevel) .

## <a name="locking-operations"></a>Операции блокировки

Внутри системы Direct3D выполняет достаточный объем работы, чтобы гарантировать успешное завершение операции блокировки после потери устройства. Однако не гарантируется, что данные ресурсов видеопамяти будут точными во время операции блокировки. Гарантируется, что не произойдет возврата никакого кода ошибки. Это позволяет писать приложения, не беспокоясь о потере устройства во время операции блокировки.

## <a name="resources"></a>Ресурсы

Ресурсы могут потреблять видеопамять. Поскольку потерянное устройство отключается от видеопамяти, принадлежащей адаптеру, невозможно гарантировать выделение видеопамяти при потере устройства. В результате все методы создания ресурсов реализуются успешно, возвращая D3D \_ ОК, но на самом деле они выделяют только фиктивную системную память. Поскольку ресурсы видеопамяти должны быть уничтожены перед изменением размера устройства, проблема избыточного выделения видеопамяти не возникает. Эти фиктивные поверхности позволяют операциям блокировки и копирования работать нормально, пока приложение не вызовет [**IDirect3DDevice9::P**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present) повторно и обнаруживает, что устройство потеряно.

Перед переводом устройства из потерянного состояния в рабочее вся видеопамять должна быть освобождена. Это означает, что приложение должно освобождать любые цепочки подкачки, созданные с помощью [**IDirect3DDevice9:: креатеаддитионалсвапчаин**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createadditionalswapchain) , и любых ресурсов, помещенных в \_ класс памяти D3DPOOL по умолчанию. Приложению не требуется освобождать ресурсы в \_ классах памяти D3DPOOL Managed или D3DPOOL \_ системмем. Другие данные о состоянии автоматически удаляются при переходе в рабочее состояние.

Рекомендуется разрабатывать приложения с одним программным путем для реагирования на потерю устройства. Этот программный путь может быть аналогичен, если не идентичен, программному пути, который используется для инициализации устройства при запуске.

## <a name="retrieved-data"></a>Извлеченные данные

Direct3D позволяет приложениям проверять текстуры и передавать состояния по одному этапу отрисовки с помощью [**IDirect3DDevice9:: валидатедевице**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-validatedevice). Этот метод, который обычно вызывается во время инициализации приложения, возвращает D3DERR \_ девицелост, если устройство было потеряно.

Direct3D также позволяет приложениям копировать сгенерированные или ранее записанные изображения из ресурсов видеопамяти в ресурсы энергонезависимой памяти системы. Так как исходные изображения в таких операциях передачи могут быть потеряны в любое время, Direct3D позволяет таким операциям копирования завершаться сбоем, если устройство потеряно.

В отношении асинхронных запросов [**IDirect3DQuery9:: GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) возвращает D3DERR \_ девицелост, если указан флаг Flush, чтобы указать приложению, что **IDirect3DQuery9:: GetData** никогда не возвратит значение S \_ ОК.

Операция копирования, [**IDirect3DDevice9:: жетфронтбуффердата**](/windows/desktop/api), может завершиться с ошибкой D3DERR \_ девицелост, так как при потере устройства основная поверхность отсутствует. [**IDirect3DDevice9:: креатеаддитионалсвапчаин**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createadditionalswapchain) может также завершиться с помощью D3DERR \_ девицелост, так как невозможно создать задний буфер при потере устройства. Обратите внимание, что эти случаи являются единственным экземпляром D3DERR \_ девицелост за пределами методов [**IDirect3DDevice9::P**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present), [**IDirect3DDevice9:: тесткуперативелевел**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-testcooperativelevel)и [**IDirect3DDevice9:: Reset**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-reset) .

## <a name="programmable-shaders"></a>Программируемые шейдеры

В Direct3D 9 шейдер вершин и шейдеры пикселей не нужно создавать повторно после сброса. Они будут сохранены. В предыдущих версиях DirectX были созданы повторно созданные шейдеры, необходимые для устройства.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Устройства Direct3D](direct3d-devices.md)
</dt> </dl>

 

 
