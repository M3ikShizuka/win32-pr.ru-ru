---
description: По сути, окно просмотра — это двухмерный (двумерный) прямоугольник, в котором проецируется трехмерная сцена.
ms.assetid: eddadaa1-9181-47fa-8530-44aa46fea286
title: Окна просмотра и обрезка (Direct3D 9)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d57f64d17f7abf4e370406f984fa50037be6d44e
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "104139214"
---
# <a name="viewports-and-clipping-direct3d-9"></a>Окна просмотра и обрезка (Direct3D 9)

По сути, окно просмотра — это двухмерный (двумерный) прямоугольник, в котором проецируется трехмерная сцена. В Direct3D этот прямоугольник существует как координаты внутри поверхности Direct3D, которую система использует как целевой объект отрисовки. Преобразование проекции преобразует вершины в систему координат, используемую для окна просмотра. Окно просмотра также используется, чтобы указать диапазон значений глубины на целевой поверхности отрисовки, где будет отрисовываться сцена (как правило, от 0,0 до 1,0).

## <a name="the-viewing-frustum"></a>Усеченная пирамида видимости

Усеченная пирамида видимости — это 3D-объем в сцене, позиционируемый относительно камеры окна просмотра. Форма этого объема влияет на то, как модели проецируются из пространства камеры на экран. При использовании наиболее распространенного типа проекции — перспективной проекции — объекты, которые находятся ближе к камере, кажутся больше, чем объекты дальше от нее. В случае перспективной проекции усеченную пирамиду видимости можно визуализировать как пирамиду, на вершине которой находится камера, как показано на следующем рисунке. Эта пирамида пересекается передней и задней плоскостью кадрирования. Объем пирамиды между передней и задней плоскостями кадрирования — это и есть усеченная пирамида видимости. Объекты отображаются, только когда они находятся в пределах этого объема.

![Иллюстрация усеченной пирамиды видимости с передней и задней плоскостью кадрирования](images/frustum.png)

Если представить себе, что вы стоите в темной комнате и смотрите наружу через квадратное окно, то, что вы видите — это усеченная пирамида видимости. В этой аналогии ближняя плоскость кадрирования — это окно, а задняя плоскость кадрирования — это то, что в итоге перегораживает открывающийся перед вами вид: высотный дом через дорогу, горы вдалеке или вообще ничего. Вы видите все, что находится внутри усеченной пирамиды, которая начинается окном и заканчивается предметом, который перегораживает вид; больше вы не видите ничего.

Усеченная пирамида видимости определяется полем зрения и расстояниями до передней и задней плоскостей кадрирования, заданными в виде Z-координат, как показано на следующей схеме.

![Схема усеченной пирамиды видимости](images/fovdiag.png)

На этой схеме переменная D — это расстояние от камеры до начала координат пространства, которое было определено на последнем участке геометрического конвейера — при преобразовании для просмотра. Это пространство, вокруг которого располагаются пределы вашей усеченной пирамиды видимости. Сведения о том, как эта D-переменная используется для построения матрицы проекции, см. в разделе [преобразование проекции (Direct3D 9)](projection-transform.md) .

## <a name="viewport-rectangle"></a>Прямоугольник окна просмотра

Вы определяете прямоугольник окна просмотра в C++ с помощью структуры [**D3DVIEWPORT9**](d3dviewport9.md) . Структура D3DVIEWPORT9 используется со следующими методами обработки окна просмотра, предоставляемыми интерфейсом IDirect3DDevice9.

-   [**IDirect3DDevice9:: "окно просмотра"**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-getviewport)
-   [**IDirect3DDevice9:: Сетвиевпорт**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-setviewport)

Структура D3DVIEWPORT9 содержит четыре элемента: X, Y, ширина, высота, которые определяют область поверхности рендеринга, в которой будет отображаться сцена. Эти значения соответствуют целевому прямоугольнику, или прямоугольнику окна просмотра, как показано на следующей схеме.

![Схема прямоугольника окна просмотра](images/destrect.png)

Значения, задаваемые в качестве членов X, Y, Width, Height, — это экранные координаты относительно левого верхнего угла поверхности целевого объекта отрисовки. Структура определяет два дополнительных члена (MinZ и MaxZ); они указывают диапазоны глубин, в которых будет отрисовываться сцена.

Direct3D предполагает, что объем кадрирования окна просмотра находится в диапазоне от -1,0 до 1,0 по оси X и от 1,0 до -1,0 по оси Y. Эти значения в прошлом использовались большинством приложений. Пропорции окна просмотра можно откорректировать перед кадрированием с использованием [преобразования проекции](projection-transform.md).

> [!Note]  
> Минз и Максз обозначают диапазоны глубины, в которых будет выполняться визуализация сцены и которые не используются для обрезки. В большинстве приложений эти члены будут установлены в 0,0 и 1,0, чтобы система отображалась во всем диапазоне значений глубины в буфере глубины. В некоторых случаях можно добиться особых эффектов, используя другие диапазоны глубин. Например, для отрисовки экранных элементов в игре вы можно задать оба значения равными 0,0, чтобы заставить систему отрисовывать объекты в сцене на переднем плане, или задать их оба равными 1,0 для отрисовки объекта, который всегда должен находиться на заднем плане.

 

Измерения, используемые в элементах X, Y, Width и Height структуры [**D3DVIEWPORT9**](d3dviewport9.md) для окна просмотра, определяют расположение и размеры окна просмотра на поверхности целевого объекта рендеринга. Эти значения задаются в экранных координатах относительно левого верхнего угла поверхности.

Direct3D использует местоположение и размеры окна просмотра для масштабирования вершин так, чтобы отрисованная сцена поместилась в соответствующее место на поверхности целевого объекта. Внутренне Direct3D вставляет эти значения в следующую матрицу, которая применяется к каждой вершине.

![уравнение матрицы, применяемое к каждой вершине](images/vpscale.png)

Эта матрица масштабирует вершины в соответствии с размерами окна просмотра и желаемым диапазоном глубин, а также переносит их в соответствующее местоположение на поверхности целевого объекта отрисовки. Матрица также обращает Y-координату, чтобы отразить начало координат экрана в левом верхнем углу с осью Y, направленной вниз. После применения этой матрицы вершины по-прежнему являются однородными, то есть они по-прежнему существуют в виде \[ вершин x, y, z, w \] и должны быть преобразованы в однородные координаты перед отправкой в средство программной прорисовки.

> [!Note]  
> Матрица масштабирования окна просмотра содержит элементы Минз и Максз структуры [**D3DVIEWPORT9**](d3dviewport9.md) для масштабирования вершин в соответствии с диапазоном глубины \[ Минз, максз \] . Это представляет собой другую семантику из предыдущих выпусков DirectX, в которых эти члены использовались для обрезки.

 

> [!Note]  
> Приложения обычно устанавливают Минз и Максз в 0,0 и 1,0 соответственно, что приводит к отрисовке системой всего диапазона глубины. Однако можно использовать другие значения для достижения определенных эффектов. Например, можно задать оба значения равными 0,0, чтобы все объекты отрисовывались на переднем плане, или равными 1,0, чтобы все объекты отрисовывались на заднем плане.

 

## <a name="clearing-a-viewport"></a>Очистка окна просмотра

При очистке окна просмотра содержимое прямоугольника окна просмотра на поверхности целевого объекта отрисовки сбрасывается. Также при этом может очищаться прямоугольник в буфере глубины и буфере трафарета.

Чтобы очистить окно просмотра, используйте [**IDirect3DDevice9:: Clear**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-clear) . Метод принимает один или несколько прямоугольников, определяющих области на поверхности. Если задать для параметра Count значение 1, а параметр Пректс — адрес одного прямоугольника, охватывающего всю область окна просмотра, будет очищено все окно просмотра. Другим способом очистки всего окна просмотра является установка для параметра Пректс **значения NULL** , а для параметра Count — значение 0.

[**IDirect3DDevice9:: Clear**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-clear) можно использовать для очистки битов трафарета в буфере глубины. Просто установите параметр flags, чтобы определить, как **IDirect3DDevice9:: Clear** работает с целью рендеринга и любыми связанными буферами глубины или трафарета. \_Флаг целевого объекта D3DCLEAR очистит окно просмотра, используя произвольный цвет RGBA, который вы задаете в аргументе Color (это не цвет материала). Флаг D3DCLEAR \_ збуффер очистит буфер глубины до произвольной глубины, указанной в Z: 0,0 — ближайшее расстояние, а 1,0 — самым крайним. \_Флаг набора элементов D3DCLEAR приведет к сбросу битов шаблона до значения, которое вы задасте в аргументе набора элементов. Можно использовать целые числа в диапазоне от 0 до 2n-1, где n — битовая глубина буфера шаблона.

В некоторых ситуациях может быть отображена только часть мелких частей целевого объекта рендеринга и поверхностей буфера глубины. Методы Clear также позволяют очищать несколько областей поверхностей в одном вызове. Для этого установите параметр count равным количеству прямоугольников, которые нужно очистить, и укажите адрес первого прямоугольника в массиве прямоугольников в параметре Пректс.

## <a name="set-up-the-viewport-for-clipping"></a>Настройка окна просмотра для кадрирования

Результаты матрицы проекции определяют объем кадрирования в пространстве проекции следующим образом:

-w<sub>c</sub><= x<sub>c</sub><= w<sub>c</sub>

-w<sub>c</sub><= y<sub>c</sub><= w<sub>c</sub>

0 <= z<sub>c</sub><= w<sub>c</sub>

где x, y, z и w представляют координаты вершин после применения преобразования проекции. Все вершины, у которых x-, y- или z-компонент находится вне этих диапазонов, отсекаются, если кадрирование включено (поведение по умолчанию).

За исключением буферов вершин, приложения включают или отключают обрезку с помощью [**состояния \_ рендеринга D3DRS**](./d3drenderstatetype.md) . Сведения об отсечениях для буферов вершин создаются во время обработки. Дополнительные сведения см. в разделе [Обработка вершин фиксированной функции (Direct3D 9)](fixed-function-vertex-processing.md) и [программируемая обработка вершин (Direct3D 9)](programmable-vertex-processing.md).

Direct3D не обрезает преобразованные вершины примитива из буфера вершин, если он не поступает из [**IDirect3DDevice9::P роцессвертицес**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-processvertices). Если вы выполняете собственные преобразования и для выполнения обрезки требуется Direct3D, не следует использовать буферы вершин. В этом случае приложение проходит по данным, чтобы преобразовать их. Direct3D перебирает данные во второй раз, чтобы обрезать его, а затем драйвер подготавливает к просмотру данные, что является неэффективным. Таким образом, если приложение преобразует данные, оно также должно обрезать данные.

Когда устройство получает предварительно преобразованные и освещенные вершины (T&L вершины), которые необходимо обрезать, для выполнения операции обрезки вершины преобразуются в область обрезки с помощью обратной однородной оси w (РХВ) и информации окна просмотра. Затем выполняется обрезка. Не все устройства способны выполнить это обратное преобразование, чтобы обрезать вершины&L.

\_Возможность устройства D3DPMISCCAPS клиптлвертс указывает, поддерживает ли устройство отсечение вершин T&L. Если эта возможность не задана, приложение несет ответственность за обрезание вершин T&L, которые он намеревается отправить на устройство для подготовки к просмотру. Устройство всегда может обрезать вершины T&L в режиме обработки вершин программного обеспечения (независимо от того, создано ли устройство в режиме обработки вершин программного обеспечения или переключено на режим обработки вершин программного обеспечения).

Единственным требованием для настройки параметров окна просмотра для устройства отрисовки является установка тома обрезки окна просмотра. Для этого инициализируйте и установите отсеченные значения для тома обрезки и для поверхности целевого объекта рендеринга. Обычно окна просмотра настроены для отображения в полную область поверхности целевого объекта рендеринга, но это не является обязательным.

Чтобы добиться этого в C++, можно использовать следующие параметры для членов структуры [**D3DVIEWPORT9**](d3dviewport9.md) .


```
D3DVIEWPORT9 viewData = { 0, 0, width, height, 0.0f, 1.0f };
```



После задания значений в структуре [**D3DVIEWPORT9**](d3dviewport9.md) примените параметры окна просмотра к устройству, вызвав его метод [**IDirect3DDevice9:: сетвиевпорт**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-setviewport) . В следующем примере кода показано, как может выглядеть этот вызов.


```
HRESULT hr;

hr = pd3dDevice->SetViewport(&viewData);
if(FAILED(hr))
    return hr;
```



Если вызов завершится с ошибкой, параметры окна просмотра задаются и вступят в силу при следующем вызове метода отрисовки. Чтобы внести изменения в параметры окна просмотра, просто обновите значения в структуре [**D3DVIEWPORT9**](d3dviewport9.md) и снова вызовите [**IDirect3DDevice9:: сетвиевпорт**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-setviewport) .

> [!Note]  
> Элементы структуры [**D3DVIEWPORT9**](d3dviewport9.md) Минз и максз указывают глубину, в которой будет выполняться визуализация сцены и которые не используются для обрезки. В большинстве приложений эти члены устанавливаются в 0,0 и 1,0, чтобы система отображалась во всем диапазоне значений глубины в буфере глубины. В некоторых случаях можно добиться особых эффектов, используя другие диапазоны глубин. Например, для отрисовки экранных элементов в игре вы можно задать оба значения равными 0,0, чтобы заставить систему отрисовывать объекты в сцене на переднем плане, или задать их оба равными 1,0 для отрисовки объекта, который всегда должен находиться на заднем плане.

 

## <a name="related-topics"></a>См. также

<dl> <dt>

[Начало работы](getting-started.md)
</dt> </dl>

 

 
