---
description: Приложения используют буфер трафарета для маскирования пикселов в изображении. Маска определяет рисуется пиксель или нет. Некоторые из наиболее распространенных эффектов показаны ниже.
ms.assetid: 984f0a98-4a74-44c3-a9d0-f5d3f12f7e4e
title: Методы буфера элементов шаблона (Direct3D 9)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5c2dcc05475a3ddfc13e456faf60ec2d11e271a9
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "104423150"
---
# <a name="stencil-buffer-techniques-direct3d-9"></a>Методы буфера элементов шаблона (Direct3D 9)

Приложения используют буфер трафарета для маскирования пикселов в изображении. Маска определяет рисуется пиксель или нет. Некоторые из наиболее распространенных эффектов показаны ниже.

-   [Компоновка](compositing.md)
-   [Переводные картинки](decaling.md)
-   [Разрешается, исчезает и прокрутка](dissolves--fades--and-swipes.md)
-   [Контуры и Силхауеттес](outlines-and-silhouettes.md)
-   [Двухсторонний набор элементов](two-sided-stencil.md)

Буфер трафарета включает или отключает отрисовку на целевую поверхность попиксельно. На своем фундаментальном уровне буфер позволяет приложениям маскировать части выводимого изображения так, чтобы они не отображались. Приложения часто используют буферы трафарета для специальных эффектов, таких как рассеивание, наложение декалей и контуров.

Данные буфера трафарета внедряются в данные z-буфера. Приложение может использовать метод [**IDirect3D9:: чеккдевицеформат**](/windows/desktop/api) для проверки поддержки наборов элементов оборудования, как показано в следующем примере кода.


```
// Reject devices that cannot perform 8-bit stencil buffering. 
// The following example assumes that pCaps is a valid pointer 
// to an initialized D3DCAPS9 structure. 

if( FAILED( m_pD3D->CheckDeviceFormat( pCaps->AdapterOrdinal,
                                       pCaps->DeviceType,  
                                       Format,  
                                       D3DUSAGE_DEPTHSTENCIL, 
                                       D3DRTYPE_SURFACE,
                                       D3DFMT_D24S8 ) ) )
return E_FAIL;
```



[**IDirect3D9:: чеккдевицеформат**](/windows/desktop/api) позволяет выбрать устройство для создания на основе возможностей этого устройства. В этом случае устройства, которые не поддерживают 8-разрядные буферы трафаретов, отклоняются. Обратите внимание, что это только одно возможное использование для **IDirect3D9:: чеккдевицеформат**; Дополнительные сведения см. в разделе [Определение поддержки оборудования (Direct3D 9)](determining-hardware-support.md).

## <a name="how-the-stencil-buffer-works"></a>Как работает буфер шаблона

Direct3D выполняет попиксельный тест содержимого буфера трафарета. Для каждого пикселя на целевой поверхности выполняется тест с использованием соответствующего значения из буфера трафарета, контрольного значения буфера и значения маски буфера. В тестовых проходах Direct3D выполняет действие. Тест проводится в несколько шагов.

1.  Выполняется побитовая операция AND над контрольным значением трафарета и маской трафарета.
2.  Выполняется побитовая операция AND со значением буфера трафарета для текущего пикселя и маской трафарета.
3.  Сравнивается результат 1-го шага с результатом 2-го шага 2 с помощью функции сравнения.

Эти шаги показаны в следующем примере кода.


```
(StencilRef & StencilMask) CompFunc (StencilBufferValue & StencilMask)
```




```
StencilBufferValue
```



содержимое буфера шаблона для текущего пикселя. В этом примере кода используется символ амперсанда (&) для представления побитовой операции и.


```
StencilMask
```



представляет значение маски набора элементов, а


```
StencilRef
```



представляет значение ссылки на набор элементов.


```
CompFunc
```



Функция сравнения.

Текущий пиксель записывается на целевую поверхность, если тест трафаретом пройден, в ином случае пиксель пропускается. Поведение сравнения по умолчанию заключается в записи пикселя, независимо от того, как происходит каждая Побитовая операция (D3DCMP \_ всегда). Это поведение можно изменить, изменив значение \_ состояния рендеринга D3DRS стенЦилфунк, передав член перечислимого типа [**D3DCMPFUNC**](./d3dcmpfunc.md) , чтобы указать нужную функцию сравнения.

Приложение может настроить работу буфера трафарета. Приложение может задать функцию сравнения, маску трафарета и контрольное значение трафарета. Таким же образом задается действие, которое Direct3D выполняет при успешном или неудачном происхождении теста. Дополнительные сведения см. в разделе [состояние буфера набора элементов (Direct3D 9)](stencil-buffer-state.md).

## <a name="examples"></a>Примеры

В следующих примерах кода демонстрируется настройка буфера шаблона.


```
// Enable stencil testing
pDevice->SetRenderState(D3DRS_STENCILENABLE, TRUE);

// Specify the stencil comparison function
pDevice->SetRenderState(D3DRS_STENCILFUNC, D3DCMP_EQUAL);

// Set the comparison reference value
pDevice->SetRenderState(D3DRS_STENCILREF, 0);

//  Specify a stencil mask 
pDevice->SetRenderState(D3DRS_STENCILMASK, 0);
```



По умолчанию значение ссылки на набор элементов равно нулю. Допустимо любое целочисленное значение. Direct3D выполняет побитовую операцию и для значения ссылки на набор элементов и значение маски набора элементов перед тестом шаблона.

Вы можете управлять тем, какие сведения о пикселях записываются в зависимости от сравнения наборов элементов.


```
// A write mask controls what is written
pDevice->SetRenderState(D3DRS_STENCILWRITEMASK, D3DSTENCILOP_KEEP);
// Specify when to write stencil data
pDevice->SetRenderState(D3DRS_STENCILFAIL, D3DSTENCILOP_KEEP);
```



Вы можете написать собственную формулу для значения, которое нужно записать в буфер шаблона, как показано в следующем примере.


```
NewStencilBufferValue = (StencilBufferValue & ~StencilWriteMask) | 
                        (StencilWriteMask & StencilOp(StencilBufferValue))
```



## <a name="related-topics"></a>См. также

<dl> <dt>

[Конвейер пикселей](pixel-pipeline.md)
</dt> </dl>

 

 
