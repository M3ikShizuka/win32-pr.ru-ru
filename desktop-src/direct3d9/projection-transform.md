---
description: Преобразование «проекция» можно рассматривать как управление внутренними функциями камеры. аналогично выбору линзы для камеры.
ms.assetid: 09e6e887-7657-4654-be19-2e83dcbc91cf
title: Преобразование проекции (Direct3D 9)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ad15ee0f4d23401563a9a51b8767be3da6e47dfee9dc76d580154ef1d524d02a
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118092728"
---
# <a name="projection-transform-direct3d-9"></a>Преобразование проекции (Direct3D 9)

Преобразование «проекция» можно рассматривать как управление внутренними функциями камеры. аналогично выбору линзы для камеры. Это самый сложный из всех трех типов преобразований. Это обсуждение преобразования «проекция» организовано в следующие разделы.

Обычно матрица проекции — это проекция масштаба и перспективы. Проекционное преобразование превращает видимое пространство (усеченную пирамиду) в кубовидную фигуру. Так как ближний конец видимого пространства меньше дальнего, это приводит к развертыванию объектов, которые находятся ближе к камере — так перспектива применяется к сцене.

В [видимом пространстве](viewports-and-clipping.md) расстояние между камерой и началом координат видимого пространства преобразования определяется произвольно как D, поэтому матрица проекции выглядит, как показано на следующем рисунке.

![иллюстрация матрицы проекции](images/projmat1.png)

Матрица просмотра переносит камеру в начало координат, перемещаясь в направлении z на –D. Матрицы преобразования выглядит, как показано на следующем рисунке.

![иллюстрация матрицы преобразования](images/projmat2.png)

Умножение матрицы преобразования на матрицу проекции (T \* P) дает матрицу составной проекции, как показано на следующем рисунке.

![иллюстрация составной матрицы проекции](images/projmat3.png)

Преобразование перспективы превращает видимое пространство в новое пространство координат. Обратите внимание, что усеченная пирамида становится кубоидом, а начало координат перемещается из правого верхнего угла сцены в центр, как показано на следующем рисунке.

![схема изменения усеченной пирамиды обзора в новое пространства координат за счет преобразования перспективы](images/cuboid.png)

При преобразовании перспективы ограничения направлений x и y равны –1 и 1 соответственно. Ограничения по оси z равны 0 для передней плоскости и 1 для задней плоскости.

Эта матрица преобразует и масштабирует объекты на основе определенного расстояния между камерой и ближней плоскостью отсечения, но при этом не учитывается, что поле зрения (fov) и z-значения, создаваемые для объектов, на расстоянии могут быть практически идентичными, что усложняет сравнение глубины. Следующая матрица решает эти проблемы и корректирует вершины для учета пропорций окна просмотра, что хорошо подходит для проекции перспективы.

![иллюстрация матрицы для проекции перспективы](images/prjmatx1.png)

В этой матрице Zₙ — это z-значение ближней плоскости отсечения. Переменные w, h и Q имеют следующие значения. Обратите внимание, что fov<sub>w</sub> и fovₖ представляют горизонтальные и вертикальные поля зрения окна просмотра в радианах.

![формулы значений переменных](images/prjmatx2.png)

В вашем приложении использование углов полей зрения для определения коэффициентов масштабирования осей x и y может быть не так удобно, как применение горизонтального и вертикального измерения окна просмотра (в пространстве камеры). В следующих двух уравнениях для w и h используются измерения окна просмотра, при этом они эквивалентны предыдущим формулам.

![формулы значений переменных w и h](images/prjmatx3.png)

В этих формулах Zₙ представляет положение ближней плоскости отсечения, а переменные V<sub>w</sub> и Vₕ представляют ширину и высоту окна просмотра в пространстве камеры.

Для приложения C++ эти два измерения непосредственно соответствуют элементам Width и Height структуры [**D3DVIEWPORT9**](d3dviewport9.md) .

Какую бы формулу вы ни выбрали, обязательно установите для Zₙ максимально возможное значение, так как z-значения, очень близкие к камере, не сильно отличаются. Это относительно усложняет сравнение глубины с помощью 16-разрядных z-буферов.

Как и в случае с преобразованиями мира и представлений, вы вызываете метод [**IDirect3DDevice9:: сеттрансформ**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settransform) , чтобы задать преобразование проекции.

## <a name="setting-up-a-projection-matrix"></a>Настройка матрицы проекции

В приведенной ниже образце функции Прожектионматрикс задаются фронтальные и обратные плоскости, а также горизонтальное и вертикальное поле углов представления. Поля представления должны быть меньше PI радиан.


```
D3DXMATRIX 
ProjectionMatrix(const float near_plane, // Distance to near clipping 
                                         // plane
                 const float far_plane,  // Distance to far clipping 
                                         // plane
                 const float fov_horiz,  // Horizontal field of view 
                                         // angle, in radians
                 const float fov_vert)   // Vertical field of view 
                                         // angle, in radians
{
    float    h, w, Q;

    w = (float)1/tan(fov_horiz*0.5);  // 1/tan(x) == cot(x)
    h = (float)1/tan(fov_vert*0.5);   // 1/tan(x) == cot(x)
    Q = far_plane/(far_plane - near_plane);

    D3DXMATRIX ret;
    ZeroMemory(&ret, sizeof(ret));

    ret(0, 0) = w;
    ret(1, 1) = h;
    ret(2, 2) = Q;
    ret(3, 2) = -Q*near_plane;
    ret(2, 3) = 1;
    return ret;
}   // End of ProjectionMatrix
```



После создания матрицы задайте [**IDirect3DDevice9:: сеттрансформ**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settransform) , указав D3DTS \_ проекцию.

Библиотека служебной программы D3DX предоставляет следующие функции, помогающие настроить матрицу проекции.

-   [**D3DXMatrixPerspectiveLH**](d3dxmatrixperspectivelh.md)
-   [**D3DXMatrixPerspectiveRH**](d3dxmatrixperspectiverh.md)
-   [**D3DXMatrixPerspectiveFovLH**](d3dxmatrixperspectivefovlh.md)
-   [**D3DXMatrixPerspectiveFovRH**](d3dxmatrixperspectivefovrh.md)
-   [**D3DXMatrixPerspectiveOffCenterLH**](d3dxmatrixperspectiveoffcenterlh.md)
-   [**D3DXMatrixPerspectiveOffCenterRH**](d3dxmatrixperspectiveoffcenterrh.md)

## <a name="a-w-friendly-projection-matrix"></a>Матрица проекций с поддержкой W

Direct3D может использовать компонент w вершины, которая была преобразована абсолютной матрицей, а также матрицами представления и проекции для вычислений на основе глубины при использовании буфера глубины или эффекта тумана. Для таких вычислений требуется, чтобы матрица проекции нормализовала переменную w как эквивалентную координате z в абсолютном пространстве. Иными словами, если матрица проекции включает коэффициент (3,4), не равный 1, необходимо масштабировать все коэффициенты, инвертируя коэффициент (3,4) для получения правильной матрицы. Если не предоставить совместимую матрицу, эффекты тумана и буферизация глубины не будут правильно применены.

На следующем рисунке показана несоответствующая требованиям матрица проекции и та же матрица, масштабированная для применения тумана туман относительно зрителя.

![иллюстрации несоответствующей матрицы проекции и матрицы с туманом относительно зрителя](images/eyerlmx.png)

В предыдущих матрицах предполагается, что все переменные не равны нулю. Дополнительные сведения о относительном тумане с учетом взгляда см. в разделе [глубина, относительная относительно глаз и Z](pixel-fog.md). Сведения о буферизации глубины на основе w см. в разделе [буферы глубины (Direct3D 9)](depth-buffers.md).

Direct3D использует текущую матрицу проекции при расчетах глубины вершин на основе переменной w. В результате приложения должны установить соответствующую матрицу проекции для получения необходимых функций на основе компонента w, даже если они не используют Direct3D для преобразования.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Преобразования](transforms.md)
</dt> </dl>

 

 
