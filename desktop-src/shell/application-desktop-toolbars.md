---
description: Панель инструментов рабочего стола приложения (также называемая панель приложений) — это окно, похожее на панель задач Windows.
ms.assetid: d9f63cb1-e2cc-4a3b-a3b8-de028e0f0123
title: Использование панелей инструментов рабочего стола приложения
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 140ef94c1daeb571cd0d766dfbd4dc28b7991efd
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104143981"
---
# <a name="using-application-desktop-toolbars"></a>Использование панелей инструментов рабочего стола приложения

*Панель инструментов рабочего стола приложения* (также называемая панель приложений) — это окно, похожее на панель задач Windows. Он привязан к границе экрана, и обычно содержит кнопки, предоставляющие пользователю быстрый доступ к другим приложениям и окнам. Система не позволяет другим приложениям использовать область рабочего стола, используемую панель приложений. Любое количество AppBar может существовать на рабочем столе в любое заданное время.

В этом разделе содержатся следующие подразделы.

-   [О панелях инструментов рабочего стола приложения](#about-application-desktop-toolbars)
    -   [Отправка сообщений](#sending-messages)
    -   [Регистрация](#registration)
    -   [Панель приложений размер и расположение](#appbar-size-and-position)
    -   [Автоматически скрывать панели инструментов рабочего стола приложения](#autohide-application-desktop-toolbars)
    -   [Сообщения уведомления панель приложений](#appbar-notification-messages)
-   [Регистрация панели инструментов рабочего стола приложения](#registering-an-application-desktop-toolbar)
-   [Установка размера и расположения панель приложений](#setting-the-appbar-size-and-position)
-   [Обработка сообщений уведомлений панель приложений](#processing-appbar-notification-messages)

## <a name="about-application-desktop-toolbars"></a>О панелях инструментов рабочего стола приложения

Windows предоставляет API, позволяющий использовать преимущества панель приложений служб, предоставляемых системой. Службы помогают обеспечить плавность работы определяемых приложением AppBar, а также с панелью задач. Система сохраняет сведения о каждом панель приложений и отправляет сообщения AppBar, чтобы уведомить их о событиях, которые могут повлиять на их размер, расположение и внешний вид.

### <a name="sending-messages"></a>отправка сообщений

Приложение использует специальный набор сообщений, называемых панель приложений сообщениями, для добавления или удаления панель приложений, установки размера и расположения панель приложений и получения сведений о размере, положении и состоянии панели задач. Чтобы отправить сообщение панель приложений, приложение должно использовать функцию [**шаппбармессаже**](/windows/desktop/api/Shellapi/nf-shellapi-shappbarmessage) . Параметры функции включают идентификатор сообщения, например [**АБМ \_ New**](abm-new.md), и адрес структуры [**аппбардата**](/windows/desktop/api/Shellapi/ns-shellapi-appbardata) . Члены структуры содержат сведения, необходимые системе для обработки данного сообщения.

Для любого заданного сообщения панель приложений система использует некоторые члены структуры [**аппбардата**](/windows/desktop/api/Shellapi/ns-shellapi-appbardata) и игнорирует другие. Однако система всегда использует элементы **кбсизе** и **HWND** , поэтому приложение должно заполнить эти члены для каждого сообщения панель приложений. Элемент **кбсизе** задает размер структуры, а элемент **HWND** — дескриптор окна Панель приложений.

Некоторые сообщения панель приложений запрашивают информацию из системы. При обработке этих сообщений система копирует запрошенные сведения в структуру [**аппбардата**](/windows/desktop/api/Shellapi/ns-shellapi-appbardata) .

### <a name="registration"></a>Регистрация

Система сохраняет внутренний список AppBar и сохраняет информацию о каждой строке в списке. Система использует информацию для управления AppBar, выполнения для них служб и отправки сообщений с уведомлениями.

Приложение должно зарегистрировать панель приложений (то есть добавить его во внутренний список), прежде чем оно сможет получить от системы панель приложений Services. Чтобы зарегистрировать панель приложений, приложение отправляет [**\_ новое сообщение АБМ**](abm-new.md) . Сопутствующая структура [**аппбардата**](/windows/desktop/api/Shellapi/ns-shellapi-appbardata) включает в себя обработчик для окна Панель приложений и идентификатор сообщения, определяемый приложением. Система использует идентификатор сообщения для отправки сообщений уведомления в процедуру окна Панель приложений окна. Дополнительные сведения см. в разделе Панель приложений Notification messages.

Приложение отменяет регистрацию панель приложений, отправляя сообщение [**об \_ удалении АБМ**](abm-remove.md) . При отмене регистрации панель приложений удаляется из внутреннего списка AppBar системы. Система больше не отправляет сообщения уведомления панель приложений или не позволяет другим приложениям использовать область экрана, используемую панель приложений. Приложение всегда должно отправить **АБМ \_ Remove** перед уничтожением панель приложений.

### <a name="appbar-size-and-position"></a>Панель приложений размер и расположение

Приложение должно установить размер и положение панель приложений, чтобы оно не влияло на другие AppBar или панель задач. Каждый панель приложений должен быть привязан к определенной границе экрана, а несколько AppBar могут быть привязаны к границе. Однако если панель приложений привязан к тому же самому, что и панель задач, система гарантирует, что панель задач всегда находится на внешнем крае.

Чтобы задать размер и расположение панель приложений, приложение сначала предложит границу экрана и ограничивающий прямоугольник для панель приложений, отправив сообщение [**АБМ \_ куерипос**](abm-querypos.md) . Система определяет, используется ли какая-либо часть экранной области в предложенном прямоугольнике панелью задач или другой панель приложений, корректирует прямоугольник (при необходимости) и возвращает измененный прямоугольник в приложение.

Затем приложение отправляет сообщение [**АБМ \_ сетпос**](abm-setpos.md) , чтобы установить новый ограничивающий прямоугольник для панель приложений. Опять же, система может настроить прямоугольник перед возвратом в приложение. По этой причине приложение должно использовать скорректированный прямоугольник, возвращенный **АБМ \_ сетпос** для установки окончательного размера и расположения. Приложение может использовать функцию [**мовевиндов**](/windows/win32/api/winuser/nf-winuser-movewindow) для перемещения панель приложений в положение.

Используя двухэтапный процесс для установки размера и положения, система позволяет приложению предоставлять пользователю промежуточный отзыв во время операции перемещения. Например, если пользователь перетаскивает панель приложений, приложение может отобразить затененный прямоугольник, указывающий на новую точку перед тем, как панель приложений перемещается.

Приложение должно задать размер и расположение его панель приложений после его регистрации и всякий раз, когда панель приложений получит сообщение уведомления [**АБН \_ посчанжед**](abn-poschanged.md) . Панель приложений получает это уведомление каждый раз, когда происходит изменение размера, расположения или видимости панели задач, а также при каждом изменении размера, добавления или удаления другого панель приложений на той же стороне экрана.

Всякий раз, когда панель приложений получает \_ сообщение активации WM, оно должно отправить сообщение о [**\_ активации АБМ**](abm-activate.md) . Аналогично, когда панель приложений получает сообщение WM \_ виндовпосчанжед, оно должно вызывать [**АБМ \_ виндовпосчанжед**](abm-windowposchanged.md). Отправка этих сообщений гарантирует, что система правильно устанавливает z-порядок любых appbarов автоскрытия на одном и том же крае.

### <a name="autohide-application-desktop-toolbars"></a>Автоматически скрывать панели инструментов рабочего стола приложения

Панель приложений автоматически скрывается, но становится видимым, когда пользователь перемещает курсор мыши к границе экрана, с которой связана панель приложений. Панель приложений скрывает себя снова, когда пользователь перемещает указатель мыши за пределы ограничивающего прямоугольника на панели.

Несмотря на то, что система допускает несколько различных AppBar в любой момент времени, она позволяет только одному элементу автоскрытия панель приложений в каждый момент времени для каждого края экрана на основе первых поступающих. Система автоматически сохраняет z-порядок панель приложений автоскрытия (только в пределах своей группы z-порядка).

Приложение использует сообщение [**АБМ \_ сетаутохидебар**](abm-setautohidebar.md) для регистрации или отмены регистрации панель приложенийа автоскрытия. В сообщении указывается ребро для панель приложений и флаг, указывающий, следует ли регистрировать или отменять регистрацию панель приложений. Сообщение завершается ошибкой, если регистрируется панель приложений, но она уже связана с заданным ребром. Приложение может получить маркер для панель приложенийа автоскрытия, связанного с ребром, отправив [**сообщение \_ жетаутохидебар АБМ**](abm-getautohidebar.md) .

Панель приложений для автоскрытия не требуется регистрировать как обычную панель приложений; то есть его не нужно регистрировать, отправляя [**\_ новое сообщение АБМ**](abm-new.md) . Панель приложений, который не зарегистрирован **АБМ \_ New** , перекрывает все AppBar, привязанные к одному и тому же краям экрана.

### <a name="appbar-notification-messages"></a>Сообщения уведомления панель приложений

Система отправляет сообщения для уведомления панель приложений о событиях, которые могут повлиять на его расположение и внешний вид. Сообщения отправляются в контексте определяемого приложением сообщения. Приложение указывает идентификатор сообщения при отправке [**\_ нового сообщения АБМ**](abm-new.md) для регистрации панель приложений. Код уведомления находится в параметре *wParam* сообщения, определяемого приложением.

Панель приложений получает уведомление о [**АБН \_ посчанжед**](abn-poschanged.md) , когда изменяется размер, положение или состояние видимости панели задач, когда на тот же край экрана добавляется другой панель приложений или изменяется размер или удаление другого панель приложений на том же крае экрана. Панель приложений должен ответить на это сообщение уведомления, отправив сообщения [**АБМ \_ Куерипос**](abm-querypos.md) и [**АБМ \_ сетпос**](abm-setpos.md) . Если положение панель приложений изменилось, оно должно вызвать функцию [**мовевиндов**](/windows/win32/api/winuser/nf-winuser-movewindow) , чтобы переместить себя в новое положение.

Система отправляет сообщение уведомления [**АБН \_ STATECHANGE**](abn-statechange.md) всякий раз, когда изменяется Автоскрытие или постоянное состояние панели задач, то есть когда пользователь устанавливает или снимает флажок **всегда включено** или **автоматически скрывать** окно на странице свойств панели задач. Панель приложений может использовать это сообщение уведомления, чтобы установить его состояние в соответствии с соответствующими настройками панели задач (при необходимости).

При запуске полноэкранного приложения или закрытии последнего полноэкранного приложения панель приложений получает сообщение уведомления о [**АБН \_ фуллскринапп**](abn-fullscreenapp.md) . Параметр *lParam* указывает, будет ли полноэкранное приложение открываться или закрываться. Если он открывается, панель приложений должен быть направлен в нижнюю часть z-порядка. При закрытии последнего полноэкранного приложения панель приложений должен восстановить свою координату z-порядка.

Панель приложений получает уведомление о [**АБН \_ виндоварранже**](abn-windowarrange.md) , когда пользователь выбирает команду каскадная, мозаичная или плитка по вертикали в контекстном меню панели задач. Система отправляет сообщение два раза — перед изменением окна (*lParam* имеет **значение true**) и после расположения окна (*lParam* имеет **значение false**).

Панель приложений может использовать сообщения [**АБН \_ виндоварранже**](abn-windowarrange.md) , чтобы исключить себя из операции каскада или плитки. Чтобы исключить себя, панель приложений должен скрывать себя, когда параметр *lParam* имеет **значение true** , и показывать себя, когда параметр *lParam* имеет **значение false**. Если панель приложений скрывает себя в ответ на это сообщение, ему не нужно отсылать сообщения [**АБМ \_ Куерипос**](abm-querypos.md) и [**АБМ \_ сетпос**](abm-setpos.md) в ответ на операцию Cascade или Tile.

## <a name="registering-an-application-desktop-toolbar"></a>Регистрация панели инструментов рабочего стола приложения

Приложение должно зарегистрировать панель приложений, отправив новое сообщение [**АБМ \_**](abm-new.md) . Регистрация панель приложений добавляет его во внутренний список системы и предоставляет системе идентификатор сообщения, который будет использоваться для отправки сообщений уведомлений в панель приложений. Перед выходом приложение должно отменить регистрацию панель приложений, отправив сообщение об [**\_ удалении АБМ**](abm-remove.md) . При отмене регистрации панель приложений удаляется из внутреннего списка системы и предотвращает получение сообщений уведомления панель приложений.

Функция в следующем примере либо регистрирует, либо отменяет регистрацию панель приложений в зависимости от значения параметра логического флага.


```C++
// RegisterAccessBar - registers or unregisters an appbar. 
// Returns TRUE if successful, or FALSE otherwise. 

// hwndAccessBar - handle to the appbar 
// fRegister - register and unregister flag 

// Global variables 
//     g_uSide - screen edge (defaults to ABE_TOP) 
//     g_fAppRegistered - flag indicating whether the bar is registered 

BOOL RegisterAccessBar(HWND hwndAccessBar, BOOL fRegister) 
{ 
    APPBARDATA abd; 
    
    // An application-defined message identifier
    APPBAR_CALLBACK = (WM_USER + 0x01);
    
    // Specify the structure size and handle to the appbar. 
    abd.cbSize = sizeof(APPBARDATA); 
    abd.hWnd = hwndAccessBar; 

    if (fRegister) 
    { 
        // Provide an identifier for notification messages. 
        abd.uCallbackMessage = APPBAR_CALLBACK; 

        // Register the appbar. 
        if (!SHAppBarMessage(ABM_NEW, &abd)) 
            return FALSE; 

        g_uSide = ABE_TOP;       // default edge 
        g_fAppRegistered = TRUE; 

    } 
    else 
    { 
        // Unregister the appbar. 
        SHAppBarMessage(ABM_REMOVE, &abd); 
        g_fAppRegistered = FALSE; 
    } 

    return TRUE; 
}
```



## <a name="setting-the-appbar-size-and-position"></a>Установка размера и расположения панель приложений

Приложение должно задать размер и расположение панель приложений после регистрации панель приложений, после того как пользователь переместит или изменит размер панель приложений и каждый раз, когда панель приложений получит сообщение с уведомлением [**АБН \_ посчанжед**](abn-poschanged.md) . Перед установкой размера и расположения панель приложений приложение запрашивает в системе утвержденный ограничивающий прямоугольник, отправляя сообщение [**\_ куерипос АБМ**](abm-querypos.md) . Система возвращает ограничивающий прямоугольник, который не влияет на панель задач или другие панель приложений. Система настраивает прямоугольник исключительно на вычитание прямоугольника; Сохранение исходного размера прямоугольника не дает никаких усилий. По этой причине при необходимости панель приложений должен перенастроить прямоугольник после отправки **АБМ \_ куерипос**.

Затем приложение передает ограничивающий прямоугольник обратно в систему, используя сообщение [**АБМ \_ сетпос**](abm-setpos.md) . Затем вызывается функция [**мовевиндов**](/windows/win32/api/winuser/nf-winuser-movewindow) для перемещения панель приложений в положение.

В следующем примере показано, как задать размер и расположение панель приложений.


```C++
// AppBarQuerySetPos - sets the size and position of an appbar. 

// uEdge - screen edge to which the appbar is to be anchored 
// lprc - current bounding rectangle of the appbar 
// pabd - address of the APPBARDATA structure with the hWnd and cbSize members filled

void PASCAL AppBarQuerySetPos(UINT uEdge, LPRECT lprc, PAPPBARDATA pabd) 
{ 
    int iHeight = 0; 
    int iWidth = 0; 

    pabd->rc = *lprc; 
    pabd->uEdge = uEdge; 

    // Copy the screen coordinates of the appbar's bounding 
    // rectangle into the APPBARDATA structure. 
    if ((uEdge == ABE_LEFT) || (uEdge == ABE_RIGHT)) 
    { 
        iWidth = pabd->rc.right - pabd->rc.left; 
        pabd->rc.top = 0; 
        pabd->rc.bottom = GetSystemMetrics(SM_CYSCREEN); 
    } 
    else 
    { 
        iHeight = pabd->rc.bottom - pabd->rc.top; 
        pabd->rc.left = 0; 
        pabd->rc.right = GetSystemMetrics(SM_CXSCREEN); 
    } 

    // Query the system for an approved size and position. 
    SHAppBarMessage(ABM_QUERYPOS, pabd); 

    // Adjust the rectangle, depending on the edge to which the appbar is anchored.
    switch (uEdge) 
    { 
        case ABE_LEFT: 
            pabd->rc.right = pabd->rc.left + iWidth; 
            break; 

        case ABE_RIGHT: 
            pabd->rc.left = pabd->rc.right - iWidth; 
            break; 

        case ABE_TOP: 
            pabd->rc.bottom = pabd->rc.top + iHeight; 
            break; 

        case ABE_BOTTOM: 
            pabd->rc.top = pabd->rc.bottom - iHeight; 
            break; 
    } 

    // Pass the final bounding rectangle to the system. 
    SHAppBarMessage(ABM_SETPOS, pabd); 

    // Move and size the appbar so that it conforms to the 
    // bounding rectangle passed to the system. 
    MoveWindow(pabd->hWnd, 
               pabd->rc.left, 
               pabd->rc.top, 
               pabd->rc.right - pabd->rc.left, 
               pabd->rc.bottom - pabd->rc.top, 
               TRUE); 

}
```



## <a name="processing-appbar-notification-messages"></a>Обработка сообщений уведомлений панель приложений

Панель приложений получает сообщение уведомления при изменении состояния панели задач, при запуске полноэкранного приложения (или при закрытии последнего) или при возникновении события, которое может повлиять на размер и положение панель приложений. В следующем примере показано, как обрабатывать различные сообщения уведомления.


```C++
// AppBarCallback - processes notification messages sent by the system. 

// hwndAccessBar - handle to the appbar 
// uNotifyMsg - identifier of the notification message 
// lParam - message parameter 

void AppBarCallback(HWND hwndAccessBar, UINT uNotifyMsg, 
    LPARAM lParam) 
{ 
    APPBARDATA abd; 
    UINT uState; 

    abd.cbSize = sizeof(abd); 
    abd.hWnd = hwndAccessBar; 

    switch (uNotifyMsg) 
    { 
        case ABN_STATECHANGE: 

            // Check to see if the taskbar's always-on-top state has changed
            // and, if it has, change the appbar's state accordingly.
            uState = SHAppBarMessage(ABM_GETSTATE, &abd); 

            SetWindowPos(hwndAccessBar, 
                         (ABS_ALWAYSONTOP & uState) ? HWND_TOPMOST : HWND_BOTTOM, 
                         0, 0, 0, 0, 
                         SWP_NOMOVE | SWP_NOSIZE | SWP_NOACTIVATE); 

            break; 

        case ABN_FULLSCREENAPP: 

            // A full-screen application has started, or the last full-screen
            // application has closed. Set the appbar's z-order appropriately.
            if (lParam) 
            { 
                SetWindowPos(hwndAccessBar, 
                             (ABS_ALWAYSONTOP & uState) ? HWND_TOPMOST : HWND_BOTTOM, 
                             0, 0, 0, 0, 
                             SWP_NOMOVE | SWP_NOSIZE | SWP_NOACTIVATE); 
            } 
            else 
            { 
                uState = SHAppBarMessage(ABM_GETSTATE, &abd); 

                if (uState & ABS_ALWAYSONTOP) 
                    SetWindowPos(hwndAccessBar, 
                                 HWND_TOPMOST, 
                                 0, 0, 0, 0, 
                                 SWP_NOMOVE | SWP_NOSIZE | SWP_NOACTIVATE); 
            } 

        case ABN_POSCHANGED: 

            // The taskbar or another appbar has changed its size or position.
            AppBarPosChanged(&abd); 
            break; 
    } 
}
```



Следующая функция корректирует ограничивающий прямоугольник панель приложений, а затем вызывает определяемую приложением функцию Аппбаркуерисетпос (включена в предыдущий раздел), чтобы соответствующим образом задать размер и расположение панели.


```C++
// AppBarPosChanged - adjusts the appbar's size and position. 

// pabd - address of an APPBARDATA structure that contains information 
//        used to adjust the size and position. 

void PASCAL AppBarPosChanged(PAPPBARDATA pabd) 
{ 
    RECT rc; 
    RECT rcWindow; 
    int iHeight; 
    int iWidth; 

    rc.top = 0; 
    rc.left = 0; 
    rc.right = GetSystemMetrics(SM_CXSCREEN); 
    rc.bottom = GetSystemMetrics(SM_CYSCREEN); 

    GetWindowRect(pabd->hWnd, &rcWindow); 

    iHeight = rcWindow.bottom - rcWindow.top; 
    iWidth = rcWindow.right - rcWindow.left; 

    switch (g_uSide) 
    { 
        case ABE_TOP: 
            rc.bottom = rc.top + iHeight; 
            break; 

        case ABE_BOTTOM: 
            rc.top = rc.bottom - iHeight; 
            break; 

        case ABE_LEFT: 
            rc.right = rc.left + iWidth; 
            break; 

        case ABE_RIGHT: 
            rc.left = rc.right - iWidth; 
            break; 
    } 

    AppBarQuerySetPos(g_uSide, &rc, pabd); 
}
```



 

 
