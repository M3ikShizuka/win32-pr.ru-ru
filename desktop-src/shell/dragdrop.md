---
description: Многие приложения позволяют пользователям передавать данные в другое приложение путем перетаскивания данных с помощью мыши или буфера обмена.
title: Передача объектов оболочки с помощью перетаскивания и буфера обмена
ms.topic: article
ms.date: 05/31/2018
ms.assetid: bd73098b-2f69-48a4-bb06-e1e0a452e69d
api_name: ''
api_type: ''
api_location: ''
topic_type:
- kbArticle
ms.openlocfilehash: b04523d0ae22eac7bef68f37a6d22ac94b21e303
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104985533"
---
# <a name="transferring-shell-objects-with-drag-and-drop-and-the-clipboard"></a>Передача объектов оболочки с помощью перетаскивания и буфера обмена

Многие приложения позволяют пользователям передавать данные в другое приложение путем перетаскивания данных с помощью мыши или буфера обмена. К числу типов данных, которые могут быть переданы, относятся объекты оболочки, такие как файлы или папки. Обмен данными между оболочками может выполняться между двумя приложениями, но пользователи также могут передавать данные оболочки в рабочий стол или проводник Windows.

Хотя файлы — это наиболее распространенный объект оболочки, передача данных оболочки может заключаться в любом из множества объектов, находящихся в [пространстве имен Shell](namespace-intro.md). Например, приложению может потребоваться переместить файл в виртуальную папку, например в корзину, или принять объект из расширения пространства имен, отличного от Майкрософт. Если вы реализуете расширение пространства имен, оно должно иметь возможность корректно работать в качестве источника и целевого объекта перетаскивания.

В этом документе обсуждается, как приложения могут реализовывать перетаскивание и передачу данных в буфер обмена с помощью объектов оболочки.

-   [Объект данных оболочки](dataobject.md)
-   [Форматы буфера обмена оболочки](clipboard.md)
-   [Обработка сценариев передачи данных оболочки](datascenarios.md)

## <a name="how-drag-and-drop-works-with-shell-objects"></a>Принцип работы перетаскивания с объектами оболочки

Приложениям часто требуется предоставить пользователям способ передачи данных оболочки. Ниже приведены некоторые примеры.

-   Перетаскивание файла из проводника Windows или рабочего стола в приложение.
-   Копирование файла в буфер обмена в проводнике Windows и его вставление в приложение.
-   Перетаскивание файла из приложения в корзину.

Подробное описание способов обработки этих и других сценариев см. в разделе [Обработка сценариев передача данных оболочки](datascenarios.md). В этом документе рассматриваются общие принципы обмена данными в оболочке.

Windows предоставляет два стандартных способа для перемещения данных оболочки в приложениях:

-   Пользователь вырезает или копирует данные оболочки, например один или несколько файлов, в буфер обмена. Другое приложение получает данные из буфера обмена.
-   Пользователь перетаскивает значок, представляющий данные из исходного приложения, и удаляет значок в окне, принадлежащем целевому объекту.

В обоих случаях передаваемые данные содержатся в *объекте данных*. Объекты данных являются объектами модели COM, которые предоставляют интерфейс [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) . Схематическое руководство состоит из трех этапов, которые должны выполнять все передачи данных в оболочке:

1.  Источник создает объект данных, представляющий передаваемые данные.
2.  Целевой объект получает указатель на интерфейс [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) объекта данных.
3.  Цель вызывает интерфейс [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) для извлечения данных из него.

Разница между буфером обмена и перемещением данных при перетаскивании заключается в основном в том, как передается указатель [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) из источника в целевой объект.

### <a name="clipboard-data-transfers"></a>Передача данных из буфера обмена

Буфер обмена — это самый простой способ перемещения данных оболочки. Основная процедура аналогична передаче стандартных данных буфера обмена. Однако, поскольку вы передаете указатель на объект данных, а не сами данные, необходимо использовать API OLE Clipboard вместо стандартного API буфера обмена. В следующей процедуре показано, как использовать интерфейс API буфера обмена OLE для перемещения данных оболочки в буфер обмена.

1.  Источник данных создает объект данных для хранения данных.
2.  Источник данных вызывает [**олесетклипбоард**](/windows/win32/api/ole2/nf-ole2-olesetclipboard), который помещает указатель на интерфейс [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) объекта данных в буфер обмена.
3.  Цель вызывает [**олежетклипбоард**](/windows/win32/api/ole2/nf-ole2-olegetclipboard) для получения указателя на интерфейс [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) объекта данных.
4.  Целевой объект извлекает данные путем вызова метода [**IDataObject:: GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) .
5.  При передаче данных в оболочке целевому объекту также может потребоваться вызвать метод [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) объекта данных, чтобы отправить отзыв объекту данных в результате передачи данных. Пример этого типа операций см. в разделе [Обработка оптимизированных операций перемещения](datascenarios.md) .

### <a name="drag-and-drop-data-transfers"></a>Перемещение данных при перетаскивании

Хотя несколько сложнее в реализации, перемещение данных с помощью перетаскивания имеет значительные преимущества по сравнению с буфером обмена:

-   Перемещение по перетаскиванию можно выполнить с помощью простого перемещения мыши, что делает операцию более гибкой и удобной для использования, чем буфер обмена.
-   Перетаскивание предоставляет пользователю визуальное представление операции. Пользователь может следовать за значком при переходе от источника к целевому объекту.
-   Перетаскивание уведомляет целевой объект, когда данные доступны.

Операции перетаскивания также используют объекты данных для переноса данных. Однако источник удаления должен предоставлять функциональные возможности, которые выходят за рамки, необходимые для перемещения буфера обмена:

-   Источник удаления должен также создать объект, предоставляющий интерфейс [**идропсаурце**](/windows/win32/api/oleidl/nn-oleidl-idropsource) . Система использует **идропсаурце** для связи с источником во время выполнения операции.
-   Объект данных перетаскивания отвечает за отслеживание перемещения курсора и отображение значка для представления объекта данных.

Цели перетаскивания также должны предоставлять больше функций, чем требуется для обработки перемещений в буфер обмена:

-   Цель перетаскивания должна предоставлять интерфейс [**интерфейс IDropTarget**](/windows/win32/api/oleidl/nn-oleidl-idroptarget) . Когда курсор находится над целевым окном, система использует **интерфейс IDropTarget** для предоставления целевой информации, например позиции курсора, и для уведомления об удалении данных.
-   Цель перетаскивания должна быть зарегистрирована в системе путем вызова [**регистердрагдроп**](/windows/win32/api/ole2/nf-ole2-registerdragdrop). Эта функция обеспечивает систему с помощью маркера целевого окна и указателя на интерфейс [**интерфейс IDropTarget**](/windows/win32/api/oleidl/nn-oleidl-idroptarget) целевого приложения.

> [!Note]  
> Для операций перетаскивания приложение должно инициализировать COM с помощью [**олеинитиализе**](/windows/win32/api/ole2/nf-ole2-oleinitialize), а не [**CoInitialize**](/windows/win32/api/objbase/nf-objbase-coinitialize).

 

Следующая процедура описывает ключевые шаги, которые обычно используются для переноса данных оболочки с помощью перетаскивания.

1.  Цель вызывает [**регистердрагдроп**](/windows/win32/api/ole2/nf-ole2-registerdragdrop) , чтобы дать системе указатель на интерфейс [**интерфейс IDropTarget**](/windows/win32/api/oleidl/nn-oleidl-idroptarget) и зарегистрировать окно в качестве целевого объекта перетаскивания.
2.  Когда пользователь запускает операцию перетаскивания, источник создает объект данных и инициирует *цикл перетаскивания* путем вызова [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop).
3.  Когда курсор находится над целевым окном, система уведомляет целевой объект, вызывая один из методов [**интерфейс IDropTarget**](/windows/win32/api/oleidl/nn-oleidl-idroptarget) целевого объекта. Система вызывает [**интерфейс IDropTarget::D ражентер**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-dragenter) , когда курсор попадает в целевое окно, и [**интерфейс IDropTarget::D раговер**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-dragover) по мере прохождения курсора в целевом окне. Оба метода обеспечивают цель перетаскивания текущей позицией курсора и состояние клавиш с модификаторами клавиатуры, таких как CTRL или ALT. Когда курсор покидает целевое окно, система уведомляет целевой объект, вызывая [**интерфейс IDropTarget::D раглеаве**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-dragleave). Когда любой из этих методов возвращает значение, система вызывает интерфейс [**идропсаурце**](/windows/win32/api/oleidl/nn-oleidl-idropsource) для передачи возвращаемого значения в источник.
4.  Когда пользователь отпускает кнопку мыши для удаления данных, система вызывает метод [**интерфейс IDropTarget::D верхнем**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) целевого объекта. Между параметрами метода — это указатель на интерфейс [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) объекта данных.
5.  Цель вызывает метод [**IDataObject:: GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) объекта данных для извлечения данных.
6.  При передаче данных в оболочке целевому объекту также может потребоваться вызвать метод [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) объекта данных, чтобы отправить отзыв источнику на результат передачи данных.
7.  Когда целевой объект завершит работу с объектом данных, он возвращается из [**интерфейс IDropTarget::D верхнем**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop). Система возвращает вызов [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) источника для уведомления источника о завершении передачи данных.
8.  В зависимости от конкретного [сценария передачи данных](datascenarios.md)источнику может потребоваться выполнить дополнительные действия в зависимости от значения, возвращаемого [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) , и значений, которые передаются в объект данных целевым объектом. Например, при перемещении файла источник должен проверить эти значения, чтобы определить, должен ли он удалить исходный файл.
9.  Источник освобождает объект данных.

Хотя процедуры, описанные выше, предоставляют хорошую общую модель для передачи данных оболочки, существует множество различных типов данных, которые могут содержаться в объекте данных оболочки. Существует также ряд различных сценариев для обмена данными, которые могут потребоваться для работы приложения. Для каждого типа данных и сценария требуется несколько иной подход к трем ключевым этапам процедуры:

-   Как источник конструирует объект данных для хранения данных оболочки.
-   То, как целевой объект извлекает данные оболочки из объекта данных.
-   Как источник завершает операцию обмена данными.

[Объект данных оболочки](dataobject.md) предоставляет общее описание того, как источник создает объект данных оболочки и как этот объект данных может обрабатываться целевым объектом. [Обработка сценариев передача данных оболочки](datascenarios.md) подробно рассказывает о том, как обрабатывать ряд распространенных сценариев обмена данными с оболочкой.

 

 
