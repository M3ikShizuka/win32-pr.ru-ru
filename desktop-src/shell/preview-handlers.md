---
description: Обработчики просмотра вызываются, когда элемент выбран для отображения упрощенного, доступного только для чтения просмотра содержимого файла в области чтения представления. Это делается без запуска приложения, связанного с файлом.
ms.assetid: 166a4001-d237-44a4-a457-e320e995639c
title: Обработчик предварительной версии и узел предварительной версии оболочки
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 993c6c8e7b15d9bfc24b5dd42352407a3a53c45b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104985640"
---
# <a name="preview-handlers-and-shell-preview-host"></a>Обработчик предварительной версии и узел предварительной версии оболочки

Обработчики просмотра вызываются, когда элемент выбран для отображения упрощенного, *доступного только для чтения* просмотра содержимого файла в области чтения представления. Это делается без запуска приложения, связанного с файлом.

В этом разделе рассматриваются следующие темы:

-   [Архитектура обработчика просмотра](#preview-handler-architecture)
-   [Параметры серверной модели](#server-model-options)
-   [Инициализация](#initialization)
-   [Поток данных обработчика просмотра](#preview-handler-data-flow)
-   [Отладка обработчика просмотра](#debugging-a-preview-handler)
-   [Предоставление собственного процесса для обработчика просмотра](#providing-your-own-process-for-a-preview-handler)
-   [См. также](#related-topics)

## <a name="preview-handler-architecture"></a>Архитектура обработчика просмотра

Обработчик просмотра — это размещенное приложение. Узлы включают проводник Windows в Windows Vista или Microsoft Outlook 2007. Узлы реализуют [**IPreviewHandlerFrame**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ipreviewhandlerframe) в качестве метода взаимодействия между обработчиком просмотра и узлом.

Обработчик предварительной версии реализует следующие интерфейсы:

-   [**IInitializeWithStream**](/windows/desktop/api/Propsys/nn-propsys-iinitializewithstream)
-   [**IObjectWithSite**](/windows/win32/api/ocidl/nn-ocidl-iobjectwithsite)
-   [**иолевиндов**](/windows/win32/api/oleidl/nn-oleidl-iolewindow)
-   [**IPreviewHandler**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ipreviewhandler)
-   [**Ипревиевхандлервисуалс**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ipreviewhandlervisuals) (необязательно)

Обработчик вызывается через его [**IObjectWithSite**](/windows/win32/api/ocidl/nn-ocidl-iobjectwithsite), который возвращает указатель [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) , с помощью которого вы запрашиваете объект [**IPreviewHandlerFrame**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ipreviewhandlerframe) для взаимодействия с узлом.

## <a name="server-model-options"></a>Параметры серверной модели

Обработчики предварительной версии всегда выполняются вне процесса. Существует два метода реализации этого:

1.  Обработчик просмотра можно построить как внутрипроцессный сервер, но выполнить его через внутрипроцессный суррогатный узел. Это является предпочтительным методом. Система предоставляет суррогатный узел для этого в файле Prevhost.exe. Обработчики просмотра, созданные с помощью этого метода, несовместимы с Outlook 2007 в Windows XP. Однако эти же обработчики будут работать в проводнике Windows и Outlook 2007, работающем под управлением Windows Vista.
2.  Обработчик просмотра можно построить как сервер модели COM. Это не рекомендуется по нескольким причинам. Во-первых, реализация внутрипроцессного сервера упрощается. Что более важно, реализация в качестве внутрипроцессного сервера обеспечивает больший контроль над временем существования объекта обработчика, что обеспечивает лучшую очистку и эффективность.

По умолчанию обработчики предварительной версии выполняются в процессе низкого уровня целостности (IL) по соображениям безопасности. При необходимости можно отключить запуск в качестве процесса с низким IL, задав в реестре следующее значение. Однако это не рекомендуется делать. В конечном итоге системы могут быть настроены на отклонение любого процесса, который не имеет низкого уровня IL.

```
HKEY_CLASSES_ROOT
   CLSID
      {YOUR HANDLER'S CLSID}
         DisableLowILProcessIsolation [DWORD] = 1
```

Разные обработчики просмотра по умолчанию используют один и тот же процесс. Одновременно могут выполняться два экземпляра Prevhost.exe; один для обработчиков, выполняющихся в качестве процессов с низким IL, один для обработчиков, которые выказали от этого поведения.

## <a name="initialization"></a>Инициализация

Как и в случае с эскизами и обработчиками свойств, настоятельно рекомендуется инициализировать обработчик с помощью потока. При необходимости можно инициализировать по файлу или элементу, но потоки предоставляют наиболее безопасный способ реализации обработчика. Инициализация через поток обеспечивает целостность файлов и повышает стабильность системы при выполнении обработчика в качестве процесса низкого IL, например при защите системы от переполнения буфера, ограничении места, в котором обработчик может записывать сведения, и ограничении связи с другими окнами.

Если необходимо выполнить инициализацию с помощью файла или элемента оболочки, сохраните путь к файлу или ссылку на [**интерфейса IShellItem**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellitem). Не считайте данные из этих источников, пока не будет вызван [**IPreviewHandler::D опревиев**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-dopreview) .

Как правило, инициализация не должна выполнять никаких больших действий, таких как составление и хранение предварительного изображения. Для оптимальной эффективности такая обработка не должна выполняться до тех пор, пока не будет вызван предварительный просмотр для.

## <a name="preview-handler-data-flow"></a>Поток данных обработчика просмотра

Поток данных в процессе предварительной версии соответствует общему пути, показанному здесь. Узел можно рассматривать как проводник Windows в Windows Vista или Outlook 2007.

1.  Обработчик просмотра инициализируется, желательно с потоком.
2.  Окно представления передается с узла в обработчик через [**IPreviewHandler:: сетвиндов**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-setwindow).
3.  На этом этапе обработчик не должен выполнять никаких действий до тех пор, пока не будет вызван [**IPreviewHandler::D опревиев**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-dopreview) .
4.  Предварительный просмотр отображается в области чтения с помощью вызова [**IPreviewHandler::D опревиев**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-dopreview).
5.  Размер окна задается с помощью [**IPreviewHandler:: SetRect**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-setrect).
6.  При необходимости размер окна изменяется с помощью [**IPreviewHandler:: SetRect**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-setrect).
7.  Предварительная версия выгружается, а ее ресурсы освобождаются, когда она больше не нужна, с помощью вызова [**IPreviewHandler:: unload**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-unload).

## <a name="debugging-a-preview-handler"></a>Отладка обработчика просмотра

Если вы выполнили рекомендации по реализации обработчика просмотра в качестве внутрипроцессного сервера, можно присоединиться к Prevhost.exe, чтобы выполнить отладку обработчика просмотра. Как упоминалось ранее, имейте в виду, что могут существовать два экземпляра Prevhost.exe, один для обычных процессов с низким уровнем IL и один для обработчиков, которые не работают как процесс с низким IL.

Если вы не нашли Prevhost.exe в списке доступных процессов, возможно, он не был загружен в этот момент. Если щелкнуть файл для предварительного просмотра, загружается суррогат, который затем должен отображаться как присоединяемый процесс.

## <a name="providing-your-own-process-for-a-preview-handler"></a>Предоставление собственного процесса для обработчика просмотра

Если требуется принудительно создать новый процесс для обработчика, а не для процесса по умолчанию, создайте новый подраздел для обработчика в каталоге **AppID** и задайте для его записи дллсуррогате значение "Prevhost.exe". Используйте этот подраздел **AppID** вместо Prevhost.exe **AppID** по умолчанию.

Предоставляя новый процесс, обработчик может избежать выполнения в рамках общего процесса, как это будет сделано по умолчанию. Это позволяет, например, убедиться, что в процессе определена конкретная версия среды CLR. Это необходимо при построении управляемой реализации обработчика просмотра.

> [!Note]  
> 32-разрядные обработчики просмотра должны использовать **AppID** {534A1E02-D58F-44f0-B58B-36CBED287C7C} при установке в 64-разрядных операционных системах.

 

## <a name="related-topics"></a>См. также

<dl> <dt>

[Создание обработчиков предварительного просмотра](building-preview-handlers.md)
</dt> <dt>

[Регистрация обработчика просмотра](how-to-register-a-preview-handler.md)
</dt> <dt>

[Рекомендации по обработчику предварительной версии](preview-handler-guidelines.md)
</dt> </dl>

 

 
