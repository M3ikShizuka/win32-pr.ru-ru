---
description: Функция обратного вызова Кплапплет обрабатывает все сообщения, отправляемые в элемент панели управления Windows. Сообщения, отправляемые в функцию, задаются в определенном порядке. С помощью одного и того же маркера элемент. cpl требует, чтобы сообщения обрабатывались особым образом.
ms.assetid: 70302698-f9d5-4de4-a662-4815002eea52
title: Обработка сообщений в панели управления
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0b8b43c6e265030279a6644547f41e3630208325
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103999051"
---
# <a name="control-panel-message-processing"></a>Обработка сообщений в панели управления

Функция обратного вызова [**кплапплет**](/windows/win32/api/cpl/nc-cpl-applet_proc) обрабатывает все сообщения, отправляемые в элемент панели управления Windows. Сообщения, отправляемые в функцию, задаются в определенном порядке. С помощью одного и того же маркера элемент. cpl требует, чтобы сообщения обрабатывались особым образом.

Во первых, функция [**кплапплет**](/windows/win32/api/cpl/nc-cpl-applet_proc) получает сообщение CPL \_ init, когда Windows впервые загружает элемент панели управления. Функция должна выполнять любую инициализацию, например выделение памяти, и возвращать ненулевое значение. Если **кплапплет** не может завершить инициализацию, он должен вернуть ноль, направляя Windows для завершения обмена данными и освобождения библиотеки DLL.

Затем, если сообщение CPL \_ init прошло удачно, Windows отправляет \_ сообщение CPL NOCOUNT. Затем функция должна возвращать количество элементов панели управления, поддерживаемое DLL-файлом.

Затем функция [**кплапплет**](/windows/win32/api/cpl/nc-cpl-applet_proc) получает одно \_ сообщение с запросом CPL и одно \_ сообщение CPL Невинкуире для каждого элемента панели управления, поддерживаемого DLL-файлом. Функция заполняет структуру [**кплинфо**](/windows/win32/api/cpl/ns-cpl-cplinfo) или [**невкплинфо**](/windows/win32/api/cpl/ns-cpl-newcplinfoa) сведениями об элементе, например его имя, значок и описательную строку. Большинство приложений должны обрабатывать сообщение с \_ запросом CPL и игнорировать сообщение CPL \_ невинкуире. Сообщение с \_ запросом CPL предоставляет сведения в форме, которую Windows может кэшировать, что приводит к значительному повышению производительности. Сообщение CPL \_ невинкуире используется только в том случае, если необходимо изменить значок элемента или отобразить строки в зависимости от состояния компьютера. Элементы панели управления, использующие CPL \_ невинкуире, не могут быть найдены в меню " **Пуск** " в Windows Vista, так как они полагаются на кэширование.

Функция [**кплапплет**](/windows/win32/api/cpl/nc-cpl-applet_proc) далее получает \_ сообщение CPL дблклк в качестве уведомления о том, что пользователь выбрал значок, представляющий элемент панели управления. Функция может получить это сообщение любое количество раз. Сообщение содержит идентификатор элемента и указатель **лпдата** , возвращенный в структуре [**кплинфо**](/windows/win32/api/cpl/ns-cpl-cplinfo) или [**невкплинфо**](/windows/win32/api/cpl/ns-cpl-newcplinfoa) в вызове [**CPL \_**](cpl-inquire.md) Call или [**CPL \_ невинкуире**](cpl-newinquire.md). Функция должна отображать соответствующее диалоговое окно и обрабатывать последующие входные данные пользователя.

Помимо CPL \_ дблклк, сообщение CPL \_ стартвпармс может быть отправлено, если элемент панели управления вызывается с входными параметрами, например из командной строки или из другой программы. Сообщение содержит идентификатор элемента вместе с дополнительной строкой параметра.

Перед завершением управления приложением [**кплапплет**](/windows/win32/api/cpl/nc-cpl-applet_proc) получает \_ сообщение об ошибке CPL по одному разу для каждого элемента панели управления, поддерживаемого DLL-файлом. Сообщение содержит идентификатор для элемента панели управления и указатель **лпдата** , возвращенный в структуре [**кплинфо**](/windows/win32/api/cpl/ns-cpl-cplinfo) или [**невкплинфо**](/windows/win32/api/cpl/ns-cpl-newcplinfoa) в вызове [**CPL \_ запрос**](cpl-inquire.md) или [**CPL \_ невинкуире**](cpl-newinquire.md). Функция должна освободить память, выделенную для указанного диалогового окна.

После последнего \_ сообщения об ошибке CPL [**кплапплет**](/windows/win32/api/cpl/nc-cpl-applet_proc) получает сообщение о \_ выходе CPL. Функция должна освободить всю оставшуюся выделенную память и отменить регистрацию всех закрытых классов окна, которые могли быть зарегистрированы. Сразу после того, как функция возвращает из этого сообщения, Windows освобождает элемент панели управления, вызывая функцию [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) .

## <a name="related-topics"></a>См. также

<dl> <dt>

[Элементы панели управления](control-panel-applications.md)
</dt> <dt>

[Руководство по работе пользователей](user-experience-guidelines.md)
</dt> <dt>

[Регистрация элементов панели управления](registering-control-panel-items.md)
</dt> <dt>

[Использование Кплапплет](using-cplapplet.md)
</dt> <dt>

[Исполнение элементов панели управления](executing-control-panel-items.md)
</dt> <dt>

[Расширение элементов панели управления "система"](extending-system-control-panel-items.md)
</dt> <dt>

[Назначение категорий панели управления](assigning-control-panel-categories.md)
</dt> <dt>

[Создание ссылок на задачи с возможностью поиска для элемента панели управления](creating-searchable-task-links.md)
</dt> <dt>

[Доступ к панели управления в защищенном режиме в Windows Vista](accessing-the-cp-in-safe-mode-under-vista.md)
</dt> </dl>

 

 
