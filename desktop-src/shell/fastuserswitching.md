---
description: Учетные записи пользователей Windows XP позволяют одновременно входить в систему нескольких пользователей, каждый из которых имеет свои собственные настройки и каждый из них работает с собственными приложениями.
ms.assetid: bc404afc-f73e-404d-854d-faab5cf205a5
title: Учетные записи пользователей с быстрым переключением пользователей и удаленный рабочий стол
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fc26471bcf56efce79fb5ccc91a78c24e43ae312
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104997751"
---
# <a name="user-accounts-with-fast-user-switching-and-remote-desktop"></a>Учетные записи пользователей с быстрым переключением пользователей и удаленный рабочий стол

Учетные записи пользователей Windows XP позволяют одновременно входить в систему нескольких пользователей, каждый из которых имеет свои собственные настройки и каждый из них работает с собственными приложениями. Поскольку одному пользователю не нужно выходить из системы для разрешения доступа к другому пользователю, Рабочий стол каждого пользователя легко получается с помощью функции быстрого переключения пользователей. Учетные записи пользователей также включают в себя компонент личного сервера терминалов или удаленный рабочий стол, который позволяет пользователям получать доступ к учетной записи рабочего стола из удаленных систем.

Обсуждаются следующие темы.

-   [Требования к использованию инфраструктуры](#infrastructure-usage-requirements)
-   [Совместимость с существующими приложениями](#compatibility-with-existing-applications)
-   [Регистрация для уведомления о переключении сеансов](#registering-for-session-switching-notification)
-   [Обеспечение выполнения только одного экземпляра приложения](#ensuring-only-one-instance-of-your-application-is-running)
-   [Завершение работы приложения во всех сеансах](#shutting-down-your-application-across-all-sessions)
-   [Взаимодействие с системными службами](#interaction-with-system-services)
-   [удаленный рабочий стол и пропускная способность](#remote-desktop-and-bandwidth)

## <a name="infrastructure-usage-requirements"></a>Требования к использованию инфраструктуры

Базовая инфраструктура, унаследованная от Windows 2000, поддерживает разделение состояния пользовательских данных, параметров пользователей и параметров компьютера. Используя преимущества этой инфраструктуры, для успешного запуска приложения под управлением Windows XP необходимо следующее:

-   По умолчанию используется папка **Мои документы** для хранения данных, созданных пользователем.
-   Правильно классифицировать и хранить данные приложения.
-   Постепенное снижение "сообщений об отказе в доступе".

Временные файлы, размещенные в памяти файлы и документы должны храниться в соответствующем подкаталоге каталога профиля пользователя. Используйте [**шжетфолдерлокатион**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shgetfolderlocation) или [**шжетфолдерпас**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shgetfolderpatha) , чтобы определить соответствующее место хранения для этих файлов. Передача флага [**CSid " \_ AppData**](csidl.md) " в эти функции возвращает путь к каталогу файловой системы, который служит общим репозиторием для данных конкретного приложения. **Для данных \_** , которые должны изменяться при изменении пользователем, например временных файлов, используйте вместо маркера CSid [**\_ локальную папку \_ AppData**](csidl.md) .

Перечисленные выше требования являются подмножеством этих компонентов в программе сертификации Майкрософт. Дополнительные сведения см. на странице « **сертифицировано для Windows Program** » в разделе https://www.microsoft.com/windowsserver2003/partners/isvs/cfw.mspx .

## <a name="compatibility-with-existing-applications"></a>Совместимость с существующими приложениями

Как быстрое переключение пользователей, так и персональный сервер терминалов используют технологию служб терминалов и поэтому совместимы с большинством приложений Microsoft Win32. Если приложение является совместимым с логотипом Windows 2000, реализуя базовое разделение профилей и функции управления питанием, это приложение должно работать должным образом под отдельными учетными записями пользователей Windows XP.

## <a name="registering-for-session-switching-notification"></a>Регистрация для уведомления о переключении сеансов

Как правило, приложение не должно получать уведомления при появлении параметра Desktop. Однако приложения, которые должны получать уведомления, когда учетная запись, под которой они выполняются, — это текущий рабочий стол, например приложения, обращающиеся к последовательному порту или другим общим ресурсам, могут зарегистрироваться для получения уведомлений о переключении на Рабочий стол. Чтобы зарегистрироваться для получения уведомления, используйте функцию [**втсрегистерсессионнотификатион**](/windows/win32/api/wtsapi32/nf-wtsapi32-wtsregistersessionnotification) .

После вызова этой функции окно с дескриптором *HWND* регистрируется для получения сообщения об [**\_ \_ изменении WM втссессион**](../termserv/wm-wtssession-change.md) с помощью функции **WndProc** . Идентификатор сеанса отправляется в параметре **lParam** , а код, указывающий на событие, создавшее сообщение, отправляется в **wParam** как один из следующих флагов.

-   \_ \_ Подключение к консоли ВТС
-   \_отключение консоли \_ ВТС
-   ВТС \_ Remote \_ Connect
-   ВТС \_ Удаленное \_ Отключение
-   \_ \_ выход из сеанса ВТС
-   \_Вход в сеанс ВТС \_

Приложения могут использовать это сообщение для отслеживания состояния, а также для выпуска и получения ресурсов, относящихся к консоли. Пользовательские рабочие столы можно динамически переключать между удаленным и консольным управлением. Приложения должны использовать сообщение [**об \_ \_ изменении WM втссессион**](../termserv/wm-wtssession-change.md) для синхронизации с удаленным или локальным состоянием соединения.

Если процесс больше не требует таких уведомлений или завершается, он должен вызвать [**втсунрегистерсессионнотификатион**](/windows/win32/api/wtsapi32/nf-wtsapi32-wtsunregistersessionnotification) для отмены регистрации уведомления.

> [!IMPORTANT]
> Значения **HWND** , передаваемые в [**втсрегистерсессионнотификатион**](/windows/win32/api/wtsapi32/nf-wtsapi32-wtsregistersessionnotification) , считаются ссылочными, поэтому необходимо установить одинаковое число вызовов [**втсунрегистерсессионнотификатион**](/windows/win32/api/wtsapi32/nf-wtsapi32-wtsunregistersessionnotification) , чтобы обеспечить освобождение всех выделенных ресурсов.

 

## <a name="ensuring-only-one-instance-of-your-application-is-running"></a>Обеспечение выполнения только одного экземпляра приложения

Многие приложения должны обеспечивать работу только одного экземпляра. Существует несколько способов сделать это в Windows XP. К ним относятся следующие:

-   Используйте [**FindWindow**](/windows/win32/api/winuser/nf-winuser-findwindowa) или [**FindWindowEx**](/windows/win32/api/winuser/nf-winuser-findwindowexa) для поиска известного окна, которое открывается приложением. Если это окно уже открыто, вы можете использовать его в качестве свидетельства о том, что приложение уже выполняется.
-   Создайте объект мьютекса или семафора при открытии приложения и закройте этот объект при завершении работы приложения. Пространство имен глобальных объектов разделяются для каждого настольного компьютера, что позволяет получить уникальный список мьютексов и объектов семафора для каждого из них.

## <a name="shutting-down-your-application-across-all-sessions"></a>Завершение работы приложения во всех сеансах

Приложению может потребоваться завершить работу во всех сеансах. Например, приложение, выполняющееся в двух или более сеансах одновременно, может загрузить новый файл из Интернета. Затем может потребоваться закрыть себя и перезапуститься с обновленными битами. Это, конечно, потребуется сделать во всех выполняющихся сеансах. Приложение должно быть написано таким образом, чтобы оно нормально записывалось при получении уведомления.

## <a name="interaction-with-system-services"></a>Взаимодействие с системными службами

С программной точки зрения необходимо решить следующие ситуации.

-   Серверный процесс получает прямой запрос от клиентского процесса.

    В этом случае сообщение, вероятно, передается с помощью вызова локальной процедуры (LPC) или удаленного вызова процедур (RPC). Есть интерфейсы API для LPC или RPC, которые позволяют получать маркер клиента. После получения маркера клиента сервер может использовать его при вызове [**параметр CreateProcessAsUser**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessasusera). Это приводит к пометке процесса на правильной станции, предполагая, что у маркера пользователя клиента есть тег сеанса.

    > [!Note]  
    > В настоящее время [**параметр CreateProcessAsUser**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) не поддерживает наследование в сеансах.

     

-   Серверный процесс получает уведомление и должен отображать пользовательский интерфейс, но отображение не обязательно должно находиться в контексте текущего пользователя.

    В этом случае серверный процесс может дублировать основной маркер процесса и изменить идентификатор текущего сеанса, чтобы он соответствовал текущему идентификатору сеанса. Текущий идентификатор сеанса можно получить с помощью функции [**втсжетактивеконсолесессионид**](/windows/win32/api/winbase/nf-winbase-wtsgetactiveconsolesessionid) .

    > [!Note]  
    > Чтобы задать идентификатор сеанса маркера, необходимы **\_ \_ права доступа к TCB**. Это будет работать только в качестве службы, работающей в системе NT AUTHORITY \\ .

     

## <a name="remote-desktop-and-bandwidth"></a>удаленный рабочий стол и пропускная способность

Благодаря добавлению удаленный рабочий столной функции в Windows XP, приложения должны не использовать больше пропускной способности, чем требуется, и избежать больших изображений и эффектов анимации при удаленном подключении к рабочему столу. Чтобы определить, является ли текущий сеанс удаленным, можно вызвать [**жетсистемметрикс**](/windows/win32/api/winuser/nf-winuser-getsystemmetrics) с **SM \_ ремотесессион**. Однако имейте в виду, что этот вызов не различает удаленный и отключенный.

 

 
