---
description: Процедура реализации расширения пространства имен аналогична процедуре для любого другого внутрипроцессного объекта компонента модели COM.
title: Реализация интерфейсов объекта папки Basic
ms.topic: article
ms.date: 05/31/2018
ms.assetid: a45b8011-5355-429b-8935-4a7bdb5d2316
api_name: ''
api_type: ''
api_location: ''
topic_type:
- kbArticle
ms.openlocfilehash: c05f5d2e4c21a923856c7324ad2d407230fa7595
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104985661"
---
# <a name="implementing-the-basic-folder-object-interfaces"></a>Реализация интерфейсов объекта папки Basic

Процедура реализации расширения пространства имен аналогична процедуре для любого другого внутрипроцессного объекта компонента модели COM. Все расширения должны поддерживать три основных интерфейса, которые предоставляют проводнику Windows Основные сведения, необходимые для отображения папок расширения в представлении в виде дерева. Однако, чтобы полностью использовать возможности проводника Windows, расширение также должно предоставлять один или несколько дополнительных интерфейсов, поддерживающих более сложные функции, такие как контекстные меню или перетаскивание, и предоставлять представление папок.

В этом документе рассматривается реализация основного и дополнительного интерфейсов, которые Windows Explorer вызывает для получения сведений о содержимом вашего расширения. Обсуждение реализации представления папок и настройки проводника Windows см. в разделе [Реализация представления папок](../lwef/nse-folderview.md).

-   [Базовая реализация и регистрация](#basic-implementation-and-registration)
    -   [Регистрация расширения](#registering-an-extension)
-   [Обработка PIDL](#handling-pidls)
    -   [Создание структуры ШИТЕМИД](#creating-an-shitemid-structure)
    -   [Создание ПИДЛ](#constructing-a-pidl)
    -   [Интерпретация PIDL](#interpreting-pidls)
-   [Реализация основных интерфейсов](#implementing-the-primary-interfaces)
    -   [Интерфейс Иперсистфолдер](#ipersistfolder-interface)
    -   [Интерфейс Ишеллфолдер](#ishellfolder-interface)
    -   [Интерфейс Иенумидлист](#ienumidlist-interface)
-   [Реализация необязательных интерфейсов](#implementing-the-optional-interfaces)
    -   [иекстрактикон](#iextracticon)
    -   [IContextMenu](#icontextmenu)
    -   [икуеринфо](#iqueryinfo)
    -   [IDataObject и интерфейс IDropTarget](#idataobject-and-idroptarget)
-   [Работа с реализацией представления папки оболочки по умолчанию](#working-with-the-default-shell-folder-view-implementation)

## <a name="basic-implementation-and-registration"></a>Базовая реализация и регистрация

В качестве внутрипроцессного COM-сервера библиотека DLL должна предоставлять несколько стандартных функций и интерфейсов:

-   [**DllCanUnloadNow**](/windows/win32/api/combaseapi/nf-combaseapi-dllcanunloadnow)
-   [**DllGetClassObject**](/windows/win32/api/combaseapi/nf-combaseapi-dllgetclassobject)
-   [**IClassFactory**](/windows/win32/api/unknwn/nn-unknwn-iclassfactory)
-   [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown)

Эти функции и интерфейсы реализуются так же, как и для большинства других COM-объектов. Дополнительные сведения см. в [документации по com](../com/the-component-object-model.md).

### <a name="registering-an-extension"></a>Регистрация расширения

Как и для всех COM-объектов, необходимо создать GUID идентификатора класса (CLSID) для вашего расширения. Зарегистрируйте объект, создав подраздел с **\_ \_ корневым** \\ **идентификатором CLSID** классов hKey с именем для идентификатора CLSID вашего расширения. Библиотека DLL должна быть зарегистрирована как внутрипроцессный сервер и должна указывать модель потоков подразделений. Поведение корневой папки расширения можно настроить, добавив различные подразделы и значения в ключ CLSID расширения.

Некоторые из этих значений применяются только к расширениям с точками виртуального соединения. Эти значения не применяются к расширениям, точки соединения которых являются папками файловой системы. Дополнительные сведения см. [в статье указание расположения расширения пространства имен](nse-junction.md). Чтобы изменить поведение расширения с помощью виртуальной точки соединения, добавьте одно или несколько следующих значений в ключ CLSID расширения:

-   Вантсфорпарсинг. Имя синтаксического анализа для расширения с виртуальной точкой соединения обычно будет иметь вид:: {*GUID*}. Расширения этого типа обычно содержат виртуальные элементы. Однако некоторые расширения, например "Мои документы", фактически соответствуют папкам файловой системы, даже если они имеют виртуальные точки соединения. Если расширение представляет объекты файловой системы таким образом, можно задать значение Вантсфорпарсинг. Проводник Windows запросит имя для анализа корневой папки, вызвав метод [**ишеллфолдер:: жетдисплайнамеоф**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getdisplaynameof) объекта Folder с *уфлагс* , имеющим значение **шгдн \_ форпарсинг** , а *Пидл* задать один пустой указатель на список идентификаторов элементов (Пидл). Пустой ПИДЛ содержит только признак конца. Затем метод должен вернуть имя синтаксического анализа:: {*GUID*} корневой папки.
-   Хидефолдервербс. Команды, зарегистрированные в **\_ \_ корневой папке классов hKey** \\  , обычно связаны со всеми расширениями. Они отображаются в контекстном меню расширения и могут вызываться [**ShellExecute**](/windows/desktop/api/Shellapi/nf-shellapi-shellexecutea). Чтобы предотвратить связь этих команд с расширением, задайте значение Хидефолдервербс.
-   Хидеасделете. Если пользователь пытается удалить расширение, в проводнике вместо этого расширения будет скрыта.
-   Хидеасделетеперусер. Это значение имеет тот же результат, что и Хидеасделете, но для каждого пользователя. Расширение скрыто только для тех пользователей, которые пытались удалить его. Расширение видимо для всех остальных пользователей.
-   Куерифороверлай. Установите это значение, чтобы указать, что значок корневой папки может иметь наложение значка. Объект folder должен поддерживать интерфейс [**ишелликоноверлай**](/windows/win32/api/shlobj_core/nn-shlobj_core-ishelliconoverlay) . Прежде чем в проводнике Windows отобразится значок корневой папки, он запросит значок оверлея, вызвав один из двух методов **ишелликоноверлай** с параметром *пидлитем* , для которого задано пустое значение Пидл.

Остальные значения и подразделы применяются ко всем расширениям:

-   Чтобы указать отображаемое имя папки точек соединения расширения, задайте в качестве значения по умолчанию для подраздела CLSID расширения соответствующую строку.
-   Когда курсор наведен на папку, обычно отображается всплывающая подсказка, описывающая содержимое папки. Чтобы создать всплывающую подсказку для корневой папки расширения, создайте значение **реестра подсказки \_ SZ** для ключа CLSID расширения и задайте для него соответствующую строку.
-   Чтобы указать пользовательский значок для корневой папки расширения, создайте подраздел в подразделе CLSID расширения с именем **дефаултикон**. Присвойте параметру **дефаултикон** по умолчанию значение **reg \_ SZ** , содержащее имя файла, содержащего значок, за которым следует запятая, знак минус, а затем индекс значка в этом файле.
-   По умолчанию контекстное меню корневой папки расширения будет содержать элементы, определенные в **\_ \_ корневой \\ папке классов hKey**. Элементы « **Удалить**», « **Переименовать**» и « **Свойства** » добавляются, если установлены соответствующие \_ Флаги сфгао XXX. Можно добавить другие элементы в контекстное меню корневой папки или переопределить существующие элементы так же, как и для [типа файла](fa-file-types.md). Создайте подраздел **Shell** с ключом CLSID расширения и определите команды, как описано в разделе [расширение контекстных меню](context.md).
-   Если требуется более гибкий способ обработки контекстного меню корневой папки, можно реализовать [обработчик контекстного меню](context-menu-handlers.md). Чтобы зарегистрировать обработчик контекстного меню, создайте ключ **шеллекс** в ключе CLSID расширения. Зарегистрируйте CLSID обработчика так же, как для обычных [обработчиков расширения оболочки](handlers.md).
-   Чтобы добавить страницу к странице свойств свойств корневой папки, присвойте папке атрибут **сфгао \_ хаспропшит** и реализуйте [обработчик страницы свойств](propsheet-handlers.md). Чтобы зарегистрировать обработчик страницы свойств, создайте ключ **шеллекс** в ключе CLSID расширения. Зарегистрируйте CLSID обработчика так же, как для обычных [обработчиков расширения оболочки](handlers.md).
-   Чтобы указать атрибуты корневой папки, добавьте подраздел **ShellFolder** в подраздел CLSID расширения. Создайте значение атрибута и задайте для него соответствующее сочетание флагов [**сфгао \_ xxx**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getattributesof) .

В следующей таблице перечислены некоторые часто используемые атрибуты для корневых папок.



| Флаг                | Значение      | Описание                                                                                                                                                                                                                                                                                                       |
|---------------------|------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| \_Папка сфгао       | 0x20000000 | Корневая папка расширения содержит один или несколько элементов.                                                                                                                                                                                                                                                           |
| СФГАО \_ хассубфолдер | 0x80000000 | Корневая папка расширения содержит одну или несколько вложенных папок. Проводник Windows поместит знак «плюс» (+) рядом со значком папки.                                                                                                                                                                               |
| СФГАО \_ канделете    | 0x00000020 | Пользователь может удалить корневую папку расширения. Контекстное меню папки будет содержать элемент " **Удалить** ". Этот флаг должен быть установлен для точек соединения, размещенных в одной из [виртуальных папок](nse-junction.md).                                                                                 |
| СФГАО \_ канренаме    | 0x00000010 | Пользователь может переименовать корневую папку расширения. Контекстное меню папки будет содержать элемент **Rename** .                                                                                                                                                                                                   |
| СФГАО \_ хаспропшит | 0x00000040 | В корневой папке расширения есть страница **свойств.** Контекстное меню папки будет содержать элемент **Свойства** . Чтобы предоставить страницу свойств, необходимо реализовать [обработчик страницы свойств](propsheet-handlers.md). Зарегистрируйте обработчик в ключе CLSID расширения, как обсуждалось ранее. |



 

В следующем примере показана запись реестра CLSID для расширения с отображаемым именем Мекстенсион. Расширение имеет пользовательский значок, содержащийся в библиотеке DLL расширения с индексом 1. Заданы атрибуты **\_ Папка сфгао**, **сфгао \_ хассубфолдер** и **сфгао \_ канделете** .

```
HKEY_CLASSES_ROOT
   CLSID
      {Extension CLSID}
         (Default) = MyExtension
         InfoTip = Some appropriate text
      DefaultIcon
         (Default) = c:\MyDir\MyExtension.dll,-1
      InProcServer32
         (Default) = c:\MyDir\MyExtension.dll
         ThreadingModel = Apartment
      ShellFolder
         Attributes = 0xA00000020
```

## <a name="handling-pidls"></a>Обработка PIDL

Каждый элемент в пространстве имен Shell должен иметь уникальный ПИДЛ. Проводник Windows назначает ПИДЛ корневой папке и передает значение в расширение во время инициализации. После этого расширение отвечает за назначение правильно сконструированного ПИДЛ для каждого из объектов и предоставление этих PIDL в проводнике Windows по запросу. Если оболочка использует ПИДЛ для определения одного из объектов расширения, расширение должно иметь возможность интерпретировать ПИДЛ и определить конкретный объект. Расширение должно также назначать каждому объекту [**Отображаемое имя**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-setnameof) и *имя анализа* . Поскольку PIDL используются практически всеми интерфейсами папок, расширения обычно реализуют один *Пидл менеджер* для обработки всех этих задач.

Термин ПИДЛ является коротким для структуры [**итемидлист**](/windows/desktop/api/Shtypes/ns-shtypes-itemidlist) или указателя на такую структуру в зависимости от контекста. Как объявлено, структура **итемидлист** имеет один элемент — структуру [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) . Структура **итемидлист** объекта фактически является упакованным массивом из двух или более структур **шитемид** . Порядок этих структур определяет путь через пространство имен, точно так же, как c: \\ MyDirectory \\ MyFile определяет путь через файловую систему. Как правило, ПИДЛ объекта состоит из ряда структур **шитемид** , которые соответствуют папкам, определяющим путь к пространству имен, за которым следует структура **шитемид** объекта, за которым следует признак конца.

Признаком конца является структура [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) , в которой для элемента *CB* задано **значение NULL**. Признак конца необходим, поскольку количество структур **шитемид** в Пидл объекта зависит от расположения объекта в пространстве имен оболочки и начальной точки пути. Кроме того, размер различных структур **шитемид** может быть различным. Когда вы получаете ПИДЛ, нет простого способа определить его размер или даже общее число структур **шитемид** . Вместо этого необходимо «пройти» упакованный массив, структура по структуре, пока не дойдет до конца.

Чтобы создать ПИДЛ, приложение должно выполнить следующие действия:

1.  Создайте структуру [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) для каждого из своих объектов.
2.  Соберите соответствующие структуры [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) в Пидл.

### <a name="creating-an-shitemid-structure"></a>Создание структуры ШИТЕМИД

Структура [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) объекта однозначно определяет объект в его папке. Фактически, тип ПИДЛ, используемый многими методами [**ишеллфолдер**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) , состоит только из структуры **шитемид** объекта, за которой следует признак конца. Определение структуры **шитемид** :


```C++
typedef struct _SHITEMID { 
    USHORT cb; 
    BYTE   abID[1]; 
} SHITEMID, * LPSHITEMID;
```



Элемент *Абид* является идентификатором объекта. Так как длина *Абид* не определена и может варьироваться, для элемента *CB* задается размер структуры [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) в байтах.

Поскольку ни длина, ни содержимое *Абид* не стандартизированы, можно использовать любую схему, которой требуется назначить значения *Абид* для объектов. Единственное требование заключается в том, что у вас не может быть двух объектов в одной папке с одинаковыми значениями. Однако по соображениям производительности структура [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) должна быть выровняйтеся с помощью **параметра DWORD**. Иными словами, следует создать значения *Абид* таким образом, чтобы *CB* был целым числом, кратным 4.

Как правило, *Абид* указывает на структуру, определенную расширением. В дополнение к ИДЕНТИФИКАТОРу объекта Эта структура часто используется для хранения разнообразных связанных данных, например типа или атрибутов объекта. Затем объекты папки расширения могут быстро извлекать данные из ПИДЛ, а не запрашивать их.

> [!Note]  
> Одним из наиболее важных аспектов разработки структуры данных для ПИДЛ является обеспечение возможности сохранения и передачи структуры. В контексте PIDL смысл этих терминов:
>
> -   Восстанавливаемого. Система часто помещает PIDL в различные типы долгосрочного хранения, например файлы ярлыков. Затем он может восстановить эти PIDL из хранилища позже, возможно, после перезагрузки системы. ПИДЛ, который был восстановлен из хранилища, должен быть допустимым и осмысленным для вашего расширения. Это требование означает, например, что не следует использовать указатели или дескрипторы в структуре ПИДЛ. PIDL, содержащие данные такого типа, обычно не имеют смысла, когда система впоследствии восстанавливает их из хранилища.
> -   Переносимыми. ПИДЛ должен оставаться осмысленным при переносе с одного компьютера на другой. Например, ПИДЛ можно записать в файл ярлыка, скопировать на гибкий диск и перенести на другой компьютер. Это ПИДЛ должно быть осмысленным для вашего расширения, работающего на втором компьютере. Например, чтобы обеспечить возможность передачи PIDL, используйте явные символы ANSI или Unicode. Избегайте таких типов данных, как **TCHAR** или **LPTSTR**. Если вы используете эти типы данных, ПИДЛ, созданный на компьютере с версией Юникод расширения, не будет читаться с помощью ANSI-версии этого расширения, работающего на другом компьютере.

 

В следующем объявлении показан простой пример структуры данных.


```C++
typedef struct tagMYPIDLDATA {
  USHORT cb;
  DWORD dwType;
  WCHAR wszDisplayName[40];
} MYPIDLDATA, *LPMYPIDLDATA;
```



Для элемента **CB** задается размер структуры **мипидлдата** . Этот член делает **мипидлдата** допустимой структурой [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) в и самой. Остальные члены эквивалентны элементу **Абид** структуры **шитемид** и содержат закрытые данные. Элемент **двтипе** является определяемым расширением значением, указывающим тип объекта. В этом примере **двтипе** имеет значение **true** для папок и **false** в противном случае. Этот член позволяет, например, быстро определить, является ли объект папкой. Элемент **всздисплайнаме** содержит отображаемое имя объекта. Так как вы не назначите одно и то же отображаемое имя двум разным объектам в одной и той же папке, отображаемое имя также будет служить ИДЕНТИФИКАТОРом объекта. В этом примере для **всздисплайнаме** задано значение 40 символов, чтобы гарантировать, что структура **шитемид** будет выставляться по **двойному** алфавиту. Чтобы ограничить размер PIDL, вместо этого можно использовать массив символов переменной длины и соответствующим образом настроить значение CB. Выведите отображаемую строку с достаточным количеством \\ символов "0" для поддержки выравнивания **DWORD** структуры. Другие члены, которые могут быть полезны для размещения структуры, включают размер, атрибуты или имя синтаксического анализа объекта.

### <a name="constructing-a-pidl"></a>Создание ПИДЛ

После определения структур [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) для объектов их можно использовать для создания Пидл. PIDL может быть сконструирован для различных целей, но большинство задач используют один из двух типов ПИДЛ. Простейший одноуровневый ПИДЛ определяет объект относительно его родительской папки. Этот тип ПИДЛ используется многими методами [**ишеллфолдер**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) . Одноуровневая ПИДЛ содержит структуру **шитемид** объекта, за которой следует признак конца. Полный ПИДЛ определяет путь через иерархию пространства имен от рабочего стола к объекту. Этот тип ПИДЛ начинается на рабочем столе и содержит одну структуру **шитемид** для каждой папки в пути, за которой следует объект и признак конца. Полный ПИДЛ уникально идентифицирует объект во всем пространстве имен оболочки.

Самый простой способ создать ПИДЛ — работать непосредственно с самой структурой [**итемидлист**](/windows/desktop/api/Shtypes/ns-shtypes-itemidlist) . Создайте структуру **итемидлист** , но выделите достаточно памяти для хранения всех структур [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) . Адрес этой структуры будет указывать на начальную структуру **шитемид** . Определите значения для элементов этой начальной структуры, а затем добавьте столько дополнительных структур **шитемид** , сколько необходимо, в соответствующем порядке. В следующей процедуре показано, как создать одноуровневое ПИДЛ. Он содержит две структуры **шитемид** — структуру **мипидлдата** , за которой следует признак конца:

1.  Используйте функцию [**CoTaskMemAlloc**](/windows/win32/api/combaseapi/nf-combaseapi-cotaskmemalloc) , чтобы выделить память для Пидл. Выделите в качестве терминатора достаточно памяти для личных данных и **UShort** (2 байта). Приведите результат к ЛПМИПИДЛДАТА.
2.  Задайте для элемента CB первой структуры **мипидлдата** размер этой структуры. В этом примере для параметра **CB** задается значение sizeof (мипидлдата). Если вы хотите использовать структуру переменной длины, вам потребуется вычислить значение **CB**.
3.  Присвойте соответствующие значения закрытым элементам данных.
4.  Вычислите адрес следующей структуры [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) . Приведите адрес текущей структуры МИПИДЛДАТА к LPBYTE и добавьте это значение в значение **CB** , определенное на шаге 3.
5.  В этом случае следующая [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) структура — это признак конца. Присвойте элементу **CB** структуры значение 0.

Для более длительного PIDL выделите достаточно памяти и повторите шаги 3-5 для каждой дополнительной структуры [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) .

Следующий пример функции принимает тип и отображаемое имя объекта и возвращает одноуровневый ПИДЛ объекта. Функция предполагает, что отображаемое имя, включая завершающий **нуль** символ, не превышает число символов, объявленных для структуры **мипидлдата** . Если это допущено к ошибке, функция [**стрингкбкопив**](/windows/win32/api/strsafe/nf-strsafe-stringcbcopya) усекает отображаемое имя. Переменная **g \_ пмаллок** — [**это указатель,**](/windows/win32/api/objidlbase/nn-objidlbase-imalloc) созданный в других местах и хранящийся в глобальной переменной.


```C++
LPITEMIDLIST CreatePIDL(DWORD dwType, LPCWSTR pwszDisplayName)
{
    LPMYPIDLDATA   pidlOut;
    USHORT         uSize;

    pidlOut = NULL;

    //Calculate the size of the MYPIDLDATA structure.
    uSize = sizeof(MYPIDLDATA);

    // Allocate enough memory for the PIDL to hold a MYPIDLDATA structure 
    // plus the terminator
    pidlOut = (LPMYPIDLDATA)m_pMalloc->Alloc(uSize + sizeof(USHORT));

    if(pidlOut)
    {
       //Assign values to the members of the MYPIDLDATA structure
       //that is the PIDL's first SHITEMID structure
       pidlOut->cb = uSize;
       pidlOut->dwType = dwType;
       hr = StringCbCopyW(pidlOut->wszDisplayName, 
                          sizeof(pidlOut->wszDisplayName), pwszDisplayName);
       
       // TODO: Add error handling here to verify the HRESULT returned 
       // by StringCbCopyW.

       //Advance the pointer to the start of the next SHITEMID structure.
       pidlOut = (LPMYPIDLDATA)((LPBYTE)pidlOut + pidlOut->cb);

       //Create the terminating null character by setting cb to 0.
       pidlOut->cb = 0;
    }

    return pidlOut;
```



Полный ПИДЛ должен иметь структуры [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) для каждого объекта из рабочего стола в объект. Расширение получает полный ПИДЛ для корневой папки, когда оболочка вызывает [**иперсистфолдер:: Initialize**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipersistfolder-initialize). Чтобы создать полное ПИДЛ для объекта, возьмите ПИДЛ, что оболочка присвоена корневой папке, и добавьте структуры **шитемид** , необходимые для перезаписи из корневой папки в объект.

### <a name="interpreting-pidls"></a>Интерпретация PIDL

Когда оболочка или приложение вызывает один из интерфейсов расширения для запроса сведений об объекте, он обычно определяет объект с помощью ПИДЛ. Некоторые методы, такие как [**ишеллфолдер:: жетуиобжектоф**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getuiobjectof), используют PIDL, которые относятся к родительской папке и просты для интерпретации. Однако расширение, вероятно, также будет иметь полный PIDL. Затем Диспетчер ПИДЛ должен определить, на какой из объектов, на который ссылается ПИДЛ.

Что усложняет задачу связывания объекта с полным ПИДЛом, так как одна или несколько начальных структур [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) в Пидл могут принадлежать к объектам, находящимся за пределами расширения в пространстве имен Shell. У вас нет способа интерпретации значения элемента *Абид* этих структур. Для расширения необходимо «пройти» по списку структур **шитемид** , пока не будет достигнута структура, соответствующая корневой папке. После этого вы узнаете, как интерпретировать информацию в структурах **шитемид** .

Чтобы проанализировать ПИДЛ, возьмите первое значение *CB* и добавьте его в адрес Пидл, чтобы переместить указатель на начало следующей структуры [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) . Затем он будет указывать на элемент *CB* этой структуры, который можно использовать, чтобы переместить указатель на начало следующей структуры **шитемид** и т. д. Каждый раз при перемещении указателя Проверьте структуру **шитемид** , чтобы определить, достигнут ли корень пространства имен расширения.

## <a name="implementing-the-primary-interfaces"></a>Реализация основных интерфейсов

Как и для всех COM-объектов, реализация расширения в основном зависит от реализации коллекции интерфейсов. В этом разделе обсуждаются три основных интерфейса, которые должны быть реализованы всеми расширениями. Они используются для инициализации и предоставляют проводнику Windows Основные сведения о содержимом расширения. Эти интерфейсы и [представление папок](../lwef/nse-folderview.md)являются обязательными для функционального расширения. Однако, чтобы полностью использовать возможности проводника Windows, большинство расширений также реализуют один или несколько дополнительных интерфейсов.

### <a name="ipersistfolder-interface"></a>Интерфейс Иперсистфолдер

Интерфейс [**иперсистфолдер**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ipersistfolder) вызывается для инициализации нового объекта Folder. Метод [**иперсистфолдер:: Initialize**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipersistfolder-initialize) присваивает новому объекту полное имя Пидл. Сохраните этот ПИДЛ для последующего использования. Например, объект Folder должен использовать этот ПИДЛ для создания полного PIDL для дочерних объектов объекта. Создатель объекта Folder также может вызвать [**IPersist::**](/windows/win32/api/objidl/nf-objidl-ipersist-getclassid) GetObject, чтобы запросить CLSID объекта.

Как правило, объект Folder создается и инициализируется с помощью метода [**ишеллфолдер:: биндтубжект**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-bindtoobject) родительской папки. Однако при просмотре пользователем расширения проводник Windows создает и инициализирует объект корневой папки расширения. ПИДЛ, что объект корневой папки получает через [**иперсистфолдер:: Initialize**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipersistfolder-initialize) , содержит путь от рабочего стола к корневой папке, в которой потребуется создать полностью определенную PIDL для вашего расширения.

### <a name="ishellfolder-interface"></a>Интерфейс Ишеллфолдер

Оболочка обрабатывает расширение как иерархическую упорядоченную коллекцию объектов Folder. Интерфейс [**ишеллфолдер**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) является ядром любой реализации расширения. Он представляет объект Folder и предоставляет проводнику Windows большую часть сведений, необходимых для просмотра содержимого папки.

[**Ишеллфолдер**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) обычно является единственным интерфейсом папок, отличным от [**иперсистфолдер**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ipersistfolder) , который напрямую предоставляется объектом Folder. Хотя проводник Windows использует разнообразные обязательные и необязательные интерфейсы для получения сведений о содержимом папки, он получает указатели на эти интерфейсы через **ишеллфолдер**.

Проводник Windows получает идентификатор CLSID корневой папки расширения различными способами. Дополнительные сведения см. в разделе [Указание расположения расширения пространства имен](nse-junction.md) или [Отображение Self-Containedного представления расширения пространства имен](nse-view.md). Затем Проводник Windows использует этот идентификатор CLSID для создания и инициализации экземпляра корневой папки и запроса для интерфейса [**ишеллфолдер**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) . Расширение создает объект Folder для представления корневой папки и возвращает интерфейс **ишеллфолдер** объекта. Большая часть оставшейся части взаимодействия между расширением и проводником Windows выполняется через **ишеллфолдер**. Проводник Windows вызывает **ишеллфолдер** в:

-   Запросите объект, который может перечислить содержимое корневой папки.
-   Получение различных типов сведений о содержимом корневой папки.
-   Запросите объект, предоставляющий один из дополнительных интерфейсов. Затем эти интерфейсы могут быть запрошены для получения дополнительных сведений, таких как значки или контекстные меню.
-   Запросите объект папки, представляющий вложенную папку корневой папки.

Когда пользователь открывает вложенную папку корневой папки, проводник Windows вызывает [**ишеллфолдер:: биндтубжект**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-bindtoobject). Расширение создает и инициализирует новый объект Folder, который представляет вложенную папку, и возвращает интерфейс [**ишеллфолдер**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) . После этого проводник Windows вызывает этот интерфейс для различных типов информации и так далее, пока пользователь не решит выполнить переход в другое место в пространстве имен оболочки или закрыть Проводник Windows.

В оставшейся части этого раздела кратко рассматриваются наиболее важные методы [**ишеллфолдер**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) и способы их реализации.

### <a name="enumobjects"></a>енумобжектс

Перед отображением содержимого папки в представлении в виде дерева Обозреватель Windows должен сначала определить, что содержится в папке, вызвав метод [**ишеллфолдер:: енумобжектс**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-enumobjects) . Этот метод создает стандартный объект перечисления OLE, предоставляющий интерфейс [**иенумидлист**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ienumidlist) и возвращающий этот указатель интерфейса. Интерфейс **иенумидлист** позволяет проводнику Windows получить PIDL всех объектов, содержащихся в папке. Затем эти PIDL используются для получения сведений об объектах, содержащихся в папке. Дополнительные сведения см. в разделе [интерфейс иенумидлист](#ienumidlist-interface).

> [!Note]  
> Метод [**иенумидлист:: Next**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ienumidlist-next) должен возвращать только PIDL, относящиеся к родительской папке. ПИДЛ должен содержать только структуру [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) объекта, за которой следует признак конца.

 

### <a name="createviewobject"></a>креатевиевобжект

Перед отображением содержимого папки проводник Windows вызывает этот метод для запроса указателя на интерфейс [**ишеллвиев**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellview) . Этот интерфейс используется проводником Windows для управления представлением папки. Создайте объект представления папки и возвратите его интерфейс **ишеллвиев** .

Метод [**ишеллфолдер:: креатевиевобжект**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-createviewobject) также вызывается для запроса одного из дополнительных интерфейсов, например [**IContextMenu**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-icontextmenu), для самой папки. Реализация этого метода должна создать объект, который предоставляет запрашиваемый интерфейс и возвращает указатель интерфейса. Если проводнику Windows требуется необязательный интерфейс для одного из объектов, содержащихся в папке, он вызывает [**ишеллфолдер:: жетуиобжектоф**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getuiobjectof).

### <a name="getuiobjectof"></a>жетуиобжектоф

Хотя основные сведения о содержимом папки доступны через методы [**ишеллфолдер**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) , расширение может также предоставлять проводнику Windows различные виды дополнительных сведений. Например, можно указать значки для содержимого папки или контекстного меню объекта. Проводник Windows вызывает метод [**ишеллфолдер:: жетуиобжектоф**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getuiobjectof) , чтобы попытаться получить дополнительные сведения об объекте, который содержится в папке. Проводник Windows определяет, какой объект требуется для получения сведений, и идентификатор IID соответствующего интерфейса. Затем объект Folder создает объект, предоставляющий запрошенный интерфейс, и возвращает указатель на интерфейс.

Если расширение позволяет пользователям передавать объекты с помощью перетаскивания или буфера обмена, проводник Windows вызывает [**ишеллфолдер:: жетуиобжектоф**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getuiobjectof) для запроса интерфейса [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) или [**интерфейс IDropTarget**](/windows/win32/api/oleidl/nn-oleidl-idroptarget) . Дополнительные сведения см. [в разделе Передача объектов оболочки с помощью перетаскивания и буфера обмена](dragdrop.md).

Проводник Windows вызывает [**ишеллфолдер:: креатевиевобжект**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-createviewobject) , когда ему требуется та же информация о самой папке.

### <a name="bindtoobject"></a>биндтубжект

Проводник Windows вызывает метод [**ишеллфолдер:: биндтубжект**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-bindtoobject) , когда пользователь пытается открыть одну из вложенных папок расширения. Если для *riid* задано значение IID \_ ишеллфолдер, следует создать и инициализировать объект Folder, представляющий вложенную папку, и вернуть интерфейс [**ишеллфолдер**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) объекта.

> [!Note]  
> В настоящее время проводник Windows вызывает этот метод только для запроса интерфейса [**ишеллфолдер**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) . Однако не следует рассчитывать, что это всегда будет так. Перед продолжением всегда проверяйте значение *riid* .

 

### <a name="getdisplaynameof"></a>жетдисплайнамеоф

Проводник Windows вызывает метод [**ишеллфолдер:: жетдисплайнамеоф**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getdisplaynameof) для преобразования Пидл одного из объектов папки в имя. Этот ПИДЛ должен быть связан с родительской папкой объекта. Иными словами, он должен содержать одну структуру [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) , не **равную NULL** . Так как существует несколько возможных способов именования объектов, проводник Windows определяет тип имени, задав один или несколько флагов [**шгднф**](/windows/win32/api/shobjidl_core/ne-shobjidl_core-_shgdnf) в параметре *уфлагс* . Одно из двух значений, **шгдн \_ Обычная** или **шгдн \_**, будет задано, чтобы указать, должно ли имя относиться к папке или относительно рабочего стола. Одно из трех других значений, **шгдн \_ форедитинг**, **шгдн \_ фораддрессбар** или **шгдн \_ форпарсинг**, можно задать, чтобы указать, для чего будет использоваться имя.

Необходимо вернуть имя в виде структуры [**стррет**](/windows/desktop/api/Shtypes/ns-shtypes-strret) . Если **шгдн \_ форедитинг**, **шгдн \_ фораддрессбар** и **шгдн \_ форпарсинг** не заданы, возвращается отображаемое имя объекта. Если установлен флаг **шгдн \_ Форпарсинг** , проводник Windows запрашивает имя синтаксического анализа. Синтаксический анализ имен передается в [**ишеллфолдер::P арседисплайнаме**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-parsedisplayname) для получения Пидл объекта, хотя он может располагаться на одном или нескольких уровнях ниже текущей папки в иерархии пространства имен. Например, имя синтаксического анализа объекта файловой системы — это путь к нему. Полный путь к любому объекту в файловой системе можно передать в метод **ишеллфолдер::P арседисплайнаме** рабочего стола, и он вернет полное Пидл объекта.

При синтаксическом анализе имен используются текстовые строки, они не обязательно должны включать отображаемое имя. Имена разбора следует назначать в зависимости от того, что будет работать наиболее эффективно при вызове [**ишеллфолдер::P арседисплайнаме**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-parsedisplayname) . Например, многие из виртуальных папок оболочки не являются частью файловой системы и не имеют полного пути. Вместо этого каждой папке назначается идентификатор GUID, а имя синтаксического анализа принимает вид:: {GUID}. Независимо от используемой схемы, она должна иметь возможность надежного «кругового пути». Например, если вызывающий объект передает имя синтаксического анализа в **ишеллфолдер::P арседисплайнаме** для получения Пидл объекта, а затем передает этот Пидл в [**Ишеллфолдер:: жетдисплайнамеоф**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getdisplaynameof) с установленным флагом **шгдн \_ форпарсинг** , вызывающий объект должен восстановить исходное имя анализа.

### <a name="getattributesof"></a>жетаттрибутесоф

Проводник Windows вызывает метод [**ишеллфолдер:: жетаттрибутесоф**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getattributesof) для определения атрибутов одного или нескольких элементов, содержащихся в объекте Folder. Значение *Цидл* задает количество элементов в запросе, а *апидл* указывает на список их PIDL.

Поскольку тестирование некоторых атрибутов может занимать много времени, проводник Windows обычно определяет запрос до подмножества доступных флагов, устанавливая их значения в *рфгинаут*. Метод должен проверять только те атрибуты, флаги которых установлены в *рфгинаут*. Оставьте допустимыми установленные флаги и очистите остаток. Если в запрос включено более одного элемента, установите только те флаги, которые применяются ко всем элементам.

> [!Note]  
> Для правильного отображения элемента должны быть правильно заданы атрибуты. Например, если элемент является папкой, содержащей вложенные папки, необходимо установить флаг **сфгао \_ хассубфолдер** . В противном случае в проводнике Windows не будет отображаться значок + рядом с значком элемента в представлении в виде дерева.

 

### <a name="parsedisplayname"></a>парседисплайнаме

Метод [**ишеллфолдер::P арседисплайнаме**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-parsedisplayname) имеет более понятный зеркальный образ [**Ишеллфолдер:: жетдисплайнамеоф**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getdisplaynameof). Чаще всего этот метод используется для преобразования имени синтаксического анализа объекта в связанный ПИДЛ. Имя анализа может ссылаться на любой объект, который находится ниже папки в иерархии пространства имен. Возвращаемый ПИДЛ задается относительно объекта Folder, предоставляющего метод и обычно не является полным. Иными словами, несмотря на то, что ПИДЛ может содержать несколько структур [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) , первый из них будет либо в самом объекте, либо в первой вложенной папке пути из папки в объект. Вызывающему объекту необходимо добавить этот ПИДЛ к полному ПИДЛу папки, чтобы получить полное имя ПИДЛ для объекта.

[**Ишеллфолдер:**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-parsedisplayname) можно также вызвать метод:P арседисплайнаме, чтобы запросить атрибуты объекта. Поскольку определение всех применимых атрибутов может занимать много времени, вызывающая сторона задаст только те флаги [**сфгао \_ xxx**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getattributesof) , которые представляют сведения, которые интересует вызывающий объект. Необходимо определить, какие из этих атрибутов имеют значение true для объекта, и очистить оставшиеся флаги.

### <a name="ienumidlist-interface"></a>Интерфейс Иенумидлист

Если проводнику Windows требуется перечислить объекты, содержащиеся в папке, вызывается [**ишеллфолдер:: енумобжектс**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-enumobjects). Объект folder должен создать объект перечисления, который предоставляет интерфейс [**иенумидлист**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ienumidlist) и возвращать этот указатель интерфейса. Проводник Windows, как правило, будет использовать **иенумидлист** для перечисления PIDL всех объектов, содержащихся в папке.

[**Иенумидлист**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ienumidlist) является стандартным интерфейсом перечисления OLE и реализуется обычным способом. Однако помните, что возвращаемый PIDL должен быть связан с папкой и содержать только структуру [**шитемид**](/windows/desktop/api/Shtypes/ns-shtypes-shitemid) объекта и признак конца.

## <a name="implementing-the-optional-interfaces"></a>Реализация необязательных интерфейсов

Существует ряд необязательных интерфейсов оболочки, которые могут поддерживаться объектами папки расширения. Многие из них, такие как [**иекстрактикон**](/windows/win32/api/shlobj_core/nn-shlobj_core-iextracticona), позволяют настраивать различные аспекты того, как пользователь просматривает расширение. Другие, такие как [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject), позволяют вашему расширению поддерживать такие функции, как перетаскивание.

Ни один из дополнительных интерфейсов не предоставляется непосредственно объектом Folder. Вместо этого проводник Windows вызывает один из двух методов [**ишеллфолдер**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) для запроса интерфейса:

-   Проводник Windows вызывает [**ишеллфолдер:: жетуиобжектоф**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getuiobjectof) объекта Folder, чтобы запросить интерфейс для одного из объектов, содержащихся в папке.
-   Проводник Windows вызывает [**ишеллфолдер:: креатевиевобжект**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-createviewobject) объекта Folder для запроса интерфейса для самой папки.

Для предоставления сведений объект Folder создает объект, который предоставляет запрошенный интерфейс, и возвращает указатель интерфейса. Затем Проводник Windows вызывает этот интерфейс для получения необходимой информации. В этом разделе обсуждаются наиболее часто используемые необязательные интерфейсы.

### <a name="iextracticon"></a>иекстрактикон

Проводник Windows запрашивает интерфейс [**иекстрактикон**](/windows/win32/api/shlobj_core/nn-shlobj_core-iextracticona) перед отображением содержимого папки. Интерфейс позволяет вашему расширению указывать настраиваемые значки для объектов, содержащихся в папке. В противном случае будут использоваться стандартные значки файлов и папок. Чтобы предоставить пользовательский значок, создайте объект извлечения значков, который предоставляет **иекстрактикон** и возвращает указатель на этот интерфейс. Для дальнейшего обсуждения см. справочную документацию по **иекстрактикон** или [Создание обработчиков значков](./how-to-create-icon-handlers.md).

### <a name="icontextmenu"></a>IContextMenu

Когда пользователь щелкает правой кнопкой мыши объект, проводник Windows запрашивает интерфейс [**IContextMenu**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-icontextmenu) . Чтобы предоставить контекстные меню для объектов, создайте объект обработчика меню и возвратите его интерфейс **IContextMenu** .

Процедуры создания объекта обработчика меню очень похожи на те, которые используются для создания расширения оболочки обработчика меню. Дополнительные сведения см. в разделе [Создание обработчиков контекстного меню](context-menu-handlers.md) или ссылки [**IContextMenu**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-icontextmenu), [**IContextMenu2**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-icontextmenu2)или [**IContextMenu3**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-icontextmenu3) .

### <a name="iqueryinfo"></a>икуеринфо

Проводник Windows вызывает интерфейс [**икуеринфо**](/windows/win32/api/shlobj_core/nn-shlobj_core-iqueryinfo) для получения текстовой строки подсказки.

### <a name="idataobject-and-idroptarget"></a>IDataObject и интерфейс IDropTarget

Когда объекты отображаются проводником Windows, объект Folder не имеет непосредственного способа выяснить, когда пользователь пытается вырезать, скопировать или перетащить объект. Вместо этого проводник Windows запрашивает интерфейс [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) . Чтобы разрешить передачу объекта, создайте объект данных и верните указатель на его интерфейс **IDataObject** .

Аналогичным образом пользователь может попытаться удалить объект данных в представлении проводника Windows одного из объектов, таких как значок или путь к адресной строке. Затем Проводник Windows запрашивает интерфейс [**интерфейс IDropTarget**](/windows/win32/api/oleidl/nn-oleidl-idroptarget) . Чтобы разрешить удаление объекта данных, создайте объект, предоставляющий интерфейс **интерфейс IDropTarget** , и возвратите указатель интерфейса.

Обработка передаваемых данных является одним из более замысловатых аспектов написания расширений пространства имен. Подробное обсуждение см. в разделе [Передача объектов оболочки с помощью перетаскивания и буфера обмена](dragdrop.md).

## <a name="working-with-the-default-shell-folder-view-implementation"></a>Работа с реализацией представления папки оболочки по умолчанию

Источники данных, использующие объект представления папок оболочки по умолчанию (Дефвиев), должны реализовывать следующие интерфейсы:

-   [**ишеллфолдер**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder)
-   [**IShellFolder2**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellfolder2)
-   [**иперсистфолдер**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ipersistfolder)
-   [**IPersistFolder2**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ipersistfolder2)

При необходимости они также могут реализовывать [**IPersistFolder3**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ipersistfolder3).

 

 
