---
description: В этом разделе описываются некоторые моменты, которые следует учитывать при использовании библиотек в программе.
ms.assetid: 40ACC8F6-1416-4390-A8D7-8F924DC2C2FE
title: Использование библиотек в программе
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 2812a66b148d9bd16fc3951efab64a4d37afaaff
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104350355"
---
# <a name="using-libraries-in-your-program"></a>Использование библиотек в программе

В этом разделе описываются некоторые моменты, которые следует учитывать при использовании библиотек в программе.

В этом разделе:

-   [Общие сведения о программировании библиотеки](#library-programming-overview)
-   [Программирование с использованием библиотек](#programming-with-libraries)
    -   [Переход от известных папок к библиотекам](#moving-from-known-folders-to-libraries)
    -   [Домашняя группа и общие библиотеки](#homegroup-and-shared-libraries)
-   [Использование общего диалогового окна "файлы" с библиотеками](#using-a-common-file-dialog-box-with-libraries)
-   [Включение выбора библиотек из пользовательского интерфейса](#enabling-library-selection-from-the-user-interface)
-   [Доступ к содержимому библиотеки в программе](#accessing-library-content-in-a-program)
    -   [Доступ к содержимому библиотеки с помощью интерфейса Ишелллибрари](#accessing-library-content-with-the-ishelllibrary-interface)
    -   [Доступ к содержимому библиотеки с помощью интерфейсов API оболочки](#accessing-library-content-with-the-shell-apis)
-   [Сохранение содержимого пользователя в библиотеке](#saving-user-content-in-a-library)
-   [Поддержка операций перетаскивания в библиотеке](#supporting-drag-and-drop-operations-in-a-library)
-   [Синхронизация с библиотекой](#keeping-in-sync-with-a-library)
    -   [Массовое обновление](#bulk-update)
    -   [Уведомление API оболочки](#shell-api-notification)
    -   [Уведомление API файловой системы](#file-system-api-notification)
-   [См. также](#related-topics)

## <a name="library-programming-overview"></a>Общие сведения о программировании библиотеки

Библиотеки позволяют пользователям упорядочивать содержимое на основе файлов в удобном для них виде, не ограничиваясь организацией файловой системы. Когда программа поддерживает библиотеки, она позволяет пользователю найти свое содержимое в удобном для них виде, одновременно предоставляя пользовательский интерфейс, совместимый с пользователем Windows 7. Библиотеки также упрощают программу для размещения файлового содержимого, хранящегося в разных папках или на разных компьютерах.

В подразделах этого раздела описывается, как можно добавить в программу поддержку библиотек и воспользоваться новыми возможностями, предлагаемыми библиотеками. По умолчанию Windows 7 предоставляет некоторую эту поддержку. Если программа не изменяет общие диалоговые окна файлов, которые в настоящее время используются, для поддержки библиотек может потребоваться очень немного дополнительного программирования.

В этом разделе описываются некоторые основные функции, предоставляемые библиотеками, и способы их поддержки в программе. С помощью этой информации вы можете выбрать, какие функции будут обеспечивать оптимальное взаимодействие с пользователем в вашей программе. Если программа настраивает общие диалоговые окна файла, сведения в этом разделе помогут определить, как использовать новые общие диалоговые окна файла для использования библиотек и обеспечения эквивалентной функциональности в Windows 7.

## <a name="programming-with-libraries"></a>Программирование с использованием библиотек

Модель программирования оболочки Windows описывает, как программа взаимодействует с объектами программирования оболочки Windows. Хотя объекты файловой системы, такие как файлы и каталоги, представлены объектами оболочки Windows, не все объекты оболочки Windows представлены файловой системой. Библиотеки, например, являются объектами оболочки Windows, которые не имеют эквивалента файловой системы. Использование объектов оболочки Windows в программе позволяет программе обращаться ко всем объектам оболочки, а не только к объектам файловой системы.

Для получения наилучших результатов ваша программа будет использовать [**API библиотеки оболочки**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishelllibrary) для взаимодействия с библиотеками и доступа к их содержимому. Хотя библиотеки содержат элементы файловой системы, такие как папки и файлы, библиотеки не являются элементами файловой системы. Таким образом, интерфейсы API файловой системы не могут использоваться для доступа к возможностям библиотеки или содержимому библиотеки.

Если у вас уже есть программа, использующая множество API-интерфейсов файловой системы, ваша программа по-прежнему может воспользоваться возможностями библиотеки. [**API библиотеки оболочки**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishelllibrary) может предоставлять ссылки файловой системы на элементы, находящиеся в библиотеке, и эти ссылки на системные файлы, такие как имя файла и путь, могут передаваться в существующие API-компоненты файловой системы, находящиеся в существующей программе.

### <a name="moving-from-known-folders-to-libraries"></a>Переход от известных папок к библиотекам

До Windows 7 было распространено использование известной папки, например папки Мои документы, в качестве папки по умолчанию в операциях сохранения или открытия файлов. В Windows 7 должна использоваться соответствующая библиотека, чтобы пользователь мог работать в программе так же, как и с другими программами Windows 7, например с проводником Windows.

Если в вашей программе используется API оболочки Windows, Добавление поддержки библиотеки не вызывает затруднений. Например, если в данный момент вызывается функция [**шжеткновнфолдеритем**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shgetknownfolderitem) для получения расположения папки «Мои документы», можно заменить значение [**кновнфолдерид**](knownfolderid.md) в известной папке «Мои документы» значением **кновнфолдерид** соответствующей библиотеки.

В следующей таблице показана связь между значениями [**кновнфолдерид**](knownfolderid.md) известных папок и значением **кновнфолдерид** соответствующей библиотеки в Windows 7. 

| Значения КНОВНФОЛДЕРИД известных папок | Значения КНОВНФОЛДЕРИД библиотеки |
|-----------------------------------|------------------------------|
| \_Документы FOLDERID               | FOLDERID \_ документслибрари   |
| FOLDERID \_ изображения                | FOLDERID \_ пиктуреслибрари    |
| FOLDERID \_ музыка                   | FOLDERID \_ мусиклибрари       |
| FOLDERID \_ рекордедтв              | FOLDERID \_ рекордедтвлибрари  |



 

### <a name="homegroup-and-shared-libraries"></a>Домашняя группа и общие библиотеки

Добавление поддержки библиотек в вашу программу включит поддержку общих библиотек в домашней группе. Домашняя группа идентифицируется по [](knownfolderid.md) значению кновнфолдерид [**в \_ домашней группе FOLDERID**](knownfolderid.md). Программа может найти закрытое или общее расположение сохранения по умолчанию пользователя, задав значение [**дефаултсавефолдертипе**](/windows/desktop/api/shobjidl_core/ne-shobjidl_core-defaultsavefoldertype) в вызове метода [**Ишелллибрари:: жетдефаултсавефолдер**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishelllibrary-getdefaultsavefolder) .

## <a name="using-a-common-file-dialog-box-with-libraries"></a>Использование общего диалогового окна "файлы" с библиотеками

Использование общего файлового диалогового окна с библиотеками. диалоговое окно «Common File» было обновлено для поддержки библиотек в Windows 7. На следующем рисунке показано, как открывается диалоговое окно Common File для пользователя в Windows 7.

![снимок экрана с диалоговым окном "общие файлы", в котором отображаются библиотеки](images/libraries-commonfiledialog.png)

В Windows 7, если в настоящий момент программа отображает общий файловый диалог и не изменяет шаблон диалогового окна или не привязывает какие-либо события, она автоматически отображает новую версию диалогового окна Windows 7. В частности, в вызове функции диалогового окна common File элементы **лпфнхук**, **HINSTANCE**, **Лптемплатенаме** структуры [**OpenFileName**](/windows/win32/api/commdlg/ns-commdlg-openfilenamea) должны иметь **значение NULL** , а флаги **ОФН \_ енаблехук** и **ОФН \_ енаблетемплате** должны быть четкими.

В Windows 7 интерфейсы, связанные с [**ифиледиалог**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ifiledialog), заменяют общие функции диалогового окна файла, которые использовались в более ранних версиях Windows. Более ранние распространенные функции диалогового окна файла по-прежнему поддерживаются в Windows 7, но они не обеспечивают полноценного взаимодействия с пользователем Windows 7 и не поддерживают библиотеки. Ниже перечислены некоторые новые возможности, поддерживаемые интерфейсами, связанными с **ифиледиалог**.

-   Пользователь может получить доступ к свойствам файла, поддерживаемым проводником Windows 7, для поиска и выбора файлов.
-   Программа может использовать интерфейсы и методы из API пространства имен оболочки для работы с элементами.
-   Программа может использовать модель настройки на основе данных вместо модели настройки на основе файлов ресурсов для добавления новых элементов управления в общие диалоговые окна файла.

Интерфейсы, связанные с [**ифиледиалог**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ifiledialog), следует использовать в следующих случаях:

-   необходимо настроить диалоговое окно Common File для программы в Windows 7. Это позволит программе работать с библиотеками и поддерживать настройку диалогового окна.
-   Вы хотите, чтобы пользователь мог выбрать несколько файлов в диалоговом окне общего файла. Это обеспечит получение правильных путей к выбранному объекту, так как библиотека может содержать содержимое, которое хранится в разных папках.

Дополнительные сведения о интерфейсах, связанных с [**ифиледиалог**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ifiledialog), см. в следующих статьях:

-   [**ифиледиалог**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ifiledialog)
-   [**ифилеопендиалог**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ifileopendialog)
-   [**ифилесаведиалог**](/windows/desktop/api/Shobjidl_core/nn-shobjidl_core-ifilesavedialog)
-   [**ифиледиалогкустомизе**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ifiledialogcustomize)
-   [**ифиледиаложевентс**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ifiledialogevents)
-   [**ифиледиалогконтролевентс**](/windows/desktop/api/Shobjidl/nn-shobjidl-ifiledialogcontrolevents)

## <a name="enabling-library-selection-from-the-user-interface"></a>Включение выбора библиотек из пользовательского интерфейса

Если программа позволяет пользователю выбрать папку (например, функции импорта или экспорта) в Windows 7, она также должна позволять пользователю выбрать библиотеку. Интерфейс [**ифилеопендиалог**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ifileopendialog) и функция [**шбровсефорфолдер**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shbrowseforfoldera) позволяют пользователю выбрать библиотеку, когда будет предложено выбрать папку. Интерфейс **ифилеопендиалог** является предпочтительным по сравнению с функцией **шбровсефорфолдер** , так как **ифилеопендиалог** поддерживает пользовательский интерфейс Windows 7.

Чтобы разрешить пользователям выбирать папки при использовании интерфейса [**ифилеопендиалог**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ifileopendialog) , вызовите сетоптионс с \_ установленным флагом Фос пиккфолдерс и убедитесь, что \_ флаг Фос форцефилесистем снят.


```C++
FILEOPENDIALOGOPTIONS fileOptions;

hr = fileOpenDialogBox->GetOptions(&fileOptions);
fileOptions = fileOptions | FOS_PICKFOLDERS | ~FOS_FORCEFILESYSTEM;
hr = fileOpenDialogBox->SetOptions(fileOptions);
```



Чтобы разрешить пользователям выбирать папки при вызове функции Шбровсефорфолдер, в элементе Улфлагс структуры [**бровсеинфо**](/windows/desktop/api/shlobj_core/ns-shlobj_core-browseinfoa) установите \_ флаг bЕсли усеневуи и снимите \_ флаг bЕсли ретурнонлифсдирс.


```C++
BROWSEINFO    browseInfo;
browseInfo.ulFlags = BIF_USENEWUI | ~BIF_RETURNONLYFSDIRS;
// Set other member values
pidl = SHBrowseForFolder(&browseInfo);
```



## <a name="accessing-library-content-in-a-program"></a>Доступ к содержимому библиотеки в программе

Для доступа к содержимому библиотеки необходимо использовать API оболочки Windows. Функции API файловой системы не могут использоваться для доступа к содержимому библиотеки, поскольку библиотеки не являются объектами файловой системы. Если программа использует пользовательский обозреватель файлов, основанный на API файловой системы, он не сможет просматривать библиотеки или доступ к содержимому библиотеки.

В этом разделе описывается, как можно получить доступ к содержимому библиотеки, чтобы можно было выбрать лучший способ обновления программы для работы с библиотеками.

### <a name="accessing-library-content-with-the-ishelllibrary-interface"></a>Доступ к содержимому библиотеки с помощью интерфейса Ишелллибрари

Самым простым способом доступа программы к содержимому библиотеки является использование [**API библиотеки оболочки**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishelllibrary). При работе с программой, использующей API файловой системы, **API библиотеки оболочки** может возвращать папки файловой системы библиотеки, что позволяет избежать изменения существующего программного кода.


```C++
IShellLibrary *picturesLibrary;

hr = SHLoadLibraryFromKnownFolder(FOLDERID_PicturesLibrary, 
                                  STGM_READ, 
                                  IID_PPV_ARGS(&picturesLibrary));

// picturesLibrary now points to the user's picture library
    
IShellItemArray *pictureFolders; 

hr = pslLibrary->GetFolders(LFF_FORCEFILESYSTEM, IID_PPV_ARGS(&pictureFolders));

// pictureFolders now contains an array of Shell items that
// represent the folders found in the user's pictures library
```



### <a name="accessing-library-content-with-the-shell-apis"></a>Доступ к содержимому библиотеки с помощью интерфейсов API оболочки

Поскольку объекты библиотеки являются частью модели программирования оболочки, их можно использовать с другими API-интерфейсами оболочки Windows. Например, вы можете использовать в программе интерфейсы [**интерфейса IShellItem**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellitem) и [**ишеллфолдер**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) , а также связанные вспомогательные функции для доступа к содержимому библиотеки таким же образом, как при перечислении папок и содержимого папок для доступа к содержимому с помощью API файловой системы.

Интерфейсы API оболочки Windows поддерживают два режима перечисления для доступа к содержимому библиотеки:

-   **Обзор перечисления**

    Обзор перечисления является режимом перечисления по умолчанию и перечисляет содержимое папки библиотеки. Снимите \_ \_ флаг ПЕРЕЧИСЛЕНИЯ навигации шконтф, чтобы использовать этот режим.

-   **Перечисление навигации**

    Перечисление навигации перечисляет папки библиотеки. Установите \_ \_ флаг ПЕРЕЧИСЛЕНИЯ навигации шконтф, чтобы использовать этот режим.

Если программа использует настраиваемый элемент управления "дерево" для навигации по папкам пользователя, то перечисление папок в режиме перечисления навигации предоставит список папок библиотеки, которые соответствуют способу перечисления папок в Windows 7 в проводнике.

Примеры использования этих функций в программе см. в примере Шеллстораже на Windows SDK.

## <a name="saving-user-content-in-a-library"></a>Сохранение содержимого пользователя в библиотеке

Программа может сохранять содержимое пользователя в библиотеке, а также в папке в библиотеке. Аналогичным образом пользователь может сохранять данные в определенной папке библиотеки или просто сохранять их в библиотеке.

Каждая библиотека содержит папку, которая назначается в качестве расположения для сохранения по умолчанию. Место сохранения по умолчанию определяется при создании библиотеки. Однако пользователь может переназначить расположение сохранения по умолчанию в любую папку в библиотеке. Хотя пользователю не нужно настраивать место сохранения по умолчанию, у него есть возможность изменить его. Если пользователь удаляет папку, которая в данный момент задана в качестве расположения для сохранения по умолчанию, библиотека автоматически настроит следующую папку в библиотеке в качестве расположения для сохранения по умолчанию.

Существует несколько способов сохранения пользовательского содержимого в библиотеке.

-   **API оболочки**

    Если вы используете модель программирования оболочки и сохраняете элемент оболочки, представленный [**интерфейса IShellItem**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellitem), IStorage или IStream, объекту библиотеки, элемент оболочки будет автоматически сохранен в месте сохранения библиотеки по умолчанию.

-   **API файловой системы**

    Если у вас есть программа, использующая много вызовов API файловой системы, можно получить путь к папке, которая определена как расположение для сохранения по умолчанию для библиотеки. Затем путь к папке можно передать в API файловой системы.

Примеры использования этих функций в программе см. в примере Шеллстораже на Windows SDK.

## <a name="supporting-drag-and-drop-operations-in-a-library"></a>Поддержка операций перетаскивания в библиотеке

Если программа поддерживает действия по перетаскиванию, они должны быть обновлены для поддержки правильного взаимодействия с библиотекой. Если файл перемещается в библиотеку, то удаленный файл должен быть сохранен в месте сохранения по умолчанию. При удалении папки в библиотеку удаленная папка должна быть добавлена в библиотеку в качестве новой папки. Если файл перемещается в существующую папку, которая не является местом сохранения по умолчанию, файл необходимо добавить в выбранную папку.

Примеры добавления поддержки библиотек для программ перетаскивания см. в примере Шелллибрарикоммандлине на Windows SDK.

## <a name="keeping-in-sync-with-a-library"></a>Синхронизация с библиотекой

В этом разделе описывается, как программа может регулярно просматривать содержимое библиотеки.

### <a name="bulk-update"></a>Массовое обновление

Так как пользователь может изменять папки библиотеки интерактивно, когда программа не запущена, программа должна вызвать [**шресолвелибрари**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-shresolvelibrary) , когда начнется обнаружение и сохранение изменений в библиотеке. Интерфейс API оболочки предоставляет функцию **шресолвелибрари** , которая позволяет программе получать текущее содержимое библиотеки и текущие расположения любых папок, которые могут содержаться в библиотеке.

Обратите внимание, что [**шресолвелибрари**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-shresolvelibrary) является блокирующей функцией, которая может занять много времени в зависимости от того, что изменилось в библиотеке. Таким образом, его не следует вызывать из потока пользовательского интерфейса.

После того как программа будет обновлена, она может зарегистрироваться для получения уведомлений об изменениях, чтобы поддерживать текущее представление.

### <a name="shell-api-notification"></a>Уведомление API оболочки

Интерфейс API оболочки Windows предоставляет функцию [**шчанженотифирегистер**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shchangenotifyregister) , которая является предпочтительным способом получения уведомления об изменениях в библиотеке для процессов, не относящихся к службе.

Чтобы обнаружить изменения в элементах библиотеки с помощью API оболочки Windows, вызовите [**шчанженотифирегистер**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shchangenotifyregister) , чтобы зарегистрировать программу для уведомления об изменениях элементов в папке библиотеки. Эта функция может уведомлять программу при наличии изменений в какой-либо библиотеке или только в определенной библиотеке. Уведомления отправляются сразу после изменения библиотеки.

### <a name="file-system-api-notification"></a>Уведомление API файловой системы

Уведомления файловой системы должны использоваться в процессах службы.

Чтобы обнаружить изменения в элементах библиотеки с помощью API файловой системы, перечислите папки в библиотеке и вызовите [**финдфирстчанженотификатион**](/windows/win32/api/fileapi/nf-fileapi-findfirstchangenotificationa) для каждой отслеживаемой папки. Программа будет принимать уведомления при изменении наблюдаемой папки. Чтобы найти конкретный файл файлов, измененных в папке, вызовите [**реаддиректоричанжесв**](/windows/win32/api/winbase/nf-winbase-readdirectorychangesw). Чтобы обнаружить изменения в файле описания библиотеки, отслеживайте папку, в которой он находится. Файл описания библиотеки можно найти в папке [**FOLDERID \_**](knownfolderid.md) librarys. Однако файл описания библиотеки не должен быть открыт или изменен.

## <a name="related-topics"></a>См. также

<dl> <dt>

[О библиотеках](library-leverage-to-manage-folders.md)
</dt> <dt>

[**ишелллибрари**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishelllibrary)
</dt> <dt>

[Ссылки оболочки](./links.md)
</dt> <dt>

[Известные папки](known-folders.md)
</dt> <dt>

[Схема описания библиотеки](library-schema-entry.md)
</dt> <dt>

[**IID \_ ППВ \_ args**](/windows/win32/api/combaseapi/nf-combaseapi-iid_ppv_args)
</dt> </dl>

 

 
