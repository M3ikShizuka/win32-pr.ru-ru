---
description: Оболочка предоставляет несколько способов управления файловыми системами.
ms.assetid: d9ffda6f-adc0-44a3-b410-e23bf5f4f165
title: Управление файловой системой
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ee0f3b47e17e691c540a9775f3b8588b311b9878
ms.sourcegitcommit: 822413efb4a70dd464e5db4d9e8693ef74f8132f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2021
ms.locfileid: "113581622"
---
# <a name="managing-the-file-system"></a>Управление файловой системой

Оболочка предоставляет несколько способов управления файловыми системами. Оболочка предоставляет функцию [**шфилеоператион**](/windows/desktop/api/Shellapi/nf-shellapi-shfileoperationa), которая позволяет приложению программно перемещать, копировать, переименовывать и удалять файлы. Оболочка также поддерживает некоторые дополнительные возможности управления файлами.

-   Документы HTML могут быть *подключены* к связанным файлам, таким как графические файлы или таблицы стилей. При перемещении или копировании документа подключенные файлы также автоматически перемещаются или копируются.
-   Для систем, доступных нескольким пользователям, Управление файлами может осуществляться отдельно для каждого пользователя. Пользователи имеют простой доступ к файлам данных, но не к файлам, принадлежащим другим пользователям.
-   Если файлы документа добавляются или изменяются, их можно добавить в список последних документов оболочки. когда пользователь щелкает команду " **документы** " на меню, отображается список ссылок на документы.

В этом документе описывается, как работают эти технологии управления файлами. Затем в нем описано, как использовать оболочку для перемещения, копирования, переименования и удаления файлов и управления объектами в корзине.

-   [Управление файлами на уровне пользователя](#per-user-file-management)
-   [Папки "Мои документы" и "Мои рисунки"](#my-documents-and-my-pictures-folders)
-   [Подключенные файлы](#connected-files)
-   [Перемещение, копирование, переименование и удаление файлов](#moving-copying-renaming-and-deleting-files)
    -   [Уведомление оболочки](#notifying-the-shell)
-   [Простой пример управления файлами с помощью Шфилеоператион](#simple-example-of-managing-files-with-shfileoperation)
-   [Добавление файлов в список последних документов оболочки](#adding-files-to-the-shells-list-of-recent-documents)

## <a name="per-user-file-management"></a>Per-User Управление файлами

оболочка Windows 2000 позволяет связать файлы с определенным пользователем, чтобы они оставались скрытыми для других пользователей. с точки зрения файловой системы файлы хранятся в папке профиля пользователя, обычно C: \\ documents и Параметры \\ *Username* \\ в системах Windows 2000. Эта функция позволяет многим пользователям использовать один и тот же компьютер, сохраняя конфиденциальность своих файлов от других пользователей. Разные пользователи могут иметь разные доступные программы. Он также предоставляет администраторам и приложениям простой способ хранения таких объектов, как инициализация (.ini) или компоновка (lnk) файлов. Таким способом приложения могут сохранять разные состояния для каждого пользователя и легко восстанавливать это состояние при необходимости. Кроме того, существует папка профиля для хранения сведений, общих для всех пользователей.

Так как неудобно определить, какой пользователь вошел в систему и где находятся файлы, стандартные папки для каждого пользователя являются специальными папками и идентифицируются с помощью [**CSid**](csidl.md). Например, CSID для папки "Program Files" (файлы программы для пользователя) — это \_ программы CSid. Если приложение вызывает [**шжетфолдерлокатион**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shgetfolderlocation) или [**шжетфолдерпас**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shgetfolderpatha) с одним из ксидлс для каждого пользователя, функция возвращает указатель на список идентификаторов элементов (Пидл) или путь, соответствующий текущему пользователю, вошедшему в систему. Если приложению необходимо получить путь или ПИДЛ папки Profile, то его CSID имеет **\_ профиль CSid**.

## <a name="my-documents-and-my-pictures-folders"></a>Папки "Мои документы" и "Мои рисунки"

Один из стандартных значков, находящихся на рабочем столе, — **Мои документы**. При открытии этой папки в ней содержатся файлы документов текущего пользователя. Экземпляр рабочего стола "Мои документы" — это виртуальная папка — псевдоним для расположения файловой системы, используемый для физического хранения документов пользователя, расположенных непосредственно под настольным компьютером в иерархии пространства имен.

Папки «Мои документы» и «мои рисунки» — обеспечивают простой и безопасный способ доступа пользователей к документам и файлам изображений в системе, в которой может быть несколько пользователей. Каждому пользователю назначаются отдельные папки файловой системы для своих файлов. например, расположением папки "документы пользователя" в файловой системе обычно является нечто вроде C: \\ documents и Параметры \\ *username* \\ мои документы. Пользователям не нужно ничего знать о физическом расположении их папок файловой системы. Они просто обращаются к своим файлам через значок «Мои документы».

> [!Note]  
> Мои документы позволяют пользователю получить доступ к своим собственным файлам, но не к другим пользователям. Если несколько пользователей используют один и тот же компьютер, администратор может блокировать пользователей из части файловой системы, в которой хранятся фактические файлы. Таким же пользователям будет доступна возможность работать с собственными документами в папке «Мои документы», но не с документами, принадлежащими другим пользователям.

 

Как правило, приложению не нужно знать, какой пользователь вошел в систему или в файловой системе, где находится папка "Мои документы" пользователя. Вместо этого приложение может извлечь ПИДЛ значка рабочего стола "Мои документы", вызвав метод [**ишеллфолдер::P арседисплайнаме**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-parsedisplayname) рабочего стола. Имя синтаксического анализа, используемое для обнаружения папки "Мои документы", не является путем к файлу, а:: {450d8fba-ad25-11D0-98a8-0800361b1103}. Выражение в квадратных скобках является текстовой формой GUID "Мои документы". Например, чтобы получить ПИДЛ из документов, приложение должно использовать этот вызов в **ишеллфолдер::P арседисплайнаме**.


```C++
hr = psfDeskTop->ParseDisplayName(NULL, 
                                  NULL, 
                                  L"::{450d8fba-ad25-11d0-98a8-0800361b1103}", 
                                  &chEaten, 
                                  &pidlDocFiles, 
                                  NULL);
```



После того, как приложение ПИДЛ мои документы, оно может обработать папку так же, как обычная папка файловой системы — перечисление элементов, синтаксический анализ, привязка и выполнение любых других допустимых операций с папкой. Оболочка автоматически сопоставляет изменения в папке «Мои документы» или ее вложенных папках с соответствующими папками файловой системы.

Если приложению требуется доступ к реальной папке файловой системы, содержащей документы текущего пользователя, передавайте параметру CSID \_ Personal значение [**шжетфолдерлокатион**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shgetfolderlocation). Функция возвращает ПИДЛ папки файловой системы, которая отображается в папке "Мои документы" текущего пользователя.

## <a name="connected-files"></a>Подключенные файлы

HTML-документы часто имеют ряд связанных графических файлов, файл таблицы стилей, несколько JScript Microsoft (совместимых с ECMA 262 языка) и т. д. При перемещении или копировании первичного HTML-документа обычно требуется переместить или скопировать связанные файлы, чтобы избежать разрыва связей. К сожалению, не существовало простого способа определить, какие файлы связаны с любым документом HTML, а не путем анализа их содержимого. чтобы решить эту проблему, Windows 2000 предоставляет простой способ *подключения* основного документа HTML к группе связанных файлов. Если подключение к файлу включено, то при перемещении или копировании документа все связанные с ним файлы помещаются вместе с ним.

Чтобы создать группу подключенных файлов, первичный документ должен иметь .htm или .html расширение имени файла. Создайте вложенную папку родительской папки основного документа. Имя вложенной папки должно быть именем основного документа, за вычетом .htm или .html расширения, за которым следует одно из перечисленных ниже расширений. Чаще всего используются расширения ". Files" или " \_ Files". Например, если первичный документ называется MyDoc.htm, то имя вложенной папки «Мидок \_ Files» определяет вложенную папку как контейнер для подключенных файлов документа. Если первичный документ перемещен или скопирован, то вложенная папка и ее файлы также будут перемещены или скопированы.

Для некоторых языков можно использовать локализованный эквивалент " \_ Files", чтобы создать вложенную папку для подключенных файлов. В следующей таблице перечислены допустимые строки, которые можно добавить к имени документа для создания вложенной папки с подключенными файлами. Обратите внимание, что некоторые из этих строк содержат символ "-" в качестве первого символа, а не " \_ " или ".".



:::row:::
   :::column span="":::
      " \_ арчивос"
   :::column-end:::
   :::column span="":::
      " \_ аркуивос"
   :::column-end:::
   :::column span="":::
      " \_ бестанден"
   :::column-end:::
   :::column span="":::
      " \_ билос"
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="":::
      "-Датеиен"
   :::column-end:::
   :::column span="":::
      " \_ датотеке"
   :::column-end:::
   :::column span="":::
      " \_ досялар"
   :::column-end:::
   :::column span="":::
      " \_ елемеи"
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="":::
      " \_ фаилид"
   :::column-end:::
   :::column span="":::
      " \_ сбой"
   :::column-end:::
   :::column span="":::
      " \_ фажлови"
   :::column-end:::
   :::column span="":::
      " \_ фичеирос"
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="":::
      " \_ фичиерс"
   :::column-end:::
   :::column span="":::
      "-фильтр"
   :::column-end:::
   :::column span="":::
      ". Files"
   :::column-end:::
   :::column span="":::
      " \_ файлы"
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="":::
      " \_ файл"
   :::column-end:::
   :::column span="":::
      " \_ фитксерс"
   :::column-end:::
   :::column span="":::
      " \_ фитксатегиак"
   :::column-end:::
   :::column span="":::
      " \_ плики"
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="":::
      " \_ саубори"
   :::column-end:::
   :::column span="":::
      " \_ тиедостот"
   :::column-end:::
   :::column span="":::
   :::column-end:::
   :::column span="":::
   :::column-end:::
:::row-end:::



 

> [!Note]  
> Эта функция чувствительна к регистру расширения. Например, для указанного выше примера вложенная папка с именем "Мидок \_ Files" не будет подключена к MyDoc.htm.

 

Включение или отключение подключения файлов осуществляется с помощью параметра **reg \_ DWORD** , нофилефолдерконнектион в следующем разделе реестра.

```
HKEY_CURRENT_USER
   Software
      Microsoft
         Windows
            CurrentVersion
               Explorer
```

Обычно это значение не определено, а соединение с файлом включено. При необходимости можно отключить подключение к файлу, добавив это значение в раздел и установив для него параметр 1. Чтобы снова включить подключение к файлу, присвойте параметру Нофилефолдерконнектион значение 0.

> [!Note]  
> Подключение файла обычно должно быть включено, так как от него могут зависеть другие приложения. Отключите соединение с файлом только в случае крайней необходимости.

 

## <a name="moving-copying-renaming-and-deleting-files"></a>Перемещение, копирование, переименование и удаление файлов

Пространство имен не является статическим, и приложениям обычно требуется управлять файловой системой, выполнив одну из следующих операций.

-   Копирование объекта в другую папку.
-   Перемещение объекта в другую папку.
-   Удаление объекта.
-   Переименование объекта.

Все эти операции выполняются с помощью [**шфилеоператион**](/windows/desktop/api/Shellapi/nf-shellapi-shfileoperationa). Эта функция принимает один или несколько исходных файлов и создает соответствующие файлы назначения. В случае операции удаления система пытается разместить удаленные файлы в корзине.

Также можно перемещать файлы с помощью функции [перетаскивания](dragdrop.md) .

Чтобы использовать функцию, необходимо заполнить члены структуры [**шфилеопструкт**](/windows/desktop/api/Shellapi/ns-shellapi-shfileopstructa) и передать ее в [**шфилеоператион**](/windows/desktop/api/Shellapi/nf-shellapi-shfileoperationa). Ключевые элементы структуры **пфром** и переносятся. 

Член **пфром** представляет собой строку, завершающуюся **нулем**, которая содержит одно или несколько имен исходных файлов. Эти имена могут быть либо полными путями, либо стандартными подстановочными знаками DOS, такими как \* . \* . Хотя этот член объявлен как строка с **завершающим нулем,** он используется в качестве буфера для хранения нескольких имен файлов. Каждое имя файла должно заканчиваться обычным **нулевым** символом. К концу окончательного имени должен быть добавлен дополнительный символ **null** для указания на конец **пфром**.

Перекрывающийся **элемент —** это строка, завершающаяся символом двойной точности **null**, подобно **пфром**. Элемент **«** составной» содержит имена одного или нескольких полных имен назначения. Они упаковываются так  же, как и для **пфром**. Если  перестройка содержит несколько имен, необходимо также установить флаг **ФОФ \_ мултидестфилес** в элементе **ффлагс** . Использование **этого параметра зависит от** операции, как описано здесь.

-   Для операций копирования и перемещения, если все файлы будут находиться в одном каталоге, то, что не **будет содержать полное** имя каталога. Если файлы будут находиться в разных назначениях **, то** , в своюмся, они также могут содержать один полный каталог или имя файла для каждого исходного файла. Если каталог не существует, система создаст его.
-   Для операций переименования в **пфром** **содержится один** полный путь к каждому исходному файлу.
-   Операции **удаления не используются** .

### <a name="notifying-the-shell"></a>Уведомление оболочки

Уведомлять оболочку об изменении после использования [**шфилеоператион**](/windows/desktop/api/Shellapi/nf-shellapi-shfileoperationa) для перемещения, копирования, переименования или удаления файлов или после выполнения любых других действий, затрагивающих пространство имен. К действиям, которые должны сопровождаться уведомлением, относятся следующие:

-   Добавление или удаление файлов или папок.
-   Перемещение, копирование или переименование файлов или папок.
-   Изменение сопоставления файлов.
-   Изменение атрибутов файла.
-   Добавление или удаление дисков или носителей.
-   Создание или отключение общей папки.
-   Изменение списка образов системы.

Приложение уведомляет оболочку путем вызова [**шчанженотифи**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shchangenotify) с подробными сведениями о том, что изменилось. Оболочка может обновить свой образ пространства имен, чтобы точно отразить его новое состояние.

## <a name="simple-example-of-managing-files-with-shfileoperation"></a>Простой пример управления файлами с помощью Шфилеоператион

В следующем примере консольного приложения показано использование [**шфилеоператион**](/windows/desktop/api/Shellapi/nf-shellapi-shfileoperationa) для копирования файлов из одного каталога в другой. Исходный и конечный каталоги, C: \\ Мои \_ документы и C: \\ My \_ Docs2, жестко запрограммированы в приложении для простоты.


```C++
#include <shlobj.h>
#include <shlwapi.h>
#include <strsafe.h>

int main(void)
{
    IShellFolder *psfDeskTop = NULL;
    IShellFolder *psfDocFiles = NULL;
    LPITEMIDLIST pidlDocFiles = NULL;
    LPITEMIDLIST pidlItems = NULL;
    IEnumIDList *ppenum = NULL;
    SHFILEOPSTRUCT sfo;
    STRRET strDispName;
    TCHAR szParseName[MAX_PATH];
    TCHAR szSourceFiles[256];
    int i;
    int iBufPos = 0;
    ULONG chEaten;
    ULONG celtFetched;
    size_t ParseNameSize = 0;
    HRESULT hr;
    

    szSourceFiles[0] = '\0';
    hr = SHGetDesktopFolder(&psfDeskTop);

    hr = psfDeskTop->ParseDisplayName(NULL, NULL, L"c:\\My_Docs", 
         &chEaten, &pidlDocFiles, NULL);
    hr = psfDeskTop->BindToObject(pidlDocFiles, NULL, IID_IShellFolder, 
         (LPVOID *) &psfDocFiles);
    hr = psfDeskTop->Release();

    hr = psfDocFiles->EnumObjects(NULL,SHCONTF_FOLDERS | SHCONTF_NONFOLDERS, 
         &ppenum);

    while( (hr = ppenum->Next(1,&pidlItems, &celtFetched)) == S_OK 
       && (celtFetched) == 1)
    {
        psfDocFiles->GetDisplayNameOf(pidlItems, SHGDN_FORPARSING, 
            &strDispName);
        StrRetToBuf(&strDispName, pidlItems, szParseName, MAX_PATH);
        
        hr = StringCchLength(szParseName, MAX_PATH, &ParseNameSize);
        
        if (SUCCEEDED(hr))
        {
            for(i=0; i<=ParseNameSize; i++)
            {
                szSourceFiles[iBufPos++] = szParseName[i];
            }
            CoTaskMemFree(pidlItems);
        }
    }
    ppenum->Release();
    
    szSourceFiles[iBufPos] = '\0';

    sfo.hwnd = NULL;
    sfo.wFunc = FO_COPY;
    sfo.pFrom = szSourceFiles;
    sfo.pTo = "c:\\My_Docs2\0";
    sfo.fFlags = FOF_SILENT | FOF_NOCONFIRMATION | FOF_NOCONFIRMMKDIR;

    hr = SHFileOperation(&sfo);
    
    SHChangeNotify(SHCNE_UPDATEDIR, SHCNF_PATH, (LPCVOID) "c:\\My_Docs2", 0);

    CoTaskMemFree(pidlDocFiles);
    psfDocFiles->Release();

    return 0;
}
```



Приложение сначала получает указатель на интерфейс [**ишеллфолдер**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) рабочего стола. Затем он получает ПИДЛ исходного каталога, передавая его полный путь к [**ишеллфолдер::P арседисплайнаме**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-parsedisplayname). Обратите внимание, что **ишеллфолдер::P арседисплайнаме** требует, чтобы путь к каталогу был строкой в Юникоде. Затем приложение привязывается к исходному каталогу и использует интерфейс **ишеллфолдер** для получения интерфейса [**иенумидлист**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ienumidlist) объекта перечислителя.

При перечислении каждого файла в исходном каталоге для получения его имени используется [**ишеллфолдер:: жетдисплайнамеоф**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getdisplaynameof) . \_Установлен флаг шгдн форпарсинг, в результате чего **ишеллфолдер:: жетдисплайнамеоф** возвращает полный путь к файлу. Пути к файлам, включая завершающие **нуль** -символы, объединяются в один массив *сзсаурцефилес*. Второй символ **null** добавляется к последнему пути для правильного завершения работы массива.

После завершения перечисления приложение присваивает значения структуре [**шфилеопструкт**](/windows/desktop/api/Shellapi/ns-shellapi-shfileopstructa) . Обратите внимание, что массив, назначенный **для задания** назначения, должен также завершаться значением Double **null**. В этом случае он просто включается в строку, которая была назначена без **необходимости.** Поскольку это консольное приложение, \_ Флаги ФОФ Silent, ФОФ \_ unconfirm и ФОФ \_ ноконфирммкдир установлены так, чтобы скрывать любые диалоговые окна, которые могут появиться. После возврата [**шфилеоператион**](/windows/desktop/api/Shellapi/nf-shellapi-shfileoperationa) вызывается [**Шчанженотифи**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shchangenotify) для уведомления оболочки об изменении. Затем приложение выполняет обычную очистку и возвращает.

## <a name="adding-files-to-the-shells-list-of-recent-documents"></a>Добавление файлов в список последних документов оболочки

Оболочка поддерживает список недавно добавленных или измененных документов для каждого пользователя. пользователь может отобразить список ссылок на эти файлы, щелкнув документы на меню. Как и в случае с папкой «Мои документы», у каждого пользователя есть каталог файловой системы для хранения фактических ссылок. Чтобы получить ПИДЛ от последнего каталога текущего пользователя, приложение может вызвать [**шжетфолдерлокатион**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shgetfolderlocation) с CSid \_ или вызвать [**шжетфолдерпас**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shgetfolderpatha) для получения пути.

Приложение может перечислить содержимое папки последних с помощью методик, описанных выше в этом документе. Однако приложение не должно изменять содержимое папки так, как будто оно является обычной папкой файловой системы. если это так, то список последних документов оболочки не будет обновляться должным образом, а изменения не будут отражены в меню. Вместо этого, чтобы добавить ссылку на документ в папку "последние" пользователя, приложение может вызвать [**шаддторецентдокс**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shaddtorecentdocs). оболочка добавит ссылку в соответствующую папку файловой системы, а также обновит список последних документов и меню. Эту функцию также можно использовать для очистки папки.

 

 
