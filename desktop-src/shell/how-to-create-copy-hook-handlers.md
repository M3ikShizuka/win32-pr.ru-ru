---
description: Использование расширений оболочки для реализации обработчика ловушки копирования.
ms.assetid: 05808281-84fb-402d-9fa1-3a747b29d030
title: Как создавать обработчики обработчиков копий
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1468839eacc10272f8f97a120b98ada6d580bacf
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104264424"
---
# <a name="how-to-create-copy-hook-handlers"></a>Как создавать обработчики обработчиков копий

Общие процедуры для реализации и регистрации обработчика расширений оболочки обсуждаются в разделе [Создание обработчиков расширений оболочки](handlers.md). В этом документе рассматриваются аспекты реализации, характерные для обработчиков событий копирования.

-   [Реализация обработчиков событий копирования](#step-1-implementing-copy-hook-handlers)
-   [Регистрация обработчиков событий копирования](#step-2-registering-copy-hook-handlers)
-   [См. также](#related-topics)

## <a name="instructions"></a>Инструкции

### <a name="step-1-implementing-copy-hook-handlers"></a>Шаг 1. Реализация обработчиков событий копирования

Как и все обработчики расширений оболочки, обработчики событий копирования — это объекты модели COM, реализованные в виде библиотек DLL. В дополнение к [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown): [**икопихук**](/previous-versions/windows/desktop/legacy/bb776049(v=vs.85)), они экспортируют один интерфейс. Оболочка инициализирует обработчик напрямую, поэтому нет необходимости в интерфейсе инициализации, например [**ишеллекстинит**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellextinit).

Интерфейс [**икопихук**](/previous-versions/windows/desktop/legacy/bb776049(v=vs.85)) содержит один метод [**Икопихук:: копикаллбакк**](/previous-versions/windows/desktop/legacy/bb776048(v=vs.85)). Когда папка собирается для перемещения, оболочка вызывает этот метод. Он передается в различные данные, в том числе:

-   Имя папки.
-   Место назначения папки или новое имя.
-   Попытка выполнить операцию.
-   Атрибуты исходной и целевой папок.
-   Маркер окна, который может использоваться для вывода пользовательского интерфейса.

Когда вызывается метод [**икопихук:: копикаллбакк**](/previous-versions/windows/desktop/legacy/bb776048(v=vs.85)) обработчика, он возвращает одно из трех следующих значений, чтобы указать оболочке, как она должна быть продолжена.



| Значение    | Описание                                                                                                                                      |
|----------|--------------------------------------------------------------------------------------------------------------------------------------------------|
| IDYES    | Разрешает операцию.                                                                                                                            |
| IDNO     | Предотвращает операцию в этой папке. Оболочка может продолжить работу с другими утвержденными операциями, например с операцией пакетного копирования. |
| IDCANCEL | Предотвращает текущую операцию и отменяет все ожидающие операции.                                                                               |



 

### <a name="step-2-registering-copy-hook-handlers"></a>Шаг 2. Регистрация обработчиков событий копирования

Обработчики событий копирования для папок регистрируются в подразделе шеллекс копихукхандлерс **\_ \_ корневого каталога классов hKey** \\  \\  \\  . Создайте подраздел **копихукхандлерс** с именем для обработчика и задайте в качестве значения по умолчанию для подраздела строковое значение GUID идентификатора класса обработчика (CLSID).

В следующем примере добавляется подраздел **микопихандлер** в список обработчиков дескрипторов копий оболочки.

```
HKEY_CLASSES_ROOT
   Directory
      shellex
         CopyHookHandlers
            MyCopyHandler
               (Default) = {MyCopyHandler CLSID GUID}
```

Обработчики событий копирования для объектов принтеров в основном регистрируются аналогичным образом. Единственное отличие заключается в том, что их необходимо зарегистрировать в подразделе " **\_ \_ корневые** \\ **принтеры** классов hKey".

## <a name="remarks"></a>Примечания

Обычно пользователи и приложения могут копировать, перемещать, удалять или переименовывать папки с небольшими ограничениями. Реализуя обработчик события копирования, вы можете контролировать, выполняются ли эти операции. Например, реализация такого обработчика позволяет предотвратить переименование или удаление критических папок. Для объектов-принтеров также могут быть реализованы обработчики ловушек копирования.

Обработчики копирования являются глобальными. Оболочка вызывает все зарегистрированные обработчики каждый раз, когда приложение или пользователь пытается скопировать, переместить, удалить или переименовать папку или объект принтера. Обработчик не выполняет саму операцию. Он только утверждает или отменяет его. Если все обработчики утверждены, оболочка выполняет операцию. Если какой-либо из обработчиков отменяет операцию, он отменяется и остальные обработчики не вызываются. Обработчики событий копирования не сообщают об успехе или неуспешном выполнении операции, поэтому их нельзя использовать для наблюдения за операциями с файлами.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Создание обработчиков расширений оболочки](handlers.md)
</dt> <dt>

[**икопихук**](/previous-versions/windows/desktop/legacy/bb776049(v=vs.85))
</dt> </dl>

 

 
