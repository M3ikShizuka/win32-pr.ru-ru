---
title: Виртуализация ресурсов
description: Виртуализация ресурсов
ms.assetid: ead0e99a-94da-4e80-bb68-d8f4b199173d
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f340b1a1bddfb3fd591452e028c80403b9c7e02f
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "103777354"
---
# <a name="resource-virtualization"></a>Виртуализация ресурсов

Основной функцией TBS является эффективное совместное использование определенных ограниченных ресурсов TPM: ключей, авторизации и транспортных сеансов.

При создании экземпляра одного из этих ресурсов TBS создает виртуальный экземпляр ресурса и возвращает его в поток команд результата (вместо фактического экземпляра Handle, возвращенного доверенным платформенным модулем). TBS поддерживает сопоставление между виртуальным и фактическим внутренним обработчиком. Если в доверенном платформенном модуле недостаточно свободного пространства для хранения большего количества ресурсов заданного типа, существующие экземпляры ресурса будут выборочно сохранены и исключены, пока доверенный платформенный модуль не сможет разместить новый ресурс. Когда старые ресурсы снова потребуются, TBS загружает сохраненные контексты (при необходимости сохраняет и удаляет другие ресурсы) перед отправкой команды.

Вся виртуализация в TBS выполняется от имени определенного контекста. Каждому контексту предоставляется доступ только к виртуальным ресурсам, созданным специально для его имени, а также к физическим ресурсам доверенного платформенного модуля, которые соответствуют этим виртуальным ресурсам. По умолчанию общее число виртуальных ресурсов ограничено 500. Это число можно изменить путем создания или изменения значения реестра **DWORD** с именем **максресаурцес** в разделе **hKey \_ Local \_ Machine** \\ **Software** \\ **Microsoft** \\ **TPM**. Использование ресурсов TBS в режиме реального времени можно наблюдать с помощью средства "системный монитор" для отслеживания количества ресурсов TBS. Это ограничение стало устаревшим в Windows 8 и Windows Server 2012.

Ограниченные ресурсы TPM, которые не виртуализированы TBS (например, счетчики и хранилище NV), должны совместно использоваться программными стеками.

> [!Note]  
> В результате виртуализации этого дескриптора происходит сбой команд, которые включают в себя дескрипторы ключей в вычислении параметров авторизации HMAC. В результате многие команды, устаревшие в TPM версии 1,2, не могут использоваться программным обеспечением приложения в среде TBS.

 

## <a name="resource-limits"></a>Ограничения ресурсов

TPM позволяет вызывающим объектам запрашивать свои возможности, чтобы определить, сколько места доступно для определенных типов ресурсов. Некоторые из этих ограничений ресурсов, например объем пространства, доступного для ключей, сеансов авторизации и транспортных сеансов, эффективно расширяются службой TBS с помощью виртуализации. Ограничения TBS, которые управляются параметром реестра **максресаурцес** , обычно гораздо выше, чем фактические ограничения базового оборудования TPM. Не предоставляется механизм для запроса ограничений TBS отдельно от ограничений оборудования TPM. Это ограничение TBS стало устаревшим в Windows 8 и Windows Server 2012.

## <a name="keys"></a>Ключи

TBS соединяет дескрипторы ключей таким образом, чтобы ключи могли быть прозрачно выгружены из доверенного платформенного модуля, если они не используются и не загружаются обратно в доверенный платформенный модуль при необходимости. При создании ключа TBS связывает виртуальный обработчик с загруженным ключом. Один и тот же виртуальный маркер используется в течение времени существования ресурса. Дескрипторы виртуальных ключей допустимы только в контексте, в котором они были созданы, а связанные ресурсы не сохраняются за время существования контекста.

-   Создание ключей с помощью \_ LOADKEY2 TPM

    Если ключ создается с помощью \_ команды TPM LoadKey2, TPM2 \_ КРЕАТЕПРИМАРИ, TPM2 \_ Load или TPM2 \_ лоадекстернал, TBS заменяет маркер в потоке возвращаемого байта виртуальным ключом, который имеет свой выбор. В результате TBS гарантирует уникальность каждого виртуального обработчика. Если TBS обнаруживает конфликт (очень маловероятное событие), TBS выгружает ключ из TPM и информирует вызывающее программное обеспечение. Затем программное обеспечение может повторно отправить операцию. Этот процесс может повторяться до тех пор, пока TBS не получит уникальный маркер ключа.

-   Очистка ключей

    TBS делает недействительным обработку виртуального ключа при получении сообщения флушспеЦифик доверенного платформенного модуля \_ или TPM2 \_ флушконтекст для этого виртуального маркера из контекста клиента. Если ключ физически находится в доверенном платформенном модуле при получении сообщения о сбросе, TBS удаляет ключ из TPM в это время.

-   Временное удаление ключей

    При удалении ключа из доверенного платформенного модуля для освобождения места для нового элемента TBS выполняет команду савеконтекст доверенного платформенного модуля \_ или TPM2 \_ контекстсаве для ключа перед его исключением.

-   Восстановление ключей

    Когда команда, ссылающаяся на загруженный ключ, отправляется в TBS, она обеспечивает физическое присутствие ключа в доверенном платформенном модуле. Если ключ отсутствует, TBS восстанавливает его с вызовом TPM \_ лоадконтекст или TPM2 \_ контекстлоад. Если ключ не может быть восстановлен в доверенный платформенный модуль, то TBS возвращает TPM \_ E \_ Недопустимый \_ кэйхандле в качестве результата TPM.

TBS заменяет каждый виртуальный маркер, связанный с ключом в потоке команд, физическим маркером ключа, загруженного в доверенный платформенный модуль. Если команда отправляется с виртуальным маркером, который не распознается TBS в контексте вызывающего, то TBS форматирует поток ошибок для вызывающего объекта с доверенным платформенным модулем (TPM \_ E) \_ Недопустимый \_ кэйхандле.

## <a name="authorization-sessions"></a>Сеансы авторизации

Сеансы авторизации создаются путем вызова TPM \_ оиап, TPM \_ ОСАП или дсап TPM \_ . В каждом случае поток возвращаемого байта содержит физический маркер доверенного платформенного модуля для вновь созданного сеанса авторизации. TBS заменяет это виртуальным маркером. При последующем обращении к сеансу авторизации TBS заменяет виртуальный обработчик в потоке команд физическим маркером сеанса авторизации. TBS гарантирует, что время существования виртуального сеанса авторизации будет совпадать с жизненным циклом физического сеанса авторизации. Если клиент пытается использовать виртуальный обработчик с истекшим сроком действия, TBS форматирует поток ошибок с ошибкой \_ ИНВАЛИДАУСХАНДЛЕ TPM.

Слоты сеансов ограничены, и TBS может исключать внешние слоты, в которых будут сохраняться контексты сеансов авторизации. В этом случае TBS выбирает сеанс авторизации, чтобы сделать его недействительным, чтобы новый контекст мог быть успешно сохранен. Приложение, которое пытается использовать старый контекст, потребует повторного создания сеанса авторизации.

TBS делает виртуальный сеанс авторизации недействительным при возникновении любого из следующих случаев.

-   Флаг продолжения использования, связанный с сеансом авторизации в возвращенном потоке команд из доверенного платформенного модуля, имеет **значение false**.
-   Команда, использующая сеанс авторизации, завершается ошибкой.
-   Выполняется команда, которая делает сеанс авторизации, связанный с командой (например, TPM креатеврапкэй), недействительным \_ .
-   Ключ, связанный с сеансом ОСАП или ДСАП, удаляется из доверенного платформенного модуля с помощью вызова TPM \_ флушспеЦифик или TPM2 \_ флушконтекст (вне зависимости от того, была ли эта команда создана с TBS или с программным обеспечением более высокого уровня).

    TBS автоматически повторно синхронизирует сеансы авторизации после успешного выполнения определенных недетерминированных команд, чтобы убедиться в том, что состояние TBS остается соответствующим состоянию доверенного платформенного модуля. Затронутые команды:

    -   \_ \_ Управление делегированием в модуле TPM \_
    -   \_ \_ Креатеовнерделегатион делегата о доходе в TPM \_
    -   \_ \_ Лоадовнерделегатион делегата о доходе в TPM \_

В каждом из следующих случаев сеанс авторизации в доверенном платформенном модуле автоматически очищается модулем TPM:

-   Создание сеансов авторизации

    Дескрипторы сеансов виртуальной авторизации допустимы только в контексте, в котором они были созданы, а связанные ресурсы не сохраняются за время существования соответствующего контекста.

-   Очистка сеансов авторизации

    TBS делает виртуальный сеанс авторизации недействительным, если он получает \_ команду ФЛУШСПЕЦИФИК TPM или TPM2 \_ флушконтекст для виртуального маркера из контекста клиента. Если сеанс авторизации физически находится в доверенном платформенном модуле при получении команды Flush, TBS немедленно сбрасывает физический сеанс из доверенного платформенного модуля.

-   Временное удаление сеансов авторизации

    При удалении сеанса авторизации из доверенного платформенного модуля для освобождения места для новой сущности TBS выполняет \_ САВЕКОНТЕКСТ TPM или TPM2 \_ контекстсаве в этом сеансе авторизации.

-   Восстановление сеансов авторизации

    Когда в TBS отправляется авторизованная команда доверенного платформенного модуля (TPM), TBS гарантирует, что все виртуальные сеансы авторизации, на которые ссылается команда, физически находятся в доверенном платформенном модуле. Если какой-либо из сеансов авторизации отсутствует, TBS восстанавливает их с вызовом TPM \_ лоадконтекст или TPM2 \_ контекстлоад. Если сеанс авторизации не удается восстановить в доверенный платформенный модуль, TBS возвращает TPM \_ E \_ Недопустимый \_ маркер в качестве результата TPM.

TBS заменяет каждый виртуальный обработчик, связанный с сеансом авторизации в потоке команд, физическим маркером сеанса авторизации, загруженного в доверенный платформенный модуль.

Если команда отправляется с виртуальным маркером, который не распознается TBS в контексте вызывающего объекта, то TBS форматирует поток ошибок для вызывающего объекта с ошибкой \_ \_ Недопустимый маркер TPM E \_ .

## <a name="transport-sessions"></a>Транспортные сеансы

> [!Note]  
> Обработка транспортных сеансов, описанных здесь, относится только к Windows Vista и Windows Server 2008.

 

Транспортные сеансы — это механизм, предоставляемый доверенным платформенным модулем, который позволяет стеку программного обеспечения шифровать данные в команде при их передаче между программным обеспечением и доверенным платформенным модулем. Это не дает злоумышленнику перехватывать данные по мере их прохождения через аппаратную шину.

> [!IMPORTANT]
> Шифруются только полезные данные. Выполняемые команды по-прежнему можно определить.

 

К сожалению, этот механизм также не позволяет TBS исследовать полезные данные. В большинстве случаев это не является проблемой, поскольку TBS изменяет только дескрипторы, а не данные полезных данных. Однако в случае \_ ЛОАДКОНТЕКСТ TPM для экземпляра возвращаемый маркер ресурса охватывается шифрованием. Таким образом, TBS не пытается выполнить \_ операцию ЛОАДКОНТЕКСТ TPM, охваченную транспортным сеансом.

TBS блокирует следующие команды в сеансе транспорта:

-   \_ЕСТАБЛИШТРАНСПОРТ TPM
-   \_ЕКСЕКУТЕТРАНСПОРТ TPM
-   \_Маркер завершения \_ TPM
-   \_ЛОАДКЭЙ TPM
-   \_ЕВИКТКЭЙ TPM
-   \_САВЕКЭЙКОНТЕКСТ TPM
-   \_ЛОАДКЭЙКОНТЕКСТ TPM
-   \_САВЕАУСКОНТЕКСТ TPM
-   \_ЛОАДАУСКОНТЕКСТ TPM
-   \_САВЕКОНТЕКСТ TPM
-   \_ЛОАДКОНТЕКСТ TPM
-   \_ФЛУШСПЕЦИФИК TPM

Если какая-либо из этих команд охватывается транспортным сеансом, TBS возвращает \_ команду TPM E \_ Embedded \_ \_ не поддерживается в качестве результата TPM.

Дескрипторы транспортного сеанса виртуализованы так же, как дескрипторы ключей и дескрипторы авторизации. Существует ограниченное число сохраненных слотов контекста сеанса транспорта, доступных в доверенном платформенном модуле.

TBS делает сеанс виртуального транспорта недействительным, если происходит одно из следующих условий:

-   Флаг продолжения использования, связанный с сеансом транспорта в потоке команд возврата из доверенного платформенного модуля, имеет **значение false**.

    Как и в случае с сеансами авторизации, TBS автоматически повторно синхронизирует сеансы транспорта после успешного выполнения определенных недетерминированных команд, чтобы убедиться в том, что состояние TBS остается соответствующим состоянию доверенного платформенного модуля. Затронутые команды:

    -   \_ \_ Управление делегированием в модуле TPM \_
    -   \_ \_ Креатеовнерделегатион делегата о доходе в TPM \_
    -   \_ \_ Лоадовнерделегатион делегата о доходе в TPM \_

В каждом из этих случаев сеанс транспорта на доверенном платформенном модуле будет автоматически сброшен доверенным платформенным модулем:

-   Создание транспортных сеансов

    TBS создает виртуальный обработчик для каждого сеанса транспорта, созданного клиентом. Дескрипторы виртуального транспорта допустимы только в контексте, в котором они были созданы, а связанные ресурсы не сохраняются за время существования соответствующего контекста.

-   Очистка сеансов транспорта

    TBS делает сеанс виртуального транспорта недействительным, если он получает \_ команду ФЛУШСПЕЦИФИК TPM для виртуального маркера из контекста клиента. Если во время получения команды FLUSH сеанс транспорта физически находится в доверенном платформенном модуле, TBS немедленно сбрасывает физический сеанс из доверенного платформенного модуля.

-   Временное удаление транспортных сеансов

    При удалении сеанса транспорта из доверенного платформенного модуля для освобождения места для новой сущности TBS выполняет \_ САВЕКОНТЕКСТ TPM в этом сеансе транспорта.

-   Восстановление сеансов транспорта

    Когда команда ексекутетранспорт доверенного платформенного модуля \_ отправляется в TBS, TBS гарантирует, что сеанс транспорта, на который ссылается команда, физически находится в доверенном платформенном модуле. Если сеанс транспорта отсутствует, TBS восстанавливает его с помощью вызова \_ ЛОАДКОНТЕКСТ TPM.

TBS заменяет виртуальный обработчик, связанный с сеансом транспорта, в командном потоке физическим маркером сеанса транспорта, загруженного в доверенный платформенный модуль. Если команда отправляется с виртуальным маркером, который не распознается TBS в контексте вызывающего объекта, то TBS форматирует поток ошибок для вызывающего объекта с помощью \_ \_ недействительного маркера "TPM E" \_ .

## <a name="exclusive-transport-sessions"></a>Исключающие сеансы транспорта

Монопольные инкапсулированные сеансы передачи позволяют программному обеспечению верхнего уровня определить, обращалось ли какое-либо другое программное обеспечение к доверенному платформенному модулю во время цепочки команд. Они не предотвращают доступ к доверенному платформенному модулю другого программного обеспечения, они просто предоставляют создателю транспортного сеанса возможность определить, что какой-то другой доступ был выполнен. TBS не выполняет никаких действий, чтобы мешать эксклюзивному транспортному сеансу, но он несколько не совместим с ними. TBS пытается дублировать естественное поведение доверенного платформенного модуля, так как он является прозрачным, поэтому не дает предпочтений командам из контекстов, устанавливающих монопольный сеанс транспорта. Например, если клиент б отправляет команду, когда клиент A находится в монопольном сеансе транспорта, он сделает недействительным монопольный сеанс транспорта клиента а.

Команды, инициированные TBS, также могут прекратить монопольный сеанс транспорта. Это происходит, когда клиент а находится в монопольном сеансе транспорта, а команда, выполняемая клиентом, вызывает ресурс, который физически отсутствует в доверенном платформенном модуле. Эта ситуация активирует диспетчер виртуализации TBS для выполнения \_ команды ЛОАДКОНТЕКСТ TPM для предоставления ресурса, который прерывает монопольный сеанс транспорта клиента a.

 

 




