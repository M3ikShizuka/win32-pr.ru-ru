---
description: Восстановление после ошибки Invalid-Device
ms.assetid: 1f5c3458-70ca-45ba-ac33-5c7b9f092320
title: Восстановление после ошибки Invalid-Device
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ca20c32be46367f53a14ce26c39f980e3649b652
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104142409"
---
# <a name="recovering-from-an-invalid-device-error"></a>Восстановление после ошибки Invalid-Device

Многие методы в ВАСАПИ возвращают ошибку с кодом АУДКЛНТ \_ E \_ \_ , если устройство конечной точки аудио, используемое клиентским приложением, становится недействительным. Этот код ошибки указывает на то, что устройство конечной точки было отключено или перенастроено, отключено, удалено или иным образом недоступно для использования. Часто приложение может восстановиться после этой ошибки.

>[!NOTE]
> Сведения о восстановлении после недопустимых ошибок устройства при использовании пространственных аудио-API (Исак) см. в разделе [восстановление после ошибки Invalid-Device (пространственный звук)](recovering-from-an-invalid-device-error-spatial-sound.md) .

Стратегия, которую приложение должно использовать для восстановления после \_ \_ недействительной ошибки устройства аудклнт E, зависит от того, \_ какие из следующих методов используются приложением для выбора устройства конечной точки аудио:

-   Всегда выбирайте устройство для подготовки аудио или записи звука по умолчанию.
-   Выберите конкретное устройство звуковой конечной точки.

В последнем случае приложение автоматически выбирает определенное устройство в соответствии с внутренними требованиями или позволяет пользователю явно выбрать устройство из списка доступных устройств.

Приложение, использующее устройство по умолчанию, может попытаться выполнить восстановление после \_ \_ \_ недействительной ошибки устройства аудклнт E, как показано ниже.

1.  Освободите интерфейс [**иаудиоклиент**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) и другие интерфейсы васапи, которые он получил на устройстве.
2.  Вызовите метод [**иммдевицеенумератор:: жетдефаултаудиоендпоинт**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) , чтобы получить текущее звуковое устройство по умолчанию.
3.  Попытка активировать [**иаудиоклиент**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) на звуковом устройстве по умолчанию.

Выполнив описанные выше действия, приложение будет реагировать соответствующим образом, независимо от причины \_ \_ ошибки " \_ Ошибка недействительности устройства аудклнт". Если перенастройка устройства по умолчанию привела к ошибке (например, если пользователь изменил формат потока, используемый устройством), то эти действия, если они были выполнены, позволят приложению продолжать использовать одно и то же устройство. Если пользователь отключил или удалил устройство, которое использовалось приложением, и доступно другое устройство для использования роли устройства по умолчанию, приложение может продолжить работу с новым устройством по умолчанию. В любом случае приложение адаптируется автоматически, не требуя вмешательства пользователя.

Приложение, которое выбирает конкретное устройство, может попытаться восстановиться \_ после \_ \_ ошибки недействительности устройства аудклнт E следующим образом:

1.  Освободите интерфейс [**иаудиоклиент**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) и другие интерфейсы васапи, которые он получил на устройстве.
2.  Попытка активировать интерфейс [**иаудиоклиент**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) на том же устройстве.
3.  Если шаг 2 завершается неудачно, приложение может в качестве варианта предложить пользователю выбрать другое устройство.

Шаг 2 может быть выполнен успешно, если устройство, используемое приложением, было перенастроено, но не отключено или удалено. В случае успеха шаг 2 позволяет приложению автоматически продолжать использовать то же устройство, не требуя вмешательства пользователя. Шаг 3 подходит, если приложение позволяет пользователю явно выбрать другое устройство после того, как пользователь отключил или удалил ранее использованное устройство.

Приложение может определить более точную причину ошибки неправильного устройства путем регистрации для получения уведомления о том, что сеанс теряет подключение к устройству. Чтобы включить это уведомление, приложение реализует интерфейс [**иаудиосессионевентс**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) и вызывает метод [**Иаудиосессионконтрол:: регистераудиосессионнотификатион**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessioncontrol-registeraudiosessionnotification) для регистрации интерфейса. Если ошибка неправильного устройства приводит к отключению сеанса, ВАСАПИ вызывает метод [**иаудиосессионевентс:: онсессиондисконнектед**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) в зарегистрированном интерфейсе. С помощью этого метода ВАСАПИ информирует приложение о причине отключения. В Windows Vista вызов **онсессиондисконнектед** определяет следующие причины.

-   Пользователь удалил устройство конечной точки аудио.
-   Служба Windows Audio завершила работу.
-   Предпочтительный формат потока изменен для устройства, к которому подключен сеанс аудио.
-   Пользователь вышел из сеанса служб терминалов Windows (ВТС), в котором выполнялся сеанс звука. Дополнительные сведения о сеансах ВТС см. в документации по Windows SDK.
-   Сеанс ВТС, в котором выполнялся сеанс аудио, был отключен.
-   Сеанс звука (общего режима) был отключен, чтобы устройство конечной точки аудио было доступно для подключения в монопольном режиме.

В ответ на событие отключения ВАСАПИ закрывает все потоки, принадлежащие сеансу. Если приложение попытается получить доступ к закрытому потоку через метод ВАСАПИ, например [**иаудиоклиент:: жеткуррентпаддинг**](/windows/desktop/api/Audioclient/nf-audioclient-iaudioclient-getcurrentpadding), то метод завершается ошибкой и возвращает код ошибки аудклнт \_ E \_ \_ .

Дополнительное преимущество получения уведомлений через интерфейс [**иаудиосессионевентс**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) заключается в том, что уведомления прибывают асинхронно. Таким же, даже если поток не выполняется, приложение по-прежнему будет получать своевременные уведомления о недопустимых ошибках устройств, которые могут препятствовать выполнению потока.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Управление потоками](stream-management.md)
</dt> </dl>

 

 



