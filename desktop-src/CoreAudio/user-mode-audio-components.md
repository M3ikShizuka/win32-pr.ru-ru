---
description: User-Mode звуковых компонентов
ms.assetid: b240b629-5bb6-4b07-95be-8ca5a14a3567
title: User-Mode звуковых компонентов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 18715db2d32be3c4a70182571028acbfca411539
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103896061"
---
# <a name="user-mode-audio-components"></a>User-Mode звуковых компонентов

В Windows Vista основные API-интерфейсы аудиоподсистемы служат основой звуковой подсистемы пользовательского режима. Основные API аудио реализованы в виде тонкого слоя системных компонентов пользовательского режима, которые отделяют клиенты пользовательского режима от аудио драйверов и аудиоустройств в режиме ядра. Интерфейсы аудио API более высокого уровня, такие как DirectSound и функции мультимедиа Windows, обращаются к звуковым устройствам через основные API-интерфейсы аудио. Кроме того, некоторые звуковые приложения взаимодействуют напрямую с основными API-интерфейсами аудио.

Основные интерфейсы аудио API поддерживают понятное для пользователя понятие устройства конечной точки аудио. Устройство конечной точки звука — это программная абстракция, представляющая физическое устройство, которое пользователь напрямую управляет. Примеры устройств конечных точек аудио — это динамики, наушники и микрофоны. Дополнительные сведения см. в статье [устройства конечных точек аудио](audio-endpoint-devices.md).

На следующей схеме показаны основные API аудио и их связь с другими звуковыми компонентами пользовательского режима в Windows Vista.

![Схема компонентов для отрисовки звука в пользовательском режиме](images/fig1.jpg)

Для простоты на предыдущей схеме показан только путь к данным для отображения звука на устройстве конечной точки — схема не показывает путь к данным записи звука. Основные API аудио включают в себя [API ммдевице](mmdevice-api.md), [Васапи](wasapi.md), [API девицетопологи](devicetopology-api.md)и [API ендпоинтволуме](endpointvolume-api.md), которые реализуются в Audioses.dll и Mmdevapi.dll системных модулей пользовательского режима.

Как показано на предыдущей схеме, основные интерфейсы API аудио предоставляют основу для следующих интерфейсов API более высокого уровня:

-   Media Foundation
-   Функции **вавекскскс** и **миксеркскскс** Windows мультимедиа
-   Звука
-   DirectMusic

DirectSound, функции аудио мультимедиа Windows и Media Foundation (с помощью потоковой прорисовки звука или САР) напрямую взаимодействуют с основными интерфейсами API аудио. DirectMusic взаимодействует с основными API-интерфейсами аудио через DirectSound.

Клиент ВАСАПИ передает данные на устройство конечной точки через *буфер конечной точки*. Компоненты системного программного обеспечения и оборудования управляют перемещением данных из буфера конечной точки на устройство конечной точки способом, который в значительной степени прозрачен для клиента. Кроме того, для устройства конечной точки, которое подключается к звуковому адаптеру с обнаружением присутствия, клиент может создать буфер конечной точки только для физически присутствующего оконечного устройства. Дополнительные сведения об обнаружении устройств с разъемами см. в статье [устройства конечных точек аудио](audio-endpoint-devices.md).

На предыдущей схеме показаны два типа буфера конечной точки. Если клиент ВАСАПИ открывает поток в *общем режиме*, клиент записывает звуковые данные в буфер конечной точки, а подсистема Windows Audio считывает данные из буфера. В этом режиме клиент использует звуковое оборудование совместно с другими приложениями, запущенными в других процессах. Обработчик аудиозаписей применяет потоки из этих приложений и воспроизводит полученное сочетание с помощью оборудования. Обработчик звука — это системный компонент пользовательского режима (Audiodg.dll), выполняющий все операции потоковой обработки в программном обеспечении. В противоположность этому, если клиент открывает поток в *монопольном режиме*, клиент имеет эксклюзивный доступ к звуковому оборудованию. Обычно эксклюзивный режим требуется только для небольшого количества приложений "Pro Audio" или RTC. Несмотря на то, что на схеме показаны потоки общего и монопольного режимов, существует только один из этих двух потоков (и соответствующий буфер конечной точки) в зависимости от того, открывает ли клиент поток в общем или в монопольном режиме.

В монопольном режиме клиент может выбрать открытие потока в любом звуковом формате, поддерживаемом устройством конечной точки. В общем режиме клиент должен открыть поток в формате Mix, который в данный момент используется обработчиком аудио (или форматом, аналогичным формату Mix). Входные потоки обработчика аудио и выходного потока из механизма имеют все данные в этом формате.

В Windows 7 для потоков в режиме общего доступа добавлен новый компонент, именуемый *Low-латенце Mode* . В этом режиме обработчик звука работает в режиме опроса, в котором существенно уменьшается задержка. Это очень полезно для коммуникационных приложений, требующих низкой задержки аудиопотока для ускорения потоковой передачи.

Приложения, управляющие потоками аудио с низкой задержкой, могут использовать службу планировщика классов мультимедиа (MMCSS) в Windows Vista для повышения приоритета потоков приложения, обращающихся к буферам конечной точки. Служба MMCSS обеспечивает работу звуковых приложений с высоким приоритетом без блокировки ресурсов ЦП для приложений с более низким приоритетом. Служба MMCSS назначает приоритет потоку на основе его имени задачи. Например, Windows Vista поддерживает имена задач «аудио» и «Pro Audio» для потоков, которые управляют звуковыми потоками. По умолчанию приоритет потока "Pro Audio" выше, чем у "звукового" потока. Дополнительные сведения о службе MMCSS см. в документации по Windows SDK.

Основные API аудио поддерживают как форматы потока PCM, так и потоки без PCM. Однако обработчик звука может смешивать только потоки PCM. Поэтому только потоки с монопольным режимом могут иметь форматы, отличные от форматов PCM. Дополнительные сведения см. в разделе [форматы устройств](device-formats.md).

Обработчик аудио работает в собственном защищенном процессе, который отделен от процесса, в котором работает приложение. Для поддержки потока в общем режиме служба Windows Audio (под названием "служба аудио" на предыдущей схеме) выделяет буфер конечной точки между процессами, доступный как для приложения, так и для обработчика звука. Для монопольного режима буфер конечной точки находится в памяти, доступной как для приложения, так и для звукового оборудования.

Служба Windows Audio — это модуль, который реализует политику Windows Audio. Политика аудио — это набор внутренних правил, применяемых системой к взаимодействию между звуковыми потоками из нескольких приложений, которые совместно используют одно и то же звуковое оборудование. Служба Windows Audio реализует политику аудио, задавая параметры управления для обработчика звука. Ниже перечислены обязанности службы аудио.

-   Отслеживание звуковых устройств, которые пользователь добавляет или удаляет из системы.
-   Наблюдение за ролями, назначенными звуковым устройствам в системе.
-   Управление потоками аудио из групп задач, создающих аналогичные классы для аудио содержимого (консоль, мультимедиа и связь).
-   Управление уровнем громкости Объединенного потока вывода ("субмикс") для каждого из различных типов аудио содержимого.
-   Уведомление обработчика аудио о обрабатывающих элементах в путях данных для звуковых потоков.

В некоторых версиях Windows служба Windows Audio по умолчанию отключена и должна быть явно включена перед тем, как система сможет воспроизводить звук.

В примере, показанном на предыдущей схеме, устройство конечной точки — это набор динамиков, подключенных к звуковому адаптеру. Клиентское приложение записывает звуковые данные в буфер конечной точки, а обработчик звука обрабатывает сведения о переносе данных из буфера на устройство конечной точки.

Поле, помеченное как «аудио драйвер» на предыдущей схеме, может быть сочетанием предоставляемых системой драйверов и компонентов драйвера поставщика. В случае использования звукового адаптера на шине PCI или PCI Express система предоставляет драйвер системы класса портов (Portcls.sys), который реализует набор драйверов портов для различных функций аудио в адаптере, и поставщик оборудования предоставляет драйвер адаптера, который реализует набор драйверов минипорта для выполнения операций, связанных с устройством, для драйверов портов. В случае использования высококачественного аудио-контроллера и кодека на шине PCI или PCI Express система предоставляет драйвер адаптера (Hdaudio.sys), и не требуется драйвер, предоставленный поставщиком. В случае использования звукового адаптера на шине USB система предоставляет системный драйвер класса Австреам (Ks.sys) и драйвер USB Audio (Usbaudio.sys); Опять же, драйвер, предоставленный поставщиком, не требуется.

Для простоты на предыдущей схеме показаны только потоки отрисовки. Однако основные API-интерфейсы аудиоподсистемы также поддерживают захват потоков. В общем режиме несколько клиентов могут совместно использовать захваченный поток с устройства звукового оборудования. В монопольном режиме один клиент имеет эксклюзивный доступ к захваченному потоку с устройства.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Руководство по программированию](programming-guide.md)
</dt> </dl>

 

 



