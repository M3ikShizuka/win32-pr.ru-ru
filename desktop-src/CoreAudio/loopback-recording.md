---
description: Запись замыкания на себя
ms.assetid: 71c567f7-fffa-4b75-897a-63ed30c4c9b0
title: Запись замыкания на себя
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 7aa5ffe48bf11ad57b02085ab00dfd1ca09be0f72a56935cbd8d1bb40543033f
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118005277"
---
# <a name="loopback-recording"></a>Запись замыкания на себя

В режиме замыкания на себя клиент ВАСАПИ может захватить аудиопоток, который воспроизводится устройством конечной точки отрисовки. Чтобы открыть поток в режиме замыкания на себя, клиент должен выполнить следующие действия:

-   Получите интерфейс [**иммдевице**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immdevice) для устройства конечной точки отрисовки.
-   Инициализируйте поток отслеживания в режиме замыкания на себя на устройстве конечной точки отрисовки.

После выполнения этих действий клиент может вызвать метод [**иаудиоклиент:: Unservice**](/windows/desktop/api/Audioclient/nf-audioclient-iaudioclient-getservice) , чтобы получить интерфейс [**иаудиокаптуреклиент**](/windows/desktop/api/Audioclient/nn-audioclient-iaudiocaptureclient) на устройстве конечной точки отрисовки.

ВАСАПИ обеспечивает режим замыкания на себя в основном для поддержки отмены акустического эха (AEC). Однако другие типы звуковых приложений могут найти режим замыкания на себя, полезный для захвата системного набора, который воспроизводится аудио-подсистемой.

В примере кода в [записи потока](capturing-a-stream.md)функция рекордаудиостреам может быть легко изменена для настройки потока записи в режиме замыкания на себя. Необходимые изменения:

-   В вызове метода [**иммдевицеенумератор:: жетдефаултаудиоендпоинт**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) измените первый параметр (*поток* данных) с екаптуре на ерендер.
-   В вызове метода [**иаудиоклиент:: Initialize**](/windows/desktop/api/Audioclient/nf-audioclient-iaudioclient-initialize) измените значение второго параметра (*стреамфлагс*) с 0 на аудклнт \_ стреамфлагс \_ loopback.

в версиях Windows до Windows 10 1703, клиент записи в режиме опроса не получает никаких событий при инициализации потока с помощью управляемой событиями буферизации и поддерживает замыкание на себя. Чтобы обойти это, инициализируйте поток отрисовки в режиме, управляемом событиями. Каждый раз, когда клиент получает событие для потока отрисовки, он должен сообщить клиенту записи о необходимости запуска потока записи, считывающего следующий набор образцов из буфера конечной точки записи. в Windows 10 версиях 1703 и выше, поддерживаются клиенты замыкания на себя на основе событий, и больше не требуется обходной путь, использующий поток отрисовки.  

Клиент может включить режим замыкания на себя только для потока общего режима (АУДКЛНТ \_ шаремоде \_ Shared). Потоки с монопольным режимом не могут действовать в режиме замыкания на себя.

Реализация замыкания на себя ВАСАПИ зависит от возможностей оборудования. Если оборудование поддерживает ПИН-код замыкания на себя в конечной точке прорисовки, ВАСАПИ использует аудио, предоставленный на этом ПИН-коде, для потока замыкания на себя. Если оборудование не поддерживает ПИН-код замыкания на себя, ВАСАПИ копирует выходной поток из обработчика аудио в буфер записи приложения замыкания на себя в дополнение к копированию звуковых данных в ПИН-код прорисовки оборудования.

Некоторые поставщики оборудования реализуют устройства замыкания на себя (а не закреплять экземпляры на устройствах отрисовки) в своих звуковых адаптерах. Несмотря на то, что устройства замыкания на себя похожи на режим замыкания на себя, их использование может быть сложнее.

Аппаратные устройства замыкания на себя имеют следующие недостатки для звуковых приложений:

-   Не все звуковые адаптеры имеют устройства замыкания на себя. Поэтому приложения, зависящие от них, не будут работать на всех системах.
-   Прежде чем приложение сможет выполнить запись с устройства замыкания на себя, пользователь должен указать устройство замыкания на себя и включить его для использования.

Разные поставщики применяют разные имена аппаратных устройств замыкания. Ниже приведены примеры имен.

-   Стерео микшер
-   Набор для звука
-   Смешанные выходные данные
-   Что вы слышите

Отсутствие стандартизованных имен может привести к затруднениям при определении устройства обратной связи в списке имен устройств.

Аппаратное устройство замыкания на себя — это устройство записи. Таким образом, если адаптер поддерживает устройство замыкания на себя, звуковые приложения могут записываться с устройства так же, как и при записи с любого другого устройства записи.

Например, если выбрать аппаратное устройство замыкания на себя как устройство для записи по умолчанию, можно использовать функцию Рекордаудиостреам (без изменения) в примере кода в [записи потока](capturing-a-stream.md) для записи потока с устройства. (для записи потока с устройства можно также использовать старый API аудио, например Windows функции мультимедиа **вавеинкскскс** .)

если ваш звуковой адаптер содержит аппаратное устройство замыкания на себя, можно использовать панель управления Windows мультимедиа, Mmsys.cpl, чтобы назначить устройство устройством записи по умолчанию. Для этого необходимо выполнить следующие шаги:

1.  Чтобы запустить Mmsys.cpl, откройте окно командной строки и введите следующую команду:

    ```C++
    control mmsys.cpl,,1
    ```

    

    Кроме того, можно запустить Mmsys.cpl, щелкнув правой кнопкой мыши значок динамика в области уведомлений, расположенном в правой части панели задач, и выбрать пункт **запись устройств**.

2.  После открытия окна Mmsys.cpl щелкните правой кнопкой мыши в любом месте списка устройств записи и убедитесь, что установлен флажок **Показывать Отключенные устройства** . (В противном случае, если устройство замыкания на себя отключено, оно не будет отображаться в списке.)
3.  Просмотрите список устройств записи, чтобы найти устройство замыкания на себя (если оно существует). Если устройство замыкания на себя отключено, включите его, щелкнув правой кнопкой мыши устройство и выбрав **включить**.
4.  Наконец, чтобы выбрать устройство замыкания на себя в качестве устройства для записи по умолчанию, щелкните устройство правой кнопкой мыши и выберите пункт **установить как устройство по умолчанию**.

ВАСАПИ поддерживает запись замыкания на себя независимо от того, содержит ли звуковое оборудование устройство замыкания на себя или включено ли это устройство.

Windows Vista обеспечивает управление цифровыми правами (DRM). Поставщики содержимого используют DRM для защиты собственной музыки или другого содержимого от несанкционированного копирования и других недопустимых применений. Аналогичным образом, доверенный звуковой драйвер не позволяет устройству замыкания на себя записывать цифровые потоки, содержащие защищенное содержимое. Windows Vista позволяет использовать только надежные драйверы для воспроизведения защищенного содержимого. дополнительные сведения о доверенных драйверах и DRM см. в документации по Windows DDK.

ВАСАПИ loopback содержит сочетание всех воспроизводимых звуковых данных независимо от сеанса служб терминалов, из которого поступило звуковое сопровождение. Например, можно запустить клиент с замыканием на себя в службе, работающей в сеансе 0, и записать звук из всех пользовательских сеансов, а также воспроизвести звук из сеанса 0.

Удаленный рабочий стол позволяет перенаправлять звук на клиент. Это реализуется путем создания новых звуковых устройств, которые отображаются только для этого сеанса.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Управление потоками](stream-management.md)
</dt> </dl>

 

 



