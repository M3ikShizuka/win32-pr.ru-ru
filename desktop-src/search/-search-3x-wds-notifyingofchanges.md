---
description: С помощью компонентов API уведомления можно уведомлять индексатор о том, что элемент был изменен, перемещен или удален, и может добавлять области поиска в очередь URL-адресов индексатора поиска Windows, для которых требуется индексирование.
ms.assetid: 817550e2-a256-48d5-9fa6-1ea04f8b8589
title: Уведомление индекса изменений (Поиск Windows)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f5a89112da20c4010e1fc23fab16778309195d20
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104144179"
---
# <a name="notifying-the-index-of-changes-windows-search"></a>Уведомление индекса изменений (Поиск Windows)

С помощью компонентов API уведомления можно уведомлять индексатор о том, что элемент был изменен, перемещен или удален, и может добавлять области поиска в очередь URL-адресов индексатора поиска Windows, для которых требуется индексирование.

Компоненты могут уведомлять индексатор службы поиска Windows об изменении данных в их хранилище. Как правило, можно полагаться на запланированные обходные сканирование индексатора. Однако предоставление уведомлений индексатору может повысить производительность, гарантируя, что индексатор не будет выполнять сканирование всего хранилища по добавочным индексам. Например, это может быть рекомендовано, если вы ожидаете, что хранилище данных будет очень большим и/или сильно загруженным, например хранилищем данных электронной почты, например.

-   [Реализация уведомлений, управляемых индексатором](#implementing-indexer-managed-notifications)
    -   [Очередь уведомлений](#notifications-queue)
    -   [исеарчперсистентитемсчанжедсинк](#isearchpersistentitemschangedsink)
-   [Реализация уведомлений, управляемых поставщиком](#implementing-provider-managed-notifications)
    -   [Очередь уведомлений](#notifications-queue)
    -   [исеарчитемсчанжедсинк](#isearchitemschangedsink)
    -   [исеарчнотифинлинесите](#isearchnotifyinlinesite)
-   [Дополнительные ресурсы](#additional-resources)
-   [См. также](#related-topics)

## <a name="implementing-indexer-managed-notifications"></a>Реализация уведомлений, управляемых индексатором

Уведомления, управляемые индексатором, позволяют управлять доступом к хранилищу данных, в то же время освобождая очередь уведомлений в течение всего процесса индексирования. Поставщик уведомлений должен отслеживать изменения в хранилище данных и создавать очередь уведомлений. Периодически поставщик отправляет пакет уведомлений об изменениях в индексатор. Когда индексатор получает уведомления, он возвращает подтверждение, и вы можете удалить элементы из очереди. Если по истечении определенного периода времени вы не получаете подтверждение, вы можете повторно отправить уведомления. В случае сбоя индексатор перестраивает внутреннюю очередь элементов для сканирования или выполняет добавочное сканирование хранилища.

Для реализации уведомлений, управляемых индексатором, необходимо реализовать следующее:

-   Механизм мониторинга изменений в хранилище данных.
-   Структура данных для постановки в очередь информации (несколько структур [**\_ \_ постоянных \_ изменений элементов поиска**](/windows/desktop/api/Searchapi/ns-searchapi-search_item_persistent_change) ) об этих изменениях.
-   Интерфейс [**исеарчперсистентитемсчанжедсинк**](/windows/desktop/api/Searchapi/nn-searchapi-isearchpersistentitemschangedsink) для отправки уведомлений в индексатор и получения подтверждений уведомлений от индексатора.

### <a name="notifications-queue"></a>Очередь уведомлений

Для отправки в индексатор в качестве уведомления необходимо отслеживать и ставить в очередь все изменения в хранилище данных. Количество уведомлений, которые вы помещаете в очередь и как часто их отправляют в индексатор, зависит от вашего обстоятельств. Возможно, вы отправляете пакет уведомлений для каждых *n* изменений или после некоторого интервала времени *t* или сочетание двух.

Индексатор предполагает, что уведомления поступают в массив [**\_ \_ сохраненных структур \_ изменений элемента поиска**](/windows/desktop/api/Searchapi/ns-searchapi-search_item_persistent_change) , поэтому вы можете выбрать подобную реализацию очереди.

### <a name="isearchpersistentitemschangedsink"></a>исеарчперсистентитемсчанжедсинк

Для доступа к этому интерфейсу сначала создается объект [**исеарчманажер**](/windows/desktop/api/Searchapi/nn-searchapi-isearchmanager) для получения доступа к объекту [**исеарчкаталогманажер**](/windows/desktop/api/Searchapi/nn-searchapi-isearchcatalogmanager) . Из этого объекта **исеарчкаталогманажер** создается экземпляр объекта [**исеарчперсистентитемсчанжедсинк**](/windows/desktop/api/Searchapi/nn-searchapi-isearchpersistentitemschangedsink) и уведомляется об изменении индексатора данных с помощью вызова метода **онитемсчанжед** .

При вызове этого метода вы включаете число сообщаемых изменений и массив [**\_ \_ сохраненных структур \_ изменений элемента поиска**](/windows/desktop/api/Searchapi/ns-searchapi-search_item_persistent_change) . Вы получаете массив кодов завершения HR, указывающий, был ли каждый URL-адрес принят для индексирования. Это подтверждение от индексатора.

## <a name="implementing-provider-managed-notifications"></a>Реализация уведомлений, управляемых поставщиком

Уведомления, управляемые поставщиком, позволяют управлять доступом к хранилищу данных и отслеживать ход работы индексатора при обновлении каталога Windows Search. Поставщик должен отслеживать изменения в хранилище данных и создавать очередь уведомлений. Периодически поставщик отправляет пакет уведомлений об изменениях в индексатор. Когда индексатор получает уведомления, он возвращает подтверждение. Если по истечении определенного периода времени вы не получаете подтверждение, вы можете повторно отправить уведомления. Когда индексатор выполняет сканирование хранилища данных и обновляет каталог Windows Search, он уведомляет поставщика о каждом обновлении каталога и вы можете удалить эти элементы из очереди. Ваш поставщик хранит свою очередь уведомлений на протяжении всего процесса, поэтому в случае сбоя можно повторно отправить уведомления индексатору.

Чтобы реализовать управляемые поставщиком уведомления, необходимо реализовать следующее:

-   Механизм мониторинга изменений в хранилище данных.
-   Структура данных для постановки в очередь информации (нескольких структур [**\_ \_ изменения элементов поиска**](/windows/desktop/api/Searchapi/ns-searchapi-search_item_change) ) об этих изменениях.
-   Интерфейс [**исеарчитемсчанжедсинк**](/windows/desktop/api/Searchapi/nn-searchapi-isearchitemschangedsink) для отправки уведомлений в индексатор и получения подтверждений уведомлений от индексатора.
-   Интерфейс [**исеарчнотифинлинесите**](/windows/desktop/api/Searchapi/nn-searchapi-isearchnotifyinlinesite) для получения обновлений о состоянии индексирования.

### <a name="notifications-queue"></a>Очередь уведомлений

Для отправки в индексатор в качестве уведомления необходимо отслеживать и ставить в очередь все изменения в хранилище данных. Количество уведомлений, которые вы помещаете в очередь и как часто их отправляют в индексатор, зависит от вашего обстоятельств. Возможно, вы отправляете пакет уведомлений для каждых *n* изменений или после некоторого интервала времени *t* или сочетание двух.

Индексатор предполагает, что уведомления поступают в массив структур [**\_ \_ изменения элементов поиска**](/windows/desktop/api/Searchapi/ns-searchapi-search_item_change) , поэтому вы можете сохранить информацию об изменениях аналогичным образом. Однако также необходимо иметь возможность сопоставлять уведомления, которые вы отправляете, с подтверждениями и обновлениями, возвращаемыми индексатором. Также может потребоваться определить, сколько времени требуется для получения подтверждений, чтобы вы могли решить, следует ли повторно отправлять уведомления.

### <a name="isearchitemschangedsink"></a>исеарчитемсчанжедсинк

Для доступа к этому интерфейсу сначала создается объект [**исеарчманажер**](/windows/desktop/api/Searchapi/nn-searchapi-isearchmanager) для получения доступа к объекту [**исеарчкаталогманажер**](/windows/desktop/api/Searchapi/nn-searchapi-isearchcatalogmanager) . Из этого объекта **исеарчкаталогманажер** создается экземпляр объекта [**исеарчитемсчанжедсинк**](/windows/desktop/api/Searchapi/nn-searchapi-isearchitemschangedsink) и уведомляется об изменении индексатора данных с помощью вызова метода **онитемсчанжед** .

В вызове этого метода вы включаете число сообщаемых изменений и массив структур [**\_ \_ изменения элементов поиска**](/windows/desktop/api/Searchapi/ns-searchapi-search_item_change) . Вы получаете массив назначенных индексаторами ДоЦидс, которые представляют каждое изменение, а также массив кодов завершения HR, указывающих, был ли каждый URL-адрес принят для индексирования. Это подтверждение от индексатора, который получил ваши уведомления, и готовится к индексированию элементов.

С этого момента индексатор отправляет обновления с помощью интерфейса [**исеарчнотифинлинесите**](/windows/desktop/api/Searchapi/nn-searchapi-isearchnotifyinlinesite) .

### <a name="isearchnotifyinlinesite"></a>исеарчнотифинлинесите

Чтобы получать обновления о состоянии элементов и каталога, необходимо зарегистрировать интерфейс [**исеарчнотифинлинесите**](/windows/desktop/api/Searchapi/nn-searchapi-isearchnotifyinlinesite) с помощью индексатора, чтобы он мог отправить ответные вызовы. Каждое обновление, отправленное с помощью [**исеарчнотифинлинесите:: онитеминдекседстатусчанже**](/windows/desktop/api/Searchapi/nf-searchapi-isearchnotifyinlinesite-onitemindexedstatuschange) , определяет элементы по DocId, состояние каждого элемента [**( \_ \_ \_ Состояние индексирования элемента поиска**](/windows/desktop/api/Searchapi/ns-searchapi-search_item_indexing_status)) и фазу индексирования ([**\_ \_ этап индексирования поиска**](/windows/desktop/api/Searchapi/ne-searchapi-search_indexing_phase)), в которых находятся элементы.

Не только вы получаете обновления состояния каждого элемента, как описано выше, также получаете важные сведения о состоянии самого каталога. Служба Windows Search может быть прервана или перезапущена конечным пользователем, сторонним приложением или другим сбоем. В этом случае вам нужен способ определить, какие уведомления следует отправить в индексатор.

Метод [**исеарчнотифинлинесите:: онкаталогстатусчанже**](/windows/desktop/api/Searchapi/nf-searchapi-isearchnotifyinlinesite-oncatalogstatuschange) , вызываемый службой поиска Windows, информирует клиентов о состоянии каталога, используя параметры, описанные в следующей таблице.



| Параметр                 | Описание                                                                                                                                           |
|---------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------|
| гуидкаталогресетсигнатуре | Идентификатор GUID, представляющий Сброс каталога. При изменении этого идентификатора GUID необходимо повторно отправить все уведомления.                                                        |
| гуидчеккпоинтсигнатуре   | Идентификатор GUID, представляющий последнюю восстановленную контрольную точку. При изменении этого идентификатора GUID все уведомления, накопленные с момента последней сохраненной контрольной точки, должны быть повторно отправлены. |
| двластчеккпоинтнумбер    | Число, указывающее последнюю сохраненную контрольную точку.                                                                                                        |



 

 

При возникновении контрольной точки каталога Служба поиска обновляет *двластчеккпоинтнумбер*, а все уведомления, отправленные до этой контрольной точки, являются надежными и восстанавливаемыми в случае сбоя службы. Поставщики уведомлений должны отслеживании только тех уведомлений, которые передаются между контрольными точками и принудительной отправкой при восстановлении или сбросе каталога.

Если выполняется восстановление каталога, служба поиска выполняет откат каталога к последней сохраненной контрольной точке и обновляет *гуидчеккпоинтсигнатуре*. В этом случае поставщики уведомлений должны переотправить все уведомления, накопленные с момента последней сохраненной контрольной точки, как определено в *двластчеккпоинтнумбер*.

Если должен произойти Сброс каталога, служба поиска сбрасывает весь каталог и обновляет *гуидкаталогресетсигнатуре*. Поставщик уведомлений должен снова отправить всю область сканирования.

## <a name="additional-resources"></a>Дополнительные ресурсы

-   Общие сведения о процессе индексирования см. [в разделе процесс индексирования](-search-indexing-process-overview.md).
-   Обзоры диспетчера каталога и диспетчера поиска в каталоге (CSM) см. в разделе [Использование диспетчера каталогов](-search-3x-wds-mngidx-catalog-manager.md) и [диспетчера области сканирования](-search-3x-wds-extidx-csm.md).
-   Сведения о создании хранилища данных оболочки см. в разделе [реализация базовых интерфейсов объекта папки](/previous-versions/windows/desktop/legacy/cc144093(v=vs.85)).

## <a name="related-topics"></a>См. также

<dl> <dt>

**Зрения**
</dt> <dt>

[Разработка обработчиков протоколов](-search-3x-wds-phaddins.md)
</dt> <dt>

[Основные сведения о обработчиках протоколов](-search-3x-wds-extidx-prot-implementing.md)
</dt> <dt>

[Добавление значков и контекстных меню](-search-3x-wds-ph-ui-extensions.md)
</dt> <dt>

[Пример кода: расширения оболочки для обработчиков протоколов](-search-3x-wds-ph-ui-samplecode.md)
</dt> <dt>

[Установка и регистрация обработчиков протоколов](-search-3x-wds-ph-install-registration.md)
</dt> <dt>

[Создание соединителя поиска для обработчика протокола](-search-3x-wds-ph-search-connector.md)
</dt> <dt>

[Обработчики протокола отладки](-search-ws-protocolhandlertesting.md)
</dt> </dl>

 

 
