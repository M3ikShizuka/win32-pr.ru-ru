---
description: В этом разделе описаны три этапа процесса индексирования и основные компоненты, участвующие в каждом из них, объясняется время индексирования, а также приводятся некоторые замечания для сторонних разработчиков, которые хотят индексировать свои хранилища данных или форматы файлов.
ms.assetid: cfba12eb-4123-4b57-8311-d4fc8f9f514e
title: Процесс индексирования в Windows Search
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 87867d5925cd53b237092435bbc9d16428418b4f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103808951"
---
# <a name="indexing-process-in-windows-search"></a>Процесс индексирования в Windows Search

В этом разделе описаны три этапа процесса индексирования и основные компоненты, участвующие в каждом из них, объясняется время индексирования, а также приводятся некоторые замечания для сторонних разработчиков, которые хотят индексировать свои хранилища данных или форматы файлов.

Этот раздел организован следующим образом:

- [Обзор](#overview)
- [Этап 1. URL-адреса очереди для индексирования](#stage-1-queuing-urls-for-indexing)
- [Этап 2. обход URL-адресов](#stage-2-crawling-urls)
- [Этап 3. обновление индекса](#stage-3-updating-the-index)
- [Как запланировано индексирование](#how-indexing-is-scheduled)
- [Примечания для тех, кто реализует этот метод](#notes-to-implementers)
- [См. также](#related-topics)

## <a name="overview"></a>Обзор

Поиск Windows поддерживает индексирование свойств и содержимого из файлов различных форматов, таких как формат doc или JPEG, и хранилищ данных, таких как файловая система или почтовые ящики Windows Outlook. Существует два типа индексов: индексы значений, позволяющие выполнять фильтрацию и сортировку по всему значению свойства и инвертированных индексов, которые индексируют слова в текстовых свойствах или содержимом. Если у вас есть пользовательский формат файла или хранилище данных, необходимо понять, как индексы Windows Search будут правильно индексировать элементы.

Процесс индексирования выполняется в три этапа, управляемого компонентом поиска Windows, который называется средством сбора данных. На первом этапе средство сбора данных добавляет URL-адреса в очереди. URL-адреса определяют Индексируемые элементы, а очереди являются просто приоритетными списками URL-адресов. На втором этапе средство сбора данных координирует другие компоненты поиска Windows и сторонних компонентов для доступа к элементам и сбора данных о них. Наконец, на третьем этапе собранные данные добавляются в индекс.

На следующей схеме показаны основные компоненты и поток данных с помощью процесса индексирования. Количество компонентов, участвующих в сборе данных для индекса. Некоторые из них являются частью службы поиска Windows, и некоторые из них поступают из сторонних приложений. Если у вас есть пользовательское хранилище данных или файловый формат, Поиск Windows полагается на обработчик протокола и отфильтрует доступ к URL-адресам и порождает свойства для индексирования. Компоненты Windows Search отображаются синим цветом, а сторонние — зеленым.

![Диаграмма, демонстрирующая взаимодействие между компонентами во время процесса индексирования](images/indexingcompoverview.jpg)

## <a name="stage-1-queuing-urls-for-indexing"></a>Этап 1. URL-адреса очереди для индексирования

На первом этапе индексирования сборщик собирает сведения об обновлениях в хранилищах данных, сравнивает эти сведения с известной областью сканирования, а затем создает очередь URL-адресов для прохода по сбору данных для индекса. Для источников, которые не основаны на уведомлениях, таких как диски FAT, сборщик периодически инициирует полный обход области сканирования, чтобы данные в индексе сохранялись в актуальном состоянии. Для таких источников, как NTFS, существует только один обход содержимого, и все остальное обрабатывается уведомлениями из [журнала изменений USN](/windows/desktop/FileIO/change-journals). Сканирование Microsoft Outlook также отсутствует. На следующей схеме показано высокоуровневое представление процесса очереди для индексирования без обхода содержимого.

![Схема, демонстрирующая процесс запроса для индексирования без обхода содержимого](images/queuingurls.jpg)

В оставшейся части этого раздела объясняется, как система поиска Windows определяет, какие URL-адреса следует обойти, и определяет некоторые важные термины.

**Область обхода содержимого**  Область обхода содержимого — это набор URL-адресов, с помощью которых Поиск Windows осуществляет сбор данных о элементах, которые пользователь желает проиндексировать для ускорения поиска. Поиск Windows добавляет некоторые URL-адреса в область обхода содержимого по умолчанию, например пути к папкам **Documents** и **Pictures** пользователя. Другие URL-адреса могут добавляться приложениями сторонних разработчиков, пользователями и групповая политика. Наконец, пользователи и групповая политика могут явно исключать URL-адреса. Windows Search принимает все добавленные URL-адреса и удаляет исключенные URL-адреса для определения области обхода. Это рабочий набор URL-адресов, из которого сборщик начинает работу.

**Средство сбора данных**  Средство сбора данных — это компонент Windows Search, который собирает сведения об URL-адресах в области сканирования и создает очередь URL-адресов для обхода содержимого индексатора. При добавлении, удалении или обновлении элемента в области обхода сборщик получает уведомление от поставщика уведомлений хранилища данных. Выполняется первоначальное сканирование, при котором средство сбора данных запускается в корне области обхода содержимого. URL-адрес передается обработчику протокола, а затем — соответствующему [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter). Фильтр обычно является перечислением каталогов, которое создает больше URL-адресов. Уведомления являются устойчивым состоянием. Как правило, каждое хранилище данных имеет собственный обработчик протокола, который предоставляет эти уведомления. Например, в локальной файловой системе [Журнал изменений USN](/windows/desktop/FileIO/change-journals) выступает в качестве поставщика уведомлений для всех URL-адресов в протоколе file://. Аналогичным образом Microsoft Outlook выступает в качестве поставщика уведомлений для всех URL-адресов в протоколе mapi://. Когда пользователь получает, перемещает или удаляет сообщение электронной почты, Outlook уведомляет средство сбора о измененном состоянии сообщения. Из этих уведомлений сборщик создает очереди индексации URL-адресов для обхода.

**Индексирование очередей**  Очереди индексирования представляют собой списки URL-адресов, которые определяют элементы, которые необходимо индексировать или повторно индексировать. Сборщик сравнивает URL-адреса, получаемые от поставщиков уведомлений, с URL-адресами в области обхода. Каждый URL-адрес от поставщиков уведомлений, которые попадают в область сканирования, добавляется в очередь, которую средство сбора данных использует для определения приоритета обработки следующих URL-адресов.

Существует три очереди: уведомления с высоким приоритетом, обычные уведомления и периодическое сканирование. Очередь с высоким приоритетом предназначена для уведомлений, которые должны обрабатываться немедленно. Например, когда пользователь изменяет свойство заголовка элемента в проводнике Windows, необходимо немедленно обновить представление проводника Windows после изменения. Обычная очередь уведомлений — для всех оставшихся уведомлений об изменениях. Очереди уведомлений обрабатываются перед очередью сканирования, так как измененные элементы, скорее всего, будут интересны пользователю. Средство сбора данных обращается к данным для URL-адресов в каждой очереди в порядке поступления (FIFO).

Дополнительные сведения о приоритетах и API-интерфейсах событий, появившихся в Windows 7, см. [в разделе индексирование определения приоритетов и событий набора строк в Windows 7](indexing-prioritization-and-rowset-events.md). Дополнительные сведения об управлении областью обхода и уведомлениях см. в разделе [предоставление уведомлений об изменениях](-search-3x-wds-notifyingofchanges.md) и [Использование диспетчера области сканирования](-search-3x-wds-extidx-csm.md).

## <a name="stage-2-crawling-urls"></a>Этап 2. обход URL-адресов

На втором этапе индексирования сборщик выполняет обход содержимого очередей, доступ к хранилищам данных и получение потоков элементов. Сначала сборщик находит соответствующий обработчик протокола для каждого URL-адреса. Затем средство сбора данных передает URL-адрес обработчику протокола. Обработчик протокола обращается к элементу и передает метаданные элементов обратно средству сбора данных. Средство сбора данных использует метаданные для указания правильного фильтра.

На следующей схеме показано высокоуровневое представление процесса обхода URL-адресов. Этот этап включает в себя значительное координирование и обмен данными между компонентами.

![Схема, показывающая процесс обхода URL-адресов и доступа к элементам](images/crawlingqueues.jpg)

В оставшейся части этого раздела описывается, как поиск Windows обращается к элементам для индексирования и объясняются роли каждого задействованного компонента.

**Средство сбора данных**  На этапе 2 этап обхода, сборщик обрабатывает URL-адреса в очередях, начиная с очереди с высоким приоритетом. Каждый URL-адрес проверяется для обнаружения его протокола. Затем средство сбора данных ищет обработчик протокола, зарегистрированный для этого протокола, и создает его экземпляр в хостном процессе протокола поиска.

**Узел протокола поиска**  Узел протокола поиска — это просто упакованный хост-процесс для обработчиков протоколов. Как правило, служба поиска Windows создает два таких процесса размещения, один из которых выполняется в контексте безопасности системы и один, который выполняется в контексте безопасности пользователя. Это разделение гарантирует, что данные, относящиеся к пользователю, никогда не запускаются в системном контексте.

Поиск Windows также использует хост-процесс для изоляции экземпляра обработчика протокола от других процессов или приложений. Таким образом, ни одно из внешних приложений не сможет получить доступ к конкретному экземпляру обработчика протокола, а в случае непредвиденного сбоя обработчика протокола это повлияет только на процесс индексирования. Поскольку хост-процесс выполняет сторонний код (обработчики протоколов), служба поиска Windows периодически перезапускает процесс, чтобы максимально сокращать время, в течение которого атака будет использована для использования информации в процессе. Кроме того, узел протокола поиска не влияет на обход содержимого URL-адресов или индексации элементов.

**Обработчики протоколов**  Обработчики протоколов предоставляют доступ к элементам в хранилище данных с помощью протокола хранилища данных. Например, обработчик протокола NTFS предоставляет доступ к файлам на локальном диске с помощью протокола file://. Обработчик протокола знает, как перемещаться по хранилищу данных, обнаруживать новые или обновленные элементы и уведомлять средство сбора данных. Затем, когда начинается обход содержимого, обработчик протокола предоставляет объект [**иурлакцессор**](/windows/desktop/api/Searchapi/nn-searchapi-iurlaccessor) для привязки к базовому потоку элемента и возвращает метаданные элемента, такие как ограничения безопасности и время последнего изменения.

> [!NOTE]  
> Обработчики протоколов не являются компонентами Windows Search. они являются компонентами конкретного протокола и хранилища данных, для доступа к которым они предназначены. Если у вас есть пользовательское хранилище данных, для которого требуется индексирование, необходимо реализовать обработчик протокола. Дополнительные сведения о обработчиках протоколов и о том, как его реализовать, см. в разделе [Разработка обработчиков протоколов](-search-3x-wds-phaddins.md).

**Метаданные и поток**  С помощью метаданных, возвращаемых объектом [**иурлакцессор**](/windows/desktop/api/Searchapi/nn-searchapi-iurlaccessor) обработчика протокола, сборщик определяет правильный фильтр для URL-адреса. Средство сбора данных анализирует расширение имени файла элемента и ищет фильтр, зарегистрированный для этого расширения. Если сборщику не удается найти фильтр, Windows Search использует метаданные для получения минимального набора сведений о системных свойствах (например, System. ItemName) и обновляет индекс. В противном случае, если сборщик обнаруживает фильтр, начинается третья стадия индексирования.

## <a name="stage-3-updating-the-index"></a>Этап 3. обновление индекса

На третьем этапе индексирования сборщик создает правильный фильтр для URL-адреса и инициализирует фильтр с потоком из объекта [**иурлакцессор**](/windows/desktop/api/Searchapi/nn-searchapi-iurlaccessor) . Затем фильтр обращается к элементу и возвращает содержимое для индекса. При наличии пользовательского формата файла Поиск Windows использует фильтр для доступа к URL-адресам и отправки содержимого и свойств для индексирования.

На следующей схеме показано высокоуровневое представление процесса доступа к данным. Этот этап включает в себя значительное координирование и обмен данными между компонентами.

![Диаграмма, показывающая данные элементов, отправленные для индекса](images/filteringdata.jpg)

В оставшейся части этого раздела описывается, как Windows Search обращается к данным элемента для индексирования и объясняет роли каждого задействованного компонента.

**Средство сбора данных**  В начале этого этапа роль сборщика состоит в создании экземпляра правильного фильтра для элемента и передаче его потоку элементов. В конце этого этапа средство сбора данных принимает содержимое и свойства, созданные фильтром и обработчиком свойств, и обновляет индекс.

**Узел фильтра**  Узел фильтра — это просто ведущий процесс для фильтров и обработчиков свойств, которые служат целью, похожей на узел протокола поиска. Ведущий процесс изолирует фильтры и обработчики свойств от остальной части системы на наличие одинаковых соображений безопасности и стабильности, по которым хостовые процессы протокола поиска изолируют обработчики протоколов. Ведущий процесс выполняется с минимальными правами (он не может получить доступ к файловой системе) и иногда перезапускается для защиты от атак безопасности. Поиск Windows также отслеживает использование ресурсов, так что если фильтр использует слишком много ресурсов, ведущий процесс перезапускается.

**Фильтры**  Фильтры являются критически важными компонентами в процессе индексирования, которые выдают сведения об элементе для средства сбора данных. Имена фильтров задаются после основного интерфейса, используемого в их реализации, интерфейсе [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) и, следовательно, иногда называются фильтрами IFilter. Существует два вида фильтров: один, который взаимодействует с отдельными элементами, такими как файлы, и другой, взаимодействующий с контейнерами, такими как папки. Оба предоставляют данные для индекса.

С помощью метаданных, возвращенных объектом [**иурлакцессор**](/windows/desktop/api/Searchapi/nn-searchapi-iurlaccessor) обработчика протокола, сборщик определяет правильный фильтр для конкретного URL-адреса и передает его в поток. Сборщик определяет правильный фильтр либо с помощью обработчика протокола, либо с помощью расширения имени файла, типа MIME или идентификатора класса (CLSID). Если URL-адрес указывает на контейнер, фильтр выдает свойства для контейнера и перечисляет элементы в контейнере (дочерние URL-адреса). Если URL-адрес указывает на элемент, фильтр возвращает текстовое содержимое, если такое считывание свойств и более сложное, чем обработчики свойств. Обычно рекомендуется, чтобы фильтры выдавали содержимое элемента, а обработчики свойств создавали свойства элемента. Однако если фильтр должен работать с более старыми приложениями, которые не распознают обработчики свойств, можно реализовать фильтр, который также будет выдавать свойства.

> [!NOTE]  
> Фильтры не являются компонентами Windows Search. они представляют собой компоненты, связанные с конкретным форматом файлов или контейнером, к которому они относятся. Дополнительные сведения о фильтрах и о том, как реализовать его для пользовательского формата файла или контейнера, см. в разделе рекомендации [по созданию обработчиков фильтров в Windows Search](-search-3x-wds-extidx-filters.md).

В следующей таблице перечислены результаты, получаемые средством сбора данных фильтром ([**IFilter**](/windows/win32/api/filter/nn-filter-ifilter)) и обработчиком свойств ([**ипропертисторе**](/windows/win32/api/propsys/nn-propsys-ipropertystore)) в процессе индексирования.

|                            | [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) | [**ипропертисторе**](/windows/win32/api/propsys/nn-propsys-ipropertystore) |
|----------------------------|------------------------------------|-------------------------------------------------|
| Разрешить запись                | Нет                                 | Да                                             |
| Смешение содержимого и свойств | Да                                | Нет                                              |
| Многоязычных               | Да                                | Нет                                              |
| Выдавать ссылки                 | Да                                | Нет                                              |
| MIME                       | Да                                | Нет                                              |
| Границы текста            | Предложение, абзац, глава       | Нет                                            |
| Клиент/сервер            | Оба                               | Клиент                                          |
| Реализация             | Complex                            | Простота                                          |

**Обработчики свойств**  Обработчики свойств — это компоненты, которые считывают и записывают свойства определенного формата файлов. Они обращаются к элементам и выдают свойства для средства сбора данных так же, как и фильтры для содержимого. Обработчики свойств проще реализовать, чем фильтры. Если текстовый формат файла очень простой или файлы должны быть очень маленькими, обработчик свойств может создавать и свойства, и содержимое.

> [!NOTE]  
> Обработчики свойств не являются компонентами Windows Search. они представляют собой компоненты, связанные с конкретным форматом файлов, для доступа к которым они предназначены. Дополнительные сведения о обработчиках свойств и о том, как реализовать его для пользовательского формата файла, см. в разделе [Разработка обработчиков свойств для поиска Windows](-search-3x-wds-extidx-propertyhandlers.md).

**Свойства** Windows Search предоставляет [систему свойств](https://msdn.microsoft.com/library/bb763010(VS.85).aspx) , которая включает в себя большую библиотеку свойств. Любое свойство может присутствовать в любом элементе, как определено фильтром или обработчиком свойств. При наличии пользовательского формата файла можно сопоставлять свойства формата файла с этими системными свойствами, а также создавать новые пользовательские свойства. Когда обработчик фильтра или свойства порождает эти свойства, сборщик обновляет индекс, чтобы пользователи могли выполнять поиск с помощью своих свойств. Дополнительные сведения о создании и регистрации пользовательских свойств для формата файла см. в разделе [система свойств](../properties/building-property-handlers.md).

**Системиндекс**  Индекс, именуемый Системиндекс, хранит индексированные данные и состоит из хранилища свойств и индексов по свойствам и содержимому для свойств элемента и инвертированному индексу для текстового содержимого и свойств. После того как средство сбора данных обновит индекс, его можно запросить с помощью поиска Windows и других приложений. Дополнительные сведения о способах запроса индекса см. в статье [программное выполнение запросов к индексу](-search-3x-wds-qryidx-overview.md).

> [!NOTE]  
> Помните, что при повторной регистрации схемы изменения, внесенные в атрибуты ранее определенных свойств, могут не рассматриваться в качестве индексатора. Решением может быть перестроение индекса или появление новых свойств, отражающих изменения вместо обновления старых (не рекомендуется). Дополнительные сведения см. в разделе [Примечание для разработчиков](#notes-to-implementers) в статье [Общие сведения о системе свойств](../properties/property-system-overview.md).

## <a name="how-indexing-is-scheduled"></a>Как запланировано индексирование

При первой установке службы поиска Windows она выполняет полную индексацию области сканирования, приостанавливаясь в периоды высокого ввода-вывода и активности пользователей. Область обхода по умолчанию состоит из расположений библиотеки по умолчанию, таких как **документы**, **музыка**, **изображения** и **видео**. Уведомления обрабатываются даже до завершения первоначального сканирования. Иногда средство сбора данных обходит URL-адреса из области полного сканирования. Эти полные обходные данные гарантируют актуальность данных в индексе. Например, если поставщик уведомлений не может отправлять уведомления или служба Windows Search неожиданно завершает работу, средство сбора данных не будет иметь знания о новых или измененных элементах и не будет индексировать эти элементы. Существует два типа источников: только уведомления и уведомления включены. В обоих источниках сборщик сначала обходит индекс. После первоначального сканирования источники, предназначенные только для уведомлений, никогда не будут выполнять полное сканирование, пока не произойдет сбой, например [Журнал изменений USN](/windows/desktop/FileIO/change-journals) . Источники с поддержкой уведомлений выполняют добавочное сканирование при запуске индексатора, но затем прослушивают уведомления во время выполнения. NTFS и Microsoft Outlook являются только уведомлениями. В Internet Explorer и FAT включены уведомления.

## <a name="notes-to-implementers"></a>Примечания для тех, кто реализует этот метод

Качество данных в индексе и эффективность процесса индексирования зависят практически от реализации фильтра и обработчика свойств. Поскольку фильтр вызывается каждый раз, когда URL-адрес определяет формат файла, процесс индексирования может сильно замедлиться, если фильтр неэффективен. Если обработчик свойств неправильно сопоставляет все свойства файла со свойствами системы или неправильно выдает эти свойства, то данные в индексе будут неправильными, а в дальнейшем поиск этих свойств вернет неверные результаты. В случае сбоя фильтра или обработчика свойств индексатор не сможет индексировать данные.

Приложения и процессы, отличные от поиска Windows, основываются на обработчиках протоколов, фильтрах и обработчиках свойств. Ваши реализации могут повлиять на приложения так, как вы, возможно, не планируете. [Руководство по разработке Windows Search](-search-developers-guide-entry-page.md) содержит советы по выбору конструкции и тестированию каждого из этих компонентов.

## <a name="related-topics"></a>См. также

[Индексирование, запросы и уведомления в Windows Search](-search-3x-wds-included-in-index.md)

[Что включено в индекс](-search-indexing-process-overview.md)

[Запрос процесса в Windows Search](querying-process--windows-search-.md)

[Обработка уведомлений в Windows Search](-search-3x-wds-support.md)

[Требования к форматированию URL-адресов](url-formatting-requirements.md)
