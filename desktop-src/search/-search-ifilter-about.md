---
description: Обработчики фильтров, которые являются реализациями интерфейса IFilter, просматривают документы для текста и свойств.
ms.assetid: 2ee9ea19-ae03-4f14-8f06-f8aa670e204e
title: Основные сведения о обработчиках фильтров в поиске Windows
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e49cc1d3e479ae03645665618c60a33bdcfe19ba
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104540719"
---
# <a name="understanding-filter-handlers-in-windows-search"></a>Основные сведения о обработчиках фильтров в поиске Windows

Обработчики фильтров, которые являются реализациями интерфейса [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) , просматривают документы для текста и свойств. Обработчики фильтров извлекают фрагменты текста из этих элементов, отфильтровывая внедренное форматирование и сохраняет информацию о положении текста. Они также извлекают фрагменты значений, которые являются свойствами документа. **IFilter** — это основа для создания приложений более высокого уровня, таких как индексаторы документов и средства просмотра, независимые от приложений.

Этот раздел организован следующим образом:

- [Сведения об интерфейсе IFilter](#about-the-ifilter-interface)
  - [Процесс изоляции](#isolation-process)
  - [Библиотеки DLL IFilter](#ifilter-dlls)
  - [Структура IFilter](#ifilter-structure)
  - [Машинный код](#native-code)
- [Поиск идентификатора класса IFilter](#finding-the-ifilter-class-identifier)
  - [Идентификаторы кода IFilter:: и фрагмента и языкового стандарта](#ifiltergetchunk-and-locale-code-identifiers)
- [Дополнительные ресурсы](#additional-resources)
- [См. также](#related-topics)

## <a name="about-the-ifilter-interface"></a>Сведения об интерфейсе IFilter

Microsoft Windows Search использует фильтры для извлечения содержимого элементов, включаемых в полнотекстовый индекс. Можно расширить поиск Windows для индексации новых или собственных типов файлов, написав фильтры для извлечения содержимого и обработчики свойств для извлечения свойств файлов.

Интерфейс [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) предназначен для удовлетворения конкретных потребностей механизмов полнотекстового поиска. Модули полнотекстового поиска, такие как Windows Search, вызывают методы **IFilter** для извлечения сведений о тексте и свойствах и их добавления в индекс. Поиск Windows прерывает результаты возвращенного метода [**IFilter:: GetText**](/windows/win32/api/filter/nf-filter-ifilter-gettext) в словах, нормализует их и сохраняет в индексе. Если он доступен, поисковая система использует идентификатор языка (LCID) текстового фрагмента для выполнения разбиения и нормализации слов, зависящих от языка.

Для доступа к зарегистрированным обработчикам фильтров (реализациям интерфейса [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) ) в Windows Search используются три функции, описанные в следующей таблице. Эти функции особенно полезны при загрузке и привязке к обработчику фильтра внедренного объекта.

| Функция               | Описание                                                                                                                                                                                               |
|------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| лоадифилтер            | Возвращает указатель на [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) , который наиболее подходит для указанного типа содержимого.                                                                                            |
| биндифилтерфромстораже | Возвращает указатель на [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) , который наиболее подходит для содержимого, содержащегося в объекте [интерфейса IStorage](/windows/win32/api/objidl/nn-objidl-istorage) . |
| биндифилтерфромстреам  | Возвращает указатель на [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) , который наиболее подходит для указанного идентификатора класса (CLSID), полученного из переменной потока.                                                 |

Интерфейс [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) имеет пять методов, описанных в следующей таблице.

| Метод                                                    | Описание                                                                                                        |
|-----------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|
| [**IFilter:: init**](/windows/win32/api/filter/nf-filter-ifilter-init)          | Инициализирует сеанс фильтрации.                                                                                   |
| [**IFilter:: "блок"**](/windows/win32/api/filter/nf-filter-ifilter-getchunk)     | Позиции [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) в начале первого или следующего фрагмента и возвращают дескриптор. |
| [**IFilter:: GetText**](/windows/win32/api/filter/nf-filter-ifilter-gettext)       | Извлекает текст из текущего фрагмента.                                                                             |
| [**IFilter:: GetValue**](/windows/win32/api/filter/nf-filter-ifilter-getvalue)     | Извлекает значения из текущего фрагмента.                                                                           |
| [**IFilter:: Биндрегион**](/windows/win32/api/filter/nf-filter-ifilter-bindregion) | Извлекает интерфейс, представляющий указанную часть объекта. Зарезервировано для последующего использования.                      |

### <a name="isolation-process"></a>Процесс изоляции

Служба поиска Windows запускает фильтры IFilter в контексте безопасности локальной системы с ограниченными правами. В этом процессе изоляции узла [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) удаляется ряд прав:

- Ограниченный код
- Все
- Локальная
- Интерактивно
- Прошедшие проверку пользователи
- Встроенные пользователи
- Идентификатор безопасности (SID) пользователей

Удаление этих прав означает, что интерфейс [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) не имеет доступа к дисковой системе или сети, а также к любым функциям пользовательского интерфейса или буфера обмена. Более того, процесс изоляции выполняется в объекте задания, который предотвращает создание дочерних процессов и накладывает ограничение в 100 МБ на рабочий набор. процесс изоляции узла интерфейса **IFilter** повышает стабильность платформы индексирования из-за возможности неправильно реализованных фильтров сторонних производителей.

> [!NOTE]  
> Обработчики фильтров должны быть написаны для управления буферами и правильного стека. Все копии строк должны иметь явные проверки для защиты от переполнения буфера. Всегда следует проверять выделенный размер буфера. Всегда следует проверять размер данных в соответствии с размером буфера.

### <a name="ifilter-dlls"></a>Библиотеки DLL IFilter

[**Фильтр IFilter**](/windows/win32/api/filter/nn-filter-ifilter) Библиотеки DLL реализуют интерфейс **IFilter** , чтобы позволить клиенту извлекать данные текста и значений свойств из типа файла, класса или воспринимаемого типа. Процесс фильтрации поиска Windows **SearchFilterHost.exe** привязывается к **IFilter** , зарегистрированному для класса, наблюдаемого типа или расширения имени элемента.

### <a name="ifilter-structure"></a>Структура IFilter

Каждый [**Фильтр IFilter**](/windows/win32/api/filter/nn-filter-ifilter) представляет собой DLL-файл, который реализует ВНУТРИПРОЦЕССНЫЙ сервер COM для предоставления указанных возможностей фильтрации. На следующем рисунке показана общая структура типовых библиотек DLL **IFilter** . Более сложный пример может реализовать более одного класса **IFilter** .

![Схема структуры типичной библиотеки DLL IFilter](images/ifilter-structure.png)

### <a name="native-code"></a>Машинный код

Фильтры должны быть написаны в машинном коде из-за потенциальных проблем с управлением версиями среды CLR при работе нескольких надстроек. В Windows 7 и более поздних версиях фильтры, написанные в управляемом коде, явным образом блокируются.

## <a name="finding-the-ifilter-class-identifier"></a>Поиск идентификатора класса IFilter

Класс DLL-библиотеки [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) регистрируется в разделе реестра персистенсандлер. В следующем примере для HTML-файлов показано, как найти библиотеку DLL **IFilter** для HTML-документа. В этом примере используется логика, аналогичная используемой системой для поиска **IFilter** , связанного с элементом.

1. Проверьте, зарегистрировано ли расширение для типа файлов, зарегистрированных в фильтрах DLL, в записи реестра \\ hKey \_ Local \_ Machine \\ Software \\ Classes. Предоставьте этому ключу `Value1` . Если эта запись уже существует, перейдите к шагу 4 этой процедуры и используйте ее `Value1` в этом разделе. Значения имеют тип REG \_ SZ.

```
    \HKEY_LOCAL_MACHINE
       SOFTWARE
          Classes
             .htm
                PersistentHandler
                   {EEC97550-47A9-11CF-B952-00AA0051FE20}
```

2. Кроме того, если для расширения не зарегистрирован Персистенсандлер, найдите идентификатор CLSID, связанный с типом документа, в записи реестра \\ hKey \_ Local \_ Machine \\ Software \\ Classes. Предоставьте этому ключу `Value2` .

```
    \HKEY_LOCAL_MACHINE
       SOFTWARE
          Classes
             htmlfile
                 = Class for WWW HTML files
                CLSID
                   {25336920-03F9-11CF-8FD0-00AA00686F13}
```

3. Определите, зарегистрирован ли Персистенсандлер для идентификатора CLSID. Используя `Value2` определенную на шаге 2, найдите запись персистенсандлер для \\ \_ \_ \\ классов программного обеспечения для локального компьютера hKey \\ \\ CLSID \\ . Предоставьте этому ключу `Value3` .

```
    \HKEY_LOCAL_MACHINE
       SOFTWARE
          Classes
             htmlfile
                 = Class for WWW HTML files
                PersistentHandler
                   {EEC97550-47A9-11CF-B952-00AA0051FE20}
```

4. Определите GUID постоянного обработчика [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) . Используя `Value1` и `Value3` , найдите идентификатор GUID постоянного обработчика **IFilter** для типа документа. Значение в записи реестра \\ hKey \_ Local \_ Machine \\ Software \\ Classes \\ CLSID \\ значение1 или 3 \\ персистентаддинсрегистеред \\ 89BCB740-6119-101A-BCB7-00DD010655AF "/> дает идентификатор GUID персистенсандлер **IFilter** для этого типа документа. Предоставьте этому ключу `Value4` . В этом примере GUID интерфейса **IFilter** — 89BCB740-6119-101A-BCB7-00DD010655AF.

```
    HKEY_LOCAL_MACHINE
       SOFTWARE
          Classes
             {EEC97550-47A9-11CF-B952-00AA0051FE20}
                 = HTML File Persistent Handler
                    Data type         REG_SZ
                        PersistentAddinsRegistered
                        {89BCB740-6119-101A-BCB7-00DD010655AF}

                    Data type         REG_SZ
                        default = {E0CA5340-4534-11CF-B952-00AA0051FE20}
```

> [!NOTE]  
> В этом примере библиотека DLL [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) для HTML-документов nlhtml.dll.

### <a name="ifiltergetchunk-and-locale-code-identifiers"></a>Идентификаторы кода IFilter:: и фрагмента и языкового стандарта

КОД языка текста может изменяться в пределах одного файла. Например, текст инструкции может переноситься между английским языком (EN-US) и испанскими (ES), а текст может содержать одно слово на языке, отличном от основного. В любом случае [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) должен начинать новый блок каждый раз при изменении кода языка. Поскольку код языка используется для выбора соответствующего средство разбиения по словам, очень важно правильно его определить. Если **IFilter** не может определить языковой стандарт текста, он должен вернуть фрагмент кода, равный нулю. Если значение LCID равно нулю, Поиск Windows будет использовать технологию автоматического определения языка (LAD) для определения идентификатора локали фрагмента. Если поиск не находит совпадений, по умолчанию используется системный язык по умолчанию (путем вызова функции [функции жетсистемдефаултлокаленаме](/windows/win32/api/winnls/nf-winnls-getsystemdefaultlocalename) ). Дополнительные сведения см. в разделе [**IFilter::**](/windows/win32/api/filter/nf-filter-ifilter-getchunk)бреактипе, [**блок \_**](/windows/win32/api/filter/ne-filter-chunk_breaktype), [**чункстате**](/windows/win32/api/filter/ne-filter-chunkstate)и [**stat \_**](/windows/win32/api/filter/ns-filter-stat_chunk).

Если вы управляете форматом файла и в настоящее время он не содержит сведений о языковых стандартах, необходимо добавить функцию пользователя, чтобы обеспечить правильную идентификацию языкового стандарта. Использование несовпадающего средства разбиения по словам может привести к плохому использованию запросов пользователя. Дополнительные сведения см. в разделе [**ивордбреакер**](/windows/desktop/api/Indexsrv/nn-indexsrv-iwordbreaker).

> [!NOTE]  
> Фильтры связаны с типами файлов, как отмечены расширениями имен файлов, типами MIME или идентификаторами CLSID. Хотя один фильтр может работать с несколькими типами файлов, каждый тип работает только с одним фильтром.

## <a name="additional-resources"></a>Дополнительные ресурсы

- Пример кода [ифилтерсампле](-search-sample-ifiltersample.md) , доступный на [GitHub](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/Win7Samples/winui/WindowsSearch/IFilterSample7), демонстрирует создание базового класса IFilter для реализации интерфейса [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) .
- Общие сведения о процессе индексирования см. [в разделе процесс индексирования](-search-indexing-process-overview.md).
- Общие сведения о типах файлов см. в разделе [типы файлов](../shell/fa-file-types.md).
- Сведения о запросе атрибутов сопоставления файлов для типа файлов см. в разделе [перцеиведтипес, системфилеассоЦиатионс и регистрация приложения](/previous-versions/windows/desktop/legacy/cc144150(v=vs.85)).

## <a name="related-topics"></a>См. также

[Разработка обработчиков фильтров](-search-ifilter-conceptual.md)

[Рекомендации по созданию обработчиков фильтров в поиске Windows](-search-3x-wds-extidx-filters.md)

[Возвращение свойств из обработчика фильтра](-search-ifilter-property-filtering.md)

[Обработчики фильтров, поставляемые с Windows](-search-ifilter-implementations.md)

[Реализация обработчиков фильтров в поиске Windows](-search-ifilter-constructing-filters.md)

[Регистрация обработчиков фильтров](-search-ifilter-registering-filters.md)

[Тестирование обработчиков фильтров](-search-ifilter-testing-filters.md)
