---
description: Некоторые приложения хранят свои элементы в базах данных или пользовательских типах файлов.
ms.assetid: 0e2b7b4b-ae87-4092-b924-6191cdf42c9b
title: Основные сведения о обработчиках протоколов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 28c171c5790e47bbf624d9107a5ca5b3dc0b9fd4
ms.sourcegitcommit: d75fc10b9f0825bbe5ce5045c90d4045e3c53243
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2021
ms.locfileid: "127363304"
---
# <a name="understanding-protocol-handlers"></a>Основные сведения о обработчиках протоколов

Некоторые приложения хранят свои элементы в базах данных или пользовательских типах файлов. хотя Windows поиск может индексировать имя и свойства файла, Windows не имеет сведений о содержимом файла. в результате такие элементы нельзя индексировать или предоставлять в оболочке Windows. Создание обработчика протокола позволяет сделать эти элементы доступными для индексирования. Можно также индексировать составной формат файла, например файл .zip.

Этот раздел организован следующим образом:

-   [Индексирование хранилищ данных с помощью обработчиков протоколов](#indexing-data-stores-with-protocol-handlers)
    -   [Хранилища данных оболочки](#shell-data-stores)
    -   [Обработчики протоколов](#protocol-handlers)
    -   [Фильтры и обработчики протоколов](#filters-and-protocol-handlers)
-   [Индексирование формата составного файла](#indexing-a-compound-file-format)
-   [Связанные темы](#related-topics)

## <a name="indexing-data-stores-with-protocol-handlers"></a>Индексирование хранилищ данных с помощью обработчиков протоколов

если пользователям требуется искать устаревшие базы данных, хранилища электронной почты или другие структуры данных, которые не поддерживаются Windows поиска, следует сначала определить, существует ли обработчик протокола для этого хранилища данных, возможно, для использования с другим приложением, например SharePoint Server. В этом случае можно установить обработчик протокола в системе. Windows обработчики протоколов поиска используют спецификации проектирования, аналогичные SharePoint Server. они часто взаимозаменяемы.

дополнительные сведения о развертывании Search Server 2008 с помощью Office SharePoint Server 2007 см. в статье [федеративный поисковый \[ сервер search server 2008 \] ](/previous-versions/office/bb931109(v=office.14)).

### <a name="shell-data-stores"></a>Хранилища данных оболочки

прежде чем сторонние разработчики новых форматов файлов и хранилищ данных смогут получить эти форматы и хранилища в результатах запроса в Windows Explorer, разработчик должен реализовать источник данных оболочки. Источник данных оболочки — это компонент, который используется для расширения пространства имен оболочки и предоставления элементов в хранилище данных. Хранилище данных — это репозиторий данных. Хранилище данных может быть предоставлено модели программирования оболочки в качестве контейнера, использующего источник данных оболочки. элементы в хранилище данных могут индексироваться системой поиска Windows с помощью обработчика протокола. Обработчик протокола реализует протокол для доступа к источнику содержимого в собственном формате. Интерфейсы [**исеарчпротокол**](/windows/desktop/api/Searchapi/nn-searchapi-isearchprotocol) и [**ISearchProtocol2**](/windows/desktop/api/Searchapi/nn-searchapi-isearchprotocol2) используются для реализации пользовательского обработчика протокола, чтобы расширить источники данных, которые могут быть проиндексированы.

если необходимо, чтобы результаты запроса отображались в Windows Explorer, необходимо реализовать источник данных оболочки, прежде чем можно будет создать обработчик протокола для расширения индекса. Однако, если все запросы будут программно (например, в OLE DB) и интерпретироваться кодом приложения, а не оболочкой, пространство имен оболочки, хотя и предпочтительнее, не является обязательным.

> [!Note]  
> Источник данных оболочки иногда называют расширением пространства имен оболочки. Обработчик иногда называют расширением оболочки или обработчиком расширения оболочки.

 

чтобы пользователи могли просматривать результаты поиска в Windows Explorer, необходимо создать обработчик протокола и одну или несколько из следующих надстроек:

-   Обработчик контекстного меню
-   Обработчик значков
-   Другой тип обработчика файлов

список обработчиков, определяемых сценарием разработчика, которые вы пытаетесь получить, см. в разделе "обзор обработчиков" статьи [Windows поиск в качестве платформы разработки](-search-3x-wds-development-ovr.md). Сведения о создании обработчиков см. в разделе [Регистрация расширений оболочки](../shell/reg-shell-exts.md), [контекстного меню](/previous-versions/windows/desktop/legacy/cc144169(v=vs.85))и [обработчиков типов файлов](../shell/fa-file-extensions.md).

### <a name="protocol-handlers"></a>Обработчики протоколов

Если хранилище данных также является контейнером (например, папкой файловой системы), необходимо реализовать фильтр для перечисления URL-адресов в контейнере. если хранилище данных содержит данные или типы файлов, отличные от типов файлов 200, поддерживаемых Windowsным поиском, необходимо реализовать фильтр для доступа к содержимому элементов в хранилище и индексировать его. Windows поиск использует обработчик протокола и технологию [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) , аналогичную той, которая используется сервером SharePoint. если у вас уже есть фильтры для определенного хранилища и типа файлов, установленных в индексируемой системе, Windows поиск может использовать существующие интерфейсы для индексирования этих данных.

Общие сведения о процессе индексирования см. [в разделе процесс индексирования](-search-indexing-process-overview.md). Основные сведения о обработчиках фильтров см. в разделе [Разработка обработчиков фильтров](-search-ifilter-conceptual.md).

### <a name="filters-and-protocol-handlers"></a>Фильтры и обработчики протоколов

обработчики протоколов предоставляют индексатору поиска Windows доступ к хранилищам данных, позволяя индексатору выполнять обход узлов хранилища данных и извлекать соответствующие сведения для индексирования. Windows например, поиск поставляется с обработчиками протоколов для хранилищ файловой системы и для некоторых версий хранилищ данных Microsoft Outlook. при индексировании Outlook электронной почте обработчик протокола выполняет сканирование всех сообщений в наборе Outlook папок и извлекает сведения из каждого сообщения и вложения. эти сведения передаются в индексатор для включения в каталог поиска Windows.

Обзоры диспетчера каталогов и диспетчера области обхода содержимого (CSM) см. в разделе [Использование диспетчера каталогов](-search-3x-wds-mngidx-catalog-manager.md) и [диспетчера области сканирования](-search-3x-wds-extidx-csm.md).

## <a name="indexing-a-compound-file-format"></a>Индексирование формата составного файла

Формат составного файла можно индексировать, чтобы отдельные элементы в файле можно было вернуть в виде отдельных результатов. Формат составного файла, например сжатый файл с расширением .zip File, по сути является хранилищем данных, и его можно рассматривать как таковое для целей индексирования. В следующем примере показан файл .zip в пространстве имен файловой системы (FILE://c:/test/test.zip), в котором есть и вложенные папки, и отдельные элементы.

``` syntax
Test.zip 

    |-folder1 

    |    |-folder2 

    |           |- FileX.txt 

    |- FileY.doc
```

Обработчик протокола FILE обнаруживает, когда FILE://c:/test/test.zip изменения, отслеживая журналы изменений файловой системы, и вызывает [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) , зарегистрированный для .zip файлов в этом файле при изменении файла, но не имеет сведений о внутренней структуре самого файла .zip.

Необходимо сообщить индексатору, что формат составного файла является хранилищем данных. Это необходимо сделать, чтобы отдельные элементы были проиндексированы и извлечены как уникальные сущности. После реализации источника данных оболочки и выполнения следующих действий у вас будет обработчик протокола, который может обрабатывать и предоставлять данные из формата составного файла (файла .zip) как отдельные элементы.

**Чтобы сообщить индексатору, что составной файл является хранилищем данных, сделайте следующее:**

1.  Создайте обработчик протокола (с помощью [**исеарчпротокол**](/windows/desktop/api/Searchapi/nn-searchapi-isearchprotocol) или [**ISearchProtocol2**](/windows/desktop/api/Searchapi/nn-searchapi-isearchprotocol2)) для файлов .zip, имеющих возможность привязки к исходному файлу. Дополнительные сведения см. в разделе [Установка и регистрация обработчиков протоколов](-search-3x-wds-ph-install-registration.md).

    Например, можно использовать экранированный путь к файлу .zip в качестве имени корневой папки, а затем использовать синтаксис иерархии, как любой другой формат файла.

    ``` syntax
    .zip:///escapedPathTo.zipFile/.zipfolder/.../.zipfile
    ```

    Используя приведенный выше образец данных для c: \\ test \\test.zip, уникальные URL-адреса будут выглядеть следующим образом. С этими URL-адресами обработчик протокола имеет сведения, необходимые для привязки к файлу .zip и перечисления дочерних URL-адресов, включая внутренние файлы, чтобы их можно было привязать и индексировать с помощью фильтров .doc и .txt.

    ``` syntax
      

    .zip:///FILE:%2f%2f%2fc:%2ftest%2ftest.zip/ 

    .zip:///FILE:%2f%2f%2fc:%2ftest%2ftest.zip/FileY.Doc 

    .zip:///FILE:%2f%2f%2fc:%2ftest%2ftest.zip/folder1 

    .zip:///FILE:%2f%2f%2fc:%2ftest%2ftest.zip/folder1/folder2 

    .zip:///FILE:%2f%2f%2fc:%2ftest%2ftest.zip/folder1/folder2/FileX.txt
    ```

2.  Убедитесь, что обработчик протокола удовлетворяет следующим двум условиям.
    -   Корневые URL-адреса для файла .zip должны выдавать PKEY \_ Search \_ Исклоседдиректори ([System. Search. Исклоседдиректори](../properties/props-system-search-iscloseddirectory.md)) по URL-адресам, которые являются корневыми URL-адресами файлов .zip. Например, .zip:///филе:% 2F% 2F% 2fc:% 2ftest% 2ftest.zip/должен выдавать Исклоседдиректори = **true**. Это указывает индексатору, что если дата на этом URL-адресе не изменилась, не нужно обрабатывать дочерние URL-адреса.
    -   Каждый дочерний URL-адрес для этого URL-адреса должен выдавать PKEY \_ Search \_ Исфулликонтаинед ([System. Search. исфулликонтаинед](../properties/props-system-search-isfullycontained.md)) в дочерних URL-адресах корневого .zip. Как правило, в конце добавочного сканирования индексатор обрабатывает все Непосещенные URL-адреса как элементы, которые должны быть удалены. Но корневой файл .zip не должен обрабатывать корневые URL-адреса, так как ничего не изменилось. Порождение этого свойства как **true** сообщает индексатору, что если этот URL-адрес не был обработан в конце добавочного сканирования, его не следует удалять. Он будет удален только в том случае, если корневой элемент изменился и он не будет посещен.

Windows Для поиска требуется начальная страница для протокола, чтобы узнать, какие URL-адреса должны выполняться постепенно, и какие URL-адреса следует игнорировать при их обнаружении. Но мы не можем начать с URL-адреса для каждого файла .zip, так как мы не понимаем, где находится каждый файл .zip. Таким образом, URL-адрес начальной страницы обработчика протокола .zip должен иметь возможность перечисления всех элементов в корне экранированных путей всех файлов .zip. Эти файлы .zip не обязательно находятся в пространстве имен FILE: и могут быть URL-адресом типа MAPI, который указывает на файл .zip как вложение, например.

**Чтобы зарегистрировать корневой элемент в качестве начальной страницы, выполните следующие действия.**

1.  Зарегистрируйте корневой элемент, например .zip:///в качестве начальной страницы, чтобы все .zip файлы запускались в силе. при обработке корневого .zip: URL-адрес обработчик протокола должен создать список дочерних url-адресов, которые будут выдаваться запросом Windows поиска всех url-адресов с помощью System. FileExtension = ".zip".
2.  Отмените эти URL-адреса, чтобы удалить косые черты и вернуть их в качестве дочерних URL-адресов. Пример запроса для получения требуемых типов может выглядеть следующим образом.

    ``` syntax
    SELECT system.itemurl, System.DateModified FROM SystemIndex 
    WHERE System.FileExtension='.zip' OR System.MimeType='mimetypefor.zip'
    ```

3.  когда Windowsный поиск периодически выполняет добавочное сканирование url-адреса .zip:///root, необходимо отразить список url-адресов, для которых Windows поиск уже обслуживает url-адреса .zip. Если удаление обнаруживается в собственном хранилище, в котором хранится файл .zip, он не отображается в перечислении, а эта ветвь дерева в .zip удаляется.
4.  Чтобы выполнить привязку к данным .zip для другого обработчика протокола, в идеале следует пропускать [ишеллфолдер](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) для этого URL-адреса, чтобы привязать его к хранилищу объекта, и не считать, что он всегда является файлом. Это обеспечивает гибкость работы с вложениями в хранилищах почты, например.
5.  При выдаче дочерних URL-адресов для каждого .zipного файла следует использовать PKEY \_ Search \_ Урлтоиндексвисмодификатионтиме ([System. Search. урлтоиндексвисмодификатионтиме](../properties/props-system-search-urltoindexwithmodificationtime.md)), чтобы передать PKEY \_ DateModified ([System. DateModified](../properties/props-system-datemodified.md)) фактического файла .zip, чтобы индексатор выполнял сканирование .zip файла только в случае его изменения.

Чтобы .zipные URL-адреса были проиндексированы сразу после создания или изменения, а также не нужно ждать, пока добавочный обход не обнаружит новое состояние, можно наблюдать за .zip файлов. Однако такой подход не будет работать для других хранилищ данных, таких как MAPI.

**Для индексирования .zip URL-адресов при их создании или изменении:**

1.  Создайте фильтр (и реализацию интерфейса [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) ) для типа файла .zip. дополнительные сведения см. в разделе [разработка обработчиков свойств для Windows поиска](-search-3x-wds-extidx-propertyhandlers.md).
2.  При вызове реализации [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) это происходит потому, что этот URL-адрес был обнаружен или изменен. Затем создайте событие для URL-адреса .zip, соответствующего URL-адресу источника, через интерфейс [**игасернотифинлине**](/previous-versions/windows/desktop/legacy/bb231470(v=vs.85)) . Это дает возможность немедленно сообщить индексатору, что новые данные будут индексироваться без ожидания добавочного сканирования.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Разработка обработчиков протоколов](-search-3x-wds-phaddins.md)
</dt> <dt>

[Установка и регистрация обработчиков протоколов](-search-3x-wds-ph-install-registration.md)
</dt> <dt>

[Уведомление индекса изменений](-search-3x-wds-notifyingofchanges.md)
</dt> <dt>

[Добавление значков и контекстных меню](-search-3x-wds-ph-ui-extensions.md)
</dt> <dt>

[Пример кода: расширения оболочки для обработчиков протоколов](-search-3x-wds-ph-ui-samplecode.md)
</dt> <dt>

[Установка и регистрация обработчиков протоколов](-search-3x-wds-ph-install-registration.md)
</dt> <dt>

[Создание соединителя поиска для обработчика протокола](-search-3x-wds-ph-search-connector.md)
</dt> <dt>

[Обработчики протокола отладки](-search-ws-protocolhandlertesting.md)
</dt> </dl>

 

 
