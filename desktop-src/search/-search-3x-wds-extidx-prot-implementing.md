---
description: Некоторые приложения хранят свои элементы в базах данных или пользовательских типах файлов.
ms.assetid: 0e2b7b4b-ae87-4092-b924-6191cdf42c9b
title: Основные сведения о обработчиках протоколов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 28c171c5790e47bbf624d9107a5ca5b3dc0b9fd4
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105701406"
---
# <a name="understanding-protocol-handlers"></a>Основные сведения о обработчиках протоколов

Некоторые приложения хранят свои элементы в базах данных или пользовательских типах файлов. Хотя Windows Search может индексировать имя и свойства файла, Windows не имеет сведений о содержимом файла. В результате такие элементы не могут индексироваться или быть представлены в оболочке Windows. Создание обработчика протокола позволяет сделать эти элементы доступными для индексирования. Кроме того, можно индексировать формат составного файла, например ZIP-файл.

Этот раздел организован следующим образом:

-   [Индексирование хранилищ данных с помощью обработчиков протоколов](#indexing-data-stores-with-protocol-handlers)
    -   [Хранилища данных оболочки](#shell-data-stores)
    -   [Обработчики протоколов](#protocol-handlers)
    -   [Фильтры и обработчики протоколов](#filters-and-protocol-handlers)
-   [Индексирование формата составного файла](#indexing-a-compound-file-format)
-   [См. также](#related-topics)

## <a name="indexing-data-stores-with-protocol-handlers"></a>Индексирование хранилищ данных с помощью обработчиков протоколов

Если пользователям требуется искать устаревшие базы данных, хранилища электронной почты или другие структуры данных, которые не поддерживаются службой поиска Windows, необходимо сначала определить, существует ли обработчик протокола для этого хранилища данных, возможно, для использования с другим приложением, например SharePoint Server. В этом случае можно установить обработчик протокола в системе. Обработчики протоколов поиска Windows используют спецификации проектирования, аналогичные SharePoint Server, и часто взаимозаменяемы.

Дополнительные сведения о развертывании сервера Search Server 2008 с помощью Office SharePoint Server 2007 см. в разделе [федеративный поисковый \[ сервер search Server 2008 \] ](/previous-versions/office/bb931109(v=office.14)).

### <a name="shell-data-stores"></a>Хранилища данных оболочки

Прежде чем сторонние разработчики новых форматов файлов и хранилищ данных смогут получить эти форматы и хранилища в результатах запроса в проводнике Windows, разработчик должен реализовать источник данных оболочки. Источник данных оболочки — это компонент, который используется для расширения пространства имен оболочки и предоставления элементов в хранилище данных. Хранилище данных — это репозиторий данных. Хранилище данных может быть предоставлено модели программирования оболочки в качестве контейнера, использующего источник данных оболочки. Элементы в хранилище данных могут индексироваться системой поиска Windows с помощью обработчика протокола. Обработчик протокола реализует протокол для доступа к источнику содержимого в собственном формате. Интерфейсы [**исеарчпротокол**](/windows/desktop/api/Searchapi/nn-searchapi-isearchprotocol) и [**ISearchProtocol2**](/windows/desktop/api/Searchapi/nn-searchapi-isearchprotocol2) используются для реализации пользовательского обработчика протокола, чтобы расширить источники данных, которые могут быть проиндексированы.

Если требуется, чтобы результаты запроса отображались в проводнике Windows, необходимо реализовать источник данных оболочки, прежде чем можно будет создать обработчик протокола для расширения индекса. Однако, если все запросы будут программно (например, в OLE DB) и интерпретироваться кодом приложения, а не оболочкой, пространство имен оболочки, хотя и предпочтительнее, не является обязательным.

> [!Note]  
> Источник данных оболочки иногда называют расширением пространства имен оболочки. Обработчик иногда называют расширением оболочки или обработчиком расширения оболочки.

 

Если требуется, чтобы пользователи могли просматривать результаты поиска в проводнике Windows, необходимо создать обработчик протокола и одну или несколько из следующих надстроек:

-   Обработчик контекстного меню
-   Обработчик значков
-   Другой тип обработчика файлов

Список обработчиков, определяемых сценарием разработчика, которые вы пытаетесь получить, см. в разделе «Обзор обработчиков» в [Windows Search как платформа разработки](-search-3x-wds-development-ovr.md). Сведения о создании обработчиков см. в разделе [Регистрация расширений оболочки](../shell/reg-shell-exts.md), [контекстного меню](/previous-versions/windows/desktop/legacy/cc144169(v=vs.85))и [обработчиков типов файлов](../shell/fa-file-extensions.md).

### <a name="protocol-handlers"></a>Обработчики протоколов

Если хранилище данных также является контейнером (например, папкой файловой системы), необходимо реализовать фильтр для перечисления URL-адресов в контейнере. Если хранилище данных содержит данные или типы файлов, отличные от одного из типов файлов 200, поддерживаемых службой поиска Windows, необходимо реализовать фильтр для доступа к содержимому элементов в хранилище и индексировать его. В Windows Search используется обработчик протокола и технология [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) , аналогичные тем, что используются сервером SharePoint. Если у вас уже есть фильтры для определенного хранилища и типа файлов, установленных в индексируемой системе, Поиск Windows может использовать существующие интерфейсы для индексирования этих данных.

Общие сведения о процессе индексирования см. [в разделе процесс индексирования](-search-indexing-process-overview.md). Основные сведения о обработчиках фильтров см. в разделе [Разработка обработчиков фильтров](-search-ifilter-conceptual.md).

### <a name="filters-and-protocol-handlers"></a>Фильтры и обработчики протоколов

Обработчики протоколов предоставляют индексатору поиска Windows доступ к хранилищам данных, позволяя индексатору выполнять обход узлов хранилища данных и извлекать соответствующие сведения для индексирования. Например, служба поиска Windows поставляется с обработчиками протоколов для хранилищ файловой системы и для некоторых версий обоих хранилищ данных Microsoft Outlook. При индексировании электронной почты Outlook обработчик протокола выполняет сканирование всех сообщений в наборе папок Outlook и извлекает сведения из каждого сообщения и вложения. Эти сведения передаются в индексатор для включения в каталог Windows Search.

Обзоры диспетчера каталогов и диспетчера области обхода содержимого (CSM) см. в разделе [Использование диспетчера каталогов](-search-3x-wds-mngidx-catalog-manager.md) и [диспетчера области сканирования](-search-3x-wds-extidx-csm.md).

## <a name="indexing-a-compound-file-format"></a>Индексирование формата составного файла

Формат составного файла можно индексировать, чтобы отдельные элементы в файле можно было вернуть в виде отдельных результатов. Формат составного файла, например сжатый файл с расширением ZIP, по сути является хранилищем данных, и его можно рассматривать как таковое для целей индексирования. В следующем примере показано, как отобразить ZIP-файл в пространстве имен файловой системы (FILE://c:/test/test.zip), в котором есть и вложенные папки, и отдельные элементы.

``` syntax
Test.zip 

    |-folder1 

    |    |-folder2 

    |           |- FileX.txt 

    |- FileY.doc
```

Обработчик протокола FILE обнаруживает, когда FILE://c:/test/test.zip изменения, отслеживая журналы изменений файловой системы, и вызывает [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) , зарегистрированный для ZIP-файлов в этом файле при изменении файла, но не имеет сведений о внутренней структуре самого ZIP-файла.

Необходимо сообщить индексатору, что формат составного файла является хранилищем данных. Это необходимо сделать, чтобы отдельные элементы были проиндексированы и извлечены как уникальные сущности. После реализации источника данных оболочки и выполнения следующих действий у вас будет обработчик протокола, который может обрабатывать и предоставлять данные из формата составного файла (ZIP-файла) в качестве отдельных элементов.

**Чтобы сообщить индексатору, что составной файл является хранилищем данных, сделайте следующее:**

1.  Создайте обработчик протокола (с помощью [**исеарчпротокол**](/windows/desktop/api/Searchapi/nn-searchapi-isearchprotocol) или [**ISearchProtocol2**](/windows/desktop/api/Searchapi/nn-searchapi-isearchprotocol2)) для ZIP-файлов с возможностью привязки к исходному файлу. Дополнительные сведения см. в разделе [Установка и регистрация обработчиков протоколов](-search-3x-wds-ph-install-registration.md).

    Например, можно использовать экранированный путь к ZIP-файлу в качестве имени корневой папки, а затем использовать синтаксис иерархии, как любой другой формат файла.

    ``` syntax
    .zip:///escapedPathTo.zipFile/.zipfolder/.../.zipfile
    ```

    Используя приведенный выше образец данных для c: \\ test \\test.zip, уникальные URL-адреса будут выглядеть следующим образом. С этими URL-адресами обработчик протокола имеет сведения, необходимые для привязки к ZIP-файлу, и перечисляет дочерние URL, включая внутренние файлы, чтобы их можно было привязать и индексировать с помощью фильтров. doc и. txt.

    ``` syntax
      

    .zip:///FILE:%2f%2f%2fc:%2ftest%2ftest.zip/ 

    .zip:///FILE:%2f%2f%2fc:%2ftest%2ftest.zip/FileY.Doc 

    .zip:///FILE:%2f%2f%2fc:%2ftest%2ftest.zip/folder1 

    .zip:///FILE:%2f%2f%2fc:%2ftest%2ftest.zip/folder1/folder2 

    .zip:///FILE:%2f%2f%2fc:%2ftest%2ftest.zip/folder1/folder2/FileX.txt
    ```

2.  Убедитесь, что обработчик протокола удовлетворяет следующим двум условиям.
    -   Корневые URL-адреса для файла ZIP должны выдавать PKEY \_ Search \_ Исклоседдиректори ([System. Search. Исклоседдиректори](../properties/props-system-search-iscloseddirectory.md)) по URL-адресам корневых ZIP-файлов. Например,. zip:///FILE:%2f%2f%2fc:%2ftest% 2ftest.zip/должен выдать Исклоседдиректори = **true**. Это указывает индексатору, что если дата на этом URL-адресе не изменилась, не нужно обрабатывать дочерние URL-адреса.
    -   Каждый дочерний URL-адрес для этого URL-адреса должен порождать \_ \_ исфулликонтаинед поиска ([System. Search. исфулликонтаинед](../properties/props-system-search-isfullycontained.md)) в дочерних URL-адресах корневого. zip. Как правило, в конце добавочного сканирования индексатор обрабатывает все Непосещенные URL-адреса как элементы, которые должны быть удалены. Но корневой ZIP-файл не должен обрабатывать корневые URL, так как ничего не изменилось. Порождение этого свойства как **true** сообщает индексатору, что если этот URL-адрес не был обработан в конце добавочного сканирования, его не следует удалять. Он будет удален только в том случае, если корневой элемент изменился и он не будет посещен.

Для службы поиска Windows требуется начальная страница для протокола, чтобы узнать, какие URL-адреса нужно просканировать постепенно, и какие URL-адреса следует игнорировать при их обнаружении. Но мы не можем начать с URL-адреса для каждого файла ZIP, так как мы не понимаем, где каждый ZIP-файл имеет значение. Таким образом, URL-адрес начальной страницы обработчика протокола ZIP должен иметь возможность перечислить все в корне экранированных путей всех ZIP-файлов. Эти ZIP-файлы не обязательно находятся в пространстве имен FILE: и могут представлять собой URL типа MAPI, указывающий на файл ZIP в качестве вложения, например.

**Чтобы зарегистрировать корневой элемент в качестве начальной страницы, выполните следующие действия.**

1.  Зарегистрируйте корневой элемент, например. zip:///, в качестве начальной страницы, чтобы все ZIP-файлы запускались в силе. При обработке корневого файла. zip: URL-адрес обработчик протокола должен создать список дочерних URL-адресов, которые будут выдаваться путем запроса поиска Windows для всех URL-адресов с помощью System. FileExtension = ". zip".
2.  Отмените эти URL-адреса, чтобы удалить косые черты и вернуть их в качестве дочерних URL-адресов. Пример запроса для получения требуемых типов может выглядеть следующим образом.

    ``` syntax
    SELECT system.itemurl, System.DateModified FROM SystemIndex 
    WHERE System.FileExtension='.zip' OR System.MimeType='mimetypefor.zip'
    ```

3.  Когда система поиска Windows периодически выполняет добавочный обход содержимого корневого URL-адреса zip:///, необходимо отразить список URL-адресов, которые службы поиска Windows уже поддерживают, а именно — URL-адреса в формате ZIP. Если удаление обнаруживается в собственном хранилище, в котором хранится ZIP-файл, он не отображается в перечислении, и эта ветвь дерева в ZIP-файле удаляется.
4.  Чтобы выполнить привязку к данным. zip для другого обработчика протокола, в идеале следует пропускать [ишеллфолдер](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) для этого URL-адреса, чтобы выполнить привязку к хранилищу объекта, а не считать, что он всегда является файлом. Это обеспечивает гибкость работы с вложениями в хранилищах почты, например.
5.  При выдаче дочерних URL-адресов для каждого файла. zip следует использовать PKEY \_ поиска \_ Урлтоиндексвисмодификатионтиме ([System. Search. урлтоиндексвисмодификатионтиме](../properties/props-system-search-urltoindexwithmodificationtime.md)), чтобы передать PKEY \_ DateModified ([System. DateModified](../properties/props-system-datemodified.md)) фактического ZIP-файла, чтобы индексатор обработал файл с расширением. zip только в том случае, если он был изменен.

Чтобы URL-адреса ZIP были индексированы сразу после создания или изменения, а также не нужно ждать, пока добавочное сканирование не обнаружит новое состояние, можно наблюдать за тем, чтобы файловая система выполняла изменения в файлах ZIP. Однако такой подход не будет работать для других хранилищ данных, таких как MAPI.

**Чтобы URL-адреса ZIP были индексированы при их создании или изменении, выполните следующие действия.**

1.  Создайте фильтр (и реализацию интерфейса [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) ) для типа ZIP-файла. Дополнительные сведения см. в разделе [Разработка обработчиков свойств для службы поиска Windows](-search-3x-wds-extidx-propertyhandlers.md).
2.  При вызове реализации [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) это происходит потому, что этот URL-адрес был обнаружен или изменен. Затем создайте событие для URL-адреса ZIP, соответствующего URL-адресу источника, через интерфейс [**игасернотифинлине**](/previous-versions/windows/desktop/legacy/bb231470(v=vs.85)) . Это дает возможность немедленно сообщить индексатору, что новые данные будут индексироваться без ожидания добавочного сканирования.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Разработка обработчиков протоколов](-search-3x-wds-phaddins.md)
</dt> <dt>

[Установка и регистрация обработчиков протоколов](-search-3x-wds-ph-install-registration.md)
</dt> <dt>

[Уведомление индекса изменений](-search-3x-wds-notifyingofchanges.md)
</dt> <dt>

[Добавление значков и контекстных меню](-search-3x-wds-ph-ui-extensions.md)
</dt> <dt>

[Пример кода: расширения оболочки для обработчиков протоколов](-search-3x-wds-ph-ui-samplecode.md)
</dt> <dt>

[Установка и регистрация обработчиков протоколов](-search-3x-wds-ph-install-registration.md)
</dt> <dt>

[Создание соединителя поиска для обработчика протокола](-search-3x-wds-ph-search-connector.md)
</dt> <dt>

[Обработчики протокола отладки](-search-ws-protocolhandlertesting.md)
</dt> </dl>

 

 
