---
description: Чтобы гарантировать, что данные индексируются и правильно отображаются для пользователя во время поиска, необходимо реализовать оболочки хранилища данных (также известные как расширения пространства имен оболочки) и обработчики типов файлов (также называемые расширениями оболочки, обработчиками расширений или обработчиками расширений оболочки).
ms.assetid: 38cebb3c-51bf-439c-8d4e-445344f6cb66
title: Добавление значков, предварительных версий и контекстных меню
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 501006227f6192b7d81a2a88ba915c368a9cc398
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104540735"
---
# <a name="adding-icons-previews-and-shortcut-menus"></a>Добавление значков, предварительных версий и контекстных меню

Чтобы гарантировать, что данные индексируются и правильно отображаются для пользователя во время поиска, необходимо реализовать оболочки хранилища данных (также известные как [расширения пространства имен оболочки](../shell/nse-works.md)) и обработчики типов файлов (также называемые расширениями оболочки, [обработчиками расширений](../shell/handlers.md)или обработчиками расширений оболочки).

В этом разделе описываются следующие интерфейсы:

-   [Реализация обработчиков типов файлов](#implementing-file-type-handlers)
    -   [IPersist](#ipersist)
    -   [иперсистфолдер](#ipersistfolder)
    -   [ишеллфолдер](#ishellfolder)
    -   [IContextMenu](#icontextmenu)
    -   [иекстрактикон](#iextracticon)
    -   [IPreviewHandler](#ipreviewhandler)
-   [Дополнительные ресурсы](#additional-resources)
-   [См. также](#related-topics)

## <a name="implementing-file-type-handlers"></a>Реализация обработчиков типов файлов

Эти расширения оболочки или обработчики типов файлов предоставляют пользователям следующие возможности оболочки:

-   В представлении результатов отображается конкретный значок для типа элемента.
-   В представлении результатов отображается предварительный просмотр элемента, когда пользователь выбирает элемент.
-   Пользователи могут дважды щелкнуть элемент, чтобы инициировать такие события, как открытие файла.
-   Пользователи могут щелкнуть правой кнопкой мыши элемент, чтобы открыть контекстное меню (контекст).
-   Пользователи могут перетаскивать элементы.

Как и все объекты COM, обработчики типов файлов должны реализовывать интерфейс [IUnknown](/windows/win32/api/unknwn/nn-unknwn-iunknown) и фабрику классов.

В Windows XP или более ранних версиях обработчики должны также реализовать:

-   Либо [интерфейс IPersistFile](/windows/win32/api/objidl/nn-objidl-ipersistfile)
-   Или [интерфейс ишеллекстинит](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellextinit)

В Windows Vista интерфейс [IPersistFile](/windows/win32/api/objidl/nn-objidl-ipersistfile) и [интерфейс ишеллекстинит](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellextinit) были заменены следующими тремя интерфейсами для инициализации обработчика с помощью оболочки:

-   [Интерфейс IInitializeWithStream](/windows/win32/api/propsys/nn-propsys-iinitializewithstream)
-   [Интерфейс Иинитиализевиситем](/windows/win32/api/shobjidl_core/nn-shobjidl_core-iinitializewithitem)
-   [Интерфейс IInitializeWithFile](/windows/win32/api/propsys/nn-propsys-iinitializewithfile)

Чтобы обеспечить разумное взаимодействие с пользователем, необходимо предоставить обработчику протокола хранилище данных оболочки. Это хранилище данных затем служит "фабрикой" для обработчиков значков, обработчиков контекстного меню, обработчиков предварительного просмотра и т. д. [Интерфейс ишеллфолдер](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder)требует минимальных реализаций [интерфейса IPersist](/windows/desktop/api/objidl/nn-objidl-ipersist) и [интерфейса иперсистфолдер](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ipersistfolder) , а для [IContextMenu](/windows/win32/api/shobjidl_core/nn-shobjidl_core-icontextmenu) и [иекстрактикон](/windows/win32/api/shlobj_core/nn-shlobj_core-iextracticona)требуется минимальная реализация интерфейса ишеллфолдер.

> [!Note]  
> Для **IPersist**, **иперсистфолдер** и **ишеллфолдер** должен быть реализован один и тот же идентификатор класса (CLSID).

 

Дополнительные сведения о создании хранилища данных оболочки для поддержки обработчика протокола см. в разделе [реализация базовых интерфейсов объекта папки](/previous-versions/windows/desktop/legacy/cc144093(v=vs.85)).

### <a name="ipersist"></a>IPersist

Интерфейс **IPersist** определяет единственный метод- **ClassID**, который предназначен для предоставления идентификатора CLSID объекта, который может храниться в системе постоянно.



| Метод     | Описание                                      |
|------------|--------------------------------------------------|
| GetClassID | Возвращает идентификатор CLSID объекта хранилища данных оболочки. |



 

### <a name="ipersistfolder"></a>иперсистфолдер

Интерфейс **иперсистфолдер** используется для инициализации объектов папки оболочки. Реализация этого интерфейса, производного от **IPersist**, заключается в том, как папка сообщается, где она находится в пространстве имен оболочки. Этот интерфейс не используется напрямую. Он используется реализацией файловой системы [метода ишеллфолдер:: биндтубжект](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellfolder-bindtoobject) при инициализации объекта папки оболочки.



| Метод     | Описание                                                                                            |
|------------|--------------------------------------------------------------------------------------------------------|
| Инициализация | Указывает объекту папки оболочки инициализировать себя на основе переданных и возвратов \_ ОК |



 

### <a name="ishellfolder"></a>ишеллфолдер

Интерфейс [ишеллфолдер](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) используется для управления папками, а частичная реализация необходима, чтобы интерфейсы значков и контекста, реализованные для обработчика протокола, были корректно работать в пользовательском интерфейсе Windows Search Results. Большинство необходимых функциональных возможностей предоставляется с помощью метода **жетуиобжектоф** . Этот метод позволяет надстройке запрашивать интерфейсы **иекстрактикон** и **IContextMenu** .

Интерфейс [ишеллфолдер](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) использует PIDL вместо URL-адресов. В отличие от требований к полному хранилищу данных оболочки, надстройки могут использовать простую структуру IDL, содержащую только URL-адрес.

Должны быть реализованы следующие методы [интерфейса ишеллфолдер](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellfolder) . Для пяти этих методов требуется минимальная реализация.



| Метод           | Описание                                                                                                                                                                                                                                                                   |
|------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| биндтубжект     | Возвращает E \_ нотимпл                                                                                                                                                                                                                                                            |
| биндтостораже    | Возвращает E \_ нотимпл                                                                                                                                                                                                                                                            |
| креатевиевобжект | Возвращает E \_ нотимпл                                                                                                                                                                                                                                                            |
| сетнамеоф        | Возвращает E \_ нотимпл                                                                                                                                                                                                                                                            |
| парседисплайнаме | Преобразует URL-адрес в структуру ПИДЛ                                                                                                                                                                                                                                          |
| компареидс       | Сравнивает два значения ПИДЛ                                                                                                                                                                                                                                                      |
| жетдисплайнамеоф | Возвращает URL-адрес для ПИДЛ                                                                                                                                                                                                                                                    |
| жетуиобжектоф    | Этот метод аналогичен [методу IUnknown:: QueryInterface](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)). Если запрошен значок, вызывающий объект запрашивает IID \_ иекстрактикон; если контекстное меню запрашивается, вызывающий объект запрашивает IID \_ IContextMenu |



 

**Ишеллфолдер** не используется для перечисления папок. Это означает, что отображаемое имя папки будет физическим URL-адресом. Это может измениться в будущем.

### <a name="icontextmenu"></a>IContextMenu

Когда Windows Search отображает результаты для пользователя, пользователь может щелкнуть правой кнопкой мыши элемент и увидеть контекстное меню, определенное интерфейсом **IContextMenu** . Контекстные меню также называются контекстными меню.

Действие по умолчанию в контекстном меню — это то же действие, которое предпринимается при двойном щелчке элемента. При отсутствии соответствующих интерфейсов **ишеллфолдер** или **IContextMenu** для элемента поведение по умолчанию для события двойного щелчка заключается в передаче URL-адреса в качестве аргумента функции [функции ShellExecute](/windows/win32/api/shellapi/nf-shellapi-shellexecutea) .

Дополнительные сведения о создании обработчиков контекстного меню см. в разделе Создание обработчиков [контекстного меню](../shell/context-menu-handlers.md) , а [Пример: расширения оболочки для обработчиков протоколов](-search-3x-wds-ph-ui-samplecode.md) для образца кода.

### <a name="iextracticon"></a>иекстрактикон

**Иекстрактикон** извлекает значок пользовательского интерфейса службы поиска Windows на основе URL-адреса в Пидл, предоставленного обработчиком протокола.

Дополнительные сведения о создании обработчиков значков и примеров см. в разделе [Создание](../shell/how-to-create-icon-handlers.md) обработчиков значков для [обработчиков протокола](-search-3x-wds-ph-ui-samplecode.md) для образца кода.

### <a name="ipreviewhandler"></a>IPreviewHandler

[IPreviewHandler](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ipreviewhandler) отображает расширенный предварительный просмотр выбранного элемента в проводнике Windows. Предварительные версии доступны в Windows Search 4,0 или в Windows Vista с Windows Desktop Search 3. x.

Чтобы создать пользовательский обработчик просмотра, выполните следующие действия.

1.  Реализуйте [IPreviewHandler](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ipreviewhandler) , который принимает [IStream](/windows/win32/api/objidl/nn-objidl-istream), следуя рекомендациям, предоставленным в [обработчиках просмотра](../shell/preview-handlers.md).
2.  Зарегистрируйте обработчик просмотра:

    ```
    HKEY_CLASSES_ROOT\<Your_Object_Type>
    ```

    ```
    HKEY_CLASSES_ROOT\<Your_Object_Type>\ShellEx
    ```

    ```
    HKEY_CLASSES_ROOT\<Your_Object_Type>\ShellEx\{8895b1c6-b41f-4c1c-a562-0d564250836f}
       @ = {<Your_PreviewHandler_GUID>}
    ```

3.  Выполните следующие два действия, чтобы реализовать папку оболочки для URL-адреса:
    1.  В [методе ишеллфолдер:: жетуиобжектоф](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getuiobjectof)обработайте [икуеряссоЦиатионс](/windows/win32/api/shlwapi/nn-shlwapi-iqueryassociations) и верните свое сопоставление для элементов оболочки, как показано в следующем примере кода.

        ```
        CComPtr<IQueryAssociations> spqa;
        AssocCreate(CLSID_QueryAssociations, __uuidof(IQueryAssociations), &spqa);
        spqa->Init(0, L"Your_Object_Type", NULL, NULL);
        spqa->QueryInterface(riid, ppvReturn);
        ```

        

    2.  После того как оболочка запросит папку оболочки для потока данных для инициализации обработчика просмотра, перейдите к методу [метода ишеллфолдер:: биндтубжект](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellfolder-bindtoobject) , обработайте IID \_ IStream и верните в URL-адрес [IStream](/windows/win32/api/objidl/nn-objidl-istream) .

Чтобы повторно использовать существующий обработчик просмотра для типа файлов, выполните следующие два действия.

1.  Зарегистрируйте этот обработчик просмотра для своего типа файлов, используя идентификатор CLSID существующего обработчика просмотра вместо <\_ \_> PreviewHandler GUID.
2.  Реализуйте папку оболочки.

Дополнительные сведения о создании обработчиков просмотра см. в разделе [обработчики](../shell/preview-handlers.md) [IPreviewHandler](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ipreviewhandler) и Preview.

## <a name="additional-resources"></a>Дополнительные ресурсы

-   Общие сведения о процессе индексирования см. [в разделе процесс индексирования](-search-indexing-process-overview.md).
-   Сведения о создании обработчиков см. в статьях [Регистрация расширений оболочки](../shell/reg-shell-exts.md), [Создание обработчиков расширений оболочки](../shell/handlers.md), [контекстное меню](/previous-versions/windows/desktop/legacy/cc144169(v=vs.85)), [расширения пространства имен оболочки](../shell/nse-works.md) и [обработчики просмотра](../shell/preview-handlers.md).

## <a name="related-topics"></a>См. также

<dl> <dt>

**Зрения**
</dt> <dt>

[Разработка обработчиков протоколов](-search-3x-wds-phaddins.md)
</dt> <dt>

[Основные сведения о обработчиках протоколов](-search-3x-wds-extidx-prot-implementing.md)
</dt> <dt>

[Уведомление индекса изменений](-search-3x-wds-notifyingofchanges.md)
</dt> <dt>

[Пример кода: расширения оболочки для обработчиков протоколов](-search-3x-wds-ph-ui-samplecode.md)
</dt> <dt>

[Установка и регистрация обработчиков протоколов](-search-3x-wds-ph-install-registration.md)
</dt> <dt>

[Создание соединителя поиска для обработчика протокола](-search-3x-wds-ph-search-connector.md)
</dt> <dt>

[Обработчики протокола отладки](-search-ws-protocolhandlertesting.md)
</dt> </dl>

 

 
