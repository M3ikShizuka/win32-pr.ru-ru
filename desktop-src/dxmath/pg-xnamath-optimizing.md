---
description: В этом разделе описываются рекомендации по оптимизации и стратегии использования библиотеки Директксмас.
ms.assetid: bcbf8ae1-ed49-fdf7-812d-b2089537ab28
title: Оптимизация кода с помощью библиотеки Директксмас
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 263434b5e7295f630f284517299cec036b33b064d35dc5085a83d67c8244366a
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118984724"
---
# <a name="code-optimization-with-the-directxmath-library"></a>Оптимизация кода с помощью библиотеки Директксмас

В этом разделе описываются рекомендации по оптимизации и стратегии использования библиотеки Директксмас.

-   [Использование методов доступа с осторожностью](#use-accessors-sparingly)
-   [Использовать правильные параметры компиляции](#use-correct-compilation-settings)
-   [Использование функций EST при необходимости](#use-est-functions-when-appropriate)
-   [Использование согласованных типов данных и операций](#use-aligned-data-types-and-operations)
-   [Правильно выровняйте выделенные ресурсы](#properly-align-allocations)
-   [Избегайте перегрузок операторов, если это возможно](#avoid-operator-overloads-when-possible)
-   [Денормализованные числа](#denormals)
-   [Использование преимуществ целочисленной двойной разрядности с плавающей запятой](#take-advantage-of-the-integer-floating-point-duality)
-   [Предпочитать шаблонные формы](#prefer-template-forms)
-   [Использование Директксмас с Direct3D](#using-directxmath-with-direct3d)
-   [Связанные темы](#related-topics)

## <a name="use-accessors-sparingly"></a>Использование методов доступа с осторожностью

Операции на основе векторов используют наборы инструкций SIMD и используют специальные регистры. Для доступа к отдельным компонентам необходимо переходить от реестров SIMD к скалярным и обратно.

По возможности более эффективно инициализировать все компоненты [**ксмвектор**](xmvector-data-type.md) , вместо того чтобы использовать ряд отдельных методов доступа к вектору.

## <a name="use-correct-compilation-settings"></a>Использовать правильные параметры компиляции

для целевых платформ Windows x86 включите/arch: SSE2. для всех Windows целей включите/fp: fast.

По умолчанию компиляция для библиотеки Директксмас для Window x86 targets выполняется с \_ \_ \_ определенными встроенными функциями SSE XM \_ . Это означает, что все функции Директксмас будут использовать инструкции SSE2. Однако это не относится к другому коду.

Код за пределами Директксмас обрабатывается с использованием значений компилятора по умолчанию. Без этого параметра созданный код часто может использовать менее эффективный код x87.

Настоятельно рекомендуется всегда использовать последнюю доступную версию компилятора.

## <a name="use-est-functions-when-appropriate"></a>Использование функций EST при необходимости

Многие функции имеют эквивалентную функцию оценки, завершающуюся в средстве EST. Эти функции дают некоторую точность для повышения производительности. Функции EST подходят для некритических вычислений, где точность может быть замедлена. Точный объем потерянных и увеличенных скоростей зависит от платформы.

Например, функцию [**XMVector3AngleBetweenNormalsEst**](/windows/win32/api/directxmath/nf-directxmath-xmvector3anglebetweennormalsest) можно использовать вместо функции [**XMVector3AngleBetweenNormals**](/windows/win32/api/directxmath/nf-directxmath-xmvector3anglebetweennormals) .

## <a name="use-aligned-data-types-and-operations"></a>Использование согласованных типов данных и операций

Инструкции SIMD в версиях Windows, поддерживающих SSE2, обычно имеют согласованные и несогласованные версии операций с памятью. Использование согласованных операций выполняется быстрее и желательно везде, где это возможно.

Библиотека Директксмас предоставляет доступ к несогласованным и неровным функциональным возможностям через векторные типы, структуру и функции типа Vector. Эти варианты обозначаются символом "A" в конце имени.

Например, существует Несогласованная структура [**XMFLOAT4X4**](/windows/win32/api/directxmath/ns-directxmath-xmfloat4x4) и согласованная структура [**XMFLOAT4X4A**](/previous-versions/windows/desktop/legacy/ee419623(v=vs.85)) , которая используется в функциях [**XMStoreFloat4**](/windows/win32/api/directxmath/nf-directxmath-xmstorefloat4) и [**XMStoreFloat4A**](/windows/win32/api/directxmath/nf-directxmath-xmstorefloat4a) соответственно.

## <a name="properly-align-allocations"></a>Правильно выровняйте выделенные ресурсы

Согласованные версии встроенных функций [SSE](/previous-versions/visualstudio/visual-studio-2010/t467de55(v=vs.100)) , лежащих в основе библиотеки директксмас, выполняются быстрее, чем несогласованное.

По этой причине операции Директксмас с использованием объектов [**ксмвектор**](xmvector-data-type.md) и [**ксмматрикс**](/windows/win32/api/directxmath/ns-directxmath-xmmatrix) предполагают, что эти объекты имеют размер 16 байт. это происходит автоматически при распределении на основе стека, если код компилируется для библиотеки директксмас с использованием рекомендуемых Windows (см. раздел [использование правильных Параметры компиляции](#use-correct-compilation-settings)) параметры компилятора. Однако важно обеспечить, чтобы выделение кучи, содержащее объекты **ксмвектор** и **ксмматрикс** , или приведение к этим типам соответствовало этим требованиям к выравниванию.

хотя 64-разрядные Windows выделения памяти распределяются по 16 байтам, по умолчанию в 32 разрядных версиях Windows выделенной памяти используется только 8-байтное согласованное значение. Сведения об управлении выравниванием памяти см. в разделе [ \_ Выравнивание \_ malloc](https://docs.microsoft.com/cpp/c-runtime-library/reference/aligned-malloc).

При использовании выровненных типов Директксмас с стандартной библиотекой шаблонов (STL) необходимо предоставить пользовательский распределитель, обеспечивающий возможность выравнивания в 16 байт. Пример написания пользовательского распределителя (а не malloc/Free) см. в [блоге](https://devblogs.microsoft.com/cppblog/the-mallocator/) по Visual C++ команде \_ . в вашей реализации вы захотите использовать согласованную функцию \_ malloc и \_ выровняйте ее \_ бесплатно.

> [!Note]  
> Некоторые шаблоны STL изменяют выравнивание указанного типа. Например, [make \_ shared<>](/cpp/standard-library/memory-functions?view=vs-2017&preserve-view=true) добавляет некоторые внутренние данные отслеживания, которые могут или не учитывают выравнивание указанного типа пользователя, что приводит к невыровненным элементам данных. В этом случае необходимо использовать несогласованные типы вместо согласованных типов. если вы наследуете от существующих классов, включая множество среда выполнения Windows объектов, можно также изменить выравнивание класса или структуры.

 

## <a name="avoid-operator-overloads-when-possible"></a>Избегайте перегрузок операторов, если это возможно

Для удобства существует ряд типов, таких как [**ксмвектор**](xmvector-data-type.md) и [**ксмматрикс**](/windows/win32/api/directxmath/ns-directxmath-xmmatrix) , имеют перегрузки операторов для распространенных арифметических операций. Такие перегрузки операторов обычно создают многочисленные временные объекты. Рекомендуется избегать этих перегрузок операторов в коде, чувствительном к производительности.

## <a name="denormals"></a>Денормализованные числа

Для поддержки вычислений, близких к 0, стандарт с плавающей точкой IEEE 754 включает поддержку постепенного потери значимости. Постепенная потеря значимости реализуется с помощью денормализованных значений, и многие аппаратные реализации работают очень часто при обработке денормализованных данных. Рекомендуется отключить обработку денормализованных данных для векторных операций, используемых Директксмас.

Изменение обработки денормализованных данных осуществляется с помощью подпрограммы [ \_ контролфп \_ s](/cpp/c-runtime-library/reference/controlfp-s) на основе предварительных потоков и может привести к улучшению производительности. Используйте этот код, чтобы изменить обработку денормализованных данных:


```
  #include <float.h>;
    unsigned int control_word;
    _controlfp_s( &control_word, _DN_FLUSH, _MCW_DN );
```



> [!Note]  
> в 64-разрядных версиях Windows инструкции [SSE](/previous-versions/visualstudio/visual-studio-2010/t467de55(v=vs.100)) используются для всех вычислений, а не только для операций вектора. Изменение денормализованной обработки влияет на все вычисления с плавающей запятой в программе, а не только на векторные операции, используемые Директксмас.

 

## <a name="take-advantage-of-the-integer-floating-point-duality"></a>Использование преимуществ целочисленной двойной разрядности с плавающей запятой

Директксмас поддерживает векторы из 4 значений с плавающей запятой одиночной точности или 4 32-разрядных (со знаком или без).

Поскольку наборы инструкций, используемые для реализации библиотеки Директксмас, имеют возможность обрабатывать те же данные, что и различные типы, например, обрабатывать один и тот же вектор как данные с плавающей запятой и целыми данными. Эти оптимизации можно получить с помощью подпрограмм целочисленного вектора инициализации и побитовых операторов для управления значениями с плавающей запятой.

Двоичный формат чисел с плавающей запятой одиночной точности, используемых библиотекой Директксмас, полностью соответствует стандарту IEEE 764:

``` syntax
     SIGN    EXPONENT   MANTISSA
     X       XXXXXXXX   XXXXXXXXXXXXXXXXXXXXXXX
     1 bit   8 bits     23 bits
```

При работе с числом с плавающей запятой в стандарте IEEE 764 важно помнить, что некоторые представления имеют особое значение (то есть они не соответствуют предыдущему описанию). Примеры:

-   Положительный нуль равен 0
-   Отрицательный нуль — 0x80000000
-   Q \_ NaN — 07FC0000
-   + INF — 0x7F800000
-   -INF — 0xFF800000

## <a name="prefer-template-forms"></a>Предпочитать шаблонные формы

Существует форма шаблона для [**ксмвекторсвиззле**](/windows/win32/api/directxmath/nf-directxmath-xmvectorswizzle), [**ксмвекторпермуте**](/windows/win32/api/directxmath/nf-directxmath-xmvectorpermute), [**ксмвекторинсерт**](/windows/win32/api/directxmath/nf-directxmath-xmvectorinsert), [**ксмвекторшифтлефт**](/windows/win32/api/directxmath/nf-directxmath-xmvectorshiftleft), [**ксмвекторротателефт**](/windows/win32/api/directxmath/nf-directxmath-xmvectorrotateleft)и [**XMVectorRotateRight**](/windows/win32/api/directxmath/nf-directxmath-xmvectorrotateright). Использование этих функций вместо универсальной формы функции позволяет компилятору создавать гораздо более еффицент реализации. Для [SSE](/previous-versions/visualstudio/visual-studio-2010/t467de55(v=vs.100))это часто сворачивается до одного или двух \_ мм \_ случайным \_ значениям PS. Для ARM-NEON шаблон **ксмвекторсвиззле** может использовать несколько специальных случаев, а не более общий элемент VTBL свиззле/переставляют.

## <a name="using-directxmath-with-direct3d"></a>Использование Директксмас с Direct3D

Чаще всего Директксмас используется для выполнения графических вычислений для использования с Direct3D. С помощью Direct3D 10. x и Direct3D 11. x можно использовать библиотеку Директксмас следующими прямыми способами:

-   Используйте [константы](ovw-xnamath-reference-constants.md) пространства имен Colors непосредственно в параметре *колорргба* в вызове метода [**ссылку ID3D11DeviceContext:: Клеаррендертаржетвиев**](/windows/win32/api/d3d11/nf-d3d11-id3d11devicecontext-clearrendertargetview) или [**ID3D10Device:: клеаррендертаржетвиев**](/windows/win32/api/d3d10/nf-d3d10-id3d10device-clearrendertargetview) . Для Direct3D 9 необходимо преобразовать в тип [**ксмколор**](/windows/desktop/api/DirectXPackedVector/ns-directxpackedvector-xmcolor) , чтобы использовать его в качестве параметра *Color* при вызове метода [**IDirect3DDevice9:: Clear**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-clear) .
-   Используйте типы [**XMFLOAT4**](/windows/win32/api/directxmath/ns-directxmath-xmfloat4) / [**ксмвектор**](xmvector-data-type.md) и [**XMFLOAT4X4**](/windows/win32/api/directxmath/ns-directxmath-xmfloat4x4) / [**ксмматрикс**](/windows/win32/api/directxmath/ns-directxmath-xmmatrix) , чтобы настроить структуры буферов констант для ссылки на типы HLSL [**float4**](../direct3dhlsl/dx-graphics-hlsl-scalar.md) или [**Matrix**](../direct3dhlsl/dx-graphics-hlsl-matrix.md)/float4x4.
    > [!Note]  
    > [**XMFLOAT4X4**](/windows/win32/api/directxmath/ns-directxmath-xmfloat4x4) / Типы [**ксмматрикс**](/windows/win32/api/directxmath/ns-directxmath-xmmatrix) относятся к основному формату строк. Таким образом, если вы используете параметр компилятора/ЗПР ( [**основной флаг \_ компиляции \_ \_ столбца \_ матрицы D3DCOMPILE**](../direct3dhlsl/d3dcompile-constants.md) ) или не заметите \_ [ключевое слово](../direct3dhlsl/dx-graphics-hlsl-appendix-keywords.md) Row при объявлении типа матрицы в HLSL, необходимо переставить матрицу, если она задана в буфере констант.

     

-   С помощью Direct3D 10. x и Direct3D 11. x можно предположить, что указатель, возвращаемый методом Map (например, [**ссылку ID3D11DeviceContext:: Map**](/windows/win32/api/d3d11/nf-d3d11-id3d11devicecontext-map)) в элементе **pData** ([**D3D10 \_ сопоставлен \_ TEXTURE2D**](/windows/win32/api/d3d10/ns-d3d10-d3d10_mapped_texture2d).**pData**, [**D3D10, \_ сопоставленный \_ TEXTURE3D**](/windows/win32/api/d3d10/ns-d3d10-d3d10_mapped_texture3d).**pData** или [**D3D11 \_ сопоставленный \_ подресурс**](/windows/win32/api/d3d11/ns-d3d11-d3d11_mapped_subresource).**pData**) — это 16-байтовое выравнивание при использовании [уровня компонентов](../direct3d11/overviews-direct3d-11-devices-downlevel-intro.md) 10 \_ 0 или более поздней версии или при использовании [**\_ \_ промежуточных ресурсов D3D11**](/windows/win32/api/d3d11/ne-d3d11-d3d11_usage) .

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Директксмас по программированию](ovw-xnamath-progguide.md)
</dt> </dl>

 

 
