---
description: Считывает данные из открытого файла.
ms.assetid: 7EA2FE38-20DA-43E1-A764-66A81725D1EA
title: Функция Нтреадфиле (WDM. h)
ms.topic: reference
ms.date: 05/31/2018
topic_type:
- APIRef
- kbSyntax
api_name:
- NtReadFile
api_type:
- DllExport
api_location:
- Ntdll.dll
ms.openlocfilehash: 57eacec05ec56fe3b174ee58569adca4c0f644e698aae3b603c7db5ab8f25f57
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119984174"
---
# <a name="ntreadfile-function"></a>Функция Нтреадфиле

Считывает данные из открытого файла.

эта функция является аналогом пользовательского режима функции [**звреадфиле**](/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntreadfile) , документированной в комплекте Windows Driver Kit (WDK).

## <a name="syntax"></a>Синтаксис


```C++
NTSTATUS NtReadFile(
  _In_     HANDLE           FileHandle,
  _In_opt_ HANDLE           Event,
  _In_opt_ PIO_APC_ROUTINE  ApcRoutine,
  _In_opt_ PVOID            ApcContext,
  _Out_    PIO_STATUS_BLOCK IoStatusBlock,
  _Out_    PVOID            Buffer,
  _In_     ULONG            Length,
  _In_opt_ PLARGE_INTEGER   ByteOffset,
  _In_opt_ PULONG           Key
);
```



## <a name="parameters"></a>Параметры

<dl> <dt>

*FileHandle* \[ окне\]
</dt> <dd>

Обработчик для объекта File. Этот маркер создается при успешном вызове [**NtCreateFile**](/windows/desktop/api/Winternl/nf-winternl-ntcreatefile) или [**нтопенфиле**](/windows/desktop/api/Winternl/nf-winternl-ntopenfile).

</dd> <dt>

*Событие* \[ в необязательное\]
</dt> <dd>

При необходимости дескриптор объекта события может быть установлен в сигнальное состояние после завершения операции чтения. Драйвер устройства и промежуточные драйверы должны установить этот параметр в **значение NULL**.

</dd> <dt>

*Апкраутине* \[ в необязательное\]
</dt> <dd>

Этот параметр зарезервирован. Драйвер устройства и промежуточные драйверы должны установить этот указатель на **значение NULL**.

</dd> <dt>

*Апкконтекст* \[ в необязательное\]
</dt> <dd>

Этот параметр зарезервирован. Драйвер устройства и промежуточные драйверы должны установить этот указатель на **значение NULL**.

</dd> <dt>

*Иостатусблокк* \[ заполняет\]
</dt> <dd>

Указатель на структуру [**\_ \_ блока состояния ввода-вывода**](/windows-hardware/drivers/ddi/wdm/ns-wdm-_io_status_block) , которая получает конечное состояние завершения и сведения о запрошенной операции чтения. **Информационный** элемент получает число байтов, фактически считанных из файла.

</dd> <dt>

*Буфер* \[ заполняет\]
</dt> <dd>

Указатель на выделенный вызывающим объектом буфер, который получает данные, считанные из файла.

</dd> <dt>

*Длина* \[ окне\]
</dt> <dd>

Размер (в байтах) буфера, на который указывает *буфер*.

</dd> <dt>

*ByteOffset* \[ в необязательное\]
</dt> <dd>

Указатель на переменную, которая указывает начальное смещение в байтах в файле, с которого начнется операция чтения. Если предпринимается попытка чтения после конца файла, **нтреадфиле** возвращает ошибку.

Если при вызове [**NtCreateFile**](/windows/desktop/api/Winternl/nf-winternl-ntcreatefile) задано одно из  \_ оповещений о синхронном вводе-выводе в файле ФЛАГов КРЕАТЕОПТИОНС \_ \_ или \_ \_ \_ неоповещение файла, диспетчер ввода-вывода сохраняет текущее расположение файла. Если это так, вызывающий объект **нтреадфиле** может указать, что вместо явного значения *ByteOffset* должно использоваться текущее смещение позиции файла. Эту спецификацию можно выполнить с помощью одного из следующих методов.

-   Укажите указатель на **большое \_ целое** значение, в котором элемент **хигхпарт** имеет значение-1, а для элемента **ловпарт** — в качестве системного файла значений \_ используется \_ \_ расположение указателя файла \_ .

-   Передайте **пустой** указатель для *ByteOffset*.

**Нтреадфиле** обновляет текущее расположение файла, добавляя число байтов, считанных при завершении операции чтения, если она использует текущее расположение файла, поддерживаемое диспетчером ввода-вывода.

Даже если диспетчер ввода-вывода сохраняет текущую позицией в файле, вызывающий объект может сбросить эту точку, передав явное значение *ByteOffset* в **нтреадфиле**. Это автоматически изменяет текущее расположение файла на это значение *ByteOffset* , выполняет операцию чтения, а затем обновляет расположение в соответствии с числом фактически считанных байтов. Этот метод предоставляет вызывающему объекту атомарную службу поиска и чтения.

</dd> <dt>

*Ключ* \[ в необязательное\]
</dt> <dd>

Драйвер устройства и промежуточные драйверы должны установить этот указатель на **значение NULL**.

</dd> </dl>

## <a name="return-value"></a>Возвращаемое значение

**Нтреадфиле** ВОЗВРАЩАЕТ либо состояние \_ Success, либо соответствующий код ошибки NTSTATUS.

## <a name="remarks"></a>Remarks

Вызывающие объекты **нтреадфиле** должны уже называться [**NtCreateFile**](/windows/desktop/api/Winternl/nf-winternl-ntcreatefile) с ФАЙЛОМ \_ Read \_ Data или универсальным \_ чтением значения, заданным в параметре *десиредакцесс* .

Если предыдущий вызов [**NtCreateFile**](/windows/desktop/api/Winternl/nf-winternl-ntcreatefile) устанавливает \_ флаг File No \_ промежуточной \_ буферизации в параметре *креатеоптионс* в **NtCreateFile**, параметры *length* и *ByteOffset* для **нтреадфиле** должны быть кратны размеру сектора. Дополнительные сведения см. в разделе **NtCreateFile**.

**Нтреадфиле** начинает чтение из заданной *ByteOffset* или текущего расположения файла в заданном *буфере*. Операция чтения завершается одним из следующих условий:

-   Буфер заполнен, так как было считано число байтов, указанное параметром *длины* . Таким образом, больше данных нельзя поместить в буфер без переполнения.

-   Конец файла достигнут во время операции чтения, поэтому в этом файле больше нет данных для передачи в буфер.

Если вызывающий объект открыл файл с флагом SYNCHRONIZE, установленным в *десиредакцесс*, вызывающий поток может синхронизироваться с завершением операции чтения, ожидая обработки файла *FileHandle*. Дескриптор получает сигнал каждый раз, когда завершается операция ввода-вывода, выполненная над дескриптором. Однако вызывающий объект не должен ждать обработчика, открытого для синхронного доступа к файлам ( \_ \_ \_ предупреждение о непредупреждении или синхронных операциях ввода-вывода файлов \_ \_ \_ ). В этом случае **нтреадфиле** ожидает от имени вызывающего объекта и не возвращает значение до завершения операции чтения. Вызывающий объект может безопасно ожидать обработку файла, только если выполняются все три следующих условия.

-   Маркер был открыт для асинхронного доступа (т. е. не \_ \_ задан флаг синхронного ввода-вывода \_ *xxx* ).

-   Этот маркер используется только для одной операции ввода-вывода за раз.

-   **Нтреадфиле** вернул состояние " \_ Ожидание".

Драйвер должен вызывать **нтреадфиле** в контексте системного процесса, если выполняется одно из следующих условий.

-   Драйвер создал файловый обработчик, который он передает в **нтреадфиле**.

-   **Нтреадфиле** будет уведомлять драйвер о завершении ввода-вывода с помощью события, созданного драйвером.

-   **Нтреадфиле** будет уведомлять драйвер о завершении ввода-вывода с помощью подпрограммы обратного вызова APC, которую драйвер передает в **нтреадфиле**.

Дескрипторы файлов и событий допустимы только в контексте процесса, где создаются дескрипторы. Поэтому, чтобы избежать брешей в системе безопасности, драйвер должен создать любой файл или обработчик событий, который он передает в **нтреадфиле** в контексте системного процесса, а не контекста процесса, в котором находится драйвер.

Аналогичным образом **нтреадфиле** должен вызываться в контексте системного процесса, если он уведомляет драйвер о завершении ввода-вывода с помощью APC, поскольку APC всегда срабатывают в контексте потока, который выдает запрос ввода-вывода. Если драйвер вызывает **нтреадфиле** в контексте процесса, отличного от системы, то компания APC может быть отложена неограниченное время или вообще не сработать.

Дополнительные сведения о работе с файлами см. [в разделе Использование файлов в драйвере](/windows-hardware/drivers/kernel/using-files-in-a-driver).

Вызывающие объекты **нтреадфиле** должны выполняться на уровне IRQL = пассивный \_ уровень, а также [включить специальный APC ядра](/windows-hardware/drivers/kernel/disabling-apcs).

## <a name="requirements"></a>Требования



| Требование | Значение |
|-------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------|
| Минимальная версия клиента<br/> | Windows 2000 Professional \[только классические приложения\]<br/>                                                                              |
| Минимальная версия сервера<br/> | Windows 2000 Server \[только классические приложения\]<br/>                                                                                    |
| Целевая платформа<br/>          | <dl> <dt>[Универсальное](https://msdn.microsoft.com/Library/Windows/Hardware/EB2264A4-BAE8-446B-B9A5-19893936DDCA)</dt> </dl> |
| Заголовок<br/>                   | <dl> <dt>WDM. h (включает WDM. h, Нтддк. h или Нтифс. h)</dt> </dl>                   |
| Библиотека<br/>                  | <dl> <dt>NTDLL. lib</dt> </dl>                                                    |
| DLL<br/>                      | <dl> <dt>Ntdll.dll (пользовательский режим)</dt> </dl>                                        |



## <a name="see-also"></a>См. также раздел

<dl> <dt>

[**кеинитиализивент**](/windows-hardware/drivers/ddi/wdm/nf-wdm-keinitializeevent)
</dt> <dt>

[**NtCreateFile**](/windows/desktop/api/Winternl/nf-winternl-ntcreatefile)
</dt> <dt>

[**нткуеринформатионфиле**](/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntqueryinformationfile)
</dt> <dt>

[**нтсетинформатионфиле**](/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntsetinformationfile)
</dt> <dt>

[**нтвритефиле**](/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntwritefile)
</dt> </dl>

 

 
