---
description: Поиск секций во время активации
ms.assetid: a5452ed6-ab0f-4d38-bc16-1de6cbf57486
title: Поиск секций во время активации
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 58e8912c8277d79c1a20300a1a880644801d0bcb
ms.sourcegitcommit: bf526e267d3991892733bdd229c66d5365cf244a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/05/2021
ms.locfileid: "104557394"
---
# <a name="locating-partitions-during-activation"></a>Поиск секций во время активации

Поиск нужной секции, в которой активируется компонент, зависит от следующих факторов.

-   Вызов функции и параметры, используемые в вызывающей программе для активации компонента
-   Является ли активируемый компонент локальным или удаленным
-   Внутреннее использование кэша секций

## <a name="the-calling-program"></a>Вызывающая программа

COM+ выбирает секцию для активации компонента в зависимости от того, как вызывающая программа активирует компонент.

При выборе секции для активации компонентов можно выполнить три разных действия. Выполняемое действие зависит от того, как вызывающая программа создает экземпляр объекта, т. е. является ли вызов функции моникером секции, который состоит из идентификатора секции и идентификатора CLSID или включает только идентификатор CLSID.

В следующей таблице показаны различные действия, которые может выполнять COM+ в порядке приоритета для определения местоположения секции.



| Вызов функции                                                  | Параметр                                                      | Действие COM+                                                                                                                                                                                    |
|----------------------------------------------------------------|----------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [**Кожетобжект**](/windows/desktop/api/objbase/nf-objbase-cogetobject) или **GetObject**<br/> | Моникер секции (включает идентификатор секции и CLSID)<br/> | Использует идентификатор секции, указанный в моникере секции.<br/>                                                                                                                           |
| [**CoCreateInstance**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreateinstance)<br/>        | CLSID<br/>                                               | Использует идентификатор секции по умолчанию для раздела удостоверения пользователя или идентификатор секции, добавленный в контекст во время активации предыдущей версии компонента в том же процессе.<br/> |



 

Действия COM+, перечисленные в предыдущей таблице, описаны в следующих разделах.

## <a name="use-of-partition-monikers"></a>Использование моникеров секций

Секцию можно явно выбрать в вызове функции с помощью *моникера секции*. Моникер секции используется в коде для явного указания секции активированного компонента. Если моникер секции используется для нахождение секции, активация происходит из этого раздела. То есть идентификатор секции, включенный в моникер, имеет приоритет над разделом пользователя по умолчанию или с ИДЕНТИФИКАТОРом секции, который существует в контексте вызывающего.

В коде C++ синтаксис для использования моникера секции выглядит следующим образом:


```C++
HRESULT CoGetObject(
  L"partition:partitionGUID/new:clsid",
  pBindOptions,
  IID_IUnknown,
  (void**)&pIUnknown);
```



В следующем примере показан фрагмент кода C++, в котором моникер секции используется в качестве аргумента функции [**кожетобжект**](/windows/desktop/api/objbase/nf-objbase-cogetobject) :


```C++
// Create CLSID1 configured in the Production partition.
HRESULT hr = CoGetObject(
  L"partition:{35056070-D5B7-4b59-9FBF-0D23417F6937}/new:CLSID1",
  pBindOptions, IID_IUnknown, (void**)&pIUnknown);
```



В Visual Basic коде синтаксис для моникера секции выглядит следующим образом:


```VB
GetObject("partition:partitionGUID/new:CLSID") As Object
```



В следующем примере показан фрагмент кода Visual Basic, в котором моникер секции используется в качестве аргумента функции **GetObject** :


```VB
Dim objCLSID1 As Object
Set objCLSID1 = GetObject( _
   "partition:{35056070-D5B7-4b59-9FBF-0D23417F6937}/new:CLSID1")
```



## <a name="use-of-default-mapping"></a>Использование сопоставления по умолчанию

Если функция [**CoCreateInstance**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreateinstance) используется для активации компонента с помощью CLSID компонента, com+ использует сопоставление удостоверений пользователя по умолчанию, то есть набор секций, с которым пользователь сопоставлен в Active Directory. Однако если пользователь не сопоставлен с набором разделов в Active Directory, выбирается глобальный раздел.

## <a name="use-of-partition-ids-and-object-context"></a>Использование идентификаторов секций и контекста объектов

Одним из пяти свойств, назначенных новой секции, является идентификатор секции. Когда клиентская программа вызывает функцию [**CoCreateInstance**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreateinstance) для создания экземпляра объекта, идентификатор секции добавляется в контекст. Использование идентификатора секции из контекста для нахождения секции имеет важное значение, так как гарантирует, что после начала цепочки активаций идентификатор секции остается прежним, если он не был явно изменен через моникер раздела.

Дополнительные сведения о расположении секций во время активации см. в разделе [com+ Queued Components and partitions](com--queued-components-and-partitions.md).

## <a name="local-and-remote-activation"></a>Локальная и удаленная активация

-   Если вызываемый компонент существует на другом компьютере, то свойства раздела (включая идентификатор секции) маршалируются на другой компьютер, а компонент активируется из упакованной секции. Если идентификатор секции не был маршалирован, COM+ использует набор разделов по умолчанию, сопоставленный с удостоверением пользователя в Active Directory.

## <a name="the-partition-cache"></a>Кэш секций

В среде домена COM+ использует сопоставления в Active Directory, чтобы выбрать правильный раздел для активации компонента. Однако частое Поиск в Active Directory может привести к чрезмерному использованию сетевого трафика. Для снижения сетевого трафика, полученного в результате частого поиска сопоставления "пользователь-Секция-набор" в Active Directory, COM+ использует *кэш секций*.

Кэш разделов содержит сопоставления, которые были сделаны в Active Directory между удостоверениями пользователей или подразделениями и их наборами секций. Этот кэш разделов находится на сервере приложений, на котором находятся приложения COM+.

Когда COM+ необходимо определить раздел пользователя по умолчанию или проверить права доступа пользователя к секции, он проверяет локальный кэш разделов для поиска сопоставления пользователя, а не проверяет Active Directory удаленно.

Если поиск в кэше секций завершается сбоем, COM+ проверяет Active Directory. Если поиск выполнен в Active Directory, COM+ сохраняет это сопоставление в кэше разделов. При следующем выполнении уточняющего запроса для сопоставления пользователя и секции COM+ обнаружит его в кэше разделов.

На следующем рисунке показан процесс, используемый COM+ для размещения секции для активации компонента.

![Схема, на которой показано дерево устранения неполадок для процесса, используемого COM+ для поиска секции для активации компонента.](images/5d00eb4e-4572-491c-85e9-33ceed2cd753.png)

Размер кэша и срок действия для записей кэша задаются с помощью разделов реестра. Сведения о настройке этих разделов реестра см. в разделе [Создание и Настройка разделов COM+](creating-and-configuring-com--partitions.md).

> [!Note]  
> Если компьютер сервера отключается от сети и сопоставление пользователя с Секцией изменяется в то время, когда сервер отключен, то кэш разделов может содержать устаревшее сопоставление пользователя с секцией. Это может привести к ошибке активации, если сопоставление пользователя с Секцией является механизмом, используемым для активации компонента.

 

## <a name="related-topics"></a>См. также

<dl> <dt>

[Поиск компонента для активации](locating-a-component-for-activation.md)
</dt> </dl>

 

