---
description: Сервер-источник позволяет клиенту получить точную версию исходных файлов, которые использовались для построения приложения.
ms.assetid: c7bf51ce-7fb4-49aa-ad33-e551b2c8362b
title: Исходный сервер
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5b3d8d76c70b67c176126d8e424bd5b55b616697
ms.sourcegitcommit: bfb5d94f754d017307b4cc9d914a2716701331d1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105656723"
---
# <a name="source-server"></a>Исходный сервер

Сервер-источник позволяет клиенту получить точную версию исходных файлов, которые использовались для построения приложения. Поскольку исходный код модуля может изменяться в разных версиях и в течение нескольких лет, важно взглянуть на исходный код, который существовал при построении рассматриваемой версии модуля.

Исходный сервер получает соответствующие файлы из системы управления версиями. Для использования исходного сервера приложение должно быть индексировано в исходном виде.

## <a name="source-indexing"></a>Индексирование исходного кода

Исходная система индексации представляет собой коллекцию исполняемых файлов и скриптов Perl. Для сценариев Perl требуется Perl 5,6 или более поздней версии.

Как правило, двоичные файлы индексируются в процессе сборки после построения приложения. Сведения, необходимые исходному серверу, хранятся в PDB-файлах.

Сервер исходного кода в настоящее время поставляется со сценариями, которые должны работать со следующими системами управления версиями.

-   Team Foundation Server
-   перфорце
-   Visual SourceSafe
-   CVS
-   Subversion

Можно также создать пользовательский скрипт для индексирования кода для другой системы управления версиями.

В следующей таблице перечислены средства исходного сервера.



| Средство        | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|-------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Srcsrv.ini  | Этот файл является главным списком всех серверов системы управления версиями. Каждая запись имеет следующий формат:*MYSERVER* = *ServerInfo*<br/> При использовании Перфорце сведения о сервере состоят из полного сетевого пути к серверу, за которым следует двоеточие, за которым следует номер порта, который он использует. Пример:<br/> MYSERVER = Machine. Corp. Company. com: 1666<br/> Этот файл можно установить на компьютере, на котором работает отладчик. При запуске исходного сервера он просматривает Srcsrv.ini для значений; Эти значения будут переопределять сведения, содержащиеся в PDB-файле. Это позволяет пользователям настроить отладчик для использования другого сервера системы управления версиями во время отладки.<br/> Дополнительные сведения см. в примере Srcsrv.ini установлен с помощью средств исходного сервера.<br/> |
| SSINDEX. cmd | Этот сценарий создает список файлов, возвращенных в систему управления версиями, и сведения о версии каждого файла. Он сохраняет подмножество этих сведений в PDB-файлах, созданных при построении приложения. Скрипт использует один из следующих модулей Perl для взаимодействия с системой управления версиями: P4.pm (Перфорце) или Vss.pm (исходный код — надежный). Для получения дополнительных сведений запустите сценарий с параметром-?. или-?? (подробное описание справки) или просмотрите скрипт.<br/>                                                                                                                                                                                                                                                                                                             |
| Srctool.exe | Эта программа отображает список всех файлов, проиндексированных в PDB-файле. Для каждого файла отображается полный путь, сервер системы управления версиями и номер версии файла. Эти сведения можно использовать для получения файлов без использования исходного сервера. Для получения дополнительных сведений запустите программу с параметром/?. (Создайте ветвь для и запустите запрос на вытягивание).<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| Pdbstr.exe  | Эта программа используется скриптами индексирования для вставки сведений системы управления версиями в альтернативный поток "SRCSRV" целевого PDB-файла. Он также может считывать любой поток из PDB-файла. Эти сведения можно использовать для проверки правильности работы сценариев индексирования. Для получения дополнительных сведений запустите программу с параметром/?. (Создайте ветвь для и запустите запрос на вытягивание).<br/>                                                                                                                                                                                                                                                                                                                                                                                                                          |



 

## <a name="retrieving-the-source-file"></a>Получение исходного файла

API DbgHelp предоставляет доступ к функциям исходного сервера с помощью функции [**симжетсаурцефиле**](/windows/desktop/api/Dbghelp/nf-dbghelp-symgetsourcefile) . Чтобы получить имя исходного файла для извлечения, вызовите функцию [**сименумсаурцефилес**](/windows/desktop/api/DbgHelp/nf-dbghelp-symenumsourcefiles) или [**SymGetLineFromAddr64**](/windows/desktop/api/Dbghelp/nf-dbghelp-symgetlinefromaddr) .

## <a name="using-source-server-with-a-debugger"></a>Использование исходного сервера с отладчиком

Чтобы использовать исходный сервер с WinDbg, KD, NTSD или CDB, убедитесь, что установлена последняя версия пакета средств отладки для Windows (версия 6,3 или более поздняя). Затем включите SRV \* в команду. сркпас следующим образом:

**\. сркпас SRV \* ;** _c: \\ mysource_

Обратите внимание, что этот пример также включает традиционный исходный путь. Если отладчику не удается получить файл с исходного сервера, он будет искать по указанному пути.

Если исходный файл извлекается исходным сервером, он остается на жестком диске после завершения сеанса отладки. Исходные файлы хранятся локально в подкаталоге src в каталоге установки средств отладки для Windows.

## <a name="source-server-data-blocks"></a>Блоки данных на исходном сервере

Исходный сервер использует два блока данных в PDB-файле.

-   Список исходных файлов. При построении модуля автоматически создается список полных путей к исходным файлам, используемым для построения модуля.
-   Блок данных. При индексировании источника, как описано выше, добавляется альтернативный поток в PDB-файл с именем «srcsrv». Скрипт, который вставляет эти данные, зависит от конкретного процесса сборки и используемой системы управления версиями.

В спецификации языка версии 1 блок данных разделен на три раздела: ini, Variables и Source Files. Он имеет следующий синтаксис.

``` syntax
SRCSRV: ini ------------------------------------------------ 
VERSION=1
VERCTRL=<source_control_str>
DATETIME=<date_time_str>
SRCSRV: variables ------------------------------------------ 
SRCSRVTRG=%sdtrg% 
SRCSRVCMD=%sdcmd% 
SRCSRVENV=var1=string1\bvar2=string2 
DEPOT=//depot 
SDCMD=sd.exe -p %fnvar%(%var2%) print -o %srcsrvtrg% -q %depot%/%var3%#%var4%
SDTRG=%targ%\%var2%\%fnbksl%(%var3%)\%var4%\%fnfile%(%var1%) 
WIN_SDKTOOLS= sserver.microsoft.com:4444 
SRCSRV: source files --------------------------------------- 
<path1>*<var2>*<var3>*<var4> 
<path2>*<var2>*<var3>*<var4> 
<path3>*<var2>*<var3>*<var4> 
<path4>*<var2>*<var3>*<var4> 
SRCSRV: end ------------------------------------------------
```

Весь текст интерпретируется буквально, за исключением текста, заключенного в знаки процента (%). Текст, заключенный в знаки процента, рассматривается как имя переменной для разрешения рекурсивно, если только это не одна из следующих функций:

<dl> <dt>

<span id="_fnvar___"></span><span id="_FNVAR___"></span>% фнвар%()
</dt> <dd>

Текст параметра должен быть заключен в знаки процента и обрабатываться как переменная для расширения.

</dd> <dt>

<span id="_fnbksl___"></span><span id="_FNBKSL___"></span>% фнбксл%()
</dt> <dd>

Все косые черты (/) в тексте параметра должны быть заменены обратной косой чертой ( \\ ).

</dd> <dt>

<span id="_fnfile___"></span><span id="_FNFILE___"></span>% фнфиле%()
</dt> <dd>

Все сведения о пути в тексте параметра должны быть удалены, и останется только имя файла.

</dd> </dl>

В разделе ini содержатся переменные, описывающие требования. Скрипт индексирования может добавлять в этот раздел любое количество переменных. Ниже приведены примеры.

<dl> <dt>

<span id="VERSION"></span><span id="version"></span>Версия
</dt> <dd>

Версия спецификации языка. Это обязательная переменная.

</dd> <dt>

<span id="VERCTL"></span><span id="verctl"></span>верктл
</dt> <dd>

Строка, описывающая продукт системы управления версиями. Эта переменная является необязательной.

</dd> <dt>

<span id="DATETIME"></span><span id="datetime"></span>DATETIME
</dt> <dd>

Строка, указывающая дату и время обработки PDB-файла. Эта переменная является необязательной.

</dd> </dl>

Раздел variables содержит переменные, описывающие извлечение файла из системы управления версиями. Он также может использоваться для определения часто используемого текста в качестве переменных для уменьшения размера блока данных.

<dl> <dt>

<span id="SRCSRVTRG"></span><span id="srcsrvtrg"></span>срксрвтрг
</dt> <dd>

Описывает, как создать целевой путь для извлеченного файла. Это обязательная переменная.

</dd> <dt>

<span id="SRCSRVCMD"></span><span id="srcsrvcmd"></span>срксрвкмд
</dt> <dd>

Описывает, как создать команду для извлечения файла из системы управления версиями. Сюда входит имя исполняемого файла и параметры командной строки. Это обязательная переменная.

</dd> <dt>

<span id="SRCSRVENV"></span><span id="srcsrvenv"></span>срксрвенв
</dt> <dd>

Строка, в которой перечислены переменные среды, создаваемые при извлечении файлов. Разделяйте несколько записей символом Backspace ( \\ b). Это необязательная переменная.

</dd> </dl>

В разделе исходные файлы содержится запись для каждого индексируемого исходного файла. Содержимое каждой строки интерпретируется как переменные с именами VAR1, VAR2, VAR3 и т. д. до VAR10. Переменные разделяются звездочками. Параметр VAR1 должен указывать полный путь к исходному файлу, как указано в других местах PDB-файла. Например, следующая строка:

``` syntax
c:\proj\src\file.cpp*TOOLS_PRJ*tools/mytool/src/file.cpp*3
```

интерпретируется следующим образом:

``` syntax
VAR1=c:\proj\src\file.cpp
VAR2=TOOLS_PRJ
VAR3=tools/mytool/src/file.cpp
VAR4=3
```

В этом примере VAR4 — номер версии. Однако большинство систем управления версиями поддерживают метки файлов таким образом, чтобы можно было восстановить исходное состояние для данной сборки. Таким образом, можно также использовать метку для сборки. Образец блока данных можно изменить, чтобы он содержал переменную, как показано ниже:

``` syntax
LABEL=BUILD47
```

Затем, предполагается, что система управления версиями использует знак @ для обозначения метки, можно изменить переменную СРКСРВКМД следующим образом:

**sd.exe-p% фнвар%(% var2%) Print-o% срксрвтрг%-q% хранилище%/%var3% @% метка%**

## <a name="how-source-server-works"></a>Принцип работы сервера исходного кода

Клиент исходного сервера реализуется в Symsrv.dll. Клиент не извлекает сведения непосредственно из PDB-файла; в нем используется обработчик символов, например, реализованный в Dbghelp.dll. По сути, это подсистема подстановки рекурсивных переменных, которая создает командную строку, которую можно использовать для извлечения правильного исходного файла из системы управления версиями. Код не должен вызывать Symsrv.dll напрямую. Чтобы интегрировать функциональные возможности в приложение, используйте функцию [**симжетсаурцефиле**](/windows/desktop/api/Dbghelp/nf-dbghelp-symgetsourcefile) .

Первая версия исходного сервера работает следующим образом. Это поведение может измениться в будущих версиях.

-   Клиент вызывает функцию **срксрвинит** с целевым путем для использования в качестве основы для всех извлечений исходных файлов. Этот путь сохраняется в переменной коне.
-   Клиент извлекает поток SRCSRV из PDB-файла при загрузке модуля PDB и вызывает функцию **срксрвлоадмодуле** для передачи блока данных на исходный сервер.
-   Когда DBGHELP извлекает исходный файл, клиент вызывает функцию **срксрвжетфиле** для получения исходных файлов из системы управления версиями.
-   Исходный сервер выполняет поиск записи, соответствующей запрошенному файлу, в записи в блоке данных в файле исходного кода. Он заполняет параметр VAR1 на VAR *n* содержимым записи с исходным файлом. Затем она расширяет переменную СРКСРВТРГ, используя VAR1 для VAR *n*. Если файл уже находится в этом расположении, он возвращает расположение вызывающему объекту. В противном случае он расширяет переменную СРКСРВКМД для создания команды, необходимой для получения файла из системы управления версиями и его копирования в целевое расположение. Наконец, он выполняет эту команду.

## <a name="creating-a-source-control-provider-module"></a>Создание модуля поставщика системы управления версиями

Исходный сервер включает модули поставщика для Перфорце (p4.pm) и Visual Source Сейф (vss.pm). Чтобы создать собственный модуль поставщика, необходимо реализовать следующий набор интерфейсов.

<dl> <dt>

<span id="_module__SimpleUsage__"></span><span id="_module__simpleusage__"></span><span id="_MODULE__SIMPLEUSAGE__"></span>**$module:: Симплеусаже ()**
</dt> <dd>

Назначение. отображает сведения об использовании простых модулей в STDOUT.

Параметры: нет

Возвращаемое значение: нет

</dd> <dt>

<span id="_module__VerboseUsage__"></span><span id="_module__verboseusage__"></span><span id="_MODULE__VERBOSEUSAGE__"></span>**$module:: Вербосеусаже ()**
</dt> <dd>

Назначение. отображает подробные сведения об использовании модуля в STDOUT.

Параметры: нет

Возвращаемое значение: нет

</dd> <dt>

<span id="_objref____module__new__CommandArguments_"></span><span id="_objref____module__new__commandarguments_"></span><span id="_OBJREF____MODULE__NEW__COMMANDARGUMENTS_"></span>**$objref = $module:: New ( \@ коммандаргументс)**
</dt> <dd>

Назначение. Инициализирует экземпляр модуля поставщика.

Parameters: все @ARGV аргументы, не распознаваемые SSIndex. cmd как общие аргументы.

Возвращаемое значение: ссылка, которую можно использовать в последующих операциях.

</dd> <dt>

<span id="_objref-_GatherFileInformation__SourcePath___ServerHashReference_"></span><span id="_objref-_gatherfileinformation__sourcepath___serverhashreference_"></span><span id="_OBJREF-_GATHERFILEINFORMATION__SOURCEPATH___SERVERHASHREFERENCE_"></span>**$objref->Гасерфилеинформатион ($SourcePath, $ServerHashReference)**
</dt> <dd>

Назначение. позволяет модулю собирать требуемые исходные сведения об индексировании для каталога, указанного параметром $SourcePath. Модуль не должен считать, что эта запись будет вызываться только один раз для каждого экземпляра объекта, так как SSIndex. cmd может вызывать его несколько раз для разных путей.

Параметры: (1) локальный каталог, содержащий индексируемый источник. (2) ссылка на хэш, содержащий все записи из указанного файла Srcsrv.ini.

Возвращаемое значение: нет

</dd> <dt>

<span id="__VariableHashReference___FileEntry_____objref-_GetFileInfo__LocalFile_"></span><span id="__variablehashreference___fileentry_____objref-_getfileinfo__localfile_"></span><span id="__VARIABLEHASHREFERENCE___FILEENTRY_____OBJREF-_GETFILEINFO__LOCALFILE_"></span>**($VariableHashReference, $FileEntry) = $objref->FileInfo ($LocalFile)**
</dt> <dd>

Назначение. предоставляет необходимые сведения для извлечения одного конкретного файла из системы управления версиями.

Параметры: полное имя файла

Возвращаемое значение: (1) хэш-ссылка на переменные, необходимые для интерпретации возвращаемого $FileEntry. SSIndex. cmd кэширует эти переменные для каждого исходного файла, используемого одним файлом отладки, чтобы уменьшить объем данных, записываемых в поток исходного индекса. (2) запись файла, записываемого в поток исходного индекса, чтобы разрешить SrcSrv.dll извлечение этого файла из системы управления версиями. Точный формат этой строки зависит от системы управления версиями.

</dd> <dt>

<span id="_TextString____objref-_LongName__"></span><span id="_textstring____objref-_longname__"></span><span id="_TEXTSTRING____OBJREF-_LONGNAME__"></span>**$TextString = $objref->LongName ()**
</dt> <dd>

Назначение. предоставляет описательную строку для обнаружения поставщика системы управления версиями для конечного пользователя.

Параметры: нет

Возвращаемое значение: описательное имя системы управления версиями.

</dd> <dt>

<span id="_StreamVariableLines____objref-_SourceStreamVariables__"></span><span id="_streamvariablelines____objref-_sourcestreamvariables__"></span><span id="_STREAMVARIABLELINES____OBJREF-_SOURCESTREAMVARIABLES__"></span>**@StreamVariableLines = $objref->Саурцестреамвариаблес ()**
</dt> <dd>

Назначение. позволяет поставщику системы управления версиями добавлять определенные переменные системы управления версиями в исходный поток для каждого файла отладки. В примерах модулей этот метод используется для записи требуемой \_ команды Extract и извлечения \_ целевых переменных.

Параметры: нет

Возвращаемое значение: список записей для переменных исходного потока.

</dd> </dl>

 

 




