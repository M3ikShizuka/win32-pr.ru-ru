---
description: Виртуализация реестра — это технология совместимости приложений, которая позволяет выполнять операции записи в реестре, которые имеют глобальное влияние на расположение пользователей.
ms.assetid: dace2f65-df60-419a-8be8-ab60668e6396
title: Виртуализация реестра
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f14d8a82a12be74d3c5f2963e8b4edf47baaa85c4a8299e4ff632284bbac83fb
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "117763591"
---
# <a name="registry-virtualization"></a>Виртуализация реестра

*Виртуализация реестра* — это технология совместимости приложений, которая позволяет выполнять операции записи в реестре, которые имеют глобальное влияние на расположение пользователей. Это перенаправление прозрачно для приложений, читающих или записывающих в реестр. он поддерживается начиная с Windows Vista.

Такая форма виртуализации является промежуточной технологией обеспечения совместимости приложений. корпорация майкрософт планирует удалить ее из будущих версий Windows операционной системы, так как другие приложения совместимы с Windows Vista и более поздними версиями Windows. Поэтому важно, чтобы ваше приложение не зависело от поведения виртуализации реестра в системе.

Виртуализация предназначена только для обеспечения совместимости с существующими приложениями. приложения, разработанные для Windows Vista и более поздних версий Windows, не должны выполнять запись в конфиденциальные системные области, а также должны использовать виртуализацию для устранения любых проблем. при обновлении существующего кода для работы в Windows Vista и более поздних версиях Windows разработчики должны убедиться, что приложения хранят данные только в расположениях пользователей или в расположениях компьютеров в% аллусерпрофиле%, которые должным образом используют список управления доступом (ACL).

Дополнительные сведения о создании приложений, совместимых с UAC, см. в разделе [руководств разработчика UAC](/previous-versions/dotnet/articles/aa480150(v=msdn.10)).

## <a name="virtualization-overview"></a>Обзор виртуализации

до Windows Vista приложения обычно выполнялись администраторами. В результате приложения могут свободно обращаться к системным файлам и разделам реестра. Если эти приложения были запущены обычным пользователем, они завершатся сбоем из-за недостаточных прав доступа. Windows в Vista и более поздних версиях Windows улучшить совместимость приложений для этих приложений путем автоматического перенаправления этих операций. Например, операции с реестром в глобальном хранилище (**hKey для \_ локального \_ компьютера \\**) перенаправляются на расположение пользователя в профиле пользователя, известном как *виртуальное хранилище* (**hKey \_ Users \\ <User SID> \_ Classes \\ виртуалсторе \\ Machine \\ Software**).

Виртуализация реестра может быть широко классифицирована в следующих типах:

<dl> <dt>

<span id="Open_Registry_Virtualization"></span><span id="open_registry_virtualization"></span><span id="OPEN_REGISTRY_VIRTUALIZATION"></span>Открыть виртуализацию реестра
</dt> <dd>

Если вызывающий объект не имеет доступа на запись в ключ и пытается открыть этот ключ, он открывается с максимально допустимым доступом для этого вызывающего объекта.

Если \_ \_ \_ \_ для ключа задан флаг reg key не, то операция завершается ошибкой и ключ не открывается. Дополнительные сведения см. в подразделе «Управление виртуализацией реестра» далее в этой статье.

</dd> <dt>

<span id="Write_Registry_Virtualization"></span><span id="write_registry_virtualization"></span><span id="WRITE_REGISTRY_VIRTUALIZATION"></span>Записать виртуализацию реестра
</dt> <dd>

Если вызывающий объект не имеет доступа на запись в ключ и пытается записать в него значение или создать подраздел, значение записывается в виртуальное хранилище.

Например, если пользователь с ограниченным доступом попытается записать значение в следующий раздел: **hKey \_ Local \_ Machine \\ Software** \\ *AppKey1*, виртуализация перенаправит операцию записи в **классы hKey \_ Пользователи \\ <User SID> \_ \\ виртуалсторе \\ Machine \\ Software** \\ *AppKey1*.

</dd> <dt>

<span id="Read_Registry_Virtualization"></span><span id="read_registry_virtualization"></span><span id="READ_REGISTRY_VIRTUALIZATION"></span>Считывание виртуализации реестра
</dt> <dd>

Если вызывающий объект считывает данные из виртуализированного ключа, реестр представляет объединенное представление как виртуализированных значений (из виртуального хранилища), так и невиртуальных значений (из глобального хранилища) вызывающему объекту.

Например, предположим, что в разделе " **\_ \_ \\ программное обеспечение на локальном компьютере**" \\ *AppKey1* содержится два значения версий 1 и 2, а ограниченный пользователь записывает в ключ значение v3. Когда пользователь пытается прочитать значения из этого ключа, объединенное представление включает в себя значения v1 и v2 из глобального хранилища и значение v3 из виртуального хранилища.

Обратите внимание, что виртуальные значения имеют приоритет над глобальными значениями при их наличии. В приведенном выше примере, даже если глобальное хранилище имело значение v3 в этом ключе, значение v3 по-прежнему будет возвращаться вызывающему объекту из виртуального хранилища. Если значение v3 было удалено из виртуального хранилища, то значение v3 будет возвращено из глобального хранилища. Другими словами, если параметр v3 должен быть удален из **\_ классов пользователей hKey \\ <User SID> \_ \\ виртуалсторе \\ Machine \\ Software** \\ *AppKey1* , но в **hKey \_ Local \_ Machine \\ Software** \\ *AppKey1* имело значение v3, это значение будет возвращено из глобального хранилища.

</dd> </dl>

## <a name="registry-virtualization-scope"></a>Область виртуализации реестра

Виртуализация реестра включена только в следующих целях:

-   32-разрядные интерактивные процессы.
-   Ключи в **\_ \_ \\ программном обеспечении для локального компьютера hKey**.
-   Ключи, в которые администратор может выполнять запись. (если администратор не может выполнить запись в раздел, то приложение не будет работать в предыдущих версиях Windows даже если оно было запущено администратором.)

Виртуализация реестра отключена для следующих параметров:

-   64-разрядные процессы.
-   Неинтерактивные процессы, например службы.

    Обратите внимание, что использование реестра в качестве механизма межпроцессного взаимодействия (IPC) между службой (или любым другим процессом, на котором не включена виртуализация) и приложение не будет работать правильно, если ключ виртуализирован. Например, если антивирусная служба обновляет свои файлы сигнатур на основе значения, установленного приложением, служба никогда не обновит свои файлы сигнатур, так как служба считывает из глобального хранилища, но приложение записывает данные в виртуальное хранилище.

-   Процессы, имитирующие пользователя. Если процесс пытается выполнить операцию при олицетворении пользователя, эта операция не будет виртуализирована.
-   Процессы в режиме ядра, такие как драйверы.
-   Процессы с **requestedExecutionLevel** , указанными в их манифестах.
-   ключи и подразделы **\_ \_ \\ \\ классов программного обеспечения hkey** на локальном компьютере, **hkey \_ local machine \_ \\ software \\ microsoft \\ Windows** и **HKEY \_ local \_ machine \\ software \\ microsoft \\ Windows NT**.

## <a name="controlling-registry-virtualization"></a>Управление виртуализацией реестра

Помимо управления виртуализацией на уровне приложения с помощью **requestedExecutionLevel** в манифесте, администратор может включить или отключить виртуализацию на основе ключа для ключей в **\_ \_ \\ программном обеспечении на локальном компьютере** в разделе hKey. Для этого используйте параметр программы командной строки Reg.exe с флагами, приведенными в следующей таблице.



| Флаг                         | Значение                                                                                                                                                                                                                                                                                                                                                                                    |
|------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| \_ключ реестра \_ не \_ Автоматический \_ сбой | Этот флаг отключает открытую виртуализацию реестра. Если этот флаг установлен и операция открытия завершается сбоем для ключа с включенной виртуализацией, реестр не пытается повторно открыть ключ. Если этот флаг снят, реестр пытается повторно открыть раздел с МАКСИМАЛЬным \_ допустимым доступом вместо запрошенного доступа.                                                                   |
| \_раздел реестра \_ не \_ виртуализация   | Этот флаг отключает виртуализацию записи реестра. Если этот флаг установлен и операция создания ключа или задания значения завершается сбоем, так как вызывающий объект не имеет достаточных прав доступа к родительскому ключу, реестр завершает операцию. Если этот флаг снят, реестр пытается записать ключ или значение в виртуальном хранилище. Вызывающий объект должен иметь ключ \_ Read Right для родительского ключа. |
| \_ \_ флаг рекурсивного ключа \_ реестра      | Если этот флаг установлен, флаги виртуализации реестра распространяются из родительского ключа. Если этот флаг снят, флаги виртуализации реестра не распространяются. Изменение этого флага влияет только на новые ключи-потомки, созданные после изменения флага. Он не устанавливает или не снимает эти флаги для существующих дочерних ключей.                                                                  |



 

В следующем примере показано использование служебной программы командной строки Reg.exe с параметром FLAGs для запроса состояния флагов виртуализации для ключа.

``` syntax
C:\>reg flags HKLM\Software\AppKey1 QUERY

HKEY_LOCAL_MACHINE\Software\AppKey1

        REG_KEY_DONT_VIRTUALIZE: CLEAR
        REG_KEY_DONT_SILENT_FAIL: CLEAR
        REG_KEY_RECURSE_FLAG: CLEAR

The operation completed successfully.
```

При включении аудита для обновляемого ключа создается новое событие аудита виртуализации, указывающее, что ключ является виртуализированным (а также обычными событиями аудита). Администраторы могут использовать эти сведения для отслеживания состояния виртуализации в системах.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[начало работы с контролем учетных записей](/previous-versions/windows/it-pro/windows-vista/cc507861(v=technet.10))
</dt> <dt>

[Основные сведения и настройка контроля учетных записей](/previous-versions/windows/it-pro/windows-vista/cc709628(v=ws.10))
</dt> <dt>

[Рекомендации для разработчиков и рекомендации для приложений в среде с минимальным уровнем привилегий](/previous-versions/dotnet/articles/aa480150(v=msdn.10))
</dt> </dl>

 

 
