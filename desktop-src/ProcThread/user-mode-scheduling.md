---
description: Планирование пользовательского режима (UMS) — это упрощенный механизм, с помощью которого приложения могут планировать собственные потоки.
ms.assetid: f9dd92fe-6d7a-452c-893e-e6df1757e377
title: Планирование User-Mode
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f3ceea3c4d4e40d73f48414d074bcb5b4f6e911d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105673890"
---
# <a name="user-mode-scheduling"></a>Планирование User-Mode

Планирование пользовательского режима (UMS) — это упрощенный механизм, с помощью которого приложения могут планировать собственные потоки. Приложение может переключаться между UMS-потоками в пользовательском режиме без использования [планировщика системы](scheduling.md) и повторного получения управления процессором, если поток UMS блокируется в ядре. UMS-потоки отличаются от [волокон](fibers.md) тем, что каждый поток UMS имеет собственный контекст потока вместо того, чтобы совместно использовать контекст потока одного потока. Возможность переключения между потоками в пользовательском режиме делает UMS более эффективным, чем [Пулы потоков](thread-pools.md) для управления большим количеством рабочих элементов кратковременной продолжительности, требующих нескольких системных вызовов.

UMS рекомендуется для приложений с высокими требованиями к производительности, которые должны эффективно работать с несколькими потоками одновременно в многопроцессорных или многоядерных системах. Чтобы воспользоваться преимуществами UMS, приложение должно реализовать компонент планировщика, который управляет потоками UMS приложения и определяет, когда они должны выполняться. Разработчикам следует учитывать, должны ли требования к производительности приложений выровнять работу, связанную с разработкой такого компонента. Приложения с умеренными требованиями к производительности могут быть лучше обслуживаться, позволяя планировщику системы планировать свои потоки.

UMS доступен для 64-разрядных приложений, работающих в 64-разрядных версиях Windows 7 и Windows Server 2008 R2 или более поздних версиях, 64-разрядные версии Windows. Эта функция недоступна в 32-разрядных версиях Windows.

Дополнительные сведения см. в следующих разделах:

-   [Планировщик UMS](#ums-scheduler)
-   [Поток планировщика UMS](#ums-scheduler-thread)
-   [Рабочие потоки UMS, контексты потоков и списки завершения](#ums-worker-threads-thread-contexts-and-completion-lists)
-   [Функция точки входа в планировщике UMS](#ums-scheduler-entry-point-function)
-   [Выполнение потока UMS](#ums-thread-execution)
-   [Практические рекомендации по UMS](#ums-best-practices)

## <a name="ums-scheduler"></a>Планировщик UMS

Планировщик UMS приложения отвечает за создание, управление и удаление потоков UMS и определение того, какой поток UMS следует запустить. Планировщик приложения выполняет следующие задачи:

-   Создает один поток планировщика UMS для каждого процессора, в котором приложение будет запускать потоки UMS Worker.
-   Создает рабочие потоки UMS для выполнения работы приложения.
-   Поддерживает собственную очередь готовности потока рабочих потоков, готовых к выполнению, и выбирает потоки для запуска на основе политик планирования приложения.
-   Создает и отслеживает один или несколько списков завершения, в которых система помещает потоки в очередь после завершения обработки в ядре. К ним относятся только что созданные рабочие потоки и потоки, заблокированные ранее в системном вызове, который стал разблокирован.
-   Предоставляет функцию точки входа планировщика для обработки уведомлений из системы. Система вызывает функцию точки входа при создании потока планировщика, когда рабочий поток блокируется в системном вызове, или когда рабочий поток явно передает управление.
-   Выполняет задачи очистки для рабочих потоков, завершенных с выполнением.
-   Выполняет упорядоченное завершение работы планировщика по запросу приложения.

## <a name="ums-scheduler-thread"></a>Поток планировщика UMS

Поток планировщика UMS — это обычный поток, который преобразует себя в UMS путем вызова функции [**ентерумссчедулингмоде**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) . Системный планировщик определяет, когда выполняется поток планировщика UMS в зависимости от его приоритета относительно других готовых потоков. Процессор, на котором выполняется поток планировщика, зависит от сходства потока, то же, что и для потоков, не являющихся UMS.

Вызывающий объект [**ентерумссчедулингмоде**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) указывает список завершения и функцию точки входа [*умссчедулерпрок*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) , связываемую с потоком планировщика UMS. Система вызывает указанную функцию точки входа по завершении преобразования вызывающего потока в UMS. Функция точки входа планировщика отвечает за определение соответствующего следующего действия для указанного потока. Дополнительные сведения см. в подразделе [функция "точка входа" планировщика UMS](#ums-scheduler-entry-point-function) далее в этой статье.

Приложение может создать один поток планировщика UMS для каждого процессора, который будет использоваться для выполнения потоков UMS. Приложение может также задавать сходство каждого потока планировщика UMS для определенного логического процессора, что, как правило, исключает от выполнения на этом процессоре несвязанные потоки, эффективно сохраняя его для этого потока планировщика. Имейте в виду, что установка сходства потоков таким образом может повлиять на общую производительность системы за счет нехватки других процессов, которые могут выполняться в системе. Дополнительные сведения о сходстве потоков см. в разделе [несколько процессоров](multiple-processors.md).

## <a name="ums-worker-threads-thread-contexts-and-completion-lists"></a>Рабочие потоки UMS, контексты потоков и списки завершения

Рабочий поток UMS создается путем вызова [**креатеремотесреадекс**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethreadex) с \_ \_ атрибутом потока UMS атрибута Thread \_ \_ и указания контекста потока UMS и списка завершения.

Контекст потока UMS представляет состояние потока UMS рабочего потока и используется для обнаружения рабочего потока в вызовах UMS-функции. Он создается путем вызова [**креатеумссреадконтекст**](/windows/desktop/api/WinBase/nf-winbase-createumsthreadcontext).

Список завершения создается путем вызова функции [**креатеумскомплетионлист**](/windows/desktop/api/WinBase/nf-winbase-createumscompletionlist) . Список завершения получает UMS-рабочие потоки, которые завершили выполнение в ядре и готовы к запуску в пользовательском режиме. Только система может поставить рабочие потоки в очередь в список завершения. Новые рабочие потоки UMS автоматически помещаются в очередь в список завершения, указанный при создании потоков. Ранее заблокированные рабочие потоки также ставятся в очередь в список завершения, когда они больше не блокируются.

Каждый поток планировщика UMS связан с одним списком завершения. Однако один и тот же список завершения может быть связан с любым количеством потоков планировщика UMS, и поток планировщика может извлекать UMS-контексты из любого списка завершения, для которого у него есть указатель.

Каждый список завершения имеет связанное событие, о котором сообщает система при постановке в очередь одного или нескольких рабочих потоков в пустой список. Функция [**жетумскомплетионлистевент**](/windows/desktop/api/WinBase/nf-winbase-getumscompletionlistevent) Извлекает маркер события для указанного списка завершения. Приложение может ожидать более одного события списка завершения вместе с другими событиями, которые имеют смысл для приложения.

## <a name="ums-scheduler-entry-point-function"></a>Функция точки входа в планировщике UMS

Функция точки входа планировщика приложения реализуется как функция [*умссчедулерпрок*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) . Система вызывает функцию точки входа планировщика приложения в следующее время:

-   Когда поток, не относящийся к UMS, преобразуется в поток планировщика UMS путем вызова [**ентерумссчедулингмоде**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode).
-   Когда рабочий поток UMS вызывает [**умссреадиелд**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield).
-   Когда рабочий поток UMS блокируется в системной службе, например в системном вызове или при сбое страницы.

Параметр *Reason* функции [*умссчедулерпрок*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) указывает причину, по которой была вызвана функция точки входа. Если функция точки входа была вызвана из-за создания нового потока планировщика UMS, параметр *счедулерпарам* содержит данные, указанные вызывающей стороной [**ентерумссчедулингмоде**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode). Если функция точки входа была вызвана из-за подоходного рабочего потока UMS, параметр *счедулерпарам* содержит данные, указанные вызывающей стороной [**умссреадиелд**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield). Если функция точки входа была вызвана, так как в ядре был заблокирован рабочий поток UMS, параметр *счедулерпарам* имеет значение null.

Функция точки входа планировщика отвечает за определение соответствующего следующего действия для указанного потока. Например, если рабочий поток заблокирован, функция точки входа планировщика может запустить следующий доступный рабочий поток, готовый к работе.

Когда вызывается функция точки входа планировщика, планировщик приложения должен попытаться получить все элементы в связанном списке завершения, вызвав функцию [**декуеуеумскомплетионлиститемс**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) . Эта функция получает список контекстов потоков UMS, которые завершили обработку в ядре и готовы к выполнению в пользовательском режиме. Планировщик приложения не должен запускать UMS-потоки непосредственно из этого списка, так как это может привести к непредсказуемому поведению в приложении. Вместо этого планировщик должен извлекать все потоки UMS, вызывая функцию [**жетнекстумслиститем**](/windows/desktop/api/WinBase/nf-winbase-getnextumslistitem) один раз для каждого контекста, вставлять контексты потоков UMS в очередь готового потока планировщика, а затем запускать UMS потоков из очереди готового потока.

Если планировщику не нужно ждать нескольких событий, он должен вызвать [**декуеуеумскомплетионлиститемс**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) с ненулевым параметром времени ожидания, чтобы функция ждет события со списком завершения перед возвратом. Если планировщику необходимо подождать несколько событий списка завершения, он должен вызвать **декуеуеумскомплетионлиститемс** с нулевым параметром времени ожидания, чтобы функция возвращалась немедленно, даже если список завершения пуст. В этом случае планировщик может ожидать явное выполнение событий списка завершения, например с помощью [**WaitForMultipleObjects**](/windows/win32/api/synchapi/nf-synchapi-waitformultipleobjects).

## <a name="ums-thread-execution"></a>Выполнение потока UMS

Вновь созданный рабочий поток UMS помещается в очередь к указанному списку завершения и не начинает выполняться до тех пор, пока планировщик UMS не выберет его для запуска. Это отличается от потоков, не являющихся потоками, которые системный планировщик автоматически планирует запускать, если только вызывающий объект явно не создаст поток, приостановленный.

Планировщик запускает рабочий поток, вызывая [**ексекутеумссреад**](/windows/desktop/api/WinBase/nf-winbase-executeumsthread) с контекстом UMS рабочего потока. Рабочий поток UMS выполняется до тех пор, пока он не выдает вызов функции [**умссреадиелд**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield) , блокирует или завершает работу.

## <a name="ums-best-practices"></a>Практические рекомендации по UMS

Приложения, которые реализуют UMS, должны следовать этим рекомендациям:

-   Базовые структуры для контекстов потоков UMS управляются системой и не должны изменяться напрямую. Вместо этого используйте [**куерюмссреадинформатион**](/windows/desktop/api/WinBase/nf-winbase-queryumsthreadinformation) и [**сетумссреадинформатион**](/windows/desktop/api/WinBase/nf-winbase-setumsthreadinformation) для получения и установки сведений о рабочем потоке UMS.
-   Чтобы предотвратить взаимоблокировки, поток планировщика UMS не должен совместно использовать блокировки с рабочими потоками UMS. Сюда входят блокировки, созданные приложением, и системные блокировки, которые косвенно получают такие операции, как выделение из кучи или загрузка библиотек DLL. Например, предположим, что планировщик выполняет рабочий поток UMS, загружающий библиотеку DLL. Рабочий поток получает блокировку и блоки загрузчика. Система вызывает функцию точки входа планировщика, которая затем загружает библиотеку DLL. Это вызывает взаимоблокировку, так как блокировка загрузчика уже удерживается и не может быть освобождена до тех пор, пока первый поток не блокируется. Чтобы избежать этой проблемы, делегируйте работу, которая может совместно использовать блокировки с рабочими потоками UMS, в выделенный рабочий поток UMS или поток, не являющийся UMS.
-   UMS наиболее эффективен, когда выполняется большая часть обработки в пользовательском режиме. По возможности избегайте выполнения системных вызовов в потоках UMS Worker.
-   Рабочие потоки UMS не должны рассчитывать на использование планировщика системы. Это предположение может иметь незначительные последствия; Например, если поток в неизвестном коде задает приоритет или сходство потоков, планировщик UMS может по-прежнему переопределять его. Код, который предполагает использование планировщика системы, может работать не так, как ожидалось, и может нарушить работу при вызове UMS-потоком.
-   Системе может потребоваться заблокировать контекст потока потока UMS. Например, асинхронный вызов процедур (APC) в режиме ядра может изменить контекст потока UMS, поэтому контекст потока должен быть заблокирован. Если планировщик пытается выполнить контекст потока UMS, пока он заблокирован, вызов завершится ошибкой. Это поведение является конструкцией, и планировщик должен быть разработан для повторного доступа к контексту потока UMS.

 

 
