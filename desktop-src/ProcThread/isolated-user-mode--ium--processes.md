---
description: в Windows 10 появилась новая функция безопасности с именем виртуальный безопасный режим (VSM).
ms.assetid: 58374CC4-593F-4B91-A5E4-85E29C44F8B4
title: Процессы с изолированным пользовательским режимом (ИУМ)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 81a176421174a58abe4ab595bb37ab75434edade
ms.sourcegitcommit: d75fc10b9f0825bbe5ce5045c90d4045e3c53243
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2021
ms.locfileid: "127375061"
---
# <a name="isolated-user-mode-ium-processes"></a>Процессы с изолированным пользовательским режимом (ИУМ)

в Windows 10 появилась новая функция безопасности с именем виртуальный безопасный режим (VSM). VSM использует гипервизор Hyper-V и преобразование адресов второго уровня (SLAT) для создания набора режимов, именуемых виртуальными уровнями доверия (Втлс). Эта новая архитектура программного обеспечения создает границу безопасности, чтобы предотвратить доступ процессов, выполняющихся в одном VTL, к памяти другого VTL. Преимуществом этой изоляции является дополнительное устранение уязвимостей ядра при защите ресурсов, таких как хэши паролей и ключи Kerberos.

На схеме 1 показана традиционная модель режима ядра и кода пользовательского режима, выполняемых в кольцевых и кольцевых ПРОЦЕССОРах 0 и 3 соответственно. В этой новой модели код, выполняемый в традиционной модели, выполняется в VTL0 и не может получить доступ к более высоким привилегированным VTL1, где выполняется код в безопасном ядре и изолированном пользовательском режиме (ИУМ). Втлс представляют собой иерархические значения, что любой код, выполняемый в VTL1, является более привилегированным, чем код, выполняющийся в VTL0.

Изоляция VTL создается гипервизором Hyper-V, который назначает память во время загрузки с помощью преобразования адресов второго уровня (SLAT). Он будет продолжать динамически по мере выполнения системы, защищая память, которую защищенный ядро указывает на необходимость защиты от VTL0, так как она будет использоваться для хранения секретов. Так как отдельные блоки памяти выделяются для двух Втлс, для VTL1 создается среда безопасной среды выполнения путем назначения эксклюзивных блоков памяти VTL1 и VTL0 с соответствующими разрешениями на доступ.

**Схема 1 — Архитектура ИУМ**

![Схема 1 — Архитектура ИУМ](images/uim-architecture.png)

## <a name="trustlets"></a>трустлетс

Трустлетс (также называемые надежными процессами, безопасными процессами или процессами ИУМ) — это программы, выполняемые как ИУМ процессы в VSM. они завершают системные вызовы путем их маршалинга в Windows ядро, работающее в VTL0 ring 0. VSM создает малую среду выполнения, которая включает в себя небольшой безопасный ядро, выполняющееся в VTL1 (изолированном от ядра и драйверов, запущенных в VTL0). Очевидное преимущество безопасности заключается в изоляции страниц пользовательского режима трустлет в VTL1 от драйверов, выполняющихся в ядре VTL0. Даже если режим ядра VTL0 скомпрометирован вредоносными программами, он не будет иметь доступа к страницам процесса ИУМ.

При включенном протоколе VSM среда локального центра безопасности (LSASS) работает как трустлет. LSASS управляет локальной системной политикой, проверкой подлинности пользователей и аудитом при обработке конфиденциальных данных безопасности, таких как хэши паролей и ключи Kerberos. Чтобы использовать преимущества безопасности VSM, трустлет с именем LSAISO.exe (изолированный LSA) работает в VTL1 и взаимодействует с LSASS.exe, запущенным в VTL0 через канал RPC. Секреты ЛСАИСО шифруются перед отправкой в LSASS в нормальном режиме, а страницы ЛСАИСО защищены от вредоносного кода, запущенного в VTL0.

**Схема 2 — Разработка LSASS Трустлет**

![Схема 2 — Разработка LSASS трустлет ](images/lsass-trustlet-design.png)

## <a name="isolated-user-mode-ium-implications"></a>Последствия изолированного режима пользователя (ИУМ)

Невозможно присоединиться к процессу ИУМ, препятствуя возможности отладки кода VTL1. Сюда входят отладочная Отладка дампов памяти и присоединение средств отладки для отладки в режиме реального времени. Он также включает попытки привилегированных учетных записей или драйверов ядра для загрузки библиотеки DLL в процесс ИУМ, внедрения потока или доставки в пользовательском режиме. Такие попытки могут привести к дестабилизации всей системы. Windows Интерфейсы API, которые приведут к нарушению безопасности Трустлет, могут завершаться сбоем непредвиденным образом. Например, загрузка библиотеки DLL в Трустлет сделает ее доступной в VTL0, но не в VTL1. Куеуеусерапк может завершиться неудачно, если целевой поток находится в Трустлет. Другие API, такие как Креатеремотесреад, Виртуалаллоцекс и Read/Вритепроцессмемори, также не будут работать должным образом при использовании в Трустлетс.

Используйте приведенный ниже пример кода, чтобы предотвратить вызов любых функций, которые пытаются присоединить или внедрить код в процесс ИУМ. Сюда входят драйверы ядра, которые ставят APC в очередь для выполнения кода в трустлет.

## <a name="remarks"></a>Remarks

Если возвращаемое состояние Иссекурепроцесс — Success, проверьте параметр Секурепроцесс \_ out, \_ чтобы определить, является ли процесс ИУМ процессом. Процессы ИУМ помечаются системой как "безопасные процессы". Логический результат TRUE означает, что целевой процесс относится к типу ИУМ.


```C++
NTSTATUS
IsSecureProcess(
   _In_ HANDLE ProcessHandle,
   _Out_ BOOLEAN *SecureProcess
   )
{
   NTSTATUS status;

       // definition included in ntddk.h  
   PROCESS_EXTENDED_BASIC_INFORMATION extendedInfo = {0};
 
   PAGED_CODE(); 
  
   extendedInfo.Size = sizeof(extendedInfo);

   // Query for the process information  
   status = ZwQueryInformationProcess(
                  ProcessHandle, ProcessBasicInformation, &extendedInfo,
                  sizeof(extendedInfo), NULL);

   if (NT_SUCCESS(status)) {
      *SecureProcess = (BOOLEAN)(extendedInfo.IsSecureProcess != 0);
   }
 
          return status;
}
```



WDK для Windows 10, "Windows Driver Kit-Windows 10.0.15063.0", содержит обязательное определение \_ \_ базовой \_ информационной структуры процесса. Обновленная версия структуры определена в нтддк. h с новым полем Иссекурепроцесс.


```C++
typedef struct _PROCESS_EXTENDED_BASIC_INFORMATION {
    SIZE_T Size;    // Ignored as input, written with structure size on output
    PROCESS_BASIC_INFORMATION BasicInfo;
    union {
        ULONG Flags;
        struct {
            ULONG IsProtectedProcess : 1;
            ULONG IsWow64Process : 1;
            ULONG IsProcessDeleting : 1;
            ULONG IsCrossSessionCreate : 1;
            ULONG IsFrozen : 1;
            ULONG IsBackground : 1;
            ULONG IsStronglyNamed : 1;
            ULONG IsSecureProcess : 1;
            ULONG IsSubsystemProcess : 1;
            ULONG SpareBits : 23;
        } DUMMYSTRUCTNAME;
    } DUMMYUNIONNAME;
} PROCESS_EXTENDED_BASIC_INFORMATION, *PPROCESS_EXTENDED_BASIC_INFORMATION;
```



 

 



