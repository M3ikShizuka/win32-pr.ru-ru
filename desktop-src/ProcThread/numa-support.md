---
description: Традиционная модель многопроцессорной поддержки — это симметричный многопроцессорный (SMP). В этой модели каждый процессор имеет равный доступ к памяти и операциям ввода-вывода. По мере добавления процессоров процессорная шина преобразуется в ограничение производительности системы.
ms.assetid: a1263968-2b26-45cc-bdd7-6aa354821a5a
title: Поддержка NUMA
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 178f53c6b55b6ae291cd5cdcf99386515a441094
ms.sourcegitcommit: f848119a8faa29b27585f4df53f6e50ee9666684
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/27/2021
ms.locfileid: "110549809"
---
# <a name="numa-support"></a><span data-ttu-id="bd4cb-105">Поддержка NUMA</span><span class="sxs-lookup"><span data-stu-id="bd4cb-105">NUMA Support</span></span>

<span data-ttu-id="bd4cb-106">Традиционная модель многопроцессорной поддержки — это симметричный многопроцессорный (SMP).</span><span class="sxs-lookup"><span data-stu-id="bd4cb-106">The traditional model for multiprocessor support is symmetric multiprocessor (SMP).</span></span> <span data-ttu-id="bd4cb-107">В этой модели каждый процессор имеет равный доступ к памяти и операциям ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-107">In this model, each processor has equal access to memory and I/O.</span></span> <span data-ttu-id="bd4cb-108">По мере добавления процессоров процессорная шина преобразуется в ограничение производительности системы.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-108">As more processors are added, the processor bus becomes a limitation for system performance.</span></span>

<span data-ttu-id="bd4cb-109">Конструкторы систем используют неоднородный доступ к памяти (NUMA) для увеличения скорости процессора без увеличения нагрузки на процессорную шину.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-109">System designers use non-uniform memory access (NUMA) to increase processor speed without increasing the load on the processor bus.</span></span> <span data-ttu-id="bd4cb-110">Архитектура является неоднородной, так как каждый процессор близко к некоторым частям памяти и более отдален от других частей памяти.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-110">The architecture is non-uniform because each processor is close to some parts of memory and farther from other parts of memory.</span></span> <span data-ttu-id="bd4cb-111">Процессор быстро получает доступ к памяти, к которой он близок, в то время как может потребоваться больше времени для получения доступа к памяти, которая находится дальше.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-111">The processor quickly gains access to the memory it is close to, while it can take longer to gain access to memory that is farther away.</span></span>

<span data-ttu-id="bd4cb-112">В системе NUMA процессоры размещаются в небольших системах, именуемых *узлами*.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-112">In a NUMA system, CPUs are arranged in smaller systems called *nodes*.</span></span> <span data-ttu-id="bd4cb-113">Каждый узел имеет свои собственные процессоры и память и подключается к более крупной системе через шину Interconnect, ориентированную на кэш.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-113">Each node has its own processors and memory, and is connected to the larger system through a cache-coherent interconnect bus.</span></span>

<span data-ttu-id="bd4cb-114">Система пытается повысить производительность, планируя потоки на процессорах, которые находятся в том же узле, что и используемая память.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-114">The system attempts to improve performance by scheduling threads on processors that are in the same node as the memory being used.</span></span> <span data-ttu-id="bd4cb-115">Он пытается удовлетворить запросы на выделение памяти в пределах узла, но при необходимости выделит память с других узлов.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-115">It attempts to satisfy memory-allocation requests from within the node, but will allocate memory from other nodes if necessary.</span></span> <span data-ttu-id="bd4cb-116">Он также предоставляет API, чтобы сделать топологию системы доступной для приложений.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-116">It also provides an API to make the topology of the system available to applications.</span></span> <span data-ttu-id="bd4cb-117">Вы можете повысить производительность приложений с помощью функций NUMA, чтобы оптимизировать планирование и использование памяти.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-117">You can improve the performance of your applications by using the NUMA functions to optimize scheduling and memory usage.</span></span>

<span data-ttu-id="bd4cb-118">Во – первых, необходимо определить макет узлов в системе.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-118">First of all, you will need to determine the layout of nodes in the system.</span></span> <span data-ttu-id="bd4cb-119">Чтобы получить узел с наибольшим номером в системе, используйте функцию [**жетнумахигхестноденумбер**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumahighestnodenumber) .</span><span class="sxs-lookup"><span data-stu-id="bd4cb-119">To retrieve the highest numbered node in the system, use the [**GetNumaHighestNodeNumber**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumahighestnodenumber) function.</span></span> <span data-ttu-id="bd4cb-120">Обратите внимание, что это число не гарантировано равно общему количеству узлов в системе.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-120">Note that this number is not guaranteed to equal the total number of nodes in the system.</span></span> <span data-ttu-id="bd4cb-121">Кроме того, не гарантируется, что узлы с последовательными числами близки друг к другу.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-121">Also, nodes with sequential numbers are not guaranteed to be close together.</span></span> <span data-ttu-id="bd4cb-122">Чтобы получить список процессоров в системе, используйте функцию [**жетпроцессаффинитимаск**](/windows/desktop/api/WinBase/nf-winbase-getprocessaffinitymask) .</span><span class="sxs-lookup"><span data-stu-id="bd4cb-122">To retrieve the list of processors on the system, use the [**GetProcessAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-getprocessaffinitymask) function.</span></span> <span data-ttu-id="bd4cb-123">Вы можете определить узел для каждого процессора в списке с помощью функции [**жетнумапроцессорноде**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornode) .</span><span class="sxs-lookup"><span data-stu-id="bd4cb-123">You can determine the node for each processor in the list by using the [**GetNumaProcessorNode**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornode) function.</span></span> <span data-ttu-id="bd4cb-124">Кроме того, чтобы получить список всех процессоров в узле, используйте функцию [**жетнуманодепроцессормаск**](/windows/desktop/api/WinBase/nf-winbase-getnumanodeprocessormask) .</span><span class="sxs-lookup"><span data-stu-id="bd4cb-124">Alternatively, to retrieve a list of all processors in a node, use the [**GetNumaNodeProcessorMask**](/windows/desktop/api/WinBase/nf-winbase-getnumanodeprocessormask) function.</span></span>

<span data-ttu-id="bd4cb-125">После определения того, какие процессоры принадлежат какому узлу, можно оптимизировать производительность приложения.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-125">After you have determined which processors belong to which nodes, you can optimize your application's performance.</span></span> <span data-ttu-id="bd4cb-126">Чтобы убедиться, что все потоки процесса выполняются на одном узле, используйте функцию [**сетпроцессаффинитимаск**](/windows/desktop/api/WinBase/nf-winbase-setprocessaffinitymask) с маской сходства процессов, указывающей процессоры в одном узле.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-126">To ensure that all threads for your process run on the same node, use the [**SetProcessAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-setprocessaffinitymask) function with a process affinity mask that specifies processors in the same node.</span></span> <span data-ttu-id="bd4cb-127">Это повышает эффективность приложений, потоки которых должны иметь доступ к одной и той же памяти.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-127">This increases the efficiency of applications whose threads need to access the same memory.</span></span> <span data-ttu-id="bd4cb-128">Кроме того, чтобы ограничить количество потоков на каждом узле, используйте функцию [**сетсреадаффинитимаск**](/windows/desktop/api/WinBase/nf-winbase-setthreadaffinitymask) .</span><span class="sxs-lookup"><span data-stu-id="bd4cb-128">Alternatively, to limit the number of threads on each node, use the [**SetThreadAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-setthreadaffinitymask) function.</span></span>

<span data-ttu-id="bd4cb-129">Приложения, интенсивно использующие память, должны оптимизировать использование памяти.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-129">Memory-intensive applications will need to optimize their memory usage.</span></span> <span data-ttu-id="bd4cb-130">Чтобы получить объем свободной памяти, доступной для узла, используйте функцию [**жетнумааваилаблемемориноде**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynode) .</span><span class="sxs-lookup"><span data-stu-id="bd4cb-130">To retrieve the amount of free memory available to a node, use the [**GetNumaAvailableMemoryNode**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynode) function.</span></span> <span data-ttu-id="bd4cb-131">Функция [**виртуалаллоцекснума**](/windows/win32/api/memoryapi/nf-memoryapi-virtualallocexnuma) позволяет приложению указать предпочитаемый узел для выделения памяти.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-131">The [**VirtualAllocExNuma**](/windows/win32/api/memoryapi/nf-memoryapi-virtualallocexnuma) function enables the application to specify a preferred node for the memory allocation.</span></span> <span data-ttu-id="bd4cb-132">**Виртуалаллоцекснума** не выделяет физические страницы, поэтому она будет выполнена, независимо от того, доступны ли страницы на этом узле или в других местах системы.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-132">**VirtualAllocExNuma** does not allocate any physical pages, so it will succeed whether or not the pages are available on that node or elsewhere in the system.</span></span> <span data-ttu-id="bd4cb-133">Физические страницы выделяются по запросу.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-133">The physical pages are allocated on demand.</span></span> <span data-ttu-id="bd4cb-134">Если на предпочитаемом узле не хватает страниц, диспетчер памяти будет использовать страницы из других узлов.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-134">If the preferred node runs out of pages, the memory manager will use pages from other nodes.</span></span> <span data-ttu-id="bd4cb-135">Если память выведена из памяти, то тот же процесс используется при возвращении.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-135">If the memory is paged out, the same process is used when it is brought back in.</span></span>

### <a name="numa-support-on-systems-with-more-than-64-logical-processors"></a><span data-ttu-id="bd4cb-136">Поддержка NUMA в системах с более чем 64 логическими процессорами</span><span class="sxs-lookup"><span data-stu-id="bd4cb-136">NUMA Support on Systems With More Than 64 Logical Processors</span></span>

<span data-ttu-id="bd4cb-137">В системах с более чем 64 логическими процессорами узлы назначаются [группам процессоров](processor-groups.md) в соответствии с емкостью узлов.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-137">On systems with more than 64 logical processors, nodes are assigned to [processor groups](processor-groups.md) according to the capacity of the nodes.</span></span> <span data-ttu-id="bd4cb-138">Емкость узла — это количество процессоров, имеющихся при запуске системы вместе со всеми дополнительными логическими процессорами, которые могут быть добавлены во время работы системы.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-138">The capacity of a node is the number of processors that are present when the system starts together with any additional logical processors that can be added while the system is running.</span></span>

<span data-ttu-id="bd4cb-139">Windows **server 2008, Windows Vista, Windows server 2003 и Windows XP:** Группы процессоров не поддерживаются.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-139">**Windows Server 2008, Windows Vista, Windows Server 2003 and Windows XP:** Processor groups are not supported.</span></span>

<span data-ttu-id="bd4cb-140">Каждый узел должен быть полностью включен в группу.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-140">Each node must be fully contained within a group.</span></span> <span data-ttu-id="bd4cb-141">Если емкость узлов относительно мала, система назначает несколько узлов одной группе и выбирает узлы, которые физически близки друг к другу для повышения производительности.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-141">If the capacities of the nodes are relatively small, the system assigns more than one node to the same group, choosing nodes that are physically close to one another for better performance.</span></span> <span data-ttu-id="bd4cb-142">Если емкость узла превышает максимальное число процессоров в группе, система разделяет узел на несколько меньших узлов, каждый из которых достаточно мал для размещения в группе.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-142">If a node's capacity exceeds the maximum number of processors in a group, the system splits the node into multiple smaller nodes, each small enough to fit in a group.</span></span>

<span data-ttu-id="bd4cb-143">Идеальный узел NUMA для нового процесса можно запросить с помощью [**\_ атрибута потока процесса \_ \_ предпочтительный \_**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) Расширенный атрибут Node при создании процесса.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-143">An ideal NUMA node for a new process can be requested using the [**PROC\_THREAD\_ATTRIBUTE\_PREFERRED\_NODE**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) extended attribute when the process is created.</span></span> <span data-ttu-id="bd4cb-144">Как и идеальный для потоков процессор, идеальный узел является указанием планировщика, который назначает новый процесс группе, содержащей запрошенный узел, если это возможно.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-144">Like a thread ideal processor, the ideal node is a hint to the scheduler, which assigns the new process to the group that contains the requested node if possible.</span></span>

<span data-ttu-id="bd4cb-145">Расширенные функции NUMA [**жетнумааваилаблемеморинодикс**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynodeex), [**жетнуманодепроцессормаскекс**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormaskex), [**жетнумапроцессорнодикс**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornodeex)и [**GetNumaProximityNodeEx**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumaproximitynodeex) отличаются от нерасширенных аналогев тем, что номер узла является значением **UShort** , а не **uchar**, для размещения потенциально большего числа узлов в системе с более чем 64 логическими процессорами.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-145">The extended NUMA functions [**GetNumaAvailableMemoryNodeEx**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynodeex), [**GetNumaNodeProcessorMaskEx**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormaskex), [**GetNumaProcessorNodeEx**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornodeex), and [**GetNumaProximityNodeEx**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumaproximitynodeex) differ from their unextended counterparts in that the node number is a **USHORT** value rather than a **UCHAR**, to accommodate the potentially greater number of nodes on a system with more than 64 logical processors.</span></span> <span data-ttu-id="bd4cb-146">Кроме того, процессор, заданный или извлекаемый расширенными функциями, включает в себя группу процессоров; процессор, заданный или извлекаемый нерасширенными функциями, является относительным для группы.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-146">Also, the processor specified with or retrieved by the extended functions includes the processor group; the processor specified with or retrieved by the unextended functions is group-relative.</span></span> <span data-ttu-id="bd4cb-147">Дополнительные сведения см. в разделах справки по отдельным функциям.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-147">For details, see the individual function reference topics.</span></span>

<span data-ttu-id="bd4cb-148">Приложение с поддержкой групп может назначить все свои потоки определенному узлу аналогично описанному выше в этом разделе, используя соответствующие расширенные функции NUMA.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-148">A group-aware application can assign all of its threads to a particular node in a similar fashion to that described earlier in this topic, using the corresponding extended NUMA functions.</span></span> <span data-ttu-id="bd4cb-149">Приложение использует [**жетлогикалпроцессоринформатионекс**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformationex) для получения списка всех процессоров в системе.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-149">The application uses [**GetLogicalProcessorInformationEx**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformationex) to get the list of all processors on the system.</span></span> <span data-ttu-id="bd4cb-150">Обратите внимание, что приложение не может задать маску сходства процессов, если только этот процесс не назначен одной группе, а требуемый узел находится в этой группе.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-150">Note that the application cannot set the process affinity mask unless the process is assigned to a single group and the intended node is located in that group.</span></span> <span data-ttu-id="bd4cb-151">Обычно приложение должно вызвать [**сетсреадграупаффинити**](/windows/win32/api/processtopologyapi/nf-processtopologyapi-setthreadgroupaffinity) , чтобы ограничить его потоки до предполагаемого узла.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-151">Usually the application must call [**SetThreadGroupAffinity**](/windows/win32/api/processtopologyapi/nf-processtopologyapi-setthreadgroupaffinity) to limit its threads to the intended node.</span></span>


### <a name="behavior-starting-with-windows-10-build-20348"></a><span data-ttu-id="bd4cb-152">Поведение, начиная с сборки Windows 10 20348</span><span class="sxs-lookup"><span data-stu-id="bd4cb-152">Behavior starting with Windows 10 Build 20348</span></span> 

> [!NOTE]
> <span data-ttu-id="bd4cb-153">Начиная с сборки Windows 10 20348, поведение этой и других функций NUMA было изменено для улучшения поддержки систем с узлами, содержащими больше процессоров 64.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-153">Starting with Windows 10 Build 20348, the behavior of this and other NUMA functions has been modified to better support systems with nodes containing more that 64 processors.</span></span>

<span data-ttu-id="bd4cb-154">Создание «фиктивных» узлов для размещения сопоставления 1:1 между группами и узлами привело к путанице в работе при обнаружении непредвиденного числа узлов NUMA, и, начиная с сборки Windows 10 Build 20348, операционная система изменилась на разрешение связи нескольких групп с узлом, поэтому теперь можно сообщить о истинной топологии NUMA системы.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-154">Creating "fake" nodes to accommodate a 1:1 mapping between groups and nodes has resulted in confusing behaviors where unexpected numbers of NUMA nodes are reported and so, starting with Windows 10 Build 20348, the OS has changed to allow multiple groups to be associated with a node, and so now the true NUMA topology of the system can be reported.</span></span>  

<span data-ttu-id="bd4cb-155">В рамках этих изменений операционной системы некоторые API NUMA были изменены для поддержки отчетов о нескольких группах, которые теперь можно связать с одним узлом NUMA.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-155">As part of these changes to the OS, a number of NUMA APIs have changed to support reporting the multiple groups which can now be associated with a single NUMA node.</span></span> <span data-ttu-id="bd4cb-156">Обновленные и новые API-интерфейсы помечаются в таблице в разделе **API NUMA** ниже.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-156">Updated and new APIs are labeled in the table in the **NUMA API** section below.</span></span>

<span data-ttu-id="bd4cb-157">Поскольку удаление разделения узлов потенциально может повлиять на существующие приложения, доступно значение реестра, позволяющее воздействовать на работу разделения устаревших узлов.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-157">Because the removal of node splitting can potentially impact existing applications, a registry value is available to allow opting back into the legacy node splitting behavior.</span></span> <span data-ttu-id="bd4cb-158">Разделение узлов можно включить повторно, создав **REG_DWORD** значение с именем "сплитларженодес" со значением 1 под HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\NUMA.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-158">Node splitting can be re-enabled by creating a **REG_DWORD** value named "SplitLargeNodes" with value 1 underneath HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\NUMA.</span></span> <span data-ttu-id="bd4cb-159">Чтобы изменения этого параметра вступили в силу, требуется перезагрузка.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-159">Changes to this setting require a reboot to take effect.</span></span>

```powershell
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\NUMA" /v SplitLargeNumaNodes /t REG_DWORD /v 1
```

> [!NOTE]
> <span data-ttu-id="bd4cb-160">Приложения, которые обновляются для использования новых функций API, сообщающих о истинной топологии NUMA, будут продолжать работать должным образом в системах, где разделение большого узла было повторно включено с помощью этого раздела реестра.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-160">Applications that are updated to use the new API functionality that reports the true NUMA topology will continue to work properly on systems where large node splitting has been reenabled with this registry key.</span></span>

<span data-ttu-id="bd4cb-161">В следующем примере сначала демонстрируются потенциальные проблемы с построением таблиц, сопоставленных процессорам с узлами NUMA с помощью устаревших API сходства, которые больше не предоставляют полный набор всех процессоров в системе. это может привести к созданию неполной таблицы.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-161">The following example first demonstrates potential issues with builds tables mapping processors to NUMA nodes using the legacy affinity APIs, which no longer provide a full cover of all processors in the system this can result in an incomplete table.</span></span> <span data-ttu-id="bd4cb-162">Последствия такой неполноты зависят от содержимого таблицы.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-162">The implications of such incompleteness depend on the contents of the table.</span></span> <span data-ttu-id="bd4cb-163">Если в таблице просто хранится соответствующий номер узла, это, скорее всего, проблема с производительностью, если необнаруженные процессоры остаются в составе узла 0.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-163">If the table simply stores the corresponding node number then this is likely only a performance issue with uncovered processors being left as part of node 0.</span></span> <span data-ttu-id="bd4cb-164">Однако если таблица содержит указатели на структуру контекста для каждого узла, это может привести к ненулевым разыменованиям во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-164">However, if the table contains pointers to a per-node context structure this can result in NULL dereferences at runtime.</span></span>

<span data-ttu-id="bd4cb-165">Далее в примере кода показаны два обходных решения проблемы.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-165">Next, the code example illustrates two workarounds for the issue.</span></span> <span data-ttu-id="bd4cb-166">Первый заключается в переходе на многогрупповые интерфейсы API сходства узлов (пользовательский режим и режим ядра).</span><span class="sxs-lookup"><span data-stu-id="bd4cb-166">The first is to migrate to the multi-group node affinity APIs (user-mode and kernel-mode).</span></span> <span data-ttu-id="bd4cb-167">Второй — использовать **кекуерилогикалпроцессоррелатионшип** для прямого запроса узла NUMA, связанного с данным номером процессора.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-167">The second is to use **KeQueryLogicalProcessorRelationship** to directly query the NUMA node associated with a given processor number.</span></span>

```cpp

//
// Problematic implementation using KeQueryNodeActiveAffinity.
//

USHORT CurrentNode;
USHORT HighestNodeNumber;
GROUP_AFFINITY NodeAffinity;
ULONG ProcessorIndex;
PROCESSOR_NUMBER ProcessorNumber;

HighestNodeNumber = KeQueryHighestNodeNumber();
for (CurrentNode = 0; CurrentNode <= HighestNodeNumber; CurrentNode += 1) {

    KeQueryNodeActiveAffinity(CurrentNode, &NodeAffinity, NULL);
    while (NodeAffinity.Mask != 0) {

        ProcessorNumber.Group = NodeAffinity.Group;
        BitScanForward(&ProcessorNumber.Number, NodeAffinity.Mask);

        ProcessorIndex = KeGetProcessorIndexFromNumber(&ProcessorNumber);

        ProcessorNodeContexts[ProcessorIndex] = NodeContexts[CurrentNode;]

        NodeAffinity.Mask &= ~((KAFFINITY)1 << ProcessorNumber.Number);
    }
}

//
// Resolution using KeQueryNodeActiveAffinity2.
//

USHORT CurrentIndex;
USHORT CurrentNode;
USHORT CurrentNodeAffinityCount;
USHORT HighestNodeNumber;
ULONG MaximumGroupCount;
PGROUP_AFFINITY NodeAffinityMasks;
ULONG ProcessorIndex;
PROCESSOR_NUMBER ProcessorNumber;
NTSTATUS Status;

MaximumGroupCount = KeQueryMaximumGroupCount();
NodeAffinityMasks = ExAllocatePool2(POOL_FLAG_PAGED,
                                    sizeof(GROUP_AFFINITY) * MaximumGroupCount,
                                    'tseT');

if (NodeAffinityMasks == NULL) {
    return STATUS_NO_MEMORY;
}

HighestNodeNumber = KeQueryHighestNodeNumber();
for (CurrentNode = 0; CurrentNode <= HighestNodeNumber; CurrentNode += 1) {

    Status = KeQueryNodeActiveAffinity2(CurrentNode,
                                        NodeAffinityMasks,
                                        MaximumGroupCount,
                                        &CurrentNodeAffinityCount);
    NT_ASSERT(NT_SUCCESS(Status));

    for (CurrentIndex = 0; CurrentIndex < CurrentNodeAffinityCount; CurrentIndex += 1) {

        CurrentAffinity = &NodeAffinityMasks[CurrentIndex];

        while (CurrentAffinity->Mask != 0) {

            ProcessorNumber.Group = CurrentAffinity.Group;
            BitScanForward(&ProcessorNumber.Number, CurrentAffinity->Mask);

            ProcessorIndex = KeGetProcessorIndexFromNumber(&ProcessorNumber);

            ProcessorNodeContexts[ProcessorIndex] = NodeContexts[CurrentNode];

            CurrentAffinity->Mask &= ~((KAFFINITY)1 << ProcessorNumber.Number);
        }
    }
}

//
// Resolution using KeQueryLogicalProcessorRelationship.
//

ULONG ProcessorCount;
ULONG ProcessorIndex;
SYSTEM_LOGICAL_PROCESSOR_INFORMATION_EX ProcessorInformation;
ULONG ProcessorInformationSize;
PROCESSOR_NUMBER ProcessorNumber;
NTSTATUS Status;

ProcessorCount = KeQueryActiveProcessorCountEx(ALL_PROCESSOR_GROUPS);

for (ProcessorIndex = 0; ProcessorIndex < ProcessorCount; ProcessorIndex += 1) {

    Status = KeGetProcessorNumberFromIndex(ProcessorIndex, &ProcessorNumber);
    NT_ASSERT(NT_SUCCESS(Status));

    ProcessorInformationSize = sizeof(ProcessorInformation);
    Status = KeQueryLogicalProcessorRelationship(&ProcessorNumber,
                                                    RelationNumaNode,
                                                    &ProcessorInformation,
                                                    &ProcesorInformationSize);
    NT_ASSERT(NT_SUCCESS(Status));

    NodeNumber = ProcessorInformation.NumaNode.NodeNumber;

    ProcessorNodeContexts[ProcessorIndex] = NodeContexts[NodeNumber];
}
```

## <a name="numa-api"></a><span data-ttu-id="bd4cb-168">API NUMA</span><span class="sxs-lookup"><span data-stu-id="bd4cb-168">NUMA API</span></span>

<span data-ttu-id="bd4cb-169">В следующей таблице описывается API NUMA.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-169">The following table describes the NUMA API.</span></span>



| <span data-ttu-id="bd4cb-170">Функция</span><span class="sxs-lookup"><span data-stu-id="bd4cb-170">Function</span></span>                                                                     | <span data-ttu-id="bd4cb-171">Описание</span><span class="sxs-lookup"><span data-stu-id="bd4cb-171">Description</span></span>                                                                                                                                                                                                                     |
|------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="bd4cb-172">**аллокатеусерфисикалпажеснума**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-172">**AllocateUserPhysicalPagesNuma**</span></span>](/windows/win32/api/memoryapi/nf-memoryapi-allocateuserphysicalpagesnuma)      | <span data-ttu-id="bd4cb-173">Выделяет страницы физической памяти для сопоставления и несоответствия в любом регионе [расширений](../memory/address-windowing-extensions.md) AWE указанного процесса и указывает узел NUMA для физической памяти.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-173">Allocates physical memory pages to be mapped and unmapped within any [Address Windowing Extensions](../memory/address-windowing-extensions.md) (AWE) region of a specified process and specifies the NUMA node for the physical memory.</span></span> |
| [<span data-ttu-id="bd4cb-174">**креатефилемаппингнума**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-174">**CreateFileMappingNuma**</span></span>](/windows/win32/api/memoryapi/nf-memoryapi-createfilemappingnumaw)                      | <span data-ttu-id="bd4cb-175">Создает или открывает именованный или безымянный объект сопоставления файлов для указанного файла и указывает узел NUMA для физической памяти.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-175">Creates or opens a named or unnamed file mapping object for a specified file, and specifies the NUMA node for the physical memory.</span></span>                                                                                              |
| [<span data-ttu-id="bd4cb-176">**жетлогикалпроцессоринформатион**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-176">**GetLogicalProcessorInformation**</span></span>](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformation)     | <span data-ttu-id="bd4cb-177">Обновлено в сборке Windows 10 20348.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-177">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="bd4cb-178">Извлекает сведения о логических процессорах и связанном оборудовании.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-178">Retrieves information about logical processors and related hardware.</span></span>                                                                                                                                                            |
| [<span data-ttu-id="bd4cb-179">**жетлогикалпроцессоринформатионекс**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-179">**GetLogicalProcessorInformationEx**</span></span>](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformationex) | <span data-ttu-id="bd4cb-180">Обновлено в сборке Windows 10 20348.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-180">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="bd4cb-181">Извлекает сведения о связях логических процессоров и связанного оборудования.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-181">Retrieves information about the relationships of logical processors and related hardware.</span></span>                                                                                                                                       |
| [<span data-ttu-id="bd4cb-182">**жетнумааваилаблемемориноде**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-182">**GetNumaAvailableMemoryNode**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynode)             | <span data-ttu-id="bd4cb-183">Извлекает объем памяти, доступный в указанном узле.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-183">Retrieves the amount of memory available in the specified node.</span></span>                                                                                                                                                                 |
| [<span data-ttu-id="bd4cb-184">**жетнумааваилаблемеморинодикс**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-184">**GetNumaAvailableMemoryNodeEx**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynodeex)         | <span data-ttu-id="bd4cb-185">Извлекает объем памяти, доступный в узле, указанном как значение **UShort** .</span><span class="sxs-lookup"><span data-stu-id="bd4cb-185">Retrieves the amount of memory available in a node specified as a **USHORT** value.</span></span>                                                                                                                                             |
| [<span data-ttu-id="bd4cb-186">**жетнумахигхестноденумбер**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-186">**GetNumaHighestNodeNumber**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumahighestnodenumber)                 | <span data-ttu-id="bd4cb-187">Возвращает узел, в котором в настоящее время имеется наибольший номер.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-187">Retrieves the node that currently has the highest number.</span></span>                                                                                                                                                                       |
| [<span data-ttu-id="bd4cb-188">**жетнуманодепроцессормаск**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-188">**GetNumaNodeProcessorMask**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumanodeprocessormask)                 | <span data-ttu-id="bd4cb-189">Обновлено в сборке Windows 10 20348.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-189">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="bd4cb-190">Извлекает маску процессора для указанного узла.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-190">Retrieves the processor mask for the specified node.</span></span>                                                                                                                                                                            |
| [<span data-ttu-id="bd4cb-191">**GetNumaNodeProcessorMask2**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-191">**GetNumaNodeProcessorMask2**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormask2)                         | <span data-ttu-id="bd4cb-192">Новые в Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-192">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="bd4cb-193">Извлекает многогрупповую маску процессора для указанного узла.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-193">Retrieves the multi-group processor mask of the specified node.</span></span>                                                                                                                                                                          |
| [<span data-ttu-id="bd4cb-194">**жетнуманодепроцессормаскекс**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-194">**GetNumaNodeProcessorMaskEx**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormaskex)             | <span data-ttu-id="bd4cb-195">Обновлено в сборке Windows 10 20348.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-195">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="bd4cb-196">Извлекает маску процессора для узла, указанного как значение типа **UShort** .</span><span class="sxs-lookup"><span data-stu-id="bd4cb-196">Retrieves the processor mask for a node specified as a **USHORT** value.</span></span>                                                                                                                                                        |
| [<span data-ttu-id="bd4cb-197">**жетнумапроцессорноде**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-197">**GetNumaProcessorNode**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornode)                         | <span data-ttu-id="bd4cb-198">Возвращает номер узла для указанного процессора.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-198">Retrieves the node number for the specified processor.</span></span>                                                                                                                                                                          |
| [<span data-ttu-id="bd4cb-199">**жетнумапроцессорнодикс**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-199">**GetNumaProcessorNodeEx**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornodeex)                     | <span data-ttu-id="bd4cb-200">Получает номер узла в виде значения **UShort** для указанного процессора.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-200">Retrieves the node number as a **USHORT** value for the specified processor.</span></span>                                                                                                                                                    |
| [<span data-ttu-id="bd4cb-201">**жетнумапроксимитиноде**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-201">**GetNumaProximityNode**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaproximitynode)                         | <span data-ttu-id="bd4cb-202">Возвращает номер узла для указанного идентификатора близости.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-202">Retrieves the node number for the specified proximity identifier.</span></span>                                                                                                                                                               |
| [<span data-ttu-id="bd4cb-203">**жетнумапроксимитинодикс**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-203">**GetNumaProximityNodeEx**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumaproximitynodeex)                     | <span data-ttu-id="bd4cb-204">Получает номер узла в виде значения **UShort** для указанного идентификатора близости.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-204">Retrieves the node number as a **USHORT** value for the specified proximity identifier.</span></span>                                                                                                                                         |
| [<span data-ttu-id="bd4cb-205">**жетпроцессдефаулткпусетмаскс**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-205">**GetProcessDefaultCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getprocessdefaultcpusetmasks)                     | <span data-ttu-id="bd4cb-206">Новые в Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-206">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="bd4cb-207">Возвращает список наборов ЦП в наборе процессов по умолчанию, который был установлен с помощью Сетпроцессдефаулткпусетмаскс или Сетпроцессдефаулткпусетс.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-207">Retrieves the list of CPU Sets in the process default set that was set by SetProcessDefaultCpuSetMasks or SetProcessDefaultCpuSets.</span></span>                                                                                                                                         |
| [<span data-ttu-id="bd4cb-208">**жетсреадселектедкпусетмаскс**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-208">**GetThreadSelectedCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getthreadselectedcpusetmasks)                     | <span data-ttu-id="bd4cb-209">Новые в Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-209">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="bd4cb-210">Задает назначение выбранных наборов ЦП для указанного потока.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-210">Sets the selected CPU Sets assignment for the specified thread.</span></span> <span data-ttu-id="bd4cb-211">Это назначение переопределяет назначение процесса по умолчанию, если оно задано.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-211">This assignment overrides the process default assignment, if one is set.</span></span>                                                                                                                                          |
| [<span data-ttu-id="bd4cb-212">**мапвиевоффиликснума**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-212">**MapViewOfFileExNuma**</span></span>](/windows/win32/api/winbase/nf-winbase-mapviewoffileexnuma)                          | <span data-ttu-id="bd4cb-213">Сопоставляет представление сопоставления файлов с адресным пространством вызывающего процесса и указывает узел NUMA для физической памяти.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-213">Maps a view of a file mapping into the address space of a calling process, and specifies the NUMA node for the physical memory.</span></span>                                                                                                 |
| [<span data-ttu-id="bd4cb-214">**сетпроцессдефаулткпусетмаскс**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-214">**SetProcessDefaultCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setprocessdefaultcpusetmasks)                     | <span data-ttu-id="bd4cb-215">Новые в Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-215">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="bd4cb-216">Задает назначение наборов ЦП по умолчанию для потоков в указанном процессе.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-216">Sets the default CPU Sets assignment for threads in the specified process.</span></span>                                                                                                                                          |
| [<span data-ttu-id="bd4cb-217">**сетсреадселектедкпусетмаскс**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-217">**SetThreadSelectedCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadselectedcpusetmasks)                     | <span data-ttu-id="bd4cb-218">Новые в Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-218">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="bd4cb-219">Задает назначение выбранных наборов ЦП для указанного потока.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-219">Sets the selected CPU Sets assignment for the specified thread.</span></span> <span data-ttu-id="bd4cb-220">Это назначение переопределяет назначение процесса по умолчанию, если оно задано.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-220">This assignment overrides the process default assignment, if one is set.</span></span>                                                                                                                                          |
| [<span data-ttu-id="bd4cb-221">**виртуалаллоцекснума**</span><span class="sxs-lookup"><span data-stu-id="bd4cb-221">**VirtualAllocExNuma**</span></span>](/windows/win32/api/memoryapi/nf-memoryapi-virtualallocexnuma)                            | <span data-ttu-id="bd4cb-222">Резервирует или фиксирует область памяти в пределах виртуального адресного пространства указанного процесса и указывает узел NUMA для физической памяти.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-222">Reserves or commits a region of memory within the virtual address space of the specified process, and specifies the NUMA node for the physical memory.</span></span>                                                                          |



 

<span data-ttu-id="bd4cb-223">Функцию [**куериворкингсетекс**](/windows/win32/api/psapi/nf-psapi-queryworkingsetex) можно использовать для получения узла NUMA, на котором выделяется страница.</span><span class="sxs-lookup"><span data-stu-id="bd4cb-223">The [**QueryWorkingSetEx**](/windows/win32/api/psapi/nf-psapi-queryworkingsetex) function can be used to retrieve the NUMA node on which a page is allocated.</span></span> <span data-ttu-id="bd4cb-224">Пример см. в разделе [выделение памяти из узла NUMA](../memory/allocating-memory-from-a-numa-node.md).</span><span class="sxs-lookup"><span data-stu-id="bd4cb-224">For an example, see [Allocating Memory from a NUMA Node](../memory/allocating-memory-from-a-numa-node.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="bd4cb-225">Связанные темы</span><span class="sxs-lookup"><span data-stu-id="bd4cb-225">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="bd4cb-226">Выделение памяти из узла NUMA</span><span class="sxs-lookup"><span data-stu-id="bd4cb-226">Allocating Memory from a NUMA Node</span></span>](../memory/allocating-memory-from-a-numa-node.md)
</dt> <dt>

[<span data-ttu-id="bd4cb-227">Несколько процессоров</span><span class="sxs-lookup"><span data-stu-id="bd4cb-227">Multiple Processors</span></span>](multiple-processors.md)
</dt> <dt>

[<span data-ttu-id="bd4cb-228">Группы процессоров</span><span class="sxs-lookup"><span data-stu-id="bd4cb-228">Processor Groups</span></span>](processor-groups.md)
</dt> </dl>

 

 
