---
description: Каждое окно является членом определенного класса Window. Класс Window определяет процедуру окна по умолчанию, используемую отдельным окном для обработки сообщений.
ms.assetid: 3a8e8f4e-910d-4863-a4a7-dd37c2dfa402
title: О процедурах окна
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f1f63586b9ca4ac6fe8486ba112316174533b44e
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105693712"
---
# <a name="about-window-procedures"></a>О процедурах окна

Каждое окно является членом определенного класса Window. Класс Window определяет процедуру окна по умолчанию, используемую отдельным окном для обработки сообщений. Все окна, принадлежащие одному и тому же классу, используют одну и ту же процедуру окна по умолчанию. Например, система определяет процедуру окна для класса поля со списком (**ComboBox**). Затем все поля со списком используют эту процедуру окна.

Приложение обычно регистрирует по крайней мере один новый класс окна и связанную с ним процедуру окна. После регистрации класса приложение может создать множество окон этого класса, все из которых используют одну и ту же оконную процедуру. Так как это означает, что несколько источников могут одновременно вызывать один и тот же фрагмент кода, при изменении общих ресурсов из оконной процедуры необходимо соблюдать осторожность. Дополнительные сведения см. в разделе [классы окон](window-classes.md).

Окна процедур для диалоговых окон (называемые процедурами диалоговых окон) имеют схожую структуру и функции в виде обычных оконных процедур. Все точки, которые ссылаются на процедуры окна в этом разделе, также применяются к процедурам диалоговых окон. Дополнительные сведения см. в разделе [диалоговые окна](/windows/desktop/dlgbox/dialog-boxes).

В этом разделе рассматриваются следующие темы.

-   [Структура процедуры окна](#structure-of-a-window-procedure)
-   [Процедура окна по умолчанию](#default-window-procedure)
-   [Подклассы оконных процедур](#window-procedure-subclassing)
    -   [Подклассы экземпляров](#instance-subclassing)
    -   [Глобальные подклассы](#global-subclassing)
-   [Подклассы оконных процедур](#window-procedure-superclassing)

## <a name="structure-of-a-window-procedure"></a>Структура процедуры окна

Оконная процедура — это функция, которая имеет четыре параметра и возвращает значение со знаком. Параметры состоят из обработчика окна, идентификатора сообщения **uint** и двух параметров сообщения, объявленных с типами данных **wParam** и **lParam** . Дополнительные сведения см. в разделе [**WindowProc**](/previous-versions/windows/desktop/legacy/ms633573(v=vs.85)).

Параметры сообщения часто содержат данные как в неупорядоченных, так и в высоком порядке словах. Существует несколько макросов, которые приложение может использовать для извлечения информации из параметров сообщения. Например, макрос [**ловорд**](/previous-versions/windows/desktop/legacy/ms632659(v=vs.85)) извлекает младшее слово (в битах от 0 до 15) из параметра сообщения. К другим макросам относятся [**HIWORD**](/previous-versions/windows/desktop/legacy/ms632657(v=vs.85)), [**лобите**](/previous-versions/windows/desktop/legacy/ms632658(v=vs.85))и [**хибите**](/previous-versions/windows/desktop/legacy/ms632656(v=vs.85)).

Интерпретация возвращаемого значения зависит от конкретного сообщения. Просмотрите описание каждого сообщения, чтобы определить соответствующее возвращаемое значение.

Так как процедуру окна можно вызывать рекурсивно, важно максимально сокращать количество локальных переменных, которые она использует. При обработке отдельных сообщений приложение должно вызывать функции вне процедуры окна, чтобы избежать чрезмерного использования локальных переменных, что может привести к переполнению стека во время глубокой рекурсии.

## <a name="default-window-procedure"></a>Процедура окна по умолчанию

Функция процедуры окна по умолчанию [**дефвиндовпрок**](/windows/desktop/api/winuser/nf-winuser-defwindowproca) определяет определенное фундаментальное поведение, совместно используемое всеми окнами. Процедура окна по умолчанию предоставляет минимальную функциональность для окна. Определяемая приложением процедура окна должна передавать все сообщения, которые она не обрабатывает, в функцию **дефвиндовпрок** для обработки по умолчанию.

## <a name="window-procedure-subclassing"></a>Подклассы оконных процедур

Когда приложение создает окно, система выделяет блок памяти для хранения сведений, относящихся к окну, включая адрес процедуры окна, которая обрабатывает сообщения для окна. Когда системе необходимо передать сообщение в окно, она выполняет поиск адреса процедуры окна в сведениях, относящихся к окну, и передает сообщение этой процедуре.

Создание *подклассов* — это метод, позволяющий приложению перехватывать и обрабатывать сообщения, отправленные или отправляемые в определенное окно, прежде чем окно сможет их обработать. При помощи подкласса окна приложение может дополнять, изменять или отслеживать поведение окна. Приложение может создать подкласс окна, принадлежащего глобальному системному классу, например элементу управления "поле ввода" или списку. Например, приложение может создать подкласс элемента управления редактирования, чтобы предотвратить прием элементом управления определенных символов. Однако нельзя создать подкласс окна или класса, принадлежащего другому приложению. Все подклассы должны выполняться в рамках одного процесса.

Приложение подклассировать окно, заменив адрес исходной процедуры окна, адресом новой процедуры окна, называемой *процедурой-подкласс*. После этого процедура подкласса получает все сообщения, отправленные или опубликованные в окне.

Процедура подкласса может предпринять три действия после получения сообщения: оно может передать сообщение в исходную процедуру окна, изменить сообщение и передать его в исходную процедуру окна или обработать сообщение и не передать его в исходную процедуру окна. Если процедура подкласса обрабатывает сообщение, оно может сделать это до, после или до и после того, как оно передаст сообщение в исходную процедуру окна.

Система предоставляет два типа подкласса: [экземпляр](#instance-subclassing) и [глобальный](#global-subclassing). В *подклассах экземпляров* приложение заменяет адрес процедуры Windows одного экземпляра окна. Приложение должно использовать подклассы экземпляров для подкласса существующего окна. В *глобальных подклассах* приложение заменяет адрес процедуры окна в структуре [**вндкласс**](/windows/win32/api/winuser/ns-winuser-wndclassa) класса Window. Все последующие окна, созданные с помощью класса, имеют адрес процедуры подкласса, но существующие окна класса не затрагиваются.

### <a name="instance-subclassing"></a>Подклассы экземпляров

Приложение подклассировать экземпляр окна с помощью функции [**SetWindowLong**](/windows/win32/api/winuser/nf-winuser-setwindowlonga) . Приложение передает флаг **ГВЛ \_ WndProc** , маркер окна в подкласс и адрес процедуры подкласс для **SetWindowLong**. Процедура подкласса может находиться либо в исполняемом файле приложения, либо в библиотеке DLL.

[**SetWindowLong**](/windows/win32/api/winuser/nf-winuser-setwindowlonga) возвращает адрес исходной процедуры окна. Приложение должно сохранить адрес, используя его при последующих вызовах функции [**каллвиндовпрок**](/windows/win32/api/winuser/nf-winuser-callwindowproca) , чтобы передать перехваченные сообщения в исходную процедуру окна. Приложение также должно иметь адрес исходной процедуры окна, чтобы удалить подкласс из окна. Чтобы удалить подкласс, приложение вызывает **SetWindowLong** еще раз, передавая адрес исходной процедуры окна с флагом **ГВЛ \_ WndProc** и маркером в окно.

Система владеет глобальными системными классами, а аспекты элементов управления могут изменяться от одной версии системы до следующей. Если приложение должно подделать подкласс окну, принадлежащему глобальному системному классу, разработчику может потребоваться обновить приложение при выпуске новой версии системы.

Поскольку создание подклассов экземпляров происходит после создания окна, нельзя добавить дополнительные байты в окно. Приложения, которые подклассировать окно, должны использовать список свойств окна для хранения любых данных, необходимых для экземпляра окна подкласса. Дополнительные сведения см. в разделе [Свойства окна](window-properties.md).

Когда приложение подклассировать окно подклассов, оно должно удалить подклассы в порядке, в котором они были выполнены. Если порядок удаления не изменяется, может произойти Неустранимая системная ошибка.

### <a name="global-subclassing"></a>Глобальные подклассы

Чтобы глобально подклассировать класс окна, приложение должно иметь обработчик для окна класса. Приложению также нужен обработчик для удаления подкласса. Для получения маркера приложение обычно создает скрытое окно класса, для которого создается подкласс. После получения маркера приложение вызывает функцию [**сеткласслонг**](/windows/win32/api/winuser/nf-winuser-setclasslonga) , задавая маркер, флаг **ГКЛ \_ WndProc** и адрес процедуры подкласса. **Сеткласслонг** возвращает адрес исходной процедуры окна для класса.

Адрес исходной процедуры окна используется в глобальных подклассах аналогично тому, как он используется в подклассах экземпляров. Процедура подкласса передает сообщения в исходную процедуру окна путем вызова [**каллвиндовпрок**](/windows/win32/api/winuser/nf-winuser-callwindowproca). Приложение удаляет подкласс из класса Window, вызывая [**сеткласслонг**](/windows/win32/api/winuser/nf-winuser-setclasslonga) еще раз, указывая адрес исходной процедуры окна, флаг **ГКЛ \_ WndProc** и указатель на окно класса, для которого создается подкласс. Приложение, глобально подклассом которого является класс элемента управления, должно удалить подкласс при завершении приложения. в противном случае может возникнуть Неустранимая системная ошибка.

Глобальные подклассы имеют те же ограничения, что и подклассы экземпляров, а также некоторые дополнительные ограничения. Приложение не должно использовать дополнительные байты для класса или экземпляра окна, не зная того, как они используются в исходной процедуре окна. Если приложение должно связывать данные с окном, оно должно использовать свойства окна.

## <a name="window-procedure-superclassing"></a>Подклассы оконных процедур

Создание класса с *помощью классов позволяет* приложению создать новый класс Window с базовой функциональностью существующего класса, а также улучшения, предоставляемые приложением. Суперкласс основан на существующем классе окна, именуемом *базовым классом*. Часто базовый класс является системным глобальным классом окон, таким как элемент управления "поле ввода", но может быть любым классом окна.

Суперкласс имеет собственную процедуру окна, называемую процедурой суперкласса. *Процедура суперкласса* может предпринять три действия после получения сообщения: оно может передать сообщение в исходную процедуру окна, изменить сообщение и передать его в исходную процедуру окна или обработать сообщение и не передать его в исходную процедуру окна. Если процедура суперкласса обрабатывает сообщение, оно может сделать это до, после или до и после того, как оно передаст сообщение в исходную процедуру окна.

В отличие от процедуры-подкласса, процедура суперкласса может обрабатывать сообщения о создании окна ([**WM \_ нккреате**](wm-nccreate.md), [**WM \_ CREATE**](wm-create.md)и т. д.), но она также должна передаваться в исходную процедуру окна базового класса, чтобы процедура окна базового класса могла выполнить свою процедуру инициализации.

Чтобы создать суперкласс для класса окна, приложение сначала вызывает функцию [**жетклассинфо**](/windows/win32/api/winuser/nf-winuser-getclassinfoa) для получения сведений о базовом классе. **Жетклассинфо** заполняет структуру [**вндкласс**](/windows/win32/api/winuser/ns-winuser-wndclassa) значениями из структуры **вндкласс** базового класса. Затем приложение копирует собственный обработчик экземпляра в элемент **HINSTANCE** структуры **вндкласс** и копирует имя суперкласса в элемент **лпсзкласснаме** . Если в базовом классе есть меню, приложение должно предоставить новое меню с теми же идентификаторами меню и скопировать имя меню в элемент **лпсзменунаме** . Если процедура суперкласса обрабатывает сообщение [**\_ команды WM**](/windows/desktop/menurc/wm-command) и не передает его в процедуру окна базового класса, меню не должно иметь соответствующих идентификаторов. **Жетклассинфо** не возвращает элемент **лпсзменунаме**, **лпсзкласснаме** или **HINSTANCE** структуры **вндкласс** .

Приложение должно также задавать элемент **лпфнвндпрок** структуры [**вндкласс**](/windows/win32/api/winuser/ns-winuser-wndclassa) . Функция [**жетклассинфо**](/windows/win32/api/winuser/nf-winuser-getclassinfoa) заполняет этот элемент адресом исходной процедуры окна для класса. Приложение должно сохранить этот адрес для передачи сообщений в исходную процедуру окна, а затем скопировать адрес процедуры суперкласса в элемент **лпфнвндпрок** . При необходимости приложение может изменять любые другие члены структуры **вндкласс** . После заполнения структуры **вндкласс** приложение регистрирует суперкласс, передав адрес структуры в функцию [**registerClass**](/windows/win32/api/winuser/nf-winuser-registerclassa) . Затем этот суперкласс можно использовать для создания окон.

Так как в качестве вспомогательного класса регистрируется новый класс окна, приложение может добавить к дополнительным байтам класса и дополнительным окнам байт. Суперкласс не должен использовать исходные дополнительные байты для базового класса или окна по тем же причинам, когда подкласс экземпляра или глобальный подкласс не должны использовать их. Кроме того, если приложение добавляет дополнительные байты для использования либо в классе, либо в экземпляре окна, оно должно ссылаться на дополнительные байты относительно числа дополнительных байтов, используемых исходным базовым классом. Поскольку число байтов, используемых базовым классом, может отличаться от версии базового класса к следующему, начальное смещение для собственных дополнительных байтов этого суперкласса также может отличаться от одной версии базового класса к другому.

 

 
