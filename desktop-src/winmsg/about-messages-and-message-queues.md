---
description: В этом разделе обсуждаются сообщения Windows и очереди сообщений.
ms.assetid: 21a4d40b-52da-49e4-a374-afc4927e96e8
title: Сведения о сообщениях и очередях сообщений
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 7f0bcf68dbacaae868de3aea1fdc4a5d11290821
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105664612"
---
# <a name="about-messages-and-message-queues"></a>Сведения о сообщениях и очередях сообщений

В отличие от приложений на основе MS-DOS, приложения на основе Windows являются управляемыми событиями. Они не выполняют явных вызовов функций (например, вызовов библиотеки времени выполнения C) для получения входных данных. Вместо этого они ожидают передачи входных данных системой.

Система передает все входные данные для приложения различным окнам в приложении. Каждое окно имеет функцию, называемую процедурой окна, которую система вызывает всякий раз, когда она имеет входные данные для окна. Процедура окна обрабатывает входные данные и возвращает управление системе. Дополнительные сведения о процедурах окна см. в разделе [процедуры окна](window-procedures.md).

Если окно верхнего уровня перестает отвечать на сообщения более чем через несколько секунд, система считает, что окно не отвечает. В этом случае система скрывает окно и заменяет его окном фантома с тем же Z-порядком, расположением, размером и визуальными атрибутами. Это позволяет пользователю перемещать его, изменять его размер или даже закрывать приложение. Однако это единственные доступные действия, так как приложение на самом деле не отвечает. В режиме отладчика система не создает Несинхронизированное окно.

В этом разделе рассматриваются следующие темы:

-   [Сообщения Windows](#windows-messages)
-   [Типы сообщений](#message-types)
    -   [Системные сообщения](#system-defined-messages)
    -   [Сообщения, определяемые приложением](#application-defined-messages)
-   [Маршрутизация сообщений](#message-routing)
    -   [Сообщения в очереди](#queued-messages)
    -   [Сообщения, не помещенные в очередь](#nonqueued-messages)
-   [Обработка сообщений](#message-handling)
    -   [Цикл обработки сообщений](#message-loop)
    -   [Процедура окна](#window-procedure)
-   [Фильтрация сообщений](#message-filtering)
-   [Публикация и отправка сообщений](#posting-and-sending-messages)
    -   [Отправка сообщений](#posting-messages)
    -   [Отправка сообщений](#sending-messages)
-   [Взаимоблокировки сообщений](#message-deadlocks)
-   [Широковещательная рассылка сообщений](#broadcasting-messages)
-   [Сообщения запроса](#query-messages)

## <a name="windows-messages"></a>Сообщения Windows

Система передает входные данные в процедуру окна в виде *сообщения*. Сообщения создаются как системой, так и приложениями. Система создает сообщение для каждого входного события, например, когда пользователь вводит, перемещает мышь или щелкает элемент управления, например полосу прокрутки. Система также создает сообщения в ответ на изменения в системе, внесенные приложением, например, когда приложение изменяет пул ресурсов системных шрифтов или изменяет размер одного из окон. Приложение может создавать сообщения, чтобы направлять собственные окна для выполнения задач или взаимодействия с Windows в других приложениях.

Система отправляет сообщение в процедуру окна с набором четырех параметров: маркером окна, идентификатором сообщения и двумя значениями, которые называются *параметрами сообщения*. *Обработчик окна* определяет окно, для которого предназначено сообщение. Система использует ее для определения того, какая процедура окна должна получить сообщение.

*Идентификатор сообщения* — это именованная константа, которая определяет назначение сообщения. Когда процедура окна получает сообщение, она использует идентификатор сообщения для определения способа обработки сообщения. Например, идентификатор сообщения [**WM \_ Paint**](/windows/desktop/gdi/wm-paint) сообщает процедуре окна, что клиентская область окна изменилась и должна быть перерисована.

Параметры сообщения указывают данные или расположение данных, используемых процедурой окна при обработке сообщения. Значение и значения параметров сообщения зависят от сообщения. Параметр сообщения может содержать целочисленный, упакованный битовый флаг, указатель на структуру, содержащую дополнительные данные, и т. д. Если сообщение не использует параметры сообщения, обычно ему присваивается **значение NULL**. Процедура окна должна проверять идентификатор сообщения, чтобы определить способ интерпретации параметров сообщения.

## <a name="message-types"></a>Типы сообщений

В этом разделе описываются два типа сообщений:

-   [Системные сообщения](#system-defined-messages)
-   [Сообщения, определяемые приложением](#application-defined-messages)

### <a name="system-defined-messages"></a>Сообщения System-Defined

Система отправляет или отправляет сообщение, *определяемое системой* , при взаимодействии с приложением. Эти сообщения используются для управления операциями приложений и предоставления входных данных и других сведений для обработки приложениями. Приложение может также отправлять или публиковать сообщения, определенные системой. Приложения обычно используют эти сообщения для управления работой окон управления, созданных с помощью предварительно зарегистрированных оконных классов.

Каждое определяемое системой сообщение имеет уникальный идентификатор сообщения и соответствующую символьную константу (определенную в файлах заголовков пакета средств разработки программного обеспечения (SDK)), которая указывает назначение сообщения. Например, константа [**WM \_ Paint**](/windows/desktop/gdi/wm-paint) запрашивает, что окно зарисовывает свое содержимое.

Символьные константы укажите категорию, которой принадлежат системные сообщения. Префикс константы определяет тип окна, которое может интерпретировать и обрабатывать сообщение. Ниже приведены префиксы и связанные с ними категории сообщений.



| Prefix                               | Категория сообщений             | Документация                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|--------------------------------------|------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **АБМ** и **АБН**                  | Панель инструментов рабочего стола приложения  | [Сообщения и уведомления оболочки](/windows/desktop/shell/control-panel-applications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **ACM** и **АКН**                  | Элемент управления "Анимация"            | [Управляющие сообщения](/windows/desktop/Controls/bumper-animation-control-reference-messages) и [уведомления элемента управления анимацией](/windows/desktop/Controls/bumper-animation-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **BCM**, **BCN**, **BM** и **млрд долл** | Button - элемент управления               | [Сообщения управления кнопками](/windows/desktop/Controls/bumper-button-control-reference-messages) и [уведомления об управлении кнопками](/windows/desktop/Controls/bumper-button-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **CB** и **КБН**                   | ComboBox - элемент управления             | [Сообщения элемента управления ComboBox](/windows/desktop/Controls/bumper-combobox-control-reference-messages) и [уведомления элемента управления ComboBox](/windows/desktop/Controls/bumper-combobox-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Кбем** и **кбен**                | Элемент управления ComboBoxEx           | [ComboBoxEx сообщения](/windows/desktop/Controls/bumper-comboboxex-control-reference-messages) и [ComboBoxEx уведомления](/windows/desktop/Controls/bumper-comboboxex-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **CCM**                              | Общий элемент управления              | [Управляющие сообщения](/windows/desktop/Controls/bumper-general-control-reference-messages)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **CDM**                              | Общее диалоговое окно            | [Сообщения общего диалогового окна](/windows/desktop/dlgbox/common-dialog-box-messages)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **DFM**                              | Контекстное меню по умолчанию         | [Сообщения и уведомления оболочки](/windows/desktop/shell/control-panel-applications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **DL**                               | Перетащить поле списка                | [Перетаскивать уведомления из списка](/previous-versions//ff485914(v=vs.85))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **DM**                               | Элемент управления "Кнопка" по умолчанию  | [Сообщения диалогового окна](/windows/desktop/dlgbox/dialog-box-messages)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **DTM** и **ДТН**                  | Элемент выбора даты и времени | [Сообщения выбора даты и времени](/windows/desktop/Controls/bumper-date-and-time-picker-control-reference-messages) и [уведомления средства выбора даты и времени](/windows/desktop/Controls/bumper-date-and-time-picker-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **EM** и **EN**                    | Элемент управления "Поле ввода"                 | [Изменение управляющих сообщений](/windows/desktop/Controls/bumper-edit-control-reference-messages), [уведомлений об изменении элементов управления](/windows/desktop/Controls/bumper-edit-control-reference-notifications), [сообщений с богатыми возможностями редактирования](/windows/desktop/Controls/bumper-rich-edit-control-reference-messages)и [уведомлений с расширенными возможностями редактирования](/windows/desktop/Controls/bumper-rich-edit-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **HDM** и **ХДН**                  | Элемент управления "заголовок"               | [Сообщения элемента управления заголовков](/windows/desktop/Controls/bumper-header-control-reference-messages) и [уведомления элемента управления заголовка](/windows/desktop/Controls/bumper-header-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **хкм**                              | Элемент управления горячими ключами              | [Управляющие сообщения горячих ключей](/windows/desktop/Controls/bumper-hot-key-control-reference-messages)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **IPM** и **ИПН**                  | контроль IP-адресов           | [Сообщения IP-адреса](/windows/desktop/Controls/bumper-ip-address-control-reference-messages) и [уведомления об IP-адресах](/windows/desktop/Controls/bumper-ip-address-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Балансировка нагрузки** и **ЛБН**                   | Элемент управления "Список"             | [Сообщения списка](/windows/desktop/Controls/bumper-list-box-control-reference-messages) и уведомления в виде [списка](/windows/desktop/Controls/bumper-list-box-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **ХЕШ**                               | Элемент управления SysLink              | [Управляющие сообщения SysLink](/windows/desktop/Controls/bumper-syslink-control-reference-messages)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **LVM** и **ЛВН**                  | Элемент управления представления списка            | [Просмотр сообщений](/windows/desktop/Controls/bumper-list-view-control-reference-messages) и [уведомлений в виде списка](/windows/desktop/Controls/bumper-list-view-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **MCM** и **МКН**                  | Элемент управления "Календарь на месяц"       | [Месячные сообщения календаря](/windows/desktop/Controls/bumper-month-calendar-control-reference-messages) и [уведомления календаря месяца](/windows/desktop/Controls/bumper-month-calendar-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Управление на основе политик (PBM)**                              | Индикатор выполнения                 | [Сообщения на индикаторе выполнения](/windows/desktop/Controls/bumper-progress-bar-control-reference-messages)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **PGM** и **ПГН**                  | Элемент управления страничного навигатора                | [Сообщения управления страничного навигатора](/windows/desktop/Controls/bumper-pager-control-reference-messages) и [уведомления элемента управления страничного навигатора](/windows/desktop/Controls/bumper-pager-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **ПСМ** и **PSN**                  | Страница свойств.               | [Сообщения на странице свойств](/windows/desktop/Controls/bumper-property-sheets-reference-messages) и [уведомления на странице свойств](/windows/desktop/Controls/bumper-property-sheets-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **RB** и **РБН**                   | Элемент управления главной панели                | [Управляющие сообщения главной панели](/windows/desktop/Controls/bumper-rebar-control-reference-messages) и [уведомления элемента управления главной панели](/windows/desktop/Controls/bumper-rebar-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **SB** и **СБН**                   | Окно строки состояния            | [Сообщения в строке состояния](/windows/desktop/Controls/bumper-status-bars-reference-messages) и [уведомления в строке состояния](/windows/desktop/Controls/bumper-status-bars-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **сбм**                              | Элемент управления "Полоса прокрутки"           | [Прокрутка сообщений](/windows/desktop/Controls/bumper-scroll-bars-reference-messages)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **АДАПТЕР**                              | Меню оболочки                   | [Сообщения и уведомления оболочки](/windows/desktop/shell/control-panel-applications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **STM** и **СТН**                  | Статический элемент управления               | [Статические управляющие сообщения](/windows/desktop/Controls/bumper-static-control-reference-messages) и [уведомления статического элемента управления](/windows/desktop/Controls/bumper-static-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **ТБ** и **ТБН**                   | Панель инструментов                      | [Сообщения элемента управления панели инструментов](/windows/desktop/Controls/bumper-toolbar-control-reference-messages) и [уведомления элемента управления панели инструментов](/windows/desktop/Controls/bumper-toolbar-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **ТБМ** и **трбн**                 | Элемент управления TrackBar             | [Контрольные сообщения](/windows/desktop/Controls/bumper-trackbar-control-reference-messages) и [уведомления](/windows/desktop/Controls/bumper-trackbar-control-reference-notifications) элемента управления TrackBar                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **TCM** и **ТКН**                  | Элемент управления табуляции                  | [Управляющие сообщения вкладки](/windows/desktop/Controls/bumper-tab-control-reference-messages) и [уведомления элемента управления Tab](/windows/desktop/Controls/bumper-tab-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **TDM** и **ТДН**                  | Диалоговое окно задачи                  | [Сообщения диалогового окна задачи](/windows/desktop/Controls/bumper-task-dialogs-reference-messages) и [Уведомления диалогового окна задачи](/windows/desktop/Controls/bumper-task-dialogs-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **ТТМ** и **ТТН**                  | Элемент управления ToolTip              | Уведомления [управляющих сообщений](/windows/desktop/Controls/bumper-tooltip-control-reference-messages) и [всплывающих](/windows/desktop/Controls/bumper-tooltip-control-reference-notifications) подсказок                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **TVM** и **ТВН**                  | Элемент управления представления в виде дерева            | [Сообщения в представлении в виде дерева](/windows/desktop/Controls/bumper-tree-view-control-reference-messages) и уведомления в виде [дерева](/windows/desktop/Controls/bumper-tree-view-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **UDM** и **УДН**                  | Элемент управления "вверх/вниз"              | [Сообщения](/windows/desktop/Controls/bumper-up-down-control-reference-messages) со стрелками вверх [и вниз](/windows/desktop/Controls/bumper-up-down-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **WM**                               | Общие сведения                      | <dl> <dt>[Сообщения](/windows/desktop/dataxchg/clipboard-messages)</dt> в буфере <dt>[обмена уведомления об](/windows/desktop/dataxchg/clipboard-notifications)</dt> <dt>[общих диалоговых окнах](/windows/desktop/dlgbox/common-dialog-box-notifications)</dt> уведомления <dt>[курсора](/windows/desktop/menurc/cursor-notifications)</dt> <dt>[Копировать сообщение](/windows/desktop/dataxchg/wm-copydata)</dt> <dt>[Диспетчер окон рабочего стола сообщения](/windows/desktop/dwm/dwm-messages)</dt> об <dt>[](/windows/desktop/Controls/bumper-scroll-bars-reference-notifications)</dt> <dt>[](timer-notifications.md)</dt> <dt>[](window-messages.md)</dt> <dt>[](window-notifications.md)</dt> <dt>[управлении устройствами](/windows/desktop/DevIO/device-management-messages)</dt> уведомления <dt>[Платформа динамических данных сообщения Exchange](/windows/desktop/dataxchg/dynamic-data-exchange-messages)</dt> <dt>[Платформа динамических данных](/windows/desktop/dataxchg/dynamic-data-exchange-notifications)</dt> уведомления <dt>[](multiple-document-interface-messages.md)</dt> <dt>[](/windows/desktop/inputdev/raw-input-notifications)</dt> <dt>[обработчика](hook-notifications.md)</dt> уведомлений <dt>[о](/windows/desktop/menurc/keyboard-accelerator-messages)</dt> сообщениях в <dt>[диалоговом окне](/windows/desktop/dlgbox/dialog-box-notifications)</dt> <dt>[сообщения об](/windows/desktop/menurc/menu-notifications)</dt> ошибках <dt>[с помощью](/windows/desktop/inputdev/keyboard-input-notifications)</dt> <dt>[клавиатуры уведомления о](/windows/desktop/menurc/keyboard-accelerator-notifications)</dt> <dt>[вводе](/windows/desktop/inputdev/mouse-input-notifications)</dt> <dt>[. сообщения](/windows/desktop/inputdev/keyboard-input-messages)</dt> </dl> |



 

Общие сообщения окна охватывают широкий спектр информации и запросов, в том числе сообщения для ввода с клавиатуры, входа в меню и диалоговых окон, создания окон и управления ими, а также платформа динамических данных Exchange (DDE).

### <a name="application-defined-messages"></a>Сообщения Application-Defined

Приложение может создавать сообщения для использования в собственных окнах или для взаимодействия с Windows в других процессах. Если приложение создает собственные сообщения, процедура окна, принимающая их, должна интерпретировать сообщения и обеспечить соответствующую обработку.

Значения идентификаторов сообщений используются следующим образом.

-   Система резервирует значения идентификаторов сообщений в диапазоне от Символ 0x0000 до 0x03FF (значение [**WM \_ User**](wm-user.md)  – 1) для системных сообщений. Приложения не могут использовать эти значения для частных сообщений.
-   Значения в диапазоне 0x0400 (значение [**\_ пользователя WM**](wm-user.md)) через 0x7FFF доступны для идентификаторов сообщений для классов частных окон.
-   Если приложение помечено как версия 4,0, можно использовать значения идентификаторов сообщений в диапазоне от 0x8000 ([**\_ приложение WM**](wm-app.md)) до 0xBFFF для частных сообщений.
-   Система возвращает идентификатор сообщения в диапазоне от 0xC000 до 0xFFFF, когда приложение вызывает функцию [**регистервиндовмессаже**](/windows/win32/api/winuser/nf-winuser-registerwindowmessagea) для регистрации сообщения. Идентификатор сообщения, возвращаемый этой функцией, гарантированно уникален в пределах всей системы. Использование этой функции предотвращает конфликты, которые могут возникать, если другие приложения используют один и тот же идентификатор сообщения для разных целей.

## <a name="message-routing"></a>Маршрутизация сообщений

Система использует два метода для маршрутизации сообщений в оконную процедуру: отправка сообщений в очередь *сообщений*"первым помещается", системный объект памяти, который временно хранит сообщения и отправляет сообщения непосредственно в процедуру окна.

Сообщения, отправляемые в очередь сообщений, называются *сообщениями в очереди*. В первую очередь это результат ввода данных пользователем, введенный с помощью мыши или клавиатуры, [**например \_ WM MOUSEMOVE**](/windows/desktop/inputdev/wm-mousemove), [**WM \_ Лбуттондовн**](/windows/desktop/inputdev/wm-lbuttondown), [**WM \_ KeyDown**](/windows/desktop/inputdev/wm-keydown)и [**WM \_ char**](/windows/desktop/inputdev/wm-char) . Другие сообщения в очереди включают в себя таймер, Paint и сообщение о выходе [**: \_ таймер WM**](wm-timer.md), [**WM \_ Paint**](/windows/desktop/gdi/wm-paint)и [**WM \_ Quit**](wm-quit.md). Большинство других сообщений, которые отправляются непосредственно в процедуру окна, называются *сообщениями, не помещенными в очередь*.

-   [Сообщения в очереди](#queued-messages)
-   [Сообщения, не помещенные в очередь](#nonqueued-messages)

### <a name="queued-messages"></a>Сообщения в очереди

Система может отображать любое количество окон за раз. Чтобы направить ввод с клавиатуры и мыши в соответствующее окно, система использует очереди сообщений.

Система поддерживает одну очередь системных сообщений и одну очередь сообщений конкретного потока для каждого потока графического пользовательского интерфейса. Чтобы избежать издержек, связанных с созданием очереди сообщений для потоков, отличных от графического пользовательского интерфейса, все потоки изначально создаются без очереди сообщений. Система создает очередь сообщений, специфичную для конкретного потока, только когда поток выполняет первый вызов одной из конкретных пользовательских функций. вызовы функций графического пользовательского интерфейса не вызывают создание очереди сообщений.

Когда пользователь перемещает мышь, нажимает кнопки мыши или типы на клавиатуре, драйвер устройства для мыши или клавиатуры преобразует входные данные в сообщения и помещает их в очередь системных сообщений. Система удаляет сообщения по одному за раз из очереди системных сообщений, анализирует их, чтобы определить окно назначения, а затем отправляет их в очередь сообщений потока, создавшего окно назначения. Очередь сообщений потока получает все сообщения мыши и клавиатуры для окон, созданных потоком. Поток удаляет сообщения из своей очереди и направляет систему на отправку в соответствующую оконную процедуру для обработки.

За исключением сообщения [**WM \_ Paint**](/windows/desktop/gdi/wm-paint) , сообщения [**\_ таймера WM**](wm-timer.md) и сообщения [**WM \_ Quit**](wm-quit.md) , система всегда отправляет сообщения в конце очереди сообщений. Это гарантирует, что окно получит свои входные сообщения в соответствующей последовательности (FIFO). Однако сообщение **WM \_ Paint** , сообщение **\_ таймера WM** и сообщение **WM \_ Quit** хранятся в очереди и передаются в процедуру окна только в том случае, если очередь не содержит других сообщений. Кроме того, несколько сообщений **WM \_ Paint** для одного и того же окна объединяются в одно сообщение **WM \_ Paint** , объединяя все недопустимые части клиентской области в одну область. Сочетание сообщений **WM \_ Paint** сокращает число попыток, которым окно должно перерисовывать содержимое клиентской области.

Система отправляет сообщение в очередь сообщений потока, заполняя структуру [**MSG**](/windows/win32/api/winuser/ns-winuser-msg) и затем копируя ее в очередь сообщений. Информация в **MSG** включает: маркер окна, для которого предназначено сообщение, идентификатор сообщения, два параметра сообщения, время отправки сообщения и позицию курсора мыши. Поток может поместить сообщение в собственную очередь сообщений или в очередь другого потока с помощью функции [**onmessage**](/windows/win32/api/winuser/nf-winuser-postmessagea) или [**постсреадмессаже**](/windows/win32/api/winuser/nf-winuser-postthreadmessagea) .

Приложение может удалить сообщение из очереди с помощью функции- [**сообщения**](/windows/win32/api/winuser/nf-winuser-getmessage) . Чтобы проверить сообщение, не удаляя его из очереди, приложение может использовать функцию [**PeekMessage**](/windows/win32/api/winuser/nf-winuser-peekmessagea) . Эта [**функция заполняет сообщения**](/windows/win32/api/winuser/ns-winuser-msg) информацией о сообщении.

После удаления сообщения из очереди приложение может использовать функцию [**DispatchMessage**](/windows/win32/api/winuser/nf-winuser-dispatchmessage) , чтобы направить систему на отправку сообщения в процедуру окна для обработки. **DispatchMessage** принимает указатель на [**сообщение**](/windows/win32/api/winuser/ns-winuser-msg) , заполненное предыдущим вызовом функции [**MSG или**](/windows/win32/api/winuser/nf-winuser-getmessage) [**PeekMessage**](/windows/win32/api/winuser/nf-winuser-peekmessagea) . **DispatchMessage** передает обработчик окна, идентификатор сообщения и два параметра сообщения в процедуру окна, но не передает время отправки сообщения или положения курсора мыши. Приложение может получить эти сведения, вызвав функции [**жетмессажетиме**](/windows/win32/api/winuser/nf-winuser-getmessagetime) и [**жетмессажепос**](/windows/win32/api/winuser/nf-winuser-getmessagepos) при обработке сообщения.

Поток может использовать функцию [**ваитмессаже**](/windows/win32/api/winuser/nf-winuser-waitmessage) для передачи управления другим потокам, если в очереди сообщений нет сообщений. Функция приостанавливает поток и не возвращает значение, пока в очередь сообщений потока не помещается новое сообщение.

Чтобы связать значение с очередью сообщений текущего потока, можно вызвать функцию [**сетмессажеекстраинфо**](/windows/win32/api/winuser/nf-winuser-setmessageextrainfo) . Затем вызовите функцию [**жетмессажеекстраинфо**](/windows/win32/api/winuser/nf-winuser-getmessageextrainfo) , чтобы получить значение, связанное с последним сообщением, полученным функцией [**пересообщения**](/windows/win32/api/winuser/nf-winuser-getmessage) или функции [**PeekMessage**](/windows/win32/api/winuser/nf-winuser-peekmessagea) .

### <a name="nonqueued-messages"></a>Сообщения, не помещенные в очередь

Сообщения, не помещенные в очередь, немедленно отправляются в конечную процедуру окна назначения, минуя очередь системных сообщений и очередь сообщений потока. Система обычно отправляет сообщения, не помещенные в очередь, чтобы уведомить окно событий, влияющих на него. Например, когда пользователь активирует новое окно приложения, система отправляет окну ряд сообщений, включая [**WM \_ Activate**](/windows/desktop/inputdev/wm-activate), [**WM \_ SETFOCUS**](/windows/desktop/inputdev/wm-setfocus)и [**WM \_ сеткурсор**](/windows/desktop/menurc/wm-setcursor). Эти сообщения уведомляют окно о том, что оно было активировано, что ввод с клавиатуры направляется в окно, а курсор мыши переместился в границы окна. Непоставленные в очередь сообщения также могут быть вызваны тем, что приложение вызывает определенные системные функции. Например, система отправляет сообщение [**WM \_ виндовпосчанжед**](wm-windowposchanged.md) после того, как приложение использует функцию [**SetWindowPos**](/windows/win32/api/winuser/nf-winuser-setwindowpos) для перемещения окна.

Некоторые функции, отправляющие сообщения, не помещенные в очередь, — это [**броадкастсистеммессаже**](/windows/win32/api/winuser/nf-winuser-broadcastsystemmessage), [**броадкастсистеммессажеекс**](/windows/win32/api/winuser/nf-winuser-broadcastsystemmessageexa), [**SendMessage**](/windows/win32/api/winuser/nf-winuser-sendmessage), [**функции sendmessagetimeout**](/windows/win32/api/winuser/nf-winuser-sendmessagetimeouta)и [**сенднотифимессаже**](/windows/win32/api/winuser/nf-winuser-sendnotifymessagea).

## <a name="message-handling"></a>Обработка сообщений

Приложение должно удалять и обрабатывать сообщения, размещенные в очередях сообщений своих потоков. Однопотоковое приложение обычно использует *цикл обработки сообщений* в функции [**WinMain**](/windows/win32/api/winbase/nf-winbase-winmain) , чтобы удалять и отсылать сообщения в соответствующие процедуры окна при обработке. Приложения с несколькими потоками могут включать цикл обработки сообщений в каждом потоке, который создает окно. В следующих разделах описывается работа цикла сообщений и объясняется роль процедуры окна:

-   [Цикл обработки сообщений](#message-loop)
-   [Процедура окна](#window-procedure)

### <a name="message-loop"></a>Цикл обработки сообщений

Простой цикл обработки сообщений состоит из одного вызова функции в каждую из этих трех [**функций: TranslateMessage,**](/windows/win32/api/winuser/nf-winuser-getmessage) [**DispatchMessage**](/windows/win32/api/winuser/nf-winuser-dispatchmessage). [](/windows/win32/api/winuser/nf-winuser-translatemessage) Обратите внимание, что при возникновении ошибки функция **onmessage** возвращает значение – 1, поэтому требуется специальное тестирование.


```
MSG msg;
BOOL bRet;

while( (bRet = GetMessage( &msg, NULL, 0, 0 )) != 0)
{ 
    if (bRet == -1)
    {
        // handle the error and possibly exit
    }
    else
    {
        TranslateMessage(&msg); 
        DispatchMessage(&msg); 
    }
}
```



Функция [**MSG**](/windows/win32/api/winuser/nf-winuser-getmessage) получает сообщение из очереди и копирует его в структуру типа [**MSG**](/windows/win32/api/winuser/ns-winuser-msg). Он возвращает ненулевое значение, если не обнаруживает сообщение [**WM \_ Quit**](wm-quit.md) , в этом случае возвращается **значение false** и завершается цикл. В многопоточном приложении завершение цикла обработки сообщений часто является первым шагом при закрытии приложения. Приложение может завершить собственный цикл с помощью функции [**посткуитмессаже**](/windows/win32/api/winuser/nf-winuser-postquitmessage) , как правило, в ответ на сообщение [**WM \_ destroy**](wm-destroy.md) в оконной процедуре главного окна приложения.

Если указать в качестве второго [**параметра аргумента Window, то**](/windows/win32/api/winuser/nf-winuser-getmessage)из очереди будут извлекаться только сообщения для указанного окна. Кроме того, в **сообщении** можно фильтровать сообщения в очереди, получая только те сообщения, которые попадают в указанный диапазон. Дополнительные сведения о фильтрации сообщений см. в разделе [Фильтрация сообщений](#message-filtering).

Цикл обработки сообщений потока должен включать [**TranslateMessage**](/windows/win32/api/winuser/nf-winuser-translatemessage) , если поток может принимать символьные данные с клавиатуры. Система создает сообщения виртуального ключа ([**WM \_ KeyDown**](/windows/desktop/inputdev/wm-keydown) и [**WM \_ KEYUP**](/windows/desktop/inputdev/wm-keyup)) каждый раз, когда пользователь нажимает клавишу. Сообщение виртуального ключа содержит код виртуального ключа, который определяет, какой ключ был нажат, но не его значение. Чтобы получить это значение, цикл обработки сообщений должен содержать **TranslateMessage**, который преобразует сообщение виртуального ключа в символьное сообщение ([**WM \_ char**](/windows/desktop/inputdev/wm-char)) и помещает его обратно в очередь сообщений приложения. Символьное сообщение может быть удалено при последующей итерации цикла обработки сообщений и отправлено в процедуру окна.

Функция [**DispatchMessage**](/windows/win32/api/winuser/nf-winuser-dispatchmessage) отправляет сообщение в процедуру окна, связанную с маркером окна, указанным в структуре [**MSG**](/windows/win32/api/winuser/ns-winuser-msg) . Если дескриптор окна находится на **\_ самом верхнем уровне HWND**, **DispatchMessage** отправляет сообщение в процедуры окна всех окон верхнего уровня в системе. Если указатель окна имеет **значение NULL**, **DispatchMessage** не выполняет никаких действий с сообщением.

Главный поток приложения запускает цикл обработки сообщений после инициализации приложения и создания хотя бы одного окна. После запуска цикл обработки сообщений продолжит получать сообщения из очереди сообщений потока и отправлять их в соответствующие окна. Цикл обработки сообщений завершается, когда функция [**onmessage**](/windows/win32/api/winuser/nf-winuser-getmessage) удаляет сообщение [**WM \_ Quit**](wm-quit.md) из очереди сообщений.

Для очереди сообщений требуется только один цикл обработки сообщений, даже если приложение содержит много окон. [**DispatchMessage**](/windows/win32/api/winuser/nf-winuser-dispatchmessage) всегда отправляет сообщение в соответствующее окно; Это связано с тем, что каждое сообщение в очереди [**является структурой**](/windows/win32/api/winuser/ns-winuser-msg) сообщений, содержащей маркер окна, которому принадлежит сообщение.

Можно изменить цикл обработки сообщений различными способами. Например, можно извлечь сообщения из очереди без их отправки в окно. Это полезно для приложений, которые передают сообщения, не указывающие окно. Кроме того, можно направить [**сообщение**](/windows/win32/api/winuser/nf-winuser-getmessage) в поиск конкретных сообщений, открывая другие сообщения в очереди. Это полезно, если необходимо временно обойти обычный порядок FIFO очереди сообщений.

Приложение, использующее сочетания клавиш, должно иметь возможность преобразования сообщений клавиатуры в командные сообщения. Для этого цикл обработки сообщений приложения должен включать вызов функции [**TranslateAccelerator**](/windows/desktop/api/winuser/nf-winuser-translateacceleratora) . Дополнительные сведения о сочетаниях клавиш см. в разделе [сочетания](/windows/desktop/menurc/keyboard-accelerators)клавиш.

Если поток использует немодальное диалоговое окно, то цикл обработки сообщений должен включать функцию [**исдиалогмессаже**](/windows/desktop/api/winuser/nf-winuser-isdialogmessagea) , чтобы диалоговое окно могла получить ввод с клавиатуры.

### <a name="window-procedure"></a>Процедура окна

Оконная процедура — это функция, которая получает и обрабатывает все сообщения, отправленные в окно. Каждый класс окна содержит процедуру окна, и каждое окно, созданное с помощью этого класса, использует эту же оконную процедуру для реагирования на сообщения.

Система отправляет сообщение в процедуру окна, передавая данные сообщения в качестве аргументов в процедуру. Затем процедура окна выполняет соответствующее действие для сообщения. Он проверяет идентификатор сообщения и при обработке сообщения использует сведения, указанные в параметрах сообщения.

Процедура окна обычно не игнорирует сообщение. Если сообщение не обрабатывается, оно должно отправить сообщение обратно в систему для обработки по умолчанию. Оконная процедура делает это путем вызова функции [**дефвиндовпрок**](/windows/desktop/api/winuser/nf-winuser-defwindowproca) , которая выполняет действие по умолчанию и возвращает результат сообщения. Затем процедура Window должна вернуть это значение в виде собственного результата сообщения. Большинство процедур обработки окон обрабатывают всего несколько сообщений и передают все остальные в систему, вызывая **дефвиндовпрок**.

Так как процедура окна совместно используется всеми окнами, принадлежащими одному и тому же классу, она может обрабатывать сообщения для нескольких различных окон. Чтобы определить конкретное окно, затронутое сообщением, процедура окна может проверить маркер окна, переданный в сообщении. Дополнительные сведения о процедурах окна см. в разделе [процедуры окна](window-procedures.md).

## <a name="message-filtering"></a>Фильтрация сообщений

Приложение может выбирать определенные сообщения для извлечения из очереди сообщений (при пропуске других сообщений) с помощью функции [**PeekMessage**](/windows/win32/api/winuser/nf-winuser-peekmessagea) или метода with [**Message**](/windows/win32/api/winuser/nf-winuser-getmessage) для указания фильтра сообщений. Фильтр — это диапазон идентификаторов сообщений (определяемый первым и последним идентификатором), обработчиком окна или и то, и другое. Для выбора **сообщений, которые** необходимо извлечь из очереди, используется фильтр сообщений и **PeekMessage** . Фильтрация сообщений полезна, если приложение должно искать в очереди сообщений сообщения, которые были получены позже в очереди. Он также полезен, если приложение должно обрабатывать входные сообщения (оборудование) перед обработкой отправленных сообщений.

Константы **WM \_ Кэйфирст** и **WM \_ кэйласт** могут использоваться в качестве значений фильтров для получения всех сообщений клавиатуры; константы **WM \_ маусефирст** и **WM \_ мауселаст** можно использовать для получения всех сообщений мыши.

Любое приложение, фильтрующее сообщения, должно гарантировать, что может быть отправлено сообщение, удовлетворяющее условиям фильтра сообщений. Например, если приложение фильтрует сообщение [**WM \_ char**](/windows/desktop/inputdev/wm-char) в окне, которое не получает ввод с клавиатуры [**, функция GetChars**](/windows/win32/api/winuser/nf-winuser-getmessage) не возвращает значение. Это фактически «зависает» приложение.

## <a name="posting-and-sending-messages"></a>Публикация и отправка сообщений

Любое приложение может публиковать и отправлять сообщения. Как и система, приложение отправляет сообщение, копируя его в очередь сообщений, и отправляет сообщение, передавая данные сообщения в качестве аргументов в процедуру окна. Для публикации сообщений приложение использует функцию [**сообщений**](/windows/win32/api/winuser/nf-winuser-postmessagea) . Приложение может отправить сообщение, вызвав функцию [**SendMessage**](/windows/win32/api/winuser/nf-winuser-sendmessage), [**броадкастсистеммессаже**](/windows/win32/api/winuser/nf-winuser-broadcastsystemmessage), [**сендмессажекаллбакк**](/windows/win32/api/winuser/nf-winuser-sendmessagecallbacka), [**функции sendmessagetimeout**](/windows/win32/api/winuser/nf-winuser-sendmessagetimeouta), [**сенднотифимессаже**](/windows/win32/api/winuser/nf-winuser-sendnotifymessagea)или [**сенддлгитеммессаже**](/windows/desktop/api/winuser/nf-winuser-senddlgitemmessagea) .

### <a name="posting-messages"></a>Отправка сообщений

Приложение обычно отправляет сообщение для уведомления определенного окна о выполнении задачи. Параметр i [**Message**](/windows/win32/api/winuser/nf-winuser-postmessagea) создает [**структуру сообщений**](/windows/win32/api/winuser/ns-winuser-msg) для сообщения и копирует сообщение в очередь сообщений. Цикл обработки сообщений приложения в конечном итоге извлекает сообщение и отправляет его в соответствующую процедуру окна.

Приложение может публиковать сообщение без указания окна. Если приложение предоставляет **нулевой** маркер окна при вызове [**сообщения**](/windows/win32/api/winuser/nf-winuser-postmessagea), сообщение отправляется в очередь, связанную с текущим потоком. Поскольку маркер окна не указан, приложение должно обработать сообщение в цикле обработки сообщений. Это один из способов создания сообщения, которое применяется ко всему приложению, а не к конкретному окну.

Иногда может потребоваться опубликовать сообщение во всех окнах верхнего уровня в системе. Приложение может опубликовать сообщение во всех окнах верхнего уровня, вызвав [**сообщение**](/windows/win32/api/winuser/nf-winuser-postmessagea) и указав HWND Top **\_** в параметре *HWND* .

Распространенная ошибка программирования заключается в том, что функция отправки [**сообщений**](/windows/win32/api/winuser/nf-winuser-postmessagea) всегда отправляет сообщение. Это не имеет значения, если очередь сообщений заполнена. Приложение должно проверить возвращаемое значение функции почтовых **сообщений** , чтобы определить, было ли сообщение отправлено, и, если оно не было, перенесите его.

### <a name="sending-messages"></a>отправка сообщений

Приложение обычно отправляет сообщение, чтобы уведомить процедуру окна о необходимости немедленного выполнения задачи. Функция [**SendMessage**](/windows/win32/api/winuser/nf-winuser-sendmessage) отправляет сообщение в процедуру окна, соответствующую заданному окну. Функция ожидает, пока процедура окна не завершит обработку, а затем вернет результат сообщения. Родительские и дочерние окна часто взаимодействуют, отправляя сообщения друг другу. Например, родительское окно, имеющее элемент управления "поле ввода" в качестве дочернего окна, может задать текст элемента управления, отправив ему сообщение. Элемент управления может уведомлять родительское окно об изменениях текста, которые выполняются пользователем, отправляя сообщения обратно в родительский объект.

Функция [**сендмессажекаллбакк**](/windows/win32/api/winuser/nf-winuser-sendmessagecallbacka) также отправляет сообщение в процедуру окна, соответствующую заданному окну. Однако эта функция возвращает значение немедленно. После того, как процедура окна обработает сообщение, система вызывает указанную функцию обратного вызова. Дополнительные сведения о функции обратного вызова см. в описании функции [**сендасинкпрок**](/windows/win32/api/winuser/nc-winuser-sendasyncproc) .

Иногда может потребоваться отправить сообщение всем окнам верхнего уровня в системе. Например, если приложение изменяет системное время, оно должно уведомлять все окна верхнего уровня об изменении, отправляя сообщение [**WM \_ тимечанже**](../sysinfo/wm-timechange.md) . Приложение может отправить сообщение всем окнам верхнего уровня, вызвав [**SendMessage**](/windows/win32/api/winuser/nf-winuser-sendmessage) и указав HWND Top **\_** в параметре *HWND* . Вы также можете транслировать сообщение во все приложения, вызвав функцию [**броадкастсистеммессаже**](/windows/win32/api/winuser/nf-winuser-broadcastsystemmessage) и указав **\_ приложения BSM** в параметре *лпдвреЦипиентс* .

С помощью функций [**SendMessage**](/windows/win32/api/winuser/nf-winuser-insendmessage) или [**инсендмессажеекс**](/windows/win32/api/winuser/nf-winuser-insendmessageex) процедура окна может определить, обрабатывается ли сообщение, отправленное другим потоком. Эта возможность полезна, если обработка сообщений зависит от происхождения сообщения.

## <a name="message-deadlocks"></a>Взаимоблокировки сообщений

Поток, который вызывает функцию [**SendMessage**](/windows/win32/api/winuser/nf-winuser-sendmessage) для отправки сообщения в другой поток, не может продолжить выполнение до тех пор, пока не будет возвращена процедура окна, получающая сообщение. Если принимающий поток получает управление при обработке сообщения, то поток отправки не может продолжать выполнение, так как он ожидает возврата **SendMessage** . Если принимающий поток присоединен к той же очереди, что и отправитель, это может привести к взаимоблокировке приложения. (Обратите внимание, что обработчики журнала присоединяют потоки к одной очереди.)

Обратите внимание, что принимающему потоку не требуется явно управлять yield; вызов любой из следующих функций может привести к неявному получению потоком управления.

-   [**диалогбокс**](/windows/desktop/api/winuser/nf-winuser-dialogboxa)
-   [**диалогбоксиндирект**](/windows/desktop/api/winuser/nf-winuser-dialogboxindirecta)
-   [**диалогбоксиндиректпарам**](/windows/desktop/api/winuser/nf-winuser-dialogboxindirectparama)
-   [**диалогбокспарам**](/windows/desktop/api/winuser/nf-winuser-dialogboxparama)
-   [**GetMessage**](/windows/win32/api/winuser/nf-winuser-getmessage)
-   [**MessageBox**](/windows/desktop/api/winuser/nf-winuser-messagebox)
-   [**PeekMessage**](/windows/win32/api/winuser/nf-winuser-peekmessagea)
-   [**SendMessage**](/windows/win32/api/winuser/nf-winuser-sendmessage)

Чтобы избежать потенциальных взаимоблокировок в приложении, рассмотрите возможность использования функций [**сенднотифимессаже**](/windows/win32/api/winuser/nf-winuser-sendnotifymessagea) или [**функции sendmessagetimeout**](/windows/win32/api/winuser/nf-winuser-sendmessagetimeouta) . В противном случае процедура окна может определить, было ли полученное сообщение отправлено другим потоком путем вызова функции [**SendMessage**](/windows/win32/api/winuser/nf-winuser-insendmessage) или [**инсендмессажеекс**](/windows/win32/api/winuser/nf-winuser-insendmessageex) . Перед вызовом любой из функций из предыдущего списка при обработке сообщения процедура окна должна сначала вызвать **SendMessage** или **инсендмессажеекс**. Если эта функция возвращает **значение true**, то процедура Window должна вызывать функцию [**реплимессаже**](/windows/win32/api/winuser/nf-winuser-replymessage) перед любой функцией, которая приводит к получению управления потоком.

## <a name="broadcasting-messages"></a>Широковещательная рассылка сообщений

Каждое сообщение состоит из идентификатора сообщения и двух параметров: *wParam* и *lParam*. Идентификатор сообщения — это уникальное значение, указывающее назначение сообщения. Параметры предоставляют дополнительные сведения, относящиеся к конкретному сообщению, но параметр *wParam* обычно представляет собой значение типа, которое предоставляет дополнительные сведения о сообщении.

*Вещание сообщения* — это просто отправка сообщения нескольким получателям в системе. Чтобы выполнить широковещательную рассылку сообщения из приложения, используйте функцию [**броадкастсистеммессаже**](/windows/win32/api/winuser/nf-winuser-broadcastsystemmessage) , указав получателей сообщения. Вместо того чтобы указывать отдельных получателей, необходимо указать одного или нескольких типов получателей. Эти типы являются приложениями, устанавливаемыми драйверами, сетевыми драйверами и драйверами устройств на уровне системы. Система отправляет широковещательные сообщения всем членам каждого указанного типа.

Обычно система передает сообщения в ответ на изменения, которые выполняются в драйверах устройств на уровне системы или связанных компонентах. Драйвер или связанный компонент передает сообщение в приложения и другие компоненты, чтобы уведомить их об изменении. Например, компонент, ответственный за диски, передает сообщение, когда драйвер устройства для дисковода гибких дисков обнаруживает смену носителя, например, когда пользователь вставляет диск в дисковод.

Система передает сообщения получателям в следующем порядке: драйверы устройств на уровне системы, сетевые драйверы, устанавливаемые драйверы и приложения. Это означает, что драйверы устройств системного уровня, если они выбраны в качестве получателей, всегда получат первую возможность ответить на сообщение. В пределах заданного типа получателя драйвер не гарантированно получает данное сообщение перед любым другим драйвером. Это означает, что сообщение, предназначенное для конкретного драйвера, должно иметь глобальный уникальный идентификатор сообщения, чтобы другой драйвер не мог его непреднамеренно обрабатывать.

Кроме того, сообщения можно рассылать во все окна верхнего уровня, **задав \_ широковещательное сообщение HWND** в функции [**SendMessage**](/windows/win32/api/winuser/nf-winuser-sendmessage), [**сендмессажекаллбакк**](/windows/win32/api/winuser/nf-winuser-sendmessagecallbacka), [**функции sendmessagetimeout**](/windows/win32/api/winuser/nf-winuser-sendmessagetimeouta)или [**сенднотифимессаже**](/windows/win32/api/winuser/nf-winuser-sendnotifymessagea) .

Приложения получают сообщения через процедуру окна своих окон верхнего уровня. Сообщения не отправляются в дочерние окна. Службы могут принимать сообщения с помощью процедуры окна или их обработчиков управления службами.

> [!Note]  
> Драйверы устройств на уровне системы используют связанную функцию на уровне системы для вещания системных сообщений.

 

## <a name="query-messages"></a>Сообщения запроса

Вы можете создавать собственные пользовательские сообщения и использовать их для координации действий между приложениями и другими компонентами системы. Это особенно полезно, если вы создали собственные устанавливаемые драйверы или драйверы устройств на уровне системы. Пользовательские сообщения могут содержать сведения о драйвере и приложениях, использующих этот драйвер, и из него.

Чтобы опросить получателей для разрешения на выполнение заданного действия, используйте *сообщение запроса*. Вы можете создавать собственные сообщения запроса, задав значение **\_ запроса БСФ** в параметре *DwFlags* при вызове [**броадкастсистеммессаже**](/windows/win32/api/winuser/nf-winuser-broadcastsystemmessage). Каждый получатель сообщения запроса должен возвращать **значение true** , чтобы функция отправляла сообщение следующему получателю. Если какой-либо получатель возвращает **\_ запрос на \_ отклонение широковещательного запроса**, вещание немедленно завершается, а функция возвращает ноль.

 

 
