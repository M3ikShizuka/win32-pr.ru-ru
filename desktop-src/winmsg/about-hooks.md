---
description: В этом разделе обсуждается использование обработчиков.
ms.assetid: 9ced0ac4-e602-425f-b954-6af9c741699a
title: Обзор обработчиков
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 36c5d89f111604418d1dc3ea9a4ebce6fe0a8124
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105656661"
---
# <a name="hooks-overview"></a>Обзор обработчиков

*Обработчик* — это механизм, с помощью которого приложение может перехватить события, такие как сообщения, действия мыши и нажатия клавиш. Функция, которая перехватывает события определенного типа, называется *процедурой-обработчиком*. Процедура-обработчик может действовать для каждого получаемого события, а затем изменить или отменить событие.

В следующем примере используется для перехватчиков:

-   Мониторинг сообщений в целях отладки
-   Предоставление поддержки для записи и воспроизведения макросов
-   Предоставление поддержки для клавиши справки (F1)
-   Имитация ввода с помощью мыши и клавиатуры
-   Реализация приложения для обучения на основе компьютеров (CBT)

> [!Note]  
> Обработчики обычно замедляют работу системы, так как они увеличивают объем обработки, которую должна выполнить система для каждого сообщения. Обработчик следует устанавливать только при необходимости и удалять его как можно скорее.

 

В этом разделе рассматриваются следующие вопросы:

-   [Цепочки обработчиков](#hook-chains)
-   [Процедуры-обработчики](#hook-procedures)
-   [Типы обработчиков](#hook-types)
    -   [Что такое каллвндпрок и т. д. \_ \_ каллвндпрокрет](#wh_callwndproc-and-wh_callwndprocret)
    -   [что такое \_ CBT](#wh_cbt)
    -   [что такое \_ Отладка](#wh_debug)
    -   [что такое \_ фореграундидле](#wh_foregroundidle)
    -   [что такое \_ сообщение](#wh_getmessage)
    -   [что такое \_ жаурналплайбакк](#wh_journalplayback)
    -   [что такое \_ жаурналрекорд](#wh_journalrecord)
    -   [что такое \_ сочетание клавиш \_](#wh_keyboard_ll)
    -   [что такое \_ клавиатура](#wh_keyboard)
    -   [что такое \_ мышь \_](#wh_mouse_ll)
    -   [что такое \_ мышь](#wh_mouse)
    -   [Что такое мсгфилтер и т. д. \_ \_ сисмсгфилтер](#wh_msgfilter-and-wh_sysmsgfilter)
    -   [что такое \_ оболочка](#wh_shell)

## <a name="hook-chains"></a>Цепочки обработчиков

Система поддерживает множество различных типов обработчиков. Каждый тип предоставляет доступ к разным аспектам механизма обработки сообщений. Например, приложение может использовать обработчик [ \_ мыши](#wh_mouse) , который позволяет отслеживать трафик сообщений для сообщений мыши.

Система поддерживает отдельную цепочку обработчиков для каждого типа обработчика. *Цепочка обработчиков* представляет собой список указателей на специальные, определяемые приложением функции обратного вызова, называемые *процедурами обработчика*. При возникновении сообщения, связанного с определенным типом обработчика, система передает сообщение каждой процедуре подключения, упоминаемой в цепочке обработчиков, один за другим. Действие, которое может выполнить процедура-ловушка, зависит от типа вовлеченного обработчика. Процедуры-обработчики для некоторых типов обработчиков могут отслеживать только сообщения. другие пользователи могут изменять сообщения или прекращать их выполнение через цепочку, предотвращая переход к следующей процедуре обработки или конечному окну.

## <a name="hook-procedures"></a>Процедуры-обработчики

Чтобы воспользоваться преимуществами определенного типа обработчика, разработчик предоставляет процедуру-обработчик и использует функцию [**сетвиндовшукекс**](/windows/win32/api/winuser/nf-winuser-setwindowshookexa) , чтобы установить ее в цепочку, связанную с обработчиком. Процедура-обработчик должна иметь следующий синтаксис:

``` syntax
LRESULT CALLBACK HookProc(
  int nCode, 
  WPARAM wParam, 
  LPARAM lParam
)
{
   // process event
   ...

   return CallNextHookEx(NULL, nCode, wParam, lParam);
}
```

*Хукпрок* — это заполнитель для определяемого приложением имени.

Параметр *нкоде* — это код обработчика, используемый процедурой-обработчиком для определения выполняемого действия. Значение кода обработчика зависит от типа обработчика; Каждый тип имеет собственный набор характеристик кодов обработчиков. Значения параметров *wParam* и *lParam* зависят от кода обработчика, но обычно содержат сведения о отправленном или опубликованном сообщении.

Функция [**сетвиндовшукекс**](/windows/win32/api/winuser/nf-winuser-setwindowshookexa) всегда устанавливает процедуру-обработчик в начале цепочки обработчиков. При возникновении события, отслеживаемого определенным типом обработчика, система вызывает процедуру в начале цепочки перехватчиков, связанной с обработчиком. Каждая процедура-ловушка в цепочке определяет, следует ли передавать событие в следующую процедуру. Процедура-обработчик передает событие следующей процедуре, вызывая функцию [**каллнекссукекс**](/windows/win32/api/winuser/nf-winuser-callnexthookex) .

Обратите внимание, что процедуры-обработчики для некоторых типов обработчиков могут наблюдать только за сообщениями. система передает сообщения каждой процедуре-обработчику независимо от того, вызывает ли конкретная процедура [**каллнекссукекс**](/windows/win32/api/winuser/nf-winuser-callnexthookex).

*Глобальный обработчик* отслеживает сообщения для всех потоков на том же рабочем столе, что и вызывающий поток. *Привязанный к конкретному потоку обработчик* отслеживает сообщения только для отдельного потока. Глобальную процедуру-ловушку можно вызвать в контексте любого приложения на том же рабочем столе, что и вызывающий поток, поэтому процедура должна находиться в отдельном модуле DLL. Процедура обработчика, относящаяся к конкретному потоку, вызывается только в контексте связанного потока. Если приложение устанавливает процедуру-обработчик для одного из своих собственных потоков, процедура обработки может находиться в том же модуле, что и остальная часть кода приложения или в библиотеке DLL. Если приложение устанавливает процедуру-обработчик для потока другого приложения, процедура должна быть в библиотеке DLL. Дополнительные сведения см. в разделе [библиотеки динамической компоновки](../dlls/dynamic-link-libraries.md).

> [!Note]  
> Глобальные перехватчики следует использовать только в целях отладки. в противном случае следует избегать их. Глобальные перехватчики снижают производительность системы и вызывают конфликты с другими приложениями, которые реализуют тот же тип глобального обработчика.

 

## <a name="hook-types"></a>Типы обработчиков

Каждый тип ловушки позволяет приложению отслеживать различные аспекты механизма обработки сообщений системы. В следующих разделах описываются доступные обработчики.

-   [Что такое каллвндпрок и т. д. \_ \_ каллвндпрокрет](#wh_callwndproc-and-wh_callwndprocret)
-   [что такое \_ CBT](#wh_cbt)
-   [что такое \_ Отладка](#wh_debug)
-   [что такое \_ фореграундидле](#wh_foregroundidle)
-   [что такое \_ сообщение](#wh_getmessage)
-   [что такое \_ жаурналплайбакк](#wh_journalplayback)
-   [что такое \_ жаурналрекорд](#wh_journalrecord)
-   [что такое \_ сочетание клавиш \_](#wh_keyboard_ll)
-   [что такое \_ клавиатура](#wh_keyboard)
-   [что такое \_ мышь \_](#wh_mouse_ll)
-   [что такое \_ мышь](#wh_mouse)
-   [Что такое мсгфилтер и т. д. \_ \_ сисмсгфилтер](#wh_msgfilter-and-wh_sysmsgfilter)
-   [что такое \_ оболочка](#wh_shell)

### <a name="wh_callwndproc-and-wh_callwndprocret"></a>Что такое каллвндпрок и т. д. \_ \_ каллвндпрокрет

**\_ Каллвндпрок** и **\_ предкаллвндпрокретные** перехватчики, позволяющие отслеживать сообщения, отправленные в процедуры окна. Система вызывает процедуру- **обработчик \_ каллвндпрок** перед передачей сообщения в процедуру получения окна и вызывает процедуру **\_ каллвндпрокрет** -обработчика после того, как процедура Window обработала сообщение.

Обработчик **\_ каллвндпрокрет** передает указатель на структуру [**квпретструкт**](/windows/win32/api/winuser/ns-winuser-cwpretstruct) в процедуру-обработчик. Структура содержит возвращаемое значение из процедуры окна, которая обработала сообщение, а также параметры сообщения, связанные с сообщением. Подклассировать окно не работает для сообщений, настроенных между процессами.

Дополнительные сведения см. в разделе функции обратного вызова [*каллвндпрок*](/previous-versions/windows/desktop/legacy/ms644975(v=vs.85)) и [*каллвндретпрок*](/windows/win32/api/winuser/nc-winuser-hookproc) .

### <a name="wh_cbt"></a>что такое \_ CBT

Система вызывает процедуру- **обработчик \_ CBT** перед активацией, созданием, уничтожением, свертыванием, развертыванием, перемещением или изменением размера окна; перед выполнением системной команды; перед удалением события мыши или клавиатуры из очереди системных сообщений перед тем, как установить фокус ввода или перед синхронизацией с системной очередью сообщений. Значение, возвращаемое процедурой-обработчиком, определяет, разрешает ли система выполнение одной из этих операций. **\_ CBTный** обработчик предназначен главным образом для приложений обучения на основе компьютеров (CBT).

Дополнительные сведения см. в описании функции обратного вызова [*кбтпрок*](/previous-versions/windows/desktop/legacy/ms644977(v=vs.85)) .

Дополнительные сведения см. в разделе [виневентс](/windows/desktop/WinAuto/winevents-infrastructure).

### <a name="wh_debug"></a>что такое \_ Отладка

Система вызывает процедуру-ловушку **\_ отладки** перед вызовом процедур-обработчиков, связанных с любым другим обработчиком в системе. С помощью этого обработчика можно определить, следует ли разрешить системе вызывать процедуры-обработчики, связанные с другими типами обработчиков.

Дополнительные сведения см. в описании функции обратного вызова [*дебугпрок*](/previous-versions/windows/desktop/legacy/ms644978(v=vs.85)) .

### <a name="wh_foregroundidle"></a>что такое \_ фореграундидле

**\_ Фореграундидленый** обработчик позволяет выполнять задачи с низким приоритетом во время бездействия основного потока. Система вызывает процедуру **\_ фореграундидле** -обработчика, когда передний поток приложения собирается стать неактивным.

Дополнительные сведения см. в описании функции обратного вызова [*фореграундидлепрок*](/previous-versions/windows/desktop/legacy/ms644980(v=vs.85)) .

### <a name="wh_getmessage"></a>что такое \_ сообщение

Функция, включающая обработчик **\_ сообщений** , позволяет приложению отслеживать [**сообщения,**](/windows/win32/api/winuser/nf-winuser-getmessage) возвращаемые функцией [**PeekMessage**](/windows/win32/api/winuser/nf-winuser-peekmessagea) . **С помощью этого обработчика \_** можно отслеживать ввод с помощью мыши и клавиатуры, а также другие сообщения, размещенные в очереди сообщений.

Дополнительные сведения см. в описании функции обратного вызова [*жетмсгпрок*](/previous-versions/windows/desktop/legacy/ms644981(v=vs.85)) .

### <a name="wh_journalplayback"></a>что такое \_ жаурналплайбакк

**\_ Жаурналплайбаккющий** обработчик позволяет приложению вставлять сообщения в очередь системных сообщений. Этот обработчик можно использовать для воспроизведения ряда событий мыши и клавиатуры, записанных ранее, с помощью функции [ \_ жаурналрекорд](#wh_journalrecord). Обычная мышь и ввод с клавиатуры отключаются при условии, что установлен обработчик **\_ жаурналплайбакк** . **\_ Жаурналплайбакк** обработчик — это глобальный обработчик — он не может использоваться в качестве обработчика для конкретного потока.

**\_ Жаурналплайбаккющий** обработчик возвращает значение времени ожидания. Это значение указывает системе, сколько миллисекунд следует ожидать перед обработкой текущего сообщения от обработчика воспроизведения. Это позволяет обработчику управлять временем воспроизводимых событий.

Дополнительные сведения см. в описании функции обратного вызова [*жаурналплайбаккпрок*](/previous-versions/windows/desktop/legacy/ms644982(v=vs.85)) .

### <a name="wh_journalrecord"></a>что такое \_ жаурналрекорд

**\_ Жаурналрекордющий** обработчик позволяет отслеживать и записывать события ввода. Как правило, этот обработчик используется для записи последовательности событий мыши и клавиатуры для последующего воспроизведения с помощью [ \_ жаурналплайбакк](#wh_journalplayback). **\_ Жаурналрекорд** -обработчик является глобальным обработчиком — он не может использоваться в качестве обработчика для конкретного потока.

Дополнительные сведения см. в описании функции обратного вызова [*жаурналрекордпрок*](/previous-versions/windows/desktop/legacy/ms644983(v=vs.85)) .

### <a name="wh_keyboard_ll"></a>что такое \_ сочетание клавиш \_

С **помощью \_ этого \_** обработчика можно отслеживать события ввода с клавиатуры, которые будут публиковаться в очереди входных потоков.

Дополнительные сведения см. в описании функции обратного вызова [*ловлевелкэйбоардпрок*](/previous-versions/windows/desktop/legacy/ms644985(v=vs.85)) .

### <a name="wh_keyboard"></a>что такое \_ клавиатура

Функция, включающая **\_ клавиатурный** обработчик, позволяет приложению отслеживать трафик сообщений для [**WM \_ KeyDown**](/windows/desktop/inputdev/wm-keydown) и [**WM \_ KEYUP**](/windows/desktop/inputdev/wm-keyup) для [**сообщений,**](/windows/win32/api/winuser/nf-winuser-getmessage) возвращаемых функцией [**PeekMessage**](/windows/win32/api/winuser/nf-winuser-peekmessagea) . Для мониторинга ввода с клавиатуры, помещенного в очередь сообщений, можно использовать **\_ клавиатурный** обработчик.

Дополнительные сведения см. в описании функции обратного вызова [*кэйбоардпрок*](/previous-versions/windows/desktop/legacy/ms644984(v=vs.85)) .

### <a name="wh_mouse_ll"></a>что такое \_ мышь \_

Включение обработчика событий мыши позволяет отслеживать события ввода мыши, которые должны быть размещены в очереди входных потоков. **\_ \_**

Дополнительные сведения см. в описании функции обратного вызова [*ловлевелмаусепрок*](/previous-versions/windows/desktop/legacy/ms644986(v=vs.85)) .

### <a name="wh_mouse"></a>что такое \_ мышь

При помощи обработчика **\_ мыши** можно отслеживать сообщения [**мыши,**](/windows/win32/api/winuser/nf-winuser-getmessage) возвращаемые функцией [**PeekMessage**](/windows/win32/api/winuser/nf-winuser-peekmessagea) . Для отслеживания ввода мыши, помещенного в очередь сообщений, можно использовать обработчик **\_ мыши** .

Дополнительные сведения см. в описании функции обратного вызова [*маусепрок*](/previous-versions/windows/desktop/legacy/ms644988(v=vs.85)) .

### <a name="wh_msgfilter-and-wh_sysmsgfilter"></a>Что такое мсгфилтер и т. д. \_ \_ сисмсгфилтер

**\_ Мсгфилтерные** и предопределяющие перехватчики **\_ сисмсгфилтер** позволяют отслеживать сообщения, обрабатываемые меню, полосой прокрутки, окном сообщения или диалоговыми окнами, а также определять, когда в результате нажатия пользователем клавиши ALT + TAB или Alt + Esc будет активировано другое окно. **\_ Мсгфилтерющий** обработчик может отслеживать только сообщения, переданные в меню, полосу прокрутки, окно сообщения или диалоговое окно, созданное приложением, которое установило процедуру-обработчик. То есть обработчик **\_ сисмсгфилтер** отслеживает такие сообщения для всех приложений.

**\_ Мсгфилтерные** и **\_ предсисмсгфилтерные** Перехватчики позволяют выполнять фильтрацию сообщений во время модальных циклов, эквивалентных фильтрации в главном цикле обработки сообщений. Например, приложение часто проверяет новое сообщение в основном цикле между моментом получения сообщения из очереди и временем, когда он отправляет сообщение, выполняя специальную обработку соответствующим образом. Однако во время модального цикла система извлекает и отправляет сообщения, не позволяя приложению фильтровать сообщения в основном цикле обработки сообщений. Если приложение устанавливает **\_ мсгфилтер** или **\_ предсисмсгфилтер** процедуру-обработчик, система вызывает эту процедуру во время выполнения модального цикла.

Приложение может вызвать непосредственный обработчик **\_ мсгфилтер** , вызвав функцию [**каллмсгфилтер**](/windows/win32/api/winuser/nf-winuser-callmsgfiltera) . С помощью этой функции приложение может использовать тот же код для фильтрации сообщений во время модальных циклов, как он используется в главном цикле обработки сообщений. Для этого необходимо инкапсулировать операции фильтрации в виде процедуры **\_ мсгфилтер** -обработчика и вызвать **каллмсгфилтер** между вызовами [**функций и**](/windows/win32/api/winuser/nf-winuser-getmessage) [**DispatchMessage**](/windows/win32/api/winuser/nf-winuser-dispatchmessage) .

``` syntax
while (GetMessage(&msg, (HWND) NULL, 0, 0)) 
{ 
    if (!CallMsgFilter(&qmsg, 0)) 
        DispatchMessage(&qmsg); 
} 
```

Последний аргумент [**каллмсгфилтер**](/windows/win32/api/winuser/nf-winuser-callmsgfiltera) просто передается в процедуру-обработчик; можно ввести любое значение. Процедура обработки, определяющая константу, такую как **мсгф \_ маинлуп**, может использовать это значение для определения места вызова процедуры.

Дополнительные сведения см. в разделе функции обратного вызова [*MessageProc*](/previous-versions/windows/desktop/legacy/ms644987(v=vs.85)) и [*сисмсгпрок*](/previous-versions/windows/desktop/legacy/ms644992(v=vs.85)) .

### <a name="wh_shell"></a>что такое \_ оболочка

Приложение оболочки может использовать обработчик **\_ оболочки** для получения важных уведомлений. Система вызывает процедуру- **обработчик \_ оболочки** при активации приложения оболочки и создании или уничтожении окна верхнего уровня.

Обратите внимание, что пользовательские приложения оболочки не получают сообщения **\_ оболочки** . Таким образом, любое приложение, которое регистрирует себя как оболочку по умолчанию, должно вызывать функцию [**системпараметерсинфо**](/windows/desktop/api/winuser/nf-winuser-systemparametersinfoa) , прежде чем она (или любое другое приложение) сможет получить сообщения **\_ оболочки** . Эта функция должна вызываться с **индексом SPI \_ сетминимизедметрикс** и структурой [**минимизедметрикс**](/windows/win32/api/winuser/ns-winuser-minimizedmetrics) . Задайте для элемента **иарранже** этой структуры значение **АРВ \_ Hide**.

Дополнительные сведения см. в описании функции обратного вызова [*шеллпрок*](/previous-versions/windows/desktop/legacy/ms644991(v=vs.85)) .

 

 
