---
title: Процессы, потоки и подразделения
description: Процесс — это коллекция пространства виртуальной памяти, кода, данных и системных ресурсов.
ms.assetid: cb62412a-d079-40f9-89dc-cce0bf3889af
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 320b09d76200739c77c7202af4d53a35089b2eca2e6fd282dd507f048aa7a10b
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119130036"
---
# <a name="processes-threads-and-apartments"></a>Процессы, потоки и подразделения

*Процесс* — это коллекция пространства виртуальной памяти, кода, данных и системных ресурсов. *Поток* — это код, который должен быть последовательно выполнен внутри процесса. Процессор выполняет потоки, а не процессы, поэтому каждое приложение имеет по крайней мере один процесс, и процесс всегда имеет по крайней мере один поток выполнения, известный как основной поток. В дополнение к основному потоку в процессе может быть несколько потоков.

Процессы взаимодействуют друг с другом через сообщения, используя технологию удаленного вызова процедур (RPC) корпорации Майкрософт для передачи информации друг другу. Между вызовом, поступающим от процесса на удаленном компьютере, и вызовом, поступающим от другого процесса на том же компьютере, не существует различий.

Когда поток начинает выполняться, он продолжается до тех пор, пока он не будет завершен или пока не будет прерван потоком с более высоким приоритетом (действие пользователя или планировщик потоков ядра). Каждый поток может выполнять отдельные разделы кода, или несколько потоков могут выполнять один и тот же раздел кода. Потоки, выполняющие один и тот же блок кода, поддерживают отдельные стеки. Каждый поток в процессе совместно использует глобальные переменные и ресурсы этого процесса.

Планировщик потоков определяет, когда и как часто следует выполнять поток, в соответствии с сочетанием атрибута класса приоритета процесса и базового приоритета потока. Атрибут класса приоритета процесса задается путем вызова функции [**сетприоритикласс**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setpriorityclass) , а базовый приоритет потока задается вызовом [**сетсреадприорити**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setthreadpriority).

Многопоточные приложения должны избегать двух проблем с потоками: *взаимоблокировки* и *состязания*. Взаимоблокировка возникает, когда каждый поток ожидает выполнения какого-либо другого потока. Управление вызовами COM помогает предотвратить взаимоблокировки вызовов между объектами. Состояние гонки возникает, когда один поток завершается до другого, от которого он зависит, что приводит к тому, что в бывшем экземпляре используется неинициализированное значение, поскольку второй еще не предоставил допустимого значения. COM предоставляет некоторые функции, специально разработанные для того, чтобы избежать конкуренции в необработанных серверах. (См. раздел [вспомогательные методы реализации сервера](out-of-process-server-implementation-helpers.md).)

## <a name="the-apartment-and-the-com-threading-architecture"></a>Подразделение и архитектура потоков COM

Хотя COM поддерживает модель с одним потоком, которая наследуется перед введением нескольких потоков выполнения, можно написать код для использования преимуществ нескольких потоков, что приведет к более эффективным приложениям, допуская выполнение одного потока, в то время как другой поток ожидает завершения некоторой длительной операции.

> [!Note]  
> Использование нескольких потоков не гарантирует лучшую производительность. На самом деле, поскольку многопоточность является сложной задачей, использование нескольких потоков часто приводит к проблемам с производительностью. Ключ состоит в использовании нескольких потоков, только если вы точно уверены, что вы делаете.

 

Как правило, самый простой способ просмотреть архитектуру потоковой обработки COM — считать все COM-объекты в процессе, разделенные на группы, называемые *апартаментами*. COM-объект находится в одном апартаменте, в том смысле, что его методы могут быть непосредственно вызваны только потоком, принадлежащим этому подразделению. Любой другой поток, которому требуется вызвать объект, должен пройти через прокси-сервер.

Существует два типа апартаментов: [Однопотоковые подразделения](single-threaded-apartments.md)и [многопоточные подразделения](multithreaded-apartments.md).

-   Однопотоковые подразделения состоят из ровно одного потока, поэтому все COM-объекты, которые находятся в однопотоковом подразделении, могут принимать вызовы методов только из одного потока, который принадлежит этому подразделению. Все вызовы методов к COM-объекту в однопотоковом апартаменте синхронизируются с очередью сообщений Windows для потока однопотокового подразделения. Процесс с одним потоком выполнения — это просто особый случай этой модели.
-   Многопоточные подразделения состоят из одного или нескольких потоков, поэтому все COM-объекты, которые находятся в многопоточном апартаменте, могут получить вызовы методов непосредственно из любого потока, принадлежащего многопоточному подразделению. Потоки в многопоточном апартаменте используют модель, называемую *бесплатным потоком*. Вызовы COM-объектов в многопоточном апартаменте синхронизируются самими объектами.

> [!Note]  
> Описание обмена данными между однопотоковыми и многопоточными апартаментами в рамках одного процесса см. в разделе [однопотоковое и](single-threaded-and-multithreaded-communication.md)многопоточное взаимодействие.

 

Процесс может содержать ноль или более однопотоковых подразделений и ноль или один многопоточный апартамент.

В процессе сначала инициализируется главный апартамент. В однопотоковом процессе это единственный апартамент. Параметры вызова маршалируются между апартаментами, а COM обрабатывает синхронизацию посредством обмена сообщениями. Если назначить несколько потоков в процессе свободными потоками, все свободные потоки находятся в одном апартаменте, параметры передаются непосредственно в любой поток в подразделении, и необходимо обрабатывать всю синхронизацию. В процессе с произвольной многопоточностью и потоковыми потоками все свободные потоки находятся в одном апартаменте, а все остальные подразделения являются однопотоковыми апартаментами. Процесс, выполняющий работу COM, — это коллекция подразделений с (не более одного многопоточного подразделения), но с любым числом однопотоковых апартаментов.

Модели потоков в COM предоставляют механизм для клиентов и серверов, использующих различные архитектурные потоки для совместной работы. Естественным образом поддерживаются вызовы между объектами с различными моделями потоков в разных процессах. С точки зрения вызывающего объекта все вызовы объектов, находящиеся вне процесса, ведут себя одинаково, независимо от того, как вызывается поток. Аналогично, с точки зрения вызываемого объекта, поступающие вызовы ведут себя одинаково, независимо от модели потоков вызывающего.

Взаимодействие между клиентом и необработанным объектом осуществляется просто, даже если они используют различные модели потоков, поскольку клиент и объект находятся в разных процессах. COM-взаимодействие между клиентом и сервером может предоставить код для потоковой модели, который будет взаимодействовать с помощью стандартного маршалирования и RPC. Например, если однопотоковый объект вызывается несколькими клиентами, работающими в многопоточном процессе, вызовы будут синхронизированы COM путем размещения соответствующих сообщений в очереди сообщений сервера. Апартамент объекта будет получать один вызов каждый раз, когда он извлекает и отправляет сообщения. Тем не менее необходимо соблюдать некоторые меры, чтобы убедиться, что внутрипроцессный сервер правильно взаимодействует с клиентами. (См. статью [проблемы потоковой обработки на сервере](in-process-server-threading-issues.md).)

Наиболее важной проблемой при программировании с использованием многопоточной модели является обеспечение безопасности потока кода таким образом, чтобы сообщения, предназначенные для конкретного потока, передавались только этому потоку, а доступ к потокам был защищен.

Дополнительные сведения см. в следующих разделах:

-   [Выбор потоковой модели](choosing-the-threading-model.md)
-   [Подразделения с одним потоком](single-threaded-apartments.md)
-   [Многопоточные подразделения](multithreaded-apartments.md)
-   [Однопотоковое и многопоточное взаимодействие](single-threaded-and-multithreaded-communication.md)
-   [Проблемы потоковой обработки в процессе сервера](in-process-server-threading-issues.md)
-   [Доступ к интерфейсам в разных апартаментах](accessing-interfaces-across-apartments.md)

 

 