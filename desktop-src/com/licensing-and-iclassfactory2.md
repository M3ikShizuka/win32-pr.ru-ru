---
title: Лицензирование и IClassFactory2
description: Лицензирование и IClassFactory2
ms.assetid: 2bead555-8c62-4f48-a4c6-6f0942ec75f8
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b8248b24d6b629d42e9ca631b1574c5a6719f0f4f626b2ea22792c3196c591e3
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "120096934"
---
# <a name="licensing-and-iclassfactory2"></a>Лицензирование и IClassFactory2

Интерфейс [**IClassFactory**](/windows/win32/api/unknwn/nn-unknwn-iclassfactory) в объекте класса предоставляет базовый механизм создания объектов COM. С помощью **IClassFactory** сервер может управлять созданием объектов на уровне компьютера. Реализация метода [**IClassFactory:: CreateInstance**](/windows/desktop/api/Unknwn/nf-unknwn-iclassfactory-createinstance) может разрешать или запрещать создание объектов на основе наличия лицензии компьютера. Лицензия компьютера — это часть сведений, отделяющая от приложения, которое существует на компьютере, чтобы указать, что программное обеспечение было установлено из допустимого источника, например установочных дисков поставщика. Если лицензия компьютера не существует, сервер может запретить создание объектов. Лицензирование компьютера предотвращает пиратство в случаях, когда пользователь пытается скопировать программное обеспечение с одного компьютера на другой, так как сведения о лицензии не копируются вместе с программным обеспечением, а компьютер, получивший копию, не лицензирован.

Однако в отрасли программного обеспечения поставщики нуждаются в более тонком уровне контроля над лицензированием. Помимо управления лицензиями компьютера, поставщику необходимо разрешить некоторым клиентам создавать объект компонента, одновременно запретив другим клиентам такую же возможность. Для этого клиентское приложение должно получить лицензионный ключ от компонента, пока клиентское приложение все еще находится в разработке. Клиентское приложение использует лицензионный ключ во время выполнения для создания объектов на нелицензированном компьютере.

Например, если поставщик предоставляет библиотеку элементов управления для разработчиков, у разработчика, который приобрели библиотеку, будет полноценная лицензия на компьютер, позволяющая создавать объекты на компьютере разработки. Затем разработчик может создать клиентское приложение на Лицензированном компьютере, включающем один или несколько элементов управления. Когда полученное клиентское приложение запускается на другом компьютере, элементы управления, используемые в клиентском приложении, должны быть созданы на другом компьютере, даже если этот компьютер не владеет лицензией компьютера для элементов управления от исходного поставщика.

Интерфейс [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2) обеспечивает этот уровень управления. Чтобы обеспечить лицензирование на основе ключей для любого конкретного компонента, необходимо реализовать **IClassFactory2** в объекте фабрики класса для этого компонента. **IClassFactory2** является производным от [**IClassFactory**](/windows/win32/api/unknwn/nn-unknwn-iclassfactory), поэтому, реализуя **IClassFactory2**, объект фабрики класса удовлетворяет базовым требованиям COM.

Чтобы включить лицензированный компонент в клиентское приложение, используйте следующие методы в [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2):

-   Метод [**жетлиЦинфо**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-getlicinfo) заполняет структуру [**лиЦинфо**](/windows/win32/api/ocidl/ns-ocidl-licinfo) данными, описывающими поведение лицензирования фабрики класса. Например, фабрика класса может предоставлять лицензионные ключи для лицензирования времени выполнения, если член **фрунтимекэйаваил** имеет **значение true**.
-   Метод [**рекуестликкэй**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-requestlickey) предоставляет лицензионный ключ для компонента. Если клиент вызывает этот метод, должна быть доступна лицензия компьютера.
-   Метод [**креатеинстанцелик**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-createinstancelic) создает экземпляр лицензированного компонента, если параметр лицензионного ключа (бстрâ бстркэй) является допустимым.

> [!Note]  
> В сведениях о типе компонент использует атрибут Licensed, чтобы пометить coclass, поддерживающий лицензирование, через [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2).

 

Во-первых, вам понадобится отдельное средство разработки, которое также является клиентом лицензированного компонента. Назначение этого средства — получить лицензионный ключ и сохранить его в клиентском приложении. Это средство выполняется только на компьютере, где есть лицензия на компьютер для компонента. Средство вызывает методы [**жетлиЦинфо**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-getlicinfo) и [**рекуестликкэй**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-requestlickey) для получения лицензионного ключа, а затем сохраняет лицензионный ключ в клиентском приложении. Например, средство разработки может создать файл заголовка (h), содержащий ключ лицензии BSTR, а затем включить этот h-файл в клиентское приложение.

Чтобы создать экземпляр компонента в клиентском приложении, сначала попытайтесь создать экземпляр объекта напрямую с помощью [**IClassFactory:: CreateInstance**](/windows/desktop/api/Unknwn/nf-unknwn-iclassfactory-createinstance). Если **CreateInstance** выполняется, второй компьютер лицензируется для компонента, и объекты могут быть созданы в. Если **CreateInstance** завершается с ошибкой с кодом \_ возврата \_ нотлиценсед, единственным способом создания объекта является передача ключа времени выполнения методу [**креатеинстанцелик**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-createinstancelic) . **Креатеинстанцелик** проверяет ключ и создает объект, если ключ является допустимым.

Таким образом, приложение, созданное с помощью компонентов (например, элементов управления), может выполняться на компьютере, не имеющем другой лицензии — для создания объектов компонентов можно использовать только клиентское приложение, содержащее лицензию времени выполнения.

Интерфейс [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2) поддерживает гибкость в схемах лицензирования. Например, разработчик сервера может зашифровать лицензионные ключи в компоненте для обеспечения дополнительной безопасности. Разработчики сервера могут также включать или отключать уровни функциональности в своих объектах, предоставляя разные лицензионные ключи для разных функций. Например, один ключ может обеспечить базовый уровень функциональности, а другой — базовую и расширенную функциональность и т. д.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Обязанности сервера COM](com-server-responsibilities.md)
</dt> </dl>

 

 