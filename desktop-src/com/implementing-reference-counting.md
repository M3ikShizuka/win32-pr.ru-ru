---
title: Реализация подсчета ссылок
description: Реализация подсчета ссылок
ms.assetid: d4fd98c9-afa4-4c5c-a3c9-44d34881cbdb
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a0d4dfe2b0faf2fc6557d1b089e33ae6ce4b98cb
ms.sourcegitcommit: 5f33645661bf8c825a7a2e73950b1f4ea0f1cd82
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/21/2020
ms.locfileid: "105710391"
---
# <a name="implementing-reference-counting"></a>Реализация подсчета ссылок

Для подсчета ссылок требуется работа в части класса, реализующего класс, и клиентов, использующих объекты этого класса. При реализации класса необходимо реализовать методы [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) и [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) в составе интерфейса [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown) . Эти два метода имеют следующие простые реализации:

-   [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) увеличивает число внутренних ссылок объекта.
-   Сначала [**выпуск**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) уменьшает внутренний счетчик ссылок объекта, а затем проверяет, не было ли значение счетчика ссылок в ноль. Если он имеет значение, это означает, что никто больше не использует объект, поэтому функция **выпуска** освобождает объект.

Распространенный подход к реализации большинства объектов заключается в наличии только одной реализации этих методов (вместе с [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q))), которая является общей для всех интерфейсов и, следовательно, является счетчиком ссылок, который применяется ко всему объекту. Однако с точки зрения клиента подсчет ссылок является строго и четко понятным представлением указателя по интерфейсу, поэтому объекты, использующие эту возможность, динамически создают, уничтожают, загружают или выгружая части их функций на основе указателей на екстант интерфейсов. Эти разговорной речи называются *интерфейсами разрыва*.

Всякий раз, когда клиент вызывает метод (или функцию API), например [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)), который возвращает новый указатель интерфейса, вызываемый метод отвечает за увеличение счетчика ссылок с помощью возвращаемого указателя. Например, когда клиент впервые создает объект, он получает указатель интерфейса на объект, который, начиная с точки зрения клиента, имеет счетчик ссылок на один. Если клиент вызывает [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) для указателя интерфейса, счетчик ссылок преобразуется в два. Клиент должен дважды вызвать метод [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) в указателе интерфейса, чтобы удалить все ссылки на объект.

Пример того, как счетчики ссылок строго определяются по интерфейсу, возникает, когда клиент вызывает [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)) в первом указателе для нового интерфейса или того же интерфейса. В любом из этих случаев клиент должен вызывать метод [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) один раз для каждого указателя. COM не требует, чтобы объект возвращал один и тот же указатель при запросе одного интерфейса несколько раз. (Единственное исключение — запрос [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown), который определяет объект для com.) Это позволяет эффективно управлять ресурсами с помощью реализации объекта.

Безопасность потоков также является важной проблемой при реализации [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) и [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release). Дополнительные сведения см. в разделе [процессы, потоки и подразделения](processes--threads--and-apartments.md).

## <a name="related-topics"></a>См. также

<dl> <dt>

[Управление жизненным циклом объектов с помощью подсчета ссылок](managing-object-lifetimes-through-reference-counting.md)
</dt> </dl>

 

 