---
title: Сведения о маршалировании
description: Если вы используете стандартную упаковку, COM обрабатывает все описанные здесь сведения.
ms.assetid: bf3fe212-648e-4d00-ad1d-43d2e5e6a7ae
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f4d0fd46ee29c712c6f2b5b286df76a30f1047e6
ms.sourcegitcommit: d75fc10b9f0825bbe5ce5045c90d4045e3c53243
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2021
ms.locfileid: "127570994"
---
# <a name="marshaling-details"></a>Сведения о маршалировании

Если вы используете стандартную упаковку, COM обрабатывает все описанные здесь сведения. Однако существует несколько программистов, которым требуются эти сведения, и для тех, кто заинтересован в базовой информации. Маршалирование — это процесс упаковки и распаковки параметров, позволяющий выполнять удаленный вызов процедур.

Различные типы параметров маршалируются различными способами. Например, упаковка целочисленного параметра подразумевает простое копирование значения в буфер сообщения. (Хотя даже в этом простом случае существуют проблемы, например порядок байтов для обработки вызовов между компьютерами). Однако маршалирование массива является более сложным процессом. Элементы массива копируются в определенном порядке, чтобы другая сторона могла точно воссоздать массив. При маршалировании указателя данные, на которые указывает указатель, копируются после правил и соглашений, связанных с вложенными указателями в структурах. Для управления упаковкой каждого типа параметра существуют уникальные функции.

При стандартном маршалировании прокси-серверы и заглушки являются ресурсами для интерфейса на уровне системы и взаимодействуют с каналом по стандартному протоколу. Стандартную упаковку можно использовать как в стандартных интерфейсах, определяемых моделью COM, так и в пользовательских интерфейсах следующим образом.

-   В случае с большинством COM-интерфейсов прокси-серверы и заглушки для стандартной упаковки — это объекты внутрипроцессного компонента, загружаемые из общесистемной библиотеки DLL, предоставляемой COM в Ole32.dll.
-   В случае пользовательских интерфейсов прокси-серверы и заглушки для стандартного маршалирования создаются конструктором интерфейса, обычно с помощью MIDL. Эти прокси-серверы и заглушки статически настроены в реестре, поэтому любой потенциальный клиент может использовать пользовательский интерфейс через границы процесса. Эти прокси-серверы и заглушки загружаются из библиотеки DLL, расположенной в системном реестре, с использованием идентификатора интерфейса (IID) для настраиваемого интерфейса, который они маршалируются.
-   В качестве альтернативы использованию MIDL для создания прокси-серверов и заглушек для настраиваемых интерфейсов вместо этого можно создать библиотеку типов, а предоставляемая система, Type-либрариâ €, будет маршалировать интерфейс.

В качестве альтернативы стандартному упаковке интерфейс (стандартный или настраиваемый) может использовать настраиваемое маршалирование. При пользовательском маршалировании объект динамически реализует прокси-серверы во время выполнения для каждого интерфейса, который он поддерживает. Для любого заданного интерфейса объект может выбрать предоставленный моделью COM стандартную упаковку или настраиваемую упаковку. Этот вариант сделан объектом на основе интерфейса. После выбора для данного интерфейса он остается в силе во время существования объекта. Однако один интерфейс для объекта может использовать настраиваемую упаковку, а другой — стандартную упаковку.

Пользовательский маршалирование по сути является уникальным для объекта, который его реализует. Он использует прокси-серверы, реализованные объектом, и предоставляется системе по запросу во время выполнения. Объекты, реализующие пользовательский маршалирование, должны реализовывать интерфейс [**IMarshal**](/windows/win32/api/objidlbase/nn-objidlbase-imarshal) , тогда как объекты, поддерживающие стандартную упаковку, — нет.

Если вы решили написать пользовательский интерфейс, необходимо предоставить для него поддержку упаковки. Как правило, вы будете предоставлять стандартную библиотеку DLL для маршалирования для создаваемого интерфейса. Можно создать код прокси-сервера или заглушки, а также БИБЛИОТЕКУ прокси-сервера или заглушки, или создать библиотеку типов, которую COM будет использовать для выполнения маршалирования на основе данных (с использованием данных в библиотеке типов).

Чтобы клиент вызывал метод интерфейса в объекте другого процесса, требуется взаимодействие нескольких компонентов. Стандартный прокси-сервер — это фрагмент кода, зависящего от интерфейса, который находится в пространстве процесса клиента и подготавливает параметры интерфейса для передачи. ИТ-пакеты, или маршалирует, таким образом, чтобы их можно было повторно создать и понять в процессе получения. Стандартная заглушка, а также часть кода, зависящего от интерфейса, находится в пространстве процесса сервера и отменяет работу прокси-сервера. Заглушка распаковать или распаковать передаваемые параметры и пересылает их приложению объекта. Он также упаковывает ответные данные для отправки обратно клиенту.

> [!Note]  
> Читатели, более знакомые с RPC, чем COM, могут использовать для просмотра терминов клиентскую заглушку и заглушку сервера. Эти термины аналогичны прокси и заглушке.

 

## <a name="components-of-interprocess-communications"></a>Компоненты взаимодействия между процессами

На следующей схеме показан поток обмена данными между компонентами. На стороне клиента границы процесса вызов метода клиента проходит через прокси-сервер, а затем на канал, который является частью библиотеки COM. Канал отправляет буфер, содержащий Упакованные параметры, в библиотеку времени выполнения RPC, которая передает ее через границу процесса. Время выполнения RPC и библиотеки COM существуют на обеих сторонах процесса. Различие между каналом и временем выполнения RPC является характеристикой этой реализации и не является частью модели программирования или концептуальной модели для COM-объектов Client/Server. Серверы COM видят только прокси-сервер или заглушку, а также непрямой канал. В будущих реализациях могут использоваться разные слои, расположенные под каналом или без слоев.

![Схема, на которой показаны Client.exe и Server.exe потоки на каждой стороне в границах процесса.](images/457036c1-98b8-4f35-aebe-70de38112b83.png)

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Канал](channel.md)
</dt> <dt>

[Обмен данными между объектами](inter-object-communication.md)
</dt> <dt>

[Microsoft RPC](microsoft-rpc.md)
</dt> <dt>

[Прокси](proxy.md)
</dt> <dt>

[Заглушка](stub.md)
</dt> </dl>

 

 