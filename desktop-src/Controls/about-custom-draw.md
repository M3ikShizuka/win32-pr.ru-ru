---
title: О пользовательской прорисовке
description: В этом разделе содержатся общие сведения о пользовательской функции рисования и дается концептуальный обзор того, как приложение может поддерживать пользовательскую прорисовку.
ms.assetid: dd104661-1e0c-4569-9753-817bcded1894
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 7f4961d80c04f8fa570286666511c04b1208c940369cd13b836095b8899505de
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119922494"
---
# <a name="about-custom-draw"></a>О пользовательской прорисовке

В этом разделе содержатся общие сведения о пользовательской функции рисования и дается концептуальный обзор того, как приложение может поддерживать пользовательскую прорисовку. В настоящее время следующие элементы управления поддерживают пользовательские функции рисования:

-   Элементы управления "заголовок"
-   Элементы управления "представление списка"
-   Элементы управления главной панели
-   Элементы управления панели инструментов
-   Элементы управления ToolTip
-   Элементы управления TrackBar
-   Элементы управления "дерево-представление"

<!-- -->

-   [О настраиваемых сообщениях уведомления о выводе](#about-custom-draw-notification-messages)
-   [Paint Циклы, этапы отрисовки и сообщения уведомления](#paint-cycles-drawing-stages-and-notification-messages)
-   [Использование преимуществ пользовательских служб рисования](#taking-advantage-of-custom-draw-services)
    -   [Ответ на уведомление о предрисовке](#responding-to-the-prepaint-notification)
    -   [Запрос уведомлений для конкретного элемента](#requesting-item-specific-notifications)
    -   [Рисование элемента](#drawing-the-item-yourself)
    -   [Изменение шрифтов и цветов](#changing-fonts-and-colors)
-   [Пользовательские прорисовки с помощью элементов управления List-View и Tree-View](#custom-draw-with-list-view-and-tree-view-controls)
    -   [Пользовательские прорисовки с помощью элементов управления List-View](#custom-draw-with-list-view-controls)
-   [Связанные темы](#related-topics)

## <a name="about-custom-draw-notification-messages"></a>О настраиваемых сообщениях уведомления о выводе

Все стандартные элементы управления, поддерживающие пользовательские коды уведомления Send [ \_ кустомдрав](nm-customdraw.md) , в конкретных точках во время операций рисования. Эти коды уведомлений описывают операции рисования, которые применяются ко всему элементу управления, а также к операциям рисования, относящимся к элементам внутри элемента управления. Как и многие коды уведомлений, \_ кустомдравные уведомления отправляются в виде сообщений [**WM \_ Notify**](wm-notify.md) .

Параметр *lParam* пользовательского уведомления о выводе будет являться адресом структуры [**нмкустомдрав**](/windows/win32/api/commctrl/ns-commctrl-nmcustomdraw) или структурой элемента управления, содержащей структуру **нмкустомдрав** в качестве первого элемента. В следующей таблице показана связь между элементами управления и используемыми ими структурами.



| Структура                                | Где используется                              |
|------------------------------------------|--------------------------------------|
| [**нмкустомдрав**](/windows/win32/api/commctrl/ns-commctrl-nmcustomdraw)     | Элементы управления "Главная панель", "TrackBar" и "заголовок" |
| [**нмлвкустомдрав**](/windows/win32/api/commctrl/ns-commctrl-nmlvcustomdraw) | Элементы управления "представление списка"                   |
| [**нмтбкустомдрав**](/windows/desktop/api/Commctrl/ns-commctrl-nmtbcustomdraw) | Элементы управления панели инструментов                     |
| [**нмтткустомдрав**](/windows/win32/api/commctrl/ns-commctrl-nmttcustomdraw) | Элементы управления ToolTip                     |
| [**нмтвкустомдрав**](/windows/win32/api/commctrl/ns-commctrl-nmtvcustomdraw) | Элементы управления "дерево-представление"                   |



 

## <a name="paint-cycles-drawing-stages-and-notification-messages"></a>Paint Циклы, этапы отрисовки и сообщения уведомления

как и все Windows приложения, стандартные элементы управления периодически задают и удаляют себя на основе сообщений, полученных от системы или других приложений. Процесс рисования или стирания элемента управления называется *циклом рисования*. Элементы управления, поддерживающие пользовательский код уведомления Send [NM \_ кустомдрав](nm-customdraw.md) , периодически проходят через каждый цикл рисования. Этот код уведомления сопровождается структурой [**нмкустомдрав**](/windows/win32/api/commctrl/ns-commctrl-nmcustomdraw) или другой структурой, содержащей структуру **нмкустомдрав** в качестве первого элемента.

Один из данных, содержащихся в структуре [**нмкустомдрав**](/windows/win32/api/commctrl/ns-commctrl-nmcustomdraw) , — это текущий этап цикла рисования. Это называется *стадией прорисовки* и представляется значением в элементе **двдравстаже** структуры. Элемент управления сообщает его родителю о четырех основных стадиях рисования. Эти основные или глобальные этапы рисования представлены в структуре следующими значениями флагов (определенными в Коммктрл. h).



| Глобальные значения этапа рисования | Описание                        |
|--------------------------|------------------------------------|
| КДДС \_           | Перед началом цикла рисования.     |
| КДДС \_          | После завершения цикла рисования. |
| предочистка КДДС \_           | Перед началом цикла стирания.     |
| КДДСная \_ Очистка          | После завершения цикла стирания. |



 

Каждое из приведенных выше значений можно сочетать с \_ флагом элемента кддс, чтобы указать этапы отрисовки, характерные для элементов. Для удобства Коммктрл. h содержит следующие значения, зависящие от конкретного элемента.



| Значения этапа отрисовки для конкретного элемента | Описание                                                                                                                                                                                                                                                                         |
|---------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| КДДС \_ итемпрепаинт              | Перед прорисовкой элемента.                                                                                                                                                                                                                                                            |
| КДДС \_ итемпостпаинт             | После прорисовки элемента.                                                                                                                                                                                                                                                       |
| КДДС \_ итемприрасе              | Перед удалением элемента.                                                                                                                                                                                                                                                           |
| КДДС \_ итемпостерасе             | После удаления элемента.                                                                                                                                                                                                                                                      |
| подэлемент КДДС \_                   | [Стандартные версии элементов управления](common-control-versions.md) 4,71. Пометьте вместе с КДДС \_ итемпрепаинт или кддс \_ итемпостпаинт при прорисовке подэлемента. Это значение будет установлено только в том случае, если [**кдрф \_ нотифитемдрав**](cdrf-constants.md) возвращается из кддс предустановки \_ . |



 

Приложение должно обработать код уведомления [NM \_ кустомдрав](nm-customdraw.md) , а затем вернуть конкретное значение, которое информирует элемент управления о том, что оно должно делать. Дополнительные сведения об этих возвращаемых значениях см. в следующих разделах.

## <a name="taking-advantage-of-custom-draw-services"></a>Использование преимуществ пользовательских служб рисования

Ключом к использованию пользовательских функций рисования является реагирование на коды уведомлений [NM \_ кустомдрав](nm-customdraw.md) , которые отправляет элемент управления. Возвращаемые значения, которые приложение отправляет в ответ на эти уведомления, определяют поведение элемента управления для этого цикла рисования.

В этом разделе содержатся сведения о том, как приложение может использовать возвращаемые значения уведомлений [NM \_ кустомдрав](nm-customdraw.md) для определения поведения элемента управления.

Сведения разбиваются на следующие разделы:

-   [Ответ на уведомление о предрисовке](#responding-to-the-prepaint-notification)
-   [Запрос уведомлений для конкретного элемента](#requesting-item-specific-notifications)
-   [Рисование элемента](#drawing-the-item-yourself)
-   [Изменение шрифтов и цветов](#changing-fonts-and-colors)

### <a name="responding-to-the-prepaint-notification"></a>Ответ на уведомление о предрисовке

В начале каждого цикла рисования элемент управления отправляет код уведомления [NM \_ кустомдрав](nm-customdraw.md) , указывая \_ значение кддс в элементе **двдравстаже** сопутствующей \_ кустомдрав структуры. Значение, которое приложение возвращает к первому уведомлению, определяет, как и когда элемент управления отправляет последующие уведомления о пользовательской прорисовке для оставшейся части этого цикла рисования. Приложение может вернуть сочетание следующих флагов в ответ на первое уведомление.



| Возвращаемое значение            | Действие                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|-------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| КДРФ \_ додефаулт         | Элемент управления будет рисовать сам. Он не будет отправлять дополнительные [уведомления \_ кустомдрав](nm-customdraw.md) для этого цикла рисования. Этот флаг нельзя использовать с любым другим флагом.                                                                                                                                                                                                                                                                               |
| КДРФ \_ доерасе           | Элемент управления будет рисовать только фон.                                                                                                                                                                                                                                                                                                                                                                                                                    |
| КДРФ \_ невфонт           | В приложении указан новый шрифт для элемента. элемент управления будет использовать новый шрифт. Дополнительные сведения об изменении шрифтов см. в разделе [Изменение шрифтов и цветов](#changing-fonts-and-colors). Это происходит, когда **двдравстаже** равно кддс \_ итемпрепаинт.                                                                                                                                                                                                       |
| КДРФ \_ нотифитемдрав    | Элемент управления будет уведомлять родителя всех операций рисования, связанных с элементами. Он будет отсылать [технологические \_](nm-customdraw.md) коды уведомлений до и после рисования элементов. Это происходит, когда **двдравстаже** равно кддс \_ .                                                                                                                                                                                                                       |
| КДРФ \_ нотифипостерасе   | Элемент управления будет уведомлять родительский элемент после стирания элемента. Это происходит, когда **двдравстаже** равно кддс \_ .                                                                                                                                                                                                                                                                                                                                             |
| КДРФ \_ нотифипостпаинт   | При завершении цикла рисования для всего элемента управления будет отправлено уведомление [ \_ кустомдрав](nm-customdraw.md) . Это происходит, когда **двдравстаже** равно кддс \_ .                                                                                                                                                                                                                                                                 |
| КДРФ \_ нотифисубитемдрав | [Версия 4,71](common-control-versions.md). Приложение получит [ \_ кустомдравное](nm-customdraw.md) уведомление с **двдравстаже** , для которого задано значение кддс \_ итемпрепаинт \| кддс \_ подэлемент перед прорисовкой каждого подэлемента представления списка. Затем можно указать шрифт и цвет для каждого подэлемента отдельно или вернуть [**кдрф \_ додефаулт**](cdrf-constants.md) для обработки по умолчанию. Это происходит, когда **двдравстаже** равно кддс \_ итемпрепаинт. |
| КДРФ \_ скипдефаулт       | Приложение вынарисовало элемент вручную. Элемент управления не будет рисовать элемент. Это происходит, когда **двдравстаже** равно кддс \_ итемпрепаинт.                                                                                                                                                                                                                                                                                                                      |
| КДРФ \_ скиппостпаинт     | Элемент управления не будет рисовать прямоугольник фокуса вокруг элемента.                                                                                                                                                                                                                                                                                                                                                                                                 |



 

### <a name="requesting-item-specific-notifications"></a>Запрос уведомлений для конкретного элемента

Если приложение возвращает [**кдрф \_ нотифитемдрав**](cdrf-constants.md) в начальное настраиваемое уведомление, элемент управления будет отправлять уведомления для каждого элемента, который он рисует во время цикла рисования. Эти уведомления для конкретного элемента будут иметь значение КДДС \_ итемпрепаинт в элементе **двдравстаже** сопровождающей [**нмкустомдрав**](/windows/win32/api/commctrl/ns-commctrl-nmcustomdraw) структуры. Можно запросить, чтобы элемент управления отправлял еще одно уведомление по завершении прорисовки элемента, возвращая [**кдрф \_ нотифипостпаинт**](cdrf-constants.md) для этих уведомлений об уровне элемента. В противном случае возвратите [**кдрф \_ додефаулт**](cdrf-constants.md) , и элемент управления не будет уведомлять родительское окно, пока не начнет прорисовку следующего элемента.

### <a name="drawing-the-item-yourself"></a>Рисование элемента

Если приложение рисует весь элемент, возвратите [**кдрф \_ скипдефаулт**](cdrf-constants.md). Это позволяет элементу управления пропускать элементы, которые ему не нужно рисовать, тем самым уменьшая нагрузку на систему. Помните, что возврат этого значения означает, что элемент управления не будет рисовать какую бы то ни было части элемента.

### <a name="changing-fonts-and-colors"></a>Изменение шрифтов и цветов

Для изменения шрифта элемента приложение может использовать пользовательский метод рисования. Просто выберите ХФОНТ в контексте устройства, который указан в элементе **HDC** структуры [**нмкустомдрав**](/windows/win32/api/commctrl/ns-commctrl-nmcustomdraw) , связанной с пользовательским уведомлением рисования. Так как выбранный шрифт может отличаться от метрик по умолчанию, убедитесь, что в возвращаемое значение для сообщения уведомления включен бит [**кдрф \_ невфонт**](cdrf-constants.md) . Дополнительные сведения об использовании этой функции см. в примере кода в разделе [Использование пользовательской прорисовки](using-custom-draw.md). Шрифт, который указывает ваше приложение, используется для показа этого элемента, если он не выбран. Пользовательская прорисовка не позволяет изменять атрибуты шрифтов для выбранных элементов.

Чтобы изменить цвета текста для всех элементов управления, поддерживающих пользовательский вывод, за исключением представления списка и представления в виде дерева, просто задайте нужные цвета текста и фона в контексте устройства, предоставляемом в пользовательской структуре уведомления с помощью функций [**сеттекстколор**](/windows/desktop/api/wingdi/nf-wingdi-settextcolor) и [**сетбкколор**](/windows/desktop/api/wingdi/nf-wingdi-setbkcolor) . Чтобы изменить цвета текста в представлении списка или представлении в виде дерева, необходимо поместить нужные значения цвета в элементы **клртекст** и **клртекстбк** структуры [**нмлвкустомдрав**](/windows/win32/api/commctrl/ns-commctrl-nmlvcustomdraw) или [**нмтвкустомдрав**](/windows/win32/api/commctrl/ns-commctrl-nmtvcustomdraw) .

> [!Note]  
> До [версии 6,0](common-control-versions.md) стандартных элементов управления панели инструментов игнорируют флаг [**кдрф \_ невфонт**](cdrf-constants.md) . Версия 6,0 поддерживает флаг **кдрф \_ невфонт** , и его можно использовать для выбора другого шрифта для панели инструментов. Однако нельзя изменить цвет панели инструментов, когда активен визуальный стиль. Чтобы изменить цвет панели инструментов в версии 6,0, необходимо сначала отключить стили оформления, вызвав [**SetWindowTheme**](/windows/desktop/api/Uxtheme/nf-uxtheme-setwindowtheme) и указав параметр без визуального стиля:

 


```
SetWindowTheme (hwnd, "", "");
```



## <a name="custom-draw-with-list-view-and-tree-view-controls"></a>Пользовательские прорисовки с помощью элементов управления List-View и Tree-View

Большинство стандартных элементов управления могут обрабатываться практически так же. Однако элементы управления "список-представление" и "дерево" имеют некоторые функции, для которых требуется несколько иной подход к пользовательской отрисовке.

В [версии 5,0](common-control-versions.md)эти два элемента управления могут отображать обрезанный текст при изменении шрифта путем возвращения [**кдрф \_ невфонт**](cdrf-constants.md). Это поведение необходимо для обеспечения обратной совместимости с более ранними версиями стандартных элементов управления. Если вы хотите изменить шрифт элемента управления "список-представление" или "дерево-представление", вы получите лучшие результаты, если отправите сообщение [**CCM \_ сетверсион**](ccm-setversion.md) с параметром *wParam* , равным 5, прежде чем добавлять элементы в элемент управления. Пример элемента управления представлением в виде дерева, в котором используется пользовательская прорисовка, см. в статье базы знаний [Sample: Кустдтв иллюстрирует пользовательскую прорисовку в TreeView (Q248496)]( https://support.microsoft.com/default.aspx?scid=kb;EN-US;q248496).

### <a name="custom-draw-with-list-view-controls"></a>Пользовательские прорисовки с помощью элементов управления List-View

Так как элементы управления "представление списка" имеют подэлементы и несколько режимов отображения, вам нужно будет работать с уведомлением [NM \_ кустомдрав](nm-customdraw.md) немного иначе, чем для других стандартных элементов управления.

Для режима отчета используйте следующую процедуру.

1.  В первом уведомлении [ \_ кустомдрав](nm-customdraw.md) будет установлен элемент **двдравстаже** в связанном наборе структур [**нмкустомдрав**](/windows/win32/api/commctrl/ns-commctrl-nmcustomdraw) для кддс предварительной версии \_ . Возвращает [**кдрф \_ нотифитемдрав**](cdrf-constants.md).
2.  Затем вы получите уведомление о [NM \_ кустомдрав](nm-customdraw.md) с параметром **ДВДРАВСТАЖЕ** , имеющим значение кддс \_ итемпрепаинт. Если вы укажете новые шрифты или цвета и вернете [**кдрф \_ невфонт**](cdrf-constants.md), будут изменены все подэлементы элемента. Если вы хотите, чтобы каждый подэлемент обрабатывался отдельно, возвратите [**кдрф \_ нотифисубитемдрав**](cdrf-constants.md).
3.  Если вы вернули [**кдрф \_ нотифисубитемдрав**](cdrf-constants.md) на предыдущем шаге, вы получите [NM \_ кустомдрав](nm-customdraw.md) уведомление для каждого подэлемента с **ДВДРАВСТАЖЕ** , установленным в кддс \_ подэлемент \| кддс \_ итемпрепаинт. Чтобы изменить шрифт или цвет для этого подэлемента, укажите новый шрифт или цвет и возвратите [**кдрф \_ невфонт**](cdrf-constants.md).

При работе с крупным значком, мелким значком и режимом списка используйте следующую процедуру.

1.  В первом уведомлении [ \_ кустомдрав](nm-customdraw.md) будет установлен элемент **двдравстаже** в связанном наборе структур [**нмкустомдрав**](/windows/win32/api/commctrl/ns-commctrl-nmcustomdraw) для кддс предварительной версии \_ . Возвращает [**кдрф \_ нотифитемдрав**](cdrf-constants.md).
2.  Затем вы получите уведомление о [NM \_ кустомдрав](nm-customdraw.md) с параметром **ДВДРАВСТАЖЕ** , имеющим значение кддс \_ итемпрепаинт. Можно изменить шрифты или цвета элемента, указав новые шрифты и цвета и возвращая [**кдрф \_ невфонт**](cdrf-constants.md). Так как эти режимы не имеют подэлементов, вы не будете получать дополнительные \_ кустомдрав уведомления.

Пример обработчика уведомлений "List-View [NM \_ кустомдрав](nm-customdraw.md) " см. в разделе [Использование пользовательского рисования](using-custom-draw.md).

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

**Зрения**
</dt> <dt>

[Использование пользовательского рисования](using-custom-draw.md)
</dt> <dt>

[Пользовательская ссылка для рисования](custom-draw-reference.md)
</dt> <dt>

**Другие ресурсы**
</dt> <dt>

[Пример: Кустдтв демонстрирует пользовательское рисование в TreeView (Q248496)]( https://support.microsoft.com/default.aspx?scid=kb;EN-US;q248496)
</dt> </dl>

 

 