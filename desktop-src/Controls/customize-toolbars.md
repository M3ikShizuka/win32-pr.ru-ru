---
title: Настройка панелей инструментов
description: Большинство приложений на основе Windows используют элементы управления Toolbar для предоставления пользователям удобного доступа к функциональным возможностям программы.
ms.assetid: 0CE2988E-D887-433B-BFB2-5F3442E8E1B7
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 091451a139cf846b1106916f28c165d6640699eb
ms.sourcegitcommit: f0ca63c18dc52c357d3398af7be766d2bdd40be7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/17/2020
ms.locfileid: "104069720"
---
# <a name="how-to-customize-toolbars"></a>Настройка панелей инструментов

Большинство приложений на основе Windows используют элементы управления Toolbar для предоставления пользователям удобного доступа к функциональным возможностям программы. Однако у статических панелей инструментов есть некоторые недостатки, например слишком мало места для эффективного вывода всех доступных инструментов. Решение этой проблемы заключается в том, чтобы сделать пользовательские панели инструментов приложения настраиваемыми. Затем пользователи могут отображать только необходимые вам средства, и они могут упорядочивать их в соответствии с личными образа жизниами.

> [!Note]  
> Панели инструментов в диалоговых окнах не могут быть настроены.

 

Чтобы включить настройку, включите флаг стиля [**CCS \_ регулируемых**](common-control-styles.md) стандартных элементов управления при создании элемента управления ToolBar. Существует два основных подхода к настройке.

-   Диалоговое окно "Настройка". Данное системное диалоговое окно является самым простым способом. Он предоставляет пользователям графический пользовательский интерфейс, позволяющий добавлять, удалять и перемещать значки.
-   Перетаскивание инструментов. Реализация функции перетаскивания позволяет пользователям перемещать средства в другое место на панели инструментов или удалять их, перетаскивая их за пределы панели инструментов. Она предоставляет пользователям быстрый и простой способ организации панели инструментов, но не позволяет им добавлять средства.

В зависимости от потребностей приложения можно реализовать любой из этих подходов или оба. Ни один из этих двух подходов к настройке не предоставляет встроенного механизма, такого как кнопка отмены или отмены, для возвращения панели инструментов в прежнее состояние. Необходимо явно использовать API элемента управления Toolbar для хранения состояния преднастройки панели инструментов. При необходимости можно использовать эти сохраненные сведения для восстановления исходного состояния панели инструментов.

## <a name="what-you-need-to-know"></a>Что необходимо знать

### <a name="technologies"></a>Технологии

-   [Элементы управления Windows](window-controls.md)

### <a name="prerequisites"></a>Предварительные условия

-   C/C++
-   Программирование пользовательского интерфейса Windows

## <a name="instructions"></a>Инструкции

### <a name="customization-dialog-box"></a>Диалоговое окно «Настройка»

Диалоговое окно Настройка предоставляется элементом управления Toolbar для предоставления пользователям простого способа добавления, перемещения или удаления инструментов. Пользователи могут запустить его, дважды щелкнув панель инструментов. Приложения могут запускать диалоговое окно настройки программным путем, отправляя элемент управления панели инструментов в [**ТБ \_ настраиваемого**](tb-customize.md) сообщения.

На следующем рисунке показан пример диалогового окна Настройка панели инструментов.

![снимок экрана окна с панелью инструментов из трех элементов и диалоговым окном со списками доступных и текущих кнопок панели инструментов](images/tb-customdlg.png)

В списке справа находятся инструменты, находящиеся на панели инструментов. Изначально в этом списке будут содержаться средства, которые вы указали при создании панели инструментов. В списке слева содержатся средства, доступные для добавления на панель инструментов. Приложение несет ответственность за заполнение этого списка (за исключением разделителя, который отображается автоматически).

Элемент управления "панель инструментов" уведомляет ваше приложение, что оно запускает диалоговое окно настройки, отправив его родительское окно код уведомления [ТБН \_ бегинаджуст](tbn-beginadjust.md) , за которым следует код уведомления [ТБН \_ иниткустомизе](tbn-initcustomize.md) . В большинстве случаев приложению не нужно отвечать на эти коды уведомлений. Однако, если не нужно, чтобы диалоговое окно Настройка панели инструментов отображало кнопку справки, обработайте ТБН \_ иниткустомизе, возвращая тбнрф \_ хидехелп.

Затем элемент управления ToolBar собирает сведения, необходимые для инициализации диалогового окна, отправляя три последовательности кодов уведомления в следующем порядке:

-   Код уведомления [ТБН \_ куеринсерт](tbn-queryinsert.md) для каждой кнопки на панели инструментов, чтобы определить, где можно вставить кнопки. Возвращает **значение false** , чтобы запретить вставку кнопки слева от кнопки, указанной в сообщении уведомления. Если вы возвращаете **значение false** для всех \_ кодов уведомлений ТБН куеринсерт, диалоговое окно не будет отображаться.
-   Код уведомления [ТБН \_ куериделете](tbn-querydelete.md) для каждого инструмента, который в данный момент находится на панели инструментов. Возвращает **значение true** , если средство можно удалить, или **значение false** в противном случае.
-   Ряд кодов уведомлений [ТБН \_ жетбуттонинфо](tbn-getbuttoninfo.md) для заполнения списка доступных кнопок. Чтобы добавить кнопку в список, заполните структуру [**нмтулбар**](/windows/win32/api/commctrl/ns-commctrl-nmtoolbara) , которая передается вместе с кодом уведомления, и возвратит **значение true**. Если больше нет средств для добавления, возвратите **значение false**. Обратите внимание, что можно получить сведения о кнопках, которые уже находятся на панели инструментов. Эти кнопки не будут добавлены в список.

Затем отображается диалоговое окно, и пользователь может начать настройку панели инструментов.

Когда диалоговое окно открыто, приложение может получить различные коды уведомлений в зависимости от действий пользователя:

-   [ТБН \_ КУЕРИНСЕРТ](tbn-queryinsert.md). Пользователь изменил расположение инструмента на панели инструментов или добавил средство. Возвращает **значение false** , чтобы предотвратить вставку средства в это место.
-   [ТБН \_ ДЕЛЕТИНГБУТТОН](tbn-deletingbutton.md). Пользователь собирается удалить средство с панели инструментов.
-   [ТБН \_ КУССЕЛП](tbn-custhelp.md). Пользователь щелкнул кнопку Справка.
-   [ТБН \_ ТУЛБАРЧАНЖЕ](tbn-toolbarchange.md). Пользователь добавил, переместил или удалил инструмент.
-   [ТБН \_ Сброс](tbn-reset.md). Пользователь щелкнул кнопку Reset (Сброс).

После уничтожения диалогового окна приложение получит код уведомления [ТБН \_ ендаджуст](tbn-endadjust.md) .

В следующем примере кода показан один из способов реализации настройки панели инструментов.


```C++
// The buttons are stored in an array of TBBUTTON structures. 
//
// Constants such as STD_FILENEW are identifiers for the 
// built-in bitmaps that have already been assigned as the toolbar's 
// image list.
//
// Constants such as IDM_NEW are application-defined command identifiers.

TBBUTTON allButtons[] = 
    {
        { MAKELONG(STD_FILENEW,  ImageListID), IDM_NEW,   TBSTATE_ENABLED, 0, {0}, 0, (INT_PTR)L"New" },
        { MAKELONG(STD_FILEOPEN, ImageListID), IDM_OPEN,  TBSTATE_ENABLED, 0, {0}, 0, (INT_PTR)L"Open"},
        { MAKELONG(STD_FILESAVE, ImageListID), IDM_SAVE,  TBSTATE_ENABLED, 0, {0}, 0, (INT_PTR)L"Save"},
        { MAKELONG(STD_CUT,      ImageListID), IDM_CUT,   TBSTATE_ENABLED, 0, {0}, 0, (INT_PTR)L"Cut" },
        { MAKELONG(STD_COPY,     ImageListID), IDM_COPY,  TBSTATE_ENABLED, 0, {0}, 0, (INT_PTR)L"Copy"},
        { MAKELONG(STD_PASTE,    ImageListID), IDM_PASTE, TBSTATE_ENABLED, 0, {0}, 0, (INT_PTR)L"Paste"}
    };

// The following appears in the window's message handler.

case WM_NOTIFY: 
    {
        switch (((LPNMHDR)lParam)->code) 
        {
        
        case TBN_GETBUTTONINFO:  
            {
                LPTBNOTIFY lpTbNotify = (LPTBNOTIFY)lParam;

                // Pass the next button from the array. There is no need to filter out buttons
                // that are already used—they will be ignored.
                
                int buttonCount = sizeof(allButtons) / sizeof(TBBUTTON);
                
                if (lpTbNotify->iItem < buttonCount)
                {
                    lpTbNotify->tbButton = allButtons[lpTbNotify->iItem];
                    return TRUE;
                }
                
                else
                
                {
                    return FALSE;  // No more buttons.
                }
            }
            
            break;

            case TBN_QUERYINSERT:
            
            case TBN_QUERYDELETE:
                return TRUE; 
        }
    }
```



### <a name="dragging-and-dropping-tools"></a>Перетаскивание инструментов

Пользователи также могут изменить порядок кнопок на панели инструментов, нажав клавишу SHIFT и перетащив кнопку в другое место. Процесс перетаскивания автоматически обрабатывается элементом управления ToolBar. Он отображает несинхронизированное изображение кнопки при перетаскивании и перемещает панель инструментов после ее удаления. Пользователи не могут добавлять кнопки таким образом, но могут удалить кнопку, удалив ее с панели инструментов.

Хотя элемент управления панели инструментов обычно выполняет эту операцию автоматически, он также отправляет два кода уведомления: [ТБН \_ Куериделете](tbn-querydelete.md) и [ТБН \_ куеринсерт](tbn-queryinsert.md). Чтобы управлять процессом перетаскивания, обрабатывайте эти коды уведомлений следующим образом:

-   Код уведомления [ТБН \_ куериделете](tbn-querydelete.md) отправляется сразу после того, как пользователь попытается переместить кнопку, перед отображением кнопки фантомной копии. Возвращает **значение false** , чтобы предотвратить перемещение кнопки. Если вы возвращаете **значение true**, пользователь сможет либо переместить средство, либо удалить его, удалив его с панели инструментов. Если средство можно переместить, его можно удалить. Тем не менее, если пользователь удаляет средство, элемент управления ToolBar отправляет приложению код уведомления [ТБН \_ делетингбуттон](tbn-deletingbutton.md) , после чего вы можете выбрать повторную вставку кнопки в ее исходном расположении, тем самым отменяя удаление.
-   Код уведомления [ТБН \_ куеринсерт](tbn-queryinsert.md) отправляется, когда пользователь пытается удалить кнопку на панели инструментов. Чтобы предотвратить удаление перемещаемой кнопки слева от кнопки, указанной в уведомлении, возвращается **значение false**. Этот код уведомления не отправляется, если пользователь удаляет средство с панели инструментов.

Если пользователь пытается перетащить кнопку, не нажимая клавишу SHIFT, элемент управления ToolBar не будет управлять операцией перетаскивания. Однако он отправит приложению код уведомления [ТБН \_ бегиндраг](tbn-begindrag.md) , чтобы указать начало операции перетаскивания, и код уведомления [ТБН \_ енддраг](tbn-enddrag.md) для указания конца. Если вы хотите включить эту форму перетаскивания, приложение должно поддерживать эти коды уведомлений, предоставлять необходимый пользовательский интерфейс и изменять панель инструментов в соответствии с любыми изменениями.

### <a name="saving-and-restoring-toolbars"></a>Сохранение и восстановление панелей инструментов

В процессе настройки панели инструментов приложению может потребоваться сохранить информацию, чтобы можно было восстановить ее исходное состояние. Чтобы начать сохранение или восстановление состояния панели инструментов, отправляйте панель инструментов с сообщением [**\_ савересторе ТБ**](tb-saverestore.md) с параметром *lParam* , имеющим значение **true**. Значение *lParam* этого сообщения указывает, запрашивается ли операция сохранения или восстановления. После отправки сообщения существует два способа работы с операцией сохранения и восстановления:

-   С помощью стандартных элементов управления [версии 4,72](common-control-versions.md) и более ранних версий необходимо реализовать обработчик [ \_ жетбуттонинфо ТБН](tbn-getbuttoninfo.md) . Элемент управления ToolBar отправляет этот код уведомления для запроса сведений о каждой кнопке при ее восстановлении.
-   Версия 5,80 включает параметр «сохранить/восстановить». В начале процесса и при сохранении или восстановлении каждой кнопки приложение получит код уведомления [ТБН \_ Save](tbn-save.md) или [ТБН \_ RESTORE](tbn-restore.md) . Чтобы использовать этот параметр, необходимо реализовать обработчики уведомлений, чтобы предоставить сведения о битовой карте и состоянии, необходимые для успешного сохранения или восстановления состояния панели инструментов.

Состояния панелей инструментов сохраняются в потоке данных, который состоит из блоков данных, определяемых оболочкой, которые изменяются блоками данных, определяемых приложением. Для каждой кнопки хранится один блок данных каждого типа, а также необязательный блок глобальных данных, которые приложения могут размещать в начале потока. Во время процесса сохранения обработчик [ \_ сохранения ТБН](tbn-save.md) добавляет определенные приложением блоки в поток данных. Во время процесса восстановления обработчик [ \_ восстановления ТБН](tbn-restore.md) считывает каждый блок и предоставляет оболочке сведения, необходимые для восстановления панели инструментов.

### <a name="how-to-handle-a-tbn_save-notification"></a>Как выполнить обработку \_ уведомления о СОХРАНЕНИИ ТБН

Первый [тбнный \_ ](tbn-save.md) код уведомления о сохранении отправляется в начале процесса сохранения. Перед сохранением каких бы то ни было кнопок, элементы структуры [**нмтбсаве**](/windows/win32/api/commctrl/ns-commctrl-nmtbsave) задаются, как показано в следующей таблице.



| Член       | Параметр                                                                                                                                                                                                                                                                                                                                            |
|--------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **iItem**    | –1                                                                                                                                                                                                                                                                                                                                                 |
| **cbData**   | Объем памяти, необходимый для данных, определяемых оболочкой.                                                                                                                                                                                                                                                                                                |
| **кбуттонс** | Число кнопок.                                                                                                                                                                                                                                                                                                                             |
| **pData**    | Вычисленный объем памяти, необходимый для определяемых приложением данных. Обычно включаются некоторые глобальные данные, а также данные для каждой кнопки. Добавьте это значение в **cbData** и выделите достаточно памяти для **pData** , чтобы вместить все данные.                                                                                                                      |
| **пкуррент** | Первый неиспользуемый байт в потоке данных. Если не требуются глобальные сведения о панели инструментов, установите **пкуррент**  =  **pData** так, чтобы он указывал на начало потока данных. Если вам требуются глобальные сведения о панели инструментов, сохраните их в **pData**, а затем установите **пкуррент** в начале неиспользуемой части потока данных перед возвратом. |



 

Если необходимо добавить некоторые глобальные сведения о панели инструментов, поставьте ее в начало потока данных. **Пкуррент** до конца глобальных данных, чтобы они указывали на начало неиспользуемой части потока данных и возвращали.

После возврата оболочка запускает сохранение сведений о кнопке. Он добавляет определяемые оболочкой данные для первой кнопки по адресу **пкуррент** , а затем перемещает **пкуррент** в начало неиспользуемой части.

После сохранения каждой кнопки отправляется код уведомления [ТБН \_ Save](tbn-save.md) , а [**нмтбсаве**](/windows/win32/api/commctrl/ns-commctrl-nmtbsave) возвращается с этими членами следующим образом.



| Член                       | Параметр                                                                                                                                                                                                                                                              |
|------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **iItem**                    | Отсчитываемый от нуля индекс номера кнопки.                                                                                                                                                                                                                           |
| **пкуррент**                 | Указатель на первый неиспользуемый байт в потоке данных. Если вы хотите сохранить дополнительные сведения о кнопке, сохраните ее в расположении, на которое указывает **пкуррент** , и обновите **пкуррент** , чтобы указать на первую неиспользуемую часть потока данных после этого. |
| [**тббуттон**](/windows/desktop/api/Commctrl/ns-commctrl-tbbutton) | Структура [**тббуттон**](/windows/desktop/api/Commctrl/ns-commctrl-tbbutton) , описывающая сохраняемую кнопку.                                                                                                                                                                              |



 

При получении кода уведомления необходимо извлечь все сведения, необходимые для каждой кнопки, из [**тббуттон**](/windows/desktop/api/Commctrl/ns-commctrl-tbbutton). Помните, что при добавлении кнопки можно использовать элемент **двдата** из **тббуттон** для хранения данных, зависящих от приложения. Загрузите данные в поток данных по адресу **пкуррент**. Передайте **пкуррент** к концу данных, снова наведите указатель на начало неиспользуемой части потока и возвратите.

Затем оболочка переходит к следующей кнопке, добавляет ее сведения в **pData**, увеличивает **пкуррент**, загружает [**тббуттон**](/windows/desktop/api/Commctrl/ns-commctrl-tbbutton)и отправляет еще один код уведомления о [ \_ тбне](tbn-save.md) . Этот процесс будет продолжен до тех пор, пока не будут сохранены все кнопки.

### <a name="restoring-saved-toolbars"></a>Восстановление сохраненных панелей инструментов

Процесс восстановления, в основном, обращается к процессу сохранения. В начале приложение получит код уведомления о [ \_ восстановлении ТБН](tbn-restore.md) с элементом **Член iItem** структуры [**нмтбресторе**](/windows/win32/api/commctrl/ns-commctrl-nmtbrestore) со значением – 1. Для элемента **cbData** задается размер **PData**, а **кбуттонс** — количество кнопок.

Обработчик уведомлений должен извлекать глобальные сведения, которые были помещены в начало элемента **pData** во время сохранения, а также **пкуррент** до начала первого блока данных, определяемых оболочкой. Задайте **кбитесперрекорд** в качестве размера блоков данных, которые использовались для сохранения данных кнопки. Задайте для **кбуттонс** число кнопок и возвратите.

Следующий [**нмтбресторе**](/windows/win32/api/commctrl/ns-commctrl-nmtbrestore) — для первой кнопки. Элемент **пкуррент** указывает на начало первого блока данных кнопки, а **Член iItem** — на индекс кнопки. Извлеките эти данные и предварительные **пкуррент**. Загрузите данные в [**тббуттон**](/windows/desktop/api/Commctrl/ns-commctrl-tbbutton)и возвратите. Чтобы опустить кнопку в восстановленной панели инструментов, установите для элемента **идкомманд** в **тббуттон** значение 0. Оболочка будет повторять процесс для оставшихся кнопок. Помимо сообщений [**нмтбсаве**](/windows/win32/api/commctrl/ns-commctrl-nmtbsave) и **нмтбресторе** , можно также использовать такие сообщения, как [ТБН \_ Reset](tbn-reset.md) , чтобы сохранить и восстановить панель инструментов.

Следующий пример кода сохраняет панель инструментов до ее настройки и восстанавливает ее, если приложение получает сообщение о [ \_ сбросе ТБН](tbn-reset.md) .


```C++
int               i;
LPNMHDR           lpnmhdr;
static int        nResetCount;
static LPTBBUTTON lpSaveButtons;
LPARAM            lParam;

switch( lpnmhdr->code)
{
    case TBN_BEGINADJUST: // Begin customizing the toolbar.
    {
        LPTBNOTIFY  lpTB = (LPTBNOTIFY)lparam;
       
        // Allocate memory for the button information.
        
        nResetCount   = SendMessage(lpTB->hdr.hwndFrom, TB_BUTTONCOUNT, 0, 0);
        lpSaveButtons = (LPTBBUTTON)GlobalAlloc(GPTR, sizeof(TBBUTTON) * nResetCount);
      
        // In case the user presses reset, save the current configuration 
        // so the original toolbar can be restored.
        
        for(i = 0; i < nResetCount; i++)
        {
            SendMessage(lpTB->hdr.hwndFrom, 
                        TB_GETBUTTON, i, 
                        (LPARAM)(lpSaveButtons + i));
        }
    }
    
    return TRUE;
   
    case TBN_RESET:
    {
        LPTBNOTIFY lpTB = (LPTBNOTIFY)lparam;
        
        int nCount, i;
    
        // Remove all of the existing buttons, starting with the last one.
        
        nCount = SendMessage(lpTB->hdr.hwndFrom, TB_BUTTONCOUNT, 0, 0);
        
        for(i = nCount - 1; i >= 0; i--)
        {
            SendMessage(lpTB->hdr.hwndFrom, TB_DELETEBUTTON, i, 0);
        }
      
        SendMessage(lpTB->hdr.hwndFrom,      // Restore the saved buttons.
                    TB_ADDBUTTONS, 
                    (WPARAM)nResetCount, 
                    (LPARAM)lpSaveButtons);
    }
    
    return TRUE;
   
    case TBN_ENDADJUST:                // Free up the memory you allocated.
        GlobalFree((HGLOBAL)lpSaveButtons);
        
        return TRUE;
}
```



## <a name="related-topics"></a>См. также

<dl> <dt>

[Использование элементов управления ToolBar](using-toolbar-controls.md)
</dt> <dt>

[**Значения индекса изображения стандартной кнопки панели инструментов**](toolbar-standard-button-image-index-values.md)
</dt> <dt>

[Демонстрация стандартных элементов управления Windows (Кппвиндовскоммонконтролс)](https://github.com/microsoftarchive/msdn-code-gallery-microsoft/tree/master/OneCodeTeam/Windows%20common%20controls%20demo%20(CppWindowsCommonControls)/%5BC++%5D-Windows%20common%20controls%20demo%20(CppWindowsCommonControls)/C++/CppWindowsCommonControls)
</dt> </dl>

 

 




