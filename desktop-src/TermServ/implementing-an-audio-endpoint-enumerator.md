---
title: Реализация пользовательского перечислителя конечной точки аудио
description: начиная с Windows Server 2008 R2, можно реализовать настраиваемый перечислитель конечных точек удаленного аудио в составе поставщика удаленный рабочий стол протокола.
ms.assetid: 684bd62e-1e28-4330-a3c5-6bce684d652d
ms.tgt_platform: multiple
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 3ae135d19e13e3b78fddbdd58bccd476b7e5ee7a
ms.sourcegitcommit: 9b5faa61c38b2d0c432b7f2dbee8c127b0e28a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/19/2021
ms.locfileid: "122478860"
---
# <a name="implementing-a-custom-audio-endpoint-enumerator"></a>Реализация пользовательского перечислителя конечной точки аудио

начиная с Windows Server 2008 R2, можно реализовать настраиваемый перечислитель конечных точек удаленного аудио в составе поставщика удаленный рабочий стол протокола. Поставщик протокола удаленный рабочий стол может использовать пользовательский перечислитель конечной точки аудио для получения коллекции звуковых конечных точек, имеющих конкретный набор возможностей.

**Реализация настраиваемого перечислителя конечной точки удаленной аудиоподсистемы**

1.  Решение перечислителя пользовательской конечной точки должно реализовывать четыре основных типа объектов: объекты перечислителя устройств, объекты коллекции устройств, объекты устройств и объекты хранилища свойств.

    

    
| Тип объекта | Описание: | 
|-------------|-------------|
| Объект перечислителя устройства<br /> | Объект перечислителя устройства предоставляет функциональные возможности перечислителя конечных точек. Он предоставляет методы, возвращающие конечную точку по умолчанию и указанные коллекции конечных точек. Например, в зависимости от указанных критериев перечислитель может возвращать конечные точки связи, конечные точки воспроизведения или конечные точки записи. Объект перечислителя устройства должен реализовывать интерфейс <a href="/windows/desktop/api/mmdeviceapi/nn-mmdeviceapi-immdeviceenumerator"><strong>иммдевицеенумератор</strong></a> .<br /> | 
| Объект коллекции устройств<br /> | Объект коллекции устройств представляет коллекцию звуковых устройств. Он должен реализовывать интерфейс <a href="/windows/desktop/api/mmdeviceapi/nn-mmdeviceapi-immdevicecollection"><strong>иммдевицеколлектион</strong></a> .<br /> | 
| Объект устройства<br /> | Объект устройства представляет конкретное звуковое устройство. Он предоставляет доступ к хранилищу свойств звукового устройства и предоставляет интерфейсы воспроизведения и записи звука, доступные на устройстве. Объект устройства должен реализовывать интерфейсы <a href="/windows/desktop/api/mmdeviceapi/nn-mmdeviceapi-immdevice"><strong>иммдевице</strong></a> и <a href="/windows/desktop/api/mmdeviceapi/nn-mmdeviceapi-immendpoint"><strong>иммендпоинт</strong></a> .<br /> | 
| Объект хранилища свойств<br /> | Объект хранилища свойств предоставляет свойства, связанные с звуковым устройством. Некоторые из этих свойств используются системой, но приложения могут также хранить произвольные свойства с конечной точкой аудио.<br /> Все звуковые устройства имеют следующие три свойства:<br /><ul><li><a href="/windows/desktop/CoreAudio/pkey-deviceinterface-friendlyname"><strong>PKEY_DeviceInterface_FriendlyName</strong></a></li><li><a href="/windows/desktop/CoreAudio/pkey-device-devicedesc"><strong>PKEY_Device_DeviceDesc</strong></a></li><li><a href="/windows/desktop/CoreAudio/pkey-device-friendlyname"><strong>PKEY_Device_FriendlyName</strong></a></li></ul>    Объект хранилища свойств должен реализовывать интерфейс <a href="/windows/win32/api/propsys/nn-propsys-ipropertystore">ипропертисторе</a> .<br /> | 


    

     

2.  Пользовательский перечислитель конечной точки должен быть реализован в библиотеке DLL, которая может быть загружена в звуковую систему и другие приложения. Библиотека DLL должна быть подписана так, чтобы защищенные процессы могли загрузить ее. Библиотека DLL должна реализовывать и экспортировать функцию [**жеттсаудиоендпоинтенумераторфорсессион**](gettsaudioendpointenumeratorforsession.md) , которая выступает в качестве точки входа в пользовательский перечислитель конечной точки.

служба службы удаленных рабочих столов вызывает метод [**куерипроперти**](/windows/desktop/api/Wtsprotocol/nf-wtsprotocol-iwtsprotocolconnection-queryproperty) и задает для параметра *QueryType* значение **WTS \_ \_ \_ DLL аудиоенум** , чтобы получить имя объекта перечислителя.

Пользовательские объекты перечислителя используют COM-подобные интерфейсы и механизм подсчета ссылок, подобный COM, но они не являются истинными COM-объектами. Пользовательский перечислитель конечной точки должен иметь возможность работать с устаревшими звуковыми интерфейсами, используемыми приложениями, которые не поддерживают COM. По этой причине пользовательский перечислитель конечной точки не должен полагаться на механизм управления жизненным циклом COM. Потребители в перечислителе конечных точек аудио, такие как MMDevAPI.dll, загружают библиотеку DLL перечислителя пользовательской конечной точки, если это требуется для пользовательских приложений, и не выгружают перечислитель, когда перечислитель содержит ссылку на объект перечислителя устройства, объект коллекции устройств, объект устройства или объект хранилища свойств. Однако невозможно для этих потребителей отслеживание ссылок на другие типы объектов, принадлежащих перечислителю пользовательской конечной точки. Соответственно, мы рекомендуем, чтобы пользовательский перечислитель конечной точки не мог создавать объекты, которые могут разжить эти четыре типа объектов.

## <a name="to-implement-a-custom-audio-endpoint"></a>Реализация пользовательской конечной точки звука

Для реализации пользовательского перечислителя аудио-устройств необходимо реализовать пользовательскую конечную точку звука. Способ связи пользовательских звуковых устройств заключается в использовании следующих двух операторов:

-   `IMMDevice::Activate(IAudioOutputEndpointRT)`
-   `IMMDevice::Activate(IAudioInputEndpointRT)`

Мы не планируем реализовать полный список интерфейсов [**иммдевице:: Activate**](/windows/desktop/api/mmdeviceapi/nf-mmdeviceapi-immdevice-activate) в пользовательском перечислителе звукового устройства. Вместо этого следует реализовать [**иаудиуутпутендпоинтрт**](/windows/desktop/api/Audioengineendpoint/nn-audioengineendpoint-iaudiooutputendpointrt) и [**иаудиоинпутендпоинтрт**](/windows/desktop/api/Audioengineendpoint/nn-audioengineendpoint-iaudioinputendpointrt). При необходимости можно реализовать еще несколько возможностей, например [**иаудиоендпоинтволуме**](/windows/desktop/api/endpointvolume/nn-endpointvolume-iaudioendpointvolume). Для любого интерфейса, который не реализуется, следует вернуть **\_ интерфейс E** (необходимо использовать этот код ошибки). после этого Windows перейдет к реализации на бирже интерфейса (например, [**IAudioClient2**](/windows/desktop/api/audioclient/nn-audioclient-iaudioclient2)).

Дополнительную справочную документацию по реализации и регистрации конечных точек аудио см. в разделе [**иаудиоинпутендпоинтрт**](/windows/desktop/api/Audioengineendpoint/nn-audioengineendpoint-iaudioinputendpointrt). Схему, в которой показано, как работает ВАСАПИ, см. в разделе [аудио-компоненты пользовательского режима](/windows/desktop/CoreAudio/user-mode-audio-components). обратите внимание, что все аудио в пользовательском режиме впервые начинаются с Windows Server 2008.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Создание поставщика протокол удаленного рабочего стола](creating-a-custom-remote-protocol.md)
</dt> <dt>

[**жеттсаудиоендпоинтенумераторфорсессион**](gettsaudioendpointenumeratorforsession.md)
</dt> <dt>

[**иммдевице**](/windows/desktop/api/mmdeviceapi/nn-mmdeviceapi-immdevice)
</dt> <dt>

[**иммдевицеколлектион**](/windows/desktop/api/mmdeviceapi/nn-mmdeviceapi-immdevicecollection)
</dt> <dt>

[**иммдевицеенумератор**](/windows/desktop/api/mmdeviceapi/nn-mmdeviceapi-immdeviceenumerator)
</dt> <dt>

[**иммендпоинт**](/windows/desktop/api/mmdeviceapi/nn-mmdeviceapi-immendpoint)
</dt> <dt>

[ипропертисторе](/windows/win32/api/propsys/nn-propsys-ipropertystore)
</dt> </dl>
