---
description: в этом разделе описываются требования к созданию пользовательских обработчиков метаданных для компонента Windows imaging (WIC), включая средства чтения и записи метаданных.
ms.assetid: 08f1872b-6e4d-44ee-abc7-48685e435acc
title: Общие сведения о расширяемости метаданных
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: c7d38206fb02c47edbe9744deb6ceb0093277d8354f8717aa89c3f1976bdeb51
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119088176"
---
# <a name="metadata-extensibility-overview"></a>Общие сведения о расширяемости метаданных

в этом разделе описываются требования к созданию пользовательских обработчиков метаданных для компонента Windows imaging (WIC), включая средства чтения и записи метаданных. Также обсуждаются требования к расширению обнаружения компонентов во время выполнения компонента WIC для включения пользовательских обработчиков метаданных.

В этом разделе содержатся следующие подразделы.

-   [Предварительные требования](#prerequisites)
-   [Введение](#introduction)
-   [Создание средства чтения метаданных](#creating-a-metadata-reader)
    -   [Интерфейс Ивикметадатареадер](#iwicmetadatareader-interface)
    -   [Интерфейс Ивикперсистстреам](#iwicpersiststream-interface)
    -   [Интерфейс Ивикстреампровидер](#iwicstreamprovider-interface)
-   [Создание модуля записи метаданных](#creating-a-metadata-writer)
    -   [Интерфейс Ивикметадатавритер](#iwicmetadatawriter-interface)
    -   [Интерфейс Ивикперсистстреам](#iwicpersiststream-interface)
    -   [Интерфейс Ивикстреампровидер](#iwicstreamprovider-interface)
-   [Установка и регистрация обработчика метаданных](#installing-and-registering-a-metadata-handler)
    -   [Разделы реестра обработчика метаданных](#metadata-handler-registry-keys)
    -   [Читатели метаданных](#metadata-readers)
    -   [Записи метаданных](#metadata-writers)
    -   [Подписывание обработчика метаданных](#signing-a-metadata-handler)
-   [Особые рекомендации](#special-considerations)
    -   [пропвариантс](#propvariants)
    -   [Обработчики 8BIM](#8bim-handlers)
-   [Связанные темы](#related-topics)

## <a name="prerequisites"></a>Предварительные условия

Чтобы разобраться в этом разделе, необходимо иметь глубокое представление о компонентах WIC, его компонентах и метаданных для изображений. Дополнительные сведения о метаданных WIC см. в статье [Общие сведения о метаданных WIC](-wic-about-metadata.md). дополнительные сведения о компонентах WIC см. в разделе [обзор компонента создания образов Windows](-wic-about-windows-imaging-codec.md).

## <a name="introduction"></a>Введение

Как обсуждалось в [обзоре метаданных WIC](-wic-about-metadata.md), часто встречается несколько блоков метаданных в изображении, каждый из которых предоставляет различные типы данных в различных форматах метаданных. Для взаимодействия с форматом метаданных, внедренным в образ, приложение должно использовать соответствующий обработчик метаданных. Компонент WIC предоставляет несколько обработчиков метаданных (средств чтения и записи метаданных), которые позволяют считывать и записывать определенные типы метаданных, например EXIF или XMP.

Помимо предоставленных собственных обработчиков, компонент WIC предоставляет интерфейсы API, позволяющие создавать новые обработчики метаданных, участвующие в обнаружении компонентов компонента WIC во время выполнения. Это позволяет приложениям, использующим WIC, считывать и записывать пользовательские форматы метаданных.

Следующие шаги позволяют обработчикам метаданных участвовать в обнаружении метаданных во время выполнения компонента WIC.

-   Реализуйте класс обработчика метаданных ([**ивикметадатареадер**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicmetadatareader)), который предоставляет необходимые интерфейсы WIC для чтения пользовательского формата метаданных. Это позволяет приложениям на основе WIC считывать формат метаданных так же, как они считывают собственные форматы метаданных.
-   Реализуйте класс обработчика записи метаданных ([**ивикметадатавритер**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicmetadatawriter)), который предоставляет необходимые интерфейсы WIC для кодирования пользовательского формата метаданных. Это позволяет приложениям на основе WIC сериализовать формат метаданных в Поддерживаемые форматы изображений.
-   Цифровая подпись и регистрация обработчиков метаданных. Это позволяет обнаруживать обработчики метаданных во время выполнения путем сопоставления идентифицирующего шаблона в реестре с шаблоном, внедренным в файл изображения.

## <a name="creating-a-metadata-reader"></a>Создание средства чтения метаданных

Основным доступом к блокам метаданных внутри кодека является интерфейс [**ивикметадатаблоккреадер**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicmetadatablockreader) , реализуемый каждым кодеком WIC. Этот интерфейс перечисляет все блоки метаданных, внедренные в формат изображения, чтобы можно было обнаружить и создать экземпляры соответствующего обработчика метаданных для каждого блока. Блоки метаданных, не распознаваемые WIC, считаются неизвестными и определяются как GUID CLSID \_ викункновнметадатареадер. Чтобы формат метаданных был распознан компонентом WIC, необходимо создать класс, реализующий три интерфейса: [**ивикметадатареадер**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicmetadatareader), [**ивикперсистстреам**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicpersiststream)и [**ивикстреампровидер**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicstreamprovider).

> [!Note]  
> Если формат метаданных имеет ограничения, которые отображают некоторые методы требуемых интерфейсов, такие методы должны возвращать ВИНКОДЕК \_ Err \_ унсуппортедоператион.

 

### <a name="iwicmetadatareader-interface"></a>Интерфейс Ивикметадатареадер

При создании средства чтения метаданных должен быть реализован интерфейс [**ивикметадатареадер**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicmetadatareader) . Этот интерфейс предоставляет доступ к элементам метаданных ундерлинг в потоке данных в формате метаданных.

В следующем коде показано определение интерфейса средства чтения метаданных, как определено в файле винкодексдк. idl.

``` syntax
interface IWICMetadataReader : IUnknown
{
    HRESULT GetMetadataFormat(
        [out] GUID *pguidMetadataFormat
        );

    HRESULT GetMetadataHandlerInfo(
        [out] IWICMetadataHandlerInfo **ppIHandler
        );

    HRESULT GetCount(
        [out] UINT *pcCount
        );

    HRESULT GetValueByIndex(
        [in] UINT nIndex,
        [in, out, unique] PROPVARIANT *pvarSchema,
        [in, out, unique] PROPVARIANT *pvarId,
        [in, out, unique] PROPVARIANT *pvarValue
        );

    HRESULT GetValue(
        [in, unique] const PROPVARIANT *pvarSchema,
        [in] const PROPVARIANT *pvarId,
        [in, out, unique] PROPVARIANT *pvarValue
        );

    HRESULT GetEnumerator(
        [out] IWICEnumMetadataItem **ppIEnumMetadata
        );
};
```

Метод **жетметадатаформат** возвращает идентификатор GUID вашего формата метаданных.

Метод **жетметадатахандлеринфо** возвращает интерфейс [**ивикметадатахандлеринфо**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicmetadatahandlerinfo) , предоставляющий сведения о обработчике метаданных. Сюда входят такие сведения, как форматы изображений, поддерживающие формат метаданных, и требуется ли для читателя метаданных доступ к полному потоку метаданных.

Метод **NOCOUNT** возвращает количество отдельных элементов метаданных (включая внедренные блоки метаданных), найденных в потоке метаданных.

Метод **жетвалуебиндекс** Возвращает элемент метаданных по значению индекса. Этот метод позволяет приложениям циклически проходить по каждому элементу метаданных в блоке метаданных. В следующем коде показано, как приложение может использовать этот метод для извлечения каждого элемента метаданных в блоке метаданных.


```C++
PROPVARIANT readerValue;
IWICMetadataBlockReader *blockReader = NULL;
IWICMetadataReader *reader = NULL;

PropVariantInit(&readerValue);

hr = pFrameDecode->QueryInterface(IID_IWICMetadataBlockReader, (void**)&blockReader);

if (SUCCEEDED(hr))
{
    // Retrieve the third block in the image. This is image specific and
    // ideally you should call this by retrieving the reader count
    // first.
    hr = blockReader->GetReaderByIndex(2, &reader);
}

if (SUCCEEDED(hr))
{
    UINT numValues = 0;

    hr = reader->GetCount(&numValues);

    // Loop through each item and retrieve by index
    for (UINT i = 0; SUCCEEDED(hr) && i < numValues; i++)
    {
        PROPVARIANT id, value;

        PropVariantInit(&id);
        PropVariantInit(&value);

        hr = reader->GetValueByIndex(i, NULL, &id, &value);

        if (SUCCEEDED(hr))
        {
            // Do something with the metadata item.
            //...
        }
        PropVariantClear(&id);
        PropVariantClear(&value);
    }               
}
```



Метод **GetValue** извлекает конкретный элемент метаданных по схеме и (или) идентификатору. Этот метод аналогичен методу **жетвалуебиндекс** , за исключением того, что он извлекает элемент метаданных с определенной схемой или идентификатором.

Метод **GetEnumerator** Возвращает перечислитель каждого элемента метаданных в блоке метаданных. Это позволяет приложениям использовать перечислитель для навигации по формату метаданных.

Если формат метаданных не имеет представления о схемах для элементов метаданных, то параметр GetValue... методы должны игнорировать это свойство. Однако если ваш формат поддерживает именование схемы, необходимо предусмотреть значение **null** .

Если элемент метаданных является внедренным блоком метаданных, создайте обработчик метаданных из подпотока внедренного содержимого и возвратите новый обработчик метаданных. Если для вложенного блока нет доступного модуля чтения метаданных, создайте экземпляр и возвратите неизвестный модуль чтения метаданных. Чтобы создать новый модуль чтения метаданных для внедренного блока, вызовите методы **креатеметадатареадерфромконтаинер** или **креатеметадатареадер** фабрики компонентов или вызовите функцию [**викматчметадатаконтент**](/windows/desktop/api/wincodecsdk/nf-wincodecsdk-wicmatchmetadatacontent) .

Если поток метаданных содержит содержимое с обратным порядком байтов, модуль чтения метаданных отвечает за обмен всеми обрабатываемыми им значениями данных. Он также отвечает за уведомление всех вложенных модулей чтения метаданных о том, что они работают с потоком данных с обратным порядком байтов. Однако все значения должны возвращаться в формате с прямым порядком байтов.

Реализация поддержки для навигации по пространству имен путем поддержки запросов, где идентификатор элемента метаданных — это `VT_CLSID` (GUID), соответствующий формату метаданных. Если во время синтаксического анализа определяется вложенный модуль чтения метаданных для этого формата, он должен быть возвращен. Это позволяет приложениям использовать средство чтения запросов метаданных для поиска в формате метаданных.

При получении элемента метаданных по ИДЕНТИФИКАТОРу следует использовать [функцию пропвариантчанжетипе](/windows/win32/api/propvarutil/nf-propvarutil-propvariantchangetype) для ПРИВЕДЕНия идентификатора к ожидаемому типу. Например, средство чтения IFD приводит идентификатор к типу `VT_UI2` , совпадающему с типом данных ТЕГА IFD с идентификатором ushort. Для этого тип входных данных и ожидаемый тип должны быть [пропвариант](/windows/win32/api/propidlbase/ns-propidlbase-propvariant) . Это не является обязательным, но выполнение этого приведения упрощает код, который вызывает модуль чтения для запроса элементов метаданных.

### <a name="iwicpersiststream-interface"></a>Интерфейс Ивикперсистстреам

Интерфейс [**ивикперсистстреам**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicpersiststream) наследует от класса **IPersistStream** и предоставляет дополнительные методы для сохранения и загрузки объектов с помощью перечисления [**викперсистоптионс**](/windows/desktop/api/Wincodecsdk/ne-wincodecsdk-wicpersistoptions) .

В следующем коде показано определение интерфейса [**ивикперсистстреам**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicpersiststream) , как определено в файле винкодексдк. idl.

``` syntax
interface IWICPersistStream : IPersistStream
{
    HRESULT LoadEx(
        [in, unique] IStream *pIStream,
        [in, unique] const GUID *pguidPreferredVendor,
        [in] DWORD dwPersistOptions
        );

    HRESULT SaveEx(
        [in] IStream *pIStream,
        [in] DWORD dwPersistOptions,
        [in] BOOL fClearDirty
        );
};
```

Метод **лоадекс** предоставляет модулю чтения метаданных поток данных, содержащий блок метаданных. Модуль чтения анализирует этот поток для доступа к базовым элементам метаданных. Модуль чтения метаданных инициализируется с помощью подпотока, расположенного в начале необработанного содержимого метаданных. Если модулю чтения не требуется полный поток, подпоток ограничен в пределах диапазона только содержимым блока метаданных. в противном случае полный поток метаданных предоставляется вместе с положением, заданным в начале блока метаданных.

Метод **Савикс** используется модулями записи метаданных для сериализации блока метаданных. Если **Савикс** используется в модуле чтения метаданных, он должен возвращать винкодек \_ Err \_ унсуппортедоператион.

### <a name="iwicstreamprovider-interface"></a>Интерфейс Ивикстреампровидер

Интерфейс [**ивикстреампровидер**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicstreamprovider) позволяет модулю чтения метаданных предоставлять ссылки на его поток содержимого, предоставлять сведения о потоке и обновлять кэшированные версии потока.

В следующем коде показано определение интерфейса [**ивикстреампровидер**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicstreamprovider) , как определено в файле винкодексдк. idl.

``` syntax
interface IWICStreamProvider : IUnknown
{
    HRESULT GetStream(
        [out] IStream **ppIStream
        );

    HRESULT GetPersistOptions(
        [out] DWORD *pdwPersistOptions
        );

    HRESULT GetPreferredVendorGUID(
        [out] GUID *pguidPreferredVendor
        );

    HRESULT RefreshStream(
        );
};
```

Метод **WebMethod извлекает** ссылку на поток метаданных. Возвращаемый поток должен вернуть указатель потока к начальной позиции. Если формат метаданных требует полного доступа к потоку, начальное расположение должно быть началом блока метаданных.

Метод **жетперсистоптионс** возвращает текущие параметры потока из перечисления [**викперсистоптионс**](/windows/desktop/api/Wincodecsdk/ne-wincodecsdk-wicpersistoptions) .

Метод **жетпреферредвендоргуид** возвращает идентификатор GUID поставщика средства чтения метаданных.

Метод **рефрешстреам** обновляет поток метаданных. Этот метод должен вызывать **лоадекс** с **нулевым** потоком для любых вложенных блоков метаданных. Это необходимо потому, что вложенные блоки метаданных и их элементы могут больше не существовать из-за редактирования на месте.

## <a name="creating-a-metadata-writer"></a>Создание модуля записи метаданных

Модуль записи метаданных — это тип обработчика метаданных, который предоставляет способ сериализации блока метаданных в кадр изображения или за пределы отдельного кадра, если формат изображения поддерживает его. Основным доступом к модулям записи метаданных внутри кодека является интерфейс [**ивикметадатаблокквритер**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicmetadatablockwriter) , реализуемый каждым кодировщиком WIC. Этот интерфейс позволяет приложениям перечислять каждый из блоков метаданных, внедренных в образ, чтобы можно было обнаружить и создать экземпляры соответствующего модуля записи метаданных для каждого блока метаданных. Блоки метаданных, у которых нет соответствующего модуля записи метаданных, считаются неизвестными и определяются как GUID CLSID \_ викункновнметадатареадер. Чтобы разрешить приложениям с поддержкой WIC сериализацию и запись формата метаданных, необходимо создать класс, реализующий следующие интерфейсы: [**ивикметадатавритер**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicmetadatawriter), [**ивикметадатареадер**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicmetadatareader), [**ивикперсистстреам**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicpersiststream)и [**ивикстреампровидер**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicstreamprovider).

> [!Note]  
> Если формат метаданных имеет ограничения, которые отображают некоторые методы требуемых интерфейсов, такие методы должны возвращать ВИНКОДЕК \_ Err \_ унсуппортедоператион.

 

### <a name="iwicmetadatawriter-interface"></a>Интерфейс Ивикметадатавритер

Интерфейс [**ивикметадатавритер**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicmetadatawriter) должен быть реализован модулем записи метаданных. Кроме того, поскольку **ивикметадатавритер** наследует от [**ивикметадатареадер**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicmetadatareader), необходимо также реализовать все методы **ивикметадатареадер**. Так как для обоих типов обработчиков требуется одинаковое наследование интерфейса, может потребоваться создать один класс, предоставляющий функции чтения и записи.

В следующем коде показано определение интерфейса модуля записи метаданных, как определено в файле винкодексдк. idl.

``` syntax
interface IWICMetadataWriter : IWICMetadataReader
{
    HRESULT SetValue(
        [in, unique] const PROPVARIANT *pvarSchema,
        [in] const PROPVARIANT *pvarId,
        [in] const PROPVARIANT *pvarValue
        );

    HRESULT SetValueByIndex(
        [in] UINT nIndex,
        [in, unique] const PROPVARIANT *pvarSchema,
        [in] const PROPVARIANT *pvarId,
        [in] const PROPVARIANT *pvarValue
        );

    HRESULT RemoveValue(
        [in, unique] const PROPVARIANT *pvarSchema,
        [in] const PROPVARIANT *pvarId
        );

    HRESULT RemoveValueByIndex(
        [in] UINT nIndex
        );
};
```

Метод **SetValue** записывает заданный элемент метаданных в поток метаданных.

Метод **сетвалуебиндекс** записывает указанный элемент метаданных в указанный индекс в потоке метаданных. Индекс не ссылается на идентификатор, а на позицию элемента в блоке метаданных.

Метод **ремовевалуе** удаляет указанный элемент метаданных из потока метаданных.

Метод **ремовевалуебиндекс** удаляет элемент метаданных по указанному индексу из потока метаданных. После удаления элемента ожидается, что остальные элементы метаданных будут занимать освобожденный индекс, если индекс не является последним индексом. Также ожидается, что счетчик будет изменяться после удаления элемента.

Это обязанность модуля записи метаданных для преобразования элементов [пропвариант](/windows/win32/api/propidlbase/ns-propidlbase-propvariant) в базовую структуру, необходимую для вашего формата. Однако, в отличие от средства чтения метаданных, типы VARIANT обычно не следует приводить к разным типам, так как вызывающий объект явно указывает, какой тип данных следует использовать.

Модуль записи метаданных должен зафиксировать все элементы метаданных в потоке изображений, включая скрытые или нераспознанные значения. Сюда входят неизвестные вложенные блоки метаданных. Тем не менее, прежде чем инициировать операцию сохранения, необходимо, чтобы кодировщик установил все критические элементы метаданных.

Если поток метаданных содержит содержимое с обратным порядком байтов, то модуль записи метаданных отвечает за обмен обрабатываемыми им значениями данных. Он также отвечает за уведомление всех вложенных модулей записи метаданных о том, что они работают с потоком данных с обратным порядком байтов при сохранении.

Реализуйте поддержку создания и удаления пространства имен путем поддержки операций Set и Remove для элементов метаданных с типом `VT_CLSID` (GUID), соответствующим формату метаданных. Модуль записи метаданных вызывает функцию [**виксериализеметадатаконтент**](/windows/desktop/api/wincodecsdk/nf-wincodecsdk-wicserializemetadatacontent) для правильного внедрения вложенного содержимого модуля записи метаданных в родительский модуль записи метаданных.

Если ваш формат метаданных поддерживает кодирование на месте, вы несете ответственность за управление обязательным заполнением. Дополнительные сведения о кодировке на месте см. в разделе [Общие сведения о метаданных WIC](-wic-about-metadata.md) и [Обзор чтения и записи метаданных изображения](-wic-codec-readingwritingmetadata.md).

### <a name="iwicpersiststream-interface"></a>Интерфейс Ивикперсистстреам

Интерфейс [**ивикперсистстреам**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicpersiststream) наследует от класса **IPersistStream** и предоставляет дополнительные методы для сохранения и загрузки объектов с помощью перечисления [**викперсистоптионс**](/windows/desktop/api/Wincodecsdk/ne-wincodecsdk-wicpersistoptions) .

В следующем коде показано определение интерфейса [**ивикперсистстреам**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicpersiststream) , как определено в файле винкодексдк. idl.

``` syntax
interface IWICPersistStream : IPersistStream
{
    HRESULT LoadEx(
        [in, unique] IStream *pIStream,
        [in, unique] const GUID *pguidPreferredVendor,
        [in] DWORD dwPersistOptions
        );

    HRESULT SaveEx(
        [in] IStream *pIStream,
        [in] DWORD dwPersistOptions,
        [in] BOOL fClearDirty
        );
};
```

Метод **лоадекс** предоставляет обработчик метаданных с потоком данных, содержащим блок метаданных.

Метод **Савикс** сериализует метаданные в поток. Если предоставленный поток совпадает с потоком инициализации, необходимо выполнить кодирование на месте. Если поддерживается кодировка на месте, этот метод должен возвращать ВИНКОДЕК \_ Err \_ тумучметадата, если для выполнения кодирования на месте недостаточно заполнения. Если кодировка на месте не поддерживается, этот метод должен возвращать ВИНКОДЕК \_ Err \_ унсуппортедоператион.

Метод **IPersistStream:: жетсиземакс** должен быть реализован и должен возвращать точный размер содержимого метаданных, которое будет записано при последующем сохранении.

Метод **IPersistStream:: IsDirty** должен быть реализован, если модуль записи метаданных инициализируется через поток, чтобы образ мог надежно определить, изменилось ли его содержимое.

Если формат метаданных поддерживает вложенные блоки метаданных, то модуль записи метаданных должен делегировать вложенным средствам записи метаданных сериализацию его содержимого при сохранении в поток.

### <a name="iwicstreamprovider-interface"></a>Интерфейс Ивикстреампровидер

Реализация интерфейса [**ивикстреампровидер**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicstreamprovider) для модуля записи метаданных аналогична реализации средства чтения метаданных. Дополнительные сведения см. в разделе Создание модуля чтения метаданных в этом документе.

## <a name="installing-and-registering-a-metadata-handler"></a>Установка и регистрация обработчика метаданных

Чтобы установить обработчик метаданных, необходимо предоставить сборку обработчика и зарегистрировать ее в системном реестре. Вы можете решить, как и когда будут заполнены разделы реестра.

> [!Note]  
> Для удобства чтения фактические шестнадцатеричные идентификаторы GUID не отображаются в разделах реестра, приведенных в следующих разделах этого документа. Чтобы найти шестнадцатеричное значение для указанного понятного имени, см. файлы винкодек. idl и винкодексдк. idl.

 

### <a name="metadata-handler-registry-keys"></a>Разделы реестра обработчика метаданных

Каждый обработчик метаданных идентифицируется уникальным идентификатором CLSID, и каждый обработчик должен зарегистрировать его CLSID в идентификаторе GUID идентификатора категории обработчика метаданных. Идентификатор категории каждого типа обработчика определяется в винкодек. idl; имя идентификатора категории для читателей — CATID \_ викметадатареадер, а имя идентификатора категории для модулей записи — CATID \_ викметадатавритер.

Каждый обработчик метаданных идентифицируется уникальным идентификатором CLSID, и каждый обработчик должен зарегистрировать его CLSID в идентификаторе GUID идентификатора категории обработчика метаданных. Идентификатор категории каждого типа обработчика определяется в винкодек. idl; имя идентификатора категории для читателей — CATID \_ викметадатареадер, а имя идентификатора категории для модулей записи — CATID \_ викметадатавритер.

> [!Note]  
> В следующих листингах разделов реестра {Reader CLSID} относится к уникальному идентификатору CLSID, предоставленному для средства чтения метаданных. {Writer CLSID} относится к уникальному идентификатору CLSID, предоставленному для модуля записи метаданных. {Handler CLSID} относится к CLSID модуля чтения, CLSID модуля записи или к обоим, в зависимости от предоставляемых обработчиков. {Контейнер GUID} относится к объекту контейнера (формат изображения или формат метаданных), который может содержать блок метаданных.

 

Следующие разделы реестра регистрируют обработчик метаданных с другими доступными обработчиками метаданных:

``` syntax
[HKEY_CLASSES_ROOT\CLSID\{CATID_WICMetadataReaders}\Instance\{Reader CLSID}]
CLSID={Reader CLSID}
Friendly Name="Reader Name"

[HKEY_CLASSES_ROOT\CLSID\{CATID_ WICMetadataWriters}\Instance\{Writer CLSID}]
CLSID={Writer CLSID}
Friendly Name="Writer Name"
```

Кроме регистрации обработчиков в соответствующих категориях, необходимо также зарегистрировать дополнительные ключи, предоставляющие сведения, относящиеся к обработчику. Читатели и модули записи имеют аналогичные требования к разделам реестра. В следующем синтаксисе показано, как зарегистрировать обработчик. Обработчик чтения и обработчик записи должны быть зарегистрированы таким образом, используя соответствующие идентификаторы CLSID:

``` syntax
[HKEY_CLASSES_ROOT\CLSID\{CLSID}]
"Vendor"={VendorGUID}
"Date"="yyyy-mm-dd"
"Version"="Major.Minor.Build.Number"
"SpecVersion"="Major.Minor.Build.Number"
"MetadataFormat"={MetadataFormatGUID}
"RequiresFullStream"=dword:1|0
"SupportsPadding"= dword:1|0
"FixedSize"=0

[HKEY_CLASSES_ROOT\CLSID\{CLSID}\InProcServer32]
@="drive:\path\yourdll.dll"
"ThreadingModel"="Apartment"

[HKEY_CLASSES_ROOT\CLSID\{CLSID}\{LCID}]
Author="Author's Name"
Description = " Metadata Description"
DeviceManufacturer ="Manufacturer Name"
DeviceModels="Device,Device"
FriendlyName="Friendly Name"
```

### <a name="metadata-readers"></a>Читатели метаданных

Регистрация модуля чтения метаданных также включает ключи, описывающие, как читатель может быть внедрен в формат контейнера. Форматом контейнера может быть формат изображения, например TIFF или JPEG; Он также может быть другим форматом метаданных, таким как блок метаданных IFD. Собственные Поддерживаемые форматы контейнеров изображений перечислены в винкодек. idl; Каждый формат контейнера изображений определяется как GUID с именем, которое начинается с GUID \_ контаинерформат. Изначально поддерживаемые форматы контейнеров метаданных перечислены в винкодексдк. idl; Каждый формат контейнера метаданных определяется как GUID с именем, которое начинается с GUID \_ метадатаформат.

Следующие ключи регистрируют контейнер, который поддерживает модуль чтения метаданных, и данные, необходимые для чтения из этого контейнера. Каждый контейнер, поддерживаемый модулем чтения, должен быть зарегистрирован таким образом.

``` syntax
[HKEY_CLASSES_ROOT\CLSID\{Reader CLSID}\Containers\{Container GUID}\0]
"Position"=dword:00000000
"Pattern"=hex:ff,ff,ff,...
"Mask"=hex:ff,ff,ff,...
"DataOffset"=dword:00000006
```

Ключ шаблона описывает двоичный шаблон, который используется для сопоставления блока метаданных с модулем чтения. При определении шаблона для модуля чтения метаданных он должен быть достаточно надежным, что положительное соответствие означает, что читатель метаданных может понять метаданные в обрабатываемом блоке метаданных.

Ключ СМЕЩ описывает фиксированное смещение метаданных из заголовка блока. Этот ключ является необязательным и, если он не указан, означает, что фактические метаданные не могут быть найдены с помощью фиксированного смещения из заголовка блока.

### <a name="metadata-writers"></a>Записи метаданных

Регистрация модуля записи метаданных также включает ключи, описывающие, как записать заголовок перед содержимым метаданных, внедренным в формат контейнера. Как и в случае с модулем чтения, формат контейнера может быть форматом изображения или другим блоком метаданных.

Следующие ключи регистрируют контейнер, который поддерживает модуль записи метаданных, и данные, необходимые для записи заголовка и метаданных. Каждый контейнер, поддерживаемый модулем записи, должен быть зарегистрирован таким образом.

``` syntax
[HKEY_CLASSES_ROOT\CLSID\{Writer CLSID}\Containers\{Container GUID}]
"WritePosition"=dword:00000000
"WriteHeader"=hex:ff,ff,ff,...
"WriteOffset"=dword:00000000
```

Ключ Вритехеадер описывает двоичный шаблон заголовков блоков метаданных для написания. Этот двоичный шаблон совпадает с ключом шаблона считывания в формате метаданных.

Ключ Вритеоффсет описывает фиксированное смещение в заголовке блока, в котором должны быть записаны метаданные. Этот ключ является необязательным и, если он не указан, означает, что фактические метаданные не должны записываться вместе с заголовком.

### <a name="signing-a-metadata-handler"></a>Подписывание обработчика метаданных

Все обработчики метаданных должны иметь цифровую подпись для участия в процессе обнаружения WIC. Компонент WIC не будет загружать обработчик, не подписанный доверенным центром сертификации. Дополнительные сведения о цифровой подписи см. в статье [Введение в подписывание кода](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms537361(v=vs.85)).

## <a name="special-considerations"></a>Особые рекомендации

В следующих разделах содержатся дополнительные сведения, которые необходимо учитывать при создании собственных обработчиков метаданных.

### <a name="propvariants"></a>пропвариантс

Компонент WIC использует [пропвариант](/windows/win32/api/propidlbase/ns-propidlbase-propvariant) для представления элемента метаданных как для чтения, так и для записи. ПРОПВАРИАНТ предоставляет тип данных и значение данных для элемента метаданных, используемого в формате метаданных. Как средство записи обработчика метаданных, вы получаете множество гибкости в том, как данные хранятся в формате метаданных и как данные представлены в блоке метаданных. В следующей таблице приведены рекомендации по выбору подходящего типа ПРОПВАРИАНТ для использования в различных ситуациях.



| Тип метаданных —...          | Использовать тип ПРОПВАРИАНТ      | ПРОПВАРИАНТ, свойство                                                                                                                                                                                                                                                           |
|------------------------------|---------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Пустой или не существует.       | VT \_ пуст                 | Неприменимо.                                                                                                                                                                                                                                                                |
| Не определено.                   | \_большой двоичный объект VT                  | Свойство BLOB используется для установки размера и указателя на объект большого двоичного объекта, выделенный с помощью функции CoTaskMemAlloc.                                                                                                                                                                           |
| Блок метаданных.            | VT \_ Unknown               | Этот тип использует свойство Пунквал.                                                                                                                                                                                                                                           |
| Массив типов.           | VT \_ вектор \| VT \_ {Type}  | Используйте свойство CA {Type}, чтобы задать число и указатель на массив, выделенный с помощью функции CoTaskMemAlloc.                                                                                                                                                                            |
| Массив блоков метаданных. | VT \_ Векторный \| \_ вариант VT | Чтобы задать массив вариантов, используйте свойство капропвар.                                                                                                                                                                                                                       |
| Рациональное значение со знаком.     | VT \_ i8                    | Чтобы задать значение, используйте свойство Хвал. Задайте в качестве максимального слова знаменатель и нижнее слово в числителе.                                                                                                                                                                |
| Рациональное значение.            | VT \_ UI8                   | Чтобы задать значение, используйте свойство Ухвал. Задайте для Хигхпарт знаменатель и Ловпарт в числителе. Обратите внимание, что Ловпарт — это целое число без знака. Числитель должен быть преобразован из целого числа без знака в тип int, чтобы обеспечить сохранение бита знака при его наличии. |



 

Чтобы избежать избыточности в представлении элементов массива, не используйте надежные массивы. Используйте только простые массивы. Это сокращает объем работы, которую приложение должно выполнить при интерпретации типов [пропвариант](/windows/win32/api/propidlbase/ns-propidlbase-propvariant) .

Старайтесь не использовать `VT_BYREF` и хранить значения встроенным, когда это возможно. `VT_BYREF` неэффективно для небольших типов (общих для элементов метаданных) и не предоставляет сведений о размере.

Перед использованием [пропвариант](/windows/win32/api/propidlbase/ns-propidlbase-propvariant)всегда вызывайте **пропвариантинит** для инициализации значения. По завершении работы с ПРОПВАРИАНТ всегда вызывайте **пропвариантклеар** , чтобы освободить память, выделенную для переменной.

### <a name="8bim-handlers"></a>Обработчики 8BIM

При записи обработчика метаданных для блока метаданных 8BIM необходимо использовать сигнатуру, которая инкапсулирует сигнатуру 8BIM и идентификатор. Например, модуль чтения метаданных собственного 8BIMIPTC предоставляет следующие сведения о реестре для обнаружения модуля чтения:

``` syntax
[HKEY_CLASSES_ROOT\CLSID\{0010668C-0801-4DA6-A4A4-826522B6D28F}\Containers\{16100D66-8570-4BB9-B92D-FDA4B23ECE67}\0]
"Position"=dword:00000000
"Pattern"=hex:38,42,49,4d,04,04
"Mask"=hex:ff,ff,ff,ff,ff,ff
"DataOffset"=dword:00000006
```

Модуль чтения 8BIMIPTC имеет зарегистрированный шаблон 0x38, 0x42, 0x49, 0x4D, 0x04, 0x04. Первые четыре байта (0x38, 0x42, 0x49, 0x4D) являются сигнатурой 8BIM, а последние два байта (0x04, 0x04) — идентификатор записи IPTC.

Таким образом, чтобы написать средство чтения метаданных 8BIM для получения сведений о разрешении, потребуется зарегистрированный шаблон 0x38, 0x42, 0x49, 0x4D, 0x03, 0xED. Опять же, первые четыре байта (0x38, 0x42, 0x49, 0x4D) являются сигнатурой 8BIM. Последние два байта (0x03, 0xED), однако, являются ИДЕНТИФИКАТОРом сведений о разрешении, как определено в формате PSD.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

**Зрения**
</dt> <dt>

[Windows Общие сведения о компонентах обработки изображений](-wic-about-windows-imaging-codec.md)
</dt> <dt>

[Общие сведения о метаданных компонента WIC](-wic-about-metadata.md)
</dt> <dt>

[Общие сведения о языке запросов метаданных](-wic-codec-metadataquerylanguage.md)
</dt> <dt>

[Общие сведения о чтении и записи метаданных изображений](-wic-codec-readingwritingmetadata.md)
</dt> <dt>

[Пошаговое руководство. повторное кодирование изображения JPEG с помощью метаданных](-wic-codec-jpegmetadataencoding.md)
</dt> <dt>

**Другие ресурсы**
</dt> <dt>

[Написание WIC-Enabled КОДЕка](-wic-howtowriteacodec.md)
</dt> </dl>

 

 
