---
description: Реализация Ивикметадатаблоккреадер
ms.assetid: 80ad8e20-a9d4-4503-94ba-1b7699e36111
title: Реализация Ивикметадатаблоккреадер
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: dbb32ca6bf5ce0714c06a6f355c319908c6dd3a61b1ac27f6baf13f6285183ba
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119772264"
---
# <a name="implementing-iwicmetadatablockreader"></a>Реализация Ивикметадатаблоккреадер

## <a name="iwicmetadatablockreader"></a>ивикметадатаблоккреадер

В образе часто существует несколько блоков метаданных, каждый из которых предоставляет различные типы данных в различных форматах. в модели компонента обработки изображений Windows (WIC) обработчики метаданных — это отдельные компоненты, которые, как и декодеры, обнаруживаются во время выполнения. Каждый формат метаданных имеет отдельный обработчик, и каждый из этих обработчиков метаданных можно использовать с любым форматом изображения, поддерживающим формат метаданных, который он обрабатывает. Таким образом, если формат изображения поддерживает EXIF, XMP, IPTC или другой формат, можно воспользоваться стандартными обработчиками метаданных для этих форматов, поставляемых с WIC, и вам не нужно писать собственный. Конечно, при создании нового формата метаданных необходимо написать для него обработчик метаданных, который будет обнаружен и вызван во время выполнения точно так же, как стандартные.

> [!Note]  
> Если формат изображения основан на формате TIFF или в контейнере JPEG, то не нужно писать какие-либо обработчики метаданных (если не разработать новый или собственный формат метаданных). В контейнерах TIFF и JPEG блоки метаданных находятся в IFD, а каждый контейнер имеет отдельную структуру IFD. WIC предоставляет обработчики IFD для обоих форматов контейнеров, которые переходят по структуре IFD и делегируют стандартные обработчики метаданных для доступа к метаданным в них. Таким образом, если ваш формат изображения основан на любом из этих контейнеров, можно автоматически воспользоваться преимуществами обработчиков WIC IFD. Однако если у вас есть собственный формат контейнера, имеющий собственную уникальную структуру метаданных верхнего уровня, необходимо написать обработчик, который может перемещаться по структуре верхнего уровня и делегировать их соответствующим обработчикам метаданных, как и обработчики IFD.)

 

Аналогичным образом WIC предоставляет уровень абстракции для приложений, которые позволяют им работать со всеми форматами изображений таким же образом через согласованный набор интерфейсов, WIC обеспечивает уровень абстракции для авторов кодеков в отношении форматов метаданных. Как отмечалось ранее, авторы кодека, как правило, не нуждаются в непосредственной работе с различными форматами метаданных, которые могут присутствовать в образе. Однако каждый автор кодека отвечает за предоставление способа перечисления блоков метаданных, чтобы можно было обнаружить и создать для каждого блока соответствующий обработчик метаданных.

Этот интерфейс необходимо реализовать в классе декодирования на уровне кадров. Также может потребоваться реализовать его на классе декодера уровня контейнера, если формат изображения предоставляет глобальные метаданные за пределами отдельных кадров изображения.

``` syntax
interface IWICMetadataBlockReader : IUnknown
{
   // All methods required
   HRESULT GetContainerFormat ( GUID *pguidContainerFormat );
   HRESULT GetCount ( UINT *pcCount );
   HRESULT GetEnumerator ( IEnumUnknown **ppIEnumMetadata );
   HRESULT GetReaderByIndex ( UINT nIndex, IWICMetadataReader **ppIMetadataReader );
}
```

-   [жетконтаинерформат](#getcontainerformat)
-   [GetCount](#getcount)
-   [GetEnumerator](#getenumerator)
-   [жетреадербиндекс](#getreaderbyindex)

### <a name="getcontainerformat"></a>жетконтаинерформат

[**Жетконтаинерформат**](/windows/desktop/api/Wincodecsdk/nf-wincodecsdk-iwicmetadatablockreader-getcontainerformat) совпадает с методом [Жетконтаинерформат](-wic-imp-iwicbitmapdecoder.md) для [реализации ивикбитмапдекодер](-wic-imp-iwicbitmapdecoder.md).

### <a name="getcount"></a>GetCount

Функция [**NOCOUNT**](/windows/desktop/api/Wincodecsdk/nf-wincodecsdk-iwicmetadatablockreader-getcount) возвращает количество блоков метаданных верхнего уровня, связанных с кадром.

### <a name="getenumerator"></a>GetEnumerator

[**GetEnumerator**](/windows/desktop/api/Wincodecsdk/nf-wincodecsdk-iwicmetadatablockreader-getenumerator) Возвращает перечислитель, который вызывающий может использовать для перечисления блоков метаданных в кадре и чтения их метаданных. Чтобы реализовать этот метод, необходимо создать модуль чтения метаданных для каждого блока метаданных и реализовать объект перечисления, который перечисляет коллекцию модулей чтения метаданных. Объект перечисления должен реализовывать [иенумункновн](/windows/win32/api/objidlbase/nn-objidlbase-ienumunknown) , чтобы его можно было привести к иенумункновн при возврате в параметр *ппиенумметадата* .

При реализации объекта перечисления можно создать все средства чтения метаданных при первом создании объекта [**ивикметадатаблоккреадер**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicmetadatablockreader) или при создании объекта перечисления, или же вы можете создать их неактивно внутри реализации метода [Иенумункновн:: Next](/windows/win32/api/objidlbase/nf-objidlbase-ienumunknown-next) . Во многих случаях более эффективно создавать их с отложенным созданием, но в следующем примере все средства чтения блокировок создаются в конструкторе для экономии пространства.


```C++
public class MetadataReaderEnumerator : public IEnumUnknown
{
   UINT m_current;
   UINT m_blockCount;
   IWICMetadataReader** m_ppMetadataReader;
   IStream* m_pStream;

   MetadataReaderEnumerator() 
   {
       // Set m_blockCount to the number of metadata blocks in the frame. 
      ...
      m_ppMetadataReader = IWICMetadataReader*[m_blockCount];
       m_current = 0;

      for (UINT x=0; x < m_blockCount; x++) 
      {
         // Find the position in the file where the xth
         // block of metadata lives and seek m_piStream 
         // to that position.
         ...

         m_pComponentFactory->CreateMetadataReaderFromContainer(
            GUID_ContainerFormatTiff,
                        NULL,
                        WICPersistOptions.WICPersistOptionsDefault | 
            WICMetadataCreationOptions.WICMetadataCreationDefault, 
                        m_pStream, &m_ppMetadataReader[x]);
        }
    }

    // Implementation of IEnumUnknown and IUnknown interfaces
    ...
}
```



Для создания модулей чтения метаданных используется метод [**креатеметадатареадерфромконтаинер**](/windows/desktop/api/Wincodecsdk/nf-wincodecsdk-iwiccomponentfactory-createmetadatareaderfromcontainer) . При вызове этого метода вы передаете идентификатор GUID формата контейнера в параметре *гуидконтаинерформат* . Если у вас есть предпочтение поставщика для читателя метаданных, можно передать идентификатор GUID предпочтительного поставщика в параметре *пгуидвендор* . Например, если компания записывает обработчики метаданных и вы хотите использовать собственный при наличии, можно передать идентификатор GUID поставщика. В большинстве случаев необходимо просто передать **значение NULL** и позволить системе выбрать соответствующий модуль чтения метаданных. Если вы запрашиваете конкретного поставщика и у него есть средство чтения метаданных на компьютере, то компонент WIC возвратит читателя этого поставщика. Однако если запрошенному поставщику не назначен модуль чтения метаданных на компьютере и имеется соответствующий модуль чтения метаданных, этот модуль чтения будет возвращен, даже если он не является предпочтительным поставщиком. Если на компьютере нет средства чтения метаданных для типа метаданных в блоке, фабрика компонентов вернет неизвестный обработчик метаданных, который будет обрабатывать блок метаданных как большой двоичный объект (BLOB) и десериализовать блок метаданных из файла без каких-либо попыток их синтаксического анализа.

Для параметра *двоптионс* выполните операцию или между соответствующим [**Викперсистоптионс**](/windows/desktop/api/Wincodecsdk/ne-wincodecsdk-wicpersistoptions) с соответствующим [**викметадатакреатионоптионс**](/windows/desktop/api/Wincodecsdk/ne-wincodecsdk-wicmetadatacreationoptions). **Викперсистоптионс** описывает, как располагается контейнер. По умолчанию используется прямой порядок байтов.

``` syntax
enum WICPersistOptions
{   
   WICPersistOptionDefault,
   WICPersistOptionLittleEndian,
   WICPersistOptionBigEndian,
   WICPersistOptionStrictFormat,
   WICPersistOptionNoCacheStream,
   WICPersistOptionPreferUTF8
};
```

[**Викметадатакреатионоптионс**](/windows/desktop/api/Wincodecsdk/ne-wincodecsdk-wicmetadatacreationoptions) укажите, нужно ли вернуть ункновнметадатахандлер, если на компьютере не найден модуль чтения метаданных, который может считывать формат метаданных определенного блока. **Викметадатакреатионалловункновн** используется по умолчанию, и всегда следует разрешать создание ункновнметадтатахандлер. Ункновнметадатахандлер обрабатывает нераспознанные метаданные как большой двоичный объект. Он не может выполнить синтаксический анализ, но он записывает его в поток как большой двоичный объект и сохраняет его без изменений при обратной записи в поток во время кодирования. Это позволяет обезопасить создание обработчиков метаданных для собственных метаданных или форматов метаданных, которые не поставляются с системой. Так как метаданные сохраняются без изменений, даже если на компьютере, который его распознает, нет обработчика, то при последующей установке соответствующего обработчика метаданных метаданные по-прежнему будут доступны для чтения. Если вы не разрешаете создание Ункновнметадатахандлер, альтернативой является отмена или перезапись нераспознанных метаданных. Это форма потери данных.

> [!Note]  
> При написании собственного обработчика метаданных для частных метаданных никогда не следует включать ссылки на что-либо за пределы самого блока метаданных. Несмотря на то, что Ункновнметадатахандлер сохраняет метаданные без изменений, метаданные перемещаются при редактировании файлов, а все ссылки на что-либо за пределами собственного блока больше не будут действительными в этом случае.

 

``` syntax
enum WICMetadataCreationOptions
{
   WICMetadataCreationDefault = 0x00000000,
   WICMetadataCreationAllowUnknown = WICMetadataCreationDefault,
   WICMetadataCreationFailUnknown = 0x00010000,
   WICMetadataCreationMask = 0xFFFF0000
};
```

Параметр *пистреам* — это фактический поток, декодированный. Перед передачей в поток следует перейти к началу блока метаданных, для которого запрашивается читатель. Соответствующий модуль чтения метаданных для блока метаданных в текущей позиции в [IStream](/windows/desktop/api/objidl/nn-objidl-istream) будет возвращен в параметре *ппиреадер* .

### <a name="getreaderbyindex"></a>жетреадербиндекс

[**Жетреадербиндекс**](/windows/desktop/api/Wincodecsdk/nf-wincodecsdk-iwicmetadatablockreader-getreaderbyindex) возвращает модуль чтения метаданных по запрошенному индексу в коллекции.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

**Reference**
</dt> <dt>

[**ивикметадатаблоккреадер**](/windows/desktop/api/Wincodecsdk/nn-wincodecsdk-iwicmetadatablockreader)
</dt> <dt>

**Зрения**
</dt> <dt>

[Реализация IWICBitmapFrameDecode](-wic-imp-iwicbitmapframedecode.md)
</dt> <dt>

[Реализация Ивикбитмапсаурцетрансформ](-wic-imp-iwicbitmapsourcetransform.md)
</dt> <dt>

[Написание WIC-Enabled КОДЕка](-wic-howtowriteacodec.md)
</dt> <dt>

[Windows Общие сведения о компонентах обработки изображений](-wic-about-windows-imaging-codec.md)
</dt> </dl>

 

 
