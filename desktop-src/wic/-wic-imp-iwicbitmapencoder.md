---
description: Реализация Ивикбитмапенкодер
ms.assetid: b671e941-ded6-4bde-bc4d-461f13feade0
title: Реализация Ивикбитмапенкодер
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 69d02105470f837dba0689b665473c01c42f6cd6497a85424ea6eea3371696f3
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119088016"
---
# <a name="implementing-iwicbitmapencoder"></a>Реализация Ивикбитмапенкодер

-   [ивикбитмапенкодер](#implementing-iwicbitmapencoder)
    -   [Инициализация](#initialize)
    -   [жетконтаинерформат](#getcontainerformat)
    -   [жетенкодеринфо](#getencoderinfo)
    -   [CreateNewFrame](#createnewframe)
    -   [Фиксация](#commit)
    -   [сетпревиев](#setpreview)
-   [Связанные темы](#related-topics)

## <a name="iwicbitmapencoder"></a>ивикбитмапенкодер

-   [Инициализация](#initialize)
-   [жетконтаинерформат](#getcontainerformat)
-   [жетенкодеринфо](#getencoderinfo)
-   [CreateNewFrame](#createnewframe)
-   [Фиксация](#commit)
-   [сетпревиев](#setpreview)

Этот интерфейс является аналогом интерфейса [**ивикбитмапдекодер**](/windows/desktop/api/Wincodec/nn-wincodec-iwicbitmapdecoder) и является отправной точкой для кодирования файла изображения. Так же как **ивикбитмапдекодер** используется для получения свойств уровня контейнера и отдельных кадров из контейнера Image, [**ивикбитмапенкодер**](/windows/desktop/api/wincodec/nn-wincodec-iwicbitmapencoder) используется для установки свойств уровня контейнера и сериализации отдельных кадров изображения в контейнер. Этот интерфейс реализуется в классе кодировщика уровня контейнера.

``` syntax
interface IWICBitmapEncoder : public IUnknown
{
   // Required methods
   HRESULT Initialize ( IStream *pIStream,
              WICBitmapEncoderCacheOption cacheOption );
   HRESULT GetContainerFormat ( GUID *pguidContainerFormat );
   HRESULT GetEncoderInfo ( IWICBitmapEncoderInfo **pIEncoderInfo );
   HRESULT CreateNewFrame ( IWICBitmapFrameEncode **ppIFrameEncode,
              IPropertyBag2 **ppIEncoderOptions );
   HRESULT Commit ( void );

   // Optional methods
   HRESULT SetPreview ( IWICBitmapSource *pIPreview );
   HRESULT SetThumbnail ( IWICBitmapSource *pIThumbnail );
   HRESULT SetColorContexts ( UINT cCount,
              IWICColorContext **ppIColorContext );
   HRESULT GetMetadataQueryWriter ( IWICMetadataQueryWriter 
              **ppIMetadataQueryWriter );
   HRESULT SetPalette ( IWICPalette *pIPalette);
};
```

Как обсуждалось в разделе [Реализация ивикбитмапдекодер](-wic-imp-iwicbitmapdecoder.md), некоторые форматы изображений имеют глобальные эскизы, цветовые контексты или метаданные, а многие форматы изображений предоставляют их только для каждого фрейма. Поэтому методы для их установки являются необязательными для [**ивикбитмапенкодер**](/windows/desktop/api/wincodec/nn-wincodec-iwicbitmapencoder), но требуются для [**ивикбитмапфраминкоде**](/windows/desktop/api/Wincodec/nn-wincodec-iwicbitmapframeencode). Мы обсудим методы, которые являются необязательными в **ивикбитмапенкодер** в разделе **ивикбитмапфраминкоде**, где они чаще всего реализуются.

Если глобальные эскизы не поддерживаются, возвратите ВИНКОДЕК \_ Err \_ кодекносумбнаил из метода Сетсумбнаил в [**ивикбитмапенкодер**](/windows/desktop/api/wincodec/nn-wincodec-iwicbitmapencoder). Если вы не поддерживаете палитру уровня контейнера или если закодированное изображение не имеет индексированного формата, то возвратите ВИНКОДЕК \_ Err \_ палеттеунаваилабле из метода сетпалетте. Для любых других неподдерживаемых методов следует возвращать ВИНКОДЕК \_ Err \_ унсуппортедоператион.

### <a name="initialize"></a>Инициализация

[**Initialize**](/windows/desktop/api/Wincodec/nf-wincodec-iwicbitmapencoder-initialize) — это первый метод, вызываемый в [**ивикбитмапенкодер**](/windows/desktop/api/wincodec/nn-wincodec-iwicbitmapencoder) после создания экземпляра. Поток изображения передается кодировщику, и вызывающий объект может дополнительно указать параметр кэширования. В случае декодера поток доступен только для чтения, но поток, передаваемый кодировщику, является записываемым потоком, в который кодировщик будет выполнять сериализацию всех данных и метаданных изображения. Параметры кэша в кодировщике также отличаются.

``` syntax
enum WICBitmapEncoderCacheOption
{
   WICBitmapEncoderCacheInMemory,
   WICBitmapEncoderCacheTempFile,
   WICBitmapEncoderNoCache
}
```

Приложение может запросить кодировщик для кэширования данных изображения в памяти, кэшировать его во временном файле или записать непосредственно в файл диска без кэширования. При появлении запроса на кэширование данных во временном файле кодировщик должен создать временный файл на диске и выполнить запись непосредственно в этот файл без кэширования в памяти. Когда вызывающий объект выбирает параметр без кэширования, каждый кадр должен быть зафиксирован по порядку, прежде чем можно будет создать следующий кадр.

### <a name="getcontainerformat"></a>жетконтаинерформат

[**Жетконтаинерформат**](/windows/desktop/api/Wincodec/nf-wincodec-iwicbitmapencoder-getcontainerformat) реализуется так же, как метод [Жетконтаинерформат](-wic-imp-iwicbitmapdecoder.md) в [реализации ивикбитмапдекодер](-wic-imp-iwicbitmapdecoder.md).

### <a name="getencoderinfo"></a>жетенкодеринфо

[**Жетенкодеринфо**](/windows/desktop/api/Wincodec/nf-wincodec-iwicbitmapencoder-getencoderinfo) возвращает объект [**ивикбитмапенкодеринфо**](/windows/desktop/api/Wincodec/nn-wincodec-iwicbitmapencoderinfo) . Чтобы получить объект **ивикбитмапенкодеринфо** , просто передайте идентификатор GUID кодировщика в метод [**креатекомпонентинфо**](/windows/desktop/api/Wincodec/nf-wincodec-iwicimagingfactory-createcomponentinfo) в [**IWICImagingFactory**](/windows/desktop/api/Wincodec/nn-wincodec-iwicimagingfactory), а затем запросите в нем интерфейс **ивикбитмапенкодеринфо** .

См. пример в разделе [Реализация ивикбитмапдекодер](-wic-imp-iwicbitmapdecoder.md) в [жетдекодеринфо](-wic-imp-iwicbitmapdecoder.md).

### <a name="createnewframe"></a>CreateNewFrame

[**CreateNewFrame**](/windows/desktop/api/Wincodec/nf-wincodec-iwicbitmapencoder-createnewframe) является аналогом [**noframes**](/windows/desktop/api/Wincodec/nf-wincodec-iwicbitmapdecoder-getframe) в [**ивикбитмапдекодер**](/windows/desktop/api/Wincodec/nn-wincodec-iwicbitmapdecoder). Этот метод возвращает объект [**ивикбитмапфраминкоде**](/windows/desktop/api/Wincodec/nn-wincodec-iwicbitmapframeencode) , который представляет собой объект, который фактически сериализует данные изображения для определенного кадра в контейнере.

одним из преимуществ компонента обработки изображений Windows (WIC) является то, что он предоставляет уровень абстракции для приложений, которые позволяют им работать со всеми форматами изображений одинаковым образом. Однако не все форматы изображений одинаковы. Некоторые форматы изображений имеют возможности, которые у других пользователей нет. Чтобы приложения могли воспользоваться преимуществами этих уникальных возможностей, необходимо предоставить кодеку способ их предоставления. Это назначение параметров кодировщика. Если кодек поддерживает любые параметры кодировщика, следует создать объект [IPropertyBag2](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/aa768192(v=vs.85)) , предоставляющий Поддерживаемые параметры кодировщика, и вернуть его в параметр *ппиенкодероптионс* этого метода. Затем вызывающий может использовать этот объект IPropertyBag2, чтобы определить, какие параметры кодировщика поддерживает кодек. Если вызывающий объект хочет указать значения для любого из поддерживаемых параметров кодировщика, он присвоит значение соответствующему свойству в объекте IPropertyBag2 и передаст его в созданный объект [**ивикбитмапфраминкоде**](/windows/desktop/api/Wincodec/nn-wincodec-iwicbitmapframeencode) в его методе Initialize.

Чтобы создать экземпляр объекта [IPropertyBag2](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/aa768192(v=vs.85)) , необходимо сначала создать структуру PROPBAG2, чтобы указать каждый параметр кодировщика, поддерживаемый кодировщиком, и его тип данных для каждого свойства. Затем необходимо реализовать объект IPropertyBag2, который применяет диапазоны значений для каждого свойства при записи и согласовывает любые конфликтующие или перекрывающиеся значения. Для простых наборов неконфликтующих параметров кодировщика можно вызвать метод [**креатинкодерпропертибаг**](/windows/desktop/api/Wincodecsdk/nf-wincodecsdk-iwiccomponentfactory-createencoderpropertybag) , который создаст простой объект IPropertyBag2, используя свойства, указанные в структуре PROPBAG2. По-прежнему необходимо применять диапазоны значений. Для более сложных вариантов кодировщика или при необходимости согласования конфликтующих значений следует написать собственную реализацию IPropertyBag2.


```C++
UINT cuiPropertyCount = 0;
IPropertyBag2* pPropertyBag = NULL;
PROPBAG2* pPropBagOptions;
HRESULT hr;

// Insert code here to initialize piPropertyBag with the 
// supported options for your encoder, and to initialize 
// cuiPropertyCount to the number of encoder option properties
// you are exposing.
...

hr = pComponentFactory->CreateEncoderPropertyBag( 
   pPropBagOptions, cuiPropertyCount, &pPropertyBag);
```



Компонент WIC предоставляет небольшой набор стандартных параметров кодировщика, используемых некоторыми распространенными форматами изображений. Все канонические параметры кодировщика являются необязательными, и кодеки не обязательно должны поддерживать их. Причина, по которой они предоставляются как канонические параметры, заключается в том, что многие приложения предоставляют пользователям пользовательский интерфейс для указания этих параметров при сохранении файла изображения в формате, который их поддерживает. Предоставление канонического способа указания этих параметров упрощает для приложений передачу их кодировщикам согласованным образом. Параметры канонического кодировщика перечислены в следующей таблице.



| Параметр кодировщика     | VARTYPE  | Диапазон значений:               |
|--------------------|----------|---------------------------|
| Lossless           | Логическое значение VT \_ | Истина/ложь                |
| ImageQuality       | VT \_ R4   | 0.0 – 1,0                   |
| CompressionQuality | VT \_ R4   | 0.0 – 1,0                   |
| битмаптрансформ    | VT \_ UI1  | викбитмаптрансформоптионс |



 

Если кодек поддерживает кодирование без потерь, следует использовать параметр кодировщика без потерь, чтобы приложения запрашивают, что образ будет кодироваться без потерь. Если вызывающий объект устанавливает для этого свойства значение true, следует игнорировать параметр Имажекуалити и кодировать изображение без потерь.

Параметр Имажекуалити позволяет приложению указать степень точности, с которой будет кодироваться изображение. Этот параметр позволяет пользователю установить компромисс между качеством изображения и скоростью и (или) размером файла. JPEG — это пример формата изображения, поддерживающего это компромисс. Значение 0,0 указывает, что качество имеет низкую важность, а кодировщик должен использовать его самый новый алгоритм потери данных. Значение 1,0 указывает, что наиболее важной является точность, и кодировщик должен сохранить максимально возможную точность. (В зависимости от кодека это может быть синонимом параметра без потерь. Однако если кодек поддерживает кодирование без потерь, а параметр без потерь имеет значение true, параметр Имажекуалити следует игнорировать.)

Параметр Компрессионкуалити позволяет приложению указать эффективность сжатия для использования при кодировании изображения. Очень эффективный алгоритм может создать файл изображения меньшего размера с тем же качеством, что и менее эффективный алгоритм сжатия, но кодирование может занять больше времени. Этот параметр позволяет пользователю задать компромисс между размером файла и скоростью кодирования, сохраняя тот же уровень качества. TIFF — это пример формата изображения, поддерживающего такое компромиссное соотношение. (Обратите внимание, что формат JPEG поддерживает различные уровни сжатия, но более высокая скорость сжатия приводит к более низкому качеству изображения. Поэтому формат изображения JPEG будет предоставлять параметр Имажекуалити, а не параметр Компрессионкуалити.) Значение 0,0 для этого параметра указывает, что следует как можно быстрее сжимать образ без снижения точности, за счет увеличения размера файла. Значение 1,0 указывает, что следует создать наименьший возможный размер файла (с тем же уровнем качества), независимо от того, сколько времени может потребоваться для его кодирования. Кодек может поддерживать как параметр Имажекуалити, так и параметр Компрессионкуалити, где параметр Имажекуалити задает приемлемую степень потери, а параметр Компрессионкуалити обеспечивает компромисс по размеру и скорости на указанном уровне качества.

Параметр Битмаптрансформ позволяет вызывающему объекту указать угол поворота или вертикальную или горизонтальную ориентацию при кодировании. Перечисление Викбитмаптрансформоптионс, используемое для указания запрошенного преобразования, — это то же перечисление, которое используется при запросе преобразования во время декодирования через интерфейс Ивикбитмапсаурцетрансформ.

Обратите внимание, что кодировщики не ограничиваются стандартными параметрами кодировщика. Назначение параметров кодировщика заключается в том, чтобы позволить кодировщикам предоставлять свои возможности, а также не ограничивать типы возможностей, которые можно предоставлять. Убедитесь, что параметры кодировщика хорошо документированы. Несмотря на то, что приложение может использовать контейнер свойств, возвращаемый этим методом для обнаружения имен, типов и диапазонов значений для поддерживаемых параметров, единственный способ найти их значения или как предоставить их в пользовательском интерфейсе — из вашей документации.

### <a name="commit"></a>Commit

[**Commit**](/windows/desktop/api/Wincodec/nf-wincodec-iwicbitmapencoder-commit) — это метод, который вызывается после сериализации всех данных изображения и метаданных в поток. Этот метод следует использовать для сериализации данных предварительного просмотра изображения в поток и всех глобальных эскизов, метаданных, палитры или других элементов, если применимо. Этот метод не должен закрывать файловый поток, так как ожидается, что приложение, открывшие поток, закроет его.

В разделе метода Ивикбитмапфраминкоде: Commit содержатся подробные сведения о влиянии Ивикбитмапенкодеркачеоптионс на поведение этого метода.

### <a name="setpreview"></a>сетпревиев

[**Сетпревиев**](/windows/desktop/api/Wincodec/nf-wincodec-iwicbitmapencoder-setpreview) используется для создания предварительной версии изображения. Хотя для каждого образа Предварительная версия не является обязательной, настоятельно рекомендуется использовать его. Современные цифровые камеры и сканеры создают высококачественные образы, которые, как правило, очень велики, и, следовательно, принимают значительное время обработки для декодирования. Изображения, создаваемые камерами следующего поколения, будут еще больше. Рекомендуется предоставлять более низкую версию изображения с низким разрешением, обычно в формате JPEG, которую можно быстро декодировать и отображать мгновенно, когда пользователь запросит его. Приложение может запросить предварительную версию перед запросом на декодирование действительного образа, чтобы обеспечить лучшую работу для пользователей, и отобразить их представление размера экрана, сэйаре в ожидании декодирования фактического изображения. Хотя кодеки должны предоставлять предварительные версии, кодеки, не поддерживающие [**ивикбитмапсаурцетрансформ**](/windows/desktop/api/Wincodec/nn-wincodec-iwicbitmapsourcetransform) , должны в определенном времени делать это.

Если вы предписываете предварительный просмотр JPEG, вам не нужно писать кодировщик JPEG для его кодирования. Необходимо делегировать кодировщику JPEG, который поставляется с платформой WIC, для кодирования как предварительных, так и эскизов.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

**Reference**
</dt> <dt>

[**ивикбитмапенкодер**](/windows/desktop/api/wincodec/nn-wincodec-iwicbitmapencoder)
</dt> <dt>

[**ивикбитмапфраминкоде**](/windows/desktop/api/Wincodec/nn-wincodec-iwicbitmapframeencode)
</dt> <dt>

**Зрения**
</dt> <dt>

[Интерфейсы кодировщика](-wic-encoderinterfaces.md)
</dt> <dt>

[Реализация Ивикбитмапкодекпрогресснотификатион (кодировщик)](-wic-imp-iwicbitmapcodecprogressnotification-encoder.md)
</dt> <dt>

[Написание WIC-Enabled КОДЕка](-wic-howtowriteacodec.md)
</dt> <dt>

[Windows Общие сведения о компонентах обработки изображений](-wic-about-windows-imaging-codec.md)
</dt> </dl>

 

 
