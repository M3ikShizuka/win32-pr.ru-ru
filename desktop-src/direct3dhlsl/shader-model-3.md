---
title: Модель шейдера 3 (Справочник по HLSL)
description: Шейдеры вершин и шейдеры пикселей значительно упрощаются благодаря более ранним версиям шейдеров.
ms.assetid: 01ac85cb-b309-4169-acc2-320a929b65cb
ms.topic: article
ms.date: 05/31/2018
topic_type:
- kbArticle
api_name: ''
api_type: ''
api_location: ''
ms.openlocfilehash: 2d87c791694e91de135052b4172e3bd5f55577d7
ms.sourcegitcommit: d75fc10b9f0825bbe5ce5045c90d4045e3c53243
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2021
ms.locfileid: "127573674"
---
# <a name="shader-model-3-hlsl-reference"></a>Модель шейдера 3 (Справочник по HLSL)

Шейдеры вершин и шейдеры пикселей значительно упрощаются благодаря более ранним версиям шейдеров. Если вы реализуете шейдеры на оборудовании, вы не можете использовать VS \_ 3 \_ 0 или PS \_ 3 \_ 0 с другими версиями шейдеров, и вы не можете использовать любой тип шейдера с фиксированным конвейером функций. Эти изменения делают возможным упрощение драйверов и среды выполнения. Единственное исключение заключается в том, что только программные \_ \_ шейдеры VS 3 0 можно использовать с любой версией построителя текстуры. Кроме того, если вы используете только программный \_ шейдер VS 3 \_ 0 с предыдущей версией шейдера пикселей, шейдер вершин может использовать только семантику вывода, совместимую с кодами гибких форматов ВЕРШИН (фвф).

Семантика, используемая в выходных данных шейдера вершин, должна использоваться для входных шейдеров пикселей. Семантика используется для сопоставления выходных данных шейдера вершин с входными шейдерами пикселей, аналогично тому, как объявление вершины сопоставляется с входными регистрами вершинного шейдера и предыдущими моделями шейдеров. См. раздел семантика соответствия для шейдеров VS 3,0 и PS 3,0.

Добавлены новые режимы рендеринга, которые охватывают возможность дополнительных координат текстуры в этой новой схеме. Атрибуты с D3DDECLUSAGE \_ текскурд и индексом использования от 0 до 15 интерполируются в режиме переноса при установке соответствующего [**D3DRS \_ Wrap \***](/windows/desktop/direct3d9/d3drenderstatetype) .

-   [Компоненты модели шейдера вершин 3](#vertex-shader-model-3-features)
-   [Компоненты модели шейдера пикселей 3](#pixel-shader-model-3-features)
-   [Семантика соответствия для \_ \_ шейдеров VS 3 0 и PS \_ 3 \_ 0](/windows)
-   [Изменения в режиме тумана, глубины и затенения](#fog-depth-and-shading-mode-changes)
-   [Преобразования с плавающей запятой и целых чисел](#floating-point-and-integer-conversions)
-   [Указание полной или частичной точности](#specifying-full-or-partial-precision)
-   [Программная вершина и шейдеры пикселей](#software-vertex-and-pixel-shaders)

## <a name="vertex-shader-model-3-features"></a>Компоненты модели шейдера вершин 3

Типы регистрации выходных шейдеров вершин свернуты в двенадцать регистров (см. раздел [выходные регистры](dx9-graphics-reference-asm-vs-registers-output.md)). Все используемые регистры должны быть объявлены с помощью инструкции [дкл](dcl-usage---ps.md) и семантики (например, дкл \_ color0 O0. ксизв).

3 \_ 0. модель шейдера вершин (VS \_ 3 0 \_ ) расширяет возможности VS \_ 2 \_ 0 с более мощным индексированием регистров, набором упрощенных выходных регистров, возможностью выборки текстуры в шейдере вершин и возможность управлять скоростью, с которой инициализируются входные шейдеры.

### <a name="index-any-register"></a>Индекс любого регистра

Все регистры ( [входные](dx9-graphics-reference-asm-vs-registers-input.md) и [выходные регистры](dx9-graphics-reference-asm-vs-registers-output.md)) можно индексировать с помощью [регистра счетчика циклов](dx9-graphics-reference-asm-vs-registers-loop-counter.md) (в более ранних версиях могут индексироваться только постоянные регистры).

Перед индексированием необходимо объявить входные и выходные регистры. Однако вы не можете индексировать выходные регистры, которые были объявлены с семантикой позиции или размера точки. Фактически, если используется индексирование, то семантика позиционирования и псизе должны быть объявлены в регистрах O0 и O1 соответственно.

Вы можете индексировать только непрерывный диапазон регистров. Это значит, что нельзя индексировать по регистрам, которые не были объявлены. Хотя это ограничение может оказаться неудобным, оно позволяет выполнять аппаратную оптимизацию. Попытка индексирования по несмежным регистрам приведет к неопределенному результату. Проверка шейдера не применяет это ограничение.

### <a name="simplify-output-registers"></a>Упрощение выходных регистров

Все различные типы выходных регистров свернуты в двенадцать выходных регистров: 1 для позиции, 2 для цвета, 8 для текстуры и 1 для тумана или кегля. Эти регистры будут интерполируются все данные, которые они содержат, для шейдера пикселей. Объявления регистров выходных данных являются обязательными, и семантика назначается каждой ККМ.

Регистры можно разделить следующим образом:

-   По крайней мере один регистр должен быть объявлен как регистр позиции с четырьмя компонентами. Это единственный обязательный регистр шейдера вершин.
-   Первые десять регистров, потребляемых шейдером, могут использовать не более четырех компонентов (ксизв).
-   Последний (или двенадцатый) регистр может содержать только скаляр (например, размер точки).

Список регистров см. в разделе [регистры-VS \_ 3 \_ 0](dx9-graphics-reference-asm-vs-registers-vs-3-0.md).

### <a name="texture-sample-in-a-vertex-shader"></a>Пример текстуры в шейдере вершин

Вершинный шейдер 3 \_ 0 поддерживает поиск текстур в шейдере вершин с помощью [текслдл-VS](texldl---vs.md).

## <a name="pixel-shader-model-3-features"></a>Компоненты модели шейдера пикселей 3

В десять входных регистров был свернут цвет шейдера пикселей и регистры текстур (см. раздел [типы входных регистров](dx9-graphics-reference-asm-ps-registers-ps-3-0.md)). Регистрация лица является скалярной регистром с плавающей запятой. Допустим только знак этого регистра. Если знак является отрицательным, примитив является обратным лицом. Это можно использовать внутри шейдера пикселей для достижения двустороннего освещения, например. Регистр позиций ссылается на текущие (x, y) Пиксели.

Регистры констант шейдера можно задать с помощью:

-   [**сетпикселшадерконстантб**](/windows/desktop/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-setpixelshaderconstantb)
-   [**сетпикселшадерконстанти**](/windows/desktop/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-setpixelshaderconstanti)
-   [**сетпикселшадерконстантф**](/windows/desktop/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-setpixelshaderconstantf)

## <a name="match-semantics-on-vs_3_0-and-ps_3_0-shaders"></a>Семантика соответствия для \_ \_ шейдеров VS 3 0 и PS \_ 3 \_ 0

Существуют некоторые ограничения на семантическое использование с VS \_ 3 \_ 0 и PS \_ 3 \_ 0. В общем случае необходимо соблюдать осторожность при использовании семантики для входных шейдеров, которые соответствуют семантике, используемой в выходных данных шейдера.

Например, шейдер пикселей упаковывает несколько имен в один регистр:


```
ps_3_0 
dcl_texcoord0 v0.x 
dcl_texcoord1 v0.yz // Valid to pack multiple names into one register 
dcl_texcoord2_centroid v1.w
...
```



Каждый регистр имеет разную семантику. Обратите внимание, что можно также указать имя v0. x и v0. из с разной семантикой (несколько) из-за использования маски записи.

При наличии шейдера пикселей следующий \_ шейдер VS 3 \_ 0 не может быть связан с ним:


```
vs_3_0 
... 
dcl_texcoord0 o5.x 
dcl_texcoord1 o6.yzw 
...
```



Эти два шейдера конфликтуют с использованием семантики [**D3DDECLUSAGE \_ TEXCOORD0**](/windows/desktop/direct3d9/d3ddeclusage) и **D3DDECLUSAGE \_ TEXCOORD1** .

Перепишите шейдер вершин следующим образом, чтобы избежать семантического конфликта.


```
vs_3_0 
... 
dcl_texcoord2 o3 
dcl_texcoord3 o9 
...
```



Аналогично, семантическое имя, объявленное в разных входных регистрах в шейдере пикселей (v0 и v1 в построителе пикселей), не может использоваться в одном выходном регистре в этом шейдере вершин. Например, этот шейдер вершин не может быть сопряжен с шейдером Pixel Shader, так как D3DDECLUSAGE \_ TEXCOORD1 используется для входных регистров шейдера пикселей (v0, v1) и в выходной регистр шейдера вершин — O3.


```
vs_3_0 
... 
dcl_texcoord0 o3.x 
dcl_texcoord1 o3.yz 

dcl_texcoord2 o3.w // BAD! Would be valid if this were not o3 
dcl_texcoord3 o9 ... 
```



С другой стороны, шейдер вершин не может быть сопряжен с шейдером пикселей, так как выходная маска для параметра с заданной семантикой не предоставляет данные, запрашиваемые шейдером пикселей:


```
vs_3_0 
... 
dcl_texcoord0 o5.x 
dcl_texcoord1 o5.yzw 
dcl_texcoord2 o7.yz // BAD! Would be valid if w were included 
dcl_texcoord3 o9 
... 
```



Этот шейдер вершин не предоставляет выходные данные с одним из семантических имен, запрошенных шейдером пикселей, поэтому связывание шейдера является недопустимым:


```
vs_3_0 
... 
dcl_texcoord0 o5.x 
dcl_texcoord1 o5.yzw 
dcl_texcoord3 o9 
// The pixel shader wants texcoord2, with a w component, 
// but it isn't output by this vertex shader at all! 
... 
```



## <a name="fog-depth-and-shading-mode-changes"></a>Изменения в режиме тумана, глубины и затенения

Если D3DRS \_ шадемоде задан для плоской заливки во время обрезки и растрирования треугольника, то атрибуты с D3DDECLUSAGE \_ цветом интерполируются как плоские оттенки. Если какие-либо компоненты регистра объявляются с помощью семантики цвета, но другие компоненты одного регистра имеют разную семантику, то интерполяция плоской заливки (линейная и плоская) будет неопределена для компонентов в этой регистровой семантике без семантической настройки цвета.

Если требуется отрисовка тумана, \_ \_ шейдеры VS 3 0 и PS \_ 3 \_ 0 должны реализовывать туман. Вычисления тумана не выполняются за пределами шейдеров. В VS 3 0 нет регистра тумана \_ \_ , а также добавлена дополнительная семантика D3DDECLUSAGE \_ тумана (для коэффициента смешения тумана на вершину) и \_ глубина D3DDECLUSAGE (для передачи значения глубины в шейдер пикселей для расчета коэффициента смешения тумана).

Состояние этапа текстуры D3DTSS \_ текскурдиндекс игнорируется при использовании шейдера Pixel shader 3,0.

Для поддержки этих изменений были добавлены следующие значения:


```
// Fog and Depth usages
D3DDECLUSAGE_FOG 
D3DDECLUSAGE_DEPTH 

// Additional wrap states for vs_3_0 attributes with D3DDECLUSAGE_TEXCOORD 
D3DRS_WRAP8 
D3DRS_WRAP9 
D3DRS_WRAP10 
D3DRS_WRAP11 
D3DRS_WRAP12 
D3DRS_WRAP13 
D3DRS_WRAP14 
D3DRS_WRAP15
```



## <a name="floating-point-and-integer-conversions"></a>Преобразования с плавающей запятой и целых чисел

Математические операции с плавающей запятой выполняются с разной точностью и диапазонами (16-разрядные, 24-разрядные и 32-разрядные) в разных частях конвейера. Значение, превышающее динамический диапазон конвейера, который входит в состав этого конвейера (например, с 32-разрядной текстурой с плавающей запятой, в 24-битный конвейер с плавающей запятой в PS \_ 2 \_ 0) создает неопределенный результат. Для прогнозируемого поведения необходимо отвести к такому значению максимальное значение динамического диапазона.

Преобразование значения с плавающей запятой в целое число происходит в нескольких местах, таких как:

-   При обнаружении инструкции [МОВА-VS](mova---vs.md) .
-   Во время адресации текстур.
-   При записи в целевой объект рендеринга, не являющийся плавающей точкой.

## <a name="specifying-full-or-partial-precision"></a>Указание полной или частичной точности

PS \_ 3 \_ 0 и PS \_ 2 \_ имеют поддержку двух уровней точности:



| PS \_ 3 \_ 0 | PS \_ 2 \_ 0 | Точность         | Значение                |
|----------|----------|-------------------|----------------------|
| x        |          | Полное              | FP32 или выше       |
| x        |          | Частичная точность | FP16 = s10e5           |
| x        | x        | Полное              | fp24 = s16e7 или выше |
| x        | x        | Частичная точность | FP16 = s10e5           |



 

PS \_ 3 \_ 0 поддерживает больше точности, чем PS \_ 2 \_ 0. По умолчанию все операции выполняются на полном уровне точности.

Частичная точность (см. [модификаторы регистров построителя текстуры](dx9-graphics-reference-asm-ps-registers-modifiers.md)) запрашивается путем добавления \_ модификатора PP к коду шейдера (при условии, что базовая реализация поддерживает ее). Реализации всегда могут игнорировать модификатор и выполнять затронутые операции в полной точности.

\_Модификатор PP может находиться в двух контекстах:

-   В объявлении координаты текстуры, чтобы передать координаты текстуры частичной точности в шейдер пикселей. Это можно использовать, когда текстуры переправляют данные цвета в шейдер пикселей, что может выполняться быстрее с частичной точностью, чем с полной точностью в некоторых реализациях.
-   В любой инструкции для запроса использования частичной точности, включая инструкции по загрузке текстур. Это означает, что реализации разрешено выполнять инструкцию с частичной точностью и сохранять результат частичной точности. При отсутствии явного модификатора инструкция должна выполняться с полной точностью (независимо от точности входных операндов).

Приложение может намеренно выбрать неточное снижение производительности. Существует несколько типов входных данных шейдера, которые являются естественными кандидатами для обработки частичной точности.

-   Итераторы цвета хорошо представлены значениями частичной точности.
-   Значения текстур из большинства форматов могут быть точно представлены значениями частичной точности (значения, выданные из 32-разрядных текстур формата с плавающей запятой, являются очевидным исключением).
-   Константы могут быть представлены в виде представления частичной точности в соответствии с шейдером.

Во всех этих случаях разработчик может указать частичную точность обработки данных, зная, что точность входных данных не будет потеряна. В некоторых случаях шейдер может потребовать, чтобы внутренние шаги вычисления выполнялись с полной точностью, даже если входные и конечные выходные значения не имеют более полной точности.

## <a name="software-vertex-and-pixel-shaders"></a>Программная вершина и шейдеры пикселей

В реализациях программного обеспечения (время выполнения и ссылка для шейдеров вершин и ссылки для шейдеров пиксельных координат) \_ шейдеры версии 2 0 и выше имеют неограниченную проверку. Это полезно для целей отладки и создания прототипов. Приложение указывает среде выполнения или ассемблеру, что требуется неявное применение проверки с помощью \_ флага SW в ассемблере (например, VS \_ 2 \_ SW). Программный шейдер не будет работать с оборудованием.

VS \_ 2 \_ SW — это ослабление с максимальным ограничением в VS \_ 2 \_ x; аналогичным образом, PS \_ 2 \_ SW — это ослабление с максимальным набором ограничений PS \_ 2 \_ x. В частности, следующие проверки являются нестрогими:



| Модель шейдера                                           |  Ресурс                                    |  Ограничение                                                                                                                                  |
|--------------------------------------------|--------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------|
| VS \_ 2 \_ SW, VS \_ 3 \_ SW, PS \_ 2 \_ SW, PS \_ 3 \_ SW | Число инструкций                   | Неограниченно                                                                                                                         |
| VS \_ 2 \_ SW, VS \_ 3 \_ SW, PS \_ 2 \_ SW, PS \_ 3 \_ SW | Регистры констант float             | 8192                                                                                                                              |
| VS \_ 2 \_ SW, VS \_ 3 \_ SW, PS \_ 2 \_ SW, PS \_ 3 \_ SW | Регистры целочисленных констант           | 2048                                                                                                                              |
| VS \_ 2 \_ SW, VS \_ 3 \_ SW, PS \_ 2 \_ SW, PS \_ 3 \_ SW | Регистры логических констант           | 2048                                                                                                                              |
| PS \_ 2 \_ SW                                  | Глубина зависимого чтения                 | Неограниченно                                                                                                                         |
| VS \_ 2 \_ SW                                  | инструкции и метки управления потоком | Неограниченно                                                                                                                         |
| VS \_ 2 \_ SW, VS \_ 3 \_ SW, PS \_ 2 \_ SW, PS \_ 3 \_ SW | Начало/шаг/количество циклов               | Начало итерации и размер шага итерации для инструкций-представительов и циклов — 32-разрядные целые числа со знаком. Число может быть до максимального числа \_ int/64. |
| VS \_ 2 \_ SW, VS \_ 3 \_ SW, PS \_ 2 \_ SW, PS \_ 3 \_ SW | Ограничения портов                          | Ограничения портов для всех файлов регистрации нестрогие.                                                                                   |
| VS \_ 3 \_ SW                                  | Число интерполяций              | 16 выходных регистров в VS \_ 3 \_ SW.                                                                                                 |
| PS \_ 3 \_ SW                                  | Число интерполяций              | 14 (16-2) входные регистры для PS \_ 3 \_ SW.                                                                                           |



 

## <a name="related-topics"></a>Связанные разделы

<dl> <dt>

[Модель шейдера 3 (DirectX HLSL)](dx-graphics-hlsl-sm3.md)
</dt> </dl>

 

 
