---
title: Идиректвритерлокк — реализация составного файла
description: Реализация составного файла Идиректвритерлокк предоставляет способ открытия составного файла в прямом режиме с одним модулем записи и несколькими читателями.
ms.assetid: 4b247dae-d937-430a-bdb7-c47fa3c026b6
keywords:
- Идиректвритерлокк Стрктд STG, реализация составного файла
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 861935a4c373ce03408c0e633e581e56d39623da
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "103773988"
---
# <a name="idirectwriterlock---compound-file-implementation"></a>Идиректвритерлокк — реализация составного файла

Реализация составного файла [**идиректвритерлокк**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock) предоставляет способ открытия составного файла в прямом режиме с одним модулем записи и несколькими читателями.

Составные файлы можно открывать в прямом режиме с помощью \_ флага Direct стгм. Интерфейс [**идиректвритерлокк**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock) ЗАДАЕТ для стгм \_ ReadWrite \| стгм Share Deny, который \_ \_ \_ является допустимым в режиме прямого доступа, не требуя дополнительной нагрузки на копию моментального снимка.

Если составной файл открывается в режиме транзакций с помощью \_ флага транзакций стгм, можно также иметь несколько модулей чтения и один модуль записи с помощью \_ \| флага записи стгм ReadWrite стгм \_ Share \_ Deny \_ . Тем не менее в этом случае для читателей создается копия файла моментального снимка. Часто возникают затраты на копирование временных файлов.

## <a name="when-to-use"></a>Назначение

Используйте предоставляемую системой реализацию [**идиректвритерлокк**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock) при открытии хранилища в прямом режиме (стгм \_ Direct) с параметром стгм \_ ReadWrite \| стгм \_ совместное использование \_ \_ флагов записи.

Чтобы получить указатель на [**идиректвритерлокк**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock), вызовите **QueryInterface** в [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) , чтобы получить корневой объект хранилища для составного файла.

Вызовите метод [**идиректвритерлокк:: ваитфорвритеакцесс**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess) , чтобы получить монопольный доступ на запись к составному файлу. Вызовите [**идиректвритерлокк:: релеасевритеакцесс**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-releasewriteaccess) , чтобы освободить монопольный доступ на запись.

[**Идиректвритерлокк:: хавевритеакцесс**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-havewriteaccess) указывает, заблокирован ли файл в данный момент.

## <a name="remarks"></a>Комментарии

Реализация составного файла функции однократного записи и множественного чтения основана на блокировке диапазона. Модуль записи получает монопольный доступ к хранилищу для записи после того, как все текущие модули чтения закрыли хранилище. Пока модуль записи активен, последующие модули чтения не смогут открыть хранилище. Модуль записи вызывает [**идиректвритерлокк:: ваитфорвритеакцесс**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess) для получения монопольного доступа на запись. Чтобы освободить хранилище, модуль записи должен вызвать [**идиректвритерлокк:: релеасевритеакцесс**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-releasewriteaccess) .

Вызов [**идиректвритерлокк:: ваитфорвритеакцесс**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess) требуется перед записью в этом режиме с одним чтением, несколькими модулями записи. Пытается выполнить запись в файл без вызова **идиректвритерлокк:: ваитфорвритеакцесс** первый результат в STG \_ E \_ ACCESSDENIED. Эта ошибка возвращается даже в том случае, если модуль записи открыл файл изначально и ни один из читателей не открыл файл.

## <a name="marshaling-considerations"></a>Рекомендации по упаковке

Настраиваемая упаковка обычно используется, когда составной файл маршалируется в другой процесс на том же компьютере. При упаковке хранилищ, права доступа не учитываются, а указатель [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) передается в новый процесс с теми же режимами доступа и правами, что и в исходном процессе упаковки. Дополнительные сведения о режимах доступа см. в разделе [**константы стгм**](stgm-constants.md). Во время маршалирования никакие блокировки не выполняются или не проверяются, чтобы обеспечить монопольный доступ на запись. В этом случае не применяется политика единого модуля записи для составных файлов, открытых в режиме с одним модулем записи, несколькими модулями чтения. Вместо этого принудительная обработка выполняется внутри реализации составного файла.

Поскольку указатель [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) передается в другой процесс во время маршалирования, два процесса могут иметь одновременный доступ к одному и тому же составному файлу. Несмотря на то, что вызывающий объект может получить эксклюзивный доступ на запись к хранилищу путем вызова [**идиректвритерлокк:: ваитфорвритеакцесс**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess), упакованная версия также может иметь доступ одновременно. Упакованные версии не принудительно закрываются, пока один модуль записи обращается к файлу. В этом случае реализация составного файла выполняет внутреннюю синхронизацию операций записи.

Если один модуль записи получает эксклюзивный доступ путем вызова, [**идиректвритерлокк:: ваитфорвритеакцесс**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess), то упакованное хранилище также имеет доступ на запись и не обязательно вызывать **Идиректвритерлокк:: ваитфорвритеакцесс**. Оба процесса имеют доступ на запись и синхронизация управляются внутренней реализацией составного файла.

## <a name="related-topics"></a>См. также

<dl> <dt>

[**идиректвритерлокк**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock)
</dt> </dl>

 

 




