---
title: Создание обработчика очистки диска
description: Один аксиома проверенное время и еще раз в мире компьютеров заключается в том, что независимо от размера хранилища вашего компьютера, вы в конечном итоге заполните его.
ms.assetid: f85e0db7-fbdb-452e-90c8-672f716b5692
keywords:
- обработчики очистки диска
- Очистка диска
- датадривенклеанер
- регистрация, обработчики очистки диска
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 61ce7fc96e16cb27168e00196b65d48d378758a47594122cca978dc1a1f4de94
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118479901"
---
# <a name="creating-a-disk-cleanup-handler"></a>Создание обработчика очистки диска

Один аксиома проверенное время и еще раз в мире компьютеров заключается в том, что независимо от размера хранилища вашего компьютера, вы в конечном итоге заполните его. Хотя средний размер жесткого диска компьютера значительно увеличился со временем, приложения также увеличились соответствующим образом, оставляя пользователям возможность создавать больше свободного пространства на жестком диске. Доступное пространство также сокращается по количеству временных файлов, создаваемых приложениями для резервного копирования или по соображениям производительности. Когда место на диске оказывается низким, необходимо уменьшить объем пространства, используемого приложениями. Свободное место на диске можно освободить с помощью различных средств, включая следующие.

-   Удаление файлов.
-   Сжатие файлов.
-   Перемещение файлов на носитель резервной копии.
-   Передача файлов на удаленный сервер.

Ниже перечислены файлы, которые являются хорошими кандидатами для очистки.

-   Файлы, которые пользователю больше не понадобятся.
-   Временные файлы, которые существуют только в целях повышения производительности.
-   Файлы, которые можно восстановить (при необходимости) с установочного компакт-диска.
-   Файлы данных, которые могут быть заменены более новыми версиями, например старые файлы резервных копий.
-   Старые файлы, которые не использовались в течение длительного времени.

Удаление особенно подходит для файлов, которые пользователю больше не понадобятся, например, для файлов, временно кэшируемых в целях повышения производительности. Удаление также подходит для файлов, которые легко восстановить, например графические файлы, которые можно загрузить с установочного компакт-диска. Файлы, которые может потребовать пользователь, или которые трудно воссоздать, лучше подходят для сжатия или резервного копирования.

Ожидается, что пользователь вручную очищать файловую систему не является хорошим решением. Пользователь может не знать, где находится много файлов, или узнать, какие из них можно безопасно удалить. Кроме того, существует риск, что пользователь может удалить нужные файлы.

В этом разделе обсуждаются следующие аспекты служебной программы очистки диска.

-   [служебная программа для очистки диска Windows](#the-windows-disk-cleanup-utility)
-   [Основы реализации](#implementation-basics)
    -   [Инициализация/Инитиализикс](#initializeinitializeex)
    -   [жетспацеусед](#getspaceused)
    -   [шовпропертиес](#showproperties)
    -   [Purge](#purge)
    -   [Отключение](#deactivate)
-   [Регистрация обработчика очистки диска](#registering-a-disk-cleanup-handler)
    -   [Регистрация CLSID обработчика](#registering-a-handlers-clsid)
    -   [Регистрация обработчика с помощью диспетчера очистки диска: общие](#registering-a-handler-with-the-disk-cleanup-manager-general)
    -   [регистрация обработчика с помощью диспетчера очистки диска: Windows 2000 или более поздних версий систем](#registering-a-handler-with-the-disk-cleanup-manager-windows-2000-or-later-systems)
    -   [Использование объекта Датадривенклеанер](#using-the-datadrivencleaner-object)
    -   [Пример регистрации обработчика очистки диска](#example-registration-of-a-disk-cleanup-handler)

## <a name="the-windows-disk-cleanup-utility"></a>служебная программа для очистки диска Windows

начиная с Windows 98, операционная система Windows включает в себя программу «очистка диска», которая упрощает для пользователя управление доступным местом на жестком диске. Служебная программа для очистки диска разработана таким образом, чтобы освободить максимально возможное дисковое пространство и снизить риск случайного удаления пользователем необходимых файлов.

Очистка диска может быть инициирована тремя способами.

-   Пользователь может инициировать очистку диска, нажав кнопку **Пуск**; Указание на **все программы**, **стандартные** и **системные средства**; и выберите пункт **Очистка диска**.
-   Система уведомляет пользователя с сообщением о том, что неиспользуемое дисковое пространство достигло критического режима. Пороговое значение критического режима для диска размером более 2,25 гигабайт (ГБ) составляет 200 МБ. Последующие предупреждения приведены в 80, 50 и 1 МБ. Пользователю предоставляется возможность освободить место на диске вручную или запустить служебную программу очистки диска.
-   у пользователя может быть мастер планирования заданий Windows (известный как мастер обслуживания в старых системах) запускать служебную программу очистки диска автоматически в запланированное время.

Основная задача, характерная для очистки диска, — освободить столько дисковых пространств, сколько возможно, без удаления необходимых файлов. Поскольку нет стандартного способа маркировки файлов для очистки, ни одно приложение не может надежно обнаруживать и очищать все ненужные файлы. Служебная программа для очистки диска решает эту проблему, разбивая операцию очистки между одним *диспетчером очистки диска* и набором *обработчиков очистки диска*.

При запуске служебной программы очистки диска пользователь видит следующее диалоговое окно. (Если на компьютере существует более одного диска или раздела диска, пользователю сначала предлагается выбрать диск перед отображением этого диалогового окна.)

![снимок экрана диалогового окна "Очистка"](images/cleanup1.png)

Диспетчер очистки диска является частью операционной системы. Он отображает диалоговое окно, показанное на предыдущем рисунке, обрабатывает ввод пользователя и управляет операцией очистки. Фактический выбор и очистка ненужных файлов выполняются обработчиками очистки отдельных дисков, показанными в списке Диспетчер очистки диска. Пользователь может включить или отключить отдельные обработчики, установив или сняв флажок в пользовательском интерфейсе диспетчера очистки диска.

Каждый обработчик отвечает за хорошо определенный набор файлов. Например, выбранный обработчик на рисунке отвечает за очистку скачанных программных файлов. Обработчик, выбранный на рисунке, также предоставляет кнопку **просмотра файлов** . нажимая кнопку, пользователь может запросить, чтобы обработчик отображал пользовательский интерфейс, обычно это окно обозревателя Windows, позволяющее пользователю указать, какие файлы или классы файлов следует очистить.

хотя Windows поставляется с несколькими обработчиками очистки диска, они не предназначены для обработки файлов, созданных другими приложениями. Вместо этого диспетчер очистки диска предназначен для гибкого и расширяемого, позволяя любому разработчику реализовывать и регистрировать собственный обработчик очистки диска. Любой разработчик может расширить доступные службы очистки диска, реализовав и зарегистрировав обработчик очистки диска.

Все приложения, которые создают временные файлы, могут и должны реализовывать и регистрировать обработчик очистки диска. Это дает пользователям удобный и надежный способ управления временными файлами приложения. При реализации обработчика можно решить, какие файлы затрагиваются, и определить, как происходит фактическая очистка.

## <a name="implementation-basics"></a>Основы реализации

Обработчики очистки — это объекты модели COM, выполняющие внутрипроцессный сервер. Windows предоставляет существующий объект обработчика, именуемый датадривенклеанер для использования. Вы также можете явно реализовать обработчик для большей гибкости. Затем эти объекты позволяют указать, как выбрать файлы, освободить место на диске и, в случае реализованного обработчика, отобразить дополнительный пользовательский интерфейс для более детального управления. В этом разделе рассматривается вопрос реализации собственного обработчика. Дополнительные сведения об использовании объекта Датадривенклеанер см. [в разделе Использование объекта датадривенклеанер](#using-the-datadrivencleaner-object).

Обработчик очистки диска должен выполнить пять основных задач.

-   Инициализируйте объект обработчика.
-   Проверьте диск, чтобы определить, сколько места на диске можно освободить.
-   Отображение пользовательского интерфейса для получения отзывов пользователей о том, какие файлы нужно очистить. (необязательно)
-   Выполните очистку.
-   "Завершение работы".

чтобы разрешить диспетчеру очистки дисков управлять этими задачами, обработчик должен экспортировать либо [**иемптиволумекаче**](/windows/desktop/api/Emptyvc/nn-emptyvc-iemptyvolumecache) для Windows 98 или [**IEmptyVolumeCache2**](/windows/desktop/api/Emptyvc/nn-emptyvc-iemptyvolumecache2) для Windows Millennium Edition (Windows Me), Windows 2000 и Windows XP. Поскольку **IEmptyVolumeCache2** наследует от **иемптиволумекаче**, для реализации обеих задач требуется только дополнительный метод **инитиализикс**, относительно небольшая дополнительная работа. Если обработчик не предназначен только для одной из этих операционных систем, он должен экспортировать оба интерфейса.

Для экспорта этих интерфейсов необходимо реализовать эти методы, соответствующие пяти основным задачам.

-   [Инициализация/Инитиализикс](#initializeinitializeex)
-   [жетспацеусед](#getspaceused)
-   [шовпропертиес](#showproperties)
-   [Purge](#purge)
-   [Отключение](#deactivate)

### <a name="initializeinitializeex"></a>Инициализация/Инитиализикс

Два метода инициализации, которые похожи на, вызываются при запуске служебной программы очистки диска. диспетчер очистки диска Windows 98 вызывает метод [**иемптиволумекаче:: Initialize**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-initialize) обработчика. однако Windows Millennium Edition (Windows Me), Windows 2000 или Windows XP disk recleanup manager, сначала пытается вызвать [**IEmptyVolumeCache2:: инитиализикс**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache2-initializeex) и использует только **иемптиволумекаче:: Initialize** , если обработчик не имеет доступ к [**IEmptyVolumeCache2**](/windows/desktop/api/Emptyvc/nn-emptyvc-iemptyvolumecache2) . Диспетчер очистки диска передает сведения в метод, например раздел реестра обработчика и том диска, который необходимо очистить.

Любой из методов может возвращать различные отображаемые строки и устанавливать один или несколько флагов. Основное различие между двумя методами заключается в способе обработки текста, отображаемого в диспетчере очистки диска. Затрагиваются следующие три строки.



| Строка       | Назначение                                                                            | Инициализация                                                                           | инитиализикс                                                                                     |
|--------------|------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------|
| Отображаемое имя | Имя обработчика, отображаемое в списке диспетчера очистки диска.               | Если *ппвсздисплайнаме* имеет значение **null**, значение по умолчанию извлекается из реестра. | Правильно локализованная строка должна быть указана в *ппвсздисплайнаме* . значения реестра не используются. |
| Описание  | Описательный текст, отображаемый под списком при выборе имени обработчика. | Если *ппвсздескриптион* имеет значение **null**, значение по умолчанию извлекается из реестра. | Правильно локализованная строка должна быть указана в *ппвсздескриптион* . значения реестра не используются. |
| Текст кнопки  | Текст для необязательной кнопки, которая позволяет пользователям отображать пользовательский интерфейс обработчика.        | Нет доступных параметров. Должен быть указан в реестре.                           | Правильно локализованная строка должна быть указана в *ппвсзбтнтекст* . значения реестра не используются.     |



 

Параметр *пдвфлагс* , находящийся в обоих методах инициализации, распознает один и тот же набор флагов. Два из этих флагов передаются в метод диспетчером очистки диска.

-   **ЕВКФ \_ сеттингсмоде**

    Если диспетчер очистки диска выполняется по расписанию, он устанавливает флаг **евкф \_ сеттингсмоде** . Если этот флаг установлен, диспетчер очистки диска не вызывает методы [жетспацеусед](#getspaceused), [очистки](#purge)или [шовпропертиес](#showproperties) . Метод [**Initialize**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-initialize) или [**инитиализикс**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache2-initializeex) обработчика должен выполнять все задачи, обычно выполняемые [**жетспацеусед**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-getspaceused) и [**очистки**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-purge). Поскольку нет возможности отзыва пользователей, следует затронуть только те файлы, которые чрезвычайно надежны для очистки. Следует игнорировать параметр *пквсзволуме* метода инициализации и очистить ненужные файлы независимо от того, на каком диске они находятся.

-   **ЕВКФ \_ аутофдискспаце**

    Если установлен флаг **евкф \_ аутофдискспаце** , то диск пользователя является критически коротким местом. Обработчик должен быть агрессивным для удаления файлов, даже если это приводит к снижению производительности. Однако, очевидно, что обработчик не должен удалять файлы, которые приведут к сбою приложения или потере данных пользователем.

Остальные флаги задаются обработчиком очистки диска и возвращаются в Диспетчер очистки диска. Дополнительные сведения см. на страницах справочника по методам для [**иемптиволумекаче:: Initialize**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-initialize) и [**IEmptyVolumeCache2:: инитиализикс**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache2-initializeex).

-   ЕВКФ \_ донтшовифзеро

    Отображать обработчик в списке диспетчера очистки диска, только если значение, возвращаемое функцией [**жетспацеусед**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-getspaceused) , указывает, что обработчик может освободить место на диске.

-   ЕВКФ \_ енаблебидефаулт

    Указывает, что обработчик включен по умолчанию. Он будет выполняться при каждом выполнении очистки диска, если пользователь не отключил его, сняв флажок в списке обработчиков диспетчера очистки диска.

-   ЕВКФ \_ енаблебидефаулт \_ Auto

    Указывает, что обработчик автоматически включается во время выполнения запланированной очистки.

-   ЕВКФ \_ хассеттингс

    Установите этот флаг, если обработчик содержит пользовательский интерфейс для вывода. В ответ диспетчер очистки диска отображает кнопку, когда этот обработчик выбран в списке. При нажатии этой кнопки диспетчер очистки диска вызывает [**шовпропертиес**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-showproperties).

-   ЕВКФ \_ ремовефромлист

    Удалите имя обработчика из списка доступных обработчиков после того, как обработчик будет выполнен один раз. Данные реестра обработчика также удаляются.

### <a name="getspaceused"></a>жетспацеусед

Диспетчер очистки диска вызывает этот метод, чтобы определить, сколько места может быть освобождено обработчиком очистки диска. Затем Диспетчер очистки диска отображает это значение справа от имени обработчика в списке. Эта операция выполняется для всех обработчиков, зарегистрированных в диспетчере очистки диска при запуске диспетчера и перед отображением основного пользовательского интерфейса диспетчера. При вызове [**жетспацеусед**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-getspaceused) обработчик должен проверять файлы, за которые он отвечает, определять, какие из них являются кандидатами на очистку, и возвращать объем дискового пространства, который может быть освобожден.

Поскольку сканирование может быть длительным процессом, диспетчер очистки диска использует параметр *ПИКБ* этого метода для передачи указателя на интерфейс [**иемптиволумекачекаллбакк**](/windows/desktop/api/Emptyvc/nn-emptyvc-iemptyvolumecachecallback) . Обработчик периодически использует этот интерфейс во время сканирования для вызова [**иемптиволумекачекаллбакк:: сканпрогресс**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecachecallback-scanprogress), который служит двум целям.

-   Позволяет диспетчеру очистки дисков обновлять индикатор выполнения, уведомляя пользователя о ходе проверки.
-   Уведомляет обработчик о необходимости остановить проверку в случае нажатия кнопки **отмены** в окне хода выполнения. Это событие кнопки не передается непосредственно в обработчик; Вместо этого диспетчер очистки диска возвращает «E \_ Abort» в следующий раз, когда [**Жетспацеусед**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-getspaceused) вызывает [**иемптиволумекачекаллбакк:: сканпрогресс**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecachecallback-scanprogress).

### <a name="showproperties"></a>шовпропертиес

перед запуском очистки обработчик может отобразить пользовательский интерфейс, обычно в виде окна обозревателя Windows, позволяющего пользователю просмотреть список файлов или классов файлов, выбранных для очистки обработчиком. Если обработчик устанавливает флаг **евкф \_ хассеттингс** при вызове [**Initialize**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-initialize) или [**инитиализикс**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache2-initializeex) , пользователь может запросить пользовательский интерфейс, нажав кнопку, отображаемую для этой цели в диспетчере очистки диска. Текст кнопки зависит от обработчика, но "файлы представления", "Просмотр страниц" и "Параметры" являются общими метками.

При нажатии кнопки диспетчер очистки диска вызывает [**шовпропертиес**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-showproperties) , чтобы вывести запрос обработчику на отображение пользовательского интерфейса. Пользовательский интерфейс должен быть создан как дочерний для окна, дескриптор которого передается в параметре *HWND* метода **шовпропертиес** .

### <a name="purge"></a>Purge

Диспетчер очистки диска вызывает метод [**очистки**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-purge) обработчика, чтобы задать очистку в перемещении. Параметр *ПИКБ* метода — это указатель на интерфейс [**иемптиволумекачекаллбакк**](/windows/desktop/api/Emptyvc/nn-emptyvc-iemptyvolumecachecallback) диспетчера очистки диска. Как и в случае с методом [**жетспацеусед**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-getspaceused) , обработчик должен периодически использовать интерфейс обратного вызова для передачи сведений о ходе выполнения и запроса диспетчера очистки диска о том, что пользователь щелкнул **отмену**. Однако обратите внимание, что метод **очистки** должен вызывать [**Иемптиволумекачекаллбакк::P уржепрогресс**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecachecallback-purgeprogress), а не [**сканпрогресс**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecachecallback-scanprogress).

### <a name="deactivate"></a>Отключение

Метод [**Deactivate**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-deactivate) вызывается, когда диспетчер очистки диска готовится к завершению работы. Обработчик должен выполнять все необходимые задачи очистки и возвращать. Если вы не хотите, чтобы обработчик запускался снова, установите флаг **евкф \_ ремовефромлист** в параметре *пдвфлагс* метода инициализации. Если этот флаг установлен, диспетчер очистки диска удаляет обработчик из списка и удаляет записи реестра обработчика. Необходимо повторно добавить записи реестра для повторного запуска обработчика. Этот флаг обычно используется для обработчиков, которые выполняются только один раз.

## <a name="registering-a-disk-cleanup-handler"></a>Регистрация обработчика очистки диска

чтобы добавить обработчик в список диспетчера очистки диска, в реестр Windows необходимо добавить определенные ключи и значения.

-   [Регистрация CLSID обработчика](#registering-a-handlers-clsid)
-   [Регистрация обработчика с помощью диспетчера очистки диска: общие](#registering-a-handler-with-the-disk-cleanup-manager-general)
-   [регистрация обработчика с помощью диспетчера очистки диска: Windows 2000 или более поздних версий систем](#registering-a-handler-with-the-disk-cleanup-manager-windows-2000-or-later-systems)
-   [Использование объекта Датадривенклеанер](#using-the-datadrivencleaner-object)
-   [Пример регистрации обработчика очистки диска](#example-registration-of-a-disk-cleanup-handler)

### <a name="registering-a-handlers-clsid"></a>Регистрация CLSID обработчика

Как и для всех COM-объектов, идентификатор GUID объекта обработчика и библиотека DLL должны быть зарегистрированы в ключе **CLSID** в **\_ \_ корневом каталоге классов hKey**. Также можно зарегистрировать значок, который отображается рядом с именем обработчика в списке диспетчера очистки диска, но это необязательно. В следующем примере показаны ключи, значения и участвующие в нем данные.

```
HKEY_CLASSES_ROOT
   CLSID
      Handler's GUID
         DefaultIcon
            (Default) = Handler's Icon Path, Icon Index
         InprocServer32
            (Default) = Handler's DLL path
            ThreadingModel = Apartment
```

### <a name="registering-a-handler-with-the-disk-cleanup-manager-general"></a>Регистрация обработчика с помощью диспетчера очистки диска: общие

Для завершения регистрации обработчик должен добавить ключ, содержащий его особенности, как показано здесь. В оставшейся части этого раздела рассматривается содержимое этого ключа.

```
HKEY_LOCAL_MACHINE
   Software
      Microsoft
         Windows
            CurrentVersion
               Explorer
                  VolumeCaches
                     Handler's Key
```

Как правило, имя ключа, содержащего определенные обработчики, называется типом обрабатываемого файла, например **загруженные файлы программы**, но это не является обязательным. В следующей таблице приведены возможные значения, найденные в этом разделе.

> [!Note]  
> Только значение по умолчанию, задающее идентификатор класса обработчика (CLSID), обязательно для всех остальных значений.

 



<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Значение</th>
<th>Тип</th>
<th>Значение</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>По умолчанию</td>
<td>REG_SZ</td>
<td>CLSID обработчика, зарегистрированный в <strong>HKEY_CLASSES_ROOT</strong> \ <strong>CLSID</strong>.</td>
</tr>
<tr class="even">
<td>адванцедбуттонтекст</td>
<td>REG_SZ</td>
<td>Текст для необязательной кнопки, которую пользователь может щелкнуть для вывода пользовательского интерфейса обработчика. Символ & можно поместить перед символом, чтобы назначить сочетание клавиш для кнопки. Значение Адванцедбуттонтекст игнорируется обработчиками, которые предоставляют <a href="/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache2-initializeex"><strong>IEmptyVolumeCache2:: инитиализикс</strong></a>.</td>
</tr>
<tr class="odd">
<td>клеанупстринг</td>
<td>REG_SZ</td>
<td>Командная строка, указывающая исполняемый файл и необязательные параметры командной строки. Эта командная строка выполняется после завершения очистки диска.</td>
</tr>
<tr class="even">
<td>CSID</td>
<td>REG_DWORD</td>
<td>Независимый от системы идентификатор для специальной папки, включаемой в поиск файлов. Это значение должно быть указано в виде числового значения для instance, 0x0000001c, а не CSIDL_LOCAL_APPDATA. Список возможных значений см. в разделе <a href="/windows/desktop/shell/csidl"><strong>CSid</strong></a>. Можно использовать только одно значение.<br/> Если указано значение папки, то расположение, указанное в качестве значения CSID, добавляется в начале этой информации для создания пути поиска. Например, рассмотрим следующий сценарий.<br/>
<ul>
<li>Значение CSID указано как 0x0000000d (CSIDL_MYMUSIC)</li>
<li>папка моя музыка находится в папке C:\Documents и Параметры \<em>имя_пользователя</em>\ музыка</li>
<li>Значение папки содержит &quot; жазз\синжерс&quot;</li>
</ul>
результатом этого сценария является то, что обработчик очистки диска ищет папку C:\Documents и Параметры \<em>username \ имя_пользователя</em>\ мусик\жазз\синжерс. Обратите внимание, что если он отсутствует, добавляется косая черта перед значением папки.<br/></td>
</tr>
<tr class="odd">
<td>Описание</td>
<td>REG_SZ</td>
<td>Описательный текст, отображаемый под списком диспетчера очистки диска, когда выбрано имя обработчика. Здесь можно объяснить, что делает обработчик, какие файлы он сам имеет в себе и какая другая информация елуЦидатори пользователю. Если <a href="/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache2-initializeex"><strong>IEmptyVolumeCache2:: инитиализикс</strong></a> не предоставляется обработчиком, этот текст можно переопределить с помощью метода <a href="/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-initialize"><strong>Иемптиволумекаче:: Initialize</strong></a> обработчика, указав альтернативную строку в параметре <em>ппвсздескриптион</em> при вызове метода.</td>
</tr>
<tr class="even">
<td>Отображение</td>
<td>REG_SZ</td>
<td>Имя обработчика, отображаемое в списке диспетчера очистки диска. Если <a href="/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache2-initializeex"><strong>IEmptyVolumeCache2:: инитиализикс</strong></a> не предоставляется обработчиком, этот текст можно переопределить с помощью метода <a href="/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-initialize"><strong>Иемптиволумекаче:: Initialize</strong></a> обработчика, указав альтернативную строку в параметре <em>ппвсздисплайнаме</em> при вызове метода.</td>
</tr>
<tr class="odd">
<td>FileList</td>
<td>REG_SZ или REG_MULTI_SZ</td>
<td>Список файлов, Поиск и очистка которых выполняется этим обработчиком. Подстановочные знаки можно указать с помощью команды? или * символов. Если значение имеет тип REG_SZ, несколько расширений разделяются с помощью | или: символы без пробелов на обеих сторонах.<br/> Если флаг DDEVCF_REMOVEDIRS установлен в значении флагов, эти значения могут указывать имена каталогов, а также файлы.<br/></td>
</tr>
<tr class="even">
<td>Флаги</td>
<td>REG_DWORD или REG_BINARY</td>
<td>Помечает управляющие элементы процедуры поиска и очистки. Одно или несколько из следующих значений.
<ul>
<li>DDEVCF_DOSUBDIRS (0x00000001). Рекурсивный поиск и удаление.</li>
<li>DDEVCF_REMOVEAFTERCLEAN (0x00000002). После запуска обработчика удалите его из реестра.</li>
<li>DDEVCF_REMOVEREADONLY (0x00000004). Удалите файлы, соответствующие условиям поиска, даже если они доступны только для чтения.</li>
<li>DDEVCF_REMOVESYSTEM (0x00000008). Удалите файлы, соответствующие условиям поиска, даже если они являются системными файлами.</li>
<li>DDEVCF_REMOVEHIDDEN (0x00000010). Удалите файлы, соответствующие условиям поиска, даже если они скрыты.</li>
<li>DDEVCF_DONTSHOWIFZERO (0x00000020). Не выводит этот обработчик в диспетчере очистки диска, если нет файлов, соответствующих условиям поиска.</li>
<li>DDEVCF_REMOVEDIRS (0x00000040). Сопоставление значения FileList с каталогами и удаление совпадений и всех подкаталогов.</li>
<li>DDEVCF_RUNIFOUTOFDISKSPACE (0x00000080). Этот обработчик следует запускать только в том случае, если свободное место на диске превышает критическое значение, определяемое диспетчером очистки диска с установкой флага EVCF_OUTOFDISKSPACE с помощью <a href="/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-initialize"><strong>иемптиволумекаче:: Initialize</strong></a> или <a href="/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache2-initializeex"><strong>IEmptyVolumeCache2:: инитиализикс</strong></a>.</li>
<li>DDEVCF_REMOVEPARENTDIR (0x00000100). Удалить родительский каталог указанных файлов после запуска очистки.</li>
<li>DDEVCF_PRIVATE_LASTACCESS (0x10000000). Используйте значение Ластакцесс, если оно предоставлено, для определения того, какие файлы следует очищать. Этот флаг пропускается при использовании параметра <a href="#using-the-datadrivencleaner-object">датадривенклеанер</a> любое предоставленное ластакцесс значение всегда используется.</li>
</ul></td>
</tr>
<tr class="odd">
<td>Папка</td>
<td>REG_SZ, REG_MULTI_SZ или REG_EXPAND_SZ</td>
<td>Конкретная папка или папки для поиска элементов, соответствующих записям в значении FileList. Подстановочные знаки можно указать с помощью команды? или * символов. Если значение имеет тип REG_SZ, несколько имен папок разделяются с помощью | символ без пробелов с обеих сторон.<br/> Если указано значение CSID, в этом значении можно указать только одну папку. Расположение, указанное в качестве значения CSID, добавляется в начало пути к папке для создания пути поиска. Пример см. в описании значения CSID.<br/> если это значение отсутствует в Windows Vista с пакетом обновления 1 (sp1) и более поздних версиях, обработчик очистки игнорируется и возвращается S_FALSE при инициализации.<br/> если это значение отсутствует в первоначальном выпуске Windows Vista и более ранних версий, используется корневая папка текущего тома. В этом случае для поиска по всему диску требуется флаг DDEVCF_DOSUBDIRS. Без него выполняется поиск только в самой корневой папке.<br/> Необходимо указать диск или диски. Это можно сделать с помощью значения CSID или строки REG_EXPAND_SZ. При запрете этих параметров диск для поиска должен быть указан в имени папки. Используйте?: для поиска в папке на текущем диске.<br/></td>
</tr>
<tr class="even">
<td>IconPath</td>
<td>REG_SZ или REG_EXPAND_SZ</td>
<td>Путь к ресурсу, из которого получается значок, используемый для связи с обработчиком.</td>
</tr>
<tr class="odd">
<td>ластакцесс</td>
<td>REG_DWORD или REG_BINARY</td>
<td>Число дней, которое должно пройти с момента последнего обращения к файлу, или создать каталог для этого файла или каталога, который будет учитываться при очистке.</td>
</tr>
<tr class="even">
<td>Приоритет</td>
<td>REG_DWORD или REG_BINARY</td>
<td>Определяет порядок выполнения обработчика относительно других обработчиков. Чем выше число, тем выше в процессе, в котором выполняется обработчик. Определенного диапазона нет допустимого числа.</td>
</tr>
<tr class="odd">
<td>PropertyBag</td>
<td>REG_SZ</td>
<td>Идентификатор CLSID ресурса, используемый для предоставления локализованного текста для отображаемого имени, описания и текста кнопки. этот ресурс полезен в ситуации, когда обработчик не реализует <a href="/windows/desktop/api/Emptyvc/nn-emptyvc-iemptyvolumecache"><strong>иемптиволумекаче</strong></a> , а обработчик выполняется под управлением Microsoft Windows NT или Windows XP.<br/> Диспетчер очистки диска сначала проверяет, вернул ли подпрограмма инициализации обработчика эти строки, как в случае реализации <a href="/windows/desktop/api/Emptyvc/nn-emptyvc-iemptyvolumecache2"><strong>IEmptyVolumeCache2</strong></a> . После этого руководитель переключается в контейнер свойств с именем в этом значении. Если ничего не указано, он извлекает текст из реестра.<br/></td>
</tr>
<tr class="even">
<td>статефлагс</td>
<td>REG_DWORD</td>
<td>Запустив исполняемый файл диспетчера очистки диска Cleanmgr.exe из командной строки, можно объявить <em>Профили</em>очистки. Эти профили состоят из подмножества доступных обработчиков и получают уникальную цифровую метку. Это позволяет автоматизировать выполнение различных наборов обработчиков в разное время.<br/> Командная строка &quot;cleanmgr.exe/sageset:<strong>nnnn</strong> &quot; , где <strong>nnnn</strong> — уникальная цифровая метка, отображает пользовательский интерфейс, позволяющий выбирать обработчики, включаемые в этот профиль. Кроме определения профиля, параметр сажесет также записывает значение с именем Статефлагс<strong>nnnn</strong>, где <strong>nnnn</strong> — это метка, используемая в параметре, для всех подразделов в разделе <strong>волумекачес</strong>. Для этих записей существует два возможных значения данных.
<ul>
<li>0: не запускать этот обработчик при выполнении этого профиля.</li>
<li>2: включить этот обработчик при выполнении этого профиля.</li>
</ul>
<br/> Например, предположим, что выполняется Командная строка &quot;cleanmgr.exe/sageset: 1234 &quot; . В представленном пользовательском интерфейсе пользователь выбирает <strong>загруженные файлы программы</strong>, но не выбирает <strong>временные файлы Интернета</strong>. Затем в реестр записываются следующие значения.<br/>
<pre data-space="preserve"><code>HKEY_LOCAL_MACHINE
   Software
      Microsoft
         Windows
            CurrentVersion
               Explorer
                  VolumeCaches
                     Downloaded Program Files
                        StateFlags1234 = 0x00000002
                     Internet Cache Files
                        StateFlags1234 = 0x00000000</code></pre>
<br/> Командная строка &quot;cleanmgr.exe/сажерун:<strong>nnnn</strong> &quot; , где значение <strong>nnnn</strong> совпадает с меткой, объявленной с параметром сажесет, запускает все обработчики, выбранные в этом профиле.<br/> Универсальное значение Статефлагс записывается в реестр, когда Очистка диска выполняется обычным образом. Это значение просто сохраняет состояние обработчика (флажок установлен или снят) в момент последнего представления в качестве параметра для пользователя. Для этих записей существует два возможных значения данных.
<ul>
<li>0: обработчик не выбран.</li>
<li>1: обработчик был выбран.</li>
</ul>
<br/></td>
</tr>
</tbody>
</table>



 

### <a name="registering-a-handler-with-the-disk-cleanup-manager-windows-2000-or-later-systems"></a>регистрация обработчика с помощью диспетчера очистки диска: Windows 2000 или более поздних версий систем

Указание отображаемого текста в реестре может усложнить локализацию программного обеспечения. по этой причине Windows 2000 и Windows XP поддерживают интерфейс [**IEmptyVolumeCache2**](/windows/desktop/api/Emptyvc/nn-emptyvc-iemptyvolumecache2) с предпочтительным методом инициализации [**инитиализикс**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache2-initializeex). в Windows 2000 или более поздней версии всегда выполняется попытка вызвать **IEmptyVolumeCache2:: инитиализикс** перед [**иемптиволумекаче:: Initialize**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache-initialize). Система использует **инициализацию** только для инициализации обработчика, если **IEmptyVolumeCache2** не предоставлен.

в отношении реестра единственным отличием от Windows 2000 и более поздних версий является то, что вы можете опустить значения адванцедбуттонтекст, дисплея и описания, если обработчику предоставлен [**IEmptyVolumeCache2:: инитиализикс**](/windows/desktop/api/Emptyvc/nf-emptyvc-iemptyvolumecache2-initializeex) . Эти значения, содержащие правильно локализованный текст, предоставляются диспетчеру очистки диска при вызове **инитиализикс**.

### <a name="using-the-datadrivencleaner-object"></a>Использование объекта Датадривенклеанер

Базовый обработчик очистки диска, называемый Датадривенклеанер, предоставляется операционной системой. Чтобы использовать этот объект в качестве обработчика вместо реализации собственного, используйте CLSID {C0E13E61-0CC6-11d1-BBB6-0060978B2AE6} в качестве значения по умолчанию для подраздела обработчика в разделе **волумекачес** , как описано в статье [Регистрация обработчика с помощью диспетчера очистки диска: общие](#registering-a-handler-with-the-disk-cleanup-manager-general).

Датадривенклеанер не предоставляет [**IEmptyVolumeCache2**](/windows/desktop/api/Emptyvc/nn-emptyvc-iemptyvolumecache2), поэтому значения отображения и описания предоставляются в реестре. При объявлении этих строк имейте в виду, что это может привести к проблемам локализации. Локализованный текст можно предоставить с помощью значения PropertyBag. Значение Адванцедбуттонтекст игнорируется, так как отсутствует пользовательский интерфейс, и поэтому кнопка не отображается, доступна для этого обработчика.

### <a name="example-registration-of-a-disk-cleanup-handler"></a>Пример регистрации обработчика очистки диска

ниже приведен пример регистрации обработчика очистки диска, реализованного Телефонной компанией. этот обработчик реализует как [**иемптиволумекаче**](/windows/desktop/api/Emptyvc/nn-emptyvc-iemptyvolumecache) , так и [**IEmptyVolumeCache2**](/windows/desktop/api/Emptyvc/nn-emptyvc-iemptyvolumecache2), поэтому предоставляет адванцедбуттонтекст, описание и отображаемые значения на тот случай, если он используется на компьютере, на котором выполняется Windows 98. этот обработчик объединяет значения csid и Folder для поиска файлов в папке C: \\ Program files \\ в Телефон \\ directory Temp, а \_ флаг ддевкф досубдирс установлен таким образом, чтобы его подкаталоги также были просмотрены. Учитываются только те файлы с расширениями TMP и TPC, которые используются для очистки, а \_ флаг ддевкф Private \_ ластакцесс установлен таким образом, чтобы из этих файлов не выполнялся доступ в течение 14 или более дней. \_Также устанавливается флаг ддевкф донтшовифзеро, чтобы обработчик не отображался в списке, если он не нашел кандидатов для очистки.

```
HKEY_LOCAL_MACHINE
   Software
      Microsoft
         Windows
            CurrentVersion
               Explorer
                  VolumeCaches
                     The Phone Company Files
                        (Default) = {the CLSID GUID}
                        AdvancedButtonText = &View Files
                        CleanupString = c:\tpc.exe
                        CSIDL = 0x00000026
                        Description = Old temporary files.
                        Display = The Phone Company Files
                        FileList = *.tmp|*.tpc
                        Flags = 0x10000021
                        Folder = \The Phone Company\Temp
                        IconPath = c:\Program Files\The Phone Company\tpc.dll,2
                        LastAccess = 0x0000000e
                        Priority = 200
                        PropertyBag = {Property Bag CLSID GUID}
```

 

