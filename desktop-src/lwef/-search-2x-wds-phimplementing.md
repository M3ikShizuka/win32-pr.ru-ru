---
title: Реализация обработчика протокола для WDS
description: Создание обработчика протокола включает реализацию Исеарчпротокол для управления объектами Урлакцессор, Иурлакцессор для создания метаданных и для обнаружения соответствующих фильтров для элементов в хранилище данных, Ипротоколхандлерсите для создания экземпляра объекта Сеарчпротокол и для обнаружения соответствующих фильтров, а также для перечисления и фильтрации файлов, расположенных в иерархии.
ms.assetid: d4bcf370-4152-4cfd-a92e-eb9196d23ab4
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 32e33a7ebf6d5f14d0ec4d78031e25b17d59bac5fb99ee7ea6d20046fbe95c78
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119963494"
---
# <a name="implementing-a-protocol-handler-for-wds"></a>Реализация обработчика протокола для WDS

> [!NOTE]
> Windows настольный поиск 2. x — это устаревшая технология, которая изначально была доступна в качестве надстройки для Windows XP и Windows Server 2003. в более поздних выпусках используйте вместо этого [Windows поиск](../search/-search-3x-wds-overview.md) .

Создание обработчика протокола включает реализацию [**исеарчпротокол**](/windows/desktop/api/searchapi/nn-searchapi-isearchprotocol) для управления объектами Урлакцессор, [**иурлакцессор**](/windows/desktop/api/searchapi/nn-searchapi-iurlaccessor) для создания метаданных и для обнаружения соответствующих фильтров для элементов в хранилище данных, ипротоколхандлерсите для создания экземпляра объекта сеарчпротокол и обнаружения соответствующих фильтров, а также [**IFilter**](/windows/desktop/api/filter/nn-filter-ifilter)для фильтрации и фильтрации файлов, хранящихся в иерархическом виде. Обработчик протокола должен быть многопоточным.

В этом разделе содержатся следующие разделы.

-   [Примечание по URL-адресам](#note-on-urls)
-   [Интерфейсы обработчика протокола](#protocol-handler-interfaces)
-   [Фильтры IFilter для контейнеров](#ifilters-for-containers)
-   [Добавление функций параметров обработчика протокола](#adding-protocol-handler-options-functionality)
    -   [исеарчпротоколоптионс](#isearchprotocoloptions)
-   [Связанные темы](#related-topics)

## <a name="note-on-urls"></a>Примечание по URL-адресам

Microsoft Windows Desktop Search (WDS) использует url-адреса для уникальной идентификации элементов в файловой системе, в хранилище, похожем на базу данных, или в интернете. URL-адрес, определяющий узел записи, называется начальной страницей. WDS начинается на этой начальной странице и рекурсивно выполняет обход хранилища данных. Типичная структура URL-адресов:

`protocol://host/path/name.extension`

> [!Note]
>
> Чтобы добавить новое хранилище данных, необходимо выбрать имя, которое будет использоваться для его поиска, которое не конфликтует с текущими. Мы рекомендуем использовать такое соглашение об именовании: companyName. Scheme.

 

## <a name="protocol-handler-interfaces"></a>Интерфейсы обработчика протокола

**исеарчпротокол**

Интерфейс [**исеарчпротокол**](/windows/desktop/api/searchapi/nn-searchapi-isearchprotocol) вызывает, инициализирует и управляет объектами урлакцессор. Дополнительные сведения о реализации интерфейса Исеарчпротокол см. в разделе **Справочник по интерфейсу исеарчпротокол**.

**иурлакцессор**

Для указанного URL-адреса интерфейс [**иурлакцессор**](/windows/desktop/api/searchapi/nn-searchapi-iurlaccessor) создает метаданные о структуре расположения и вложенных элементах, а также привязывает эти элементы к фильтру. Экземпляр объекта **иурлакцессор** создается и инициализируется объектом сеарчпротокол. Однако можно также реализовать внутренний метод инициализации, чтобы объект **иурлакцессор** мог выполнять задачи инициализации, характерные для обработчика протокола, например проверку URL-адреса для элемента, к которому осуществляется доступ, или проверку времени последнего изменения, чтобы определить, должен ли файл обрабатываться в текущем сканировании.

> [!Note]
>
> Изменение времени для каталогов игнорируется. Объект [**иурлакцессор**](/windows/desktop/api/searchapi/nn-searchapi-iurlaccessor) должен перечислить дочерние объекты, чтобы определить, были ли изменения или удаления.

 

Большая часть структуры объекта **урлакцессор** зависит от того, является ли структура иерархической или основанной на компоновке. Для иерархических хранилищ данных объект **урлакцессор** должен найти фильтр, который может перечислить их содержимое. Еще одно различие между иерархическими и обработчиками протоколов на основе ссылок заключается в использовании метода DataDirectory. В обработчиках протоколов на основе связей этот метод должен возвращать \_ значение S false. Обработчики иерархических протоколов должны возвращать значения S \_ ОК для контейнеров.

Дополнительные инструкции по реализации интерфейса [**иурлакцессор**](/windows/desktop/api/searchapi/nn-searchapi-iurlaccessor) см. в справочнике по [**интерфейсу иурлакцессор**](/windows/desktop/api/searchapi/nn-searchapi-iurlaccessor) .

**ипротоколхандлерсите**

Этот интерфейс используется для создания экземпляра объекта **сеарчпротокол** , а также предоставляет объект **урлакцессор** с соответствующим фильтром для УКАЗАННОГО идентификатора класса (CLSID).

## <a name="ifilters-for-containers"></a>Фильтры IFilter для контейнеров

При реализации иерархического обработчика протокола необходимо реализовать компонент контейнера [**IFilter**](/windows/desktop/api/filter/nn-filter-ifilter), который перечисляет URL-адреса, представляющие контейнеры или папки. Процесс перечисления — это цикл по методам **noreturn и** **GetValue** интерфейса IFilter, которые возвращают список URL-адресов, представляющих каждый элемент в контейнере.

Во-первых, функция **фуллпроспек возвращает объект** с набором свойств Set \_ proping и либо:

-   PID \_ ГСР \_ дирлинк, URL-адрес элемента без времени последнего изменения или
-   PID \_ ГСР \_ дирлинк \_ со \_ временем, URL-адрес и время последнего изменения

Набор свойств GUID для набора \_ PROPS — 0B63E343-9CCC-11D0-BCDB-00805FCCCE04. Свойство ПРОПСПЕК имеет значение PID \_ ГСР \_ дирлинк = 2 или PID \_ ГСР \_ дирлинк \_ с параметром \_ time = 12 Decimal.

Возврат PID \_ ГСР \_ дирлинк \_ со \_ временем более эффективен, так как индексатор может немедленно определить, нужно ли индексировать элемент, не вызывая методы исеарчпротокол->Креатеурлакцессор () и иурлакцессор->жетластмодифиед ().

Затем функция **GetValue** возвращает пропвариант для URL-адреса (и время последнего изменения, если используется):

-   VT \_ LPWSTR, URL-адрес дочернего элемента или
-   Вектор URL-адреса, за которым следует FILETIME

В следующем примере кода показано, как создать правильный PID \_ ГСР \_ дирлинк \_ со \_ временем.

> [!Note]
>
> **ЭТОТ КОД И ИНФОРМАЦИЯ ПРЕДОСТАВЛЯЮТСЯ "КАК ЕСТЬ" БЕЗ КАКИХ-ЛИБО ЯВНЫХ ИЛИ ПОДРАЗУМЕВАЕМЫХ ГАРАНТИЙ, ВКЛЮЧАЯ, НО НЕ ОГРАНИЧИВАЯСЬ ПОДРАЗУМЕВАЕМЫМИ ГАРАНТИЯМИ ПРИГОДНОСТИ И (ИЛИ) ПРИГОДНОСТИ ДЛЯ КОНКРЕТНОЙ ЦЕЛИ.**
>
> (C) корпорация Майкрософт (Microsoft Corporation). All rights reserved.

 


```
// params are assumed to be valid

HRESULT GetPropVariantForUrlAndTime(PCWSTR pszUrl, const FILETIME &ftLastModified, PROPVARIANT **ppPropValue)
{
    *ppPropValue = NULL;

    // allocate the propvariant pointer
    *ppPropValue = (PROPVARIANT *)CoTaskMemAlloc(sizeof(*ppPropValue));
    HRESULT hr = *ppPropValue ? S_OK : E_OUTOFMEMORY;

    if (SUCCEEDED(hr))
    {
        PropVariantInit(*ppPropValue);  // zero init the value

        // now allocate enough memory for 2 nested PropVariants.
        // PID_GTHR_DIRLINK_WITH_TIME is an array of 2 PROPVARIANTs
        PROPVARIANT *pVector = (PROPVARIANT *)CoTaskMemAlloc(sizeof(*pVector) * 2);
        hr = pVector ? S_OK : E_OUTOFMEMORY;

        if (SUCCEEDED(hr))
        {
            // set the container PROPVARIANT that it is a vector of 2 PROPVARIANTS
            (*ppPropValue)->vt = VT_VARIANT | VT_VECTOR;
            (*ppPropValue)->capropvar.cElems = 2;
            (*ppPropValue)->capropvar.pElems = pVector;
            PWSTR pszUrlAlloc;
            hr = SHStrDup(pszUrl, &pszUrlAlloc);

            if (SUCCEEDED(hr))
            {
                // now fill the array of PROPVARIANTS
                // put the pointer to the URL into the vector
                (*ppPropValue)->capropvar.pElems[0].vt = VT_LPWSTR; 
                (*ppPropValue)->capropvar.pElems[0].pwszVal = pszUrlAlloc;

                 // put the FILETIME into vector
                (*ppPropValue)->capropvar.pElems[1].vt = VT_FILETIME; 
                (*ppPropValue)->capropvar.pElems[1].filetime = ftLastModified;
            }

            else
            {
                CoTaskMemFree(pVector);
            }
        }
 
        if (FAILED(hr))
        {
            CoTaskMemFree(*ppPropValue);
            *ppPropValue = NULL;
        }
    }
    return S_OK;
}

```



> [!Note]
>
> Компоненту [**IFilter**](/windows/desktop/api/filter/nn-filter-ifilter)контейнера всегда следует перечислять все дочерние URL-адреса, даже если дочерние URL-адреса не изменялись, так как индексатор обнаруживает удаления с помощью процесса перечисления. Если Дата вывода в папке DIR \_ \_ со \_ временем указывает на то, что данные не изменялись, индексатор не обновляет данные для этого URL-адреса.

 

Физический URL-адрес — это URL-адрес, обрабатываемый объектом **урлакцессор** . Если фильтр не создает понятный Дисплайурл, WDS Отображает физический URL-адрес пользователя как часть результатов поиска. Схема WDS содержит два свойства для управления отображением конечного пользователя, как показано в таблице ниже.



| GUID                                 | пропспек      | Описание                                         |
|--------------------------------------|---------------|-----------------------------------------------------|
| D5CDD505-2E9C-101B-9397-08002B2CF9AE | DisplayFolder | Путь к папке, отображаемый пользователю в результатах поиска |
| D5CDD505-2E9C-101B-9397-08002B2CF9AE | FolderName    | Отображаемое имя родительской папки                   |



 

Если код не создает DisplayFolder или имя_папки, эти значения вычисляются из Дисплайурл. Косые черты в контейнерах URL-адреса указываются в хранилище или файловой системе.

## <a name="adding-protocol-handler-options-functionality"></a>Добавление функций параметров обработчика протокола

Чтобы обработчик протокола имел начальную страницу по умолчанию (и URL-адрес узла входа), необходимо реализовать интерфейс **исеарчпротоколоптионс** . В будущих версиях WDS этот интерфейс будет предоставлять обработчики диалогового окна Параметры для улучшения пользовательского интерфейса. Этот интерфейс обеспечивает следующие функциональные возможности:

-   Определяет, выполняются ли требования для обработчика протокола. Например, хранилище обработчика протокола может требовать доступ к конкретному приложению для правильного индексирования данных приложения, но это приложение недоступно.
-   Определяет минимальные требования, необходимые обработчику протокола для обработки элемента. требования могут быть выражены с помощью понятного, локализованного описания, например Microsoft Outlook 2000 или более поздней версии.
-   Определяет URL-адреса, которые обработчик протокола должен обработать по умолчанию.

### <a name="isearchprotocoloptions"></a>исеарчпротоколоптионс

В следующей таблице описаны методы, которые необходимо реализовать для интерфейса **исеарчпротоколоптионс** .



| Метод               | Описание                                                                                             |
|----------------------|---------------------------------------------------------------------------------------------------------|
| чеккрекуирементс    | Определяет, выполняются ли минимальные требования пользовательского обработчика протокола                             |
| жетдефаулткравлскопе | Возвращает список URL-адресов по умолчанию в указанном хранилище для пользовательского обработчика протокола.                   |
| Требования      | Определяет понятное для пользователя локализованное описание минимальных требований для пользовательского обработчика протокола. |



 

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

**Reference**
</dt> <dt>

[Уведомление индекса изменений](-search-2x-wds-notifyingofchanges.md)
</dt> <dt>

[Добавление значков, предварительных версий и контекстных меню с расширениями оболочки](-search-2x-wds-ph-ui-extensions.md)
</dt> <dt>

[Установка и регистрация обработчиков протоколов](-search-2x-wds-ph-install-registration.md)
</dt> </dl>

 

 