---
title: Разработка надстроек IFilter
description: вы можете расширить возможности поиска Microsoft Windows Desktop (WDS) с помощью надстроек фильтров, компонентов, реализующих ифилтеринтерфаце, для включения новых типов файлов.
ms.assetid: 71dd515d-a73e-4e0a-b0da-c8a6209d09fe
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 497d4bffdb9564e0737bee3cd0b63fa8026633a2cc81aad37cb989423e460487
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118480898"
---
# <a name="developing-ifilter-add-ins"></a>Разработка надстроек IFilter

> [!NOTE]
> Windows настольный поиск 2. x — это устаревшая технология, которая изначально была доступна в качестве надстройки для Windows XP и Windows Server 2003. в более поздних выпусках используйте вместо этого [Windows поиск](../search/-search-3x-wds-overview.md) .

вы можете расширить возможности поиска Microsoft Windows Desktop (WDS) с помощью надстроек фильтров, компонентов, реализующих интерфейс [**IFilter**](/windows/desktop/api/filter/nn-filter-ifilter), для включения новых типов файлов. Фильтры отвечают за доступ и синтаксический анализ данных в файлах и для возврата пар свойств и значений, а также фрагментов текста для индексирования. В процессе индексирования WDS вызывает соответствующий фильтр с URL-адресом для каждого файла или элемента. Фильтр сначала извлекает метаданные, соответствующие свойствам, которые помечены как доступные для получения в схеме WDS, например заголовок, размер файла и Дата последнего изменения. Затем содержимое элемента разбивается на фрагменты текста. WDS добавляет в каталог свойства и текст, возвращаемые фильтром. WDS может индексировать файлы любого типа, для которых имеется зарегистрированный фильтр.

В некоторых случаях не требуется создавать новый фильтр. WDS 2. x содержит фильтры для более чем 200 типов элементов (включая элементы с открытым текстом, такие как HTML, XML и файлы исходного кода) и использует ту же технологию [**IFilter**](/windows/desktop/api/filter/nn-filter-ifilter), что и SharePoint Services. Если вы уже установили фильтры для ваших типов файлов, службы WDS смогут использовать существующие фильтры для индексирования этих данных. Кроме того, WDS включает общий фильтр для типов файлов, основанных на тексте. если имеется тип файла, который может быть обработан либо существующим фильтром SharePoint Services, либо фильтром открытого текста, можно добавить расширение имени файла и идентификатор GUID фильтра в реестр, чтобы службы WDS могли найти и использовать его (см. раздел [регистрация надстройки фильтра](#to-register-a-filter-add-in) для получения дополнительных сведений).

Однако если у вас есть необычный и собственный формат данных или файл, написание пользовательской реализации фильтра является единственным способом убедиться, что WDS может индексировать формат файла в каталоге. У вас может быть только одна надстройка фильтра для типа файлов, поэтому можно переопределить существующий фильтр или перекрыть другой фильтр для конкретного типа файлов.

В этом разделе рассматриваются следующие вопросы.

-   [Требуемые интерфейсы фильтра](#required-filter-interfaces)
    -   [Интерфейс IFilter](#ifilter-interface)
    -   [IPersistStream](#ipersiststream)
    -   [IPersistFile](#ipersistfile)
    -   [иперсистстораже](#ipersiststorage)
-   [Вывод свойств с фильтрами](#outputting-properties-with-filters)
    -   [Значения свойств](#property-values)
-   [Установка надстройки фильтра](#filter-add-in-installation)
    -   [Идентификаторы CLSID, необходимые для регистрации](#clsids-required-for-registration)
    -   [Модель регистрации](#registration-model)
    -   [Регистрация надстройки фильтра](#to-register-a-filter-add-in)
-   [Связанные темы](#related-topics)

## <a name="required-filter-interfaces"></a>Требуемые интерфейсы фильтра

Надстройка фильтра должна реализовывать интерфейс [**IFilter**](/windows/desktop/api/filter/nn-filter-ifilter)и один из следующих интерфейсов:

-   [IPersistStream](/windows/win32/api/objidl/nn-objidl-ipersiststream) — для загрузки данных из потока. Это более безопасно, чем использование файлов, так как на диск ничего не записывается. интерфейс IPersistStream является предпочтительным методом для прямой совместимости с Windows Vista.
-   [Интерфейс IPersistFile](/windows/win32/api/objidl/nn-objidl-ipersistfile) — для загрузки данных из файла. этот интерфейс не поддерживается в Windows Vista.
-   [интерфейс иперсистстораже](/windows/win32/api/objidl/nn-objidl-ipersiststorage) — для загрузки данных из структурированных служба хранилища OLE COM.

Надстройка фильтра использует эти интерфейсы, чтобы получить содержимое элемента и вернуть их в индекс до конца файла. Надстройка фильтра должна быть как можно более надежной для обработки поврежденных файлов и тех, которые не соответствуют ожидаемым входным форматам.

### <a name="ifilter-interface"></a>Интерфейс IFilter

Это обязательный интерфейс для реализации фильтра. Дополнительные сведения см. в справочнике по интерфейсу [**IFilter**](/windows/desktop/api/filter/nn-filter-ifilter).



| Метод       | Описание                                                                            |
|--------------|----------------------------------------------------------------------------------------|
| Init ()       | Инициализирует сеанс фильтрации.                                                       |
| "Перефрагментировать" ()   | Размещает фильтр в начале первого или следующего фрагмента и возвращает дескриптор. |
| Gettext ()    | Извлекает текст из текущего фрагмента.                                                 |
| GetValue()   | Извлекает значения свойств из текущего фрагмента.                                      |
| Биндрегион () | В настоящее время зарезервировано для внутреннего использования; не реализуйте. Этот метод возвращает E \_ нотимпл. |



 

### <a name="ipersiststream"></a>IPersistStream

Этот интерфейс загружает файл из потока для более безопасной обработки, чем [интерфейс IPersistFile](/windows/win32/api/objidl/nn-objidl-ipersistfile) , так как контекст, в котором выполняется фильтр [IPersistStream](/windows/win32/api/objidl/nn-objidl-ipersiststream) , не требует наличия прав на открытие файлов на диске или по сети. Из двух методов для доступа к одному файлу это предпочтительный метод для прямой совместимости с Windows.



| Метод       | Описание                                                                                                                                        |
|--------------|----------------------------------------------------------------------------------------------------------------------------------------------------|
| IsDirty ()    | Проверяет, были ли изменения. Этот метод возвращает E \_ нотимпл в фильтрах.                                                                      |
| InitNew ()    | Создает новое хранилище. Этот метод возвращает E \_ нотимпл в фильтрах.                                                                                  |
| Load ()       | Инициализирует объект из потока, в котором он был предварительно сохранен.                                                                               |
| Save ()       | Сохраняет объект в указанном потоке и указывает, должен ли объект сбрасывать свой «грязный» флаг. Этот метод возвращает E \_ нотимпл в фильтрах. |
| Жетсиземакс () | Возвращает размер потока, необходимого для сохранения объекта, в байтах. Этот метод возвращает E \_ нотимпл в фильтрах.                                      |



 

### <a name="ipersistfile"></a>IPersistFile

этот интерфейс загружает файл по абсолютному пути и не поддерживается в Windows Vista.



| Метод          | Описание                                                                                                                  |
|-----------------|------------------------------------------------------------------------------------------------------------------------------|
| Жеткурфиле ()    | Возвращает текущее имя файла, связанного с объектом. Возвращает путь, указанный в Load ().                          |
| Load ()          | Открывает указанный файл и инициализирует объект из содержимого файла. Вы можете отложить открытие файла, пока он не понадобится. |
| -ClassID ()    | Возвращает идентификатор класса (CLSID) для нового типа файла. Для создания уникального идентификатора CLSID следует использовать uuidgen.exe.           |
| IsDirty ()       | Требуется только возврат E \_ нотимпл в фильтрах                                                                                       |
| Save ()          | Требуется только возврат E \_ нотимпл в фильтрах                                                                                       |
| Савекомплетед () | Требуется только возврат E \_ нотимпл в фильтрах                                                                                       |



 

### <a name="ipersiststorage"></a>иперсистстораже

Этот интерфейс поддерживает структурированную модель хранения, в которой каждый содержащийся объект имеет собственное хранилище, вложенное в хранилище контейнера. как и [интерфейс IPersistFile](/windows/win32/api/objidl/nn-objidl-ipersistfile), этот интерфейс загружается по абсолютному пути и не поддерживается в Windows Vista.



| Метод            | Описание                                                                                                   |
|-------------------|---------------------------------------------------------------------------------------------------------------|
| IsDirty ()         | Проверяет, были ли изменения. Этот метод возвращает E \_ нотимпл в фильтрах.                                 |
| InitNew ()         | Создает новое хранилище. Этот метод возвращает E \_ нотимпл в фильтрах.                                             |
| Load ()            | Сохраняет хранилище. Этот метод возвращает E \_ нотимпл в фильтрах.                                                 |
| Save ()            | Возвращает размер потока, необходимого для сохранения объекта, в байтах. Этот метод возвращает E \_ нотимпл в фильтрах. |
| Савекомплетед ()   | Зарезервировано для внутреннего использования. Этот метод возвращает E \_ нотимпл в фильтрах.                                         |
| Хандсоффстораже () | Зарезервировано для внутреннего использования. Этот метод возвращает E \_ нотимпл в фильтрах.                                         |



 

## <a name="outputting-properties-with-filters"></a>Вывод свойств с фильтрами

Назначение фильтра — извлечение содержимого и свойств файлов для включения в полнотекстовый индекс. Сначала WDS вызывает метод Load для реализаций IPersistFile, IPersistStream или Иперсистстораже, а затем вызывает метод init реализации IFilter. Метод **gettext вызывается** для извлечения фрагментов данных текста или значений свойств, а затем метод **gettext** или **GetValue** вызывается столько раз, сколько необходимо для получения всех значений текста или свойств, связанных с фрагментом. Этот процесс повторяется до **тех** пор, пока не будет выводится сообщение о том, что в документе больше нет блоков.

Метод **GetNext** извлекает сведения о первом или следующем логическом блоке данных из фильтруемого файла и возвращает эти сведения в \_ структуре блока Stat, включая монотонно увеличивающийся идентификатор блока, сведения о состоянии текущего фрагмента, относящиеся к предыдущему фрагменту, флаг, указывающий, содержит ли фрагмент текст или значение, языковой стандарт фрагмента и спецификацию свойства блока. Спецификация свойства — это [**фуллпропспек**](/windows/desktop/api/filter/ns-filter-fullpropspec) , состоящий из идентификатора CLSID и целочисленного или строкового свойства (например, D5CDD505-2E9C-101B-9397-08002B2CF9AE/PerceivedType). Он определяет тип свойства, а не само значение свойства.

Идентификатор локали блока используется для выбора подходящего средство разбиения по словам, и очень важно правильно его определить. Если фильтр не может определить языковой стандарт для текста, он должен использовать языковой стандарт системы по умолчанию, доступный с помощью **жетсистемдефаултлЦид**. Если вы управляете форматом файла и в настоящее время он не содержит сведений о языковых стандартах, необходимо добавить функцию пользователя, чтобы обеспечить правильную идентификацию языкового стандарта. Использование непарного средства разбиения по словам может привести к неправильному использованию запросов пользователя.

 Параметр gettext управляет доступом к блокам и не возвращает само значение текста или свойства. Вместо этого последующие вызовы **gettext** и **GetValue** извлекают текст фрагмента. Функция **gettext Возвращает** фрагменты текста, которые являются строками в Юникоде, из текущего \_ ФРАГМЕНТа текста фрагмента. Если текущий фрагмент слишком велик, может потребоваться более одного вызова метода **gettext** . Каждый вызов метода **gettext** извлекает текст, который сразу же следует за текстом из последнего вызова метода **gettext** . Например, последний символ из одного вызова может располагаться в середине слова, а первый символ в следующем вызове продолжит это слово. Механизм поиска должен справиться с этой ситуацией.

Функция **GetValue** возвращает значения свойств для \_ фрагмента текущего значения фрагмента в структурах пропвариант, которые могут содержать разнообразные типы данных. **GetValue** должен выделить структуру пропвариант, используя CoTaskMemAlloc. Вызывающий метод **GetValue** отвечает за освобождение памяти, на которую указывает пропвариант, с помощью пропвариантклеар, а также освобождает структуру с помощью CoTaskMemFree. Дополнительные сведения о Пропвариантс см. в справочнике по [пропвариант](/windows/win32/api/propidlbase/ns-propidlbase-propvariant) .

### <a name="property-values"></a>Значения свойств

Фильтры должны выводить как минимум следующие свойства, которые являются столбцами по умолчанию в представлении результатов WDS.



| GUID                                 | пропспек      | Понятное имя  | Описание                                                                                                                                     |
|--------------------------------------|---------------|----------------|-------------------------------------------------------------------------------------------------------------------------------------------------|
| F29F85E0-4FF9-1068-AB91-08002B27B3D9 | 2             | примарититле   | Заголовок, отображаемый для этого элемента.                                                                                                              |
| F29F85E0-4FF9-1068-AB91-08002B27B3D9 | 4             | примаряусорс | Лицо, наиболее связанное с этим элементом.                                                                                                          |
| D5CDD505-2E9C-101B-9397-08002B2CF9AE | примаридате   | примаридате    | Наиболее важная дата для элемента, например Дата получения сообщения электронной почты или изменения для файлов.                                                               |
| D5CDD505-2E9C-101B-9397-08002B2CF9AE | PerceivedType | PerceivedType  | Тип анализируемого файла. должен соответствовать одному из типов поиска на рабочем столе Windows, перечисленных в списке [наблюдаемый тип](-search-2x-wds-perceivedtype.md)WDS. |



 

Для элементов с открытым текстом WDS извлекает все текстовые и определяемые системой свойства, такие как размер файла или расширение, в том числе новые типы файлов с открытым текстом в индексе). Другие типы свойств, которые могут быть возвращены в индекс, включают:

-   Для файлов: автор, заголовок, состояние, ключевые слова
-   Для мультимедиа: альбом, жанр, Марка камеры, Дата съемки
-   Для связи: от, кому, копия, важность
-   Для контактов: должность, Рабочий телефон, компания

Приведенный выше список группирует свойства, общие с указанным распознанным типом. Однако любое свойство можно использовать независимо от типа. Например, компания может использовать имя работодателя контакта и может также использоваться для ссылки на имя клиента, к которому относится файл. Многие из этих свойств используются для отображения результатов поиска в представлении результатов WDS. Например, свойство Title файла отображается как основной столбец в представлении результатов по умолчанию. Объекты IFilter должны выводить все свойства, связанные с типом элемента, который они анализируют. Пользовательские свойства нельзя добавить в WDS 2. x. Полный список доступных свойств см. в статье [схема WDS](-search-2x-wds-schematable.md).

## <a name="filter-add-in-installation"></a>Установка надстройки фильтра

Установка фильтра предполагает копирование библиотеки DLL в соответствующее расположение в каталоге Program Files и его регистрацию. Фильтры должны реализовать самостоятельную регистрацию для установки и следовать приведенным ниже рекомендациям.

-   Установщик должен использовать установщик EXE или MSI.
-   Необходимо указать заметки о выпуске.
-   Для каждой установленной надстройки необходимо создать запись « **Установка и удаление программ** ».
-   Установщик должен задействовать все параметры реестра для конкретного типа файлов или хранить данные, распознаваемые текущей надстройкой.
-   Если предыдущая надстройка перезаписывается, установщик должен уведомить пользователя.
-   Если более новая надстройка перезаписала предыдущую надстройку, то должна быть возможность восстановить функциональность предыдущей надстройки и сделать ее надстройкой по умолчанию для этого типа файла или хранилища.

### <a name="clsids-required-for-registration"></a>Идентификаторы CLSID, необходимые для регистрации

Существует три идентификатора класса (CLSID), связанных с каждым фильтром. Необходимо создать один или несколько из них (используйте uuidgen.exe) для регистрации надстройки фильтра.

-   Первый определяет постоянный обработчик, IID \_ IFilter, который имеет значение {89BCB740-6119-101A-BCB7-00DD010655AF}. Этот идентификатор CLSID является константой для всех фильтров, реализующих интерфейс IFilter.
-   Второй (значение \_ ключа IFILTER IID) определяет реализацию IFilter для типа файла. Этот ключ содержит значение InprocServer32, указывающее имя библиотеки DLL по пути и потоковой модели. Если фильтр находится в системном пути, например в каталоге System32, достаточно имени файла. В противном случае это значение должно иметь полную спецификацию пути.
-   Третья определяет тип файла, который обрабатывает фильтр, и возвращается методом WebMethod в интерфейсе IPersist.

> [!Note]
>
> В будущих версиях операционных систем Майкрософт установка файлов в каталоге System32 может оказаться более сложной, поэтому рекомендуется установить их в разделе Program Files и включить полный путь к фильтру в реестре. По соображениям безопасности также целесообразно указать полный путь к библиотеке DLL в реестре. В противном случае можно загрузить версию библиотеки DLL «троянский конь», если она будет находиться в пути обработки до вашей версии.

 

### <a name="registration-model"></a>Модель регистрации

Когда WDS готова к фильтрации файла, он ищет в реестре расширение файла, чтобы определить, какой именно фильтр нужно загрузить. Затем он выполняет ряд ссылок реестра для поиска имени библиотеки DLL фильтра в следующем порядке:

1.  Из идентификаторов CLSID, расположенных по адресу:

    **HKEY \_ текущее \_ пользовательское \\ программное обеспечение \\ Microsoft \\ рссеарч \\ контентиндекскоммон \\ Filters \\ override \\ рсапп**

    **HKEY \_ текущее \_ пользовательское \\ программное обеспечение \\ Microsoft \\ рссеарч \\ контентиндекскоммон \\ Filters**

2.  Из типа содержимого файла в:

    **\_ \_ \\ \\ \\ \\ Тип содержимого базы данных MIME для классов \\ по локальному компьютеру hKey**

3.  Из расширения имени файла (то же, что и Win32 Лоадифилтер API) в:

    **HKEY \_ текущее \_ пользовательское \\ программное обеспечение \\ Microsoft \\ рссеарч \\ контентиндекскоммон \\ Filters \\ override \\ рсапп**

    **HKEY \_ текущее \_ пользовательское \\ программное обеспечение \\ Microsoft \\ рссеарч \\ контентиндекскоммон \\ Filters**

    **\_Классы hKey \_ root \\ ЕКСТПЕРСИСТЕНСАНДЛЕР->CLSID->IID \_ IFilter->CLSID**

4.  По умолчанию:

    **HKEY \_ локальный \_ компьютер \\ программное обеспечение \\ Microsoft \\ рссеарч \\ контентиндекскоммон \\ Filters**

### <a name="to-register-a-filter-add-in"></a>Регистрация надстройки фильтра

Чтобы зарегистрировать надстройку фильтра, необходимо сделать всего восемь записей в реестре, где:

-   **. ext** — новое расширение имени файла.
-   **GUID \_ 1** может быть любым новым идентификатором GUID, созданным для этого расширения.
-   **89BCB740-6119-101A-BCB7-00DD010655AF** — это GUID интерфейса IFilter, который является константой для всех реализаций IFilter.

1.  Зарегистрируйте постоянный обработчик для расширения имени файла со следующими ключами и значениями:

    ```
    HKEY_CLASSES_ROOT\<.ext>\PersistentHandler
       (Default) = {GUID_1}
    ```

    ```
    HKEY_CLASSES_ROOT\CLSID\{GUID_1}
       (Default) = <Persistent Handler Description>
    ```

    ```
    HKEY_CLASSES_ROOT\CLSID\{GUID_1}\PersistentAddinsRegistered
       (Default) = (Value Not Set)
    ```

    ```
    HKEY_CLASSES_ROOT\CLSID\{GUID_1}\PersistentAddinsRegistered\{89BCB740-6119-101A-BCB7-00DD010655AF}
       (Default) = {CLSID of IFilter implementation}
    ```

    ```
    HKEY_CLASSES_ROOT\CLSID\{GUID_1}\PersistentHandler
       (Default) = {GUID_1}
    ```

2.  Зарегистрируйте реализацию IFilter со следующими ключами и значениями:

    ```
    HKEY_CLASSES_ROOT\CLSID\{CLSID of IFilter implementation}
       (Default) = Extension IFilter Description">
    ```

    ```
    HKEY_CLASSES_ROOT\CLSID\{CLSID of IFilter implementation}\InprocServer32
       (Default) = <DLL Install Path>
       ThreadingModel = Both
    ```

3.  зарегистрируйте реализацию IFilter с помощью Windows Desktop Search со следующими ключами и значением:

    ```
    HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\RSSearch\ContentIndexCommon\Filters\Extension\<.ext>
       (Default) = {CLSID of IFilter implementation}"
    ```

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

**Reference**
</dt> <dt>

[счематабле](-search-2x-wds-schematable.md)
</dt> <dt>

[Наблюдаемые типы](-search-2x-wds-perceivedtype.md)
</dt> <dt>

[Разработка обработчиков протоколов](-search-2x-wds-phaddins.md)
</dt> <dt>

**Другие ресурсы**
</dt> <dt>

[**IFilter**](/windows/desktop/api/filter/nn-filter-ifilter)
</dt> </dl>

 

 