---
title: Протокол служб индексирования содержимого
description: Этот документ является спецификацией протокола службы индексирования содержимого.
ms.assetid: b91c8038-5ace-441d-8523-60f849ff1458
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0df48db5dd1b19983b12daeb6747dce92eedcd78674553f11af2e335f08e7de5
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118481146"
---
# <a name="content-indexing-services-protocol"></a>Протокол служб индексирования содержимого

> [!NOTE]
> Windows настольный поиск 2. x — это устаревшая технология, которая изначально была доступна в качестве надстройки для Windows XP и Windows Server 2003. в более поздних выпусках используйте вместо этого [Windows поиск](../search/-search-3x-wds-overview.md) .

Спецификация протокола, версия 0,12

-   [1 Введение](#1-introduction)
    -   [1.1. Глоссарий](#11-glossary)
    -   [1.2. Ссылки](#12-references)
    -   [Общие сведения о протоколе 1,3 (краткий обзор)](#13-protocol-overview-synopsis)
    -   [1.4. Связь с другими протоколами](#14-relationship-to-other-protocols)
    -   [1,5. Предварительные условия](#15-prerequisites-and-preconditions)
    -   [1.6. Постановление о пределах применения](#16-applicability-statement)
    -   [1.7. Управление версиями и согласованность функций](#17-versioning-and-capability-negotiation)
    -   [1.8. Расширяемые поля поставщика](#18-vendor-extensible-fields)
    -   [1.9. Назначения стандартов](#19-standards-assignments)
-   [2. Сообщения](#2-messages)
    -   [2.1. Транспортировка](#21-transport)
    -   [2.2. Синтаксис сообщений](#22-message-syntax)
-   [3. Сведения о протоколе](#3-protocol-details)
    -   [Сведения о сервере 3,1](#31-server-details)
    -   [3,2. сведения о клиенте](#32-client-details)
-   [4. Примеры протокола](#4-protocol-examples)
    -   [4,1 Пример 1](#41-example-1)
    -   [4,2. Пример 2](#42-example-2)
-   [5. Безопасность](#5-security)
    -   [5.1. Вопросы безопасности для разработчиков](#51-security-considerations-for-implementers)
    -   [5.2. Индекс параметров безопасности](#52-index-of-security-parameters)
-   [6 индекс поведения, зависящего от версии](#6-index-of-version-specific-behavior)

Этот документ является спецификацией протокола службы индексирования содержимого.

документация по серверной протоколу для рабочих групп (WSPP) предназначена для использования в сочетании с документацией по общедоступным стандартам, графикой программирования сетей и Windows концепциями распределенных систем рабочей группы, и предполагает, что читатель знаком с упомянутым материалом или имеет немедленный доступ к нему.

Спецификация протокола WSPP не требует использования средств программирования Майкрософт или сред программирования, чтобы лицензироваться на разработку реализации. Лицензии, имеющие доступ к средствам и средам программирования Майкрософт, могут воспользоваться преимуществами этих средств.

## <a name="1-introduction"></a>1. Введение

-   [1.1. Глоссарий](#11-glossary)
-   [1.2. Ссылки](#12-references)
-   [Общие сведения о протоколе 1,3 (краткий обзор)](#13-protocol-overview-synopsis)
-   [1.4. Связь с другими протоколами](#14-relationship-to-other-protocols)
-   [1,5. Предварительные условия](#15-prerequisites-and-preconditions)
-   [1.6. Постановление о пределах применения](#16-applicability-statement)
-   [1.7. Управление версиями и согласованность функций](#17-versioning-and-capability-negotiation)
-   [1.8. Расширяемые поля поставщика](#18-vendor-extensible-fields)
-   [1.9. Назначения стандартов](#19-standards-assignments)

### <a name="11-glossary"></a>1.1. Глоссарий

> [!Note]  
> Следующие термины определены в разделе глоссария в \[ MS-sys \] :
>
> -   GUID
> -   Прямой порядок байтов
> -   Именованный канал
> -   Путь

 

**Binding**: запрос на включение определенного **столбца** в возвращенный **набор строк** . **Привязка** указывает свойство, включаемое в результаты поиска.

**Bookmark**: маркер, однозначно определяющий строку в наборе строк.

**Catalog**— единица организации высшего уровня в службе индексирования. Он представляет собой набор индексированных документов, по которым можно выполнять запросы с помощью протокола службы индексирования содержимого.

**Категория**: Иерархическое группирование строк. Например, результат запроса, содержащий столбцы Author и Title, можно классифицировать на основе автора. Каждая группа строк, содержащая одно и то же значение для автора, будет составлять категорию.

**Глава** : диапазон **строк** в наборе **строк** .

**Column**: контейнер для одного типа данных в **строке** . Столбцы сопоставляются с именами свойств и указывают, какие свойства используются для элементов **дерева** **команд** в поисковом запросе.

**Дерево команд**: сочетание **ограничений** , **категорий** и **порядков сортировки** , заданных для поискового запроса.

**Cursor**: сущность, используемая в качестве механизма для работы с одной **строкой** или небольшим блоком **строк** за раз в наборе данных, возвращаемых в результирующем наборе. **Курсор** располагается на одной **строке** в результирующем наборе. После того как **курсор** находится в строке, операции могут выполняться над этой **строкой** или в блоке **строк** , начиная с этой позиции.

**Handle**— маркер, который можно использовать для распознавания и доступа к **курсорам** , **главам** и **закладкам** .

**Index**: Постоянная структура, содержащая текстовое содержимое, извлеченное из файлов **службой индексирования** . Сюда входит список слов, которые хранятся вместе с содержащимся именем файла, расположением Word и **языковым стандартом** .

**Индексирование**. процесс извлечения текста и свойств из файлов и сохранения извлеченных значений в **индексах** (для текста) и в **кэше свойств** (для свойств).

**Служба индексирования**: служба, которая создает индексированные **каталоги** для содержимого и свойств файловых систем. Приложения могут искать в каталогах сведения из файлов в индексированной файловой системе.

**Языковой стандарт**: идентификатор, как указано в \[ приложении MS-GPSI, \] который указывает предпочтения, связанные с языком. Эти настройки указывают, как форматируются даты и время, элементы сортируются в алфавитном порядке, сравниваются по строкам и т. д.

**Запрос на естественном языке**. запрос, построенный на языке человека вместо синтаксиса запроса.

**Пропускаемое слово**: слово, которое игнорируется службой индексирования, если оно существует в **ограничениях** , указанных для поискового запроса, так как у него малое значение для дискриминатора. Примеры на английском языке: "a", "and" и "The".

**Кэш свойств**: кэш свойств файла, извлеченных **службой индексирования** .

**Индексирование свойств**. процесс создания **индекса** **свойств типа «значение** » документа, включая автора, тему, тип, число слов, число печатных страниц и другие свойства.

**Ограничение**: набор условий, которым должен соответствовать файл, включаемый в результаты поиска, возвращенные **службой индексирования** в ответ на поисковый запрос. **Ограничение** ограничивает фокус поискового запроса, ограничивая файлы, которые **Служба индексирования** будет включать в результаты поиска, только те, которые соответствуют условиям.

**Row**: коллекция **столбцов** , содержащая значения свойств, которые описывают отдельный файл из набора файлов, соответствующих **ограничениям** , указанным в поисковом запросе, отправленном в **службу индексирования** .

**Набор строк: набор** **строк** , возвращаемых в результатах поиска.

**Порядок сортировки**. набор правил в поисковом запросе, который определяет порядок строк в результатах поиска. Каждое правило состоит из свойства (имя, размер и т. д.) и направления упорядочения (по возрастанию или по убыванию). Несколько правил применяются последовательно.

**Свойство текстового типа**: свойство, которое описывает содержимое документа и имеет только неформатированный текст, связанный с его именем.

**Свойство типа значения**— свойство, которое описывает один атрибут всего документа. Свойство типа значения имеет идентификатор типа данных и значение этого типа данных, связанное с его именем.

**Виртуальный корневой каталог**: альтернативный путь к папке. У физической папки может быть не более одного виртуального корня. Пути, начинающиеся с виртуального корня, называются виртуальными путями. Например,/сервер/ванитирут может быть виртуальным корнем C: \\ IIS \\ Web \\ папка1. Затем файл C: \\ IIS \\ web \\ папка1 \\default.htm будет иметь виртуальный путь/сервер/ванитирут/default.htm.

**Может**, не должен, не обязательно: эти термины (во всех прописных) используются, как описано в \[ RFC2119 \] . Во всех необязательных инструкциях используются термины MAY (ВОЗМОЖНО), SHOULD (СЛЕДУЕТ) или SHOULD NOT (НЕ СЛЕДУЕТ).

### <a name="12-references"></a>1.2. Ссылки

### <a name="121-normative-references"></a>1.2.1. Нормативные ссылки

\[IEEE754 \] институт инженеров по стандартизации и электронике, "Standard для Floating-Point арифметических операций", IEEE 754-1985, 1985 октября, https://standards.ieee.org/standard/754-1985.html

\[MS-DCOM \] корпорации Майкрософт, «распределенные протоколы модели объектов Distributed Component», 2006 июня.

\[MS-GPSI \] Microsoft Corporation, "Групповая политика установки программное расширение", июнь 2006 г.

\[MS-SMB \] Корпорация Майкрософт, Microsoft (протокол SMB) и расширения, май 2006.

\[MS-SYS Корпорация \] Майкрософт, "системный обзор v4", июль 2006.

\[САЛТОН \] Салтон, G., "Автоматическая обработка текста: анализ преобразования и извлечение информации по компьютерам", 1988, ISBN 0-201-2227-8.

\[Unicode \] Consortium (Unicode Standard, версия 2,0, 1996, https://www.unicode.org

### <a name="122-informative-references"></a>1.2.2. Справочные ссылки

\[MSDN-OLEDB \] корпорации Майкрософт, OLE DB, https://msdn.microsoft.com/library/default.asp?url=/library/oledb/htm/dasdkoledboverview.asp .

\[MSDN — КУЕРЕРР \] корпорации Майкрософт, Query-Execution значения https://msdn.microsoft.com/library/default.asp?url=/library/indexsrv/html/ixreferr\_5df7.asp

### <a name="13-protocol-overview-synopsis"></a>Общие сведения о протоколе 1,3 (краткий обзор)

**Служба индексирования** содержимого помогает эффективно организовывать извлеченные функции коллекции документов. Протокол службы индексирования содержимого (CISP) позволяет клиенту взаимодействовать с сервером, на котором размещена служба индексирования, выдавать запросы и предоставлять администратору возможность управлять сервером индексирования.

При обработке файлов служба индексирования анализирует набор документов и реорганизует их содержимое таким образом, что **Свойства** этих документов могут быть эффективно возвращены в ответ на запросы. Коллекция документов, которые можно запросить, состоит из **каталога** . Каталог может содержать **индекс** (для быстрого получения ссылки на текст) и **кэш свойств** (для быстрого извлечения значений свойств).

По сути, каталог состоит из логической "таблицы" свойств с текстом или значением и соответствующим языковым стандартом, хранящимся в **столбцах** таблицы. Каждая строка таблицы соответствует отдельному документу в области каталога, а каждый столбец таблицы соответствует свойству.

Конкретные задачи, выполняемые CISP, группируются в две функциональные области:

-   Удаленное администрирование каталогов служб индексирования,
-   Удаленное выполнение запросов к каталогам службы индексирования.

### <a name="131-remote-administration-tasks"></a>Задачи удаленного администрирования 1.3.1

CISP включает следующие задачи управления каталогом служб индексирования из клиента.

-   Запрашивает текущее состояние каталога служб индексирования на сервере.
-   Обновление состояния каталога служб индексирования.
-   Запуск процесса индексирования для определенного набора файлов.
-   Инициация оптимизации индекса для повышения производительности запросов.

Все задачи удаленного администрирования следуют простой модели "запрос-ответ". На клиенте не ведется никаких состояний для вызова администрирования, и административные вызовы могут выполняться в любом порядке.

### <a name="132-remote-querying"></a>1.3.2 удаленный запрос

CISP позволяет клиентам выполнять поисковые запросы к удаленному серверу, на котором размещена служба индексирования.

Отправка поискового запроса — это многоэтапный процесс, инициированный клиентом. Для этого необходимо выполнить следующие шаги:

1.  Клиент запрашивает соединение с сервером, на котором размещена служба индексирования.
2.  Клиент отправляет параметры поискового запроса, в том числе следующие:
    -   **Ограничения** , указывающие, какие документы должны включаться и (или) исключены из результатов поиска.
    -   Порядок, в котором должны возвращаться результаты поиска.
    -   Столбцы, возвращаемые в результирующем наборе.
    -   Максимальное число **строк** , которое должно быть возвращено для запроса.
    -   Максимальное время выполнения запроса.

        После того как сервер подтвердил запрос клиента на инициацию запроса, клиент может запросить сведения о состоянии запроса, но это не обязательное действие.

3.  Затем клиент указывает, какие свойства сервер должен включать в результаты поиска.
4.  Клиент запрашивает результирующий набор от сервера, а сервер отвечает, отправляя клиенту значения свойств для файлов, включенных в результаты поискового запроса клиента. Если значение свойства слишком велико для одного буфера ответа, сервер не будет передавать свойство, а вместо этого установит для свойства значение отложено. Затем клиент запрашивает значение свойства отдельно, используя последовательность запросов для последовательных блоков значения, а затем возобновляет запрос других значений.
5.  Когда клиент завершает работу с поисковым запросом и больше не требует дополнительных результатов, клиент обращается к серверу для освобождения запроса.
6.  После того, как сервер выпустил запрос, клиент может отправить запрос на отключение от сервера. После этого соединение закрывается. Кроме того, клиент может отправить еще один запрос и повторить последовательность из шага 2.

Windows поведение. этот протокол реализован на Windows 2000, Windows XP, Windows Server 2003 и Windows Vista.

### <a name="14-relationship-to-other-protocols"></a>1.4. Связь с другими протоколами

CISP использует \[ протокол SMB MS-SMB \] для передачи сообщений. Никакой другой протокол не зависит непосредственно от протокола службы индексирования содержимого.

*Windows Поведение. Обычно приложения взаимодействуют с оболочкой интерфейса OLE DB \[ MSDN-OLEDB \] (например, клиент протокола), а не напрямую с протоколом.*

### <a name="15-prerequisites-and-preconditions"></a>1,5. Предварительные условия

Предполагается, что клиент получил имя сервера и имя каталога перед вызовом этого протокола. То, как клиент делает это, лежит вне области данной спецификации.

Также предполагается, что клиент и сервер имеют сопоставление безопасности, которое можно использовать с именованными каналами \[ MS-SMB \] .

### <a name="16-applicability-statement"></a>1.6. Постановление о пределах применения

CISP предназначен для запросов и управления каталогами на удаленном сервере от клиента. CISP не рекомендуется использовать в Windows Vista.

### <a name="17-versioning-and-capability-negotiation"></a>1.7. Управление версиями и согласованность функций

Этот протокол не имеет механизмов управления версиями или согласования возможностей.

### <a name="18-vendor-extensible-fields"></a>1.8. Расширяемые поля поставщика

Этот протокол использует значения HRESULT, которые являются расширяемыми поставщиками. Поставщики могут выбирать собственные значения для этого поля, если бит C (0x20000000) задан в соответствии с разделом 4.1.1 в MS-SYS, что означает, что это \[ \] код клиента.

Этот протокол также использует значения NTSTATUS, взятые из числового пространства NTSTATUS, определенного в \[ MS-sys \] . Поставщики должны повторно использовать эти значения с указанным значением. Выбор любого другого значения вызывает риск конфликта в будущем.

*Windows поведение. Windows использует только значения, указанные в разделе 4.1.3 \[ MS-SYS \] .*

### <a name="181-property-ids"></a>Идентификаторы свойств 1.8.1

Свойства представлены идентификаторами, известными как идентификаторы свойств. Каждое свойство должно иметь глобальный уникальный идентификатор. Этот идентификатор состоит из **идентификатора GUID** , представляющего коллекцию свойств, которые называются набором свойств, а также строки или 32-разрядного целого числа для идентификации свойства в наборе. Если используется целочисленная форма идентификатора, значения 0x00000000, 0xFFFFFFFF и 0xFFFFFFFE считаются недопустимыми.

Поставщики могут гарантировать, что их свойства определяются уникальным образом, помещая их в набор свойств, определенный их собственным идентификатором GUID.

### <a name="19-standards-assignments"></a>1.9. Назначения стандартов

Этот протокол не имеет стандартных назначений, а только частные назначения, выполняемые корпорацией Майкрософт с использованием процедур распределения, заданных в других протоколах.

Корпорация Майкрософт выделила этот протокол именованным каналом, как указано в \[ MS-SMB \] . Назначение:



| Параметр | Значение             | Справочник  |
|-----------|-------------------|------------|
| Имя канала | \\\\скадс элемента конфигурации канала \_ | \[MS-SMB\] |



 

## <a name="2-messages"></a>2. Сообщения

-   [2.1. Транспортировка](#21-transport)
-   [2.2. Синтаксис сообщений](#22-message-syntax)

### <a name="21-transport"></a>2.1. Транспортировка

Все сообщения должны быть перенесены с помощью именованного канала, как указано в \[ MS-SMB \] . Используется следующее имя канала:

-   \\\\скадс элемента конфигурации канала \_

Этот протокол использует базовый протокол именованных каналов SMB для получения удостоверения вызывающей стороны, который установил подключение, как указано в разделе 2.2.8 \[ MS-SMB \] ; клиент должен задать идентификатор безопасности в \_ качестве имперсонатионлевел в запросе, чтобы открыть именованный канал.

### <a name="22-message-syntax"></a>2.2. Синтаксис сообщений

Несколько структур и сообщений в следующих разделах относятся к маркерам глав или закладок. Маркер представляет собой 32-разрядную непрозрачную структуру, которая однозначно определяет главу или закладку. Как правило, клиентские приложения получают значения обработчиков через вызовы методов; Однако существует несколько хорошо известных значений, которые не нужно получать с сервера, значение которого указано в следующей таблице:



| Значение                         | Значение                                                                      |
|-------------------------------|------------------------------------------------------------------------------|
| База данных \_ null \_ параметру hChapter 0x00000000 | Маркер главы для набора строк с неразбитым набором, содержащий все результаты запроса.    |
| ДББМК, \_ первый 0x00000001       | Маркер закладки, указывающий первую строку в наборе строк. |
| ДББМК \_ последний 0x00000002        | Маркер закладки для закладки, определяющей последнюю строку в наборе строк.  |



 

### <a name="221-structures"></a>2.2.1 структуры

В этом разделе описываются структуры данных, которые определяются и используются CISP.

Все 2-, 4-и 8-байтовые целые числа со знаком и без знака в следующих структурах должны передаваться с прямым порядком байтов.

В следующей таблице перечислены структуры данных, определенные в этом разделе.



| Структура                    | Описание                                                                                                            |
|------------------------------|------------------------------------------------------------------------------------------------------------------------|
| кбасесторажевариант          | Содержит значение, по которому выполняется операция сопоставления для свойства, указанного в структуре Кпропертирестриктион. |
| SAFEARRAY, SAFEARRAY2        | Содержит многомерный массив.                                                                                     |
| сафеаррайбаунд               | Представляет границы для измерения массива, указанного в структуре SAFEARRAY.                                  |
| кфуллпропспек                | Содержит спецификацию свойства.                                                                                     |
| кконтентрестриктион          | Содержит строку, соответствующую значению свойства в кэше свойств.                                                 |
| ккэй                         | Содержит значение свойства.                                                                                             |
| Цинтерналпропертирестриктион | Содержит значение свойства для сопоставления с операцией.                                                                  |
| кнатлангуажерестриктион      | Содержит запрос на естественном языке для свойства.                                                                |
| кнодерестриктион             | Содержит массив узлов дерева команд, задающий ограничения для запроса.                                       |
| коккрестриктион              | Содержит расположение слова в фразе.                                                                           |
| кпропертирестриктион         | Содержит значение свойства для сопоставления с операцией.                                                                  |
| кранжерестриктион            | Содержит ограничение на диапазон значений.                                                                           |
| кскоперестриктион            | Содержит ограничение на файлы для поиска.                                                                    |
| ксорт                        | Определяет столбец для сортировки.                                                                                           |
| ксинрестриктион              | Содержит слово или его синонимы для фразы запроса.                                                                    |
| квекторрестриктион           | Содержит взвешенное значение или операцию для узла дерева команд.                                                               |
| квордрестриктион             | Содержит слово для фразы запроса.                                                                                    |
| крестриктион                 | Содержит узел дерева команд запроса.                                                                               |
| кколумнсет                   | Указывает число возвращаемых столбцов.                                                                             |
| ккатегоризатионсет           | Содержит сведения о группировании набора результатов запроса.                                                     |
| ккатегоризатионспек          | Содержит определение категорий, в которых будут классифицироваться результаты запроса.                                      |
| кдбколид                     | Содержит столбец.                                                                                                     |
| кдбпроп                      | Содержит свойство.                                                                                                   |
| кдбпропсет                   | Содержит набор свойств.                                                                                          |
| кпидмаппер                   | Содержит массив идентификаторов свойств, указывающих свойства, возвращаемые в наборе строк.                                     |
| кровсикат                   | Содержит смещение для получения строк в сообщении Кпмжетровсин                                                |
| кровсикатратио              | Определяет точку, с которой начинается извлечение сообщения Кпмжетровсин.                                           |
| кровсикбибукмарк           | Определяет закладки, из которых извлекаются строки для сообщения Кпмжетровсин.                                       |
| кровсикнекст                 | Содержит число строк, которые необходимо пропустить в сообщении Кпмжетровсин.                                                         |
| кровсетпропертиес            | Содержит сведения о конфигурации для запроса.                                                                    |
| ксортсет                     | Содержит порядок сортировки для запроса.                                                                                   |
| ктаблеколумн                 | Содержит столбец для сообщения Кпмсетбиндингс.                                                                      |
| сериализедпропертивалуе      | Содержит сериализованное значение.                                                                                           |



 

### <a name="2211-cbasestoragevariant"></a>2.2.1.1 Кбасесторажевариант

Структура Кбасесторажевариант содержит значение, по которому выполняется операция сопоставления для свойства, указанного в структуре Кпропертирестриктион.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

втипе

vData1

vData2

Управляемое vValue (переменная)



 

**втипе**: признак типа, указывающий тип управляемое vValue. Это должно быть одно из значений VARENUM, указанных в следующей таблице.



| Значение                 | Значение                                                                                                                              |
|-----------------------|--------------------------------------------------------------------------------------------------------------------------------------|
| VT \_ Empty (символ 0x0000)    | Управляемое vValue отсутствует.                                                                                                               |
| VT \_ null (0x0001)     | Управляемое vValue отсутствует.                                                                                                               |
| VT \_ I1 (0x0010)       | 1-байтовое целое число со знаком.                                                                                                             |
| VT \_ UI1 (0x0011)      | 1-байтовое целое число без знака.                                                                                                           |
| VT \_ I2 (0x0002)       | 2-байтовое целое число со знаком.                                                                                                             |
| VT \_ UI2 (0x0012)      | 2-байтовое целое число без знака.                                                                                                           |
| Логическое значение VT \_ (0x000B)     | Логическое значение; 2-байтовое целое число, содержащее символ 0x0000 (FALSE) или 0xFFFF (TRUE).                                                        |
| VT \_ I4 (0x0003)       | 4-байтовое целое число со знаком.                                                                                                             |
| VT \_ UI4 (0x0013)      | 4-байтовое целое число без знака.                                                                                                           |
| VT \_ R4 (0x0004)       | 32-разрядное число с плавающей запятой, определенное в \[ IEEE754 \] .                                                                     |
| VT \_ int (0x0016)      | 4-байтовое целое число со знаком.                                                                                                             |
| VT \_ uint (0x0017)     | 4-байтовое целое число без знака.                                                                                                           |
| \_Ошибка VT (0x000A)    | 4-байтовое целое число без знака, содержащее значение HRESULT, как указано в \[ MS-sys \] .                                                         |
| VT \_ I8 (0x0014)       | 8 байт целое число со знаком.                                                                                                            |
| VT \_ UI8 (0x0015)      | 8-байтовое целое число без знака.                                                                                                          |
| VT \_ R8 (0x0005)       | 64-разрядное число с плавающей запятой, определенное в \[ IEEE754 \] .                                                                      |
| VT \_ CY (0x0006)       | 8-байтное дополнение к целому числу (с масштабированием на 10 000).                                                                               |
| \_Дата VT (0x0007)     | 64-разрядное число с плавающей запятой, представляющее количество дней с момента 00:00:00 31 декабря 1899 (координированное время в формате UTC).     |
| VT \_ fileTime (0x0040) | 64-разрядное целое число, представляющее число интервалов 100-наносекундных с 00:00:00 по 1 января 1601 г. (координированное время в формате UTC). |
| VT \_ Decimal (0x000E)  | ДЕСЯТИЧная структура, как указано в разделе 2.2.1.1.1.1.                                                                             |
| VT \_ CLSID (0x0048)    | 16-байтовое двоичное значение, содержащее идентификатор GUID.                                                                                            |
| \_Большой двоичный объект VT (0x0041)     | Целое число без знака размером 4 байта в большом двоичном объекте, за которым следует множество байтов данных.                                           |
| VT \_ BSTR (0x0008)     | Целое число без знака длиной 4 байта в строке, за которым следует строка, как указано ниже в разделе управляемое vValue.                       |
| VT \_ LPSTR (0x001E)    | Строка ANSI, заканчивающаяся нулем.                                                                                                       |
| VT \_ LPWSTR (0x001F)   | Строка Юникода в Юникоде, заканчивающаяся нулем \[ \] .                                                                                        |
| \_Вариант VT (0x000C)  | Кбасесторажевариант. НЕОБХОДИМО сочетать с модификатором типа в \_ массиве VT или в \_ векторе VT.                                               |



 

В следующей таблице указаны модификаторы типа для Втипе. Модификаторы типа могут быть двоичными ORed с Втипе, чтобы изменить значение управляемое vValue, чтобы указать, что это один из двух возможных типов массивов.



| Значение               | Значение                                                                                                                                                                                                                                                                                                                                                            |
|---------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| \_Вектор VT (0x1000) | Если индикатор типа сочетается с \_ вектором VT с помощью оператора OR, управляемое vValue является подсчитанным массивом значений указанного типа. Дополнительные сведения см. в разделе 2.2.1.1.1.2. <br/> Этот модификатор типа не должен сочетаться со следующими типами: VT \_ int, VT \_ uint, Decimal, VT \_ , BLOB- \_ \_ объект VT \_ .<br/>                                    |
| \_Массив VT (0x2000)  | Если индикатор типа сочетается с \_ массивом VT с помощью оператора OR, это значение является массивом SAFEARRAY (как указано в разделе 2.2.1.1.1.3), содержащим значения указанного типа. <br/> Этот модификатор типа не должен сочетаться со следующими типами: VT \_ i8, VT \_ UI8, VT \_ FILETIME, VT \_ CLSID, \_ BLOB VT, \_ \_ объект объекта VT, VT \_ LPSTR, VT \_ LPWSTR. <br/> |



 

**vData1**: Если втипе имеет тип VT \_ Decimal, значение этого поля указывается в качестве поля масштабирования в разделе 2.2.1.1.1.1. Для всех остальных Втипес значение должно быть равно 0x00.

**vData2**: Если втипе имеет тип VT \_ Decimal, значение этого поля указывается как поле подписи в разделе 2.2.1.1.1.1. Для всех остальных Втипес значение должно быть равно 0x00.

**управляемое vValue**: значение для операции сопоставления. Синтаксис должен быть указан в поле Втипе.

В следующей таблице приведены размеры для поля управляемое vValue, зависящие от поля Втипе для типов данных фиксированной длины. Размер указан в байтах.



| втипе                                                   | Size |
|---------------------------------------------------------|------|
| VT \_ I1, VT, \_ UI1                                        | 1    |
| VT \_ I2, VT \_ UI2, логическое значение VT \_                               | 2    |
| VT \_ I4, VT \_ UI4, VT \_ R4, VT \_ int, VT \_ uint, \_ Ошибка VT   | 4    |
| VT \_ i8, VT \_ UI8, VT \_ R8, VT \_ CY, VT \_ , VT \_ fileTime | 8    |
| VT \_ Decimal, VT \_ CLSID                                  | 16   |



 

Если для Втипе задано значение VT \_ BLOB, VT \_ BSTR или VT LPSTR, то \_ Структура управляемое vValue указана на следующей схеме:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

кбсизе

Блобдата (переменная, необязательный)



 

**кбсизе**: 32-разрядное целое число без знака, указывающее размер поля блобдата в байтах. Если Втипе имеет значение VT \_ BSTR или VT \_ LPSTR, для кбсизе должно быть задано значение 0x00000000, если представленная строка является пустой строкой.

**блобдата**: длина должна быть кбсизе в байтах.

Если для Втипе задано значение VT \_ BLOB, это поле будет иметь непрозрачные двоичные данные BLOB.

Для Втипе, установленного в VT \_ BSTR, это поле представляет собой набор символов в выбранной кодировке OEM. Клиент и сервер должны быть настроены для использования набора символов с возможностью взаимодействия (по протоколу внешнего вида протокола). Нет необходимости завершать его нулем.

Для Втипе, установленного в VT \_ LPSTR, это поле является строкой символов, завершающейся нулем, в выбранной кодировке OEM. Клиент и сервер должны быть настроены для использования набора символов с возможностью взаимодействия (по протоколу внешнего вида протокола).

Если Втипе имеет значение VT \_ LPWSTR, структура управляемое vValue указывается на следующей схеме:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

кклен

String (переменная, необязательная)



 

**кклен**: 32-разрядное целое число без знака, указывающее размер строкового поля в символах Юникода. Для пустой строки необходимо задать значение 0x00000000.

**строка**: строка Юникода, заканчивающаяся нулем.

### <a name="22111-cbasestoragevariant-structures"></a>2.2.1.1.1 Кбасесторажевариант структуры

В структуре Кбасесторажевариант используются следующие структуры.

### <a name="221111-decimal"></a>2.2.1.1.1.1 DECIMAL

Значение DECIMAL используется для представления точного числового значения с фиксированной точностью и фиксированным масштабом.

Если для Втипе задано значение VT \_ Decimal (0x0000E), то поля vData1 и vData2 в КБАСЕСТОРАЖЕВАРИАНТ должны интерпретироваться следующим образом:

**vData1**: количество цифр справа от десятичной запятой. Значение должно находиться в диапазоне от 0 до 28.

**vData2**: знак числового значения. Задайте значение 0x00, если положительный, 0x80, если отрицательный.

Формат поля управляемое vValue:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

Hi32

Lo32

Mid32



 

**Hi32**: наибольшее число 32 бит 96 разрядов.

**Lo32**: младшие 32 бита 96 разрядного целого числа.

**Mid32**: середина 32 бит 96 разрядного целого числа.

### <a name="221112-vt_vector"></a>вектор 2.2.1.1.1.2 VT \_

\_Вектор VT используется для передачи одномерных массивов.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

ввекторелементс

ввектордата



 

**ввекторелементс**: 32-разрядное целое число без знака, указывающее количество элементов в поле ввектордата.

**ввектордата**: массив элементов, имеющих тип, обозначенный параметром втипе с сброшенным битом 0x1000. Размер отдельного элемента фиксированной длины можно получить из таблицы типов данных фиксированной длины, как указано в разделе 2.2.1.1. Длина этого поля в байтах может быть вычислена путем умножения Ввекторелементс на размер отдельного элемента.

Для типов данных переменной длины Ввектордата содержит последовательность последовательных упакованных простых типов, где тип обозначается параметром Втипе с сброшенным битом 0x1000. Это включает особый случай, обозначенный Втипе VT \_ array \| VT \_ (т. е. 0x100C).

Элементы в поле Ввектордата должны быть разделены от 0 до 3 байтов, чтобы каждый элемент начинался со смещения, кратного 4 байтам от начала сообщения, содержащего этот массив. Если заданы байты заполнения, то значение, которое они содержат, является произвольным. Содержимое байтов заполнения должно игнорироваться получателем.

Для Втипе, установленного в VT \_ array \| VT \_ , тип для элементов в этой последовательности — кбасесторажевариант.

### <a name="221113-safearray"></a>2.2.1.1.1.3 SAFEARRAY

SAFEARRAY используется для передачи многомерных массивов. Структура содержит сведения о размере массива, а также данные в массиве.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

кдимс

ффеатурес

кбелементс

Ргсабаунд (переменная)

Вдата (переменная)



 

**кдимс**: 16-разрядное целое число без знака, указывающее количество измерений многомерного массива.

**ффеатурес**: 16-разрядное битовое значение. Значения представляют функции, определенные приложениями верхнего уровня, и должны игнорироваться.

**кбелементс**: 32-битовое целое число без знака, указывающее размер каждого элемента массива.

**Ргсабаунд**: массив, содержащий одну структуру сафеаррайбаунд, как указано в разделе 2.2.1.1.1.4, для измерения в массиве SafeArray. В этом массиве сначала находится крайне левое измерение, а в последнем — крайнее правое измерение.

**вдата**: вектор упакованных элементов определенного типа, обозначенный втипеом содержащего кбасесторажевариант, с битом 0x2000.

Вдата маршалируется аналогично \_ вектору VT, как указано в разделе 2.2.1.1.1.2, с разницей, что число элементов не сохраняется перед вектором. Вместо этого число элементов вычисляется путем умножения значения Целементс на все защищенные границы массива, заданные в поле Ргсабаунд. Элементы хранятся в векторе в порядке измерений, начиная с крайнего правого измерения.

Следующая диаграмма наглядно представляет пример двумерного массива. Первое измерение имеет Целементс, равное 4 (представлен горизонтально) и Ллбаунд равно 0, а второе измерение имеет Целементс, равное 2 (представлен вертикально), а Ллбаунд равно 0.

:::row:::
    :::column:::
        0x00000001
    :::column-end:::
    :::column:::
        0x00000002
    :::column-end:::
    :::column:::
        0x00000003
    :::column-end:::
    :::column:::
        0x00000005
    :::column-end:::
:::row-end:::

:: Row:::
    :::column:::
        0x00000007
    :::column-end:::
    :::column:::
        0x00000011
    :::column-end:::
    :::column:::
        0x00000013
    :::column-end:::
    :::column:::
        0x00000017
    :::column-end:::
:::row-end:::

С помощью приведенной выше схемы Вдата будет содержать следующую последовательность: 0x00000001, 0x00000007, 0x00000002, 0x00000011, 0x00000003, 0x00000013, 0x00000005, 0x00000017 (сначала просматривая крайнее правое измерение, а затем увеличив следующее измерение). Предыдущая Ргсабаунд (которая регистрирует Целементс и LBound) будет выглядеть следующим образом: 0x00000004, 0x00000000, 0x00000002, 0x00000000.

### <a name="221114-safearraybound"></a>2.2.1.1.1.4 САФЕАРРАЙБАУНД

Структура САФЕАРРАЙБАУНД представляет границы одного измерения SAFEARRAY или SAFEARRAY2. Он имеет следующий формат:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

целементс

ллбаунд



 

**целементс**: 32-битовое целое число без знака, указывающее количество элементов в измерении.

**ллбаунд**: 32-битовое целое число без знака, задающее нижнюю границу измерения.

### <a name="221115-safearray2"></a>2.2.1.1.1.5 SAFEARRAY2

SAFEARRAY2 используется для передачи многомерных массивов в СЕРИАЛИЗЕДПРОПЕРТИВАЛУЕ. Структура содержит сведения о границах, а также данные.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

кдимс

Ргсабаунд (переменная)

Вдата (переменная)



 

**кдимс**: 32-разрядное целое число без знака, указывающее количество измерений SAFEARRAY2.

**Ргсабаунд**: массив, содержащий одну структуру сафеаррайбаунд, как указано в разделе 2.2.1.1.1.4 для измерения в SAFEARRAY2. В этом массиве сначала находится крайне левое измерение, а в последнем — крайнее правое измерение.

**вдата**: вектор упакованных элементов определенного типа, обозначенный двтипеом содержащего сериализедпропертивалуе, с битом 0x2000. Формат Вдата, аналогичный указанному для поля Вдата массива SAFEARRAY в разделе 2.2.1.1.1.3.

### <a name="2212-cfullpropspec"></a>2.2.1.2 Кфуллпропспек

Структура Кфуллпропспек содержит идентификатор GUID набора свойств и идентификатор свойства для уникальной идентификации свойства.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_гуидпропсет

...

...

...

улкинд

прспек

Имя свойства (переменная)



 

**\_ гуидпропсет**: идентификатор GUID набора свойств, которому принадлежит свойство.

**улкинд**: 32-битовое целое число без знака. Одно из приведенных ниже значений, которое указывает содержимое Прспек.



| Значение                                            | Значение                                                                                  |
|--------------------------------------------------|------------------------------------------------------------------------------------------|
| ПРСПЕК \_ LPWSTR<br/> 0x00000000<br/> | Поле Прспек указывает число символов, отличных от NULL, в поле Имя свойства. |
| ПРСПЕК \_ PropID<br/> 0x00000001<br/>  | В поле Прспек указывается идентификатор свойства (PROPID).                                     |



 

**Прспек**: 32-битовое целое число без знака, равное значению, указанному в поле улкинд.

**Имя свойства**: Если улкинд имеет значение прспек \_ PropID, это поле не должно присутствовать. Если для Улкинд задано значение ПРСПЕК \_ LPWSTR, то в этом поле должен содержаться массив, не учитывающий регистр, из прспек символов Юникода, отличных от NULL, содержащий имя свойства.

### <a name="2213-ccontentrestriction"></a>2.2.1.3 Кконтентрестриктион

Структура Кконтентрестриктион содержит строку, соответствующую свойству в кэше свойств.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_Свойство (переменная)

...

Padding1 (переменная)

Копия

\_Пвксфрасе (переменная)

...

Padding2 (переменная)

lcid

\_улженератемесод



 

**\_ Свойство**: структура кфуллпропспек, как указано в разделе 2.2.1.2. Это поле обозначает свойство, для которого необходимо выполнить операцию сопоставления.

**Padding1**: это поле должно иметь длину от 0 до 3 байт. Длина этого поля должна быть такой, что следующее поле начинается со смещения, кратного 4 байтам от начала сообщения, содержащего эту структуру. Если это поле (т. е. Длина ненулевой), то значение, которое он содержит, является произвольным. Содержимое этого поля должно игнорироваться получателем.

**CC**: 32-битовое целое число без знака, указывающее количество символов в \_ поле пвксфрасе.

**\_ пвксфрасе**: строка Юникода, не заканчивающаяся нулем, представляющая слово или фразу для сопоставления со свойством. Это поле не должно быть пустым. Поле "копия" содержит длину строки.

**Padding2**: это поле должно иметь длину от 0 до 3 байт. Длина этого поля должна быть такой, что следующее поле начинается со смещения, кратного 4 байтам от начала сообщения, содержащего эту структуру. Если это поле (т. е. Длина ненулевой), то значение, которое он содержит, является произвольным. Содержимое этого поля должно игнорироваться получателем.

**LCID**: 32-разрядное целое число без знака, указывающее языковой стандарт \_ пвксфрасе, как указано в \[ приложении MS-GPSI \] A.

**\_ улженератемесод**: 32-битовое целое число без знака, определяющее метод, используемый при создании альтернативных форм Word



| Значение                                                       | Значение                                                                                                                                                                                                                                                                                           |
|-------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| СОЗДАТЬ \_ \_ точный метод<br/> 0x00000000<br/>    | Точное соответствие.                                                                                                                                                                                                                                                                                      |
| СОЗДАТЬ \_ \_ префикс метода<br/> 0x00000001 <br/>  | Совпадение префикса.                                                                                                                                                                                                                                                                                     |
| СОЗДАТЬ \_ метод \_ инфлект <br/> 0x00000002<br/> | Соответствует Перегибам слова. Перегиб слова — это вариант корневого слова в той же части речи, который был изменен в соответствии с лингвистическими правилами данного языка. Например, в английской версии глагола "дорожки" включает "дорожки", "купание", "Swimming" и "свам". |



 

### <a name="2214-ckey"></a>2.2.1.4 Ккэй

Структура Ккэй содержит значение свойства.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

PROPID

CB

buf (переменная)



 

**PropID**: 32-битовое целое число без знака, представляющее идентификатор свойства, как описано в разделе 1.8.1. Хорошо известные значения:



| Значение      | Значение                                                 |
|------------|---------------------------------------------------------|
| 0xFFFFFFFF | Представляет недопустимый идентификатор свойства и не должен использоваться. |
| 0xFFFFFFFE | Представляет недопустимый идентификатор свойства и не должен использоваться. |
| 0x00000000 | Представляет идентификатор любого свойства.                             |



 

**CB**: 32-разрядное целое число без знака, содержащее длину buf в байтах.

**buf**: последовательность байтов, представляющих значение свойства.

### <a name="2215-cinternalpropertyrestriction"></a>2.2.1.5 Цинтерналпропертирестриктион

Структура Цинтерналпропертирестриктион содержит значение свойства для сопоставления с операцией.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_RelOp

\_PID

\_првал (переменная)

рестриктионпресент

Некстрестриктион (переменная)



 

**\_ relop**: 32-разрядное целое число, указывающее отношение для выполнения со свойством. ДОЛЖНО иметь одно из следующих значений:



| Значение                 | Значение                                                                                                           |
|-----------------------|-------------------------------------------------------------------------------------------------------------------|
| ПРЛТ 0x00000000       | Сравнение "меньше чем".                                                                                           |
| ПРЛЕ 0x00000001       | Сравнение "меньше или равно".                                                                               |
| ПРГТ 0x00000002       | Сравнение "больше чем".                                                                                        |
| ПРЖЕ 0x00000003       | Сравнение "больше или равно".                                                                            |
| ПРЕК 0x00000004       | Сравнение на равенство.                                                                                           |
| ПРНЕ 0x00000005       | Сравнение «не равно».                                                                                           |
| ПРРЕ 0x00000006       | Сравнение регулярных выражений.                                                                                  |
| Праллбитс 0x00000007  | Побитовое и, возвращающее правый операнд.                                                                     |
| Прсомебитс 0x00000008 | Побитовое и, возвращающее ненулевое значение.                                                                       |
| Пралл 0x00000100      | Операция должна быть выполнена над столбцом набора строк и имеет значение true, если операция выполняется для всех строк. |
| ПРАНИ 0x00000200      | Операция должна быть выполнена над столбцом набора строк, и имеет значение true, если операция выполняется для любой строки.       |



 

**\_ pid**: 32-разрядное целое число без знака, представляющее идентификатор свойства (см. раздел PropID в разделе 2.2.1.4).

**\_ Првал**: кбасесторажевариант, содержащий значение, которое необходимо связать со свойством.

**рестриктионпресент**: значение байта, указывающее, имеется ли поле некстрестриктион. НЕОБХОДИМО задать значение 0x00 или 0x01. Если задано значение 0x01, Рестриктионпресент указывает на наличие поля Некстрестриктион. Если задано значение 0x00, Рестриктионпресент указывает, что поле Некстрестриктион отсутствует.

**некстрестриктион**: структура крестриктион, как указано в разделе 2.2.1.16, с указанием дополнительного ограничения.

### <a name="2216-cnatlanguagerestriction"></a>2.2.1.6 Кнатлангуажерестриктион

Структура Кнатлангуажерестриктион содержит запрос на **естественном языке** , соответствующий свойству.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_Свойство (переменная)

...

\_заполнение \_ CC (переменная)

Копия

\_Пвксфрасе (переменная)

...

\_LCID заполнения \_ (переменная)

Код языка



 

**\_ Свойство**: структура кфуллпропспек, как указано в разделе 2.2.1.3. Это поле обозначает свойство, для которого необходимо выполнить операцию сопоставления.

**\_ Заполнение \_ CC**: это поле должно иметь длину от 0 до 3 байт. Длина этого поля должна быть такой, что следующее поле начинается со смещения, кратного 4 байтам от начала сообщения, содержащего эту структуру. Если это поле (т. е. Длина ненулевой), то значение, которое он содержит, является произвольным. Содержимое этого поля должно игнорироваться получателем.

**CC**: 32-битовое целое число без знака. Число символов в \_ поле пвксфрасе.

**\_ пвксфрасе**: строка Юникода, не заканчивающаяся нулем, представляющая слово или фразу для сопоставления со свойством. НЕ должно быть пустым. Поле "копия" содержит длину строки.

**\_ \_ код языка заполнения**: это поле должно иметь длину от 0 до 3 байт. Длина этого поля должна быть такой, что следующее поле начинается со смещения, кратного 4 байтам от начала сообщения, содержащего эту структуру. Если это поле (т. е. Длина ненулевой), то значение, которое он содержит, является произвольным. Содержимое этого поля должно игнорироваться получателем.

**LCID**: 32-разрядное целое число без знака, указывающее языковой стандарт \_ пвксфрасе, как указано в \[ приложении MS-GPSI \] A.

### <a name="2217-cnoderestriction"></a>2.2.1.7 Кнодерестриктион

Структура Кнодерестриктион содержит массив узлов **дерева команд** , которые указывают ограничения для запроса.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_кноде

\_Паноде (переменная)



 

**\_ кноде**: 32-разрядное целое число без знака, указывающее количество структур крестриктион, содержащихся в \_ поле паноде.

**\_ паноде**: массив структур крестриктион. Структуры в массиве должны быть разделены от 0 до 3 байтов, так что каждая структура начинается со смещения, кратного 4 байтам от начала сообщения, содержащего этот массив. Если заданы байты заполнения, то значение, которое они содержат, является произвольным. Содержимое байтов заполнения должно игнорироваться получателем.

### <a name="2218-coccrestriction"></a>2.2.1.8 Коккрестриктион

Структура Коккрестриктион содержит расположение слова в фразе.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_OCC

\_кпревноисевордс

\_кнекстноисевордс



 

**\_ occ**: 32-разрядное целое число без знака, указывающее смещение слова в строке запроса в единицах. Слово, используемое в этой спецификации, является единицей языка в любом языковом стандарте, который несет смысл.

**\_ кпревноисевордс**: 32-разрядное целое число без знака, содержащее количество **пропускаемых слов** , которые происходят между этим словом и предыдущим словом в фразе.

**\_ кнекстноисевордс**: 32-разрядное целое число без знака, содержащее количество пропускаемых слов, произошедших между этим словом и следующим словом в фразе.

### <a name="2219-cpropertyrestriction"></a>2.2.1.9 Кпропертирестриктион

Структура Кпропертирестриктион содержит значение свойства для сопоставления с операцией.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_RelOp

\_Свойство (переменная)

\_првал (переменная)



 

**\_ relop**: 32-битовое целое число без знака, указывающее отношение для выполнения со свойством. ДОЛЖНО иметь одно из следующих значений.



| Значение                 | Значение                                                                                                           |
|-----------------------|-------------------------------------------------------------------------------------------------------------------|
| ПРЛТ 0x00000000       | Сравнение "меньше чем".                                                                                           |
| ПРЛЕ 0x00000001       | Сравнение "меньше или равно".                                                                               |
| ПРГТ 0x00000002       | Сравнение "больше чем".                                                                                        |
| ПРЖЕ 0x00000003       | Сравнение "больше или равно".                                                                            |
| ПРЕК 0x00000004       | Сравнение на равенство.                                                                                           |
| ПРНЕ 0x00000005       | Сравнение «не равно».                                                                                           |
| ПРРЕ 0x00000006       | Сравнение регулярных выражений.                                                                                  |
| Праллбитс 0x00000007  | Побитовое и, возвращающее правый операнд.                                                                     |
| Прсомебитс 0x00000008 | Побитовое и, возвращающее ненулевое значение.                                                                       |
| Пралл 0x00000100      | Операция должна быть выполнена над столбцом набора строк и имеет значение true, если операция выполняется для всех строк. |
| ПРАНИ 0x00000200      | Операция должна быть выполнена над столбцом набора строк, и имеет значение true, если операция выполняется для любой строки.       |



 

**\_ Свойство**: структура кфуллпропспек, как указано в разделе 2.2.1.2, указывающая свойство, для которого выполняется операция сопоставления.

**\_ првал**: структура кбасесторажевариант, как указано в разделе 2.2.1.1, содержащей значение, которое необходимо связать со свойством.

### <a name="22110-crangerestriction"></a>2.2.1.10 Кранжерестриктион

Структура Кранжерестриктион содержит ограничение на диапазон значений.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_Кэйстарт (переменная)

\_Кэйенд (переменная)



 

**\_ кэйстарт**: структура ккэй, как указано в разделе 2.2.1.4, содержащей начало диапазона.

**\_ кэйенд**: структура ккэй, содержащая конец диапазона.

### <a name="22111-cscoperestriction"></a>2.2.1.11 Кскоперестриктион

Структура Кскоперестриктион содержит ограничение на файлы для поиска.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

ккловерпас

\_Ловерпас (переменная)

...

\_Заполнение (переменная)

\_недопустим

\_фрекурсиве

\_фвиртуал



 

**Ккловерпас**: 32-разрядное целое число без знака, содержащее количество символов Юникода в \_ поле ловерпас.

**\_ ловерпас**: строка в Юникоде, не заканчивающаяся нулем, представляющая **путь** , к которому должен быть ограничен запрос. Поле Ккловерпас содержит длину строки.

**\_ Заполнение**: это поле должно иметь длину от 0 до 3 байт. Длина этого поля должна быть такой, что следующее поле начинается со смещения, кратного 4 байтам от начала сообщения, содержащего эту структуру. Если это поле (т. е. Длина ненулевой), то значение, которое он содержит, является произвольным. Содержимое этого поля должно игнорироваться получателем.

**\_ length**: 32-разрядное целое число без знака, содержащее длину \_ Ловерпас в символах Юникода. Это должно быть то же значение, что и Ккловерпас.

**\_ фрекурсиве**: 32-битовое целое число без знака. НЕОБХОДИМО задать значение 0x00000001 или 0x00000000. Если задано значение 0x00000001, сервер должен рекурсивно проверять все подкаталоги пути. Если задано значение 0x00000000, сервер не должен проверять подкаталоги.

**\_ фвиртуал**: 32-битовое целое число без знака. НЕОБХОДИМО задать значение 0x00000001 или 0x00000000. Если задано значение 0x00000001, \_ ловерпас является виртуальным путем (URL-адресом, связанным с физическим каталогом в файловой системе) для веб-сайта. Если задано значение 0x00000000, \_ ловерпас является путем к файловой системе.

### <a name="22112-csort"></a>2.2.1.12 Ксорт

Структура Ксорт определяет столбец для сортировки.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

пидколумн

Параметр dwOrd

локаль



 

**пидколумн**: 32-битовое целое число без знака. Номер столбца, по которому выполняется сортировка.

**параметр DWORD**: 32-битовое целое число без знака. ДОЛЖНО иметь одно из следующих значений, указывая способ сортировки по столбцу.



| Значение                        | Значение                                                                                    |
|------------------------------|--------------------------------------------------------------------------------------------|
| ЗАПРОС \_ сортасценд 0x00000000 | Строки сортируются в возрастающем порядке по значениям в указанном столбце.  |
| ЗАПРОС в \_ порядке 0x00000001    | Строки сортируются в убывающем порядке на основе значений в указанном столбце. |



 

**языковой стандарт**: 32-разрядное целое число без знака, указывающее языковой стандарт, как указано в \[ приложении MS-GPSI, \] из которого находится столбец.

### <a name="22113-csynrestriction"></a>2.2.1.13 Ксинрестриктион

Структура Ксинрестриктион содержит слово или его синонимы для фразы запроса.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

Ограничение

...

...

ккэй

\_Кэйаррай (переменная)

\_Диапазон



 

**Ограничение**: структура коккрестриктион, указывающая расположение слова.

**ккэй**: 32-битовое целое число без знака, указывающее количество элементов в \_ массиве кэйаррай.

**\_ кэйаррай**: массив структур ккэй, задающий слово и его синонимы.

параметр **\_ Range**: Если задано значение 0x01, то ключи являются префиксами для сопоставления. Если задано значение 0x00, то для соответствия ключам используются точные значения. \_параметру "диапазон" не должны быть присвоены никакие другие значения.

### <a name="22114-cvectorrestriction"></a>2.2.1.14 Квекторрестриктион

Структура Квекторрестриктион содержит взвешенное значение или операцию для узла дерева команд.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_Прес (переменная)

...

\_Заполнение (переменная)

\_улранкмесод



 

**\_ прес**: дерево команд кнодерестриктион, на основе которого выполняется ранжирование или операция.

**\_ Заполнение**: это поле должно иметь длину от 0 до 3 байт. Длина этого поля должна быть такой, что следующее поле начинается со смещения, кратного 4 байтам от начала сообщения, содержащего эту структуру. Если это поле (т. е. Длина ненулевой), то значение, которое он содержит, является произвольным. Содержимое этого поля должно игнорироваться получателем.

**\_ улранкмесод**: 32-битовое целое число без знака, указывающее алгоритм ранжирования. НЕОБХОДИМО задать одно из следующих значений.



| Значение                            | Значение                                       |
|----------------------------------|-----------------------------------------------|
| \_Минимальное звание вектора ( \_ 0x00000000)     | Используйте минимальное Салтон алгоритма \[ \] .             |
| Максимум ВЕКТОРного \_ ранга \_ 0x00000001     | Использовать максимальный алгоритм \[ Салтон \] .             |
| \_Внутренний приоритетный экземпляр \_ 0x00000002   | Использовать внутренний алгоритм продукта \[ Салтон \] .       |
| ВЕКТОРные \_ ранжирующие \_ 0x00000003    | Используйте алгоритм "коэффициент костей" \[ Салтон \] .    |
| ВЕКТОР \_ ранжирования \_ джаккарда 0x00000004 | Используйте алгоритм Джаккарда коэффициента \[ Салтон \] . |



 

### <a name="22115-cwordrestriction"></a>2.2.1.15 Квордрестриктион

Структура Квордрестриктион содержит слово для фразы запроса.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

ограничение

...

...

\_Key (переменная)

\_Диапазон



 

**ограничение**: структура коккрестриктион, указывающая расположение слова.

**\_ Key**: структура ккэй, указывающая слово.

параметр **\_ Range**: Если задано значение 0x01, ключ является префиксом для сопоставления. Если задано значение 0x00, то ключ является точным значением для сопоставления. \_параметру "диапазон" не должно быть присвоено другое значение.

### <a name="22116-crestriction"></a>2.2.1.16 Крестриктион

Структура Крестриктион содержит узел дерева команд запроса.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_ултипе

Weight

Ограничение



 

**\_ ултипе**: 32-битовое целое число без знака, указывающее тип ограничения, используемый для узла дерева команд. НЕОБХОДИМО задать одно из следующих значений.



| Значение                    | Значение                                                                                     |
|--------------------------|---------------------------------------------------------------------------------------------|
| Ртноне 0x00000000        | Узел представляет пропускаемое слово в векторном запросе.                                         |
| Ртанд 0x00000001         | Узел содержит Кнодерестриктион, на основе которого выполняется логическая операция. |
| РТор 0x00000002          | Узел содержит Кнодерестриктион, для которого должна быть выполнена логическая операция или.  |
| Ртнот 0x00000003         | Узел содержит Крестриктион, для которого не выполняется операция.             |
| Ртконтент 0x00000004     | Узел содержит Кконтентрестриктион.                                                    |
| Ртпроперти 0x00000005    | Узел содержит Кпропертирестриктион.                                                   |
| Ртпроксимити 0x00000006   | Узел содержит Кнодерестриктион, на основе которого будет выполняться ранжирование с учетом расположения,     |
| Ртвектор 0x00000007      | Узел содержит Квекторрестриктион.                                                     |
| Ртнатлангуаже 0x00000008 | Узел содержит Кнатлангуажерестриктион.                                                |
| Ртскопе 0x00000009       | Узел содержит Кскоперестриктион.                                                      |
| ПРАНИ 0xFFFFFFFA         | Узел содержит Цинтерналпропертирестриктион.                                           |
| Ртранже 0xFFFFFFFC       | Узел содержит Кранжерестриктион.                                                      |
| Ртфрасе 0xFFFFFFFD      | Узел содержит Кнодерестриктион, для которого должно быть выполнено совпадение фразы.          |
| Ртсиноним 0xFFFFFFFE     | Узел содержит Ксинрестриктион.                                                        |
| Ртворд 0xFFFFFFFF        | Узел содержит Квордрестриктион.                                                       |



 

**Вес**: 32-битовое целое число без знака, представляющее вес узла. Вес указывает на важность узла относительно других узлов в дереве команд запроса. Более важные значения веса более важны.

**Ограничение**: тип ограничения для узла дерева команд. Синтаксис должен быть указан в \_ поле ултипе.

### <a name="22117-ccolumnset"></a>2.2.1.17 Кколумнсет

Структура Кколумнсет указывает возвращаемые номера столбцов. Эта структура всегда используется в ссылке на определенную структуру Кпидмаппер (раздел 2.2.1.23).



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

количество

индексы (переменная)



 

**Count**: 32-разрядное целое число без знака, указывающее количество элементов в массиве индексов.

**индексы**: массив из 4-байтных целых чисел без знака, представляющий индексы, начинающиеся с нуля, в массиве апропспек в соответствующей структуре кпидмаппер.

### <a name="22118-ccategorizationset"></a>2.2.1.18 Ккатегоризатионсет

Структура Ккатегоризатионсет содержит сведения о группировании результирующего набора запроса.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

количество

категории (переменная)



 

**Count**: 32-разрядное целое число без знака, содержащее количество элементов в массиве Categories.

**Categories**: массив структур ккатегоризатионспек, задающий группирование запроса.

### <a name="22119-ccategorizationspec"></a>2.2.1.19 Ккатегоризатионспек

Структура Ккатегоризатионспек содержит группирование для результирующего набора запроса.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_Ксколумнс (переменная)

\_улкатегтипе



 

**\_ ксколумнс**: структура кколумнсет, указывающая столбцы, по которым будет группироваться запрос.

**\_ улкатегтипе**: 32-битовое целое число без знака. НЕОБХОДИМО задать значение 0x00000000.

### <a name="22120-cdbcolid"></a>2.2.1.20 Кдбколид

Структура Кдбколид содержит столбец.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

Элемент ekind

GUID

...

...

...

улид

Встринг (переменная)



 

**элемент ekind**: необходимо задать одно из приведенных ниже значений, которое указывает содержимое GUID и управляемое vValue.



| Значение                            | Значение                                                                                                         |
|----------------------------------|-----------------------------------------------------------------------------------------------------------------|
| \_Имя GUID дбкинд \_ 0x00000000    | Встринг содержит имя свойства.                                                                               |
| ДБКИНД \_ GUID \_ PropID 0x00000001  | Улид содержит 4-байтовое целое число, указывающее идентификатор свойства.                                                      |
| ДБКИНД \_ пгуид \_ имя 0x00000003   | Встринг содержит имя свойства. Это значение должно рассматриваться так же, как \_ и \_ имя GUID дбкинд.                    |
| ДБКИНД \_ пгуид \_ PropID 0x00000004 | Улид содержит 4-байтовое целое число, указывающее идентификатор свойства. Это значение должно быть таким же, как и ДБКИНД \_ GUID \_ PropID. |



 

**GUID**: идентификатор GUID свойства.

**улид**: Если элемент ekind имеет значение дбкинд \_ GUID \_ PropID или дбкинд \_ пгуид \_ PropID, это поле содержит целое число без знака, в котором указывается идентификатор свойства. Если элемент ekind имеет значение ДБКИНД \_ GUID \_ или имя дбкинд \_ пгуид \_ , это поле содержит целое число без знака, указывающее количество символов Юникода, содержащихся в поле встринг.

**встринг**: строка Юникода, не заканчивающаяся нулем, представляющая имя свойства. Его необходимо опустить, если для поля элемент ekind не задано значение ДБКИНД \_ GUID \_ Name или дбкинд \_ пгуид \_ Name.

### <a name="22121-cdbprop"></a>2.2.1.21 Кдбпроп

Структура Кдбпроп содержит свойство.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

дбпропид

дбпропоптионс

дбпропстатус

идентификатора столбца (переменная)

Управляемое vValue (переменная)



 

**Дбпропид**: 32-битовое целое число без знака, указывающее идентификатор свойства.

**Дбпропоптионс** : необходимо задать значение 0x00000000.

**Дбпропстатус**: необходимо задать значение 0x00000000.

**идентификатора столбца**: структура кдбколид, как указано в разделе 2.2.1.20, указывающая столбец, к которому применяется свойство.

**управляемое vValue**: кбасесторажевариант, содержащий значение свойства.

### <a name="221211-properties"></a>свойства 2.2.1.21.1

В этом разделе описаны свойства, используемые CISP. Эти свойства группируются в три набора свойств, Ident 2.2.1.21.1 ифиед в поле Гуидпропертисет структуры Кдбпропсет (раздел 2.2.1.22).

В следующей таблице перечислены свойства, которые являются частью \_ набора свойств DBPROPSET фсЦифрмврк \_ ext.



| Значение                                  | Значение                                                                                                                                            |
|----------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------|
| DBPROP \_ CI \_ Catalog \_ имя 0x00000002   | Указывает имя каталога или каталогов для запроса. Значение должно быть VT \_ LPWSTR или \_ вектор VT \| \_ LPWSTR                                   |
| DBPROP \_ CI \_ включает \_ области 0x00000003 | Указывает один или несколько путей для включения в запрос. Значение должно быть VT \_ LPWSTR или \_ вектор VT \| \_ LPWSTR.                                 |
| \_ \_ Флаги области CI DBPROP \_ 0x00000004    | Указывает, как должны обрабатываться пути, указанные в \_ \_ \_ свойстве областей DBPROP CI. Значение должно быть VT \_ I4 или \_ вектор \| VT \_ i4. |
| \_ \_ Тип запроса DBPROP CI \_ 0x00000007     | Указывает тип запроса. Для Кдбколид должно быть задано значение DB \_ нуллид.                                                                               |



 

В следующей таблице перечислены флаги для \_ \_ \_ свойства Flags области DBPROP CI.



| Значение                     | Значение                                                                                                                                                                                                                 |
|---------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| \_Глубокий запрос 0x01          | Если задано значение, указывает, что файлы в каталоге области и во всех подкаталогах включены в результаты. Если задано значение Clear, в результаты включаются только файлы в каталоге области. НЕ следует сочетать с QUERY \_ Deep. |
| ЗАПРОС \_ виртуального \_ пути 0x02 | Если задано значение, это указывает на то, что область является виртуальным путем. Если флажок снят, указывает, что область является физическим каталогом.                                                                                                         |



 

В следующей таблице перечислены типы запросов для \_ свойства типа "запрос CI DBPROP" \_ \_ .



| Значение                     | Значение                                                                                                            |
|---------------------------|--------------------------------------------------------------------------------------------------------------------|
| Цинормал 0x00000000       | Обычный запрос.                                                                                                   |
| Цивиртуалрутс 0x00000001 | Запрос запрашивает список виртуальных корней каталога. Для этого значения требуются права администратора. |
| Ципропертиес 0x00000003   | Запрос запрашивает список всех свойств, поддерживаемых службой индексирования.                            |
| Циадминоп 0x00000004      | Запрос является административной операцией. Для этого значения требуются права администратора.                           |



 

В следующей таблице перечислены свойства, которые являются частью \_ набора свойств DBPROPSET куерекст.



| Значение                                      | Значение                                                                                                                                                                                                                          |
|--------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| DBPROP \_ усеконтентиндекс 0x00000002         | Указывает, как служба индексирования предназначена для обработки запросов с высокой скоростью. Значение должно быть логическим значением VT \_ . Значение TRUE показывает, что серверу разрешено завершать эти запросы.                                                                                    |
| DBPROP \_ дефернониндекседтримминг 0x00000003 | Указывает, должна ли служба индексирования выполнять усечение результатов. Если значение равно TRUE, то сервер должен выполнять усечение результатов таким образом, чтобы оптимизировать время отклика клиенту. Значение должно быть логическим значением VT \_ .             |
| DBPROP \_ усикстендеддбтипес 0x00000004      | Указывает, поддерживает ли клиент \_ типы данных VT Vector. Если значение — TRUE, клиент поддерживает \_ вектор VT; если значение равно false, то сервер должен преобразовать \_ векторные типы данных VT в \_ типы данных массива VT.  Значение должно быть логическим значением VT \_ . |
| DBPROP \_ фирстровс 0x00000007               | Указывает, что строка соответствует возвращаемому значению. Если значение равно TRUE, сервер должен возвращать первый набор совпадающих строк. Если значение равно FALSE, то должны возвращаться наиболее подходящие строки. Значение должно быть логическим значением VT \_ .                                             |



 

В следующей таблице перечислены свойства, которые являются частью \_ набора свойств DBPROPSET Цифрмврккоре \_ ext.



| Значение/ДБПРОПИД                 | Значение                                                                                                                                 |
|----------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------|
| DBPROP \_ машины 0x00000002       | Указывает имена компьютеров, на которых будет обрабатываться запрос. Значение должно быть либо VT \_ BSTR, либо VT \_ \| . VT \_ BSTR. |
| \_0X00000003 DBPROP клиента \_ CLSID | Задает константу подключения для службы индексирования. Значение должно быть \_ идентификатором CLSID VT, содержащим 0x2A4880706FD911D0A80800A0C906241A.  |



 

### <a name="22122-cdbpropset"></a>2.2.1.22 Кдбпропсет

Структура Кдбпропсет содержит набор свойств. Обратите внимание, что первое поле имеет фиксированный размер, но может не быть согласовано со смещением, которое является 4-байтовым числом, кратным началу сообщения, содержащего эту структуру. Однако поле Кпропертиес будет выражаться таким образом, поэтому формат будет выглядеть следующим образом:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

гуидпропертисет

...

...

...

...

\_Заполнение (переменная)

кпропертиес

Апропс (переменная)



 

**гуидпропертисет**: идентификатор GUID, определяющий набор свойств. НЕОБХОДИМО задать двоичную форму, соответствующую одному из следующих значений (отображается в форме строкового представления), определяя набор свойств свойств, содержащихся в поле Апропс.



| Значение/GUID                                                                              | Имя                                             |
|-------------------------------------------------------------------------------------------|--------------------------------------------------|
| DBPROPSET \_ фсЦифрмврк \_ ext<br/> {A9BD1526-6A80-11D0-8C9D-0020AF1D740E}<br/>   | Набор свойств платформы индекса содержимого файловой системы |
| DBPROPSET \_ куерекст<br/> {A7AC77ED-F8D7-11CE-A798-0020F8008025}<br/>          | Набор свойств расширения запроса                     |
| DBPROPSET \_ Цифрмврккоре \_ ext<br/> {AFAFACA5-B5D1-11D0-8C62-00C04FC2DB8D}<br/> | Набор свойств Core платформы индекса содержимого        |



 

**\_ Заполнение**: это поле должно иметь длину от 0 до 3 байт. Длина этого поля должна быть такой, что следующее поле начинается со смещения, кратного 4 байтам от начала сообщения, содержащего эту структуру. Если это поле имеется (т. е. Длина не равно нулю), то значение, которое он содержит, является произвольным. Содержимое этого поля должно игнорироваться получателем.

**кпропертиес**: 32-разрядное целое число без знака, содержащее количество элементов в массиве апропс.

**апропс**: массив структур кдбпроп, как указано в разделе 0, содержащем свойства. Структуры в массиве должны быть разделены от 0 до 3 байтов, так что каждая структура начинается со смещения, кратного 4 байтам от начала сообщения, содержащего этот массив. Если заданы байты заполнения, то значение, которое они содержат, является произвольным. Содержимое байтов заполнения должно игнорироваться получателем.

### <a name="22123-cpidmapper"></a>2.2.1.23 Кпидмаппер

Структура Кпидмаппер содержит массив идентификаторов свойств, указывающих свойства, возвращаемые в наборе строк.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

количество

апропспек

... перемен



 

**Count**: 32-разрядное целое число без знака, содержащее количество элементов в массиве апропспек.

**апропспек**: массив структур кфуллпропспек, указывающих возвращаемые свойства. Структуры в массиве должны быть разделены от 0 до 3 байтов с отступом таким, что каждая структура имеет 4-байтовое выравнивание от начала сообщения. Такое заполнение байтов может быть любым произвольным значением и не должно учитываться при получении.

### <a name="22124-crowseekat"></a>2.2.1.24 Кровсикат

Структура Кровсикат содержит смещение для получения строк в сообщении Кпмжетровсин.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_хрегион

\_кскип

\_бмкоффсет



 

**\_ хрегион**: необходимо задать значение 0x00000000, и оно должно игнорироваться.

**\_ кскип**: 32-битовое целое число без знака, содержащее количество строк для пропуска в наборе строк.

**\_ бмкоффсет**: 32-разрядное значение, представляющее маркер **закладки** , указывающий начальную точку, с которой следует пропускать число строк, указанное в \_ кскип, перед началом извлечения.

### <a name="22125-crowseekatratio"></a>2.2.1.25 Кровсикатратио

Структура Кровсикатратио определяет точку, с которой начинается извлечение сообщения Кпмжетровсин.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

Цитблчапт

\_хрегион

\_улнумератор

\_улденоминатор



 

**Цитблчапт**: 32-битовое целое число без знака, указывающее главу набора строк, из которой нужно получить строки.

**\_ хрегион**: необходимо задать значение 0x00000000, и оно должно игнорироваться.

**\_ улнумератор**: 32-разрядное целое число без знака, представляющее числитель количества строк в главе, с которых начинается извлечение.

**\_ улденоминатор**: 32-разрядное целое число без знака, представляющее знаменатель отношения количества строк в главе, с которых начинается извлечение. ДОЛЖНО быть больше нуля.

### <a name="22126-crowseekbybookmark"></a>2.2.1.26 Кровсикбибукмарк

Структура Кровсикбибукмарк определяет закладки, из которых начинается получение строк для сообщения Кпмжетровсин.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_хрегион

\_кбукмаркс

\_максрет

\_квалидрет

\_Абукмаркс (переменная)

\_Аскрет (переменная)



 

**\_ хрегион**: необходимо задать значение 0x00000000, и оно должно игнорироваться.

**\_ кбукмаркс**: 32-разрядное целое число без знака, представляющее число элементов в \_ массиве абукмаркс.

**\_ максрет**: 32-разрядное целое число без знака, представляющее число элементов в \_ массиве аскрет.

**\_ квалидрет**: 32-разрядное целое число без знака, представляющее число \_ допустимых элементов в массиве аскрет. В массиве определены допустимые элементы, тогда как недопустимые элементы не определены.

**\_ абукмаркс**: массив дескрипторов закладок (каждый из которых представлен 4 байта), полученный из сообщения кпмжетровсаут.

**\_ аскрет**: массив значений HRESULT. Когда Кровсикбибукмарк отправляется как часть запроса Кпмжетровсин, число записей в массиве должно быть равно \_ кбукмаркс. При отправке клиентом значения должны быть равны нулю, а сервер должен игнорировать содержимое массива. При отправке сервером (в составе сообщения Кпмжетровсаут) значения в массиве указывают состояние результата для каждого извлечения строки.

### <a name="22127-crowseeknext"></a>2.2.1.27 Кровсикнекст

Структура Кровсикнекст содержит число строк, которые необходимо пропустить в сообщении Кпмжетровсин.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

Цитблчапт

\_хрегион

\_кскип



 

**Цитблчапт**: 32-разрядное целое число без знака, указывающее главу набора строк, из которой нужно получить строки.

**\_ хрегион**: необходимо задать значение 0x00000000, и оно должно игнорироваться.

**\_ кскип**: 32-разрядное целое число без знака, представляющее число строк для пропуска в наборе строк.

### <a name="22128-crowsetproperties"></a>2.2.1.28 Кровсетпропертиес

Структура Кровсетпропертиес содержит сведения о конфигурации для запроса.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_убулеаноптионс

\_улмаксопенровс

\_улмеморюсаже

\_кмаксресултс

\_ккмдтимеаут



 

**\_ убулеаноптионс**: наименее значимые 3 бита этого поля должны содержать одно из следующих трех значений:



| Значение                  | Значение                                                             |
|------------------------|---------------------------------------------------------------------|
| Есекуентиал 0x00000001 | Курсор можно переместить только вперед.                              |
| Елокатабле 0x00000003  | Курсор можно переместить в любую позицию.                            |
| Ескроллабле 0x00000007 | Курсор можно переместить в любую позицию и получить в любом направлении. |



 

Остальные биты могут быть либо понятны, либо установлены в любое сочетание следующих логических значений или совместно.



| Значение                     | Значение                                                                                                     |
|---------------------------|-------------------------------------------------------------------------------------------------------------|
| Еасинчронаус 0x00000008  | Клиент не будет ждать завершения выполнения.                                                          |
| Ефирстровс 0x00000080     | Возвращение первых обнаруженных строк, а не наиболее подходящих соответствий.                                                    |
| Ехолдровс 0x00000200      | Сервер не должен отбрасывать строки до тех пор, пока клиент не завершит запрос.                                     |
| Ечаптеред 0x00000800     | Набор строк поддерживает главы.                                                                               |
| ЕусеЦи 0x00001000         | Отвечайте на запрос только из индекса, а не из файловой системы.                                                  |
| Едефертримминг 0x00002000 | Служба индексирования позволяет оптимизировать время отклика клиенту при удалении результатов. |



 

**\_ улмаксопенровс**: 32-разрядное целое число без знака. Необходимо задать значение 0x00000000. Не используется и должен игнорироваться.

**\_ улмеморюсаже**: 32-разрядное целое число без знака. Необходимо задать значение 0x00000000. Не используется и должен игнорироваться.

**\_ кмаксресултс**: 32-разрядное целое число без знака, указывающее максимальное количество строк, возвращаемых для запроса.

**\_ ккмдтимеаут**: 32-разрядное целое число без знака, определяющее время ожидания запроса (в секундах) и автоматическое завершение, считая от момента начала выполнения запроса на сервере. Значение 0x00000000 означает, что время ожидания запроса не истекло.

### <a name="22129-crowvariant"></a>2.2.1.29 Кроввариант

Структура Кроввариант содержит часть фиксированного размера типа данных переменной длины, которая хранится в сообщении Кпмжетровсаут.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

втипе

reserved1

reserved2

Offset (необязательно)



 

**втипе**: признак типа, указывающий тип управляемое vValue. Это должно быть одно из значений VARENUM, указанных в разделе 2.2.1.1.

**reserved1**: не используется. В качестве значения можно задать любое произвольное значение. оно должно игнорироваться при получении.

**reserved2**: не используется. В качестве значения можно задать любое произвольное значение. оно должно игнорироваться при получении.

**Offset**: смещение данных переменной длины (например, строка).  Это должно быть 32-разрядное значение (4 байта), если используется 32-разрядное смещение (согласно правилам в разделе 2.2.3.16), или значение 64-Byte (8 байт), если используется 64-разрядное смещение.

### <a name="22130-csortset"></a>2.2.1.30 Ксортсет

Структура Ксортсет содержит порядок сортировки запроса.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

Count

Сортаррай (переменная)



 

**Count**: 32-разрядное целое число без знака, задающее число элементов в сортаррай.

**сортаррай**: массив структур ксорт, описывающих порядок сортировки результатов запроса. Структуры в массиве должны быть разделены от 0 до 3 байтов с отступом таким, что каждая структура имеет 4-байтовое выравнивание от начала сообщения. Такое заполнение байтов может быть любым произвольным значением и не должно учитываться при получении.

### <a name="22131-ctablecolumn"></a>2.2.1.31 Ктаблеколумн

Структура Ктаблеколумн содержит столбец сообщения Кпмсетбиндингсин



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

пропспек

... перемен

втипе

валуеусед

\_padding1 (необязательно)

Валуеоффсет (необязательно)

Валуесизе (необязательно)

статусусед

\_padding2 (необязательно)

Статусоффсет (необязательно)

ленгсусед

\_padding3 (необязательно)

Ленгсоффсет (необязательно)



 

**Пропспек**: структура кфуллпропспек, указанная в разделе 2.2.1.3.

**втипе**: указывает тип значения данных, содержащегося в столбце. Список значений для этого поля см. в поле Втипе в разделе 2.2.1.1.

**Валуеусед**: одно поле byte, которое должно иметь значение 0x01 или 0x00. Если задано значение 0x01, столбец передается в пределах строки фиксированного размера. Если задано 0x00, значение столбца передается в разделе переменной длины в конце буфера.

**\_ padding1**: поле с одним байтом, которое должно быть вставлено перед валуеоффсет, если, без него, валуеоффсет не будет начинаться с четного смещения, начиная с начала сообщения. Значение этого байта является произвольным и должно игнорироваться. Если Валуеусед имеет значение 0x00, это поле не должно присутствовать.

**Валуеоффсет**: 2-байтовое целое число без знака, указывающее смещение значения столбца в строке. Если Валуеусед имеет значение 0x00, это поле не должно присутствовать.

**Валуесизе**: 2-байтовое целое число без знака, указывающее размер значения столбца в байтах. Если Валуеусед имеет значение 0x00, это поле не должно присутствовать.

**Статусусед**: одно поле byte, которое должно иметь значение 0x01 или 0x00. Если задано значение 0x01, состояние столбца передается в строке. Если 0x00, состояние столбца не передается в строке.

**\_ padding2**: поле с одним байтом, которое должно быть вставлено перед статусоффсет, если, без него, поле статусоффсет не будет начинаться с четного смещения относительно начала сообщения. Значение этого байта является произвольным и должно игнорироваться. Если Статусусед имеет значение 0x00, это поле не должно присутствовать.

**Статусоффсет**: 2-байтовое целое число без знака, указывающее смещение состояния столбца в строке. Если Статусусед имеет значение 0x00, это поле не должно присутствовать.

**Ленгсусед**: одно поле byte, которое должно иметь значение 0x01 или 0x00. Если задано значение 0x01, длина столбца передается внутри строки. Если 0x00, длина столбца не должна передаваться внутри строки.

**\_ padding3**: поле с одним байтом, которое должно быть вставлено перед ленгсоффсет, если, без него, ленгсоффсет не будет начинаться с четного смещения, начиная с начала сообщения. Значение этого байта является произвольным и должно игнорироваться. Если Ленгсусед имеет значение 0x00, это поле не должно присутствовать.

**Ленгсоффсет**: 2-байтовое целое число без знака, указывающее смещение длины столбца в строке. Если Ленгсусед имеет значение 0x00, это поле не должно присутствовать.

### <a name="22132-serializedpropertyvalue"></a>2.2.1.32 СЕРИАЛИЗЕДПРОПЕРТИВАЛУЕ

Структура СЕРИАЛИЗЕДПРОПЕРТИВАЛУЕ содержит сериализованное значение.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

двтипе

RGB (переменная)



 

**двтипе**: один из типов Variant, определенный в разделе 2.2.1.1, который можно сочетать с модификаторами типа Variant. Для всех типов Variant, за исключением тех, которые объединены с \_ массивом VT, сериализедпропертивалуе имеет тот же макет, что и кбасесторажевариант, как указано в разделе 2.2.1.1. Если тип Variant сочетается с \_ модификатором типа массива VT, то в поле Кбасесторажевариант управляемое vValue вместо SAFEARRAY используется SAFEARRAY2, заданный в разделе 2.2.1.2.1.1.

**RGB**: сериализованное значение. См. подробные сведения о сериализации для управляемое vValue в 2.2.1.1.

### <a name="222-message-headers"></a>Заголовки сообщений 2.2.2

Все сообщения протокола службы индексирования содержимого содержат 16-байтовый заголовок.

Ниже приведена схема, показывающая формат заголовка сообщения протокола службы индексирования содержимого.



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_msg

\_состояние

\_улчекксум

\_ulReserved2



 

\_**MSG**: 32-разрядное целое число, определяющее тип сообщения, следующего за заголовком. В следующей таблице перечислены сообщения протокола службы индексирования содержимого и целые значения, указанные для каждого сообщения. Как показано в таблице, некоторые значения указывают 2 сообщения в таблице. В этих экземплярах сообщение, следующее за заголовком, можно определить по направлению потока сообщений. Если направлением является клиент-сервер, отображается сообщение с добавлением к имени сообщения. Если направлением является серверный клиент, то отображается сообщение с добавлением к имени сообщения "out".



| Значение      | Значение                                                     |
|------------|-------------------------------------------------------------|
| 0x000000C8 | Кпмконнектин или Кпмконнектаут                               |
| 0x000000C9 | кпмдисконнект                                               |
| 0x000000CA | Кпмкреатекуерин или Кпмкреатекуерйоут                       |
| 0x000000CB | Кпмфрикурсорин или Кпмфрикурсораут                         |
| 0x000000CC | Кпмжетровсин или Кпмжетровсаут                               |
| 0x000000CD | Кпмратиофинишедин или Кпмратиофинишедаут                   |
| 0x000000CE | Кпмкомпаребмкин или Кпмкомпаребмкаут                         |
| 0x000000CF | Кпмжетаппроксиматепоситионин или Кпмжетаппроксиматепоситионаут |
| 0x000000D0 | кпмсетбиндингсин                                            |
| 0x000000D1 | кпмжетнотифи                                                |
| 0x000000D2 | кпмсенднотифйоут                                            |
| 0x000000D7 | Кпмжеткуеристатусин или Кпмжеткуеристатусаут                 |
| 0x000000D9 | кпмЦистатеинаут                                             |
| 0x000000E1 | кпмфорцемержеин                                             |
| 0x000000E4 | Кпмфетчвалуеин или Кпмфетчвалуеаут                         |
| 0x000000E6 | кпмупдатедокументсин                                        |
| 0x000000E7 | Кпмжеткуеристатусексин или Пмжеткуеристатусексаут              |
| 0x000000E8 | кпмрестартпоситионин                                        |
| 0x000000E9 | кпмстопасинчин                                             |
| 0x000000EC | Кпмсеткатстатеин или Кпмсеткатстатеаут                       |



 

\_**состояние**: HRESULT \[ MS-sys \] , указывающий состояние запрошенной операции.

\* *

*Windows Поведение. Клиент всегда задает \_ для поля состояния значение 0x00000000.*

**\_ УЛЧЕККСУМ**: \_ необходимо вычислить улчекксум, как указано в разделе 3.2.4 для следующих сообщений:

-   кпмконнектин
-   кпмкреатекуерин
-   кпмсетбиндингсин
-   кпмжетровсин
-   кпмфетчвалуеин

Для всех остальных сообщений \_ параметру УЛЧЕККСУМ должно быть присвоено значение 0x00000000. Клиент должен игнорировать \_ поле улчекксум.

**\_ ulReserved2**: значение должно быть равно 0 и игнорируется получателем.

### <a name="223-messages"></a>сообщения 2.2.3

### <a name="2231-cpmcistateinout"></a>2.2.3.1 КпмЦистатеинаут

Сообщение КпмЦистатеинаут содержит сведения о состоянии службы индексирования. Формат сообщения КпмЦистатеинаут, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

кбструкт

квордлист

кперсистентиндекс

ккуериес

cDocument

кфрештест

двмержепрогресс

Пространство

кфилтереддокументс

ктоталдокументс

кпендингсканс

двиндекссизе

куникуекэйс

ксеккдокументс

двпропкачесизе



 

**кбструкт**: 32-битовое целое число без знака. Размер (в байтах) этого сообщения (за исключением общего заголовка). НЕОБХОДИМО задать значение 0x0000003C.

**квордлист**: 32-разрядное целое число без знака, указывающее количество начальных индексов, созданных для недавно индексированных документов.

**кперсистентиндекс**: 32-битовое целое число без знака, указывающее количество постоянных индексов.

**ккуериес**: 32-битовое целое число без знака, указывающее количество активных запросов.

**CDocument**: 32-разрядное целое число без знака, указывающее общее количество документов, ожидающих индексирования.

**кфрештест**: 32-разрядное целое число без знака, указывающее количество уникальных документов со сведениями в индексах, которые не были полностью оптимизированы для повышения производительности.

**двмержепрогресс**: беззнаковое 32-разрядное целое число, определяющее процент завершения текущей полной оптимизации индексов, если в данный момент выполняется оптимизация. ДОЛЖНО быть меньше или равно 100.

**пространство**: состояние индексирования содержимого, заданное одной или несколькими \_ константами состояния CI \_ \* , определенными в таблице ниже.



| Значение                                         | Значение                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|-----------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| \_ \_ Теневое \_ Слияние состояния CI 0x00000001           | Служба индексирования находится в процессе оптимизации некоторых индексов, чтобы сократить использование памяти и повысить производительность запросов.                                                                                                                                                                                                                                                                                                                                                                |
| \_ \_ Слияние хозяина состояния CI — \_ 0x00000002           | Служба индексирования находится в процессе полной оптимизации для всех индексов.                                                                                                                                                                                                                                                                                                                                                                                                                  |
| \_ \_ Требуется сканирование содержимого состояния CI, \_ \_ 0x00000004 | Некоторые документы в индексе были изменены, и службе индексирования необходимо определить, какие из них были добавлены, изменены или удалены.                                                                                                                                                                                                                                                                                                                                                              |
| \_Состояние CI \_ отжига \_ Merge 0x00000008        | Служба индексирования находится в процессе оптимизации индексов, чтобы сократить использование памяти и повысить производительность запросов. Этот процесс является более полным, чем тот, который определяется \_ \_ значением теневого копирования состояния CI \_ , но не так, как указано в \_ \_ значении объединения с образцом состояния CI \_ . Такая оптимизация зависит от конкретной реализации, так как они зависят от способа внутреннего хранения данных. оптимизация не влияет на протокол никаким способом, отличным от времени отклика. |
| \_Просмотр состояния CI \_ 0x00000010                | Служба индексирования проверяет каталог или набор каталогов, чтобы определить, были ли файлы добавлены, удалены или обновлены со времени последнего индексирования каталога.                                                                                                                                                                                                                                                                                                                 |
| \_Восстановление состояния CI — \_ 0x00000020              | Служба запускается из последнего сохраненного состояния и находится в процессе восстановления.                                                                                                                                                                                                                                                                                                                                                                                                        |
| \_ \_ 0x00000080 нехватка \_ памяти CI State             | Большая часть виртуальной памяти сервера используется.                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| \_ \_ Высокий уровень операций ввода-вывода в состоянии CI \_ 0x00000100                | Уровень активности ввода-вывода на сервере относительно высокий.                                                                                                                                                                                                                                                                                                                                                                                                                    |
| \_ \_ Сводное \_ Слияние состояния CI \_ 0x00000200 приостановлено   | Процесс полной оптимизации для всех выполняемых индексов был приостановлен. Он предоставляется исключительно в информативных целях и не влияет на CISP.                                                                                                                                                                                                                                                                                                                                  |
| \_Состояние CI \_ только для чтения \_ 0x00000400              | Часть службы индексирования, которая выбирает новые документы для индексирования, приостановлена. Он предоставляется исключительно в информативных целях и не влияет на CISP.                                                                                                                                                                                                                                                                                                                               |
| Состояние элемента конфигурации \_ \_ батарея \_ Power 0x00000800          | Часть службы индексирования, которая выбирает новые документы для индексирования, приостановлена для сохранения времени существования аккумулятора, но по-прежнему отвечает на запросы. Он предоставляется исключительно в информативных целях и не влияет на CISP.                                                                                                                                                                                                                                                                 |
| \_Состояние CI \_ пользователь \_ Active 0x00001000            | Часть службы индексирования, которая выбирает новые документы для индексирования, приостановлена из-за высокой активности пользователя (клавиатуры или мыши), но по-прежнему отвечает на запросы. Он предоставляется исключительно в информативных целях и не влияет на CISP.                                                                                                                                                                                                                                         |
| Состояние CI, \_ \_ начиная с 0x00002000                | Служба запускается. Запросы можно запускать, но сканирование и уведомление еще не включены. Он предоставляется исключительно в информативных целях и не влияет на CISP.                                                                                                                                                                                                                                                                                                                   |
| \_ \_ Считывание состояния CI \_ USN 0x00004000           | Служба не прочитала журнал, который хранится в файловой системе, чтобы отследить изменения в файлах или каталогах на томе, поэтому индекс может оказаться неактуальным.                                                                                                                                                                                                                                                                                                                                  |



 

**кфилтереддокументс**: 32-разрядное целое число без знака, указывающее количество документов, индексированных с момента начала индексирования содержимого.

**ктоталдокументс**: 32-битовое целое число без знака, указывающее общее количество документов в системе.

**кпендингсканс**: 32-битовое целое число без знака, указывающее количество ожидающих операций индексирования высокого уровня. Значение этого параметра зависит от поставщика, но более крупные числа должны указывать на большее количество индексов.

*Windowsное поведение*. обычно это значение равно нулю, за исключением случаев, когда было начато индексирование или после того, как очередь уведомлений переполняется.

**двиндекссизе**: 32-разрядное целое число без знака, указывающее размер индекса (за исключением кэша свойств) в мегабайтах.

**куникуекэйс**: 32-битовое целое число без знака, указывающее приблизительное количество уникальных ключей в каталоге.

**ксеккдокументс**: 32-разрядное целое число без знака, указывающее количество документов, которые служба индексирования будет повторно пытаться индексировать из-за сбоя во время первоначальной попытки индексирования.

**двпропкачесизе**: 32-разрядное целое число без знака, указывающее размер кэша свойств в мегабайтах.

### <a name="2232-cpmsetcatstatein"></a>2.2.3.2 Кпмсеткатстатеин

Сообщение Кпмсеткатстатеин задает состояние каталога. Формат сообщения Кпмсеткатстатеин, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_partID

\_двневстате

\_Катнаме (переменная, необязательный)



 

**\_ PARTID**: необходимо задать значение 0x00000001.

**\_ двневстате**: необходимо задать одно из следующих значений, указывающее новое состояние каталога.



| Значение                         | Значение                                                                                                                                                                 |
|-------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ЦИКАТ \_ остановлено 0x00000001     | Каталог остановлен. Это состояние означает, что новые файлы индексироваться не будут, а поисковые запросы обрабатываться не будут.                                                     |
| ЦИКАТ \_ ReadOnly 0x00000002    | Каталог доступен только для чтения. Нет новых файлов для индексирования.                                                                                                               |
| ЦИКАТ, \_ доступный для записи, 0x00000004    | Каталог доступен для записи. Новые файлы можно индексировать, а запросы поиска — обрабатывать.                                                                              |
| ЦИКАТ \_ без \_ запроса 0x00000008   | Каталог недоступен для запросов.                                                                                                                              |
| ЦИКАТ \_ получить \_ состояние 0x00000010  | Состояние каталога не должно изменяться, извлекается только.                                                                                                          |
| ЦИКАТ \_ все \_ открытые 0x00000020 | Проверка того, были ли запущены все каталоги. Если да, то в \_ поле дволдстате, отправленном в ответе кпмсеткатстатеаут на это сообщение, будет получено ненулевое значение. |



 

**\_ Катнаме**: имя каталога, для которого необходимо изменить состояние. Имя должно быть строкой в Юникоде, завершающейся нулем. Это поле необходимо опустить, если \_ двневстате имеет значение Цикат \_ All \_ Opened.

### <a name="2233-cpmsetcatstateout"></a>2.2.3.3 Кпмсеткатстатеаут

Сообщение Кпмсеткатстатеаут — это ответ на сообщение Кпмсеткатстатеин со старым состоянием каталога. Формат сообщения Кпмсеткатстатеаут, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_дволдстате



 

**\_ дволдстате**: одно из следующих значений, указывающее старое состояние каталога.



| Значение                       | Значение                                    |
|-----------------------------|--------------------------------------------|
| ЦИКАТ \_ остановлено 0x00000001   | Каталог остановлен.                    |
| ЦИКАТ \_ ReadOnly 0x00000002  | Каталог доступен только для чтения.                  |
| ЦИКАТ, \_ доступный для записи, 0x00000004  | Каталог доступен для записи.                   |
| ЦИКАТ \_ без \_ запроса 0x00000008 | Каталог недоступен для запросов. |



 

### <a name="2234-cpmupdatedocumentsin"></a>2.2.3.4 Кпмупдатедокументсин

Сообщение Кпмупдатедокументсин направляет сервер для индексирования указанного пути.

Сервер будет отвечать с заголовком сообщения Кпмупдатедокументсаут, в котором результаты запроса содержатся в \_ поле Status заголовка сообщения.

Формат сообщения Кпмупдатедокументсин, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_флаг (необязательно)

\_Фрутпас (необязательно)

RootPath (переменная, необязательный)



 

**\_ флаг**: тип обновления, которое необходимо выполнить. Это поле должно присутствовать, когда клиент отправляет сообщение, и должно отсутствовать, когда сервер отправляет сообщение. В этом поле должно быть указано одно из следующих значений:



| Значение                  | Значение                                   |
|------------------------|-------------------------------------------|
| UPD \_ инкрем 0x00000000 | Необходимо выполнить добавочное обновление. |
| \_Полный UPD 0x00000001   | Необходимо выполнить полное обновление.         |
| UPD \_ init 0x00000002   | Будет выполнена новая инициализация.  |



 

**\_ фрутпас**: логическое значение, указывающее, указывает ли поле rootpath путь для выполнения обновления. Это поле должно присутствовать, когда клиент отправляет сообщение, и должно отсутствовать, когда сервер отправляет сообщение. Для этого поля необходимо задать значение 0x00000001 или 0x00000000. Если задано значение 0x00000001, то путь, по которому выполняется обновление, включается в RootPath. Если задано значение 0x00000000, то обновление будет выполнено для всех индексированных путей.

**Rootpath**: имя обновляемого пути. Это поле должно присутствовать, когда клиент отправляет сообщение, и должно отсутствовать, когда сервер отправляет сообщение. Имя должно быть строкой в Юникоде, завершающейся нулем. Это поле необходимо опустить, если \_ для фрутпас задано значение 0x00000000.

### <a name="2235-cpmforcemergein"></a>2.2.3.5 Кпмфорцемержеин

Сообщение Кпмфорцемержеин запрашивает сервер для выполнения любого обслуживания, необходимого для повышения производительности запросов. Сервер будет отвечать с заголовком сообщения Кпмфорцемержеин, а результаты запроса содержатся в \_ поле Status (состояние).

Формат сообщения Кпмфорцемержеин, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_partID (необязательно)



 

**\_ PARTID**: это поле должно присутствовать, когда клиент отправляет сообщение, и должно отсутствовать, когда сервер отправляет сообщение. Если это поле указано, оно должно быть установлено в значение 0x00000001.

### <a name="2236-cpmconnectin"></a>2.2.3.6 Кпмконнектин

Сообщение Кпмконнектин начинает сеанс между клиентом и сервером.

Формат сообщения Кпмконнектин, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_иклиентверсион

\_фклиентисремоте

\_cbBlob1

\_cbBlob2

\_заполнение

...

...

MachineName

... перемен

Имя пользователя

... перемен

\_Паддингкпропсетс (необязательный, переменная)

кпропсетс

PropertySet1 (переменная)

PropertySet2 (переменная)

\_Паддинжекстпропсет (необязательный, переменная)

цекстпропсет

Апропертисетс (переменная)



 

**\_ иклиентверсион**: 32-разрядное целое число, указывающее, должен ли сервер проверять значение контрольной суммы, указанное в \_ поле улчекксум заголовков сообщений для сообщений, отправленных клиентом. Если \_ поле иклиентверсион имеет значение 0x00000008 или больше, сервер должен проверить \_ значение поля улчекксум для следующих сообщений:

-   кпмконнектин
-   кпмкреатекуерин
-   кпмфетчвалуеин
-   кпмжетровсин
-   кпмсетбиндингсин

Дополнительные сведения о том, как сервер проверяет значение, указанное клиентом в поле Улчекксум, для сообщений, перечисленных выше, см. в разделе 3.2.5.

Если значение больше 0x00000008, предполагается, что клиент может обрабатывать 64-битные смещения в сообщениях Кпмжетровсаут. Дополнительные сведения см. в разделе 2.2.3.16.

*Windows поведение: на клиентах Windows иклиентверсион задается следующим* образом:



| Значение      | Значение                                                              |
|------------|----------------------------------------------------------------------|
| 0x00000005 | клиентская ос — Windows 2000.                                           |
| 0x00000008 | клиентская ос — 32-разрядная Windows XP или 32-bit Windows Server 2003. |
| 0x00010008 | клиентская ос — 64-разрядная Windows XP или 64-bit Windows Server 2003. |



 

\_**фклиентисремоте**: логическое значение, указывающее, работает ли клиент на компьютере, отличном от компьютера, на котором находится сервер. НЕОБХОДИМО задать значение 0x00000001.

\_**cbBlob1**: 32-разрядное целое число без знака, указывающее размер в байтах для полей Кпропсет, PropertySet1 и PropertySet2 в сочетании.

\_**cbBlob2**: 32-разрядное целое число без знака, указывающее размер в байтах для полей Цекспропсет и апропертисет в сочетании.

\_**Заполнение**: 12 байтов заполнения, которые могут содержать произвольные значения, и должны игнорироваться.

**MachineName**— имя компьютера клиента. Строка имени должна быть массивом, заканчивающимся нулем, размером менее 512 символов Юникода, включая знак завершения NULL.

**Username**— строка, представляющая имя пользователя, запустившего приложение, которое вызвало этот протокол. Строка имени должна быть массивом, заканчивающимся нулем, размером менее 512 символов Юникода при объединении с MachineName.

**\_ паддингкпропсетс**: длина этого поля должна быть от 0 до 7 байт. Число байтов должно быть числом, необходимым для смещения в байтах поля Кпропсетс с начала сообщения, содержащего эту структуру, кратной 8. Значение байт может быть любым произвольным значением и должно игнорироваться получателем.

**кпропсетс**: 32-разрядное целое число без знака, указывающее количество структур кдбпропсет, следующих за этим полем. Это значение должно быть равно 0x0000002.

**PropertySet1**: структура Кдбпропсет с гуидпропертисет, содержащей DBPROPSET \_ фсЦифрмврк \_ ext (см. раздел 2.2.1.22).

**PropertySet2**: структура Кдбпропсет с гуидпропертисет, содержащей DBPROPSET \_ Цифрмврккоре \_ ext (см. раздел 2.2.1.22).

\_**Паддинжекстпропсет**: длина этого поля должна быть от 0 до 7 байт. Число байтов должно быть числом, необходимым для смещения в байтах поля Цекстпропсетс с начала сообщения, содержащего эту структуру, кратной 8. Значение байт может быть любым произвольным значением и должно игнорироваться получателем.

**цекстпропсет**: 32-разрядное целое число без знака, указывающее количество структур кдбпропсет, следующих за этим полем.

**апропертисетс**: массив структур кдбпропсет, задающий другие свойства. Число элементов в этом массиве должно быть равно Цекстпропсет.

### <a name="2237-cpmconnectout"></a>2.2.3.7 Кпмконнектаут

Сообщение Кпмконнектаут содержит ответ на сообщение Кпмконнектин.

Формат сообщения Кпмконнектаут, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_serverVersion

\_зарезервировано (переменная)



 

**\_ serverVersion**:

32-разрядное целое число, указывающее, может ли сервер поддерживать 64-битное смещение *.* Дополнительные сведения см. в разделе 2.2.3.16.



| Значение      | Значение                                 |
|------------|-----------------------------------------|
| 0x00000007 | Сервер может передавать только 32-разрядные смещения. |
| 0x00010007 | Сервер может передавать 32 или 64-битные смещения.   |



 

**\_ зарезервировано**: зарезервировано. Сервер может отправить произвольное число произвольных значений, и клиент должен игнорировать эти значения, если они есть.

### <a name="2238-cpmcreatequeryin"></a>2.2.3.8 Кпмкреатекуерин

Сообщение Кпмкреатекуерин создает новый запрос. Формат сообщения Кпмкреатекуерин, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

Size

кколумнсетпресент

(Необязательно)

... перемен

Крестриктионпресент.

Ограничение (необязательно)

... перемен

ксортсетпресент

Тип сортировки (необязательно)

... перемен

ккатегоризатионсетпресент

Категоризатионсет (необязательно)

... перемен

ровсетпропертиес

...

...

...

...

Пидмаппер (переменная)



 

**Размер**: 32-разрядное целое число без знака, указывающее число байтов от начала этого поля до конца сообщения.

**Кколумнсетпресент**: поле byte, указывающее, имеется ли поле с набором столбцов. Для этого поля необходимо задать значение 0x01 или 0x00. Если задано значение 0x01, поле Кколумнсет должно присутствовать. Если задано значение 0x00, оно должно отсутствовать.

Набор **столбцов**: структура кколумнсет, содержащая номера столбцов, в которых должны возвращаться свойства кпидмаппер.

**Крестриктионпресент**: поле byte, указывающее, имеется ли поле ограничения. Если задано любое ненулевое значение, поле ограничения должно присутствовать. Если задано значение 0x00, ограничение должно отсутствовать.

**Ограничение**: структура крестриктион, содержащая дерево команд запроса.

**Ксортсетпресент**: поле byte, указывающее, имеется ли поле Sorting. Если задано любое ненулевое значение, поле Sorting должно присутствовать. Если задано значение 0x00, то параметр Sort должен отсутствовать.

Набор **сортировки**: структура ксортсет, указывающая порядок сортировки запроса.

**Ккатегоризатионсетпресент**: поле byte, указывающее, имеется ли поле ккатегоризатионсет. Если задано любое ненулевое значение, поле Ккатегоризатионсет должно присутствовать. Если задано значение 0x00, Ккатегоризатионсет должно отсутствовать.

**Ккатегоризатионсет**: структура ккатегоризатионсет, содержащая группы для запроса.

**Ровсетпропертиес**: структура кровсетпропертиес, предоставляющая сведения о конфигурации для запроса.

**Пидмаппер**: структура кпидмаппер, содержащая свойства, возвращаемые в наборе строк.

### <a name="2239-cpmcreatequeryout"></a>2.2.3.9 Кпмкреатекуерйоут

Сообщение Кпмкреатекуерйоут содержит ответ на сообщение Кпмкреатекуерин.

Формат сообщения Кпмкреатекуерйоут, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_фтруесекуентиал

\_фворкидуникуе

акурсорс



 

**\_ фтруесекуентиал**: информативное логическое значение, указывающее, может ли запрос получать результаты быстрее. Если для запроса, предоставленного в Кпмкреатекуерин, задано 0x00000001, сервер может использовать индекс таким образом, чтобы результаты запроса могли быть доставлены быстрее. Если задано значение 0x00000000, то при доставке результатов запроса будет воздержаться задержка. Не должно быть задано ни одно другое значение.

**\_ фворкидуникуе**: логическое значение, указывающее, являются ли идентификаторы документов, на которые указывают курсоры, уникальными в результатах запроса. Если задано значение 0x00000001, идентификаторы являются уникальными. Если задано значение 0x00000000, они уникальны только во всем наборе строк.

**акурсорс**: массив из 32-разрядных целых чисел без знака, представляющих дескрипторы курсоров, с числом элементов, равным числу категорий в поле Категоризатионсет сообщения кпмкреатекуерин.

### <a name="22310-cpmgetquerystatusin"></a>2.2.3.10 Кпмжеткуеристатусин

Сообщение Кпмжеткуеристатусин запрашивает состояние запроса. Формат сообщения Кпмжеткуеристатусин, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_хкурсор



 

**\_ хкурсор**: 32-разрядное целое число без знака, представляющее маркер из сообщения кпмкреатекуерйоут, идентифицирующего запрос, для которого необходимо получить сведения о состоянии.

### <a name="22311-cpmgetquerystatusout"></a>2.2.3.11 Кпмжеткуеристатусаут

Сообщение Кпмжеткуеристатусаут отвечает на сообщение Кпмжеткуеристатусин с состоянием запроса. Формат сообщения Кпмжеткуеристатусаут, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_Состояние



 

**\_ Состояние**: битовая маска значений, определенных в таблицах ниже, которая описывает запрос.

В следующей таблице перечислены \_ \* значения Stat, полученные путем выполнения побитовой операции и для \_ состояния с 0x00000007. Результат должен быть одним из следующих:



| Константа                 | Значение                                                                           |
|--------------------------|-----------------------------------------------------------------------------------|
| STAT \_ занято 0x00000000    | Асинхронный запрос все еще выполняется.                                          |
| \_Ошибка stat 0x00000001   | Запрос находится в состоянии ошибки.                                                   |
| РЕГЛАМЕНТное \_ Завершение 0x00000002    | Запрос завершен.                                                            |
| STAT \_ Refresh 0x00000003 | Запрос завершен, но обновления приводят к дополнительным вычислениям запросов. |



 

В следующей таблице перечислены дополнительные \_ \* биты Stat, которые можно задать независимо.



| Константа                                    | Значение                                                                                                                             |
|---------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| STAT \_ пропускаемых \_ слов 0x00000010               | Пропускаемые слова были заменены символами-шаблонами в запросе содержимого.                                                              |
| \_ \_ \_ Неактуальное содержимое \_ stat     | Результаты запроса могут быть неверными, так как в запросе были внесены измененные, но неиндексированные файлы.                             |
| \_Неполное обновление stat \_ 0x00000040        | Результаты запроса могут быть неверными, так как запрос содержал измененные и повторно индексированные файлы, содержимое которых не было указано. |
| \_Неполный \_ запрос содержимого stat \_ 0x00000080 | Запрос содержимого был слишком сложен для завершения или обязательного перечисления вместо использования индекса содержимого.                          |
| \_Превышено ограничение по времени stat \_ \_ 0x00000100      | Результаты запроса могут быть неверными, так как время выполнения запроса достигло максимально допустимого времени.                    |



 

### <a name="22312-cpmgetquerystatusexin"></a>2.2.3.12 Кпмжеткуеристатусексин

Сообщение Кпмжеткуеристатусексин запрашивает состояние запроса и дополнительную информацию, например количество индексируемых документов, количество документов, оставшихся для индексирования, и т. д. Формат сообщения Кпмжеткуеристатусексин, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_хкурсор

\_бмк



 

**\_ хкурсор**: 32-разрядное значение, представляющее маркер из сообщения кпмкреатекуерйоут, идентифицирующего запрос, для которого необходимо получить сведения о состоянии.

**\_ бмк**: 32-разрядное значение, указывающее маркер закладки, расположение которого необходимо получить.

### <a name="22313-cpmgetquerystatusexout"></a>2.2.3.13 Кпмжеткуеристатусексаут

Сообщение Кпмжеткуеристатусексаут отвечает на сообщение Кпмжеткуеристатусексин с состоянием запроса и другими сведениями о состоянии, как описано на схеме ниже. Формат сообщения Кпмжеткуеристатусексаут, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_Состояние

\_кфилтереддокументс

\_кдокументстофилтер

\_двратиофинишедденоминатор

\_двратиофинишеднумератор

\_ировбмк

\_кровстотал



 

**\_ Состояние**: один из stat \_ \* значения, указанные в разделе 2.2.3.11.

**\_ кфилтереддокументс**: 32-разрядное целое число без знака, указывающее количество индексируемых документов

**\_ кдокументстофилтер**: 32-разрядное целое число без знака, указывающее количество документов, которые еще остались для индексирования.

**\_ двратиофинишедденоминатор**: 32-разрядное целое число без знака, указывающее знаменатель отношения документов, обработка которых завершена в результате запроса.

**\_ двратиофинишеднумератор**: 32-битовое целое число без знака, указывающее числитель коэффициента документов, обработка которых завершена в результате запроса.

**\_ ировбмк**: 32-разрядное целое число без знака, указывающее приблизительное расположение закладки в наборе строк с точки зрения строк.

**\_ кровстотал**: 32-битовое целое число без знака, указывающее общее количество строк в наборе строк.

### <a name="22314-cpmsetbindingsin"></a>2.2.3.14 Кпмсетбиндингсин

Сообщение Кпмсетбиндингсин запрашивает привязку столбцов к набору строк. Сервер будет отвечать на сообщение запроса Кпмсетбиндингсин, используя раздел заголовка сообщения Кпмбиндингсин с результатами запроса, содержащимся в \_ поле Status (состояние). Формат сообщения Кпмсетбиндингсин, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_Хкурсор (необязательно)

\_Кбров (необязательно)

\_Кббиндингдеск (необязательно)

\_фиктивный (необязательный)

Кколумнс (необязательно)

Аколумнс (переменная, необязательный)



 

**\_ хкурсор**: 32-разрядное значение, представляющее маркер из сообщения кпмкреатекуерйоут, идентифицирующего строку, для которой задаются привязки. Это поле должно присутствовать, когда клиент отправляет сообщение, и должно отсутствовать, когда сервер отправляет сообщение.

**\_ кбров**: 32-битовое целое число без знака, указывающее размер строки в байтах. Это поле должно присутствовать, когда клиент отправляет сообщение, и должно отсутствовать, когда сервер отправляет сообщение.

**\_ кббиндингдеск**: 32-разрядное целое число без знака, указывающее длину (в байтах) полей, следующих за \_ фиктивным полем. Это поле должно присутствовать, когда клиент отправляет сообщение, и должно отсутствовать, когда сервер отправляет сообщение.

**\_ фиктивное**: это поле не используется и должно игнорироваться. Для него можно задать любое произвольное значение. Это поле должно присутствовать, когда клиент отправляет сообщение, и должно отсутствовать, когда сервер отправляет сообщение.

**кколумнс**: 32-разрядное целое число без знака, указывающее количество элементов в массиве аколумнс. Это поле должно присутствовать, когда клиент отправляет сообщение, и должно отсутствовать, когда сервер отправляет сообщение.

**аколумнс**: массив структур ктаблеколумн, описывающих столбцы строки в наборе строк. Это поле должно присутствовать, когда клиент отправляет сообщение, и должно отсутствовать, когда сервер отправляет сообщение. Структуры в массиве должны быть разделены от 0 до 3 байтов с отступом таким, что каждая структура имеет 4-байтовое выравнивание от начала сообщения. Такое заполнение байтов может быть любым произвольным значением и не должно учитываться при получении.

### <a name="22315-cpmgetrowsin"></a>2.2.3.15 Кпмжетровсин

Сообщение Кпмжетровсин запрашивает строки из запроса. Формат сообщения Кпмжетровсин, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_хкурсор

\_кровстотрансфер

\_кброввидс

\_кбсик

\_кбресервед

\_кбреадбуффер

\_улклиентбасе

\_фбвдфетч

eType

\_Протокол CHAP

сикдескриптион

...

... перемен



 

**\_ хкурсор**: 32-разрядное значение, представляющее маркер из сообщения кпмкреатекуерйоут, идентифицирующего запрос, для которого необходимо получить строки.

**\_ кровстотрансфер**: 32-разрядное целое число без знака, указывающее максимальное число строк, которое клиент хочет получить в ответ на это сообщение.

**\_ кброввидс**: 32-разрядное целое число без знака, указывающее длину строки в байтах.

**\_ кбсик**: 32-битовое целое число без знака, указывающее размер сообщения, начинающегося с eType.

**\_ кбресервед**: 32-разрядное целое число без знака, указывающее размер (в байтах) сообщения кпмжетровсаут (без полей Rows и сикдескриптионс). Это значение в этом поле добавляется к значению \_ поля кбсик, а затем используется для вычисления поля смещение строк в сообщении кпмжетровсаут.

**\_ кбреадбуффер**: 32-разрядное целое число без знака, которое должно быть равно максимальному значению параметра \_ кброввидс или 1000, равному значению \_ кровстотрансфер, округленному до ближайшего 512 байта. Значение не должно превышать 0x00004000.

**\_ улклиентбасе**: 32-разрядное целое число без знака, указывающее базовое значение, используемое для вычислений указателей в буфере строк. Если используются 64-разрядные смещения, поле reserved2 в заголовке сообщения используется в качестве верхних 32-бит и \_ улклиентбасе в качестве младших 32 бит для 64-разрядного значения. Дополнительные сведения см. в разделе 2.2.3.16.

**\_ фбвдфетч**: 32-битовое целое число без знака, указывающее порядок получения строк. Если задано значение 0x00000001, строки будут извлекаться в обратную последовательность. Если задано значение 0x00000000, строки будут извлекаться в прямом порядке. НЕ должно быть задано ни одного другого значения.

**eType**: 32-разрядное целое число без знака, содержащее одно из следующих значений для указания типа выполняемой операции.



| Значение                         | Значение                                                  |
|-------------------------------|----------------------------------------------------------|
| Еровсикнекст 0x00000001       | Сикдескриптион содержит структуру Кровсикнекст.       |
| Еровсикат 0x00000002         | Сикдескриптион содержит структуру Кровсикат.         |
| Еровсикатратио 0x00000003    | Сикдескриптион содержит структуру Кровсикатратио.    |
| Еровсикбибукмарк 0x00000004 | Сикдескриптион содержит структуру Кровсикбибукмарк. |



 

**\_ chap**: 32-разрядное значение, представляющее маркер главы набора строк.

**Сикдескриптион**: это поле должно содержать структуру типа, обозначенного значением eType.

### <a name="22316-cpmgetrowsout"></a>2.2.3.16 Кпмжетровсаут

Сообщение Кпмжетровсаут отвечает на сообщение Кпмжетровсин со строками запроса. Серверы должны отформатировать смещения до типов данных переменной длины в поле строк следующим образом:

-   Клиент указал, что он был 32-разрядной системой (0x00000008 или меньше в поле Иклиентверсион Кпмконнектин): смещениями являются 32-разрядные целые числа.
-   Клиент указал, что он был 64-разрядной системой ( \_ иклиентверсион > 0x00000008 в кпмконнектин) и сервер указал, что он был 32-разрядной системой ( \_ serverVersion установлен в 0X00000007 в кпмконнектаут): смещениями являются 32-разрядные целые числа
-   Клиент указал, что он был 64-разрядной системой ( \_ иклиентверсион > 0x00000008 в кпмконнектин) и сервер указал, что он был 64-разрядной системой ( \_ serverVersion установлен в 0X00010007 в кпмконнектаут): смещениями являются 64-разрядные целые числа

Формат сообщения Кпмжетровсаут, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_кровсретурнед

eType

\_Протокол CHAP

Сикдескриптион (необязательный, переменная)

...

...

Паддингровс (необязательный, переменная)

Строки



 

**\_ кровсретурнед**: 32-разрядное целое число без знака, указывающее количество строк, возвращаемых в строках.

**eType**: 32-разрядное целое число без знака, содержащее одно из следующих значений, указывающее тип выполняемой операции ровсик.



| Значение                         | Значение                                                  |
|-------------------------------|----------------------------------------------------------|
| Еровссикноне 0x00000000      | Нет Сикдескриптион, игнорировать поле Сикдескриптион.        |
| Еровсикнекст 0x00000001       | Сикдескриптион содержит структуру Кровсикнекст.       |
| Еровсикат 0x00000002         | Сикдескриптион содержит структуру Кровсикат.         |
| Еровсикатратио 0x00000003    | Сикдескриптион содержит структуру Кровсикатратио.    |
| Еровсикбибукмарк 0x00000004 | Сикдескриптион содержит структуру Кровсикбибукмарк. |



 

**\_ chap**: 32-разрядное значение, представляющее маркер главы набора строк.

**Сикдескриптион**: это поле должно содержать структуру типа, обозначенного полем eType.

**паддингровс**: длина этого поля должна быть достаточной (от 0 до \_ кбресервед-1 байт) для заполнения поля ROWS \_ значением кбресервед offset с начала сообщения, где \_ кбресервед — это значение в сообщении кпмжетровсин. Байты заполнения, используемые в этом поле, могут быть любым произвольным значением. Это поле должно игнорироваться получателем.

**Строки**: данные строк форматируются в соответствии со сведениями о столбцах в последнем сообщении кпмсетбиндингсин. Строки должны храниться в прямом порядке (например, строка 1 перед строкой 2).

Столбцы фиксированного размера должны храниться в смещениях, указанных последним сообщением Кпмсетбиндингсин.

Столбцы переменного размера (например, строки) должны храниться следующим образом:

-   Сами данные переменной (например, строка) хранятся ближе к концу буфера в порядке убывания (например, коллекция всех переменных данных для строки 1 находится в конце, строка 2 — в ближайшее и т. д.).
-   Область фиксированного размера (в начале буфера строк) должна содержать Кроввариант для каждого столбца, хранящийся в смещении, указанном в самом последнем сообщении Кпмсетбиндингсин. Втипе должен содержать тип данных (например, VT \_ LPWSTR). Если, как определено правилами в начале раздела в этом разделе, используется 32-разрядное смещение, а поле offset в Кроввариант должно содержать 32-разрядное значение, которое является смещением данных переменной от начала сообщения Кпмжетровсаут, плюс значение \_ улклиентбасе, указанное в последнем кпмжетровсин сообщении. Если используются 64-разрядные смещения, поле offset в Кроввариант должно содержать 64-разрядное значение, которое является смещением от начала сообщения Кпмжетровсаут, добавленного к 64-разрядному значению, созданному с помощью \_ улклиентбасе, в качестве младших 32-бит и \_ ulReserved2 в качестве 32 высоких-бит.

Например, если в сообщении Кпмсетбиндингсин указано два столбца — size (VT \_ i4) и Title (VT \_ LPWSTR), а \_ улклиентбасе from кпмжетровсин — 0x10000, то две строки будут выглядеть следующим образом. Раздел, помеченный серым цветом, является частью буфера фиксированной длины.

![Пример сообщения кпмсетбиндингсин](images/cpmgetrowsout.gif)

### <a name="22317-cpmratiofinishedin"></a>2.2.3.17 Кпмратиофинишедин

Сообщение Кпмратиофинишедин запрашивает процент завершения запроса. Формат сообщения Кпмратиофинишедин, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_хкурсор

\_фкуикк



 

**\_ хкурсор**: маркер из сообщения кпмкреатекуерйоут, идентифицирующего запрос, для которого запрашиваются сведения о завершении.

**\_ фкуикк**: необходимо задать значение 0x00000001. Не используется и должен игнорироваться сервером.

### <a name="22318-cpmratiofinishedout"></a>2.2.3.18 Кпмратиофинишедаут

Сообщение Кпмратиофинишедаут отвечает на сообщение Кпмратиофинишедин с коэффициентом завершения запроса. Формат сообщения Кпмратиофинишедаут, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_ улнумератор

\_улденоминатор

\_cRows

\_фневровс



 

**\_ улнумератор**: 32-битовое целое число без знака, указывающее числитель коэффициента завершения в терминах строк.

**\_ улденоминатор**: 32-битовое целое число без знака, указывающее знаменатель коэффициента завершения в терминах строк. ДОЛЖНО быть больше нуля.

**\_ crowset**: 32-разрядное целое число без знака, указывающее общее количество строк для запроса.

**\_ фневровс**: логическое значение, указывающее, доступны ли новые строки. Значение 0x00000001 указывает, что новые строки доступны в наборе строк. Значение 0x00000000 указывает, что набор строк не содержит новых строк. Для этого поля не должны быть заданы другие значения.

### <a name="22319-cpmfetchvaluein"></a>2.2.3.19 Кпмфетчвалуеин

Сообщение Кпмфетчвалуеин запрашивает значение свойства, которое слишком велико для возвращения в наборе строк. Как указано в разделе 3.2.4.2.5, это сообщение отправляется повторно для получения всех байтов свойства, обновляя \_ кбсофар для каждого, пока \_ поле Фмориксистс сообщения кпмфетчвалуеаут не будет установлено в **значение false**.

Формат сообщения Кпмфетчвалуеин, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_WID

\_кбсофар

\_кбпропспек

\_кбчунк

Пропспек (переменная)

...

\_Заполнение (переменная)



 

**\_ wid**: 32-разрядное целое число без знака, содержащее сведения об идентификаторе документа, определяющего документ, для которого должно быть выбрано свойство.

**\_ кбсофар**: 32-разрядное целое число без знака, содержащее число байтов, ранее переданных для этого свойства. В первом сообщении должно быть задано значение 0x00000000.

**\_ кбпропспек**: 32-разрядное целое число без знака, содержащее размер поля пропспек в байтах.

**\_ кбчунк**: 32-разрядное целое число без знака, содержащее максимальное число байтов, которое отправитель может принимать в сообщении кпмфетчвалуеаут.

*Windows Поведение: для этого поля задано значение 0x00004000 для всех версий Windows.*

**Пропспек**: структура кфуллпропспек, указывающая извлекаемое свойство.

**\_ Заполнение**: это поле должно иметь длину, необходимую (от 0 до 3 байт), для размещения сообщения до нескольких 4 байт. Значение заполнения байтов может быть любым произвольным значением. Это поле должно игнорироваться получателем.

### <a name="22320-cpmfetchvalueout"></a>2.2.3.20 Кпмфетчвалуеаут

Сообщение Кпмфетчвалуеаут отвечает на сообщение Кпмфетчвалуеин со значением свойства из предыдущего запроса. Как указано в разделе 3.1.5.2.8, это сообщение отправляется после каждого сообщения Кпмфетчвалуеин до тех пор, пока не будут переданы все байты свойства.

Формат сообщения Кпмфетчвалуеаут, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_кбвалуе

\_фмориксистс

\_фвалуиксистс

втипе

Управляемое vValue (переменная)



 

**\_ кбвалуе**: 32-разрядное целое число без знака, содержащее общий размер в байтах в управляемое vValue.

**\_ фмориксистс**: логическое значение, указывающее, доступны ли дополнительные сообщения кпмфетчвалуеаут. Если задано значение 0x00000001, то существуют дополнительные сообщения Кпмфетчвалуеаут. Если задано значение 0x00000000, дополнительные сообщения Кпмфетчвалуеаут недоступны.

**\_ фвалуиксистс**: логическое значение, указывающее, имеется ли значение для свойства. Если задано значение 0x00000001, то свойство существует. Если задано 0x00000000, значение свойства не существует.

**втипе**. значение из перечисления VARENUM. Дополнительные сведения см. в разделе 2.2.1.1, описывающем тип свойства.

**управляемое vValue**: часть массива байтов, содержащая структуру сериализедпропертивалуе, как указано в разделе 2.2.1.32, где смещение начала части является значением \_ кбсофар в кпмфетчвалуеин. Длина части, обозначенной \_ полем кбвалуе, должна быть равна значению \_ Кбчунк в кпмфетчвалуеин, если \_ фмориксистс имеет значение 0X00000001, и должно быть меньше или равно значению \_ кбчунк в противном случае.

### <a name="22321-cpmgetnotify"></a>2.2.3.21 Кпмжетнотифи

Сообщение Кпмжетнотифи запрашивает, что клиент хочет получать уведомления об изменениях набора строк.

Сообщение не должно включать текст. будет отправлен только заголовок сообщения, как указано в разделе 2.2.2.

### <a name="22322-cpmsendnotifyout"></a>2.2.3.22 Кпмсенднотифйоут

Сообщение Кпмсенднотифйоут уведомляет клиента об изменении результатов запроса.

Это сообщение отправляется, только когда происходит изменение. Формат сообщения Кпмсенднотифйоут, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_ватчнотифи



 

**\_ ватчнотифи**: изменение запроса. Оно должно иметь одно из следующих значений:



| Значение                                     | Значение                                             |
|-------------------------------------------|-----------------------------------------------------|
| ДБВАТЧНОТИФИ \_ ровсчанжед 0x00000001     | Изменилось число строк в наборе строк запроса. |
| ДБВАТЧНОТИФИ \_ куеридоне 0x00000002       | Запрос завершен.                            |
| ДБВАТЧНОТИФИ \_ куеририксекутед 0x00000003 | Запрос был повторно выполнен.                     |



 

### <a name="22323-cpmgetapproximatepositionin"></a>2.2.3.23 Кпмжетаппроксиматепоситионин

Сообщение Кпмжетаппроксиматепоситионин запрашивает приблизительное расположение закладки в главе. Формат сообщения Кпмжетаппроксиматепоситионин, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_хкурсор

\_Протокол CHAP

\_бмк



 

**\_ хкурсор**: 32-разрядное значение, представляющее курсор запроса, полученный из кпмкреатекуерйоут для набора строк, содержащего закладку.

**\_ chap**: 32-разрядное значение, представляющее маркер раздела, содержащего закладку.

**\_ бмк**: 32-разрядное значение, представляющее маркер закладки, для которой необходимо получить приблизительную точку.

### <a name="22324-cpmgetapproximatepositionout"></a>2.2.3.24 Кпмжетаппроксиматепоситионаут

Сообщение Кпмжетаппроксиматепоситионаут отвечает на сообщение Кпмжетаппроксиматепоситионин, описывающее примерное расположение закладки в главе. Формат сообщения Кпмжетаппроксиматепоситионаут, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_numerator

\_denominator



 

**\_ числитель**: 32-разрядное целое число без знака, содержащее номер строки закладки в наборе строк. Если строки отсутствуют, это поле должно иметь значение 0x00000000.

**\_ знаменатель**: 32-битовое целое число без знака, содержащее количество строк в наборе строк.

### <a name="22325-cpmcomparebmkin"></a>2.2.3.25 Кпмкомпаребмкин

Сообщение Кпмкомпаребмкин запрашивает сравнение двух закладок в главе.

Формат сообщения Кпмкомпаребмкин, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_хкурсор

\_Протокол CHAP

\_бмкфирст

\_бмксеконд



 

\_**хкурсор**: 32-разрядное значение, представляющее собой маркер из сообщения кпмкреатекуерйоут для набора строк, содержащего закладки.

\_**CHAP**: 32-разрядное значение, представляющее маркер главы, содержащей закладки для сравнения.

\_**бмкфирст**: 32-разрядное значение, представляющее маркер первой закладки для сравнения.

\_**бмксеконд**: 32-разрядное значение, представляющее маркер для сравнения с второй закладкой.

### <a name="22326-cpmcomparebmkout"></a>2.2.3.26 Кпмкомпаребмкаут

Сообщение Кпмкомпаребмкаут отвечает на сообщение Кпмкомпаребмкин с использованием сравнения двух закладок в главе. Формат сообщения Кпмкомпаребмкаут, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_двкомпарисон



 

\_**двкомпарисон**: одно из следующих значений, указывающее относительное положение двух закладок в главе.



| Значение                               | Значение                                                           |
|-------------------------------------|-------------------------------------------------------------------|
| ДБКОМПАРЕ \_ lt 0x00000000            | Первая закладка располагается перед второй.               |
| ДБКОМПАРЕ \_ EQ 0x00000001            | Первая закладка имеет ту же самую точку, что и вторая.           |
| ДБКОМПАРЕ \_ gt 0x00000002            | Первая закладка размещается после второй.                |
| ДБКОМПАРЕ \_ Ne 0x00000003            | Первая закладка не совпадает с позицией второго. |
| ДБКОМПАРЕ \_ ноткомпарабле 0x00000004 | Первая закладка не сравнима со вторым.               |



 

### <a name="22327-cpmrestartpositionin"></a>2.2.3.27 Кпмрестартпоситионин

Сообщение Кпмрестартпоситионин перемещает позицию выборки для курсора в начало главы. Как указано в разделе 3.1.5.2.12, сервер будет отвечать с помощью того же сообщения, а результаты запроса содержатся в \_ поле Status заголовка CISP.

Формат сообщения Кпмрестартпоситионин, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_Хкурсор (необязательно)

\_CHAP (необязательно)



 

**\_ хкурсор**: 32-разрядное значение, представляющее маркер, полученное из сообщения кпмкреатекуерйоут, которое определяет запрос, для которого нужно перезапустить эту точку. Это поле должно присутствовать, когда клиент отправляет сообщение, и должно отсутствовать, когда сервер отправляет сообщение.

**\_ chap**: 32-разрядное значение, представляющее маркер главы, из которой извлекаются строки. Это поле должно присутствовать, когда клиент отправляет сообщение, и должно отсутствовать, когда сервер отправляет сообщение.

### <a name="22328-cpmfreecursorin"></a>2.2.3.28 Кпмфрикурсорин

Сообщение Кпмфрикурсорин запрашивает выпуск курсора. Формат сообщения Кпмфрикурсорин, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_хкурсор



 

**\_ хкурсор**: 32-разрядное значение, представляющее маркер курсора из сообщения кпмкреатекуерйоут для выпуска.

### <a name="22329-cpmfreecursorout"></a>2.2.3.29 Кпмфрикурсораут

Сообщение Кпмфрикурсораут отвечает на сообщение Кпмфрикурсорин с результатами освобождения курсора. Формат сообщения Кпмфрикурсораут, следующий за заголовком:



0

1

2

3

4

5

6

7

8

9

1<br/> 0<br/>

1

2

3

4

5

6

7

8

9

2<br/> 0<br/>

1

2

3

4

5

6

7

8

9

3<br/> 0<br/>

1

\_ккурсорсремаининг



 

**\_ ккурсорсремаининг**: 32-битовое целое число без знака, указывающее количество курсоров, которые все еще используются для запроса.

### <a name="22330-cpmdisconnect"></a>2.2.3.30 Кпмдисконнект

Сообщение Кпмдисконнект завершает подключение к серверу

Сообщение не должно включать текст. будет отправлен только заголовок сообщения, как указано в разделе 2.2.2.

### <a name="224-errors"></a>ошибки 2.2.4

Все сообщения протокола службы индексирования содержимого должны возвращать 0x00000000 при успешном выполнении; в противном случае они возвращают 32-разрядный ненулевой код ошибки, который может быть либо HRESULT, либо значением NTSTATUS (см. раздел 1,8). Если буфер слишком мал и не умещается в результате, \_ должен быть возвращен код состояния недостаточно \_ ресурсов (0xC0000009A), и Неудачная операция должна быть повторена с буфером большего размера.

Все остальные значения ошибок должны обрабатываться одинаково.

(Обратите внимание, что в настоящее время пробелы в значениях HRESULT и NTSTATUS не перекрываются, за исключением идентичных значений, но даже в случае возникновения конфликтов в будущем это не вызовет никаких проблем с протоколом, если значение параметра STATUS \_ Недостаточные \_ ресурсы остаются уникальными, так как все остальные значения ошибок обрабатываются одинаково.)

## <a name="3-protocol-details"></a>3. Сведения о протоколе

-   [Сведения о сервере 3,1](#31-server-details)
-   [3,2. сведения о клиенте](#32-client-details)

Запросы сообщений CISP для удаленного запроса каталогов службы индексирования не нуждаются в определенной последовательности. Рекомендуется, чтобы более высокий уровень приступил к осмысленной последовательности сообщений, как и для сообщений, полученных из этой последовательности или с недопустимыми данными, сервер будет отвечать с ошибкой. Некоторые сообщения также зависят от более высокого уровня, предоставляющего допустимые данные, полученные в сообщениях, предшествующих последовательности.

На следующей схеме показана типичная последовательность сообщений для простого запроса от клиента к удаленному компьютеру.

![последовательность сообщений для простого запроса](images/protocoldetails.jpg)

Сообщения, представленные на предыдущей схеме, представляют собой подмножество всех сообщений CISP, используемых для запроса каталога службы удаленного индексирования.

### <a name="31-server-details"></a>Сведения о сервере 3,1

### <a name="311-abstract-data-model"></a>3.1.1. Абстрактная модель данных

В следующем разделе задаются данные и состояние, поддерживаемые сервером CISP. Приведенные здесь данные предназначены для упрощения объяснения того, как работает протокол. Этот раздел не требует, чтобы реализации применялись к этой модели, если их внешнее поведение согласуется с, описанным в этом документе.

Служба индексирования, реализующая CISP, должна поддерживать следующие абстрактные элементы данных:

-   Список клиентов, подключенных к серверу
-   Сведения о каждом клиенте, включая:
-   -   Версия клиента (как указано в сообщении Кпмконнектин, указанном в разделе 2.2.3.6)
    -   Каталог, связанный с клиентом (с помощью сообщения Кпмконнектин)
    -   Дополнительные свойства клиента, как указано в разделе 2.2.1.21.1.
    -   Поисковый запрос клиента
    -   Список дескрипторов курсоров для запроса и позиции в результирующем наборе для каждого дескриптора.
    -   Текущий набор привязок
    -   Текущее состояние запроса, включающего (для каждого курсора):
    -   -   Число строк в результатах запроса
        -   Числитель и знаменатель завершения запроса
        -   Последнее число строк, сообщаемое последним сообщением Кпмратиофинишедаут для данного курсора
        -   Будет ли запрос отслеживаться сервером на предмет изменений в результатах запроса, и если он отслеживается, что изменилось в результатах запроса с момента последнего сообщения клиенту, Кпмсенднотифйоут
        -   Список обработчиков глав, обслуживаемых этим запросом клиенту.
        -   Список дескрипторов закладок для каждого курсора, обслуживаемого этим запросом клиенту.

-   Текущее состояние службы индексирования, которое может быть "не инициализировано", "выполняется" или "завершение работы". Обратите внимание, что большая часть времени сервера находится в состоянии "выполняется". Ниже приведена схема конечного автомата для сервера.

    ![схема конечного автомата сервера службы индексирования](images/abstractdatamodel.jpg)

-   Сведения о каталоге: Количество индексируемых документов, размер индекса, число уникальных ключей и т. д. (см. раздел 2.2.3.1 для полного списка), State (соответствует значениям Двневстате в разделе 2.2.3.2).
-   Для каждого поддерживаемого языка база данных вариантов слов, описанная в разделе 2.2.1.3.

### <a name="312-timers"></a>3.1.2. Таймеры

Таймеры протокола не требуются.

### <a name="313-initialization"></a>3.1.3. Инициализация

После инициализации сервер должен установить свое состояние "не инициализировано" и начать прослушивание сообщений по именованному каналу, указанному в разделе 1,9. После выполнения любой другой внутренней инициализации она должна перейти в состояние "выполняется".

### <a name="314-higher-layer-triggered-events"></a>3.1.4. Активируемые события более высокого уровня

Нет.

### <a name="315-message-processing-and-sequencing-rules"></a>Правила обработки сообщений 3.1.5. и последовательности

При возникновении ошибки во время обработки сообщения, отправленного клиентом, сервер должен сообщить об ошибке обратно клиенту следующим образом:

-   Прерывать обработку сообщения, отправленного клиентом
-   Ответ с заголовком сообщения (только) сообщения, отправленного клиентом, оставляя \_ поле сообщения неизменным.
-   Задайте в \_ поле Состояние значение кода ошибки.

При поступлении сообщения сервер должен проверить \_ значение поля MSG, чтобы узнать, является ли он известным типом (см. раздел 2.2.2). Если тип неизвестен, он должен сообщить \_ \_ об ошибке Status (недопустимый параметр) (0xC000000D).

После этого сервер должен проверить \_ значение поля улчекксум, если тип сообщения имеет одно из следующих значений:

-   Кпмконнектин (0x000000C8)
-   Кпмкреатекуерин (0x000000CA)
-   Кпмсетбиндингсин (0x000000D0)
-   Кпмжетровсин (0x000000CC)
-   Кпмфетчвалуеин (0x000000E4)

Чтобы проверить \_ значение поля улчекксум, сервер должен проверить значение, указанное клиентом в \_ поле Иклиентверсион сообщения кпмконнектин.

Если \_ для поля иклиентверсион не задано значение 0x00000008, а \_ для поля улчекксум не задано значение 0x00000000, сервер должен сообщить о состоянии \_ недопустимого \_ параметра (0xC000000D). Сервер не должен проверять \_ поле улчекксум для клиентов, присвойте \_ полю иклиентверсион значение меньше 0x00000008.

Если \_ значение поля иклиентверсионфиелд равно 0x00000008 или больше, сервер должен проверить, что \_ поле улчекксум было вычислено как указано в разделе 3.2.4. Если \_ значение улчекксум недопустимо, сервер должен сообщить \_ \_ об ошибке состояния недопустимого параметра (0xC000000D).

Затем сервер проверяет, в каком состоянии находится. Если состояние "не инициализировано", сервер должен сообщить \_ \_ об ошибке CI E Not \_ Initialized (0x8004180B). Если состояние "завершение работы", сервер должен сообщить \_ об ошибке "CI E \_ Shutdown (0x80041812)".

После того как заголовок определен как допустимый и сервер находится в состоянии "выполняется", дальнейшая обработка сообщений должна быть выполнена, как указано в подразделах ниже.

### <a name="3151-remote-indexing-service-catalog-management"></a>Управление каталогом службы удаленного индексирования 3.1.5.1

### <a name="31511-receiving-a-cpmcistateinout-request"></a>3.1.5.1.1 получение запроса КпмЦистатеинаут

Когда сервер получает запрос сообщения КпмЦистатеинаут от клиента, сервер должен сначала проверить, находится ли клиент в списке подключенных клиентов. Если клиент отсутствует в списке, сервер должен сообщить \_ \_ об ошибке Status (недопустимый параметр) (0xC000000D). В противном случае он должен ответить клиенту сообщением КпмЦистатеинаут, заполняя его данными о связанном с клиентом каталоге, как указано в разделе 2.2.3.1.

### <a name="31512-receiving-a-cpmsetcatstatein-request"></a>3.1.5.1.2 получение запроса Кпмсеткатстатеин

Когда сервер получает запрос сообщения Кпмсеткатстатеин от клиента, сервер должен выполнить следующие действия.

-   Убедитесь, что у клиента есть административный доступ. Если у клиента отсутствует административный доступ, сервер должен сообщить \_ \_ об ошибке отказа в доступе (0xC0000022).
-   Если \_ двневстате не равно Цикат \_ все открытые, \_ измените состояние каталога, указанного в поле катнаме, как указано в \_ поле двневстате. Дополнительные сведения см. в разделе 2.2.3.2. Если сервер не находит каталог с именем, указанным в поле Катнаме, сервер должен вернуть состояние \_ Ошибка недопустимого \_ параметра (0xC000000D).
-   Ответ на клиент с помощью сообщения Кпмсеткатстатеаут, где \_ ДВОЛДСТАТЕ должно быть установлено предыдущее состояние каталога. Если \_ двневстате РАВЕН Цикат \_ все \_ открытые, сервер должен проверить состояние всех каталогов и, если все они запущены, должен установить \_ для дволдстате значение 0x00000001, а в противном случае задать для \_ дволдстате значение 0x00000000.

### <a name="31513-receiving-a-cpmupdatedocumentsin-request"></a>3.1.5.1.3 получение запроса Кпмупдатедокументсин

Когда сервер получает запрос сообщения Кпмупдатедокументсин, сервер должен выполнить следующие действия.

-   Проверьте, находится ли клиент в списке подключенных клиентов (которые имеют связанный каталог). Если клиент отсутствует в списке, сервер должен сообщить \_ \_ об ошибке Status (недопустимый параметр) (0xC000000D).
-   Убедитесь, что у клиента есть административный доступ. Если у клиента нет прав администратора для доступа к серверу, сервер должен сообщить \_ \_ об ошибке отказа в доступе (0xC0000022).
-   Начало процесса индексирования пути, указанного клиентом, выполнение полного или добавочного сканирования в зависимости от значения \_ поля флага в сообщении кпмупдатедокументсин. Если путь не был ранее проиндексирован, его необходимо добавить в коллекцию индексированных расположений и выполнить полную проверку. Если указано недопустимое значение \_ поля флага, сервер должен действовать так, как если бы \_ флаг был установлен в значение UPD \_ init и выполнял полную проверку. Эта операция должна выполняться в каталоге, связанном с клиентом.
-   Ответьте на клиент с помощью заголовка сообщения для Кпмупдатедокументсин и задайте в \_ поле Status результаты запроса.

### <a name="31514-receiving-a-cpmforcemergein-request"></a>3.1.5.1.4 получение запроса Кпмфорцемержеин

Когда сервер получает запрос сообщения Кпмфорцемержеин, сервер должен выполнить следующие действия.

-   Проверьте, находится ли клиент в списке подключенных клиентов (которые имеют связанный каталог). Если клиент отсутствует в списке, сервер должен сообщить \_ об ошибке состояния "Недопустимый \_ параметр" (0xC000000D).
-   Убедитесь, что у клиента есть административный доступ. Если у клиента отсутствует административный доступ, сервер должен сообщить \_ \_ об ошибке отказа в доступе (0xC0000022).
-   Начните любой процесс обслуживания, необходимый для повышения производительности запросов к каталогу, связанному с клиентом.
-   Ответьте на клиент с помощью заголовка сообщения для Кпмфорцемержеин и задайте в \_ поле Status результаты запроса.

Обратите внимание, что процесс обслуживания является асинхронным и может продолжаться после того, как клиент получит ответное сообщение. Этот процесс не влияет непосредственно на протокол (кроме времени отклика).

### <a name="3152-remote-indexing-service-querying"></a>Запросы удаленной службы индексирования 3.1.5.2

### <a name="31521-receiving-a-cpmconnectin-request"></a>3.1.5.2.1 получение запроса Кпмконнектин

Когда сервер получает запрос Кпмконнектин от клиента, сервер должен выполнить следующие действия.

-   Проверьте, находится ли клиент в списке подключенных клиентов. В этом случае сервер должен сообщить \_ \_ об ошибке Status (недопустимый параметр) (0xC000000D).
-   Проверяет, существует ли указанный каталог, но не находится в остановленном состоянии. Если это не так, то сервер должен сообщить \_ \_ об ошибке Reporting E без \_ каталога (0x8004181D).
-   Добавьте клиент в список подключенных клиентов.
-   Свяжите каталог с клиентом.
-   Храните в состоянии клиента сведения, передаваемые в сообщении Кпмконнектин (например, имя каталога, версия клиента и т. д.).
-   Ответ на клиент с помощью сообщения Кпмконнектаут.

### <a name="31522-receiving-a-cpmcreatequeryin-request"></a>3.1.5.2.2 получение запроса Кпмкреатекуерин

Когда сервер получает запрос сообщения Кпмкреатекуерин от клиента, сервер должен выполнить следующие действия.

-   Проверьте, находится ли клиент в списке подключенных клиентов. Если это не так, сервер должен сообщить \_ \_ об ошибке Status (недопустимый параметр) (0xC000000D).
-   Убедитесь, что у клиента уже есть связанный с ним запрос. В этом случае сервер должен сообщить \_ \_ об ошибке Status (недопустимый параметр) (0xC000000D).
-   Проверьте, находится ли каталог, связанный с клиентом, в состоянии, что позволяет обрабатывать запросы (ЦИКАТ \_ ReadOnly или Цикат с \_ возможностью записи). Если это не так, сервер должен сообщить \_ \_ \_ об ошибке запроса No (0x8004160C).
-   Проанализируйте набор ограничений, порядок сортировки и группирования, указанные в запросе. Если сервер обнаруживает ошибку, он должен сообщить о соответствующей ошибке. Если по какой бы то ни было причине этот шаг завершается сбоем, сервер должен сообщить об обнаруженной ошибке. Сведения об ошибках запросов службы индексирования см \[ . в разделе MSDN-куерерр \] .
-   Сохраните поисковый запрос в состоянии клиента.
-   Выполните все подготовительные действия, необходимые для обслуживания строк на клиенте, и свяжите запрос с соответствующими дескрипторами курсора (в зависимости от информации, передаваемой в сообщении Кпмкреатекуерин).
-   Добавьте эти дескрипторы в список дескрипторов курсоров клиента и инициализируйте списки дескрипторов глав и закладок.
-   Инициализировать список дескрипторов глав для каждого курсора в этом запросе на базу данных \_ со значением NULL \_ параметру hChapter
-   Инициализируйте список дескрипторов закладок для каждого курсора в этом запросе на набор ДББМК \_ First и дббмк \_ Last.
-   Пометьте запрос как неотслеживаемый для изменений.
-   Инициализирует количество строк до текущего вычисленного числа строк (может быть 0, если запрос не начал выполнение или какое-либо число, если запрос находится в процессе выполнения) и инициализирует числитель и знаменатель завершения запроса.
-   Ответ на клиент с помощью сообщения Кпмкреатекуерйоут.

### <a name="31523-receiving-a-cpmgetquerystatusin-request"></a>3.1.5.2.3 получение запроса Кпмжеткуеристатусин

Когда сервер получает запрос сообщения Кпмжеткуеристатусин от клиента, сервер должен выполнить следующие действия.

-   Проверьте, связан ли с клиентом запрос. Если это не так, сервер должен сообщить \_ \_ об ошибке Status (недопустимый параметр) (0xC000000D).
-   Проверьте, находится ли дескриптор курсора в списке дескрипторов курсора клиента. Если это не так, сервер должен сообщить \_ об ошибке E Fail (0x80004005).
-   Подготовка сообщения Кпмжеткуеристатусаут. Сервер должен получить текущее состояние запроса и задать его в \_ поле кстатус (см. 2.2.3.11 для возможных значений). Если по какой бы то ни было причине выполнить этот шаг не удается, сервер должен сообщить об ошибке.
-   Ответ на клиент с помощью сообщения Кпмжеткуеристатусаут.

### <a name="31524-receiving-a-cpmgetquerystatusexin-request"></a>3.1.5.2.4 получение запроса Кпмжеткуеристатусексин

Когда сервер получает запрос сообщения Кпмжеткуеристатусексин от клиента, сервер должен выполнить следующие действия.

-   Проверьте, связан ли с клиентом запрос. Если это не так, сервер должен сообщить \_ \_ об ошибке Status (недопустимый параметр) (0xC000000D).
-   Проверьте, находится ли переданный дескриптор курсора в списке дескрипторов курсора клиента. Если это не так, сервер должен сообщить \_ об ошибке E Fail (0x80004005).
-   Подготовка сообщения Кпмжеткуеристатусексаут. Сервер должен получить текущее состояние запроса и ход выполнения запроса и задать Кстатус (см. 2.2.3.11 для возможных значений), \_ двратиофинишедденоминатор и \_ двратиофинишеднумератор соответственно. Затем необходимо задать для кровстотал число строк в результатах запроса \_ . Если этот шаг завершается неудачей по каким либо причинам, сервер должен сообщить о том, что произошла ошибка.
-   Получите сведения о каталоге клиента и заполните \_ кфилтереддокументс и \_ кдокументстофилтер. Если по какой бы то ни было причине выполнить этот шаг не удается, сервер должен сообщить о том, что произошла ошибка.
-   Получите расположение закладки, обозначенной маркером в \_ поле БМК, и заполните оставшееся \_ поле ировбмк в сообщении кпмжеткуеристатусексаут. Если этот шаг завершается неудачей по каким либо причинам, сервер должен сообщить о том, что произошла ошибка.
-   Ответ на клиент с помощью сообщения Кпмжеткуеристатусексаут.

### <a name="31525-receiving-a-cpmratiofinishedin-request"></a>3.1.5.2.5 получение запроса Кпмратиофинишедин

Когда сервер получает запрос сообщения Кпмратиофинишедин от клиента, сервер должен выполнить следующие действия.

-   Проверьте, связан ли с клиентом запрос. Если это не так, сервер должен сообщить \_ \_ об ошибке Status (недопустимый параметр) (0xC000000D).
-   Проверьте, находится ли переданный дескриптор курсора в списке дескрипторов курсора клиента. Если это не так, сервер должен сообщить \_ об ошибке E Fail (0x80004005).
-   Подготовка сообщения Кпмратиофинишедаут. Сервер должен получить состояние запроса клиента и заполнить \_ поля улнумератор, \_ улденоминатор и \_ CRowset. Если по какой бы то ни было причине выполнить этот шаг не удается, сервер должен сообщить о том, что произошла ошибка.
-   Если \_ CRowset равно последнему сообщаемому числу строк для этого запроса, установите \_ фневровс в 0x00000000, в противном случае задайте для него значение 0x00000001.
-   Обновить Последнее сообщаемое количество строк для этого запроса до значения \_ CRowset.
-   Ответ на клиент с помощью сообщения Кпмратиофинишедаут.

### <a name="31526-receiving-a-cpmsetbindingsin-request"></a>3.1.5.2.6 получение запроса Кпмсетбиндингсин

Когда сервер получает запрос сообщения Кпмсетбиндингсин от клиента, сервер должен выполнить следующие действия.

-   Проверьте, связан ли с клиентом запрос. Если это не так, сервер должен сообщить \_ \_ об ошибке Status (недопустимый параметр) (0xC000000D).
-   Проверьте, находится ли переданный дескриптор курсора в списке дескрипторов курсора клиента. Если это не так, сервер должен сообщить \_ об ошибке E Fail (0x80004005).
-   Убедитесь, что сведения о привязках допустимы (т. е. столбец, по крайней мере, указывает значение, длину или состояние, которое должно быть возвращено; не пересекается в привязках для значения, длины или состояния; и значения, длины и состояния в указанном размере строки) и если не сообщать \_ \_ об ошибке DB e Бадбиндинфо (0x80040E08).
-   Сохраните сведения о привязке, связанные со столбцами, указанными в поле Аколумнс. Если по какой бы то ни было причине выполнить этот шаг не удается, сервер должен сообщить о том, что произошла ошибка.
-   Ответ на клиент с заголовком сообщения (только) с \_ установленным сообщением кпмсетбиндингсин и \_ состоянием, равным результатам указанной привязки.

### <a name="31527-receiving-a-cpmgetrowsin-request"></a>3.1.5.2.7 получение запроса Кпмжетровсин

Когда сервер получает запрос сообщения Кпмжетровсин от клиента, сервер должен выполнить следующие действия.

-   Проверьте, связан ли с клиентом запрос. Если это не так, сервер должен сообщить \_ \_ об ошибке Status (недопустимый параметр) (0xC000000D).
-   Убедитесь, что переданный дескриптор курсора находится в аселист дескрипторов курсора клиента. Если это не так, сервер должен сообщить \_ об ошибке E Fail (0x80004005).
-   Проверьте, имеет ли клиент текущий набор привязок. Если это не так, сервер должен сообщить \_ об ошибке E Fail (0x80004005).
-   Подготовка сообщения Кпмжетровсаут. Сервер должен располагать курсор в результатах запроса, как указано в описании поиска. Если по какой бы то ни было причине выполнить этот шаг не удается, сервер должен сообщить о том, что произошла ошибка.
-   Выберет столько строк, сколько замещается в буфере, размер которого обозначен параметром \_ кбреадбуффер, но не больше, чем указано в \_ кровстотрансфер. При выборке строк сервер должен сравнить тип значения свойства выбранного столбца с типом, указанным в текущем наборе привязок клиента (раздел 3.1.1). Если тип в привязке не является \_ вариантом VT, сервер должен попытаться преобразовать значение свойства столбца в этот тип. В противном случае, если установлен \_ флаг DBPROP усикстендеддбтипес в \_ наборе свойств DBPROPSET куерекст клиента или если значение свойства столбца не является \_ векторным типом VT, значение свойства должно возвращаться в его нормальном типе. Если ни один из вариантов не является случайом (т. е. у сервера есть \_ Векторный тип VT, а клиент не поддерживает \_ вектор VT), сервер должен попытаться преобразовать его в \_ тип массива VT следующим образом: VT \_ i8, VT \_ UI8, VT \_ fileTime и VT \_ CLSID элементы массива не могут быть преобразованы, а завершаться ошибкой. \_Элементы массива VT LPSTR и VT \_ LPWSTR должны быть преобразованы в VT \_ BSTR; элементы массива всех остальных типов должны оставаться неизменными. Наконец, если столбцы строки содержат дескрипторы глав или маркеры закладок, сервер должен обновить соответствующие списки. Если по какой бы то ни было причине выполнить этот шаг не удается, сервер должен сообщить о том, что произошла ошибка.
-   Сохранение фактического числа строк, извлекаемых в \_ кровсретурнед.
-   Скопируйте описание поиска и поле раздела из Кпмжетровсин в сообщение Кпмжетровсаут для отправки.
-   Сохранять полученные строки в поле строк (см. Примечание о состоянии ниже и разделе 2.2.3.16 в структуре поля строк).
-   Ответ на клиент с помощью сообщения Кпмжетровсаут.

Примечание о поле "байт состояния":

Если для Статусусед задано значение 0x01 в Ктаблеколумн сообщения Кпмсетбиндингин для столбца, то сервер должен установить байт состояния (который находится в Статусоффсет с начала строки) для этого столбца в одно из следующих значений:



| Значение | Значение        |
|-------|----------------|
| 0x00  | статусок       |
| 0x01  | статусдеферред |
| 0x02  | статуснулл     |



 

Если значение свойства отсутствует для этой строки, сервер должен задать для параметра Byte состояния значение Статуснулл. Если значение слишком велико для передачи в сообщение Кпмжетровсаут, сервер должен задать для параметра Byte состояния значение Статусдеферред. В противном случае сервер должен установить байт состояния в Статусок.

### <a name="31528-receiving-a-cpmfetchvaluein-request"></a>3.1.5.2.8 получение запроса Кпмфетчвалуеин

Когда сервер получает запрос сообщения Кпмфетчвалуеин от клиента, сервер должен выполнить следующие действия.

-   Проверьте, связан ли с клиентом запрос. Если это не так, сервер должен сообщить \_ \_ об ошибке Status (недопустимый параметр) (0xC000000D).
-   Подготовка сообщения Кпмфетчвалуеаут. Если по какой бы то ни было причине выполнить этот шаг не удается, сервер должен сообщить об ошибке.
-   Найдите документ, указанный в \_ поле WID, и проверьте, доступен ли для этого клиента идентификатор свойства для этого документа (в дальнейшем именуемый как "значение свойства"), указанный в структуре пропспек. Если это значение недоступно, сервер должен установить значение \_ фвалуиксистс в 0x00000000, а в противном случае задать \_ для фвалуиксистс значение 0x00000001. Если по какой бы то ни было причине выполнить этот шаг не удается, сервер должен сообщить об ошибке.
-   Если \_ фвалуиксистс равен 0x00000001, сервер должен выполнить следующие действия:
-   -   Сериализует значение свойства в структуру СЕРИАЛИЗЕДПРОПЕРТИВАЛУЕ и копирует, начиная с \_ смещения кбсофар, \_ не более кбчунк байт (но не после конца сериализованного свойства) в поле управляемое vValue. Если этот шаг завершается неудачей по каким либо причинам, сервер должен сообщить об ошибке.
    -   Задайте \_ для кбвалуе число байтов, скопированных на предыдущем шаге.
    -   Задайте для Втипе тип свойства значения свойства.
    -   Если длина сериализованного свойства больше \_ кбсофар, добавленного в \_ кбвалуе, задайте \_ для фмориксистс значение 0x00000001, в противном случае задайте для него значение 0x00000000.

-   Ответ на клиент с помощью сообщения Кпмфетчвалуеаут

### <a name="31529-receiving-a-cpmgetnotify-request"></a>3.1.5.2.9 получение запроса Кпмжетнотифи

Когда сервер получает сообщение Кпмжетнотифи от клиента, сервер должен выполнить следующие действия.

-   Проверьте, связан ли с клиентом запрос. Если это не так, сервер должен сообщить \_ \_ об ошибке Status (недопустимый параметр) (0xC000000D).
-   Если в результирующем наборе запроса не было изменений с момента последнего сообщения Кпмсенднотифйоут для этого клиента или если запрос в настоящий момент не отслеживает изменения в результирующем наборе, сервер должен ответить с сообщением Кпмжетнотифи и начать отслеживать запрос на изменения в наборе результатов. Если позднее в наборе результатов запроса произошло изменение, сервер должен отправить клиенту ровно одно сообщение Кпмсенднотифйоут и указать изменение в \_ поле ватчнотифи.
-   Если с момента последнего сообщения Кпмсенднотифйоут в результирующий набор запроса были внесены изменения, сервер должен ответить на Кпмсенднотифйоут и указать изменение в \_ поле ватчнотифи. Обратите внимание, что в случае большого количества изменений в результатах запроса ДБВАТЧНОТИФИ \_ ровсчанжед имеет приоритет (т. е. Если запрос выполнен, повторное выполнение, а затем число измененных строк и запрос был выполнен повторно, то событие, о котором было отправлено, было бы дбватчнотифи \_ ровсчанжед).

### <a name="315210-receiving-a-cpmgetapproximatepositionin-request"></a>3.1.5.2.10 получение запроса Кпмжетаппроксиматепоситионин

Когда сервер получает запрос сообщения Кпмжетаппроксиматепоситионин от клиента, сервер должен выполнить следующие действия.

-   Проверьте, связан ли с клиентом запрос. Если это не так, сервер должен сообщить \_ \_ об ошибке Status (недопустимый параметр) (0xC000000D).
-   Проверьте, находятся ли в соответствующих списках маркер курсора, маркер раздела и маркер закладки. Если это не так, сервер должен сообщить \_ об ошибке E Fail (0x80004005).
-   Найти строку, связанную с маркером закладки в результатах запроса и приблизительной позицией строки в наборе строк, на которую ссылается маркер главы, и определить числитель и знаменатель для этой должности. Обратите внимание, что если маркер главы имеет \_ значение DB NULL \_ параметру hChapter, то соответствующая глава является основным набором строк запроса. Если по какой бы то ни было причине выполнить этот шаг не удается, сервер должен сообщить об ошибке.
-   Ответ на клиент с помощью сообщения Кпмфетчвалуеаут.

### <a name="315211-receiving-a-cpmcomparebmkin-request"></a>3.1.5.2.11 получение запроса Кпмкомпаребмкин

Когда сервер получает запрос сообщения Кпмкомпаребмкин от клиента, сервер должен выполнить следующие действия.

-   Проверьте, связан ли с клиентом запрос. Если это не так, сервер должен сообщить \_ \_ об ошибке Status (недопустимый параметр) (0xC000000D).
-   Проверьте, находятся ли в соответствующих списках дескриптор курсора, дескрипторы разделов и маркеры закладок. Если это не так, сервер должен сообщить \_ об ошибке E Fail (0x80004005).
-   Подготовка сообщения Кпмкомпаребмкаут.
-   Если маркеры закладки равны, \_ ДВКОМПАРИСОН должен иметь значение дбкомпаре \_ EQ.
-   В противном случае, если один из дескрипторов закладок является ДББМК \_ первым или дббмк \_ последним, \_ двкомпарисон должен иметь значение дбкомпаре \_ Ne.
-   В противном случае сервер должен выполнить следующие действия.
-   -   Поиск строк, на которые ссылается каждый маркер закладки в результатах запроса
    -   Если какая-либо из строк не входит в главу, обозначенную маркером главы в Кпмкомпаребмкин, \_ для ДВКОМПАРИСОН необходимо задать значение дбкомпаре \_ ноткомпарабле.
    -   В противном случае, если обе строки находятся в одной и той же главе, сервер должен приблизительно соответствовать положению этих строк в наборе строк, на который ссылается этот маркер главы. Затем он должен сравнить значения позиций и установить \_ для двкомпарисон значение дбкомпаре \_ lt, если значение первой строки меньше, чем у второй строки. в противном случае \_ двкомпарисон должно быть установлено в дбкомпаре \_ gt.

-   Ответ на клиент с заполненным сообщением Кпмкомпаребмкаут.

### <a name="315212-receiving-a-cpmrestartpositionin-request"></a>3.1.5.2.12 получение запроса Кпмрестартпоситионин

Когда сервер получает запрос сообщения Кпмрестартпоситионин от клиента, сервер должен выполнить следующие действия.

-   Проверьте, связан ли с клиентом запрос. Если это не так, сервер должен сообщить \_ \_ об ошибке Status (недопустимый параметр) (0xC000000D).
-   Проверьте, пройдены ли в соответствующих списках маркер курсора и маркер раздела. Если это не так, сервер должен сообщить \_ об ошибке E Fail (0x80004005).
-   Переместить курсор в начало главы, определяемое маркером главы. Обратите внимание, что если маркер главы имеет \_ значение DB NULL \_ параметру hChapter, то соответствующая глава является основным набором строк запроса. Если по какой бы то ни было причине выполнить этот шаг не удается, сервер должен сообщить об ошибке.
-   Ответ на клиент с помощью сообщения Кпмрестартпоситионин.

### <a name="315213-receiving-a-cpmfreecursorin-request"></a>3.1.5.2.13 получение запроса Кпмфрикурсорин

Когда сервер получает запрос сообщения Кпмфрикурсорин от клиента, сервер должен выполнить следующие действия.

-   Проверьте, связан ли с клиентом запрос. Если это не так, сервер должен сообщить \_ \_ об ошибке Status (недопустимый параметр) (0xC000000D).
-   Проверьте, находится ли переданный дескриптор курсора в списке дескрипторов курсора клиента. Если это не так, сервер должен сообщить \_ об ошибке E Fail (0x80004005).
-   Отпустите курсор и связанные ресурсы (см. раздел 3.1.1 для получения полного списка) для этого маркера курсора.
-   Удалить курсор из списка курсоров для этого клиента.
-   Ответьте на сообщение Кпмфрикурсораут, установив в \_ поле ккурсорсремаининг число оставшихся курсоров. в списке этого клиента.
-   Если для этого клиента больше нет курсоров, сервер должен освободить запрос и связанные с ним ресурсы (см. раздел 3.1.1).

### <a name="315214-receiving-a-cpmdisconnect-request"></a>3.1.5.2.14 получение запроса Кпмдисконнект

Когда сервер получает запрос сообщения Кпмдисконнект от клиента, сервер должен удалить клиент из списка подключенных клиентов и освободить все ресурсы, связанные с клиентом.

### <a name="316-timer-events"></a>События таймера 3.1.6

Нет.

### <a name="317-other-local-events"></a>3.1.7 другие локальные события

Когда сервер остановлен, он должен сначала перейти в состояние "завершение работы". Затем он должен остановить прослушивание канала, выполнить другие задачи завершения работы, связанные с реализацией, а затем перейти в состояние "остановлено".

### <a name="32-client-details"></a>3,2. сведения о клиенте

### <a name="321-abstract-data-model"></a>абстрактная модель данных 3.2.1

В следующем разделе указываются данные и состояние, поддерживаемые клиентом протокола службы индексирования содержимого. Предоставленные данные предназначены для упрощения объяснения того, как работает протокол. Этот раздел не требует, чтобы реализации применялись к этой модели, если их внешнее поведение согласуется с, описанным в этом документе.

Клиент имеет следующее абстрактное состояние:

-   **Последнее отправленное сообщение**: копия последнего сообщения, отправленного на сервер.
-   **Текущее значение свойства**: частичное значение свойства "отложено", которое находится в процессе извлечения.
-   **Текущее число полученных байтов**: количество байтов, полученных для текущего значения свойства до настоящего времени.
-   **Состояние подключения именованного канала**: соединение с сервером.

### <a name="322-timers"></a>таймеры 3.2.2

Таймеры протокола не требуются.

### <a name="323-initialization"></a>Инициализация 3.2.3

Никакие действия не выполняются до получения запроса на более высоком уровне.

### <a name="324-higher-layer-triggered-events"></a>3.2.4 события, активируемые Higher-Layer

При получении запроса от более высокого уровня клиент должен создать соединение именованного канала с сервером, используя сведения, указанные в разделе 2,1. Если это невозможно, запрос более высокого уровня должен быть неудачным. Это значит, что в случае сбоя подключения следует повторить попытку, если это необходимо.

Заголовок должен быть предварительно заполнен полями, заданными в разделе 2.2.2.

Для сообщений, которые задаются как запрашивающие ненулевую контрольную сумму, \_ значение УЛЧЕККСУМ должно быть вычислено следующим образом:

1.  Содержимое сообщения после \_ поля ulReserved2 в заголовке сообщения должно интерпретироваться как последовательность из 32 битовых целых чисел. Клиент должен вычислить сумму числовых значений, заданных этими целыми числами.
2.  Вычислите побитовое ИСКЛЮЧАЮЩее это значение с помощью 0x59533959.
3.  Вычтите значение, заданное в \_ MSG, из значения, полученного в результате побитового исключающего XOR.

### <a name="3241-remote-indexing-service-catalog-management"></a>Управление каталогом службы удаленного индексирования 3.2.4.1

Каждое сообщение активируется запросом из более высокого уровня. Клиент для запросов сообщений CISP для удаленного управления каталогами не обеспечивает выполнение последовательности сообщений, но (за исключением сообщения Кпмсеткатстатеин) сервер будет отвечать только после успешного выполнения, если клиент ранее подключился с помощью сообщения Кпмконнектин.

### <a name="32411-sending-a-cpmcistateinout-request"></a>3.2.4.1.1 Отправка запроса КпмЦистатеинаут

Как правило, более высокий уровень требует, чтобы клиент протокола отправлял сообщение КпмЦистатеинаут, когда ему требуются сведения о службах индексирования на сервере.

При запросе на отправку этого сообщения клиент должен выполнить следующие действия:

-   Отправка сообщения КпмЦистатеинаут, как указано в разделе 2.2.3.1 на сервер.
-   Ожидание получения от сервера сообщения КпмЦистатеинаут без автоматической отмены всех остальных сообщений.
-   Сообщает значение \_ поля Status в ответе и, если оно прошло успешно, информационная структура возвращается к более высокому слою.

### <a name="32412-sending-a-cpmsetcatstatein-request"></a>3.2.4.1.2 Отправка запроса Кпмсеткатстатеин

Как правило, более высокий уровень требует, чтобы клиент протокола отправлял сообщение Кпмсеткатстатеин, когда ему требуются сведения о каталоге или каталоге. Для этого сообщения более высокий уровень должен предоставить клиенту протокола значение для \_ двневстате и, при необходимости, имя каталога.

При запросе на отправку этого сообщения клиент должен выполнить следующие действия:

-   Отправка сообщения Кпмсеткатстатеин, указанного в 2.2.3.2, на сервер.
-   Ожидание получения от сервера сообщения Кпмсеткатстатеаут без автоматической отмены всех остальных сообщений.
-   Сообщает значение \_ поля Status в ответе и, если оно прошло успешно, \_ дволдстате обратно на более высокий уровень.

### <a name="32413-sending-a-cpmupdatedocumentsin-request"></a>3.2.4.1.3 отправка запроса Кпмупдатедокументсин

Более высокий уровень обычно запрашивает отправку этого сообщения, когда необходимо либо обновить документы в существующем пути, либо добавить новый путь к этому индексу. Таким образом, более высокий уровень заключается в предоставлении пути и типа сканирования, указанного в разделе 2.2.3.4, где для существующих путей предназначено добавочное или полное обновление, а новая инициализация предназначена для новых путей.

Чтобы обслуживать запрос более высокого уровня, клиент должен выполнить следующие действия:

-   Отправка сообщения Кпмупдатедокументсин, как указано в разделе 2.2.3.4 на сервер.
-   Ожидание получения сообщения Кпмупдатедокументсин с сервера без автоматической отмены всех остальных сообщений.
-   Сообщает значение \_ поля Status в ответе назад к более высокому слою.

### <a name="32414-sending-a-cpmforcemergein-request"></a>3.2.4.1.4 Отправка запроса Кпмфорцемержеин

Как правило, более высокий уровень запрашивает отправку этого сообщения при необходимости улучшить производительность запросов или является частью запланированного обслуживания службы индексирования.

Чтобы обслуживать более высокий уровень, клиент должен выполнить следующие действия:

-   Отправка сообщения Кпмфорцемержеин, указанного в разделе 2.2.3.5, на сервер.
-   Ожидание получения сообщения Кпмупдатедокументсин с сервера без автоматической отмены всех остальных сообщений.
-   Сообщает значение \_ поля Status в ответе назад к более высокому слою.

### <a name="3242-remote-indexing-service-catalog-query-messages"></a>Сообщения о запросе каталога службы удаленного индексирования 3.2.4.2

За исключением Кпмжетровсин/Кпмжетровсаут, Кпмфетчвалуеин/Кпмфетчвалуеаут существует связь "один к одному" между CISP сообщениями и запросами более высокого уровня. Для двух упомянутых выше исключений может существовать несколько сообщений, создаваемых клиентом для удовлетворения требований к размеру или получения полного свойства. Более высокий уровень обычно отслеживает все сведения, относящиеся к запросам (например, открытые дескрипторы курсоров, допустимые значения для дескрипторов закладок и разделов, значения WID для отложенных значений свойств и т. д.), а также отслеживает, если клиент находится в подключенном состоянии, но он не применяется каким-либо образом клиентом.

В наглядной части схемы в разделе 3 показана эта последовательность для простого запроса службы индексирования.

### <a name="32421-sending-a-cpmconnectin-request"></a>3.2.4.2.1 Отправка запроса Кпмконнектин

Это сообщение обычно является первым запросом от более высокого уровня (как если бы клиент не был подключен, сервер будет завершать свою часть сообщений с исключением Кпмсеткатстатеин). Более высокий уровень предоставляет клиенту протокола сведения, необходимые для подключения.

Чтобы обслуживать более высокий уровень, клиент должен выполнить следующие действия:

-   Заполните сообщение, используя сведения, предоставленные клиентом более высокого уровня (см. раздел 2.2.3.6) в \_ иклиентверсион, MachineName, username, PropertySet1, PropertySet2 и апропертисет.
-   Задайте \_ фклиентисремоте, \_ кбблоб, \_ cbBlob2, кпропсет и цекстпропсет, как указано в 2.2.3.6.
-   Задайте контрольную сумму в \_ поле улчекксум.
-   Отправка сообщения Кпмконнектин на сервер.
-   Ожидание получения сообщения Кпмконнектаут с сервера без автоматической отмены всех остальных сообщений.
-   Сообщает значение \_ поля Status в ответе и, если оно прошло успешно, \_ serverVersion обратно на более высокий уровень.

В информативных целях ожидается, что при успешном подключении более высокие уровни обычно выполняют следующие действия, но не применяются клиентом CISP.

-   Использование сообщений об управлении каталогом службы удаленного индексирования для административных задач
-   Используйте запрос Кпмкреатекуерин, чтобы создать поисковый запрос с целью получения результатов из каталога.

### <a name="32422-sending-a-cpmcreatequeryin-request"></a>3.2.4.2.2 Отправка запроса Кпмкреатекуерин

Более высокий уровень, как правило, предоставляет сведения о создании запроса после подключения клиента протокола. Более высокий уровень предоставляет клиенту набор ограничений, набор столбцов, правила порядка сортировки и набор классификации (каждый из них можно опустить), свойства набора строк и структуру сопоставления ИДЕНТИФИКАТОРов свойств.

При получении этого запроса от более высокого уровня клиент должен выполнить следующие действия:

-   Подготовьте Кпмкреатекуерйоут, как показано ниже.
-   -   Если задан набор столбцов, установите для Кколумнссетпресет значение 0x01 и заполните поле Columning.
    -   Если имеются ограничения, задайте для Крестриктионпресент значение 0x01 и заполните поле ограничения.
    -   Если указан набор сортировки, заполните поле Sorting.
    -   Если задан набор классификаций, задайте для Ксортсетпресент значение 0x01 и заполните поле Категоризатионсет.
    -   Установите остальные поля, как указано в 2.2.3.8.

-   Вычислите \_ поле улчекксум в заголовке.
-   Отправка сообщения Кпмкреатекуерин на сервер.
-   Дождитесь получения сообщения Кпмкреатекуерйоут (см. сведения в разделе 3.2.5.1.1) без автоматического удаления всех остальных сообщений.
-   Сообщает значение \_ поля Status в ответе и, если оно прошло успешно, массив дескрипторов курсоров и информативные логические значения (как указано в 2.2.3.9) возвращаются к более высокому слою.

### <a name="32423-sending-a-cpmsetbindingsin-request"></a>3.2.4.2.3 отправка запроса Кпмсетбиндингсин

Как правило, более высокий уровень задает привязки для каждого столбца, возвращаемого в строках, если он уже имеет допустимый маркер курсора (после успешного получения Кпмкреатекуерйоут см. раздел 3.2.5.1.1). Выше ожидается, что необходимо предоставить массив структур Ктаблеколумн, как указано в разделе 2.2.4.31, для поля Аколумнс и допустимого маркера курсора.

При получении этого запроса от более высокого уровня клиент должен выполнить следующие действия:

-   Вычислите количество структур Ктаблеколумн в массиве Аколумнс и задайте для поля Кколумнс это значение.
-   Вычислите общий размер в байтах для полей Кколумнс и Аколумнс и задайте \_ для поля кббиндингдеск это значение.
-   Задавайте указанные поля в сообщении Кпмсетбиндингсин значениям, предоставленным более высоким уровнем приложения. Задайте в \_ поле улчекксум значение, вычисленное, как указано в разделе 3.2.5.
-   Отправка завершенного сообщения Кпмсетбиндигнсин на сервер.
-   Ожидание получения сообщения Кпмсетбиндингсин от сервера, удаление других сообщений.
-   Укажите состояние из \_ поля состояние ответа на более высокий уровень.

Для информативных целей ожидается, что более высокие уровни обычно запрашивают у клиента сообщение Кпмжетровсин, но это не обеспечивается протоколом службы индексирования содержимого.

### <a name="32424-sending-a-cpmgetrowsin-request"></a>3.2.4.2.4 Отправка запроса Кпмжетровсин

Когда более высокий уровень собирается получить сведения о строках, он предоставит клиенту протокола допустимый маркер курсора и раздела и предложит соответствующее описание поиска. Как правило, ожидается более высокий уровень, если у него есть допустимый обработчик курсора или раздела, а привязки были заданы с помощью сообщения Кпмсетбиндингсин. Чтобы получить доступ к набору строк в главе, более высокий уровень заключается в использовании маркера раздела, полученного от сервера, в предыдущем Кпмжетровсаут сообщении.

При получении этого запроса от более высокого уровня клиент должен выполнить следующие действия:

-   Определите, какое целочисленное значение без знака следует указать для \_ поля кбреадбуффер. Чтобы определить это значение, клиент должен получить максимальное значение из следующего:
-   -   1000. время в значении \_ поля c ровстотрансфер.
    -   Значение \_ кброввидс, округленное до ближайшего 512 байта с множителем.
    -   Передавайте большее из этих двух значений, до ограничения 16 КБ.
    -   В случаях, когда размер одной строки превышает 16 КБ, сервер не может вернуть результаты в этот запрос.

Укажите клиентскую базу для данных строк переменного размера в адресном пространстве клиента в \_ поле улклиентбасе.

*Windows Поведение. для 32-разрядного клиента, говорящего на 32-разрядном сервере, или клиента 64 bit, говорящего на 64-bit Server, этому параметру присваивается адрес в памяти принимающего буфера в процессе приложения. Это позволяет указателям, полученным в поле строк Кпмжетровсаут, быть правильными указателями памяти в процессе клиентского приложения. В противном случае — значение 0x00000000.*

-   Вычислите размер описания поиска и задайте его в \_ поле кбсик.
-   Установите значение Кбресервед (которое будет действовать как смещение для начала строк) на значение \_ кбсик плюс 0x14.
-   Отправка сообщения Кпмконнектин, указанного в 2.2.3.15, на сервер.

### <a name="32425-sending-a-cpmfetchvaluein-request"></a>3.2.4.2.5 Отправка запроса Кпмфетчвалуеин

Если клиент получает от сервера ответ Кпмжетровсаут с полем состояния столбца, установленным в значение Статусдеферред (0x01), это означает, что значение свойства не было указано в поле Rows сообщения Кпмжетровсаут. В этом случае более высокий уровень обычно запрашивает у клиента протокола получение значения с помощью сообщения Кпмфетчвалуеин, а также предоставляет значение Пропспек и \_ WID для отложенного свойства, которое клиент протокола должен использовать в первом сообщении кпмфетчвалуеин.

Если это первое сообщение Кпмфетчвалуеин, отправленное клиентом для запроса указанного свойства, клиент должен выполнить следующие действия:

-   Установите все поля в сообщении, как указано в разделе 2.2.3.19.
-   Задайте \_ для кбсофар значение 0x00000000.
-   Установка текущих байтов, полученных в значение 0.
-   Отправка сообщения Кпмфетчвалуеин на сервер.

### <a name="32426-sending-a-cpmfreecursorin-request"></a>3.2.4.2.6 Отправка запроса Кпмфрикурсорин

Когда более высокий уровень больше не использует поисковый запрос, он может освободить ресурсы на сервере, запросив клиента отправить сообщение Кпмфрикурсорин.

При получении этого запроса клиент должен отправить сообщение Кпмфрикурсорин, как указано в 2.2.3.28, на сервер, содержащий маркер, заданный верхним слоем.

### <a name="32427-sending-a-cpmdisconnect-message"></a>3.2.4.2.7 Отправка сообщения Кпмдисконнект

Если более высокий уровень не содержит запросов для службы индексирования, чтобы освободить больше ресурсов сервера, приложение может запросить отправку клиентом сообщения Кпмдисконнект на сервер. При получении этого запроса клиент должен просто отправить сообщение по запросу. Нет ответа на это сообщение от сервера.

### <a name="325-message-processing-and-sequencing-rules"></a>Правила обработки сообщений 3.2.5 и последовательности

Когда клиент получает ответ на сообщение от сервера, клиент должен использовать Последнее отправленное сообщение, чтобы определить, является ли сообщение, полученное от сервера, ожидаемым клиентом. Все сообщения с \_ полем MSG, отличным от одного сообщения в последней отправке, должны игнорироваться.

### <a name="3251-receiving-a-cpmcreatequeryout-response"></a>3.2.5.1 получение ответа Кпмкреатекуерйоут

Когда клиент получает от сервера ответ на сообщение Кпмкреатекуерйоут, клиент должен возвратить \_ состояние и (если состояние прошло успешно) значения маркера курсора возвращаются к более высокому слою. Дальнейшие действия выполняются на более высоком уровне.

Так как более высокий уровень имеет значение для структуры запроса, он всегда будет рассчитывать правильное число дескрипторов курсора, возвращаемых в сообщении Кпмкреатеауерйоут. Дескрипторы курсора возвращаются в следующем порядке: первый дескриптор относится к набору строк, к которому применяется unchapter, второй — к первому разбитому на разделы набору строк (т. е. Группирование результатов на основе первой категории, указанной в поле Категоризатионсет сообщения Кпмкреатекуерин).

Для информативных целей ожидается, что более высокие уровни могут выполнять следующие действия, но они не применяются клиентом CISP.

-   Использование Кпмсетбиндингсин для установки привязок для отдельных столбцов и выполнения последующих действий по пути запроса
-   Используйте Кпмжеткуеристатусин для проверки хода выполнения запроса.
-   Используйте Кпмратиофинишедин, чтобы запросить процент завершения запроса.

### <a name="3252-receiving-a-cpmgetrowsout-response"></a>3.2.5.2 получение ответа Кпмжетровсаут

Когда клиент получает от сервера ответ на сообщение Кпмжетровсаут, клиент должен выполнить следующие действия:

-   Убедитесь, что \_ поле состояния в заголовке указывает на успешное выполнение или сбой.
-   Если \_ значение состояния "БУФЕР состояния \_ \_ слишком мало" \_ (0XC0000023), клиент должен проверить состояние последнего отправленного сообщения. Если он не содержит сообщение Кпмжетровсин, то полученное сообщение должно игнорироваться без уведомления. В противном случае клиент должен отправить на сервер новое сообщение Кпмжетровсин со всеми полями, идентичными сохраненному, за исключением того, что \_ КБРЕАДБУФФЕР должен быть увеличен на 512 (но не больше, чем 0x4000). Если \_ состояние \_ "буфер состояния \_ слишком \_ мал" (0XC0000023), а Последнее отправленное сообщение уже имеет \_ кбреадбуффер, равное 0x4000 Client, должен сообщить об ошибке до более высокого уровня.
-   Если \_ значением состояния является любое другое значение ошибки, клиент должен указать на сбой до более высокого уровня.
-   Если \_ значение состояния указывает на успешное выполнение, результаты должны указывать на более высокий уровень, запрашивающий информацию, а дальнейшие действия — на более высоком уровне.

В информативных целях предполагается, что более высокие уровни обычно выполняют следующие действия, но не применяются клиентом протокола службы индексирования содержимого:

-   Если значения в строках представляют идентификаторы документов, главы или закладки обрабатывают более высокий уровень, обычно они сохраняются для использования в последующих операциях, в которых задействованы допустимые идентификаторы документов, разделы или маркеры закладок.
-   Более высокий уровень обычно сохраняет или отображает данные из значений строк или иным образом использует их.
-   Для значений, которые были помечены как отложенные выше, будут получены значения с помощью сообщений Кпмфетчвалуеин.
-   Описание поиска возвращается к более высокому слою и может быть повторно использовано или проверено более высоким уровнем.

В информативных целях, если более высокий уровень запросил обработку глав и закладок, полученных в строках, это может сделать следующее:

-   Используйте Кпмжеткуеристатусексин, чтобы проверить ход выполнения запроса, а также дополнительные сведения о состоянии, например число отфильтрованных документов, документов, которые нужно отфильтровать, отношение документов, обрабатываемых запросом, общее число строк в запросе и расположение закладки в наборе строк.
-   Используйте Кпмжетнотифи, чтобы запросить у сервера уведомление клиента об изменениях набора строк.
-   Используйте Кпмжетаппроксиматепоситионин для запроса приблизительного расположения закладки в главе.
-   Используйте Кпмкомпаребмкин для запроса сравнения двух закладок в главе.
-   Используйте Кпмрестартпоситионин, чтобы изменить положение курсора на начало набора строк на сервере.

### <a name="3253-receiving-a-cpmfetchvalueout-response"></a>3.2.5.3 получение ответа Кпмфетчвалуеаут

Когда клиент получает от сервера ответ на сообщение Кпмжетровсаут, клиент должен выполнить следующие действия:

-   Убедитесь, что \_ поле состояния в заголовке указывает на успешное выполнение или сбой. В случае сбоя уведомить более высокий уровень. В противном случае продолжайте ниже.
-   Проверьте \_ фвалуиксист и, если задано значение 0x00000000 уведомить более высокого уровня о том, что значение не найдено.
-   В противном случае добавьте \_ кбвалуе байт из управляемое vValue в текущее значение свойства.
-   Если \_ \_ фмориксистс имеет значение 0x00000001, то Увеличьте \_ текущие байты, полученные \_ кбвалуе, и отправьте сообщение кпмфетчвалуеин на сервер, установив \_ для Кбсофар значение Current bytes Received, \_ кбпропспек to Zero и \_ кбчунк до размера буфера, который требуется более высокого уровня.
-   Если \_ фмориксистс имеет значение 0x00000000, укажите значение свойства из текущего значения свойства в более высокий уровень.

### <a name="3254-receiving-a-cpmfreecursorout-response"></a>3.2.5.4 получение ответа Кпмфрикурсораут

Когда клиент получает успешный ответ на сообщение Кпмфрикурсораут от сервера, клиент должен вернуть \_ значение ккурсорсремаининг к более высокому слою.

Следующие сведения предоставляются только в информативных целях и не применяются клиентом CISP. Предполагается, что более высокий уровень отслеживает дескрипторы курсора и не использует уже освобожденные объекты. Когда число \_ ккурсорсремаининг равно 0x00000000, более высокий уровень может использовать соединение для указания другого запроса (с помощью сообщения кпмкреатекуерин).

### <a name="326-timer-events"></a>События таймера 3.2.6

Нет.

### <a name="327-other-local-events"></a>3.2.7 другие локальные события

Нет.

## <a name="4-protocol-examples"></a>4. Примеры протокола

-   [4,1 Пример 1](#41-example-1)
-   [4,2. Пример 2](#42-example-2)

### <a name="41-example-1"></a>4,1 Пример 1

В следующем примере мы рассмотрим ситуацию, в которой пользователь Джон на компьютере а хочет получить размеры файлов, содержащих слово «Microsoft», из набора документов, хранящихся на сервере X в системе каталогов. предположим, что компьютер A работает под управлением 32-разрядной операционной системы Windows XP, а компьютер X работает под управлением 32-разрядной операционной системы Windows Server 2003.

1.  Пользователь запускает приложение поиска и вводит поисковый запрос. Приложение, в свою очередь, передает поисковый запрос клиенту протокола.
2.  Клиент протокола устанавливает соединение с сервером индексирования X. Клиент протокола использует элемент \\ конфигурации канала именованного \\ канала \_ скадс для подключения к серверу X через SMB.
3.  Затем клиент протокола подготавливает сообщение Кпмконнектин со следующими значениями:

    Заголовок сообщения заполняется следующим образом:

    -   **\_ сообщение имеет значение** 0x000000C8, указывающее, что это сообщение кпмконнектин.
    -   для параметра **\_ Status** задано значение 0x00000000.
    -   **\_ улчекксум** содержит контрольную сумму, вычисленную, как указано в разделе 3.2.4.
    -   для **\_ ulReserved2** задано значение 0x00000000.

    Текст сообщения заполняется следующим образом:

    -   **\_ иклиентверсион** имеет значение 0x00000008, указывающее, что сервер должен проверять поле контрольной суммы.
    -   **\_ фклиентисремоте** имеет значение 0x00000001, указывающее, что сервер является удаленным сервером.
    -   **\_ cbBlob1** задает размер в байтах Объединенных полей кпропсет, PropertySet1 и PropertySet2.
    -   для **\_ cbBlob2** задано значение 0x00000004 (это означает отсутствие дополнительных наборов свойств).
    -   **MachineName** имеет значение.
    -   Параметр **username** имеет значение John.
    -   для **кпропсетс** задано значение 0x00000002.
    -   Поле **PropertySet1** имеет тип кдбпропсет. Структура Кдбпропсет, состоящая из поля PropertySet1, заполняется следующим образом:
        -   Для поля **гуидпропсет** установлено значение A9BD1526-6A80-11D0-8C9D-0020AF1D740E (DBPROPSET \_ фсЦифрмврк \_ EXT).
        -   для поля **кпропертиес** установлено значение 0x00000004.
        -   поле **апропс** представляет собой массив структур кдбпроп.

            Для элемента **апропс \[ 0 \]** :

            -   **PropId** имеет значение 0x00000002 ( \_ \_ имя каталога CI DBPROP \_ ).
            -   Для **дбпропоптионс** задано значение 0x0000000.
            -   Для **дбпропстатус** задано значение 0x00000000.
            -   Для элемента **идентификатора столбца** :
                -   **элемент ekind** имеет значение 0X00000001 (дбкинд \_ GUID \_ PropID)
                -   **GUID** имеет значение null (все нули), то есть значение применяется к запросу, а не только к одному столбцу.
                -   для **улид** задано значение 0x00000000.
            -   Для элемента **управляемое vValue** :
                -   для **втипе** задано значение 0X001F (VT \_ LPWSTR).
                -   для **управляемое vValue** задано значение System, имя нужного каталога.

            Для элемента **апропс \[ 1 \]** :

            -   **PropId** имеет значение 0x00000007 ( \_ \_ тип запроса DBPROP CI \_ )
            -   Для **дбпропоптионс** задано значение 0x0000000.
            -   **Дбпропстатус** имеет значение to0x00000000.
            -   Для элемента **идентификатора столбца** :
                -   **элемент ekind** имеет значение 0X00000001 (дбкинд \_ GUID \_ PropID).
                -   **GUID** имеет значение null (все нули), то есть значение применяется к запросу, а не только к одному столбцу.
                -   для **улид** задано значение 0x00000000.
            -   Для элемента **управляемое vValue** :
                -   для **втипе** задано значение 0X0003 (VT \_ i4).
                -   **управляемое vValue** имеет значение 0X00000000 (Цинормал), то есть это обычный запрос.

            Для элемента **апропс \[ 2 \]** :

            -   **PropId** имеет значение 0x00000004 ( \_ \_ Флаги области CI DBPROP \_ ).
            -   Для **дбпропоптионс** задано значение 0x0000000.
            -   Для **дбпропстатус** задано значение 0x00000000.
            -   Для элемента **идентификатора столбца** :
                -   **элемент ekind** имеет значение 0X00000001 (дбкинд \_ GUID \_ PropID).
                -   **GUID** имеет значение null (все нули), то есть значение применяется к запросу, а не только к одному столбцу.
                -   для **улид** задано значение 0x00000000.
            -   Для элемента **управляемое vValue** :
                -   **втипе**: 0x1003 ( \_ вектор \| VT, \_ i4)
                -   **управляемое vValue**: 0x00000001/0x00000001 (один элемент со значением 1), то есть Поиск вложенных папок

            Для элемента **апропс \[ 3 \]** :

            -   **PropId**: 0X00000003 (DBPROP \_ CI \_ включает \_ области)
            -   **Дбпропоптионс**: 0x0000000
            -   **Дбпропстатус**: 0x00000000
            -   Для элемента **идентификатора столбца** :
                -   **элемент ekind** имеет значение 0X00000001 (дбкинд \_ GUID \_ PropID).
                -   **GUID** имеет значение null (все нули), то есть значение применяется к запросу, а не только к одному столбцу.
                -   для **улид** задано значение 0x00000000
            -   Для элемента **управляемое vValue** :
                -   для **втипе** задано значение 0x101F (VT \_ vector \| VT \_ ).
                -   **управляемое vValue** имеет значение 0x00000001/0x00000002/" \\ " (один элемент с строкой, завершающейся нулевым символом NULL), то есть в корневой области.

    -   Поле **PropertySet2** имеет тип кдбпропсет.

        Структура Кдбпропсет, состоящая из поля PropertySet1, заполняется следующим образом:

        -   Для **гуидпропсет** задано значение AFAFACA5-B5D1-11D0-8C62-00C04FC2DB8D (DBPROPSET \_ Цифрмврккоре \_ EXT).
        -   поле **кпропертиес** имеет значение 0x00000001.
        -   Поле **апропс** представляет собой массив структур кдбпроп.

            Для элемента **апропс \[ 0 \]** :

            -   **PropId** имеет значение 0X00000002 (DBPROP \_ Machine).
            -   Для **дбпропоптионс** задано значение 0x0000000.
            -   Для **дбпропстатус** задано значение 0x00000000.
            -   Для элемента **идентификатора столбца** :
                -   **элемент ekind** имеет значение 0X00000001 (дбкинд \_ GUID \_ PropID),
                -   **GUID** имеет значение null (все нули), то есть значение применяется к запросу, а не только к одному столбцу.
                -   для **улид** задано значение 0x00000000.
            -   Для элемента **управляемое vValue** :
                -   **втипе**: 0X0008 (VT \_ BSTR)
                -   **управляемое vValue**: 0x04/"x" (4 байта/строка в Юникоде, заканчивающаяся нулем), означающее "X" — имя сервера.

    -   для поля **цекстпропсет** установлено значение 0x00000000.
    -   Массив **апропертисетс** не существует.
    -   При необходимости заполняются различные поля заполнения. Сообщение отправляется на сервер.

4.  Сервер проверяет правильность **\_ улчекксум** , проверяет, имеет ли пользователь разрешение на выполнение этого запроса, и реагирует на сообщение кпмконнектаут.

    Заголовок сообщения заполняется следующим образом:

    -   **\_ сообщение имеет значение** 0x000000C8, указывающее, что это сообщение кпмконнектаут.
    -   для параметра **\_ Status** задано значение 0x0000000, означающее успешное выполнение.
    -   **\_ улчекксум** имеет значение 0.
    -   для **\_ ulReserved2** задано значение 0x00000000.

    Текст сообщения заполняется следующим образом:

    -   для поля **\_ serverVersion** установлено значение 0x00000007 (32-bit Windows XP или 32-bit Windows Server 2003).
    -   **\_ зарезервированные** поля заполняются произвольными данными.

5.  Клиент готовит сообщение Кпмкреатекуерин.

    Заголовок сообщения заполняется следующим образом:

    -   **\_ сообщение имеет значение** 0x000000CA, указывающее, что это сообщение кпмкреатекуерин.
    -   для параметра **\_ Status** задано значение 0x00000000.
    -   **\_ улчекксум** содержит контрольную сумму, вычисленную в соответствии с 3.2.5.
    -   для **\_ ulReserved2** задано значение 0x00000000.

    Текст сообщения заполняется следующим образом:

    -   Поле **size (размер** ) задает размер остальной части сообщения.
    -   Для поля **кколумнсетпресент** задано значение 0x01.
    -   Поле набора **столбцов** имеет тип кколумнсет. Структура Кколумнсет, включающая в себя это поле, задается следующим образом:
        -   поле **\_ Count** имеет значение 0x00000001, указывающее, что возвращается один столбец.
        -   Массив **индексов** — это 0x00000000, указывающий первую запись в \_ апропспек.
    -   Поле **крестриктионпресент** имеет значение 0x01, указывающее на наличие поля **ограничения** .
    -   Поле **ограничения** имеет тип крестриктион и имеет значение:
        -   для **\_ ултипе** задано значение 0x00000004 (ртконтент).
        -   для параметра **\_ Weight** задано значение 0x00000000.
    -   Оставшаяся часть поля содержит структуру Кконтентрестриктион:
        -   **\_ Задано значение GUID** B725F130-47EF-101A-A5F1-02608c9eebac/0X00000001 (для прспек \_ PropID)/0x13, представляющее тело документа.
        -   Для **\_ CC** задано значение 0x00000009.
        -   для **\_ пвксфрасе** задана строка «Microsoft».
        -   для **\_ LCID** задано значение 0X409 (для английского языка).
        -   для **\_ улженератемесод** задано значение 0x00000000 (точное совпадение).
    -   **Ксортпресент** имеет значение 0x00.
    -   **Ккатегоризатионсетпресент** имеет значение 0x00.
    -   **Ровсетпропертиес** задается следующим образом:
        -   **\_ убулеаноптионс** имеет значение 0x00000001 (последовательный).
        -   для **\_ улмаксопенровс** задано значение 0x00000000.
        -   для **\_ улмеморюсаже** задано значение 0x00000000.
        -   \_для **кмаксресултс** задано значение 0x00000100 (возвращается не более 256 строк).
        -   для **\_ ккмдтимеаут** задано значение 0x00000000 (никогда не время ожидания).
    -   **Пидмаппер** имеет значение:
        -   для параметра **\_ Count** задано значение 0x00000001.
        -   для **\_ апропспек** задано значение GUID B725F130-47EF-101A-A5-F1-02608C9EEBAC/0x00000001 (для прспек \_ PROPID)/0x0000000c, представляющее свойство размера файла Windows.

6.  Сервер обрабатывает его и реагирует на сообщение Кпмкреатекуерйоут.

    Заголовок сообщения заполняется следующим образом:

    -   **\_ сообщение имеет значение** 0x000000CA, указывающее, что это сообщение кпмкреатекуерйоут.
    -   **\_ состояние** установлено в значение Success.
    -   **\_ улчекксум** имеет значение 0x00000000 (или любое другое произвольное значение).
    -   **\_ ulReserved2** имеет значение 0x00000000 (или любое другое произвольное значение).

    Текст сообщения заполняется следующим образом:

    -   **\_ фтруесекеунтиал** имеет значение 0x00000000, указывающее, что запрос может использовать индекс.
    -   **\_ фворкидуникуе** имеет значение 0x00000001.
    -   Массив **акурсорс** содержит только один элемент, представляющий маркер курсора для этого запроса. Значение зависит от состояния сервера. Предположим, что возвращаемое значение — 0xAAAAAAAA.

7.  Клиент выдает сообщение запроса Кпмсетбиндингсин для определения формата строки.

    Заголовок сообщения заполняется следующим образом:

    -   **\_ сообщение имеет значение** 0x000000D0, указывающее, что это сообщение кпмсетбиндингсин.
    -   **\_ состояние** установлено в значение Success.
    -   **\_ улчекксум** имеет значение 0x00000000 (или любое другое произвольное значение).
    -   **\_ ulReserved2** имеет значение 0x00000000 (или любое другое произвольное значение).

    Текст сообщения заполняется следующим образом:

    -   для **\_ хкурсор** задано значение 0xAAAAAAAA.
    -   для **\_ кбров** задано значение 0x10 (достаточно большое, чтобы вместить столбцы).
    -   **\_ кббиндингдеск** задается в сочетании с размером полей **\_ кколумнс** и **\_ аколумнс** .
    -   **\_ кколумнс** имеет значение 0x00000001.
    -   Массив **\_ аколумнс** имеет значение, содержащее одну структуру ктаблеколумн, содержащую:
    -   -   для **\_ пропспек** задано значение GUID b725f130-47ef-101a-a5-f1-02608c9eebac/0x00000001 (для прспек \_ PROPID)/0x0000000c, представляющее свойство размера файла Windows.
        -   для **\_ втипе** задано значение 0x0015 (VT \_ UI8).
        -   Для **\_ валуеусед** задано значение 0x01 (столбец передается в строке).
        -   Для **\_ валуеоффсет** задано значение 0x0002 (в начале строки).
        -   Для **\_ валуесизе** задано значение 0X08 (размер VT \_ UI8).
        -   Для **\_ статусусед** задано значение 0x01.
        -   Для **\_ статусоффсет** задано значение 0x0A.
        -   **\_ Ленгсусед** имеет значение 0x00.

8.  Сервер обрабатывает его и реагирует на сообщение Кпмсетбиндингсин.

    Заголовок сообщения заполняется следующим образом:

    -   для **\_ сообщения** задано значение 0x000000D0.
    -   **\_ состояние** установлено в значение Success.
    -   **\_ улчекксум** имеет значение 0x00000000 (или любое другое произвольное значение).
    -   **\_ ulReserved2** имеет значение 0x00000000 (или любое другое произвольное значение).

9.  Клиент выдает сообщение запроса Кпмжетровсин. Предположим, что клиент готов принять 100 строк на этом этапе и хочет, чтобы они были в возрастающем порядке.

    Заголовок сообщения заполняется следующим образом:

    -   **\_ сообщение имеет значение** 0x000000CC, указывающее, что это сообщение кпмжетровсин.
    -   для параметра **\_ Status** задано значение 0x00000000.
    -   **\_ улчекксум** содержит контрольную сумму, вычисленную в соответствии с разделом 0.
    -   для **\_ ulReserved2** задано значение 0x00000000.

    Текст сообщения заполняется следующим образом:

    -   для **\_ хкурсор** задано значение 0xAAAAAAAA.
    -   для **\_ кровстотрансфер** задано значение 0x00000064.
    -   **\_ кроввидс** имеет значение 0x00000010 (из привязок).
    -   для **\_ кбсик** задано значение 0x14, которое равно размеру полей eType, \_ CHAP и кровсикнекст.
    -   для **\_ кбресервед** задано значение 0x18 (0x14 Plus \_ кбсик).
    -   для **\_ кбреадбуффер** задано значение 0x800 (0x64 \* 0x10 округляется до следующего кратного 0x200).
    -   для **\_ улклиентбасе** задано значение 0x00000000.
    -   **\_ фбвдфетч** имеет значение 0x00000000, указывающее, что строки должны быть получены в прямом порядке.
    -   **eType** имеет значение 0x0000001, указывающее, что клиент хочет получить следующие строки.
    -   для параметра **\_ CHAP** задано значение 0 (не в разделе результат).
    -   Для **сикдескриптион** задано значение кровсикнекст. Структура Кровсикнекст содержит следующие значения:
        -   Для **Цитблчапт** задано значение 0x00000000.
        -   для **\_ хрегион** задано значение 0x00000000.
        -   **\_ кскип** имеет значение 0, указывающее, что клиенту не нужно пропускать строки.

10. Сервер обрабатывает его и реагирует на сообщение Кпмжетровсаут. Предположим, что сервер нашел 100 документов, содержащих слово Microsoft.

    Заголовок сообщения заполняется следующим образом:

    -   **\_ сообщение имеет значение** 0x000000CC, указывающее, что это сообщение кпмжетровсаут.
    -   **\_ состояние** установлено в значение Success.
    -   для **\_ улчекксум** задано значение 0x00000000.
    -   для **\_ ulReserved2** задано значение 0x00000000.

    Текст сообщения заполняется следующим образом:

    -   Для **\_ кровсретурнед** задано значение 0x00000064.
    -   **eType** имеет значение 0x00000001.
    -   для параметра **\_ CHAP** задано значение 0x00000000 (не в разделе результат).
    -   **Сикдескриптион** содержит структуру кровсикнекст, заполненную следующим образом:
        -   Для **Цитблчапт** задано значение 0x00000000.
        -   для **\_ хрегион** задано значение 0x00000000.
        -   **\_ кскип** имеет значение 0, указывающее, что клиенту не нужно пропускать строки.
    -   **Строки** содержат размер 100 документов, содержащих слово «Microsoft». Так как это данные фиксированного размера, они просто структурированы как список из 100, 8-байтных целых чисел без знака.

11. Клиент отправляет сообщение Кпмдисконнект, чтобы завершить соединение.

    Заголовок сообщения заполняется следующим образом:

    -   **\_ сообщение имеет значение** 0x000000C9, указывающее, что это сообщение кпмдисконнект.
    -   для параметра **\_ Status** задано значение 0x00000000.
    -   для **\_ улчекксум** задано значение 0x00000000.

12. Сервер обрабатывает сообщение и удаляет все состояние клиента.

### <a name="42-example-2"></a>4,2. Пример 2

В предыдущем примере запрос был достаточно простым. Давайте теперь рассмотрим немного более сложный запрос. Предположим, что пользователь хочет получить размер документов, содержащих оба слова: "Microsoft" и "Office". Это указывается путем изменения поля ограничения, содержащегося в сообщении Кпмкреатекуерин, отправленном на шаге 5, следующим образом.

Поле **ограничения** имеет тип крестриктион и имеет значение:

-   -   для **\_ ултипе** задано значение 0x00000004 (ртанд).
    -   для параметра **\_ Weight** задано значение 0x00000000.

Оставшаяся часть поля содержит структуру Кнодерестриктион:

-   -   **\_ кноде** имеет значение 0x00000002, указывающее, что в массиве паноде есть два узла.
    -   Поле **\_ паноде** представляет собой массив из двух структур крестриктион.

        **\_ паноде \[ 0 \]** содержит:

        -   -   для **\_ ултипе** задано значение 0x00000004 (ртконтент).
            -   для параметра **\_ Weight** задано значение 0x00000000.
            -   Оставшаяся часть поля содержит структуру Кконтентрестриктион:
                -   Для **\_ свойства** задано значение GUID b725f130-47ef-101A-a5f1-02608c9eebac/0X00000001 (для прспек \_ PropID)/0x13.
                -   Для **\_ CC** задано значение 0x00000009.
                -   для **\_ пвксфрасе** задана строка «Microsoft».
                -   для **\_ LCID** задано значение 0X409 (для английского языка).
                -   для **\_ улженератемесод** задано значение 0x00000000 (точное совпадение).

        **\_ паноде \[ 1 \]** содержит:

        -   -   для **\_ ултипе** задано значение 0x00000004 (ртконтент).
            -   для параметра **\_ Weight** задано значение 0x00000000.
            -   Оставшаяся часть поля содержит структуру Кконтентрестриктион:
                -   Для **\_ свойства** задано значение GUID b725f130-47ef-101A-a5f1-02608c9eebac/0X00000001 (для прспек \_ PropID)/0x13.
                -   Для **\_ CC** задано значение 0x00000006.
                -   **\_ пвксфрасе** имеет значение String "Office".
                -   для **\_ LCID** задано значение 0X409 (для английского языка).
                -   для **\_ улженератемесод** задано значение 0x00000000 (точное совпадение).

## <a name="5-security"></a>5. Безопасность

### <a name="51-security-considerations-for-implementers"></a>5.1. Вопросы безопасности для разработчиков

Реализации индексирования, для которых требуется индексирование защищенного содержимого, следует использовать контекст пользователя, предоставляемый SMB \[ MS-SMB, \] чтобы обрезать результаты поиска и возвратить только те, которые доступны вызывающему объекту.

### <a name="52-index-of-security-parameters"></a>5.2. Индекс параметров безопасности



| Параметр безопасности  | Section |
|---------------------|---------|
| Уровень олицетворения | 2.1     |



 

## <a name="6-index-of-version-specific-behavior"></a>6 индекс поведения, зависящего от версии



| Поведение конкретной версии                                                                         | Section   | Windows 2000 | Windows XP | Windows Server 2003 |
|---------------------------------------------------------------------------------------------------|-----------|--------------|------------|---------------------|
| этот протокол реализован на Windows 2000, Windows XP, Windows Server 2003 и Windows Vista. | 1.3.2     | X            | X          | X                   |
| Приложения обычно взаимодействуют с оболочкой интерфейса OLE DB                                  | 1.4       | X            | X          | X                   |
| Значения NTSTATUS                                                                                   | 1.8       | X            | X          | X                   |
| Клиент устанавливает \_ поле состояния в каждом заголовке сообщения.                                        | 2.2.2     | X            | X          | X                   |
| значение Кпендингсканс обычно равно нулю                                                               | 2.2.3.1   | X            | X          | X                   |
| значение Иклиентверсион                                                                              | 2.2.3.6   | X            | X          | X                   |
| \_значение Кбчунк                                                                                   | 2.2.3.19  | X            | X          | X                   |
| 32-разрядные и 64-разрядные адреса памяти                                                                | 3.2.4.2.4 | X            | X          | X                   |



 

 

 





