---
description: Настройка профилей и других свойств ASF-файлов
ms.assetid: c43df556-9d8a-4010-9ed6-f84d8ac6d9bc
title: Настройка профилей и других свойств ASF-файлов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 46e26dcbb49cb5ff8309dccafc3f1d8d66397871
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "104422997"
---
# <a name="configuring-profiles-and-other-asf-file-properties"></a>Настройка профилей и других свойств ASF-файлов

Следующие элементы описывают выполнение различных задач, связанных с созданием файлов ASF. Некоторые из интерфейсов, упомянутых в этом разделе, описаны в документации пакета SDK для Windows Media Format.

Создание профиля

Профили ASF подробно обсуждаются в пакете SDK формата Windows Media. по сути, они описывают атрибуты файла формата Windows Media, такие как скорость, число и тип потоков, а также качество сжатия. Фильтр использует профиль для определения типа записываемого файла формата Windows Media, количества входных контактов, которые он должен настроить, и типов носителей, которые они могут принимать.

Чтобы создать настраиваемый профиль, используйте пакет SDK для формата Windows Media, чтобы создать объект диспетчера профилей с помощью функции **вмкреатепрофилеманажер** . Затем создайте профиль и передайте его в [модуль записи WM ASF](wm-asf-writer-filter.md) с помощью метода [**Иконфигасфвритер:: конфигурефилтерусингпрофиле**](/previous-versions/windows/desktop/api/Dshowasf/nf-dshowasf-iconfigasfwriter-configurefilterusingprofile) . Это единственный способ настроить фильтр с помощью профиля, который использует кодеки Windows Media Audio и Video 9. Системные профили для более ранних версий этих кодеков можно добавить с помощью метода [**иконфигасфвритер:: конфигурефилтерусингпрофилегуид**](/previous-versions/windows/desktop/api/Dshowasf/nf-dshowasf-iconfigasfwriter-configurefilterusingprofileguid) .

Вы можете сбросить профиль, пока подключены входные сигналы фильтра, если новый профиль не требует дополнительных входных ПИН-кодов. Например, если изменить профиль из одновходного звукового профиля на два входных аудио-и видеопрофиль, будет повторно подключен только ПИН-код, а для видеопотока не будет создан новый ПИН-код.

Добавление метаданных

Чтобы добавить метаданные в файл, запросите фильтр [модуля записи WM ASF](wm-asf-writer-filter.md) для интерфейса **ивмхеадеринфо** . После того как для фильтра был получен профиль, используйте методы интерфейса **ивмхеадеринфо** для записи метаданных.

Индексирование файла

Модуль записи WM ASF по умолчанию создает временные индексированные файлы. Чтобы создать файл, индексируемый по фрейму, используйте метод [**иконфигасфвритер:: сетиндексмоде**](/previous-versions/windows/desktop/api/Dshowasf/nf-dshowasf-iconfigasfwriter-setindexmode) , чтобы отключить все индексирование, а затем создайте файл. По завершении используйте пакет SDK для формата Windows Media, чтобы создать для файла индекс на основе фрейма.

Кодировка Two-Pass

Двусторонняя кодировка поддерживается только в кодеках Windows Media версии 8 и более поздних. Переведите модуль записи WM ASF в режим предварительной обработки, вызвав [**IConfigAsfWriter2:: сетпарам**](/previous-versions/windows/desktop/api/Dshowasf/nf-dshowasf-iconfigasfwriter2-setparam) и указав \_ конфигасфвритер \_ param \_ в параметре *двпарам* , и **значение true** в параметре *dwParam1* .

Затем запустите граф фильтра. Когда выполняются все этапы предварительной обработки (обычно выполняется только один этап предварительной обработки), приложение получит событие [**\_ \_ завершения предварительной обработки**](ec-preprocess-complete.md) в фильтре. При получении этого события используйте [**имедиасикинг:: сетпоситионс**](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-setpositions) , чтобы сбросить указатель потока обратно на начало и снова запустить граф фильтра. После последнего этапа (обычно второй проход) приложение получит событие [**EC \_ Complete**](ec-complete.md) , чтобы обозначить завершение процесса кодирования. Если этап предварительной обработки был отменен до получения события **\_ предварительной обработки \_** , вызовите [**IConfigAsfWriter2:: ресетмултипассстате**](/previous-versions/windows/desktop/api/Dshowasf/nf-dshowasf-iconfigasfwriter2-resetmultipassstate) , чтобы сбросить фильтр, прежде чем пытаться выполнить другой предварительный запуск.

\_ \_ \_ Если требуется полностью перевести фильтр из режима предварительной обработки в **значение false** , необходимо установить параметр многопрохода конфигасфвритер параметра.

> [!IMPORTANT]
> Ответственность за включение режима предварительной обработки на основе профиля, который будет использоваться для кодирования, несет приложение. Для некоторых профилей требуется двусторонняя кодировка. Если вы попытаетесь закодировать файл с таким профилем и не установили \_ \_ параметр конфигасфвритер param of \_ Pass в **значение true**, будет получено сообщение об ошибке [**EC \_ усераборт**](ec-userabort.md) . Дополнительные сведения см. в документации пакета Windows Media Format SDK.

 

Получение и установка свойств буфера во время выполнения

В некоторых случаях, например, если требуется принудительно вставить ключевые кадры при записи файла, приложению может потребоваться получить или задать сведения о буфере Windows Media во время выполнения. Фильтры модуля записи [WM ASF](wm-asf-reader-filter.md) и [WM ASF](wm-asf-writer-filter.md) поддерживают механизм обратного вызова, который позволяет приложению получать доступ к интерфейсу **INSSBuffer3** в каждом отдельном буфере мультимедиа во время чтения или записи файлов. Приложения могут использовать этот интерфейс для обозначения конкретных выборок в качестве ключевых кадров, установки кодов времени SMPTE, указания параметров чересстрочную развертки или добавления любых типов частных данных в поток.

Используйте интерфейс [**иамвмбуфферпасс**](/previous-versions/windows/desktop/api/Dshowasf/nn-dshowasf-iamwmbufferpass) для регистрации обратных вызовов из ПИН-кода, обрабатывающего поток видео. ПИН-код будет вызывать метод [**иамвмбуфферпасскаллбакк:: notify**](/previous-versions/windows/desktop/api/Dshowasf/nf-dshowasf-iamwmbufferpasscallback-notify) для каждого буфера.

Неквадратные Пиксели

Модуль записи WM ASF подключается к вышестоящему фильтру, например к декодеру DV, который выводит сведения о соотношении пропорций в пикселях. Модуль записи WM ASF записывает эти сведения в виде расширений модулей данных для каждого образца в файле.

Когда читатель WM ASF встречает сведения о соотношении пропорций в заголовке файла или в расширениях модулей данных для образцов, он будет предлагать формат [**VIDEOINFOHEADER2**](/previous-versions/windows/desktop/api/dvdmedia/ns-dvdmedia-videoinfoheader2) в качестве первого варианта для своего выходного контакта. Элементы **двпиктаспектратиокс** и **двпиктаспектратиой** структуры, описывающие пропорции видео, будут правильно скорректированы с учетом пропорций в пикселях.

Поддержание формата с чередованием

При записи чередования видео с телевизора или с цифровой камеры может потребоваться сохранить исходное видео как независимые поля, если предполагается, что закодированный файл воспроизводится на телевизоре или другом с чередованием дисплее. (Мониторы компьютеров — это прогрессивные проверки устройств.) Если вы развернете видео, а затем переустановите его для воспроизведения на телевизоре, будет вызвана часть потери данных. В файле ASF сведения о чересстрочную развертке хранятся в виде модулей обработки данных, которые приложение применяет к каждому примеру с помощью метода [**иамвмбуфферпасскаллбакк**](/previous-versions/windows/desktop/api/Dshowasf/nn-dshowasf-iamwmbufferpasscallback) , описанного выше. Чтобы закодировать файл, сохраняющий исходные параметры развертки, выполните следующие действия.

1.  Реализуйте класс, который поддерживает **иамвмбуфферпасскаллбакк** , и напишите функцию Notify, которая задает флаги чересстрочную развертки для каждого образца. Эта функция будет вызываться модулем записи WM ASF до обработки каждого примера.
    ```C++
    // Set to WM_CT_TOP_FIELD_FIRST if that is your format.
    BYTE flag = WM_CT_INTERLACED | WM_CT_BOTTOM_FIELD_FIRST;
    HRESULT hr = S_OK;

    hr = pNSSBuffer3->SetProperty(
        WM_SampleExtensionGUID_ContentType, 
        (void*) &flag, 
        WM_SampleExtension_ContentType_Size
        );         
    ```

    

2.  Перед передачей профиля в фильтр задайте расширения единиц обработки данных в профиле.
    ```C++
    hr = pWMStreamConfig2->AddDataUnitExtension(
        WM_SampleExtensionGUID_ContentType, 
        WM_SampleExtension_ContentType_Size, 
        NULL, 
        0 
        );
    ```

    

3.  После настройки фильтра с помощью профиля получите интерфейс **IWMWriterAdvanced2** из модуля записи WM ASF и вызовите метод **сетинпутсеттингс** .

    ``

    ``

    ```C++
    // Must do this first.
    hr = pConfigAsfWriter2->ConfigureFilterUsingProfile(pProfile);
      
    CComPtr<IServiceProvider> pProvider;
    CComPtr<IWMWriterAdvanced2> pWMWA2;

    hr = pConfigAsfWriter2->QueryInterface( __uuidof(IServiceProvider),
                                             (void**)&pProvider);
    if (SUCCEEDED(hr))
    {
        hr = pProvider->QueryService(IID_IWMWriterAdvanced2,
            IID_IWMWriterAdvanced2,
            (void**)&pWMWA2);
    }

    BOOL pValue = TRUE;

    // Set the first parameter to your actual input number.
    hr = pWMWA2->SetInputSetting(0, g_wszInterlacedCoding,
        WMT_TYPE_BOOL, (BYTE*) &pValue, sizeof(WMT_TYPE_BOOL));
                
    ```

    

## <a name="related-topics"></a>См. также

<dl> <dt>

[Создание файлов ASF в DirectShow](creating-asf-files-in-directshow.md)
</dt> </dl>

 

 



