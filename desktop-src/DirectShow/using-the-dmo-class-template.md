---
description: Использование шаблона класса DMO
ms.assetid: 5193ad08-aaee-47e3-93eb-a126a66d8f23
title: Использование шаблона класса DMO
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4db80017372f11f6c928e0e6a83b591967a84ee7
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104081089"
---
# <a name="using-the-dmo-class-template"></a>Использование шаблона класса DMO

DirectShow включает шаблон класса [**имедиаобжектимпл**](imediaobjectimpl-class-template.md)для реализации дмос. Шаблон обрабатывает множество задач по регистрации, например проверку входных параметров. С помощью шаблона вы можете сосредоточиться на функциональных возможностях, характерных для объектов DMO. Кроме того, шаблон помогает гарантировать создание надежной реализации. Шаблон определяется в файле заголовка Дмоимпл. h, расположенном в каталоге Include пакета SDK.

Шаблон **имедиаобжектимпл** наследует интерфейс [**имедиаобжект**](/previous-versions/windows/desktop/api/Mediaobj/nn-mediaobj-imediaobject) . Чтобы создать DMO с помощью шаблона, определите новый класс, производный от **имедиаобжектимпл**. Шаблон реализует все методы **имедиаобжект** . В большинстве случаев шаблон вызывает соответствующий закрытый метод производного класса. Этот шаблон предоставляет следующие возможности.

-   Проверка основных параметров. Методы шаблона проверяют, что обязательные параметры не равны **null**, индексы потоков находятся в пределах диапазона, и что эти флаги допустимы.
-   Блокировкой. Методы шаблона вызывают два внутренних метода: **Lock** и **Unlock** для сериализации операций в DMO. Эта функция гарантирует, что DMO будет потокобезопасным.
-   Типы носителей. Шаблон хранит типы носителей, заданные клиентом, и предоставляет методы доступа для типов мультимедиа.
-   Потоки. Шаблон предотвращает потоковую передачу, пока клиент не настроил типы мультимедиа для всех необязательных потоков. Это также гарантирует, что метод [**имедиаобжект:: аллокатестреамингресаурцес**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-allocatestreamingresources) вызывается перед началом потоковой передачи, что гарантирует выделение ресурсов.

Производный класс должен реализовывать интерфейс **IUnknown** ; Этот интерфейс не предоставляется шаблоном. Можно использовать библиотеку активных шаблонов (ATL) для реализации **IUnknown** или предоставить некоторую другую реализацию. В шаблоне также не реализован механизм блокировки. Производный класс должен реализовывать методы **Lock** и **Unlock** . При создании класса с помощью ATL можно использовать реализации ATL по умолчанию.

**Объявление производного класса**

Шаблон класса **имедиаобжектимпл** объявляется следующим образом:


```C++
template <class _DERIVED_, int NUMBEROFINPUTS, int NUMBEROFOUTPUTS>
class IMediaObjectImpl : public ImediaObject
```



Три параметра шаблона являются \_ производными \_ , НУМБЕРОФИНПУТС и нумберофаутпутс. Задайте значение \_ производное \_ равным имени класса. Два других параметра определяют количество входных потоков и потоков вывода в DMO. Например, чтобы создать класс DMO с именем Кмидмо, который поддерживает один входной поток и два выходных потока, используйте следующее объявление:


```C++
class CMyDmo : public IMediaObjectImpl<CMyDmo, 1, 2>
```



Оставшаяся часть этого раздела описывает, как шаблон реализует различные методы в **имедиаобжект**.

**Методы установки типов мультимедиа**

Следующие методы устанавливают или извлекают типы мультимедиа в DMO:

-   **Жетинпуттипе**, **жетаутпуттипе**. Эти методы возвращают предпочтительные типы мультимедиа по номеру потока и индексу типа. Шаблон вызывает **интерналжетинпуттипе** или **интерналжетаутпуттипе** в производном классе.
-   **Сетинпуттипе**, **сетаутпуттипе**. Эти методы задают тип мультимедиа в потоке, проверяют тип носителя или удаляют тип носителя. Чтобы проверить тип носителя, шаблон вызывает **интерналчеккинпуттипе** или **интерналчеккаутпуттипе** в производном классе. Производный класс возвращает S \_ ОК, чтобы принять тип или DMO \_ E \_ инвалидтипе для отклонения типа. Шаблон обрабатывает установку или очистку типа носителя.
-   **Жетинпуткурренттипе**, **жетаутпуткурренттипе**. Эти методы возвращают текущий тип мультимедиа для потока или \_ тип DMO E, \_ \_ \_ Если тип не задан. Шаблон полностью реализует эти методы.

**Информационные методы**

Следующие методы предоставляют сведения о DMO.

-   **Жетинпутмакслатенци**, **сетинпутмакслатенци**. Эти методы извлекают или устанавливают максимальную задержку. Шаблон вызывает **интерналжетинпутмакслатенци** или **интерналсетинпутмакслатенци** в производном классе.
-   **Жетинпутсизеинфо**, **жетаутпутсизеинфо**. Эти методы возвращают требования к буферу DMO для указанного потока. Если для этого потока не задан тип мультимедиа, шаблон Возвращает тип DMO " \_ \_ \_ не \_ задан". В противном случае он вызывает **интерналжетинпутсизеинфо** или **интерналжетаутпутсизеинфо** в производном классе.
-   **Жетинпутстреаминфо**, **жетаутпутстреаминфо**. Эти методы возвращают различные флаги, которые указывают, как клиент должен форматировать данные. Шаблон вызывает **интерналжетинпутстреаминфо** или **интерналжетаутпутстреаминфо** в производном классе.
-   **Жетстреамкаунт**. Этот метод возвращает число потоков ввода и вывода. Шаблон реализует этот метод с помощью параметров шаблона.

**Методы для выделения ресурсов**

-   Метод **аллокатестреамингресаурцес** выделяет все ресурсы, необходимые для DMO перед началом потоковой передачи. Метод **фристреамингресаурцес** освобождает те же ресурсы. Шаблон вызывает **интерналаллокатестреамингресаурцес** и **интерналфристреамингресаурцес** соответственно.

Клиенту DMO не требуется вызывать эти методы, но шаблон автоматически вызывает **аллокатестреамингресаурцес** перед запуском потоковой передачи. Таким образом, DMO может предположить, что ресурсы были правильно распределены по времени, вызванном методом **ProcessInput** . DMO должен вызвать **фристреамингресаурцес** в своем деструкторе.

Кроме того, когда шаблон вызывает **интерналаллокатестреамингресаурцес**, он устанавливает внутренний флаг, чтобы он не вызывал этот метод еще раз до вызова **интерналфристреамингресаурцес**. Это гарантирует, что ресурсы не будут перераспределяться случайно, что может привести к утечкам памяти.

**Методы потоковой передачи**

Для потоковой передачи данных используются следующие методы.

-   **Жетинпутстатус**. Этот метод указывает, может ли объект DMO принимать входные данные в данный момент. Шаблон вызывает **интерналакцептингинпут** в производном классе. Если объекты DMO могут принимать входные данные, то производный класс возвращает \_ значение S ОК, а шаблон задает \_ бит входных \_ данных статусф для DMO \_ \_ в параметре *dwFlags* . В противном случае производный класс возвращает \_ значение false, а шаблон задает для *dwFlags* значение 0.
-   **ProcessInput**. Этот метод обрабатывает входной буфер. Шаблон вызывает **аллокатестреамингресаурцес**, описанный выше. Затем он вызывает **интерналакцептингинпут** в производном классе. Если DMO может принимать новые входные данные, шаблон вызывает **интерналпроцессинпут**.
-   **ProcessOutput**. Этот метод обрабатывает набор выходных буферов, по одному буферу для каждого выходного потока. Шаблон вызывает **аллокатестреамингресаурцес** , а затем **интерналпроцессаутпут**.
-   **Ненепрерывность**. Этот метод сигнализирует о прекращении поддержки во входном потоке. Шаблон вызывает **интерналакцептингинпут** в производном классе. Если этот метод возвращает значение \_ ОК, шаблон вызывает **интерналдисконтинуити** для производного класса.
-   **Сброс**. Этот метод очищает DMO. Шаблон вызывает **интерналфлуш** в производном классе. DMO должен удалить все входные буферы, которые все еще хранятся для обработки.

Шаблон не предоставляет прямой поддержки для интерфейса [**имедиаобжектинплаце**](/previous-versions/windows/desktop/api/mediaobj/nn-mediaobj-imediaobjectinplace) .

**Методы блокировки**

Блокировка используется для защиты состояния DMO в многопоточной среде. В проекте ATL метод [**имедиаобжект:: Lock**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-lock) вызывает конфликт имен с методом **блокировки** ATL. Для разрешения конфликта шаблон переименовывает метод **имедиаобжект** в **дмолокк**. При компиляции производного класса Определите имя исправления, \_ \_ прежде чем включать файл заголовка DMO. h:


```C++
#define FIX_LOCK_NAME
#include <dmo.h>
```



Эта директива заставляет препроцессору заменять **дмолокк** для **блокировки** в объявлении интерфейса **имедиаобжект** . Приложения по-прежнему могут вызывать метод с помощью **блокировки** имени, так как порядок vtable не изменяется. Метод **дмолокк** вызывает **блокировку** или **разблокировку** в производном классе. Если для реализации производного класса используется ATL, эти методы уже определены в ATL, поэтому дополнительный код не требуется. Если вы не используете ATL, необходимо предоставить методы **Lock** и **Unlock** в производном классе.

Шаблон автоматически блокирует DMO в каждом из методов **имедиаобжект** . Производному классу может потребоваться заблокировать DMO в других открытых методах, которые он реализует (например, если он поддерживает **имедиаобжектинплаце**). Шаблон класса также предоставляет внутренний вспомогательный класс [**имедиаобжектимпл:: локкит**](imediaobjectimpl-lockit.md), который полезен для блокировки и разблокировки DMO.

**Сводка**

Для следующих методов **имедиаобжект** шаблон вызывает соответствующий метод с той же сигнатурой в производном классе. Производный класс должен реализовывать каждый из методов, показанных во втором столбце.



| Метод Имедиаобжект            | Метод производного класса                   |
|--------------------------------|----------------------------------------|
| **аллокатестреамингресаурцес** | **интерналаллокатестреамингресаурцес** |
| **Разрыв**              | **интерналдисконтинуити**              |
| **Очистка**                      | **интерналфлуш**                      |
| **фристреамингресаурцес**     | **интерналфристреамингресаурцес**     |
| **жетинпутмакслатенци**         | **интерналжетинпутмакслатенци**         |
| **жетинпутсизеинфо**           | **интерналжетинпутсизеинфо**           |
| **жетинпутстреаминфо**         | **интерналжетинпутстреаминфо**         |
| **жетинпуттипе**               | **интерналжетинпуттипе**               |
| **жетаутпутсизеинфо**          | **интерналжетаутпутсизеинфо**          |
| **жетаутпутстреаминфо**        | **интерналжетаутпутстреаминфо**        |
| **жетаутпуттипе**              | **интерналжетаутпуттипе**              |
| **ProcessInput**               | **интерналпроцессинпут**               |
| **ProcessOutput**              | **интерналпроцессаутпут**              |
| **сетинпутмакслатенци**         | **интерналсетинпутмакслатенци**         |



 

Для оставшихся методов **имедиаобжект** не существует соответствия "один к одному" между методами шаблонов и методами производного класса. В следующей таблице перечислены методы, полностью реализуемые шаблоном, и методы, которые вызывают другие методы в производном классе.



| Метод Имедиаобжект                   | Метод производного класса                                                             |
|---------------------------------------|----------------------------------------------------------------------------------|
| **жетинпуткурренттипе**               | Полностью реализовано                                                                |
| **жетаутпуткурренттипе**              | Полностью реализовано                                                                |
| **жетстреамкаунт**                    | Полностью реализовано                                                                |
| **жетинпутстатус**                    | [**интерналакцептингинпут**](/previous-versions/ms809095(v=msdn.10))        |
| **Lock** (реализован как **дмолокк**) | [**Блокировка**](/previous-versions/ms809100(v=msdn.10)), [ **разблокировка**](/previous-versions/ms809101(v=msdn.10)) |
| **сетинпуттипе**                      | [**интерналчеккинпуттипе**](/previous-versions/ms809096(v=msdn.10))        |
| **сетаутпуттипе**                     | [**интерналчеккаутпуттипе**](/previous-versions/ms809098(v=msdn.10))      |



 

## <a name="related-topics"></a>См. также

<dl> <dt>

[**Шаблон класса Имедиаобжектимпл**](imediaobjectimpl-class-template.md)
</dt> <dt>

[Написание DMO](writing-a-dmo.md)
</dt> </dl>

 

 
