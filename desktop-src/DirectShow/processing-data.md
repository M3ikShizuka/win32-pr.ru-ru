---
description: Обработка данных
ms.assetid: 823615df-ce50-4e20-957a-f83d3be66658
title: Обработка данных
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9bbece449df36c2de88414f313d477b8a16ba896
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "105673053"
---
# <a name="processing-data"></a>Обработка данных

**Анализ данных мультимедиа**

Если фильтр анализирует данные мультимедиа, не следует доверять заголовкам или другим самоопределяющим данным в содержимом. Например, не следует доверять значениям размера, которые отображаются в фрагментах AVI Metallica или в пакетах MPEG. Ниже приведены распространенные примеры такого рода ошибок.

-   Считывание *n* байт данных, где значение *n* получено из содержимого, без проверки значения *n* относительно фактического размера буфера.
-   Переход к байтовому смещению в пределах буфера без проверки того, что смещение попадает в буфер.

Другим распространенным классом ошибок не является проверка описаний форматов, найденных в содержимом. Пример:

-   За структурой [**битмапинфохеадер**](/windows/win32/api/wingdi/ns-wingdi-bitmapinfoheader) может следовать таблица цветов. Структура **битмапинфо** определяется как структура **битмапинфохеадер** , за которой следует массив значений **ргбкуад** , образующих таблицу цветов. Размер массива определяется значением **биклрусед**. Никогда не копируйте таблицу цветов в **битмапинфо** без предварительной проверки размера буфера, выделенного для структуры **битмапинфо** .
-   К структуре [**вавеформатекс**](/previous-versions/dd757713(v=vs.85)) могут быть добавлены дополнительные сведения о форматировании. Элемент **кбсизе** указывает размер дополнительной информации.

Во время подключения к закреплениям фильтр должен проверять правильность формата всех структур форматирования и иметь разумные значения. В противном случае отклоните подключение. В коде, который проверяет структуру формата, будьте особенно внимательны к арифметическому переполнению. Например, в **битмапинфохеадер** ширина и высота представляют собой 32-разрядные **длинные** значения, но размер изображения (который является функцией произведения двух) — это только значение **типа DWORD** .

Если данные формата из источника больше выделенного буфера, не следует усекать исходные данные, чтобы скопировать их в буфер. Это может создать структуру, неявный размер которой больше, чем фактический размер. Например, в заголовке точечного рисунка может быть указана таблица палитры, которая больше не существует. Вместо этого Перераспределите буфер или просто завершите соединение.

**Ошибки во время потоковой передачи**

Если при выполнении графа фильтр получает неверно сформированное содержимое, он должен завершить потоковую передачу. Выполните следующие действия.

-   Возврат кода ошибки из **Receive**.
-   Вызовите [**Ипин:: EndOfStream**](/windows/desktop/api/Strmif/nf-strmif-ipin-endofstream) в подчиненном фильтре.
-   Вызовите [**кбасефилтер:: нотифевент**](cbasefilter-notifyevent.md) , чтобы опубликовать событие [**EC \_ еррораборт**](ec-errorabort.md) .

**Изменения формата**

Существует несколько механизмов, которые можно выполнить для фильтров, чтобы изменить формат среднего потока. Каждая из них включает в себя несколько шагов, что создает потенциал для ложных приемов. Если фильтр получает запрос на изменение динамического формата, он должен либо отклонить запрос, либо при поступлении принять новый формат. Аналогично, никогда не следует переключать форматы, если только другой фильтр не согласен. Дополнительные сведения см. в разделе [динамические изменения формата](dynamic-format-changes.md).

 

 
