---
description: Проверка цепочки сертификатов
ms.assetid: e0c36f04-1694-40d8-94a1-06ee7de08777
title: Проверка цепочки сертификатов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 70a1dd3a09e46199cb537c1ac4b17cb96ed0edc2
ms.sourcegitcommit: 61a4c522182aa1cacbf5669683d9570a3bf043b2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/26/2021
ms.locfileid: "122884041"
---
# <a name="validating-the-certificate-chain"></a>Проверка цепочки сертификатов

В этом разделе описано, как проверить цепочку сертификатов драйвера при использовании протокола сертифицированной выходной защиты (Копп).

Цепочка сертификатов графического драйвера — это XML-документ. Цепочка сертификатов содержит три сертификата. Первый сертификат называется *конечным сертификатом*, а — сертификатом Копп драйвера. Следующий сертификат является сертификатом подписи независимого поставщика оборудования (IHV). Последний сертификат — сертификат подписи Майкрософт. Чтобы убедиться, что графический драйвер является легальным устройством Копп, приложение должно проверить все три из этих сертификатов. Вредоносная программа может препятствовать работе Копп, если приложение неправильно проверяет сертификаты в цепочке.

Цепочки сертификатов Копп используют кодировку UTF-8. Двоичные данные в сертификатах, например открытый ключ RSA, кодируются в кодировке Base64 и хранятся в порядке с обратным порядком байтов. (*Big-endian* означает, что наиболее значимый байт хранится в памяти с наименьшим адресом.)

Некоторые элементы в сертификате содержат логические значения, которые указывают на существование компонента сертификата. Если функция существует, соответствующему дочернему элементу присваивается значение 1. Если компонент отсутствует, этот дочерний элемент отсутствует в сертификате.

### <a name="xml-element-definitions"></a>Определения XML-элементов

Ниже приведены определения для элементов в схеме сертификата.

-   **Цертификатеколлектион**. Корневой элемент XML-документа. Он содержит элементы сертификата, по одному для каждого сертификата в цепочке.
-   **Сертификат**. Содержит один сертификат. Этот элемент содержит данные и элементы сигнатуры.
-   **Данные**. Содержит сведения о сертификате. В частности, он содержит открытый ключ сертификата и тип. Элемент Data содержит следующие дочерние элементы:
    -   **PublicKey**. Содержит открытый ключ RSA сертификата. Элемент PublicKey содержит элемент KeyValue, который содержит элемент Рсакэйвалуе. У элемента Рсакэйвалуе есть два дочерних элемента, модуль и экспонента, и они определяют открытый ключ. Элементы модуля и экспоненты кодируются в кодировке Base64 и хранятся в порядке с обратным порядком байтов.
    -   **Кэйусаже**. Если сертификат является сертификатом Копп драйвера, этот элемент должен содержать дочерний элемент с именем Енкрипткэй. Если сертификат является сертификатом подписи независимого поставщика оборудования или сертификатом подписи Майкрософт, он должен содержать дочерний элемент с именем Сигнцертификате. Оба этих дочерних элемента содержат логические значения.
    -   **Секуритилевел**. Этот элемент следует игнорировать.
    -   **Мануфактурердата**. Указывает изготовителя и модель графического устройства. Этот элемент является только информационным.
    -   **Features**. Содержит дочерние элементы, которые указывают на использование сертификата. Единственным, что относится к Копп, является элемент Коппцертификате. Могут присутствовать другие дочерние элементы; Если это так, их следует игнорировать. Если элемент Коппцертификате существует, сертификат является сертификатом Копп. Этот элемент должен присутствовать в конечном узле допустимого сертификата Копп. Этот элемент содержит логическое значение.
-   **Сигнатура**. Содержит подпись для этого сертификата. Он содержит следующие дочерние элементы:
    -   **SignedInfo**. Содержит сведения о сигнатуре. Важным дочерним элементом этого элемента является элемент Дижествалуе, который содержит значение хэша SHA-1 в кодировке Base64 для элемента данных. Значение дайджеста используется при проверке сертификата по списку отзыва сертификатов (CRL).
    -   **Сигнатуревалуе**. Это значение вычислено для элемента данных и вычислено в соответствии со схемой цифровых подписей РСАССА-PSS, определенной в Public-Key криптографических стандартах (PKCS) \# 1 (версия 2,1). Сведения о PKCS \# 1 см. в статье [https://www.rsa.com/](https://www.rsa.com/) .
    -   **KeyInfo**. Содержит открытый ключ RSA следующего сертификата в цепочке. Этот элемент используется для проверки того, что данные в элементе Data не были изменены. Этот элемент имеет тот же формат, что и элемент PublicKey.

### <a name="certificate-validation"></a>Проверка сертификатов

Чтобы правильно проверить цепочку сертификатов, приложение должно выполнить следующие действия. В случае сбоя любого из шагов или если какой либо элемент, на который ссылается в этих процедурах, не существует, проверка завершится ошибкой.

### <a name="validate-certificate-collection-procedure"></a>Процедура проверки коллекции сертификатов

Чтобы проверить цепочку сертификатов, выполните следующие действия.

1.  Убедитесь, что Цертификатеколлектион имеет правильный формат XML.
2.  Убедитесь, что Цертификатеколлектион кодируется в формате UTF-8.
3.  Убедитесь, что атрибут Version в элементе Цертификатеколлектион имеет значение 2,0 или более поздней версии.
4.  Убедитесь, что цепочка сертификатов содержит ровно три элемента сертификата.
5.  Пройдите по каждому элементу сертификата в цепочке сертификатов и выполните процедуру проверки сертификата, описанную ниже, для каждой из них.

### <a name="validate-certificate-procedure"></a>Процедура проверки сертификата

Чтобы проверить сертификат в цепочке, выполните следующие действия.

1.  Убедитесь, что ни один из дочерних элементов в элементе Data не повторяется. Например, должен быть только один элемент PublicKey.
2.  Убедитесь, что элемент Data/PublicKey/KeyValue/Рсакэйвалуе/модуль существует. Значение декодированной Base64 должно быть 256 байт для всех сертификатов, кроме корневого. В корневом сертификате этот элемент должен иметь длину 128 байт.
3.  Убедитесь, что элемент Data/PublicKey/KeyValue/Рсакэйвалуе/экспонента существует. Декодированное значение Base64 не должно быть больше 4 байт.
4.  Если этот сертификат является конечным, проверьте следующее:
    -   Элемент Кэйусаже содержит элемент Енкрипткэй со значением 1.
    -   Элемент features содержит элемент Коппцертификате со значением 1.
5.  Если этот сертификат не является конечным сертификатом, проверьте следующее:
    -   Модуль и показатель степени из элемента Data/PublicKey точно соответствуют модулю и экспоненте из элемента Signature/KeyInfo предыдущего сертификата.
    -   Элемент Кэйусаже содержит элемент Сигнцертификате со значением 1.
6.  Используйте хэш-алгоритм SHA-1 для хэширования каждого байта в элементе данных сертификата. Каждый байт от первого символа в &lt; &gt; теге данных до последнего символа в закрывающем &lt; &gt; теге/Дата должен быть хэширован. Хэш-значение используется для проверки сертификата по списку отзыва сертификатов (CRL), как описано в [списках отзыва сертификатов](certificate-revocation-lists.md) .
7.  Сравните значение хэша из шага 6 с декодированным значением SignedInfo/Reference/Дижествалуе в формате Base64. Эти значения должны совпадать.
8.  Выполните процедуру проверки подписи, описанную ниже.
9.  Если этот сертификат не является окончательным сертификатом в цепочке, сохраните значение Signature/KeyInfo/KeyValue/Рсакэйвалуе для следующей итерации цикла.
10. Если этот сертификат является окончательным сертификатом в цепочке, убедитесь, что значение Signature/KeyInfo/KeyValue/Рсакэйвалуе соответствует открытому ключу Майкрософт. Открытый ключ Майкрософт имеет следующие значения в кодировке Base64:
    -   Модул

        `pjoeWLSTLDonQG8She6QhkYbYott9fPZ8tHdB128ZETcghn5KHoyin7HkJEcPJ0Eg4UdSv a0KDIYDjA3EXd69R3CN2Wp/QyOo0ZPYWYp3NXpJ700tKPgIplzo5wVd/69g7j+j8M66W7V NmDwaNs9mDc1p2+VVMsDhOsV/Au6E+E=`

    -   Числа `AQAB`

### <a name="verify-signature-procedure"></a>Проверка процедуры подписи

Значение элемента Сигнатуревалуе вычислено для элемента данных в соответствии со схемой цифровых подписей РСАССА-PSS, определенной в PKCS \# 1 версии 2,1 (здесь и далее НАЗЫВАЕТСЯ PKCS). Чтобы проверить эту подпись, выполните следующие действия.

1.  Декодирование значений модуля и экспоненты в элементе Signature/KeyInfo/KeyValue/Рсакэйвалуе. Эти значения определяют открытый ключ RSA сертификата подписи.
2.  Декодирование элемента Signature/Сигнатуревалуе.
3.  Вычислите операцию РСАССА-PSS-Verify, определенную в разделе BIND 8.1.2 файла PKCS.

Для операции РСАССА-PSS-Verify используйте следующие входные данные:

-   (*n*,*e*) — это открытый ключ из шага 1.
-   *M* — все байты в элементе Data, включая &lt; &gt; теги Data и &lt; /Дата &gt; , которые заключают элемент.
-   *S* — это декодированное значение сигнатуры из шага 2.

Операция РСАССА-PSS-Verify использует операцию ЕМСА-PSS-ENCODED, определенную в разделе 9.1.1. из PKCS. Для этой операции Копп использует следующие параметры:

-   Hash = SHA-1
-   *хлен* = 20
-   МГФ (функция формирования маски) = ГЕНЕРАЦИИ маски MGF1
-   *слен* = 0

Функция создания маски ГЕНЕРАЦИИ маски MGF1 определена в приложении B. 2 из PKCS. Для этой функции Копп использует следующие параметры:

-   Hash = SHA-1
-   *хлен* = 20

Выходные данные операции РСАССА-PSS-Verify указывают, является ли подпись допустимой или недопустимой.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Использование протокола сертифицированной выходной защиты (Копп)](using-certified-output-protection-protocol--copp.md)
</dt> </dl>

 

 



