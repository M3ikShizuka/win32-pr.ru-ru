---
description: Запись проекта в файл
ms.assetid: 84499e4f-4f45-4aa6-aa89-d95c3b6b47d0
title: Запись проекта в файл
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b8f63ddbc6a021362134d420220f7e25c662553f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105683625"
---
# <a name="writing-a-project-to-a-file"></a>Запись проекта в файл

\[Этот API не поддерживается и может быть изменен или недоступен в будущем.\]

В этой статье описывается, как записать проект [служб редактирования DirectShow](directshow-editing-services.md) в файл. Сначала он описывает, как записать файл с помощью базовой подсистемы визуализации. Затем он описывает интеллектуальное повторное сжатие с помощью интеллектуального механизма визуализации.

Общие сведения о визуализации проектов в службах редактирования DirectShow см. [в разделе о механизмах подготовки](about-the-render-engines.md)отчетов.

**Использование базового механизма визуализации**

Начните с создания внешнего интерфейса графа следующим образом:

1.  Создайте подсистему визуализации.
2.  Укажите временную шкалу.
3.  Задайте диапазон отрисовки. (необязательно)
4.  Создание внешнего интерфейса графа.

Эти шаги показаны в следующем примере кода.


```C++
IRenderEngine *pRender = NULL; 
hr = CoCreateInstance(CLSID_RenderEngine, NULL, CLSCTX_INPROC,
    IID_IRenderEngine, (void**) &pRender);

hr = pRender->SetTimelineObject(pTL);
hr = pRender->ConnectFrontEnd( );
```



Далее добавьте к графу фильтров фильтры для мультиплексирования и записи файлов. Проще всего это сделать с помощью [построителя графа записи](capture-graph-builder.md), компонента DirectShow для создания графов записи. Построитель графов записи предоставляет интерфейс [**ICaptureGraphBuilder2**](/windows/desktop/api/Strmif/nn-strmif-icapturegraphbuilder2) . Выполните следующие действия:

1.  Создайте экземпляр построителя графа записи.
2.  Получите указатель на граф и передайте его в построитель Graph.
3.  Укажите имя и тип носителя для выходного файла. Этот шаг также получает указатель на фильтр мультиплексора, который требуется позже.

Эти шаги показаны в следующем примере кода.


```C++
CoCreateInstance(CLSID_CaptureGraphBuilder2, NULL, CLSCTX_INPROC, 
    IID_ICaptureGraphBuilder2, (void **)&pBuilder);

// Get a pointer to the graph front end.
IGraphBuilder *pGraph;
pRender->GetFilterGraph(&pGraph);
pBuilder->SetFiltergraph(pGraph);

// Create the file-writing section.
IBaseFilter *pMux;
pBuilder->SetOutputFileName(&MEDIASUBTYPE_Avi, 
    OLESTR("Output.avi"), &pMux, NULL);
```



Наконец, подключите выходные контакты на внешнем интерфейсе к фильтру мультиплексора.

1.  Получение числа групп.
2.  Для каждого ПИН-кода получите указатель на ПИН-код.
3.  При необходимости создайте экземпляр фильтра сжатия для сжатия потока. Тип сжатия будет зависеть от типа носителя группы. [Перечислитель системных устройств](system-device-enumerator.md) можно использовать для перечисления доступных фильтров сжатия. Дополнительные сведения см. в разделе [Перечисление устройств и фильтров](enumerating-devices-and-filters.md).
4.  При необходимости задайте параметры сжатия, такие как частота ключевых кадров. Этот шаг подробно описан далее в этой статье.
5.  Вызовите [**ICaptureGraphBuilder2:: RenderStream**](/windows/desktop/api/Strmif/nf-strmif-icapturegraphbuilder2-renderstream). Этот метод принимает указатели на ПИН-код, фильтр сжатия (если он есть) и мультиплексор.

В следующем примере кода показано, как подключить выходные контакты.


```C++
long NumGroups;
pTimeline->GetGroupCount(&NumGroups);

// Loop through the groups and get the output pins.
for (i = 0; i < NumGroups; i++)
{
    IPin *pPin;
    if (pRender->GetGroupOutputPin(i, &pPin) == S_OK) 
    {
        IBaseFilter *pCompressor;
        // Create a compressor filter. (Not shown.)
        // Set compression parameters. (Not shown.)

        // Connect the pin.
        pBuilder->RenderStream(NULL, NULL, pPin, pCompressor, pMux);
        pCompressor->Release();
        pPin->Release();
    }
}
```



Чтобы задать параметры сжатия (шаг 4, ранее), используйте интерфейс [**иамвидеокомпрессион**](/windows/desktop/api/Strmif/nn-strmif-iamvideocompression) . Этот интерфейс предоставляется на выходных контактах фильтров сжатия. Перечислите ПИН-коды фильтра сжатия и запросите все выходные данные для **иамвидеокомпрессион**. (Дополнительные сведения о перечислении ПИН-кодов см. в разделе [перечисление ПИН](enumerating-pins.md)-кодов.) Не забудьте освободить все указатели интерфейса, полученные на этом шаге.

После построения графа фильтра вызовите метод [**имедиаконтрол:: Run**](/windows/desktop/api/Control/nf-control-imediacontrol-run) в диспетчере графов фильтров. При выполнении графа фильтра данные записываются в файл. Используйте уведомление о событии, чтобы дождаться завершения воспроизведения. (См. раздел [реагирование на события](responding-to-events.md).) По завершении воспроизведения необходимо явно вызвать [**имедиаконтрол:: останавливаться**](/windows/desktop/api/Control/nf-control-imediacontrol-stop) , чтобы прерывать граф фильтра. В противном случае файл будет записан неправильно.

**Использование подсистемы интеллектуального просмотра**

Чтобы получить преимущества интеллектуального повторного сжатия, используйте интеллектуальный механизм визуализации вместо базового механизма визуализации. Шаги по созданию графа практически одинаковы. Основное различие заключается в том, что сжатие обрабатывается на внешнем интерфейсе графа, а не в разделе, предназначенном для записи файлов.

> [!IMPORTANT]
> Не используйте интеллектуальный модуль визуализации для чтения или записи файлов Windows Media.

 

Каждая группа видео имеет свойство, определяющее формат сжатия для этой группы. Формат сжатия должен точно совпадать с форматом несжатой группы по высоте, ширине, глубине бит и частоте кадров. Интеллектуальный механизм визуализации использует формат сжатия при создании графа. Перед установкой формата сжатия обязательно задайте несжатый формат для этой группы, вызвав [**иамтимелинеграуп:: сетмедиатипе**](iamtimelinegroup-setmediatype.md).

Чтобы задать формат сжатия группы, вызовите метод [**иамтимелинеграуп:: сетсмартрекомпрессформат**](iamtimelinegroup-setsmartrecompressformat.md) . Этот метод принимает указатель на структуру [**SCompFmt0**](scompfmt0.md) . Структура **SCompFmt0** имеет два члена: **нформатид**, который должен равняться нулю, и **mediaType**, который является структурой [**\_ \_ типа мультимедиа AM**](/windows/win32/api/strmif/ns-strmif-am_media_type) . Инициализируйте **структуру \_ \_ типа файлов мультимедиа** , используя сведения о форматировании.

> [!Note]  
> Если вы хотите, чтобы окончательный проект имел тот же формат, что и один из исходных файлов, можно получить \_ структуру типа файлов мультимедиа, \_ непосредственно исходя из исходного файла, используя средство обнаружения мультимедиа. См. раздел [**имедиадет:: Get \_ стреаммедиатипе**](imediadet-get-streammediatype.md).

 

Приведите переменную [**SCompFmt0**](scompfmt0.md) к указателю типа **Long**, как показано в следующем примере.


```C++
SCompFmt0 *pFormat = new SCompFmt0;
memset(pFormat, 0, sizeof(SCompFmt0));
pFormat->nFormatId = 0;

// Initialize pFormat->MediaType. (Not shown.)

pGroup->SetSmartRecompressFormat( (long*) pFormat );
```



Интеллектуальный механизм визуализации автоматически ищет совместимый фильтр сжатия. Можно также указать фильтр сжатия для группы, вызвав [**исмартрендеренгине:: сетграупкомпрессор**](ismartrenderengine-setgroupcompressor.md).

Чтобы построить граф, выполните те же действия, которые были описаны для базового механизма отрисовки в предыдущем разделе. Ниже приведены единственные отличия.

-   Используйте интеллектуальный механизм визуализации, а не базовый механизм визуализации. Идентификатор класса — CLSID \_ смартрендеренгине.
-   Задайте параметры сжатия после сборки внешнего интерфейса, но перед отрисовкой выходных закрепления. Вызовите метод [**исмартрендеренгине:: жетграупкомпрессор**](ismartrenderengine-getgroupcompressor.md) , чтобы получить указатель на фильтр сжатия группы. Затем запросите интерфейс [**иамвидеокомпрессион**](/windows/desktop/api/Strmif/nn-strmif-iamvideocompression) , как описано выше.
-   При отрисовке выходных контактов нет необходимости вставлять фильтр сжатия. Поток уже сжат.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Подготовка проекта](rendering-a-project.md)
</dt> </dl>

 

 



