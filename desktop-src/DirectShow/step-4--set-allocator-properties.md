---
description: Задайте свойства распределителя в процессе записи фильтра преобразования. Закрепление вывода фильтра преобразования выбирает нисходящий распределитель.
ms.assetid: c2fd6d8b-b239-45e4-9c02-41edafa58762
title: Шаг 4. Задание свойств распределителя
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 33376cff0e6c0674edfadcffed59d16d8d7dccb9f48384a22ec4c69fc48d8eb7
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118652134"
---
# <a name="step-4-set-allocator-properties"></a>Шаг 4. Задание свойств распределителя

Это шаг 4 учебника [Создание фильтров преобразования](writing-transform-filters.md).

> [!Note]  
> Этот шаг не является обязательным для фильтров, производных от **ктрансинплацефилтер**.

 

После того как два контакта договариваются по типу носителя, они выбирают распределителя для соединения и согласовывают свойства распределителя, такие как размер буфера и количество буферов.

В классе **ктрансформфилтер** есть два распределителя, один для вышестоящего соединения, а другой — для соединения с нижестоящим ПИН-кодом. Вышестоящий фильтр выбирает вышестоящий распределитель, а также выбирает свойства распределителя. Входной ПИН-код принимает любой способ, который принимается в качестве вышестоящего фильтра. Если необходимо изменить это поведение, переопределите метод [**кбасеинпутпин:: нотифяллокатор**](cbaseinputpin-notifyallocator.md) .

Закрепление вывода фильтра преобразования выбирает нисходящий распределитель. Он выполняет следующие действия:

1.  Если подчиненный фильтр может предоставить распределитель, то он будет использоваться выходным закреплением. В противном случае выходной ПИН-код создает новый распределитель.
2.  Закрепление вывода получает требования к распределительу подчиненного фильтра (если таковые имеются) путем вызова [**имеминпутпин:: жеталлокаторрекуирементс**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-getallocatorrequirements).
3.  Закрепление вывода вызывает метод [**ктрансформфилтер::D еЦидебуфферсизе**](ctransformfilter-decidebuffersize.md) фильтра преобразования, который является чистым виртуальным. Параметры этого метода являются указателем на структуру распределителя и структурой [**\_ свойств распределителя**](/windows/win32/api/strmif/ns-strmif-allocator_properties) с требованиями подчиненного фильтра. Если в подчиненном фильтре нет требований к распределительу, то структура будет обнулена.
4.  В методе **деЦидебуфферсизе** производный класс задает свойства распределителя путем вызова [**Имемаллокатор:: SetProperties**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-setproperties).

Как правило, производный класс выберет свойства распределителя на основе выходного формата, требований подчиненного фильтра и собственных требований фильтра. Попробуйте выбрать свойства, совместимые с запросом подчиненного фильтра. В противном случае подчиненный фильтр может отклонить соединение.

В следующем примере кодировщик RLE устанавливает минимальные значения для размера буфера, выравнивания буфера и количества буферов. Для префикса используется любое значение, запрошенное нисходящим фильтром. Префикс обычно равен нулю байт, но для некоторых фильтров это требуется. Например, фильтр [мультиплексора](avi-mux-filter.md) в формате AVI использует префикс для записи заголовков Metallica.


```C++
HRESULT CRleFilter::DecideBufferSize(
    IMemAllocator *pAlloc, ALLOCATOR_PROPERTIES *pProp)
{
    AM_MEDIA_TYPE mt;
    HRESULT hr = m_pOutput->ConnectionMediaType(&mt);
    if (FAILED(hr))
    {
        return hr;
    }

    ASSERT(mt.formattype == FORMAT_VideoInfo);
    BITMAPINFOHEADER *pbmi = HEADER(mt.pbFormat);
    pProp->cbBuffer = DIBSIZE(*pbmi) * 2; 
    if (pProp->cbAlign == 0)
    {
        pProp->cbAlign = 1;
    }
    if (pProp->cBuffers == 0)
    {
        pProp->cBuffers = 1;
    }
    // Release the format block.
    FreeMediaType(mt);

    // Set allocator properties.
    ALLOCATOR_PROPERTIES Actual;
    hr = pAlloc->SetProperties(pProp, &Actual);
    if (FAILED(hr)) 
    {
        return hr;
    }
    // Even when it succeeds, check the actual result.
    if (pProp->cbBuffer > Actual.cbBuffer) 
    {
        return E_FAIL;
    }
    return S_OK;
}
```



Распределитель не сможет точно сопоставить ваш запрос. Поэтому метод **SetProperties** возвращает фактический результат в отдельной структуре **\_ свойств распределителя** ( *фактический* параметр в предыдущем примере). Даже если **SetProperties** , следует проверить результат, чтобы убедиться, что они соответствуют минимальным требованиям фильтра.

**Пользовательские распределителя**

По умолчанию все классы фильтров используют класс [**кмемаллокатор**](cmemallocator.md) для своих распределительов. Этот класс выделяет память из виртуального адресного пространства клиентского процесса (с помощью **VirtualAlloc**). Если фильтр должен использовать некоторый другой тип памяти, например поверхности DirectDraw, можно реализовать пользовательский распределитель. Можно использовать класс [**кбасеаллокатор**](cbaseallocator.md) или написать совершенно новый класс распределителя. Если фильтр имеет пользовательский распределитель, переопределите следующие методы в зависимости от того, какой ПИН-код использует распределитель:

-   Входной ПИН-код: [**кбасеинпутпин::-распределителя**](cbaseinputpin-getallocator.md) и [**Кбасеинпутпин:: нотифяллокатор**](cbaseinputpin-notifyallocator.md).
-   Выходной ПИН-код: [**кбасеаутпутпин::D еЦидеаллокатор**](cbaseoutputpin-decideallocator.md).

Если другой фильтр отказывается подключиться с помощью пользовательского распределителя, то фильтр может либо завершить подключение, либо подключиться к распределителю другого фильтра. В последнем случае может потребоваться установить внутренний флаг, указывающий тип распределителя. Пример такого подхода см. в разделе [**класс кдравимаже**](cdrawimage.md).

Далее. [Шаг 5. Преобразование изображения](step-5--transform-the-image.md).

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[написание фильтров DirectShow](writing-directshow-filters.md)
</dt> </dl>

 

 



