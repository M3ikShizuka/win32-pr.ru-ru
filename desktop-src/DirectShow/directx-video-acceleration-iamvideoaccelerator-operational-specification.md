---
description: Спецификация оперативного ускорения DirectX Video Иамвидеоакцелератор
ms.assetid: 25ee05d5-8554-4739-9122-e3c0255bf965
title: Спецификация оперативного ускорения DirectX Video Иамвидеоакцелератор
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 3360e18e91197f2a15a36fb112f0419b6382e915
ms.sourcegitcommit: d75fc10b9f0825bbe5ce5045c90d4045e3c53243
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2021
ms.locfileid: "127053936"
---
# <a name="directx-video-acceleration-iamvideoaccelerator-operational-specification"></a>Спецификация оперативного ускорения DirectX Video Иамвидеоакцелератор

Точный механизм работы выглядит следующим образом:

1.  Каждый профиль с ограниченным режимом, определенный в этом документе, имеет связанный идентификатор GUID, который может поддерживаться нисходящим входным закреплением [**Ипин:: куерякцепт**](/windows/desktop/api/Strmif/nf-strmif-ipin-queryaccept) и [**Ипин:: рецеивеконнектион**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) и перечислены в [**иамвидеоакцелератор:: жетвидеоакцелераторгуидс**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getvideoacceleratorguids).
2.  Аналогичным образом, каждый тип протокола шифрования для использования с DirectX, должен иметь соответствующий идентификатор GUID типа протокола шифрования, который может поддерживаться [**Ипин:: куерякцепт**](/windows/desktop/api/Strmif/nf-strmif-ipin-queryaccept) и [**Ипин:: рецеивеконнектион**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) и перечислены в **иамвидеоакцелератор:: жетвидеоакцелераторгуидс**. Параметр "без шифрования" GUID ДКСВА \_ не должен отправляться в этом списке, так как его поддержка является обязательной и, следовательно, неявной.
3.  После вызова [**Ипин:: рецеивеконнектион**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) для попытки соединения с нисходящим входным закреплением декодер [**Иамвидеоакцелераторнотифи:: жеткреатевидеоакцелератордата**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-getcreatevideoacceleratordata) должен возвращать указатель на \_ структуру данных DXVA ConnectMode, содержащую сведения о режиме соединения для соединения. [**Иамвидеоакцелератор:: жеткомпбуфферинфо**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getcompbufferinfo) должен вызываться с \* пдвнумтипескомпбуфферс = 16 и возвращать информацию о сжатом буфере на основе соглашения о том, что номер типа каждого буфера (как определено в разделе 3,4 спецификации DirectX ва) можно использовать непосредственно в качестве индекса, начинающегося с нуля, в массиве **амвакомпбуфферинфо** структур данных, которые возвращаются. Для этого требуется, чтобы для любых типов буферов, которые не будут использоваться (включая тип буфера 0, поскольку не определено использование этого типа буфера), драйвер ускорителя предоставит структуры данных Амвакомпбуфферинфо с каким-либо форматом значений параметров (например, Двнумкомпбуфферс = 0, Дввидстокреате = 0, Двхеигхттокреате = 0 и Двбитестоаллокате = 0).
4.  События ДКСВА и связанные с ними буферы данных отправляются с помощью [**иамвидеоакцелератор:: Execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute). Функция ДКСВА указывается в параметре Двфунктион вызова. Единственные ДКСВА функции, относящиеся к инициализации, — это ДКСВА \_ конфигкуерйорреплифунк и дксва \_ енкриптпротоколфунк.
    -   Если Двфунктион содержит ДКСВА \_ конфигкуерйорреплифунк, то указатель лпприватеинпутдата для передачи данных в ускоритель в этом вызове указывает на структуру данных конфигурации, указатель лпприватеаутпутдата для получения информации от ускорителя, указывающий на область, где может быть размещена альтернативная или повторяющаяся структура данных конфигурации, указатель памвабуфферинфо для массива AMVABUFFERINFO должен быть **равен null**, а dwNumBuffers должен быть равен нулю. Возвращаемое значение HRESULT содержит \_ признак s OK или s \_ false, или e \_ Fail или e \_ INVALIDARG или другое обозначение ошибки HRESULT в случае серьезной проблемы при выполнении протокола (например, недопустимый параметр конфигурации). Все вызовы **иамвидеоакцелератор:: Execute** для всех применений дксва \_ конфигкуерйорреплифунк должны предшествовать всем остальным вызовам **иамвидеоакцелератор:: Execute**.
    -   Если Двфунктион содержит ДКСВА \_ енкриптпротоколфунк, то указатель лпприватеинпутдата для передачи данных в ускоритель в этом вызове должен указывать на структуру данных протокола шифрования, которая начинается с дксва \_ енкриптпротоколхеадер, указатель lpPrivateOutputData для получения сведений от сочетания клавиш должен указывать на область, в которой должны быть возвращены данные (например, сертификат) по протоколу шифрования (который начинается с DXVA \_ EncryptProtocolHeader), указатель PAMVABUFFERINFO для массива AMVABUFFERINFO должен быть **равен null**, а dwNumBuffers — равняться нулю. Возвращаемое значение HRESULT содержит S \_ ОК, если протокол шифрования работает нормально и содержит e \_ Fail или e \_ INVALIDARG или другое обозначение ошибки HRESULT в случае серьезной проблемы при выполнении протокола.

        После инициализации операции в приведенном выше режиме фактическая операция декодера продолжается следующим образом:

5.  **Иамвидеоакцелератор:: бегинфраме** должен вызываться перед отправкой любых бдксва \_ Func с параметрами сжатого буфера, которые вызывают запись в несжатую конечную поверхность. Целью [**иамвидеоакцелератор:: бегинфраме**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) в DirectX ва является связывание целевых поверхностей со значениями индекса и уведомление драйвера ускорителя для инициации записи поверхности, чтобы драйвер мог ответить на то, что поверхность готова к перезаписи. Структура **амвабегинфрамеинфо** , передаваемая в **Иамвидеоакцелератор:: бегинфраме** , должна содержать указатель Пинпутдата на один параметр вбегинпиктуреиндекс Word, соответствующий индексу кадра, переданному в **IAMVideoAccelerator:: BeginFrame** (и dwSizeInputData должен быть 2). Это индекс, который будет использоваться в сжатом буфере для команды записи в область (например, для использования в качестве Вдекодедпиктуреиндекс, Вдеблоккедпиктуреиндекс, Вблендеддестинатиониндекс или ВпикресампледестпиЦиндекс). Каждый вызов **иамвидеоакцелератор:: бегинфраме** должен быть связан с соответствующим вызовом [**Иамвидеоакцелератор:: ендфраме**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) , как описано ниже. Например, если сжатая картинка должна быть декодирована, а затем в альфа-смешение с помощью внешнего интерфейса, перекрывающегося из буфера в буфер с графическим изображением, будет вызван вызов **иамвидеоакцелератор:: бегинфраме** перед декодированием сжатого изображения в область, указанную в вдекодедпиктуреиндекс, затем вызывается метод **Иамвидеоакцелератор:: ендфраме** после передачи всех сжатых буферов, используемых для декодирования изображения, затем второй вызов **IAMVideoAccelerator:: BeginFrame** перед сочетанием альфа-смешения цвета источника с декодированным изображением в поверхность, указанную в WBlendedDestinationIndex, а затем второй вызов **IAMVideoAccelerator:: EndFrame** после операции сочетания альфа-смешения. Указатель Паутпутдата в Амвабегинфрамеинфо должен иметь **значение NULL** (и двсизеаутпутдата должен быть "0"). Значение HRESULT, возвращаемое функцией **иамвидеоакцелератор:: бегинфраме** , должно быть следующим:
    -   \_ОК, если несжатая поверхность доступна и готова к использованию.
    -   \_В ожидании, если несжатая поверхность еще недоступна для использования, но скоро станет доступна (если несжатая поверхность считывается для отображения и чтение/отображение поверхности еще не завершено).
    -   E \_ Fail или e \_ INVALIDARG другое уведомление об ошибке, только если обнаружена ошибка формата данных или протокола (например, неверное значение двсизеинпутдата или паутпутдата, отличное от **null** ).
6.  События ДКСВА и связанные с ними буферы данных отправляются с помощью **иамвидеоакцелератор:: Execute**. \_В одном вызове [**иамвидеоакцелератор:: Execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute)может быть указано более одного значения бдксва Func. Значения Бдксва \_ Func должны быть упакованы в параметр двфунктион вызова с первой командой функции в восьми МСБС, следующей командой в следующих восьми битах и так далее, при этом все оставшиеся биты заканчиваются нулями. Значение 0xFF для Бдксва \_ Func указывает, что бдксва \_ Func расширяется до двух или четырех байт. Если второй байт является также 0xFF, это означает, что Бдксва \_ Func расширен до четырех байтов. Если верхние четыре бита третьего байта являются 0xF или 0x0, это означает, что Бдксва \_ Func содержит дксва \_ КОНФИГКУЕРЙОРРЕПЛИФУНК или дксва \_ енкриптпротоколфунк. Многобайтовые команды не должны указывать на продолжение после окончания Двфунктион. Будьте осторожны с помощью декодера, чтобы убедиться, что между различными \_ значениями бдксва Func, заданными в одном вызове иамвидеоакцелератор, не существует последовательных зависимостей. **выполнение** и то, что все возможные состояния гонки (например, между декодированием изображений и наложением подизображений, между загрузкой подизображения и наложением подизображения и т. д.) препятствуют выполнению соответствующих вызовов **иамвидеоакцелератор:: бегинфраме** и [**иамвидеоакцелератор:: куерирендерстатус**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus) до последующих вызовов **IAMVideoAccelerator:: Execute**.
    -   Если Двфунктион содержит ДКСВА \_ конфигкуерйорреплифунк, то указатель лпприватеинпутдата для передачи данных в ускоритель в этом вызове указывает на структуру данных конфигурации, указатель лпприватеаутпутдата для получения информации от ускорителя, указывающий на область, где может быть размещена альтернативная или повторяющаяся структура данных конфигурации, указатель памвабуфферинфо для массива AMVABUFFERINFO должен быть **равен null**, а dwNumBuffers должен быть равен нулю. Возвращаемое значение HRESULT содержит значение S \_ ОК или s \_ false в ответ на запрос, или e \_ Fail или e \_ INVALIDARG другое обозначение ошибки HRESULT в случае серьезной проблемы при выполнении протокола (например, недопустимый параметр конфигурации). Все вызовы **иамвидеоакцелератор:: Execute** для всех применений дксва \_ конфигкуерйорреплифунк должны предшествовать всем остальным вызовам **иамвидеоакцелератор:: Execute**.
    -   Если Двфунктион содержит ДКСВА \_ енкриптпротоколфунк, то указатель лпприватеинпутдата для передачи данных в ускоритель в этом вызове должен указывать на структуру данных протокола шифрования, которая начинается с дксва \_ енкриптпротоколхеадер, указатель lpPrivateOutputData для получения сведений от сочетания клавиш должен указывать на область, в которой должны быть возвращены данные (например, сертификат) по протоколу шифрования (который начинается с DXVA \_ EncryptProtocolHeader), указатель PAMVABUFFERINFO для массива AMVABUFFERINFO должен быть **равен null**, а dwNumBuffers — равняться нулю. Возвращаемое значение HRESULT содержит S \_ ОК, если протокол шифрования работает нормально и содержит e \_ Fail или e \_ INVALIDARG или другое обозначение ошибки HRESULT в случае серьезной проблемы при выполнении протокола.
    -   Если Двфунктион не содержит ДКСВА \_ конфигкуерйорреплифунк или дксва \_ енкриптпротоколфунк, то указатель лпприватеинпутдата для передачи данных в ускоритель должен указывать на список описания буфера. Первые четыре записи в структуре списка буферных описаний для каждого буфера (Двтипеиндекс, Двбуффериндекс, Двдатаоффсет и Двдатасизе) должны быть равны значениям в структуре данных АМВАБУФФЕРИНФО для одного и того же буфера. Если Бдксва \_ Func равно "1" в двфунктион, а бпикреадбаккрекуестс — "1", указатель лпприватеаутпутдата для получения сведений от сочетания клавиш должен указывать на область постоянной памяти (например, кучу), которая должна быть заполнена данными макроблокк, передаваемых из ускорителя (такие данные не гарантированно будут представлены до тех пор, пока **иамвидеоакцелератор:: QueryRenderStatus** для записи в тот же буфер параметров изображения, \_ как описано в элементе 10 ниже). В противном случае указатель Лпприватеаутпутдата для получения сведений от сочетания клавиш должен указывать на одиночный DWORD, чтобы задать одно из следующих значений индикации (особенно полезно для сообщения об ошибках битовый поток в ВЛД операции вне узла).

        | Значение | Описание                                     |
        |-------|-------------------------------------------------|
        | 0     | Выполнение ОК.                                   |
        | 1     | Обнаружена незначительная проблема в формате данных.       |
        | 2     | Обнаружена значительная проблема в формате данных. |
        | 3     | Обнаружена серьезная проблема в формате данных.      |
        | 4     | Возникла другая серьезная проблема.               |

        

         

        Если выводится серьезная проблема, программный декодер прекращает работать с функциями, если не может быть выполнено корректирующее действие. Эти данные, возвращенные с помощью сочетания клавиш, не должны считываться узлом до тех пор, пока не завершится подготовка буфера для изображения, что можно проверить с помощью [**иамвидеоакцелератор:: куерирендерстатус**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus). Возвращаемое значение HRESULT содержит S \_ ОК, если операция интерфейса работает нормально и может возвращать e \_ Fail или e \_ INVALIDARG или другое обозначение ошибки HRESULT в случае серьезной проблемы.

7.  Буфер параметров декодирования изображения должен быть в одном из первых буферов, отправленных для декодирования каждого изображения при использовании [**иамвидеоакцелератор:: Execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute) с бдксва \_ Func, равным "1", и все буферы для декодирования изображения в битовый поток должны быть отправлены перед любыми буферами для декодирования последующих изображений. При отправке буфера команд элемента управления макроблокк необходимо отправить соответствующий буфер данных о остаточной разнице (содержащий данные для одного макроблоккс) с тем же вызовом **иамвидеоакцелератор:: Execute** .
8.  [**Иамвидеоакцелератор:: ендфраме**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) должен вызываться после отправки всех сжатых буферов, что приведет к созданию выходного содержимого в заданной несжатой поверхности (результат операций указан для Вдекодедпиктуреиндекс, Вдеблоккедпиктуреиндекс, Вблендеддестинатиониндекс или wPicResampleDestPicIndex). Целью этого вызова к **иамвидеоакцелератор:: ендфраме** является уведомление оборудования ускорителя о том, что все данные, необходимые для указанной операции, отправлены. Указатель на данные, которые будут отправлены через **иамвидеоакцелератор:: ендфраме** , указывает на одно слово вендпиктуреиндекс, содержащее индекс завершенного кадра. Этот параметр должен соответствовать значению Вбегинпиктуреиндекс, указанному в предыдущем вызове метода [**иамвидеоакцелератор:: бегинфраме**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) перед отправкой соответствующих сжатых буферов. После вызова **иамвидеоакцелератор:: ендфраме** несжатая поверхность с индексом вендпиктуреиндекс не найдена ни в Вдекодедпиктуреиндекс, Вдеблоккедпиктуреиндекс, wBlendedDestinationIndex, ни в wPicResampleDestPicIndex до тех пор, пока не будет вызван еще один вызов **IAMVideoAccelerator:: BeginFrame** , чтобы объявить о том, что это произойдет, и в \_ результате возвращается значение ОК. Однако индекс конечной поверхности может встречаться в последующих командах чтения, таких как Вфорвардрефпиктуреиндекс, Вбакквардрефпиктуреиндекс, ВпикресамплесаурцепиЦиндекс или Брефпикселект \[ i \] . Значение HRESULT, возвращаемое функцией **иамвидеоакцелератор:: ендфраме** , должно быть равно " \_ ОК", если не существует какого-либо формата данных или ошибки протокола, в этом случае может быть E \_ Fail или e \_ INVALIDARG или другое указание ошибки.
9.  В случае декодирования на основе полей (например, в MPEG-2 битстреамс) в интерфейсе ускорителя не будет однозначно сопоставлять функциональные рисунки в битовый поток с несжатыми областями. При декодировании изображений в формате MPEG-2 битовый поток будет раскодировано два рисунка для создания одного полного выходного несжатого изображения поверхности. В определении интерфейса DirectX ва каждый кадр соответствует каждому использованию Вдекодедпиктуреиндекс, Вдеблоккедпиктуреиндекс, Вблендеддестинатиониндекс или ВпикресампледестпиЦиндекс. Таким образом, две пары вызовов **иамвидеоакцелератор:: бегинфраме** и **Иамвидеоакцелератор:: ендфраме** необходимы для расшифровки рисунков полей на выходных несжатых поверхностях.
10. Вызов [**иамвидеоакцелератор:: куерирендерстатус**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus) с dwFlags равным нулю, который происходит после вызова **Иамвидеоакцелератор:: Ендфраме** с определенным вендпиктуреиндекс и проверяет состояние буфера, который был отправлен, который содержал WEndPictureIndex в WDecodedPictureIndex, WDeblockedPictureIndex, wBlendedDestinationIndex или WPicResampleDestPicIndex, возвращает значение S \_ ОК, если все операции записи данных на несжатую поверхность завершены и будут возвращать E \_ Pending, если операция еще не завершена. E \_ Fail или e \_ INVALIDARG или другие признаки ошибки могут возвращаться в случае ошибки протокола.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Сопоставление ускорения видео DirectX с Иамвидеоакцелератор](mapping-directx-video-acceleration-to-iamvideoaccelerator.md)
</dt> </dl>

 

 



