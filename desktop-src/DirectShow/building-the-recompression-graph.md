---
description: Создание Graph повторного сжатия
ms.assetid: 8f25c60e-30be-4cc4-b924-b8d6654604d3
title: Создание Graph повторного сжатия
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0432f51e5309a308b32535993fef04da1762d45f179e1ab3a6826d4c5432b02b
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118159115"
---
# <a name="building-the-recompression-graph"></a>Создание Graph повторного сжатия

Типичный граф фильтра для повторного сжатия файла AVI выглядит следующим образом:

![Граф повторного сжатия AVI](images/avi2avi4.png)

[Фильтр-разделитель AVI](avi-splitter-filter.md) извлекает данные из [фильтра источника файлов (Async)](file-source--async--filter.md) и анализирует их в видеопотоки и звуковые потоки. Программа декодирования видео декодирует сжатое видео, когда оно повторно сжимается программой сжатия видео. Выбор декомпрессоров зависит от исходного файла. он будет автоматически обрабатываться [интеллектуальным Подключение](intelligent-connect.md). Приложение должно выбрать программу сжатия, как правило, путем показа пользователю списка. (См. раздел [Выбор фильтра сжатия](choosing-a-compression-filter.md).)

После этого сжатое видео переходит в [Фильтр мультиплексора AVI](avi-mux-filter.md). Аудиопоток в этом примере не сжимается, поэтому он перемещается непосредственно из AVI-разделителя в мультиплексор AVI. Мультиплексор AVI покидает два потока, а [фильтр записи файлов](file-writer-filter.md) записывает выходные данные на диск. Обратите внимание, что требуется наличие AVI-мультиплексора, даже если у исходного файла нет звукового потока.

самый простой способ создать диаграмму фильтра — использовать [построитель Graph Capture](capture-graph-builder.md), который является DirectShowным компонентом для создания графов записи и других пользовательских графиков фильтра.

начните с вызова cocreateinstance для создания построителя Graph отслеживания:


```C++
ICaptureGraphBuilder2 *pBuild = NULL;
hr = CoCreateInstance(CLSID_CaptureGraphBuilder2, 
                        NULL, CLSCTX_INPROC_SERVER,
    IID_ICaptureGraphBuilder2, (void **)&pBuild);
```



затем используйте построитель Graph Capture для создания графа фильтра:

1.  Создайте раздел отрисовки диаграммы, включающий фильтр мультиплексора и [модуль записи файлов](file-writer-filter.md)AVI.
2.  Добавьте фильтр источника и фильтр сжатия в граф.
3.  Подключение фильтр источника к фильтру мультиплексора. Построитель диаграмм записи вставляет любые фильтры разделителя и декодера, необходимые для анализа исходного файла. Он также может маршрутизировать видео-и звуковые потоки с помощью фильтров сжатия.

В следующих разделах описывается каждый из этих шагов.

Создание раздела подготовки к просмотру

Чтобы создать раздел отрисовки графа, вызовите метод [**ICaptureGraphBuilder2:: сетаутпутфиленаме**](/windows/desktop/api/Strmif/nf-strmif-icapturegraphbuilder2-setoutputfilename) . Этот метод принимает входные параметры, которые указывают подтип носителя для выходных данных и имя выходного файла. Он возвращает указатели на фильтр МУЛЬТИПЛЕКСОРа и модуль записи файлов. Фильтр МУЛЬТИПЛЕКСОРа необходим для следующего этапа построения Graph. Для этого примера указатель на модуль записи файлов не требуется, поэтому параметр может иметь **значение NULL**:


```C++
IBaseFilter *pMux = NULL;
hr = pBuild->SetOutputFileName(
        &MEDIASUBTYPE_Avi, // File type. 
        wszOutputFile,     // File name, as a wide-character string.
        &pMux,             // Receives a pointer to the multiplexer.
        NULL);             // Receives a pointer to the file writer. 
```



Когда метод возвращает значение, фильтр МУЛЬТИПЛЕКСОРа имеет необработанный счетчик ссылок, поэтому не забудьте освободить указатель позже.

На следующей диаграмме показана диаграмма фильтра на этом этапе.

![раздел подготовки к просмотру на графе фильтра](images/avi2avi1.png)

Фильтр МУЛЬТИПЛЕКСОРа предоставляет два интерфейса для управления форматом AVI:

-   [**Интерфейс иконфигинтерлеавинг**](/windows/desktop/api/Strmif/nn-strmif-iconfiginterleaving): задает режим взаимодействия.
-   [**Интерфейс иконфигавимукс**](/windows/desktop/api/Strmif/nn-strmif-iconfigavimux): задает главный поток и Индекс совместимости AVI.

Добавление фильтров источника и сжатия

Следующим шагом является добавление фильтров источника и сжатия к графу фильтра. построитель Graph записи автоматически создает экземпляр фильтра Graph Manager при вызове сетаутпутфиленаме. Получите указатель на него, вызвав метод [**ICaptureGraphBuilder2:: жетфилтерграф**](/windows/desktop/api/Strmif/nf-strmif-icapturegraphbuilder2-getfiltergraph) :


```C++
IGraphBuilder *pGraph = NULL;
hr = pBuild->GetFiltergraph(&pGraph);
```



Теперь вызовите метод [**играфбуилдер:: аддсаурцефилтер**](/windows/desktop/api/Strmif/nf-strmif-igraphbuilder-addsourcefilter) , чтобы добавить фильтр источника асинхронного файла, и метод [**Ифилтерграф:: аддфилтер**](/windows/desktop/api/Strmif/nf-strmif-ifiltergraph-addfilter) , чтобы добавить видео компрессор:


```C++
IBaseFilter *pSrc = NULL;
hr = pGraph->AddSourceFilter(wszInputFile, L"Source Filter", &pSrc);
hr = pGraph->AddFilter(pVComp, L"Compressor");
```



На этом этапе фильтр источника и фильтр сжатия не подключены ни к чему другому в графе, как показано на следующем рисунке:

![Фильтрация графа с помощью фильтров источника и сжатия](images/avi2avi2.png)

Подключение источника в мультиплексор

Последним шагом является подключение фильтра по источнику к фильтру мультиплексора AVI через видео-компрессор. Используйте метод [**ICaptureGraphBuilder2:: RenderStream**](/windows/desktop/api/Strmif/nf-strmif-icapturegraphbuilder2-renderstream) , который подключает выходной ПИН-код к фильтру источника к указанному фильтру приемника (при необходимости с помощью фильтра сжатия).

Первые два параметра указывают, какой из ПИН-кодов фильтра источника подключается, путем назначения категории закрепления и типа носителя. Фильтр источника "асинхронный файл" имеет только один выходной ПИН-код, поэтому эти параметры должны иметь **значение NULL**. Следующие три параметра указывают фильтр источника, фильтр сжатия (если он есть) и фильтр мультиплексора.

В следующем примере кода демонстрируется визуализация видеопотока через видео-компрессор.


```C++
hr = pBuild->RenderStream(
        NULL,       // Output pin category
        NULL,       // Media type
        pSrc,       // Source filter
        pVComp,     // Compression filter
        pMux);      // Sink filter (the AVI Mux)
```



На схеме ниже показан граф фильтра на данный момент.

![Визуализированный поток видео](images/avi2avi3.png)

При условии, что исходный файл имеет звуковой поток, фильтр [разделителя AVI](avi-splitter-filter.md) создал выходной ПИН-код для аудио. Чтобы подключить этот ПИН-код, вызовите RenderStream еще раз:


```C++
hr = pBuild->RenderStream(NULL, NULL, pSrc, NULL, pMux);
```



Здесь не указан фильтр сжатия. Выходной ПИН-код фильтра источника уже подключен, поэтому метод RenderStream выполняет поиск неподключенного выходного контакта в фильтре разделителя. Он находит звуковой ПИН-код и подключает его непосредственно к фильтру МУЛЬТИПЛЕКСОРа. Если исходный файл не имеет аудиопотока, второй вызов RenderStream завершится ошибкой. Это нормальная ситуация. Граф завершается после первого вызова RenderStream, поэтому сбой второго вызова является безвредным.

В этом примере важен порядок двух вызовов RenderStream. Поскольку второй вызов не задает компрессор, он подключается к любому неподключенному ПИН-коду из разделителя AVI. Если вы сделаете этот вызов еще до другого, он может подключить видеопоток к мультиплексору в виде AVI, без сжатия видео. Поэтому сначала должен быть вызван более конкретный вызов (с фильтром сжатия).

В предыдущем обсуждении предполагается, что исходный файл является файлом AVI. Однако эта методика также работает с другими типами файлов, например с файлами MPEG. Итоговый граф фильтра будет немного отличаться.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Повторное сжатие файла AVI](recompressing-an-avi-file.md)
</dt> </dl>

 

 



