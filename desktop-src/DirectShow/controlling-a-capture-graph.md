---
description: Управление графиком записи
ms.assetid: e7afafca-e993-4096-bad4-399ee6c67fe9
title: Управление графиком записи
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6366645f14822a770b828e59b2201e378a0e1e8e
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "104537676"
---
# <a name="controlling-a-capture-graph"></a>Управление графиком записи

Интерфейс [**Имедиаконтрол**](/windows/desktop/api/Control/nn-control-imediacontrol) диспетчера графа фильтров имеет методы для запуска, остановки и приостановки всей диаграммы. Однако если граф фильтра имеет захват и предварительный просмотр потоков, то, скорее всего, потребуется управлять двумя потоками независимо друг от друга. Например, может потребоваться предварительный просмотр видео без записи. Это можно сделать с помощью метода [**ICaptureGraphBuilder2:: контролстреам**](/windows/desktop/api/Strmif/nf-strmif-icapturegraphbuilder2-controlstream) .

> [!Note]  
> Этот метод не работает при записи в файл формата ASF.

 

Управление потоком записи

Следующий код задает выполнение потока видеозаписи в течение четырех секунд, начиная с одной секунды после выполнения графа:


```C++
// Control the video capture stream. 
REFERENCE_TIME rtStart = 10000000, rtStop = 50000000;
const WORD wStartCookie = 1, wStopCookie = 2;  // Arbitrary values.
hr = pBuild->ControlStream(
    &PIN_CATEGORY_CAPTURE, // Pin category.
    &MEDIATYPE_Video,      // Media type.
    pCap,                 // Capture filter.
    &rtStart, &rtStop,     // Start and stop times.
    wStartCookie, wStopCookie  // Values for the start and stop events.
);
pControl->Run();
```



Первый параметр указывает, какой поток следует контролировать, как GUID категории ПИН-кода. Второй параметр задает тип носителя. Третий параметр — это указатель на фильтр записи. Чтобы управлять всеми потоками записи в графе, установите для второго и третьего параметров **значение NULL**.

Следующие два параметра определяют время начала и окончания работы потока относительно времени начала выполнения графа. Вызовите [**имедиаконтрол:: Run**](/windows/desktop/api/Control/nf-control-imediacontrol-run) , чтобы запустить граф. До запуска графа метод **контролстреам** не оказывает никакого влияния. Если граф уже запущен, параметры вступают в силу немедленно.

Последние два параметра используются для получения уведомлений о событиях при запуске и остановке потока. Для каждого потока, управляемого с помощью этого метода, граф фильтра отправляет пару событий: [**\_ элемент управления потоком EC \_ \_ запущен**](ec-stream-control-started.md) при запуске потока, а [**\_ Управление потоком EC \_ \_ остановлено**](ec-stream-control-stopped.md) при остановке потока. Значения **встарткукие** и **встопкукие** используются в качестве второго параметра события. Таким же *lParam2* в событии Start равно **Встарткукие**, а *lParam2* в событии «завершение» равно **встопкукие**. В следующем коде показано, как получить эти события:


```C++
while (hr = pEvent->GetEvent(&evCode, &param1, &param2, 0), SUCCEEDED(hr))
{
    switch (evCode)
    {
    case EC_STREAM_CONTROL_STARTED: 
    // param2 == wStartCookie
    break;

    case EC_STREAM_CONTROL_STOPPED: 
    // param2 == wStopCookie
    break;
    
    } 
    pEvent->FreeEventParams(evCode, param1, param2);
}
```



Метод **контролстреам** определяет некоторые специальные значения времени начала и окончания.



|             |                                        |                                    |
|-------------|----------------------------------------|------------------------------------|
|             | Запуск                                  | Stop                               |
| макслонглонг | Никогда не запускать этот поток.               | Не останавливайтесь до тех пор, пока граф не прекратит работу. |
| **NULL**    | Запустить сразу после выполнения графа. | Немедленное завершение.                  |



 

Например, следующий код немедленно останавливает поток записи:


```C++
pBuild->ControlStream(&PIN_CATEGORY_CAPTURE, &MEDIATYPE_Video, pCap,
    0, 0,     // Start and stop times.
    wStartCookie, wStopCookie); 
```



Несмотря на то, что вы можете прерывать поток записи и перезапускать его позже, это приведет к созданию разрыва в метках времени. При воспроизведении видео во время пропуска появится сообщение о зависании (в зависимости от формата файла).

Управление потоком предварительной версии

Чтобы управлять предварительной версией ПИН-кода, вызовите **контролстреам** , но Задайте первый параметр для закрепления \_ категории \_ Предварительная версия. Это работает так же, как и для \_ захвата категорий ПИН-кодов \_ , за исключением того, что нельзя использовать время ссылки для указания запуска и завершения, так как в кадрах предварительной версии отсутствуют отметки времени. Поэтому необходимо использовать **значение NULL** или макслонглонг. Чтобы запустить предварительный просмотр потока, используйте **значение NULL** :


```C++
pBuild->ControlStream(&PIN_CATEGORY_PREVIEW, &MEDIATYPE_Video, pCap,
    NULL,    // Start now.
    0,       // (Don't care.)
    wStartCookie, wStopCookie); 
```



Чтобы прерывать предварительный просмотр потока, используйте МАКСЛОНГЛОНГ.


```C++
pBuild->ControlStream(&PIN_CATEGORY_PREVIEW, &MEDIATYPE_Video, pCap,
    0,               // (Don't care.)
    MAXLONGLONG,     // Stop now.
    wStartCookie, wStopCookie); 
```



Не имеет значения, поступает ли поток просмотра из предварительной версии в фильтре записи или из фильтра Smart Tee. Метод **контролстреам** работает в любом направлении.

Однако для ПИН-портов видео метод завершится ошибкой. В этом случае другой подход заключается в скрытии окна видео. Запросите граф для **ивидеовиндов** и используйте метод [**ивидеовиндов::p UT \_ Visible**](/windows/desktop/api/Control/nf-control-ivideowindow-put_visible) , чтобы показать или скрыть окно.


```C++
// Hide the video window.
IVideoWindow *pVidWin = 0;
hr = pGraph->QueryInterface(IID_IVideoWindow, (void**)&pVidWin);
if (SUCCEEDED(hr))
{
    pVidWin->put_Visible(OAFALSE);
    pVidWin->Release();
}
```



Кроме того, при вызове [**ивидеовиндов::p UT \_ автоотображения**](/windows/desktop/api/Control/nf-control-ivideowindow-put_autoshow) со значением оафалсе перед запуском графа фильтр модуля подготовки видео скрывает окно до тех пор, пока не будет указано иное. По умолчанию модуль подготовки видео отображает окно при запуске графа.

Примечания об управлении потоком

Поведением по умолчанию для ПИН-кода является доставка образцов при выполнении графа. Например, предположим, что вы вызываете **контролстреам** с \_ захватом категории ПИН-кода, \_ но не с \_ предварительной версией категории ПИН-кода \_ . При запуске графа предварительный просмотр потока выполняется немедленно, а поток отслеживания выполняется в любое время, указанное в **контролстреам**.

Если вы захватываете несколько потоков и отправляете их в фильтр мультиплексора — например, если вы записываете аудио и видео в AVI-файл, следует одновременно управлять обоими потоками. В противном случае фильтр мультиплексора может блокировать ожидание одного потока, так как он пытается чередования двух потоков. Задайте то же время начала и окончания для всех потоков записи перед запуском графа:


```C++
pBuild->ControlStream(&PIN_CATEGORY_CAPTURE, 
    
NULL, NULL,       // All capture streams.
    &rtStart, rtStop, 
    wStartCookie, wStopCookie); 
```



На внутреннем уровне метод **контролстреам** использует интерфейс [**иамстреамконтрол**](/windows/desktop/api/Strmif/nn-strmif-iamstreamcontrol) , который предоставляется на контактах фильтра записи, интеллектуального tee Filter (при наличии) и, возможно, фильтра мультиплексора. Этот интерфейс можно использовать напрямую, вместо того чтобы вызывать **контролстреам**, хотя это и не имеет особого преимущества.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Видеозапись](video-capture.md)
</dt> </dl>

 

 



