---
description: Создание графика записи звука
ms.assetid: 2302bb40-a5db-473a-afeb-71905ac41f47
title: Создание графика записи звука
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6bd3c731a7dc498fcb7180bc56ae6a7f94dbec6d
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "105662056"
---
# <a name="creating-an-audio-capture-graph"></a>Создание графика записи звука

Первым шагом для приложения аудиозаписи является создание графа фильтра. Конфигурация графа зависит от типа файла, который требуется создать.

-   AVI-файл только для звука: фильтр записи звука для фильтра [мультиплексора AVI](avi-mux-filter.md) и фильтр AVI-мультиплексора для фильтра [записи файлов](file-writer-filter.md) .
-   WAV файл: фильтр записи звука в фильтр [Вавдест Filter](wavdest-filter-sample.md) для фильтра записи файлов
-   Файл Windows Media Audio (WMA): фильтр записи звука для фильтра [модуля записи WM ASF](wm-asf-writer-filter.md) .

Фильтр Вавдест предоставляется в виде примера пакета SDK. Чтобы использовать его, необходимо создать и зарегистрировать фильтр.

Чтобы использовать фильтр модуля записи ASF, необходимо установить Windows Media SDK и получить программный ключ для разблокировки фильтра. Дополнительные сведения см. [в разделе Использование Windows Media в DirectShow](using-windows-media-in-directshow.md).

Можно построить граф фильтра с помощью объекта [построителя графа записи](capture-graph-builder.md) или построить граф вручную. Это значит, что приложение программным образом добавляет и подключает каждый фильтр. В этой статье описывается ручной подход. Дополнительные сведения об использовании построителя графа записи см. в разделе [Capture видео](video-capture.md). Большая часть информации в этой статье относится к графикам только для звука.

Добавление устройства записи звука

Так как фильтр записи звука взаимодействует с конкретным устройством, вы не можете просто вызвать **CoCreateInstance** для создания фильтра. Вместо этого используйте [перечислитель системных устройств](system-device-enumerator.md) для перечисления всех устройств в категории "источники звукового захвата", которая определяется идентификатором класса CLSID \_ аудиоинпутдевицекатегори.

Перечислитель системных устройств возвращает список моникеров для устройств. Понятное имя каждого моникера соответствует имени устройства. Выберите одно из возвращенных моникеров и используйте его для создания экземпляра фильтра записи звука для этого устройства. Добавьте фильтр к графу фильтра. Предпочитаемое устройство записи звука отображается первым в списке моникеров. (Пользователь выбирает предпочитаемое устройство, щелкая звуки и мультимедиа в панели управления.)

Дополнительные сведения см. [в разделе Использование перечислителя системных устройств](using-the-system-device-enumerator.md).

Чтобы указать, какие входные данные нужно записать, получите интерфейс [**иамаудиоинпутмиксер**](/windows/desktop/api/Strmif/nn-strmif-iamaudioinputmixer) из фильтра записи звука и вызовите метод Where **\_ Enable** , чтобы указать входные данные. Однако одним из ограничений этого метода является то, что разные аппаратные устройства могут использовать разные строки для обнаружения входных данных. Например, одна карта может использовать "микрофон" для распознавания входных данных с микрофона, а другая плата может использовать "Mic". Чтобы определить идентификатор строки для заданного входа, используйте функции мультимедиа Windows [**вавеаутопен**](/previous-versions//dd743866(v=vs.85)), [**миксеропен**](/previous-versions//dd757308(v=vs.85))и [**миксержетлинеинфо**](/previous-versions//dd757303(v=vs.85)). Дополнительные сведения см. в разделе [запросы устройства микшера](/windows/desktop/Multimedia/mixer-device-queries) MSDN.

Добавление мультиплексора и модуля записи файлов

График записи звука должен содержать мультиплексор и модуль записи файлов.

*Мультиплексор* — это фильтр, объединяющий один или несколько потоков в один поток с определенным форматом. Например, фильтр мультиплексора AVI сочетает аудио и видеопотоки с чередованием потока AVI. Для записи звука обычно используется только один аудиопоток, но звуковые данные по-прежнему должны быть упакованы в формат, который можно сохранить на диске, что требует мультиплексора. Выбор мультиплексора зависит от целевого формата:

-   AVI: мультиплексор AVI
-   WAV: Вавдест
-   WMA: модуль записи ASF

*Модуль записи файлов* — это фильтр, записывающий входящие данные в файл. Для файлов AVI или WAV используйте [фильтр записи файлов](file-writer-filter.md). Для файлов WMA модуль записи ASF выступает в качестве мультиплексора и модуля записи файлов.

После создания фильтров и добавления их к графу Подключите выходную закрепление фильтра записи звука к входному ПИН-коду мультиплексора и подключите выходный ПИН-код мультиплексора к входному ПИН-коду модуля записи фильтра (предполагая, что они являются отдельными фильтрами). Чтобы указать имя файла, запросите средство записи файлов для интерфейса [**ифилесинкфилтер**](/windows/desktop/api/Strmif/nn-strmif-ifilesinkfilter) и вызовите метод [**Ифилесинкфилтер:: сетфиленаме**](/windows/desktop/api/Strmif/nf-strmif-ifilesinkfilter-setfilename) .

### <a name="example-code"></a>Пример кода

В следующем примере показано, как создать график записи звука с помощью фильтра Вавдест. Те же принципы применяются для других типов файлов.


```C++
IBaseFilter *pSrc = NULL, *pWaveDest = NULL, *pWriter = NULL;
IFileSinkFilter *pSink= NULL;
IGraphBuilder *pGraph;

// Create the Filter Graph Manager.
hr = CoCreateInstance(CLSID_FilterGraph, NULL, CLSCTX_INPROC_SERVER,
    IID_IGraphBuilder, (void**)&pGraph);

// This example omits error handling.

// Not shown: Use the System Device Enumerator to create the 
// audio capture filter.

// Add the audio capture filter to the filter graph. 
hr = pGraph->AddFilter(pSrc, L"Capture");

// Add the WavDest and the File Writer.
hr = AddFilterByCLSID(pGraph, CLSID_WavDest, L"WavDest", &pWaveDest);
hr = AddFilterByCLSID(pGraph, CLSID_FileWriter, L"File Writer", &pWriter);

// Set the file name.
hr = pWriter->QueryInterface(IID_IFileSinkFilter, (void**)&pSink);
hr = pSink->SetFileName(L"C:\\MyWavFile.wav", NULL);

// Connect the filters.
hr = ConnectFilters(pGraph, pSrc, pWaveDest);
hr = ConnectFilters(pGraph, pWaveDest, pWriter);

// Not shown: Release interface pointers.

```



В этом примере используется `AddFilterByCLSID` функция, описанная в разделе [Добавление фильтра по CLSID](add-a-filter-by-clsid.md), и `ConnectFilters` функция, описанная в разделе [Подключение двух фильтров](connect-two-filters.md). Ни один из них не является API DirectShow.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Запись звука](audio-capture.md)
</dt> </dl>

 

 
