---
description: После сбоя любого типа, который нарушает нормальную обработку транзакций, KTM и каждый диспетчер ресурсов должны выполнять операции восстановления. Восстановление — это процесс, с помощью которого участники транзакции прибывают к единообразному представлению каждого состояния транзакций.
ms.assetid: 5bc9a155-6ba4-41f8-8e12-e87f48d83940
title: Обработка восстановления
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ec99ad63d18c95da3ebb3ad5db6c204301d75336cc1842dd21e1edf79f5f9a38
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119146497"
---
# <a name="recovery-processing"></a>Обработка восстановления

После сбоя любого типа, который нарушает нормальную обработку транзакций, KTM и каждый диспетчер ресурсов должны выполнять операции *восстановления* . Восстановление — это процесс, с помощью которого участники транзакции прибывают к единообразному представлению состояния каждой транзакции.

Диспетчеры ресурсов могут быть *сомнительными* по отношению к результату транзакции. Это означает, что на момент сбоя они получали уведомление об уведомлении транзакции \_ \_ , было подготовлено к долговременному хранению, но не получило (или не получило, но не зарегистрировало) окончательный результат транзакции. Аналогичным образом, KTM может быть сомнительным о транзакции, если она была подготовлена, но не получила (или не получила, но не зарегистрировалась) результат. Во время восстановления все результаты, которые были отправлены, но не подтверждены, должны быть отправлены повторно. Например, если диспетчер ресурсов получил \_ \_ уведомление о фиксации транзакции и вызвал функцию [**коммиткомплете**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete) , RM может по-прежнему получать \_ \_ уведомление о фиксации повторяющихся транзакций при восстановлении.

Чтобы транзакция была правильно восстановлена после сбоя диспетчера ресурсов или системы, каждый диспетчер ресурсов должен выполнить следующие действия при каждом запуске:

1.  Вызовите функцию [**опенресаурцеманажер**](/windows/desktop/api/Ktmw32/nf-ktmw32-openresourcemanager) , чтобы повторно открыть ее обработчик Resource Manager с помощью его уникального постоянного имени. Это информирует KTM о том, что диспетчер ресурсов выполняется снова и доступен для выполнения восстановления. Если для восстановления не существует зачислений, вызов **опенресаурцеманажер** может завершиться ошибкой. Вызовите [**креатересаурцеманажер**](/windows/desktop/api/Ktmw32/nf-ktmw32-createresourcemanager) , чтобы повторно создать объект RM.
2.  Вызовите [**рековерресаурцеманажер**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverresourcemanager). Диспетчер ресурсов получит событие уведомления [**о \_ \_ восстановлении транзакции notify**](notification-mask.md) для каждого прикрепления, для которого ему требуется выполнить операции восстановления, за которым следует \_ уведомление о \_ транзакции \_ . Событие уведомления содержит глобальный уникальный идентификатор как для транзакции, так и для прикрепления.
3.  Вызовите функцию [**опененлистмент**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment) , чтобы повторно открыть каждый маркер прикрепления, для которого диспетчер ресурсов получил уведомление о \_ \_ восстановлении транзакции.
4.  Для каждого прикрепления, открытого с помощью [**опененлистмент**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment), вызовите [**рековеренлистмент**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverenlistment). Это приводит к \_ \_ \_ повторной доставке уведомления о фиксации или уведомлении транзакции \_ .
5.  Если диспетчер ресурсов получил \_ уведомление о \_ фиксации транзакции, RM может завершить транзакцию, вызвав [**коммиткомплете**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete).

    Если диспетчер ресурсов получил уведомление о неопределенном \_ \_ состоянии транзакции, диспетчер ресурсов должен дождаться прибытия уведомления о результате.

6.  Для всех транзакций, которые диспетчер ресурсов не получает уведомление о \_ \_ восстановлении транзакции, но ранее получил уведомление об \_ \_ отслеживании транзакции, диспетчер ресурсов должен обработать транзакцию так, как будто она была отменена.

> [!Note]
>
> Диспетчеры ресурсов могут прикрепляться к или создавать новые транзакции в процессе выполнения восстановления.

 

KTM использует *предполагаемую модель аварийного завершения* транзакции. Это поведение показано в следующем сценарии. Предположим, что KTM и Resource Manager существуют на одном компьютере. Предположим, что в KTM выдается уведомление о подготовке транзакции, но система завершается сбоем до того, как KTM зарегистрирует уведомление о подготовке. Далее предположим, что диспетчер ресурсов получает и записывает уведомление о подготовке непосредственно перед завершением работы системы. После восстановления системы KTM не имеет сведений о транзакции, так как она никогда не зарегистрировала этап подготовки. Диспетчер ресурсов имеет знания о транзакции, поскольку она получила, обрабатывает и зарегистрировала уведомление об подготовке. Когда KTM выдает свои уведомления о восстановлении, диспетчер ресурсов не включает уведомление о восстановлении для рассматриваемой транзакции. В случае предполагаемой модели прерывания в этом случае диспетчер ресурсов будет обрабатывать подготовленную транзакцию как прерванную, когда она не получает уведомления для выполнения восстановления в этой транзакции.

 

 



