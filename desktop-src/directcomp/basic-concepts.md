---
title: Основные понятия (DirectComposition)
description: В этом разделе приводится обзор основных понятий Microsoft DirectComposition.
ms.assetid: F442BDCA-C913-4438-BFFA-D3F28B68EE85
keywords:
- Основные понятия DirectComposition
- Основные понятия DirectComposition
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0550dc12cb0dcc5262701658d8e3883ee1ce8d82
ms.sourcegitcommit: d75fc10b9f0825bbe5ce5045c90d4045e3c53243
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2021
ms.locfileid: "126970426"
---
# <a name="basic-concepts"></a>Основные понятия

> [!NOTE]
> для приложений на Windows 10 рекомендуется использовать интерфейсы api Windows. UI. компоновки вместо DirectComposition. Дополнительные сведения см. в разделе [модернизировать The классическое приложение с использованием визуального слоя](/windows/uwp/composition/visual-layer-in-desktop-apps).

В этом разделе приводится обзор основных понятий Microsoft DirectComposition. Он содержит следующие подразделы:

-   [Композиция](#composition-target-window)
-   [Визуальные элементы](#visuals)
    -   [Визуальное дерево](#visual-tree)
    -   [Свойства визуального объекта](#properties-of-a-visual-object)
-   [Объект устройства](#device-object)
-   [Окно цели композиции](#composition-target-window)
-   [Транзакционная композиция](#transactional-composition)
    -   [Пакетная обработка в MSBuild](#batching)
    -   [Синхронизация](#synchronization)
    -   [Визуальные деревья для разных устройств](#cross-device-visual-trees)
-   [Связанные темы](#related-topics)

## <a name="composition"></a>Композиция

DirectComposition определяет *композицию* в виде коллекции точечных рисунков, которые комбинируются и обрабатываются путем применения различных преобразований, эффектов и анимации для создания визуального результата в пользовательском интерфейсе приложения. DirectComposition работает только с растровым содержимым; Он не поддерживает векторы или текст. DirectComposition не предоставляет содержимое точечного рисунка. Вместо этого он предоставляет интерфейсы, в которых пользователи могут рисовать с помощью D2D, DXGI или передать собственное содержимое текстуры.

Приложение DirectComposition создает два набора объектов для создания сцены: точечные рисунки, состоящие вместе, и визуальные элементы, определяющие пространственные связи между точечными рисунками. Дополнительные сведения об объектах Bitmap, поддерживаемых DirectComposition, см. в разделе [растровые объекты](bitmap-surfaces.md).

## <a name="visuals"></a>Визуальные элементы

*Визуальные* элементы (или *визуальные объекты*) являются фундаментальными элементами DirectComposition. Они являются основными стандартными блоками, которые используются для создания композиций и анимации в пользовательском интерфейсе приложения.

В терминах программирования визуальный элемент представляет собой объект с набором свойств и предоставляет интерфейс, который используется для задания значений свойств. Свойство содержимого визуального элемента связывает определенное растровое изображение с визуальным элементом, в то время как другие свойства управляют положением DirectComposition и обрабатывают визуальный элемент по мере его отрисовки на экране.

Дополнительные сведения см. в разделе [Свойства визуального элемента](#properties-of-a-visual-object).

### <a name="visual-tree"></a>Визуальное дерево

DirectComposition создает композицию из иерархической коллекции визуальных объектов, называемых *визуальным деревом*. Визуальный элемент в корне дерева называется *корневым визуальным* элементом и может иметь один или несколько *дочерних визуальных элементов* , связанных с ним. Дочерний визуальный элемент может иметь один или несколько дочерних визуальных элементов. Любой визуальный элемент, имеющий связанные дочерние визуальные элементы, называется *родительским визуальным* элементом, а все дочерние визуальные элементы с одним и тем же родителем называются *визуальными элементами*. Конкретный визуальный элемент вместе со всеми его дочерними и вложенными визуальными элементами называется *визуальным поддеревом*.

Расположение визуального элемента в дереве помогает определить положение экрана и z-порядок относительно других визуальных элементов в композиции. Корневой визуальный элемент располагается относительно левого верхнего угла клиентской области целевого окна, в котором отображается композиция. Все дочерние визуальные элементы располагаются относительно левого верхнего угла родительского визуального элемента (или визуального элемента, заданного свойством Трансформпарент) и всегда отображаются перед родительским элементом в z-порядке.

На следующем рисунке показана композиция визуальных элементов и структура визуального дерева, используемая для создания композиции. Visual 1 — это корневой визуальный элемент, который также является родительским для дочерних визуальных элементов 2 и 3, представляющих собой одноуровневые визуальные элементы. Visual 3 имеет два дочерних визуальных элемента, визуальные элементы 4 и 5. Все визуальные элементы с 3 по 5 составляют визуальное поддерево.

![Композиция визуальных элементов и соответствующее визуальное дерево](images/visuals-and-corresponding-tree.png)

Родительский визуальный элемент поддерживает упорядоченный список своих дочерних визуальных элементов. Когда визуальные элементы одного уровня расположены друг за другом, DirectComposition задает z-порядок одноуровневых элементов на основе порядка их появления в списке дочерних элементов родительского визуального элемента. Одноуровневый элемент, появляющийся позже в списке, помещается перед всеми одноуровневыми элементами, которые появляются ранее в списке. На следующем рисунке показан z-порядок перекрывающихся дочерних визуальных элементов.

![z-порядок пересекающихся дочерних визуальных элементов](images/overlapping-child-visuals.png)

### <a name="properties-of-a-visual-object"></a>Свойства визуального объекта

Визуальный объект предоставляет набор свойств, позволяющих задать содержимое растрового изображения для визуального элемента и управлять тем, как DirectComposition позиции и манипулирует визуальным содержимым. В следующих разделах подробно описывается каждое свойство.

-   [Свойство содержимого](#content-property)
-   [Свойство Clip](#clip-property)
-   [Бордермоде, свойство](#bordermode-property)
-   [Битмапинтерполатионмоде, свойство](#bitmapinterpolationmode-property)
-   [Компоситемоде, свойство](#compositemode-property)
-   [Свойства Оффсеткс и offset](#offsetx-and-offsety-properties)
-   [Свойство Effect](#effect-property)
-   [Transform - свойство](#transform-property)
-   [Трансформпарент, свойство](#transformparent-property)

### <a name="content-property"></a>Свойство содержимого

Свойство содержимого визуального элемента определяет содержимое растрового изображения, связанное с визуальным элементом. Это битовая карта, которую DirectComposition использует при включении визуального элемента в композицию.

Свойство содержимого визуального элемента задается путем вызова метода [**идкомпоситионвисуал:: сетконтент**](/windows/win32/api/dcomp/nf-dcomp-idcompositionvisual-setcontent) .

Дополнительные сведения о типах растрового содержимого, поддерживаемых DirectComposition, см. в разделе [растровые объекты](bitmap-surfaces.md).

### <a name="clip-property"></a>Свойство Clip

Свойство Clip визуального элемента определяет прямоугольную область, называемую вырезанной областью (или *прямоугольником* *обрезки* ). При отрисовке визуального элемента отображается только часть визуального элемента, находящаяся внутри вырезанной области, а любое содержимое, разпадающее за пределы области обрезки, обрезается (то есть не отображается). DirectComposition поддерживает отрезкие области, имеющие скругленные или квадратные углы.

Свойство Clip визуального элемента задается путем вызова метода [**идкомпоситионвисуал:: сетклип**](/windows/win32/api/dcomp/nf-dcomp-idcompositionvisual-setclip(constd2d_rect_f_)) .

Дополнительные сведения см. в разделе [Обрезка](clipping.md).

### <a name="bordermode-property"></a>Бордермоде, свойство

Свойство Бордермоде указывает, как составлять границы точечных рисунков и клипов, связанных с этим визуальным элементом, или с визуальными элементами в поддереве, корнем которого является этот визуальный элемент.

Режим границы влияет на то, как края растрового изображения формируются при преобразовании растрового изображения таким способом, чтобы границы не совпадали с целыми координатами. Он также влияет на то, как содержимое обрезается по углам клипа, имеющего скругленные углы, и на границе зажима, преобразованной таким способом, что границы не вычисляются с помощью целых координат.

Дополнительные сведения см. в разделе [**идкомпоситионвисуал:: сетбордермоде**](/windows/win32/api/dcomp/nf-dcomp-idcompositionvisual-setbordermode).

### <a name="bitmapinterpolationmode-property"></a>Битмапинтерполатионмоде, свойство

Свойство Битмапинтерполатионмоде указывает DirectComposition, как создать точечный рисунок, когда он преобразуется таким образом, что между пикселями в точечном рисунке и пикселями экрана нет соответствия «один к одному».

Чтобы задать свойство Битмапинтерполатионмоде визуального элемента, вызовите метод [**идкомпоситионвисуал:: сетбитмапинтерполатионмоде**](/windows/win32/api/dcomp/nf-dcomp-idcompositionvisual-setbitmapinterpolationmode) .

### <a name="compositemode-property"></a>Компоситемоде, свойство

Свойство Компоситемоде указывает DirectComposition, как смешивать растровое содержимое визуального элемента с помощью целевого объекта рендеринга. Описание поддерживаемых составных режимов см. в разделе [**дкомпоситион \_ составной \_ режим**](/windows/desktop/api/DcompTypes/ne-dcomptypes-dcomposition_composite_mode).

Чтобы задать свойство Компоситемоде визуального элемента, вызовите метод [**идкомпоситионвисуал:: сеткомпоситемоде**](/windows/win32/api/dcomp/nf-dcomp-idcompositionvisual-setcompositemode) .

### <a name="offsetx-and-offsety-properties"></a>Свойства Оффсеткс и offset

Свойства Оффсеткс и offset указывают DirectComposition, где должен размещаться визуальный элемент по горизонтали и вертикали. Они определяют двухмерную фиксированную позицией, из которой рассчитываются все преобразования и эффекты для визуального элемента.

Для корневого визуального элемента свойства Оффсеткс и Offset определяют координату x и координату y точки относительно верхнего левого угла окна, в котором размещается визуальный элемент. Для дочернего визуального элемента координаты задаются относительно левого верхнего угла родителя или, если [свойство трансформпарент](#transformparent-property) задано, верхний левый угол указанного визуального элемента. При отрисовке визуального элемента он позиционируется таким, что верхний левый угол отображается в соответствии с заданными координатами.

Чтобы задать свойства Оффсеткс и offset визуального элемента, вызовите методы [**идкомпоситионвисуал:: сетоффсеткс**](/previous-versions/windows/desktop/legacy/hh449126(v=vs.85)) и [**сетоффсети**](/previous-versions/windows/desktop/legacy/hh449131(v=vs.85)) .

### <a name="effect-property"></a>Свойство Effect

Свойство Effect позволяет указать эффект или группу эффектов, которые изменяют, как будет состоять визуальный элемент и его поддерево. Например, можно указать эффекты, управляющие прозрачностью визуального элемента, смешать визуальный элемент с другим точечным рисунком различными способами, а также применить преобразования перспективы к визуализации.

Чтобы задать свойство Effect визуального элемента, вызовите метод [**идкомпоситионвисуал:: сетеффект**](/windows/win32/api/dcomp/nf-dcomp-idcompositionvisual-seteffect) .

Дополнительные сведения см. в статье [Эффекты](effects.md).

### <a name="transform-property"></a>Transform - свойство

Свойство Transform задает двухмерный (2D) преобразование или группу двумерных преобразований для DirectComposition, выполняемых в визуальном элементе. Преобразование (или преобразование) — это операция, которая изменяет систему координат визуального элемента относительно ее родителя или относительно визуального элемента, заданного [свойством трансформпарент](#transformparent-property). С помощью преобразований можно изменить положение, размер или природу визуального элемента, переместив его в другое место (перевод), сделав его больше или меньше (масштабирование), отключив его (вращение), искажение фигуры (наклон) и т. д.

Свойство Transform визуального элемента задается путем вызова метода [**идкомпоситионвисуал:: сеттрансформ**](/previous-versions/windows/desktop/legacy/hh449178(v=vs.85)) .

Дополнительные сведения см. в статье [Преобразования](transforms.md).

### <a name="transformparent-property"></a>Трансформпарент, свойство

Система координат визуального элемента изменяется свойствами Оффсеткс, offset и Transform. Как правило, эти свойства определяют систему координат визуального элемента относительно непосредственного родителя. Чтобы использовать какой-либо визуальный элемент, отличный от родительского, в качестве основания для системы координат дочернего визуального элемента, используйте свойство Трансформпарент, чтобы указать другой визуальный элемент в качестве родительского для преобразования.

Чтобы задать свойство Трансформпарент визуального элемента, вызовите метод [**идкомпоситионвисуал:: сеттрансформпарент**](/windows/win32/api/dcomp/nf-dcomp-idcompositionvisual-settransformparent) .

## <a name="device-object"></a>Объект устройства

Чтобы использовать DirectComposition, необходимо создать различные объекты модели COM и управлять ими. Первым объектом, который необходимо создать, является *объект устройства* DirectComposition, так как он служит фабрикой для создания всех других объектов, используемых в составе.

Объект устройства создается путем вызова функции [**дкомпоситионкреатедевице**](/windows/desktop/api/Dcomp/nf-dcomp-dcompositioncreatedevice) , которая возвращает указатель на интерфейс [**идкомпоситиондевице**](/windows/win32/api/dcomp/nn-dcomp-idcompositiondevice) . Этот интерфейс предоставляет набор методов, используемых для создания визуальных объектов, объектов Clip, объектов анимации, объектов Transform, объектов эффектов и т. д.

Объект устройства служит еще одной целью, помимо фабрики для создания других объектов. Он предоставляет метод, именуемый [**commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) , который передает визуальное дерево в DirectComposition для обработки. Дополнительные сведения см. в разделе [транзакционная композиция](#transactional-composition).

Помните, что, несмотря на то, что в приложении можно создать несколько экземпляров объекта устройства, все объекты, используемые в определенной композиции, должны создаваться одним и тем же объектом устройства — за одним исключением можно объединять визуальные объекты из различных объектов устройств в одном визуальном дереве. После этого DirectComposition считает визуальное дерево обычным, за исключением того, что изменения в конкретном визуальном объекте в дереве вступают в силу только при вызове метода [**commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) для объекта устройства, создавшего визуальный объект.

Возможность использования визуальных элементов из различных устройств в одном визуальном дереве позволяет нескольким потокам создавать и манипулировать одним визуальным деревом, одновременно сохраняя два независимых устройства, которые можно использовать для асинхронной фиксации изменений. Дополнительные сведения см. в разделе [визуальные деревья для разных устройств](#cross-device-visual-trees).

## <a name="composition-target-window"></a>Окно цели композиции

Визуальное дерево должно быть привязано к окну, прежде чем можно будет отобразить на экране все визуальные элементы дерева. Окно, называемое *окном цели композиции*, может быть окном верхнего уровня или дочерним окном. Кроме того, окно цели композиции может быть слоеным окном. то есть, он может иметь стиль окна с [**\_ \_ слоем WS ex**](/windows/desktop/winmsg/extended-window-styles) .

DirectComposition позволяет приложению привязать к каждому окну не более двух визуальных деревьев. Визуальные деревья включают в себя одно, которое состоит поверх самого окна, но позади всех дочерних окон окна, а другое — в верхней части окна и поверх дочерних окон. Иными словами, каждое окно имеет четыре концептуальных слоя, и все слои обрезаются до видимой области целевого окна. На следующем рисунке показаны четыре концептуальных слоя окна.

![концептуальные слои окна](images/directcomposition-layers.png)

## <a name="transactional-composition"></a>Транзакционная композиция

DirectComposition использует модель транзакций, в которой создается пакетный набор изменений для визуального элемента, а затем зафиксируется значение DirectComposition для обработки всех элементов одновременно. Вы можете изменить тот же визуальный объект DirectComposition и зафиксировать изменения любое количество раз. Когда диспетчер окон рабочего стола (DWM) берет пакеты, он выбирает все ожидающие пакеты и применяет их к следующему кадру в том порядке, в котором они были зафиксированы.

Все изменения в одной фиксации гарантированно применяются к одному кадру. Так как DWM собирает пакеты по одному разу на кадр, можно изменить любой конкретный объект только один раз для каждого кадра. Последующие фиксации, которые изменяют различные объекты, могут также применяться к текущему кадру, но DirectComposition не гарантирует, что изменения будут происходить в одном кадре.

Методы [**идкомпоситионсурфаце:: бегиндрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-begindraw) и [**Идкомпоситионсурфаце:: EndDraw**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-enddraw) позволяют синхронизировать обновления отрисовки с визуальными обновлениями. Например, можно вызвать **идкомпоситионсурфаце:: бегиндрав**, обновить свойства Оффсеткс и Clip визуального элемента, вызвать [**Идкомпоситиондевице:: Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit), нарисовать содержимое с помощью Microsoft DirectX, а затем вызвать **идкомпоситионсурфаце:: EndDraw**. В этом случае Microsoft DirectComposition гарантирует, что содержимое растрового изображения и свойства визуальных элементов будут обновляться одновременно.

### <a name="batching"></a>Пакетная обработка

Можно зафиксировать несколько изменений одного и того же визуального элемента или внести несколько изменений в различные визуальные элементы в пределах одного кадра. При внесении нескольких изменений в один и тот же визуальный элемент в одном и том же фрейме учитывайте следующие моменты:

-   При внесении нескольких изменений в одно и то же свойство визуального элемента применяется только Последнее изменение. Например, если для параметра Opacity задано значение 0, то в 0,5 и, наконец, в 1,0, к визуальному элементу применяется только непрозрачность 1,0.
-   При изменении нескольких свойств одного и того же визуального элемента DirectComposition применяет изменения сначала к визуальному элементу, а затем к любым дочерним визуальным элементами. Свойства применяются в следующем порядке независимо от порядка их указания:

    1.  Offset
    2.  Преобразование
    3.  Отсечение
    4.  Действие

    На следующем рисунке показан результат применения всех четырех свойств к визуальному элементу.

    ![результат применения всех четырех свойств к визуальному элементу](images/order-of-properties.png)

    Помните, что все изменения применяются к визуальному элементу одновременно в контексте того же кадра. Это означает, что с точки зрения пользователя изменения визуального элемента происходят мгновенно.

-   Для свойства Transform можно использовать [**идкомпоситиондевице:: креатетрансформграуп**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-createtransformgroup) , чтобы создать группу преобразований, которые будут применяться ко всему визуальному элементу. DirectComposition применяет преобразования в указанном порядке.
-   Для свойства Effect можно использовать [**идкомпоситионеффектграуп**](/windows/win32/api/dcomp/nn-dcomp-idcompositioneffectgroup) , чтобы применить группу эффектов. DirectComposition применяет эффекты в указанном порядке. Кроме того, преобразование «Трехмерная перспектива» приводит к преобразованию визуального дерева после применения всех трехмерных преобразований в текущем визуальном элементе. Это гарантирует, что полученный визуальный элемент будет выглядеть как можно ближе к объемному.

### <a name="synchronization"></a>Синхронизация

Приложение может вызывать DirectComposition из нескольких потоков одновременно. Порядок выполнения гарантируется для последовательных вызовов, но не для одновременных вызовов. Например, если поток A изменяет визуальный элемент и поток б фиксирует пакет одновременно, он не определяет, включено ли визуальное изменение в зафиксированный пакет или начинает новый пакет. С другой стороны, если приложение использует другие механизмы синхронизации, чтобы убедиться, что один метод вызывается раньше другого, DirectComposition учитывает порядок вызова и обрабатывает их, как если бы оба вызова были выданы в таком порядке из одного потока.

### <a name="cross-device-visual-trees"></a>Визуальные деревья для разных устройств

Объекты DirectComposition не привязаны к потоку; для изменения одного и того же набора объектов можно использовать несколько потоков. Однако при совместном использовании одного объекта устройства учитывайте следующие моменты.

-   Оба потока должны иметь возможность вызова [**идкомпоситиондевице:: Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit). Если только один из потоков вызывает **идкомпоситиондевице:: Commit**, другой поток не может зафиксировать свои изменения в DirectComposition.
-   Транзакционное поведение может быть потеряно, если один поток вызывает [**идкомпоситиондевице:: Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) , а другой поток все еще выполняет изменения, которые должны быть частью одной транзакции.

Если необходимо зафиксировать несколько одновременных транзакций в DirectComposition, необходимо использовать несколько объектов устройств, возможно, из нескольких потоков. В этом сценарии одно и то же визуальное дерево совместно используется объектами обоих устройств, и каждый объект устройства фиксирует свои собственные транзакции.

На следующем рисунке показано визуальное дерево, совместно используемое двумя объектами устройства. Визуальные элементы 1, 2, 4 и 5 принадлежат одному устройству или другому, но Visual 3 совместно используется обоими устройствами и поэтому может использоваться для соединения двух поддеревьев в одном, более крупном визуальном дереве. Совместное использование визуального дерева позволяет асинхронно манипулировать двумя устройствами из двух разных потоков.

![визуальное дерево, совместно используемое двумя устройствами](images/shared-visual-tree-1.png)

Чтобы продемонстрировать полезность совместного использования визуального дерева между двумя устройствами, рассмотрим архитектуру, обеспечивающую сенсорный ввод с низкой задержкой. Архитектура может использовать два потока, один из которых обрабатывает большинство задач пользовательского интерфейса, и второй поток, предназначенный для обработки событий сенсорного ввода. Сенсорный поток обновляет преобразование конкретного визуального элемента на основе пользовательского жеста ввода. При обновлении преобразования поток касания может сделать все поддерево в рамках этого визуального элемента проследить за пальцем пользователя, увеличить или уменьшить масштаб по мере выполнения пользователем жеста с несколькими касаниями и т. д. Поток пользовательского интерфейса удерживает владение большей частью дерева композиции, при этом поток касания владеет только одними визуальными элементами, помеченными для асинхронного ответа на сенсорный экран. На следующем рисунке показана упрощенная версия такого дерева компоновки:

![визуальное дерево, совместно используемое в потоке пользовательского интерфейса и сенсорном потоке](images/shared-visual-tree-2.png)

Как правило, поток пользовательского интерфейса изменяет только те визуальные элементы, которые он владеет исключительно, а сенсорный поток изменяет только общий визуальный элемент. Единственное исключение возникает при создании или удалении поддерева с поддержкой сенсорного ввода.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[**Идкомпоситионсурфаце:: Бегиндрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-begindraw)
</dt> <dt>

[**Идкомпоситионсурфаце:: EndDraw**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-enddraw)
</dt> <dt>

[**Идкомпоситондевице:: Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit)
</dt> <dt>

[Основные понятия DirectComposition](directcomposition-concepts.md)
</dt> </dl>

 

 