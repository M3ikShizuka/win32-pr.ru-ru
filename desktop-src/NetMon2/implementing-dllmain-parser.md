---
description: Сетевой монитор использует функцию экспорта DllMain для определения существования средства синтаксического анализа и освобождения ресурсов, которые сетевой монитор использует для хранения сведений о средстве синтаксического анализа.
ms.assetid: 1741a12c-3645-4e83-b97f-37e67218c5eb
title: Реализация средства синтаксического анализа DllMain
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 55dd1ab7432920ac7496643c7c6f9aa0692daf56
ms.sourcegitcommit: d75fc10b9f0825bbe5ce5045c90d4045e3c53243
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2021
ms.locfileid: "127057292"
---
# <a name="implementing-dllmain-parser"></a>Реализация средства синтаксического анализа DllMain

Сетевой монитор использует функцию экспорта **DllMain** для определения существования средства синтаксического анализа и освобождения ресурсов, которые сетевой монитор использует для хранения сведений о средстве синтаксического анализа.

Когда сетевой монитор вызывает функцию **DllMain** в первый раз, Библиотека DLL средства синтаксического анализа вызывает [**креатепротокол**](createprotocol.md) для выполнения следующих действий:

-   Укажите протокол, который обнаруживает анализатор.
-   Укажите точки входа для оставшихся функций экспорта средства синтаксического анализа, которые сетевой монитор вызовы.

Когда сетевой монитор вызывает **DllMain** в последний раз, функция **DllMain** вызывает [**дестройпротокол**](destroyprotocol.md) , чтобы освободить все ресурсы, которые сетевой монитор использует для хранения сведений о средстве синтаксического анализа.

Следующая процедура определяет шаги, необходимые для реализации функции **DllMain**.

**Реализация функции DllMain**

1.  Укажите структуру [**EntryPoint**](entrypoints.md) для функции [**креатепротокол**](createprotocol.md) и переменной глобальной присоединения. Переменная Attach используется для наблюдения за количеством выполняемых экземпляров протокола.
2.  Проверьте значение параметра *команды* , который устанавливает операционная система.

    Если параметру *команды* присвоено значение DLL \_ Process \_ Attach и Attach равно 0, то вызовите [**креатепротокол**](createprotocol.md) , чтобы указать имя протокола и точки входа для следующих функций экспорта.

    -   **Зарегистрировать**
    -   **Отмена регистрации**
    -   **рекогнизефраме**
    -   **аттачпропертиес**
    -   **Форматпропертиес** (требуется только в том случае, если в сетевой монитор будут отображаться свойства протокола).

    Если параметру *команды* присвоено значение \_ DLL \_ отсоединение процесса и присоединение равно 0, то вызовите [**дестройпротокол**](destroyprotocol.md) , используя экземпляр, который [**креатепротокол**](createprotocol.md) возвращает.

3.  Возвращает **значение true** , поскольку функция синтаксического анализа **DllMain** должна всегда возвращать **значение true**.

Ниже приведена базовая реализация **DllMain**. В примере кода используется оператор Case для перехвата значений параметра *Command* , чтобы определить, следует ли вызывать [**креатепротокол**](createprotocol.md) или [**дестройпротокол**](destroyprotocol.md) .

``` syntax
#include <windows.h>

// Entry point structure for parser export functions and global
// Attach variable.
ENTRYPOINTS EntryPoints =
{
  Register,
  Deregister,
  RecognizeFrame,
  AttachProperties,
  FormatProperties
};

DWORD Attached = 0; 

BOOL WINAPI DllMain(HANDLE hInstance, ULONG Command, LPVOID Reserved)
{
  switch(Command)
  {
  // Call CreateProtocol.
  case DLL_PROCESS_ATTACH:
       // Loading parser DLL.
       if(Attached == 0)
       {
         hProtocol = CreateProtocol( "ProtocolName",
                                     &EntryPoints,
                                     ENTRYPOINTS_SIZE);
       }
       Attached++;
       break;
  // Call DestroyProtocol.
  case DLL_PROCESS_DETACH:
       // Unloading parser DLL.
       Attached--;
       if(Attached == 0)
       {
         DestroyProtocol( hProtocol);
       }
       break;
  }
  return TRUE;
}
```

 

 



