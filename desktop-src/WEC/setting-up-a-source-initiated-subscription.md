---
title: Настройка исходной подписки, инициированной источником
description: Подписки, инициированные источником, позволяют определить подписку на компьютере сборщика событий, не определяя исходные компьютеры событий, а затем можно настроить несколько удаленных компьютеров источника событий (с помощью параметра групповой политики) для перенаправления событий на компьютер сборщика событий.
ms.assetid: c02b5075-d685-44cf-937f-a1edfd2550ca
ms.tgt_platform: multiple
ms.topic: article
ms.date: 12/17/2018
ms.openlocfilehash: f9d0ade037c0332f390bbea4c9f126f78f4172879fc50465fcf9e329e89fa23d
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119620654"
---
# <a name="setting-up-a-source-initiated-subscription"></a>Настройка исходной подписки, инициированной источником

Подписки, инициированные источником, позволяют определить подписку на компьютере сборщика событий, не определяя исходные компьютеры событий, а затем можно настроить несколько удаленных компьютеров источника событий (с помощью параметра групповой политики) для перенаправления событий на компьютер сборщика событий. Это отличается от подписки, инициированной сборщиком, так как в модели подписки, инициированной сборщиком, сборщик событий должен определить все источники событий в подписке на события.

При настройке подписки, инициированной источником, определите, находятся ли компьютеры-источники событий в том же домене, что и компьютер сборщика событий. В следующих разделах описаны действия, которые необходимо выполнить, когда источники событий находятся в одном домене или не находятся в том же домене, что и компьютер сборщика событий.

> [!Note]  
> Любой компьютер в домене, локальный или удаленный, может быть сборщиком событий. Однако при выборе сборщика событий важно выбрать компьютер, топологически близко к месту, где будет создано большинство событий. Отправка событий на компьютер в удаленном сетевом расположении в глобальной сети может снизить общую производительность и эффективность сбора событий.

## <a name="setting-up-a-source-initiated-subscription-where-the-event-sources-are-in-the-same-domain-as-the-event-collector-computer"></a>Настройка инициированной источником подписки, в которой источники событий находятся в том же домене, что и компьютер сборщика событий

Как компьютеры источника событий, так и компьютер сборщика событий должны быть настроены для настройки подписки, инициированной источником.

> [!Note]  
> в этих инструкциях предполагается, что у вас есть доступ администратора к контроллеру домена Windows Server, обслуживающему домен, в котором будет настроено получение событий на удаленном компьютере или компьютерах.

### <a name="configuring-the-event-source-computer"></a>Настройка компьютера источника событий

1. выполните следующую команду в командной строке с повышенными привилегиями на контроллере домена Windows Server, чтобы настроить служба удаленного управления Windows:

    **WinRM QCS-q**

2. Запустите групповую политику, выполнив следующую команду:

    **% SYSTEMROOT% \\ system32 \\ gpedit. msc**

3. в узле **конфигурация компьютера** разверните узел **административные шаблоны** , разверните узел **Windows компоненты** , а затем выберите узел **пересылка событий** .

4. Щелкните правой кнопкой мыши параметр **SubscriptionManager** и выберите пункт **свойства**. Включите параметр **SubscriptionManager** и нажмите кнопку " **Показывать** ", чтобы добавить адрес сервера в параметр. Добавьте хотя бы один параметр, указывающий компьютер сборщика событий. Окно **Свойства SubscriptionManager** содержит вкладку **Объяснение** , описывающую синтаксис параметра.

5. После добавления параметра **SubscriptionManager** выполните следующую команду, чтобы убедиться, что политика применена:

    **gpupdate /force**

### <a name="configuring-the-event-collector-computer"></a>Настройка компьютера сборщика событий

1. выполните следующую команду в командной строке с повышенными привилегиями на контроллере домена Windows Server, чтобы настроить служба удаленного управления Windows:

    **WinRM QCS-q**

2. Выполните следующую команду, чтобы настроить службу сборщика событий:

    **wecutil QC/q**

3. Создайте исходную подписку. Это можно сделать программно, с помощью Просмотр событий или с помощью [**Wecutil.exe**](wecutil.md). Дополнительные сведения о создании подписки программным путем см. в примере кода в статье [Создание инициированной источником подписки](creating-a-source-initiated-subscription.md). При использовании Wecutil.exe необходимо создать XML-файл подписки на события и использовать следующую команду:

    **wecutil cs** *configurationFile.xml*

    Следующий код XML является примером содержимого файла конфигурации подписки, который создает подписку, инициированную источником, для перенаправления событий из журнала событий приложений удаленного компьютера в журнал ForwardedEvents на компьютере сборщика событий.

    ```XML
    <Subscription xmlns="http://schemas.microsoft.com/2006/03/windows/events/subscription">
        <SubscriptionId>SampleSISubscription</SubscriptionId>
        <SubscriptionType>SourceInitiated</SubscriptionType>
        <Description>Source Initiated Subscription Sample</Description>
        <Enabled>true</Enabled>
        <Uri>http://schemas.microsoft.com/wbem/wsman/1/windows/EventLog</Uri>

        <!-- Use Normal (default), Custom, MinLatency, MinBandwidth -->
        <ConfigurationMode>Custom</ConfigurationMode>

        <Delivery Mode="Push">
            <Batching>
                <MaxItems>1</MaxItems>
                <MaxLatencyTime>1000</MaxLatencyTime>
            </Batching>
            <PushSettings>
                <Heartbeat Interval="60000"/>
            </PushSettings>
        </Delivery>

        <Expires>2018-01-01T00:00:00.000Z</Expires>

        <Query>
            <![CDATA[
                <QueryList>
                    <Query Path="Application">
                        <Select>Event[System/EventID='999']</Select>
                    </Query>
                </QueryList>
            ]]>
        </Query>

        <ReadExistingEvents>true</ReadExistingEvents>
        <TransportName>http</TransportName>
        <ContentFormat>RenderedText</ContentFormat>
        <Locale Language="en-US"/>
        <LogFile>ForwardedEvents</LogFile>
        <AllowedSourceNonDomainComputers></AllowedSourceNonDomainComputers>
        <AllowedSourceDomainComputers>O:NSG:NSD:(A;;GA;;;DC)(A;;GA;;;NS)</AllowedSourceDomainComputers>
    </Subscription>
    ```

    > [!Note]  
    > При создании исходной инициированной подписки, если Алловедсаурцедомаинкомпутерс, Алловедсаурценондомаинкомпутерс/Иссуеркалист, Алловедсубжектлист и DeniedSubjectList все пусты, то "O:NSG: NSD: (A;; GA;;;D C) (A;; Общедоступный;;; NS) "будет использоваться в качестве дескриптора безопасности по умолчанию для Алловедсаурцедомаинкомпутерс. Дескриптор по умолчанию предоставляет членам группы домена Доменные компьютеры, а также группу локальных сетевых служб (для локального сервера пересылки) возможность создавать события для этой подписки.

### <a name="to-validate-that-the-subscription-works-correctly"></a>Проверка правильности работы подписки

1. На компьютере сборщика событий выполните следующие действия.

    1. выполните следующую команду в командной строке с повышенными привилегиями на контроллере домена Windows Server, чтобы получить состояние выполнения подписки:

        **wecutil GR** *&lt; subscriptionID &gt;*

    2. Убедитесь, что источник событий подключен. Возможно, потребуется подождать, пока интервал обновления, указанный в политике, не пойдет после создания подписки для подключения к источнику событий.
    3. Выполните следующую команду, чтобы получить сведения о подписке:

        **wecutil GS** *&lt; subscriptionID &gt;*

    4. Получите значение Деливеримакситемс из сведений о подписке.

2. На компьютере источника событий создайте события, которые соответствуют запросу, из подписки на события. Деливеримакситемс число событий должно быть сгенерировано для перенаправляемых событий.
3. На компьютере сборщика событий проверьте, что события были перенаправлены в журнал ForwardedEvents или в журнал, указанный в подписке.

## <a name="forwarding-the-security-log"></a>Пересылка журнала безопасности

Чтобы можно было перенаправить журнал безопасности, необходимо добавить учетную запись сетевой службы в группу читателей EventLog.

## <a name="setting-up-a-source-initiated-subscription-where-the-event-sources-are-not-in-the-same-domain-as-the-event-collector-computer"></a>Настройка исходной подписки, в которой источники событий находятся не в том же домене, что и компьютер сборщика событий

> [!Note]  
> в этих инструкциях предполагается, что у вас есть доступ администратора к контроллеру домена Windows Server. в этом случае, поскольку компьютер или компьютеры сборщика удаленных событий не находятся в домене, обслуживаемом контроллером домена, важно запустить отдельный клиент, установив для служба удаленного управления Windows значение "автоматически" с помощью служб (services. msc). Кроме того, можно выполнить команду "winrm quickconfig" на каждом удаленном клиенте.

Перед созданием подписки должны быть выполнены следующие предварительные условия.

1. на компьютере сборщика событий выполните следующие команды из командной строки с повышенными привилегиями, чтобы настроить служба удаленного управления Windows и службу сборщика событий.

    **WinRM QCS-q**

    **wecutil QC/q**

2. Компьютер сборщика должен иметь сертификат проверки подлинности сервера (сертификат с целью проверки подлинности сервера) в хранилище сертификатов локального компьютера.
3. на компьютере источника событий выполните следующую команду, чтобы настроить служба удаленного управления Windows:

    **WinRM QCS-q**

4. На исходном компьютере должен быть сертификат проверки подлинности клиента (сертификат с целью проверки подлинности клиента) в хранилище сертификатов локального компьютера.
5. Порт 5986 открыт на компьютере сборщика событий. Чтобы открыть этот порт, выполните следующую команду:

    **netsh firewall Add открытие портов TCP 5986 "WinRM HTTPS Remote Management"**

### <a name="certificates-requirements"></a>Требования к сертификатам

- Сертификат проверки подлинности сервера должен быть установлен на компьютере сборщика событий в личном хранилище локального компьютера. Субъект этого сертификата должен соответствовать полному доменному имени сборщика.
- Сертификат проверки подлинности клиента должен быть установлен на компьютерах-источниках событий в личном хранилище локального компьютера. Субъект этого сертификата должен соответствовать полному доменному имени компьютера.
- Если сертификат клиента выдан другим центром сертификации, чем один из сборщиков событий, то эти корневые и промежуточные сертификаты необходимо установить и в сборщике событий.
- если сертификат клиента был выдан промежуточным центром сертификации, а сборщик выполняется Windows 2012 или более поздней версии, необходимо настроить следующий раздел реестра:

    **HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\Schannel\ClientAuthTrustMode (DWORD) = 2**
 
- Убедитесь, что сервер и клиент могут успешно проверить состояние отзыва для всех сертификатов. Использование команды **certutil** может помочь в устранении любых ошибок.

Дополнительные сведения см. в этой статье: https://technet.microsoft.com/library/dn786429(v=ws.11).aspx

### <a name="setup-the-listener-on-the-event-collector"></a>Настройка прослушивателя в сборщике событий

1. Настройте проверку подлинности на сертификате с помощью следующей команды:

    **WinRM set winrm/config/Service/auth @ {Certificate = "true"}**

2. На компьютере сборщика событий должен существовать прослушиватель HTTPS для WinRM с бегунком сертификата проверки подлинности сервера. Это можно проверить с помощью следующей команды:

    **WinRM e/config/Listener**

3. Если прослушиватель HTTPS не отображается или отпечаток прослушивателя HTTPS не совпадает с бегунком печати сертификата проверки подлинности сервера на компьютере сборщика, можно удалить этот прослушиватель и создать новый с правильной печатью Thumb. Чтобы удалить прослушиватель HTTPS, используйте следующую команду:

    **WinRM удалить WinRM/config/Listener? Адрес = * + транспорт = HTTPS**

    Чтобы создать новый прослушиватель, используйте следующую команду:

    **WinRM создать WinRM/config/Listener? Адрес =&#42;+ Transport = HTTPS @ {имя_узла = "** &lt; _полное доменное имя сборщика_ &gt; **"; CertificateThumbprint = "** &lt; _бегунка сертификата проверки подлинности сервера_ &gt; **"}**

### <a name="configure-certificate-mapping-on-the-event-collector"></a>Настройка сопоставления сертификатов в сборщике событий

1. Создайте нового локального пользователя и добавьте его в локальную группу администраторов.
2. Создайте сопоставление сертификата с помощью сертификата, который имеется в "доверенных корневых центрах сертификации" или "промежуточных центрах сертификации".

    Это сертификат корневого или промежуточного ЦС, который выдал сертификаты, установленные на компьютерах-источниках событий *(чтобы избежать путаницы, это центр сертификации, находящийся непосредственно над сертификатом в цепочке сертификатов)*:

    **WinRM Create WinRM/config/Service/certmapping?** = &lt; _Отпечаток издателя выдающего сертификата ЦС_ &gt; **+ subject =&#42;+ URI =&#42; @ {имя_пользователя = "** &lt; _username_ &gt; **"; Password = "** &lt; _пароль_ &gt; **"} — удаленный: localhost**

3. В клиенте проверьте прослушиватель и сопоставление сертификата с помощью следующей команды:

    **WinRM g WinRM/config-р:хттпс://** &lt; _Полное доменное имя_ &gt; сборщика событий **: 5986-а:цертификате-Certificate: "** &lt; _Отпечаток сертификата_ &gt; проверки подлинности клиента **"**

    Это должно вернуть конфигурацию WinRM сборщика событий. **Не перейдем за** этот шаг, если конфигурация не отображается.

    **Что происходит на этом этапе?**
    - Клиент подключается к сборщику событий и отправляет указанный сертификат.
    - Сборщик событий ищет выдающий ЦС и проверяет, соответствует ли он сопоставлению сертификата.
    - Сборщик событий проверяет цепочку сертификатов клиента и состояние отзыва
    - Если описанные выше действия выполнены успешно, проверка подлинности завершается.

> [!NOTE]
> Может возникнуть ошибка отказа в доступе, посвященная методу проверки подлинности, что может привести к неверному получению. Чтобы устранить неполадки, проверьте журнал CAPI в сборщике событий.

4. Перечислите настроенные записи certmapping с помощью команды **WinRM enum WinRM/config/Service/certmapping** .

### <a name="event-source-computer-configuration"></a>Конфигурация компьютера источника событий

1. Войдите в систему с учетной записью администратора и откройте редактор локальных групповых политик (gpedit. msc).
2. перейдите к локальному компьютеру полици\компутер \ административные шаблоны \ Windows компонентс\евент пересылка.
3. Откройте "Настройка адреса сервера, интервала обновления и центра сертификации поставщика для целевой версии диспетчера подписки".
4. Включите политику и щелкните SubscriptionManagers "показывать...". переключатель.
5. В окне SubscriptionManagers введите следующую строку:

    **Сервер = HTTPS://** &lt; _Полное доменное имя сервера_ &gt; сборщика событий **: 5986/WSMan/SubscriptionManager/WEC, обновление =** &lt; _Интервал обновления в секундах_ &gt; **, Иссуерка =** &lt; _Отпечаток выдающего сертификата ЦС_&gt;

6. Выполните следующую командную строку, чтобы обновить локальные параметры групповая политика: gpupdate/force.
7. эти действия должны привести к созданию события 104 на исходном компьютере Просмотр событий приложений и служб логс\микрософт\ Windows \евентлог-форвардингплугин\оператионал log со следующим сообщением:

    "Сервер пересылки успешно подключился к диспетчеру подписки по адресу &lt; FQDN &gt; , за которым следует событие 100 с сообщением:" &lt; sub_name подписка &gt; успешно создана ".

8. В сборщике событий состояние выполнения подписки отобразится 1 активный компьютер.
9. Откройте журнал ForwardedEvents в сборщике событий и проверьте, имеются ли события, перенаправляемые с исходных компьютеров.

### <a name="grant-permission-on-the-private-key-of-the-client-certificate-on-the-event-source"></a>Предоставление разрешения на закрытый ключ сертификата клиента в источнике события

1. Откройте консоль управления сертификатами для локального компьютера на компьютере источника событий.
2. Щелкните сертификат клиента правой кнопкой мыши и выберите Управление закрытыми ключами.
3. Предоставьте разрешение на чтение пользователю сетевой службы.

### <a name="event-subscription-configuration"></a>Конфигурация подписки на события

1. Откройте Просмотр событий в сборщике событий и перейдите к узлу подписки.
2. Щелкните правой кнопкой мыши элемент подписки и выберите команду "создать подписку...".
3. Укажите имя и описание (необязательно) для новой подписки.
4. Выберите параметр "инициированный исходным компьютером" и щелкните "выбрать группы компьютеров...".
5. В окне группы компьютеров нажмите кнопку "добавить компьютеры, не являющиеся доменами". и введите имя узла источника события.
6. Нажмите кнопку "добавить сертификаты". и добавьте сертификат центра сертификации, выдающий сертификаты клиентов. Для проверки сертификата можно щелкнуть в окне Просмотр сертификата.
7. В окне центры сертификации нажмите кнопку ОК, чтобы добавить сертификат.
8. По завершении добавления компьютеров нажмите кнопку ОК.
9. Вернитесь к свойствам подписки, щелкните в области выбрать события...
10. Настройте фильтр запросов событий, указав уровни событий, журналы событий или источники событий, ИДЕНТИФИКАТОРы событий и любые другие параметры фильтрации данных.
11. Вернитесь к свойствам подписки, щелкните Дополнительно...
12. Выберите один из вариантов оптимизации для доставки событий из события источник в сборщик событий или оставьте значение по умолчанию обычная. 
    1. **Уменьшить пропускную способность**. события будут доставляться с меньшей частотой для экономии пропускной способности.
    2. **Свести к минимальным задержкам**. события будут доставляться сразу после их возникновения для сокращения задержки событий.
13. Измените протокол на HTTPS и нажмите кнопку ОК.
14. Нажмите кнопку ОК, чтобы создать новую подписку.
15. Проверьте состояние среды выполнения подписки, щелкнув ее правой кнопкой мыши и выбрав пункт "состояние среды выполнения".
