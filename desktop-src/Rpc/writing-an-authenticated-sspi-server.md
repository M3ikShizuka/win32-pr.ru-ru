---
title: Написание сервера SSPI с проверкой подлинности
description: Прежде чем клиентские и серверные программы могли пройти проверку подлинности, сервер должен зарегистрировать сведения для проверки подлинности.
ms.assetid: 723ae1ee-d729-4748-9ef1-062a0c6f60d0
keywords:
- Удаленный вызов процедур RPC, задачи, написание сервера SSPI с проверкой подлинности
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 462f153905d6b654a0533c7bd05bff0e9627869d6910fb1fea05fe9340b788a0
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119010352"
---
# <a name="writing-an-authenticated-sspi-server"></a>Написание сервера SSPI с проверкой подлинности

Прежде чем клиентские и серверные программы могли пройти проверку подлинности, сервер должен зарегистрировать сведения для проверки подлинности. В частности, сервер должен зарегистрировать имя участника и указать используемую службу проверки подлинности. Дополнительные сведения об именах участников см. в разделе [имена участников](principal-names.md). Дополнительные сведения о службах аутентификации см. в разделе [службы проверки подлинности](authentication-services.md).

Чтобы зарегистрировать сведения для проверки подлинности, серверы вызывают функцию [**рпксерверрегистераусинфо**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcserverregisterauthinfo) . Передайте указатель на имя участника в качестве значения первого параметра. Задайте для второго параметра значение константы, указывающее службу проверки подлинности, которую будет использовать приложение. Описание служб проверки подлинности см. в разделе [константы службы проверки подлинности](authentication-service-constants.md).

Сервер также может передать адрес функции приобретения ключа в качестве значения третьего параметра. См. [раздел функции приобретения ключей](key-acquisition-functions.md). Чтобы использовать функцию приобретения ключа по умолчанию для выбранной службы проверки подлинности, установите для третьего параметра **значение NULL**. Последний параметр функции [**рпксерверрегистераусинфо**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcserverregisterauthinfo) — это данные указателя для передачи в функцию приобретения ключа, если вы предоставляете функцию приобретения ключа. Вызов **рпксерверрегистераусинфо** показан в следующем фрагменте кода.


```C++
dwStatus = DsMakeSpn(
    "ldap",
    "ServerName.domain.com",
    NULL,
    0,
    NULL,
    &pcSpnLength,
    pszSpn);

rpcStatus = RpcServerRegisterAuthInfo (
    psz,                                   // Server principal name
    RPC_C_AUTHN_GSS_NEGOTIATE,             // Authentication service
    NULL,                                  // Use default key function
    NULL);                                 // No arg for key function
```



Кроме того, сервер может предоставить библиотеку времени выполнения RPC с помощью функции авторизации. Чтобы задать функцию авторизации, вызовите функцию [**рпкмгмтсетаусоризатионфн**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcmgmtsetauthorizationfn) .

Серверная часть распределенного приложения может вызывать функцию [**рпкбиндингинкаусклиент**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcbindinginqauthclient) или [**рпкбиндингинкаусклиентекс**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcbindinginqauthclientex) для запроса к маркеру привязки сведений для проверки подлинности.

Если сервер регистрируется в поставщике поддержки безопасности, клиентские вызовы с недействительными учетными данными не будут отправлены. Однако вызовы без учетных данных будут отправлены. Избежать этого можно тремя способами:

-   Зарегистрируйте интерфейс с помощью [**рпксерверрегистерифекс**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcserverregisterifex), используя функцию обратного вызова безопасности. Это приведет к тому, что библиотека времени выполнения RPC автоматически отклонит непроверенные вызовы к этому интерфейсу. Регистрация функции обратного вызова совместима с другими методами проверки учетных данных доступа. Функция обратного вызова может вызывать функции [**рпЦимперсонатеклиент**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcimpersonateclient), [**рпкжетаусоризатионконтекстфорклиент**](/windows/desktop/api/Rpcasync/nf-rpcasync-rpcgetauthorizationcontextforclient), [**рпкбиндингинкаусклиентекс**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcbindinginqauthclient) или другие. Однако эти функции не могут использовать переданные функции аргументы, так как они не обрабатываются в этот момент.

> [!IMPORTANT]
> Регистрация интерфейса с помощью [**рпксерверрегистерифекс**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcserverregisterifex) с функцией обратного вызова безопасности является наиболее часто рекомендуемым методом проверки учетных данных клиента.

 

-   Вызовите [**рпкбиндингинкаусклиент**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcbindinginqauthclient) , чтобы определить уровень безопасности, который использует клиент. После этого заглушка может вернуть ошибку, если клиент не прошел проверку подлинности.

 

 




