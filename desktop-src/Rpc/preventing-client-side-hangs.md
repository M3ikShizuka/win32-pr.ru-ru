---
title: Предотвращение зависаний на стороне клиента
description: Существует два способа зависания сетевого подключения клиентом, что может привести к потере запросов сервера или сбою сервера. При использовании параметров по умолчанию RPC никогда не истечет время ожидания вызова, и клиентский поток будет ждать ответа неограниченно долго.
ms.assetid: 2c201e29-9d9c-48e6-b0b5-68e4b25c3fb7
keywords:
- Удаленный вызов процедур RPC, рекомендации, предотвращение зависаний клиента
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5da79573e59e30c58a7c236b35293b678c93dde6bf999b477de054d6f3c62971
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118927299"
---
# <a name="preventing-client-side-hangs"></a>Предотвращение зависаний на стороне клиента

Существует два способа зависания клиента. сетевое подключение может привести к потере серверных запросов или сбою сервера. При использовании параметров по умолчанию RPC никогда не истечет время ожидания вызова, и клиентский поток будет ждать ответа неограниченно долго.

Существует два метода предотвращения этого: поддерживать активность и истечение времени ожидания.

## <a name="tcp-keep-alives"></a>Активность обновления TCP

Клиент может быть настроен для периодической проверки связи с сервером, чтобы убедиться, что сервер активен и работает. Проверки связи — это активность TCP-соединений для последовательностей протокола [**\_ http**](/windows/desktop/Midl/ncacn-http) [**нкакн \_ IP \_ TCP**](/windows/desktop/Midl/ncacn-ip-tcp) и нкакн, поэтому они эффективны при использовании ЦП и пропускной способности сети. Чтобы включить проверку активности для данного удаленного вызова процедуры, используйте функцию [**рпкмгмтсеткомтимеаут**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcmgmtsetcomtimeout) перед инициацией вызова. Эта функция принимает в качестве аргументов маркер привязки и время ожидания. При каждом вызове удаленной процедуры для этого маркера привязки после **рпкмгмтсеткомтимеаут** использует заданное время ожидания.

Параметр времени ожидания для функции [**рпкмгмтсеткомтимеаут**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcmgmtsetcomtimeout) указывает, как долго время выполнения RPC будет ожидать, прежде чем будет включен режим поддержания активности. Время ожидания — это значение от 0 до 10, где 0 — минимальное время ожидания, а 10 — бесконечное время ожидания (без времени ожидания). Время ожидания выходит за пределы секунд; преобразование из значения времени ожидания, предоставленного функции **рпкмгмтсеткомтимеаут** , в секундах выполняется во время выполнения RPC и зависит от реализации.

в следующей таблице приведено преобразование в секунды для Windows 2000 и Windows XP. в будущих версиях Windows может измениться сопоставление между параметром Timeout и значением времени ожидания в секундах:

| Параметр времени ожидания                       | Фактическое время ожидания в секундах |
|-----------------------------------------|----------------------------|
| 0 ( \_ \_ \_ минимальное время ожидания привязки RPC C \_ )       | 120                        |
| 1                                       | 240                        |
| 2                                       | 360                        |
| 3                                       | 480                        |
| 4                                       | 600                        |
| 5 ( \_ \_ время ожидания привязки RPC C \_ по умолчанию \_ )   | 720                        |
| 6                                       | 840                        |
| 7                                       | 960                        |
| 8                                       | 1080                       |
| 9 ( \_ \_ \_ Максимальное время ожидания привязки RPC C \_ )       | 1200                       |
| 10 ( \_ \_ \_ бесконечное время ожидания привязки RPC C \_ ) | Бесконечное время ожидания          |



 

После включения поддержания активности клиент отправляет один пакет проверки активности каждую секунду. Если нет подтверждения от сервера в течение трех или более активных сеансов, то клиент объявляет соединение неактивным и завершает удаленный вызов процедуры. Если сервер отправляет ответ в течение заданного времени ожидания, то функция поддержания активности не будет включена. Если сервер реагирует на активность, но не отвечает на удаленный вызов процедур, клиент продолжает отправлять сообщения о существовании. Когда сервер отвечает на вызов RPC, проверка активности отключена. для Windows 2000 функция поддержания активности включена только для синхронных вызовов RPC. для Windows XP функция поддержания активности включена для асинхронных вызовов RPC.

Чтобы обеспечить своевременное реагирование клиентского приложения на сетевые проблемы, необходимо установить самое низкое значение. Следует соблюдать осторожность в отношении таких искушения, а также применять принудительное применение к определенному значению. При восстановлении подключения сервер, который временно теряет подключение, может обнаружиться в состоянии поддержания активности от многочисленных клиентов. Кроме того, длительные вычислительные задачи могут занять более двух минут, и сервер может найти больше времени на время ЦП, чем выполнение полезных действий. Поэтому следует использовать проверку активности. Если клиент не может допустить своего потока в течение длительных периодов, следует учитывать асинхронные вызовы RPC.

Другие последовательности протоколов могут реализовывать различные механизмы обнаружения серверов, которые не отвечают, в зависимости от того, какой транспорт используется. Транспорт [**нкалрпк**](/windows/desktop/Midl/ncalrpc) не использует проверки активности. Так как все связи в **нкалрпк** являются локальными, если сервер не отвечает на запросы во время выполнения вызова, время выполнения RPC на клиенте немедленно вызовет сбой.

## <a name="call-time-outs"></a>Время ожидания вызова

Проверка активности протокола TCP выполняется, если сетевое подключение потеряно или если сервер аварийно завершает работу. Но если сервер взаимоблокируется в пользовательском режиме, то проверка активности TCP возвращается успешно, но вызов никогда не будет возвращать. для работы с этим сценарием был добавлен новый параметр времени выполнения для Windows XP: \_ \_ \_ время ожидания вызова RPC C \_ . Этот параметр указывает времени выполнения RPC на настройку таймера при каждой отправке запроса на сервер. Если срок действия таймера истекает, вызов автоматически отменяется и завершается \_ с \_ отменой вызова RPC S \_ . Пока сервер отвечает в течение указанного времени, клиент не будет отменять вызов. Это означает, что вызов из нескольких фрагментов может занять больше времени, чем время ожидания, так как каждый ответ сервера получается в течение времени ожидания, даже несмотря на то, что время ожидания всех откликов превышает промежуток времени.

Кроме того, при отмене вызова сервер не уведомляется об отмене. Таким образом, сервер, скорее всего, будет выполнять вызов в некоторый момент, и клиент просто игнорирует ответ от сервера.

Наиболее опасная ловушка с истечением времени вызова — это установка короткого времени ожидания и повторный вызов на том же сервере. В следующем сценарии показаны опасности такого подхода.

Imagine сервер, который работает почти под емкостью. У него есть несколько клиентов с очень коротким временем ожидания, например пять секунд. Временная утрата сетевого подключения или перегрузки на маршрутизаторе приводит к задержке в ответах сервера на несколько секунд. В сетях Ethernet эта ситуация может быть легко вызвана увеличением нагрузки на связь, которую сервер использует совместно с другим компьютером. Сервер не управляет отправкой всех ответов до 5-секундного истечения времени ожидания. Клиенты отменили свои вызовы и сразу же попытайтесь повторить попытку. Сервер не знает, что вызовы выполняют повторы, а также выполняет их. Таким способом, вместо выполнения обычной рабочей нагрузки вызовов он выполняет 30-50% больше вызовов в зависимости от количества истечения времени ожидания клиентов. Если это превышает емкость, и сервер не может отвечать на все клиенты в течение пяти секунд, на сервер отправляются еще один цикл вызовов. Клиенты продолжают выполнять одни и те же вызовы, а так как сервер перегружается при обработке предыдущих вызовов, он не может ответить в течение времени ожидания. После ответа клиенты достигли времени ожидания, выдавали новый вызов и отменили ответ. В худшем случае сервер не будет восстанавливаться до перезагрузки, а в зависимости от шаблона клиентского доступа может не восстанавливаться до тех пор, пока не остановится достаточное количество клиентов.

> [!Note]  
> Время ожидания вызовов работает только в последовательностях протокола [**\_ http**](/windows/desktop/Midl/ncacn-http) [**нкакн \_ IP \_ TCP**](/windows/desktop/Midl/ncacn-ip-tcp) и нкакн.

 

 

 