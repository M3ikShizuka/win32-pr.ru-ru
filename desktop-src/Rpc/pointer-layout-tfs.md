---
title: Макет указателя
description: Макет указателя описывает указатели структуры или массива.
ms.assetid: 1a4984c1-97b9-4e95-a17e-851b67fa94a3
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6616cc7d1000b042c6039b2abf3f79d4900cd0e5fadac748881666610b139c57
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "120019196"
---
# <a name="pointer-layout"></a>Макет указателя

Макет указателя описывает указатели структуры или массива.

## <a name="pointer_layout"></a>\_<> макета указателя

Макет указателя \_<> поле состоит из символов формата \_ : FC PP FC, \_ за которыми следуют одно или несколько описаний указателей, как описано ниже, и завершением с помощью \_ символа конца формата FC:

``` syntax
FC_PP
FC_PAD
{ pointer_instance_layout<> }*
FC_END
```

\_Макет экземпляра указателя \_<> поле — это строка формата, описывающая один или несколько экземпляров указателей. В этих дескрипторах используются следующие поля:

-   смещение \_ в \_ памяти

    Смещение со знаком в расположении указателя в памяти. Для указателя, находящегося в структуре, это смещение является отрицательным смещением от конца структуры (конца неподчиненной части согласованных структур); для массивов смещение начинается с начала массива.

-   смещение \_ в \_ буфере

    Смещение со знаком в позиции указателя в буфере. Для указателя, находящегося в структуре, это смещение является отрицательным смещением от конца структуры (конца неподчиненной части согласованных структур): для массивов смещение начинается с начала массива.

-   смещение \_ к \_ массиву

    Смещение от окружающей структуры к внедренному массиву, указатели которого обрабатываются. Для массивов верхнего уровня это поле всегда будет равно нулю.

-   итерации

    Общее число указателей, для которых<> описан один и тот же макет.

-   increment

    Увеличение между последовательными указателями во время ПОВТОРа.

-   число \_ \_ указателей

    Количество различных указателей в экземпляре REPEAT.

-   \_Описание указателя

    Описание указателя.

Все макеты экземпляров указателей используют следующий экземпляр одиночного указателя \_<8>:

``` syntax
offset_to_pointer_in_memory<2> 
offset_to_pointer_in_buffer<2> 
pointer_description<4>
```

Ниже приведены дескрипторы экземпляров.

**Одиночный экземпляр указателя на простой тип:**

``` syntax
FC_NO_REPEAT FC_PAD 
pointer_instance<8>
```

**Фиксированный указатель Repeat:**

``` syntax
FC_FIXED_REPEAT FC_PAD 
iterations<2> 
increment<2> 
offset_to_array<2> 
number_of_pointers<2>
{ pointer_instance<8> }*
```

**Указатель на переменную Repeat:**

``` syntax
FC_VARIABLE_REPEAT (FC_FIXED_OFFSET | FC_VARIABLE_OFFSET) 
increment<2> 
offset_to_array<2> 
number_of_pointers<2> 
{ pointer_instance<8> }*
```

Для экземпляров фиксированных повторных и переменных повторений указателей существует набор смещений и описаний указателей для каждого указателя в экземпляре REPEAT.

## <a name="pointers-layout-design-issues"></a>Проблемы проектирования макетов указателей

В этом разделе рассматриваются проблемы, связанные с обработкой согласованных структур и внедренных указателей. Эта ошибка заключается в том, что компилятор создает макеты указателей для структур и массивов с некоторой избыточностью. Это полезно, так как эта информация полезна, поэтому, например, согласованная структура может пройти по одному макету указателя, чтобы обслуживать все указатели из структуры и из согласованного массива, который является частью согласованной структуры. Однако существуют некоторые внедренные ситуации, требующие, чтобы модуль NDR выполнил дополнительную работу по обработке всех макетов указателей в соответствующей последовательности, обрабатывая каждый указатель ровно один раз.

## <a name="what-the-compiler-generates"></a>Что создает компилятор

Каждый объект, обсуждаемый в этом разделе, имеет указатели, поэтому, например, согласованная структура имеет указатели в части структуры, а также в элементах массива. Элемент является простой структурой с указателем.

1.  Согласованная структура, один уровень

    Согласованный дескриптор имеет часть PP, в которой все указатели описаны как из структуры, так и из массива. Список членов имеет длину FC \_ -файла, а не указатель. Дескриптор массива CARRAY содержит элементы с помощью встроенных \_ сложных дескрипторов без указателей. Элемент по-прежнему имеет единственный дескриптор указателя. Макет указателя предшествует макету элемента в согласованной структуре и простых дескрипторах структуры.

2.  Согласованная структура, два или более уровней

    Описание PP содержит указатели со всех уровней. Он использует то же описание массива, что и внутренняя согласованная структура. Список членов имеет длину FC \_ -файла, а не указатель. Внедренная структура реализуется с помощью внедренной сложной структуры. Согласованный дескриптор структуры используется повторно как есть. Размер плоской части структуры также выходит за рамки, что означает, что размер структуры верхнего уровня будет включать неструктурированный размер внедренной структуры.

3.  Сложная структура, один уровень

    Элементы указателя помечаются \_ указателем FC. Макет указателя упрощен таким, что для каждой записи указателя FC в списке имеется дескриптор указателя (4 байта) \_ . Макет указателя просматривается параллельно с помощью прохода по элементу, то есть \_ указатель FC вызывает обработку следующего описания указателя. Массив CARRAY имеет макет указателя со всеми дескрипторами массива, а затем элемент, используя внедренный сложный объект. Дескриптор элемента используется повторно. Размер плоской части структуры завершается. Иными словами, плоский размер структуры верхнего уровня включает неструктурированный размер внедренной структуры. Макет элемента предшествует макету указателя для сложных структур.

    Таким образом, создаваемое описание соответствия массивов зависит от того, является ли он массивом в согласованной структуре или в сложной структуре.

4.  Сложная структура, 2 или более уровней, сложная комплексная

    В сложной структуре верхнего уровня есть указатели на члены, а внедренная сложная структура имеет свои указатели на члены. Дескриптор согласованной структуры используется повторно. Дескриптор массива из верхнего уровня представляет собой повторно используемый массив из внедренной структуры.

5.  Сложная структура с внедренной согласованной структурой

    "Top =". Согласованная структура имеет свои указатели на члены. Согласованный дескриптор структуры используется повторно как есть. Дескриптор массива повторно используется из внедренной согласованной структуры; Иными словами, у него нет указателей в дескрипторе массива. У элемента есть дескриптор указателя.

6.  Массивы структур с указателями

    Массив простых структур с указателями создается как СМФАРРАЙ или CARRAY, в зависимости от того, имеет ли размер массив, но в обоих случаях он имеет макет указателя, который является завершенным (ФИКСИРОВАНное \_ повторение или переменная \_ repeat). Макет указателя располагается перед макетом элемента.

    Массив сложных структур с указателями создается как ФИКТИВный \_ массив независимо от того, является ли он фиксированным или размером, а в обоих случаях не имеет макета указателя.

## <a name="what-the-ndr-engine-does"></a>Что делает модуль NDR

В этом разделе описывается поведение механизма NDR.

**Проход упаковки**

1.  Согласованные структуры и внедренная согласованная структура.

    Структура верхнего уровня ведет себя как структура с одним уровнем.

2.  Внедренная комплексная структура с согласованным массивом

    Любая сложная структура заставляет внешнюю структуру быть сложной. Внедренная структура никогда не маршалирует свой массив. Каждая структура всегда проходит через внедренные указатели, просто упаковывая элементы и элемент, происходящий в качестве \_ указателя FC.

3.  Сложная структура с согласованной структурой

    Самая верхняя встроенная согласованная структура выполняет упаковку согласованного массива и всех поинтис. Модуль NDR никогда не имеет более глубокой вложенной согласованной структуры, если таковые имеются. Это упрощает решение, так как согласованная структура является конечным объектом до того момента, когда происходит маршалирование внедренных объектов. Сложная структура верхнего уровня пропускает упаковку массива.

**Распаковка, буфсизинг и освобождение проходов**

Демаршалирование является симметричным для маршалирования; Первая операция, выполняемая для сложных структур, заключается в том, чтобы определить расположение поинтис в буфере с помощью вызова функции **ндркомплексструктбуфферсизе** . Затем он демаршалирует поинтис в параллельном режиме, что позволяет использовать ту же схему для правильного распаковки поинтис. Не должно быть путаницы по размеру объектов и объединений. образ памяти не должен использоваться для размеров объектов и объединений только для содержимого буфера.

Флаги, используемые для правильного маршалирования и распаковки, используются аналогичным образом в буфсизинг и освобождаются, чтобы гарантировать, что поинтис проводятся ровно один раз.

**Архитектуре Pass**

Сначала архитектуре-проход похож на упаковку и распаковку; для обработки сложных структур требуются два прохода. Первый проход преобразует плоскую часть и находит в буфере расположение поинтис, аналогичное тому, как буфсизинг выполняет эту операцию для распаковки. Затем второй проход преобразует поинтис.

Архитектуре передается следующим образом: Каждая структура и каждый элемент должны быть пошаговыми, пока конечный элемент или элемент не является простым типом. Это отличается от распаковки; Например, при распаковке не требуется обрабатывать согласованные структуры, встроенные в согласованные структуры, или любой член согласованной структуры. Еще одна причина заключается в том, что преобразование не является идемпотентными операцией, поэтому проход распаковки может повторить детрансляцию некоторых частей без ущерба, в то время как преобразование должно выполняться на основе строгого простого типа.

Следовательно, алгоритм архитектуре можно суммировать следующим образом. NDR имеет концепцию согласованной структуры верхнего уровня и флаг, помечающий это соответствующим образом. Во время первого прохода, например для преобразования плоской части и получения расположения поинтис, это понятие использовать не будет. ОНД рассматривает плоские части всех уровней структур и никогда не подключается к обработке указателей. Наконец, ОНД будет плоско преобразовывать массив в верхний уровень.

Во второй раз флаг будет использоваться для обозначения прохода встроенного указателя, чтобы избежать появления более глубоких уровней согласованных структур, а затем самой лучшей согласованной структуры. Таким образом, флаг принудительно вызовет общее поведение маршалинга и демаршалинга, что позволяет избежать убывания на более глубоком уровне согласованных структур.

Второй проход для сложных структур с совместимыми массивами работает следующим образом: сложные структуры работают по общему принципу. Это означает, что более глубокие уровни никогда не просматривает или не пропускают согласованный размер или их согласованные массивы, а просто проведут их члены, не затрагивая массив.

Для сложных структур с согласованными структурами согласованная структура должна быть осведомлена о том, является ли она верхним уровнем и является ли она сложной структурой. Плоская часть массива обрабатывается с помощью самой верхней согласованной структуры. На втором этапе самая лучшая согласованная структура пропускает плоскую часть и просматривает макет указателя и возвращает. Самая сложная структура будет пропускать свою плоскую часть, а также пропускать макет указателя.

**Надежный аспект архитектуреных обзоров**

Архитектуре проходит проверку на наличие стандартных условий, готовых к заполнению буфера, и выполняет другие проверки некоррелированной природы. С помощью этого шага невозможно выполнить проверки, нацеленные на коррелированные значения (например, аргумент размера и соответствующий размер); они выполняются позже, при распаковке.

 

 




