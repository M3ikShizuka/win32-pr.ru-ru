---
title: Семантика сбоев для дескрипторов контекста
description: В этом разделе обсуждается семантика сбоев для дескрипторов контекста.
ms.assetid: fcf28519-39ad-4823-bc27-f3502e4d540c
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: c4528b3f5160b92a4e6f10dbcf877e9fec59f81b
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "104068037"
---
# <a name="failure-semantics-for-context-handles"></a>Семантика сбоев для дескрипторов контекста

В этом разделе обсуждается семантика сбоев для дескрипторов контекста.

## <a name="failure-semantics-when-closing-the-context-handle-fails"></a>Семантика сбоя при закрытии маркера контекста

Представьте себе, что клиентское приложение пытается закрыть обработчик контекста, Открытый на сервере, без закрытия клиентского процесса. Кроме того, предположим, что вызов сервера для закрытия обработчика контекста завершается неудачно (например, у клиента недостаточно памяти). Правильный способ решения этой ситуации — вызвать функцию [**рпкссдестройклиентконтекст**](/windows/desktop/api/Rpcndr/nf-rpcndr-rpcssdestroyclientcontext) . В этом случае клиент очищает свою сторону обработчика контекста и прерывает подключение к серверу. Так как подключение действительно является пулом подключений (см. раздел [RPC и сеть](rpc-and-the-network.md)), который подсчитывается по одной ссылке на каждую открытую привязку или маркер контекста, удаление обработчика контекста путем вызова функции **рпкссдестройклиентконтекст** не приводит к уничтожению соединения. Вместо этого уменьшается число ссылок для пула соединений. Чтобы подключения в пуле были закрыты, клиенту необходимо закрыть все дескрипторы привязки и дескрипторы контекста на этом сервере от клиентского процесса. Затем все подключения в пуле закрываются, а механизм запуска сервера инициируется и очищается.

## <a name="failure-semantics-during-change-of-state-of-the-context-handle"></a>Семантика сбоя при изменении состояния маркера контекста

Сведения в этом разделе относятся к платформам Windows XP и более поздних версий.

Дескрипторы контекста — это просто параметры функции. Все изменения в состоянии обработчика контекста происходят, когда параметры маршалируются или расмаршалируются. Например, если клиент открывает обработчик контекста (изменяет его с **null** на значение, отличное от **null**), то во время выполнения RPC на самом деле не открывается часть этого маркера RPC до тех пор, пока аргументы не будут упакованы для отправки клиенту. Сбои могут возникать во время промежуточного выполнения. Из-за различных возможных сетевых или нехватки ресурсов передача пакета клиенту может завершиться ошибкой. Или серверная подпрограммы может вызвать исключение при попытке изменить маркер контекста. В таких или других случаях сбоя клиент и сервер могут получить непоследовательные представления маркера контекста. В этом разделе описывается правило для состояния маркера контекста, а также ответственность за выполнение кода клиента и сервера во время различных условий сбоя.

-   Получен **нулевой** маркер контекста, но Серверная подпрограммы встречает ошибку и создает исключение.

    Серверная подпрограммы должна выполнять очистку любого состояния, связанного с обработчиком контекста, который мог быть создан. Время выполнения RPC очищает свое состояние.

-   Поступают дескрипторы контекста, отличные от **null** , но Серверная подпрограммы встречает ошибку и создает исключение.

    Если серверная операция закрыла обработчик контекста, клиент не узнает о нем, так как вызов не будет выполнен. дальнейшее использование маркера контекста приведет к \_ \_ \_ \_ ошибке несовпадения контекста RPC X SS на клиенте. Если серверная подпрограммы не изменяет контекстный маркер, клиент по-прежнему может его использовать. Если серверная операция изменяет данные, хранящиеся в контексте сервера, то новые вызовы клиента будут использовать эти сведения.

-   Получен **ненулевой** контекстный маркер, и Серверная операция закрывает этот обработчик, но либо маршалирование, либо после неудачного маршалирования контекстного маркера, либо обработка после сбоя упаковки.

    Маркер контекста закрыт, и последующие вызовы этого клиента с помощью этого обработчика контекста приводят к \_ \_ \_ \_ ошибке несовпадения контекста RPC X SS на клиенте.

-   Получен **нулевой** маркер контекста, и сервер создает его контекст для этого обработчика, но либо упакованный, либо после неудачного маршалирования обработчика контекста, либо обработки после сбоя упаковки.

    В этом случае во время выполнения RPC вызывается выполнение для этого обработчика контекста и очищает состояние RPC для этого обработчика контекста. Обработчик контекста не будет создан на стороне клиента.

-   Получен **ненулевой** контекстный маркер, и сервер либо не изменяет контекстный обработчик, либо изменяет данные, хранящиеся в контексте сервера, а маршалирование завершается неудачей после маршалирования маркера контекста.

    Новые вызовы от клиента будут использовать контекстный обработчик, который имеет сервер.

-   Получен **нулевой** маркер контекста, и сервер не устанавливает его ничего, кроме **null**, но вызов завершается неудачей до маршалирования маркера контекста.

    В этом случае на клиенте не создается маркер контекста.

-   Получен **ненулевой** контекстный маркер, и сервер устанавливает для него **значение NULL**, но маршалирование завершается неудачей перед упаковкой маркера контекста.

    В этом случае маркер контекста остается закрытым на сервере, и клиент получает \_ \_ \_ ошибки несоответствия контекста RPC X SS \_ при попытке использовать контекстный маркер.

-   На сервере поступает **нулевой** маркер контекста, и сервер устанавливает для него значение, отличное от **null**, но при маршалировании происходит сбой, прежде чем будет выполнен маршалирование контекстного маркера.

    Запуск обработчика контекста должен быть вызван, чтобы сервер мог выполнить очистку, и на клиенте не будет создаваться маркер контекста.

-   Получен **ненулевой** контекстный маркер, и сервер либо не изменяет контекстный обработчик, либо изменяет сведения, хранящиеся в контексте сервера, и маршалирование завершается неудачей перед упаковкой маркера контекста.

    Новые вызовы от клиента будут использовать состояние на сервере.

-   Маркер контекста объявляется как возвращаемое значение, а Серверная операция возвращает **значение NULL** для обработчика контекста, и маршалирование завершается неудачей перед упаковкой маркера контекста.

    В этом случае на клиенте не создается новый контекст.

-   Маркер контекста объявляется как возвращаемое значение, а Серверная операция возвращает не **значение NULL** для обработчика контекста, и маршалирование завершается неудачей перед упаковкой маркера контекста.

    Во время выполнения RPC вызывается подлежащая запуску обработчик контекста, чтобы дать ему возможность выполнить очистку, и на клиенте не будет создаваться новый контекст.

 

 




