---
title: Разработка интерфейса с использованием дескрипторов контекста
description: Как правило, обработчик контекста создается путем указания атрибута \ context \_ Handle \ в определении типа в IDL-файле.
ms.assetid: e4caf91f-f92d-4aef-a20f-0a3073230640
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 77e65e36384bda3d81526d5891eca92a77a67402e7cd3aa7af8b61e061a9d3b2
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "120020474"
---
# <a name="interface-development-using-context-handles"></a>Разработка интерфейса с использованием дескрипторов контекста

Как правило, обработчик контекста создается путем указания \[ атрибута [**\_ Handle контекста**](/windows/desktop/Midl/context-handle) \] для определения типа в IDL-файле. Определение типа также неявно указывает подпрограммы запуска контекста, которую необходимо предоставить. Если связь между клиентом и сервером нарушается, время выполнения сервера вызывает эту подпрограммы для выполнения необходимой очистки. Дополнительные сведения о подразделах выполнения контекста см. в разделе [подпрограммы запуска контекста сервера](server-context-run-down-routine.md).

Интерфейс, использующий обработчик контекста, должен иметь маркер привязки для начальной привязки, который должен быть выполнен до того, как сервер сможет вернуть контекстный маркер. Для создания привязки и установки контекста можно использовать автоматический, неявный или явный маркер привязки.

Маркер контекста должен иметь тип [ * *void \** _](/windows/desktop/Midl/void) или тип, который разрешается в [_ *\* void* *](/windows/desktop/Midl/void). Серверная программа приводит ее к требуемому типу.

> [!Note]  
> Использование \[ [**в**](/windows/desktop/Midl/in), [**out**](/windows/desktop/Midl/out-idl) \] для параметров дескриптора контекста не рекомендуется, за исключением подпрограмм, которые закрывают дескрипторы контекста. Если контекст обрабатывает параметры, помеченные как \[ [](/windows/desktop/Midl/in), используется параметр [**out**](/windows/desktop/Midl/out-idl) \] , не передающий на сервер дескриптор контекста, **равный null** или неинициализированному клиенту. Вместо этого следует передать указатель на маркер **null** для обработчика контекста. Обратите внимание, что параметры обработчика контекста, помеченные \[ [**в**](/windows/desktop/Midl/in) \] , не принимают **пустые** указатели.

 

В следующем фрагменте определения интерфейса показано, как распределенное приложение может использовать контекстный обработчик для открытия сервером и обновления файла данных для каждого клиента.

Интерфейс должен содержать удаленный вызов процедуры для инициализации обработчика и присвоения ему значения, отличного от **null** . В этом примере функция Ремотеопен выполняет эту операцию. Он задает маркер контекста с \[ атрибутом [**Outing**](/windows/desktop/Midl/out-idl) \] . Кроме того, можно вернуть контекстный маркер в качестве возвращаемого значения процедуры. Однако в этом примере мы передаем контекстный обработчик в список параметров.

В этом примере сведения о контексте являются маркером файла. Он отслеживает текущее расположение в файле. Интерфейс упаковывает файл как обработчик контекста и передает его в качестве параметра в вызовы удаленных процедур. Структура содержит имя файла и файловый обработчик.

``` syntax
/* file: cxhndl.idl (fragment of interface definition file) */
typedef [context_handle] void * PCONTEXT_HANDLE_TYPE;
typedef [ref] PCONTEXT_HANDLE_TYPE * PPCONTEXT_HANDLE_TYPE;
 
short RemoteOpen([out] PPCONTEXT_HANDLE_TYPE pphContext,
    [in, string] unsigned char * pszFile);
 
void RemoteRead(
    [in] PCONTEXT_HANDLE_TYPE phContext,
    [out, size_is(cbBuf)] unsigned char achBuf[],
    [in, out] short *pcbBuf);
 
short RemoteClose([in, out] PPCONTEXT_HANDLE_TYPE pphContext);
```

Функция Ремотеопен создает допустимый **ненулевой** маркер контекста, отличный от NULL. Он передает контекстный указатель клиенту. Последующие удаленные вызовы процедур, такие как Ремотереад, используют описатель контекста в качестве указателя в.

В дополнение к удаленной процедуре, которая инициализирует маркер контекста, интерфейс должен содержать процедуру, которая освобождает контекст сервера и устанавливает для контекстного маркера **значение NULL**. В предыдущем примере функция Ремотеклосе выполняет эту операцию.

 

 