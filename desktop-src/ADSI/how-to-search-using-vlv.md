---
title: Поиск с помощью VLV
description: Active Directory поддерживает поиск в представлении виртуального списка (VLV). Этот стиль поиска специально предназначен для больших результирующих наборов и позволяет приложению отображать набор тысяч записей без необходимости получения каждой записи.
ms.assetid: fea04190-0846-4b62-99f4-7d8fb35fd510
ms.tgt_platform: multiple
keywords:
- Поиск с помощью VLV
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8f4a24250c8e54ccb7917f86b193152c62810b93
ms.sourcegitcommit: b0ebdefc3dcd5c04bede94091833aa1015a2f95c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/21/2020
ms.locfileid: "103987888"
---
# <a name="how-to-search-using-vlv"></a>Поиск с помощью VLV

Active Directory поддерживает поиск в представлении виртуального списка (VLV). Этот стиль поиска специально предназначен для больших результирующих наборов и позволяет приложению отображать набор тысяч записей без необходимости получения каждой записи.

Существует два различных способа использования поиска VLV. Первый — получить атрибуты для определенных записей на основе числового смещения. Этот метод полезен при получении результатов поиска в ответ на операцию прокрутки.

Второй способ использования поиска VLV — Поиск части или всего текстового атрибута и отображение результатов поиска. Примером использования этой адресной книги является адресная книга. Если пользователь вводит "s", то приложение может использовать поиск VLV для поиска записей с обычным именем, начинающимся с "s". Если затем пользователь добавляет "m" к "s", приложение может использовать другой поиск VLV для поиска записей с общим именем, начинающимся с "SM".

Чтобы выполнить поиск VLV, попросите ADSI использовать элемент управления VLV. Для этого вызовите метод [**IDirectorySearch:: сетсеарчпреференце**](/windows/desktop/api/Iads/nf-iads-idirectorysearch-setsearchpreference) с **рекламным \_ сеарчпреф \_ VLV** с параметром поиска **адстипе \_ Prov \_** . **\_ \_ Конкретное значение адстипе Prov** — это указатель на структуру [**ADS \_ VLV**](/windows/desktop/api/Iads/ns-iads-ads_vlv) , которая содержит данные о поиске. В примере функции [**жетвлвитемкаунт**](example-code-for-using-a-vlv-search.md) показано, как задать оба этих параметра поиска.

Все поисковые запросы VLV должны использовать сортировку результатов на стороне сервера, которая выполняется путем установки параметра **AD \_ сеарчпреф \_ Sort \_ по** поиску. Дополнительные сведения о параметрах поиска **ADS \_ сеарчпреф \_ \_** см. в разделе [Сортировка результатов поиска с помощью IDirectorySearch](sorting-the-search-results-with-idirectorysearch.md).

При выполнении поиска VLV в столбце возвращается определенный объем метаданных, который извлекается путем вызова [**IDirectorySearch::**](/windows/desktop/api/Iads/nf-iads-idirectorysearch-getcolumn) GetResponse с идентификатором **\_ \_ ответа VLV ADS** . Эти данные содержатся в структуре [**ADS \_ VLV**](/windows/desktop/api/Iads/ns-iads-ads_vlv) . Определенным уровнем важности являются члены **двконтенткаунт** и **лпконтекстид** . Элемент **двконтенткаунт** будет содержать количество результатов, удовлетворяющих критериям поиска VLV. Это значение можно использовать в качестве оценки общего числа элементов, которые будут возвращены для поиска этого типа. Элемент **лпконтекстид** содержит определяемое сервером значение, которое может быть передано следующему поиску для определения поиска. Использование **лпконтекстид** может повысить производительность поиска. Имейте в виду, что **лпконтекстид** является определяемым сервером значением и его длина содержится в элементе **двконтекстидленгс** . Этот буфер освобождается при вызове метода [**IDirectorySearch:: фриколумн**](/windows/desktop/api/Iads/nf-iads-idirectorysearch-freecolumn) , поэтому вызывающий объект должен выделить буфер соответствующего размера, скопировать и сохранить содержимое буфера между операциями поиска.

Дополнительные сведения об элементе управления VLV LDAP см. [в разделе Поиск с помощью элемента управления LDAP VLV](/previous-versions/windows/desktop/ldap/searching-with-the-ldap-vlv-control).

Дополнительные сведения можно найти в разделе

-   Получение количества элементов
-   Поиск по смещению
-   Поиск по строке
-   [Пример кода для использования поиска VLV](example-code-for-using-a-vlv-search.md)

## <a name="obtaining-the-number-of-items"></a>Получение количества элементов

**Чтобы получить оценку количества элементов, которые будут возвращены для конкретного поиска, выполните следующие действия.**

1.  Заполните структуру [**ADS \_ VLV**](/windows/desktop/api/Iads/ns-iads-ads_vlv) значениями, имеющими нулевое значение или значения **null** .
2.  Заполните [**баннерную \_ \_ информацию сеарчпреф**](/windows/desktop/api/Iads/ns-iads-ads_searchpref_info) со следующими значениями.

    -   Установите элемент **двсеарчпреф** в **ADS \_ сеарчпреф \_ VLV**.
    -   Задайте для элемента **управляемое vValue. двтипе** значение **адстипе \_ Prov \_**.
    -   Задайте для элемента **управляемое vValue. провидерспеЦифик. двленгс** размер структуры [**ADS \_ VLV**](/windows/desktop/api/Iads/ns-iads-ads_vlv) .
    -   Присвойте элементу **управляемое vValue. провидерспеЦифик. лпвалуе** адрес структуры [**ADS \_ VLV**](/windows/desktop/api/Iads/ns-iads-ads_vlv) из шага 1.

3.  Заполните структуру [**ADS \_**](/windows/desktop/api/Iads/ns-iads-ads_sortkey) , как показано в [поле Сортировка результатов поиска по IDirectorySearch](sorting-the-search-results-with-idirectorysearch.md) для сортировки по нужному атрибуту.
4.  Заполните еще одну [**рекламу \_ сеарчпреф \_ сведения**](/windows/desktop/api/Iads/ns-iads-ads_searchpref_info) , чтобы добавить структуру [**ADS \_**](/windows/desktop/api/Iads/ns-iads-ads_sortkey) в параметры поиска, как показано в разделе [Сортировка результатов поиска с помощью IDirectorySearch](sorting-the-search-results-with-idirectorysearch.md).
5.  Добавьте другие необходимые параметры поиска и вызовите [**IDirectorySearch:: сетсеарчпреференце**](/windows/desktop/api/Iads/nf-iads-idirectorysearch-setsearchpreference) , чтобы задать параметры поиска.
6.  Выполните поиск с помощью [**IDirectorySearch:: ExecuteSearch**](/windows/desktop/api/Iads/nf-iads-idirectorysearch-executesearch).
7.  Получите первую строку результатов, вызвав [**IDirectorySearch:: жетфирстров**](/windows/desktop/api/Iads/nf-iads-idirectorysearch-getfirstrow).
8.  Чтобы получить метаданные для поиска VLV, вызовите [**IDirectorySearch::**](/windows/desktop/api/Iads/nf-iads-idirectorysearch-getcolumn) GetResponse с **ADS \_ VLV \_ Response** .
9.  Приведите **падсвалуес->провидерспеЦифик. лпвалуе** структуры [**\_ \_ столбцов поиска ADS**](/windows/desktop/api/Iads/ns-iads-ads_search_column) к указателю [**\_ VLV структуры ADS**](/windows/desktop/api/Iads/ns-iads-ads_vlv) . Элемент **двконтенткаунт** этой структуры **ADS \_ VLV** содержит приблизительное количество элементов, возвращаемых при поиске этого типа.
10. Если будут выполнены другие VLV Поиск одного и того же типа, создайте копию данных **лпконтекстид** и сохраните их для следующего поиска VLV.

В примере функции [**жетвлвитемкаунт**](example-code-for-using-a-vlv-search.md) показано, как это сделать.

## <a name="searching-by-offset"></a>Поиск по смещению

Одна из целей, которая делает поиск VLV настолько быстро, что можно искать конкретный результат по числовому смещению. Например, если поиск приведет к возвращению 10 000 элементов, VLV Поиск позволяет получить информацию приблизительно для элемента 4072nd, не извлекая все элементы до того, как элемент найден.

Смещения задаются как отношение между смещением и числом содержимого. Соотношение полезно, поскольку сервер может не иметь точной оценки количества записей, существующих в списке, или размер списка может измениться во время его обзора пользователем. Поскольку необходимо указать начало и конец списка, можно использовать оценочное значение количества содержимого в первом поисковом запросе, а также значение смещения. Сервер использует эти данные для вычисления соответствующих смещений в списке, исходя из его представления о количестве содержимого, которое отправляется в ответ на клиент через элемент **двконтенткаунт** структуры [**ADS \_ VLV**](/windows/desktop/api/Iads/ns-iads-ads_vlv) . Например, если вы оцениваете размер списка как 3000 и хотите, чтобы смещение было введено в список 1500, задайте для **двконтенткаунт** значение 3000, а для **двоффсет** — значение 1500. Если сервер считает реальный размер списка равным 4500, он повторно вычислит смещение до 2250 и возвратит новые оценки в **двконтенткаунт** и **двоффсет**.

> [!Note]
>
> Все числовые значения в VLV поиска являются приближениями и не должны использоваться для абсолютных значений. Например, если вы выдаете VLV Поиск 50-й позиции в ъявлению из 100, вы не гарантируете получение точного среднего элемента.
>
> **Чтобы найти конкретный элемент по смещению, выполните следующие действия.**
>
> 1.  Заполните структуру [**ADS \_ VLV**](/windows/desktop/api/Iads/ns-iads-ads_vlv) следующими значениями. Дополнительные члены структуры должны иметь нулевое значение или **значение NULL**.
>
>     -   Задайте для элемента **двконтенткаунт** максимальное значение соотношения извлекаемых элементов.
>     -   Присвойте элементу **двоффсет** отношение к соотношениям (относительно **двконтенткаунт**) элемента или элементов для извлечения.
>     -   Задайте для элемента **лпконтекстид** адрес копии буфера идентификаторов контекста и **двконтекстидленгс** , чтобы длина буфера идентификатора контекста в байтах была равна. Если идентификатор контекста не был сохранен, оба эти элемента должны быть равны нулю или **null**.
>
> 2.  Задайте параметры поиска, как показано в шагах 2 – 5 раздела Получение числа элементов.
> 3.  Выполните поиск с помощью [**IDirectorySearch:: ExecuteSearch**](/windows/desktop/api/Iads/nf-iads-idirectorysearch-executesearch).
> 4.  Получите первую строку результатов, вызвав [**IDirectorySearch:: жетфирстров**](/windows/desktop/api/Iads/nf-iads-idirectorysearch-getfirstrow).
> 5.  Вызовите [**IDirectorySearch:: DataColumn**](/windows/desktop/api/Iads/nf-iads-idirectorysearch-getcolumn) с именем атрибута, который необходимо получить, чтобы получить фактические данные для запрошенного элемента.
> 6.  Чтобы получить метаданные для поиска VLV, вызовите [**IDirectorySearch::**](/windows/desktop/api/Iads/nf-iads-idirectorysearch-getcolumn) GetResponse с **ADS \_ VLV \_ Response** .
> 7.  Приведите **падсвалуес->провидерспеЦифик. лпвалуе** структуры [**\_ \_ столбцов поиска ADS**](/windows/desktop/api/Iads/ns-iads-ads_search_column) к указателю [**\_ VLV структуры ADS**](/windows/desktop/api/Iads/ns-iads-ads_vlv) .
> 8.  Создайте копию данных **лпконтекстид** и сохраните ее для следующего поиска VLV.

 

В примере функции [**жетвлвитемтекст**](example-code-for-using-a-vlv-search.md) показано, как это сделать.

Кроме того, можно получить несколько строк данных с помощью одного вызова поиска. Это делается на шаге 1, настроив элементы **двбефорекаунт** и **двафтеркаунт** структуры [**ADS \_ VLV**](/windows/desktop/api/Iads/ns-iads-ads_vlv) соответствующим образом. Элемент **двбефорекаунт** содержит количество элементов, отображаемых в списке до элемента, а элемент **двафтеркаунт** содержит число элементов, которые отображаются в списке после того, как заданный элемент. Оба эти счетчика исключают сам элемент, поэтому при установке **двбефорекаунт** в значение 10, а **двафтеркаунт** — в 10, возвращается всего 21 элемент. Этот параметр позволяет кэшировать результаты поиска на стороне клиента.

## <a name="searching-by-string"></a>Поиск по строке

Можно также использовать поиск VLV, чтобы найти элементы, имеющие строковый атрибут, значение которого совпадает со всем или частью строки без извлечения всех элементов. Сопоставление строк выполняется по атрибуту, указанному в структуре [**ADS \_**](/windows/desktop/api/Iads/ns-iads-ads_sortkey) в области **объявлений \_ сеарчпреф \_ Sort \_ по** параметрам поиска.

**Чтобы найти конкретный элемент по строке, выполните следующие действия.**

1.  Заполните структуру [**ADS \_ VLV**](/windows/desktop/api/Iads/ns-iads-ads_vlv) следующими значениями. Дополнительные члены структуры должны иметь нулевое значение или **значение NULL**.

    -   Присвойте элементу **псзтаржет** указатель на строку, завершающуюся нулем, которая содержит строку для поиска.
    -   Задайте для элемента **лпконтекстид** адрес копии буфера идентификаторов контекста и **двконтекстидленгс** , чтобы длина буфера идентификатора контекста в байтах была равна. Если идентификатор контекста не был сохранен, оба эти элемента должны быть равны нулю или **null**.

2.  Задайте параметры поиска, как показано в шагах 2 – 5 раздела Получение числа элементов.
3.  Выполните поиск с помощью [**IDirectorySearch:: ExecuteSearch**](/windows/desktop/api/Iads/nf-iads-idirectorysearch-executesearch).
4.  Получите первую строку результатов, вызвав [**IDirectorySearch:: жетфирстров**](/windows/desktop/api/Iads/nf-iads-idirectorysearch-getfirstrow).
5.  Вызовите [**IDirectorySearch:: DataColumn**](/windows/desktop/api/Iads/nf-iads-idirectorysearch-getcolumn) с именем атрибута, который необходимо получить, чтобы получить фактические данные для запрошенного элемента.
6.  Чтобы получить метаданные для поиска VLV, вызовите [**IDirectorySearch::**](/windows/desktop/api/Iads/nf-iads-idirectorysearch-getcolumn) GetResponse с **ADS \_ VLV \_ Response** .
7.  Приведите **падсвалуес->провидерспеЦифик. лпвалуе** структуры [**\_ \_ столбцов поиска ADS**](/windows/desktop/api/Iads/ns-iads-ads_search_column) к указателю [**\_ VLV структуры ADS**](/windows/desktop/api/Iads/ns-iads-ads_vlv) .
8.  Создайте копию данных **лпконтекстид** и сохраните ее для следующего поиска VLV. При необходимости элемент **двоффсет** содержит Отсчитываемый от единицы индекс первого элемента, атрибут String которого начинается со значения, указанного в **псзтаржет**.

В примере функции [**жетвлвитемсбистринг**](example-code-for-using-a-vlv-search.md) показано, как это сделать.

Аналогично поиску по индексу можно также получить более одной строки данных с помощью одного вызова поиска. Это выполняется таким же образом путем установки элементов **двбефорекаунт** и **двафтеркаунт** структуры [**ADS \_ VLV**](/windows/desktop/api/Iads/ns-iads-ads_vlv) соответствующим образом.

 

 