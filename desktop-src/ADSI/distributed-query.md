---
title: Распределенный запрос
description: Поскольку ADSI является поставщиком OLE DB, он может участвовать в распределенном запросе, представленном в Microsoft SQL Server 7,0.
ms.assetid: 0a93ec2e-397a-47f7-b00c-f0f9aaa06de6
ms.tgt_platform: multiple
keywords:
- запросы к ADSI, распределенный запрос
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f8675f0a5ba9faa6ece78783eb4f61f17aafabc8
ms.sourcegitcommit: 3e70ae762629e244028b437420ed50b5850db4e3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/20/2020
ms.locfileid: "105654263"
---
# <a name="distributed-query"></a>Распределенный запрос

Поскольку ADSI является поставщиком OLE DB, он может участвовать в распределенном запросе, представленном в Microsoft SQL Server 7,0. Ниже приведены возможные сценарии.

-   Объединение Active Directory объектов с SQL Server данными.
-   Обновление данных SQL из Active Directory объектов.
-   Создание трехстороннее и двустороннего соединений с другими поставщиками OLE DB. Например, сервер индекса, SQL Server и Active Directory.

Поставщик OLE DB поддерживает два диалекта команд: LDAP и SQL, чтобы получить доступ к службе каталогов и вернуть результаты в виде табличной формы, которая может быть запрошена SQL Server распределенными запросами.

**Запуск анализатора запросов SQL**

1.  Сначала откройте [анализатор запросов SQL](https://msdn.microsoft.com/library/Aa216983.aspx) на SQL Server, связанном со службой каталогов (см. раздел Создание связанного сервера).
2.  Запуск **анализатора запросов SQL** (запуск \| программ \| Microsoft SQL Server 7,0)
3.  Войдите на компьютер SQL Server.
4.  Введите запрос SQL в область редактора окна запроса.
5.  Выполните запрос, нажав клавишу F5.

Дополнительные сведения приведены в следующих разделах:

-   [Создание связанного сервера](#creating-a-linked-server)
-   [Создание SQL Server с проверкой подлинности имени входа](#creating-a-sql-server-authenticated-login)
-   [Запрос к службе каталогов](#querying-the-directory-service)

## <a name="creating-a-linked-server"></a>Создание связанного сервера

Чтобы настроить распределенное соединение в службе каталогов Windows 2000 Server, создайте связанный сервер. Для этого настройте сопоставление ADSI с помощью системной хранимой процедуры [SP \_ аддлинкедсервер](https://msdn.microsoft.com/library/Aa259589.aspx) . Эта процедура связывает имя с именем поставщика OLE DB.

В следующем примере обратите внимание, что в системной хранимой процедуре [SP \_ аддлинкедсервер](https://msdn.microsoft.com/library/Aa259589.aspx) используются несколько аргументов:

-   «ADSI» — это аргумент **сервера** , который будет именем этого связанного сервера.
-   "Active Directory Services 2,5" — это аргумент **срвпродукт** , который представляет собой имя источника данных OLE DB, добавляемого в качестве связанного сервера.
-   "Адсдсубжект" — это **аргумент \_ имени поставщика** .
-   "адсдатасаурце" — это **аргумент \_ источника данных** , который представляет собой имя источника данных, интерпретируемое поставщиком OLE DB.

Команда [exec](https://msdn.microsoft.com/library/Aa258848.aspx) используется для выполнения системных хранимых процедур.


```sql
EXEC sp_addlinkedserver 'ADSI', 'Active Directory Services 2.5', 
'ADSDSOObject', 'adsdatasource'
GO
```



Для имен входа, прошедших проверку подлинности Windows, для доступа к каталогу с помощью SQL Serverного делегирования безопасности достаточно самостоятельного сопоставления. Так как Самосопоставление создается по умолчанию для связанных серверов, созданных с помощью [SP \_ аддлинкедсервер](https://msdn.microsoft.com/library/Aa259589.aspx), никаких других сопоставлений имен входа не требуется.

Для имен входа, прошедших проверку подлинности SQL Server, можно настроить подходящие имена входа и пароли для подключения к службе каталогов с помощью системной хранимой процедуры [SP \_ аддлинкедсрвлогин](https://msdn.microsoft.com/library/Aa259581.aspx) .

> [!Note]  
> По возможности используйте аутентификацию Windows.

 

## <a name="creating-a-sql-server-authenticated-login"></a>Создание SQL Server с проверкой подлинности имени входа

Если вы предпочитаете использовать вход с проверкой подлинности SQL Server, а не проверку подлинности Windows, добавьте имя входа на связанный сервер (см. предыдущий раздел). Для этого используйте системную хранимую процедуру [SP \_ аддлинкедсрвлогин](https://msdn.microsoft.com/library/Aa259581.aspx) .

В следующем примере существует несколько аргументов, которые используются с системной хранимой процедурой [SP \_ аддлинкедсрвлогин](https://msdn.microsoft.com/library/Aa259581.aspx) :

-   "ADSI" — это аргумент **рмтсврнаме** , который представляет собой имя связанного сервера, созданного в предыдущем примере.
-   " \\ Администратор Fabrikam" — это аргумент **локаллогин** , который является именем входа на локальном сервере и может быть SQL Server именем входа или пользователем Windows NT.
-   "CN = Administrator, OU = Sales, DC = активедс, DC = Fabrikam, DC = com" — это аргумент **рмтусер** , который является именем пользователя, используемым для подключения, так как **useself** имеет **значение false**.
-   "Secret \* \* 2000" — это **рмтпассворд**, который является паролем, связанным с **рмтусер**

Команда [exec](https://msdn.microsoft.com/library/Aa258848.aspx) используется для выполнения системных хранимых процедур.


```sql
EXEC sp_addlinkedsrvlogin 'ADSI', false, 'Fabrikam\Administrator', 
'CN=Administrator,OU=Sales,DC=activeds,DC=Fabrikam,DC=com', 'secret**2000'
```



## <a name="querying-the-directory-service"></a>Запрос к службе каталогов

После создания связанного сервера используйте инструкцию [OPENQUERY](https://msdn.microsoft.com/library/Aa276848.aspx) для отправки запроса в службу каталогов. Следующий SQL-запрос создает виртуальную таблицу для хранения результатов запроса с помощью инструкции [Create View](https://msdn.microsoft.com/library/Aa258253.aspx) . Созданное представление называется "Виевадконтактс".

Первая инструкция [SELECT](https://msdn.microsoft.com/library/Aa259187.aspx) определяет сведения, запрашиваемые из службы каталогов, и сопоставляет их со столбцом в таблице. Сведения, заключенные в квадратные скобки, указывают на данные, помещаемые в виртуальную таблицу. Сведения, отсутствующие в квадратных скобках, указывают на данные, получаемые из службы каталогов. Обратите внимание, что сведения, получаемые из службы каталогов, должны ссылаться по отображаемому имени LDAP.

Следующий оператор является инструкцией [OPENQUERY](https://msdn.microsoft.com/library/Aa276848.aspx) . Эта инструкция имеет два аргумента: ADSI, то есть имя созданного связанного сервера и Инструкция запроса. Инструкция запроса содержит следующие элементы:

-   Инструкция [SELECT](https://msdn.microsoft.com/library/Aa259187.aspx) содержит список данных, которые будут получены из службы каталогов. Для указания искомых данных необходимо использовать отображаемое имя LDAP.
-   Инструкция [from](https://msdn.microsoft.com/library/Aa258869.aspx) содержит имя связанного сервера каталогов, из которого будут получены эти сведения.
-   Оператор [WHERE](https://msdn.microsoft.com/library/Aa260674.aspx) предоставляет условия поиска. В этом примере выполняется поиск контактов.

Последняя инструкция [SELECT](https://msdn.microsoft.com/library/Aa259187.aspx) используется для отбора результатов из отображаемого представления.


```sql
CREATE VIEW viewADContacts
AS
SELECT  [Name], sn [Last Name], street [Street], l [City], st [State]
FROM OPENQUERY( ADSI, 
     'SELECT name, sn, street, l, st
      FROM 'LDAP:// OU=Sales,DC=activeds,DC=Fabrikam,DC=Com'
      WHERE objectCategory='Person' AND 
      objectClass = 'contact'')
GO
SELECT * FROM viewADContacts
```



 

 




