---
title: Трассировка событий в ADSI
description: Windows сервер 2008 и Windows Vista предоставляют трассировку событий в Active Directory интерфейсах служб (ADSI).
ms.assetid: 743aeeba-5b48-47c7-aaf5-0e9b48e206db
ms.tgt_platform: multiple
keywords:
- интерфейс ADSI трассировки событий
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 50ff881a408e2f6d7a6b661e7556c8d39366f726
ms.sourcegitcommit: 9b5faa61c38b2d0c432b7f2dbee8c127b0e28a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/19/2021
ms.locfileid: "122469201"
---
# <a name="event-tracing-in-adsi"></a>Трассировка событий в ADSI

Windows сервер 2008 и Windows Vista предоставляют [трассировку событий](/windows/desktop/ETW/event-tracing-portal) в [Active Directory интерфейсах служб](active-directory-service-interfaces-adsi.md) (ADSI). Некоторые области поставщика ADSI LDAP имеют базовую реализацию, которая является сложной или включает последовательность действий, что затрудняет диагностику проблем. Для помощи в устранении неполадок, связанных с разработчиками приложений, в следующие области была добавлена трассировка событий.

## <a name="schema-parsing-and-downloading"></a>Синтаксический анализ и загрузка схемы

Интерфейс IADs в ADSI требует, чтобы схема LDAP была кэширована на клиенте, чтобы атрибуты можно было правильно маршалировать (как описано в [модели схемы ADSI](adsi-schema-model.md)). Для этого ADSI загружает схему для каждого процесса (и для каждого LDAP-сервера или домена) в память из файла схемы (. SCH), сохраненного на локальном диске, или путем его загрузки с LDAP-сервера. Различные процессы на одном клиентском компьютере используют кэшированную схему на диске, если она доступна и применима.

Если схема не может быть получена с диска или с сервера, ADSI использует жестко закодированную схему по умолчанию. В этом случае атрибуты, которые не являются частью этой схемы по умолчанию, не могут быть упакованы, и при получении этих атрибутов ADSI возвращает ошибку. Это может быть вызвано несколькими причинами, в том числе проблемами при анализе схемы и недостаточными привилегиями для загрузки схемы. Часто бывает трудно определить, почему используется определенная схема по умолчанию. Использование трассировки событий в этой области поможет вам быстрее диагностировать проблему и устранить ее.

## <a name="changing-and-setting-the-password"></a>Изменение и установка пароля

[**ChangePassword**](/windows/desktop/api/Iads/nf-iads-iadsuser-changepassword) и [**SetPassword**](/windows/desktop/api/Iads/nf-iads-iadsuser-setpassword) используют более одного механизма для выполнения запрошенной операции на основе доступной конфигурации (как описано в разделе [Настройка и изменение ПАРОЛЕЙ пользователей с помощью поставщика LDAP](setting-user-passwords-for-ldap-providers.md)). При сбое **ChangePassword** и **SetPassword** может быть трудно определить причину, и трассировка событий поможет устранить проблемы с этими методами.

## <a name="adsi-bind-cache"></a>Кэш привязки ADSI

ADSI внутренне пытается повторно использовать LDAP-подключения везде, где это возможно (см. раздел [кэширование подключения](connection-caching.md)). При устранении неполадок полезно отслеживать, было ли открыто новое соединение для связи с сервером или использовалось ли существующее соединение. Также может быть полезно отслеживать жизненный цикл кэша подключений (иногда называемый кэшем привязки), его создание или закрытие и наличие ссылки на соединение. В случае [бессерверной привязки](/windows/desktop/AD/serverless-binding-and-rootdse)ADSI вызывает локатор контроллера домена, чтобы выбрать сервер для домена контекста пользователя. Затем ADSI поддерживает кэш сопоставления сервера домена для последующих подключений. Трассировка событий позволяет отслеживать выбор контроллера домена и, следовательно, помогает устранять проблемы, связанные с подключением.

## <a name="enabling-tracing-and-starting-a-tracing-session"></a>Включение трассировки и запуск сеанса трассировки

Чтобы включить трассировку ADSI, создайте следующий раздел реестра:

**HKey \_ Локальная система \_ машин** \\  \\ **CurrentControlSet** \\ **Services** \\ **ADSI**, \\ **Трассировка** \\ **_processName_**

*ProcessName* — это полное имя процесса, который необходимо отследить, включая его расширение (например, "Svchost.exe"). Кроме того, в этом разделе можно поместить необязательное значение типа **DWORD** с именем PID. Настоятельно рекомендуется задать это значение и, таким образом, отслеживать только конкретный процесс. В противном случае будут отслеживаться все экземпляры приложения, заданные параметром *processName* .

Затем выполните следующую команду:

**tracelog.exe-Start** *sessionname* **-GUID \#** _поставщика \_ GUID_ **-f** *имя_файла* **-флаг** *флагов трассировки* **-Level** *TraceLevel*

*sessionname* — это просто произвольный идентификатор, который используется для обозначения сеанса трассировки (в дальнейшем необходимо будет ссылаться на это имя сеанса, когда вы останавливаете сеанс трассировки). Идентификатор GUID для поставщика отслеживания ADSI — "7288c9f8-d63c-4932-A345-89d6b060174d". *filename* указывает файл журнала, в который будут записываться события. *флагов трассировки* должно иметь одно из следующих значений:



|         Флаг                        |         Значение              |
|---------------------------------|-----------------------|
| **ОТЛАДКа \_ схемы**<br/>    | 0x00000001<br/> |
| **ОТЛАДКа \_ чанжепвд**<br/> | 0x00000002<br/> |
| **ОТЛАДКа \_ сетпвд**<br/>    | 0x00000004<br/> |
| **ОТЛАДКа \_ биндкаче**<br/> | 0x00000008<br/> |



 

Эти флаги определяют, какие методы [ADSI](active-directory-service-interfaces-adsi.md) будут трассироваться, в соответствии со следующей таблицей.




| | | <strong>DEBUG_SCHEMA</strong><br /> | <ul><li>лдапжетсчема</li><li>жетсчемаинфотиме</li><li>лдапреадсчемаинфофромсервер</li><li>процесссчемаинфо</li><li>хелперреадлдапсчемаинфо</li><li>процессклассинфоаррай</li><li>реадсчемаинфофромрегистри</li><li>сторесчемаинфофромрегистри</li><li>аттрибутетипедескриптион</li><li>обжектклассдескриптион</li><li>дитконтентруледескриптион</li><li>директористринг</li><li>директористрингс</li><li>дитконтентруледескриптион</li></ul><br /> | | <strong>DEBUG_CHANGEPWD</strong><br /> | <ul><li>Кадсусер:: ChangePassword</li></ul><br /> | | <strong>DEBUG_SETPWD</strong><br /> | <ul><li>Кадсусер:: SetPassword</li></ul><br /> | | <strong>DEBUG_BINDCACHE</strong><br /> | <ul><li>жетсервербаседобжект</li><li>жетсерверлессбаседобжект</li><li>жетгкдомаиннаме</li><li>жетдефаултдомаиннаме</li><li>жетусердомаинфлатнаме</li><li>биндкачелукуп</li><li>екуивалентпортнумберс</li><li>канкредентиалсбереусед</li><li>биндкачеадд</li><li>биндкачеаддреф</li><li>аддреферраллинк</li><li>коммонремовинтри</li><li>биндкачедерефхелпер</li><li>нотифиневконнектион</li><li>куерифорконнектион</li><li>лдапопенбиндвискредентиалс</li><li>лдапопенбиндвисдефаулткредентиалс</li></ul><br /> | 




 

Можно объединить флаги, объединив соответствующие биты в аргументе *флагов трассировки* . Например, чтобы указать **отладочную \_ схему** и флаги **отладки \_ биндкаче** , соответствующее значение *флагов трассировки* будет 0x00000009.

Наконец, флаг *TraceLevel* должен иметь одно из следующих значений:



|      Флаг                                    |       Значение                |
|------------------------------------------|-----------------------|
| **\_ошибка уровня \_ трассировки**<br/>       | 0x00000002<br/> |
| **\_ \_ сведения об уровне трассировки**<br/> | 0x00000004<br/> |



 

**Трассировка событий \_ \_Сведения об уровне** приводят к тому, что процесс трассировки записывает все события, в то время как **\_ \_ ошибка уровня трассировки** приводит к тому, что процесс трассировки записывает только события ошибок.

Чтобы завершить трассировку, выполните следующую команду:

**tracelog.exe-закончить** *сеанс*

В предыдущем примере имя *сеанса sessionname* совпадает с именем, предоставленным командой, в которой был запущен раздел трассировки.

## <a name="remarks"></a>Комментарии

Более эффективно отслеживать только определенные процессы, указывая определенный PID, чем отслеживать все процессы на компьютере. Если необходимо выполнить трассировку нескольких приложений на одном компьютере, это может повлиять на производительность. в разделах кода, ориентированных на производительность, содержится важный результат отладки. Кроме того, администраторы должны быть внимательны, чтобы правильно задавать разрешения для файлов журнала при трассировке нескольких процессов. в противном случае любой пользователь сможет читать журналы трассировки, а другие пользователи смогут отслеживать процессы, содержащие безопасную информацию.

Например, предположим, что администратор настроит трассировку для приложения «Test.exe» и не укажет идентификатор процесса в реестре для трассировки нескольких экземпляров процесса. Теперь другой пользователь хочет выполнить трассировку приложения "Secure.exe". Если файлы журнала трассировки не ограничены должным образом, все, что нужно сделать, — это переименовать "Secure.exe" в "Test.exe" и будет отслеживаться. Как правило, при устранении неполадок рекомендуется отслеживать только определенные процессы, а также удалять раздел реестра трассировки, как только это делается.

Поскольку при включении трассировки событий создаются дополнительные файлы журналов, администраторы должны внимательно отслеживать размеры файлов журнала. нехватка дискового пространства на локальном компьютере может привести к отказу в обслуживании.

## <a name="example-scenarios"></a>Примеры сценариев

Сценарий 1. администратор видит непредвиденную ошибку в приложении, которое устанавливает пароли для учетных записей пользователей, поэтому для решения проблемы с помощью трассировки событий необходимо выполнить следующие действия.

1.  Напишите сценарий, который воссоздает проблему, и создайте раздел реестра.

    **HKey \_ \_** \\  \\  \\  \\  \\  \\ **cscript.exeа** трассировки ADSI CurrentControlSet Services System на локальном компьютере

2.  Запустите сеанс трассировки, установив для *флагов трассировки* значение 0X2 (**Отладка \_ чанжепассвд**) и *TraceLevel* в 0x4 **( \_ \_ сведения на уровне трассировки**), используя следующую команду:

    **tracelog.exe-Start скрипттраце-GUID \# 7288c9f8-d63c-4932-A345-89d6b060174d-f. \\ ADSI. ETL-флаг 0x2 — уровень 0x4**

3.  Запустите cscript.exe с помощью тестового скрипта, чтобы воспроизвести проблему, а затем завершите сеанс трассировки:

    **tracelog.exe скрипттраце**

4.  Удаление раздела реестра

    **HKey \_ \_** \\  \\  \\  \\  \\  \\ **cscript.exeа** трассировки ADSI CurrentControlSet Services System на локальном компьютере

5.  Запустите средство ETW Tracerpt.exe, чтобы проанализировать данные трассировки из журнала:

    **tracelog.exe-Start скрипттраце-GUID \# 7288c9f8-d63c-4932-A345-89d6b060174d-f. \\ ADSI. ETL-флаг 0x2 — уровень 0x4**

Сценарий 2. администратор хочет отслеживать операции анализа и скачивания схемы в приложении [ASP](https://msdn.microsoft.com/asp.net/default.aspx) с именем w3wp.exe, которое уже выполняется. Для этого администратор должен выполнить следующие действия:

1.  Создание раздела реестра

    **HKey \_ \_** \\  \\  \\  \\  \\  \\ **w3wp.exeа** трассировки ADSI CurrentControlSet Services System на локальном компьютере

    в этом разделе Создайте значение типа DWORD с именем PID и задайте для него идентификатор процесса экземпляра w3wp.exe, который в данный момент выполняется на локальном компьютере.

2.  Затем они создают сеанс трассировки, устанавливая для *флагов трассировки* значение 0x1 **( \_ схема отладки**) и *TraceLevel* в 0x4 **( \_ \_ сведения на уровне трассировки**):

    **tracelog.exe-Start w3wptrace-GUID \# 7288c9f8-d63c-4932-A345-89d6b060174d-f. \\ w3wp. ETL-флаг 0x1 — уровень 0x4**

3.  Воспроизведите операцию, требующую устранения неполадок.
4.  Завершение сеанса трассировки:

    **tracelog.exe w3wptrace**

5.  Удалите раздел реестра **hKey \_ локальный \_ компьютер** \\ **System** \\ **CurrentControlSet** \\ **Services** \\ **ADSI** \\ **Трассировка** \\ **w3wp.exe**.
6.  Запустите средство ETW tracerpt.exe, чтобы проанализировать данные трассировки из журнала:

    **tracerpt.exe. \\ w3wp. ETL-o-отчет**

 

