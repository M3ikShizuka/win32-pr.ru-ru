---
title: Использование API сервера служб развертывания Windows
description: в средах, где стандартное решение служб развертывания Windows (wds) использовать нельзя, сервер WDS предоставляет API, позволяющий разработчикам писать подключаемые модули, называемые поставщиками, для обработки запросов среды выполнения (PXE).
ms.assetid: 5e25654a-33c6-4c0f-acc3-e938d1f4a4e7
keywords:
- Windows службы развертывания Windows служб развертывания с помощью API сервера
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 21ce7516e5279fecdfeecfa90edd8e3a0dad265562fa5ea59336367dbe157c5e
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119999574"
---
# <a name="using-the-windows-deployment-services-server-api"></a>Использование API сервера служб развертывания Windows

в средах, где стандартное решение служб развертывания Windows (wds) использовать нельзя, сервер WDS предоставляет API, позволяющий разработчикам писать подключаемые модули, называемые поставщиками, для обработки запросов среды выполнения (PXE). При написании поставщиков PXE для WDS разработчики должны соблюдать следующие рекомендации.

## <a name="install-the-wds-role-on-the-server"></a>Установка роли WDS на сервере

-   Windows Службы развертывания (WDS) — это пересмотренная версия служб удаленной установки (RIS). для реализации PXE-сервера и поставщиков WDS потребуется роль сервера WDS.
-   WDS заменяет службу RIS стандартным компонентом, начиная с Windows server 2008 и Windows server 2003 с пакетом обновления 2 (SP2).
-   необходимо обновить сервер RIS до WDS на Windows server 2003 с пакетом обновления 1 (SP1). роль сервера WDS можно установить с помощью [пакет автоматической установки Windows (WAIK)](https://www.microsoft.com/download/details.aspx?id=10333).

## <a name="register-providers"></a>Регистрация поставщиков

-   Зарегистрируйте библиотеку динамической компоновки (DLL) поставщика во время установки и вставьте поставщик в упорядоченный список зарегистрированных поставщиков.
    > [!Note]  
    > При установке нового или измененного поставщика необходимо перезапустить службу PXE WDS, чтобы изменения вступили в силу.

     

-   Используйте функцию [**пксепровидеррегистер**](/windows/win32/api/WdsPxe/nf-wdspxe-pxeproviderregister) для регистрации поставщика и его добавления в список. Используйте функцию [**пксепровидерунрегистер**](/windows/win32/api/WdsPxe/nf-wdspxe-pxeproviderunregister) , чтобы отменить регистрацию зарегистрированного поставщика и удалить его из списка.
-   Укажите последовательность поставщика в упорядоченном списке. Индекс поставщика в списке не может быть гарантирован, так как после этого другой поставщик может быть зарегистрирован. Чтобы вставить поставщик в список до или после другого зарегистрированного поставщика, сначала используйте функцию [**пксепровидеркуериндекс**](/windows/win32/api/WdsPxe/nf-wdspxe-pxeproviderqueryindex) для получения индекса зарегистрированного поставщика, а затем зарегистрируйте новый поставщик при указании большего или меньшего значения индекса.
-   Установка может хранить сведения о конфигурации поставщика в разделе реестра, возвращенном при регистрации поставщика. Адрес раздела реестра получен с помощью *Фпровидеркэй* [**пксепровидеррегистер**](/windows/win32/api/WdsPxe/nf-wdspxe-pxeproviderregister). Поставщик получает маркер того же ключа, что и параметр *хпровидеркэй* , в его обратный вызов [*пксепровидеринитиализе*](pxeproviderinitialize.md) . Поставщик должен хранить адрес этого ключа.
-   Всегда устанавливайте библиотеку динамической компоновки (DLL) поставщика в папку Program Files сервера.

## <a name="initialize"></a>Инициализация

-   Включите библиотеку DLL, которая экспортирует функцию обратного вызова [*пксепровидеринитиализе*](pxeproviderinitialize.md) в поставщике. Каждому поставщику требуется обратный вызов *пксепровидеринитиализе* . Когда служба WDS загружает поставщик, она вызывает функцию *пксепровидеринитиализе* поставщика и передает маркер тому же ключу, который используется для хранения сведений о конфигурации во время регистрации поставщика.
-   Когда обратный вызов [*пксепровидеринитиализе*](pxeproviderinitialize.md) возвращает и завершается успешно, поставщик должен быть полностью инициализирован и готов к обработке запросов.
-   Регистрация каждого обратного вызова в поставщике во время обработки функции [*пксепровидеринитиализе*](pxeproviderinitialize.md) . Обратные вызовы должны быть зарегистрированы с помощью функции [**пксерегистеркаллбакк**](/windows/win32/api/WdsPxe/nf-wdspxe-pxeregistercallback) .
-   Инициализируйте все внутренние ресурсы поставщика в процессе обработки своей функции [*пксепровидеринитиализе*](pxeproviderinitialize.md) .

## <a name="shutdown"></a>Shutdown

-   Реализуйте обратный вызов [*пксепровидершутдовн*](pxeprovidershutdown.md) . Каждый поставщик должен иметь обратный вызов *пксепровидершутдовн*.
-   Функция обратного вызова [*пксепровидершутдовн*](pxeprovidershutdown.md) должна полностью завершить работу поставщика и освободить все его ресурсы.
-   После возврата обратного вызова [*пксепровидершутдовн*](pxeprovidershutdown.md) в функцию [*пксепровидеринитиализе*](pxeproviderinitialize.md) передается обработчик *хпровидер* , который не должен использоваться для вызова WDS.
-   Зарегистрируйте обратный вызов [*пксепровидершутдовн*](pxeprovidershutdown.md) , вызвав функцию [**пксерегистеркаллбакк**](/windows/win32/api/WdsPxe/nf-wdspxe-pxeregistercallback) с **\_ \_ завершением обратного вызова PXE** во время обработки обратного вызова [*пксепровидеринитиализе*](pxeproviderinitialize.md) . Не вызывайте обратный вызов *пксепровидершутдовн* в случае сбоя функции *пксепровидеринитиализе* .

## <a name="handle-request-packet"></a>Обработайте пакет запроса

Реализуйте обратный вызов [*пксепровидеррекврекуест*](pxeproviderrecvrequest.md) для поставщика. Каждый поставщик должен иметь обратный вызов *пксепровидеррекврекуест* . Когда WDS получает запрос, он вызывает обратный вызов *пксепровидеррекврекуест* для первого поставщика в списке зарегистрированных поставщиков.

-   Если поставщик будет обрабатывать этот запрос синхронно, функция [*пксепровидеррекврекуест*](pxeproviderrecvrequest.md) должна возвращать значение **ошибки \_ Success**. Если и только в том случае, если поставщик будет обрабатывать этот запрос асинхронно, обратный вызов *пксепровидеррекврекуест* должен возвратить **ошибку \_ ввода-вывода \_ в ожидании** и вызвать функцию [**пксеасинкреквдоне**](/windows/win32/api/WdsPxe/nf-wdspxe-pxeasyncrecvdone) при обработке запроса.
-   Обратный вызов [*пксепровидеррекврекуест*](pxeproviderrecvrequest.md) и функция [**пксеасинкреквдоне**](/windows/win32/api/WdsPxe/nf-wdspxe-pxeasyncrecvdone) возвращают адрес перечисления PXE для **\_ \_ операции загрузки** , описывающий действие, выполняемое поставщиком для выполнения запроса.

    Существует четыре способа, с помощью которых поставщик обрабатывает запрос:

    -   Поставщик отвечает на клиент с помощью стандартного пакета ответа DHCP, который содержит путь к программе сетевой загрузки. Возврат значения **\_ \_ NBP для протокола PXE** для перечисления означает, что поставщик успешно обработал пакет запроса и выполнил запрос, отправив ответный пакет, вызвав функции [**пксепаккеталлокате**](/windows/win32/api/WdsPxe/nf-wdspxe-pxepacketallocate) и [**пксесендрепли**](/windows/win32/api/WdsPxe/nf-wdspxe-pxesendreply) .
    -   Поставщик отвечает на клиент с пользовательским пакетом ответа, который не соответствует DHCP. Возвращение **\_ \_ настраиваемого** значения для типа PXE Ба для перечисления означает, что поставщик успешно обработал пакет запроса и выполнил запрос, отправив пользовательский пакет ответа путем вызова функций [**пксепаккеталлокате**](/windows/win32/api/WdsPxe/nf-wdspxe-pxepacketallocate) и [**пксесендрепли**](/windows/win32/api/WdsPxe/nf-wdspxe-pxesendreply) .
    -   Поставщик определяет, что запрос следует игнорировать. Возврат значения **\_ \_ игнорирования протокола PXE Ба** для перечисления означает, что поставщик освободил все ресурсы, связанные с запросом, и запрос не передается следующему поставщику в списке зарегистрированных поставщиков. Поставщики могут использовать этот параметр, если обнаруживают, что пакет запроса является недопустимым.
    -   Поставщик отклоняет обслуживание запроса. Возврат значения **\_ \_ отклонения протокола PXE Ба** для перечисления дает системе команду передать запрос следующему поставщику в списке зарегистрированных поставщиков. Если это последний поставщик в списке, то освобождает все ресурсы, связанные с запросом, и запрос игнорируется.
    -   Зарегистрируйте обратный вызов [*пксепровидеррекврекуест*](pxeproviderrecvrequest.md) , вызвав функцию [**пксерегистеркаллбакк**](/windows/win32/api/WdsPxe/nf-wdspxe-pxeregistercallback) с **\_ \_ \_ запросом обратного вызова PXE** во время обработки обратного вызова [*пксепровидеринитиализе*](pxeproviderinitialize.md) .

## <a name="generate-response-packet"></a>Создать ответный пакет

-   Используйте API для записи поставщиков на обработку запросов DHCP и создания пакетов ответа.
-   Функция [**пксепровидерсетаттрибуте**](/windows/win32/api/WdsPxe/nf-wdspxe-pxeprovidersetattribute) указывает атрибуты, используемые поставщиком для фильтрации пакетов. Можно указать атрибуты поставщика, чтобы поставщик мог видеть все пакеты, поставщик видит только пакеты DHCP, или поставщик видит только пакеты DHCP, в которых указан параметр идентификатора класса вендора DHCP (60) как "Пксеклиент".
-   Функция [**пкседхкписвалид**](/windows/win32/api/WdsPxe/nf-wdspxe-pxedhcpisvalid) проверяет, является ли пакет допустимым пакетом DHCP. Поставщики могут использовать функцию **пкседхкписвалид** для проверки того, является ли пакет клиентом DHCP-пакетом, если фильтр, заданный функцией [**пксепровидерсетаттрибуте**](/windows/win32/api/WdsPxe/nf-wdspxe-pxeprovidersetattribute) , настроен на получение всех пакетов, чтобы определить, является ли указанный пакет допустимым пакетом DHCP.
-   Функция [**пкседхкпинитиализе**](/windows/win32/api/WdsPxe/nf-wdspxe-pxedhcpinitialize) инициализирует ответный пакет как пакет ответа DHCP, основанный на данных пакета, полученного от клиента. Функция [*пксепровидеринитиализе*](pxeproviderinitialize.md) принимает адрес допустимого DHCP-пакета, полученного от клиента в ответном вызове [*пксепровидеррекврекуест*](pxeproviderrecvrequest.md) . Функция **пкседхкпинитиализе** принимает указатель на ответный пакет, выделенный с помощью функции [**пксепаккеталлокате**](/windows/win32/api/WdsPxe/nf-wdspxe-pxepacketallocate) .
-   Функция [**пкседхкпжетоптионвалуе**](/windows/win32/api/WdsPxe/nf-wdspxe-pxedhcpgetoptionvalue) извлекает значение параметра из пакета DHCP. Функция [**пкседхкпжетвендороптионвалуе**](/windows/win32/api/WdsPxe/nf-wdspxe-pxedhcpgetvendoroptionvalue) извлекает значение параметра из поля сведений о конкретном поставщике (43) пакета DHCP.
-   Затем поставщик может заполнить ответный пакет информацией и использовать функцию [**пксесендрепли**](/windows/win32/api/WdsPxe/nf-wdspxe-pxesendreply) для отправки ответного пакета клиенту. Функция [**пкседхкпаппендоптион**](/windows/win32/api/WdsPxe/nf-wdspxe-pxedhcpappendoption) добавляет параметр DHCP в ответный пакет.
-   Поставщик, отвечающий на клиентские запросы путем отправки пакета, должен выделить ответный пакет с помощью функции [**пксепаккеталлокате**](/windows/win32/api/WdsPxe/nf-wdspxe-pxepacketallocate) . Затем поставщик может заполнить ответный пакет информацией и использовать функцию [**пксесендрепли**](/windows/win32/api/WdsPxe/nf-wdspxe-pxesendreply) для отправки ответного пакета клиенту.
-   Если выделенная память больше не нужна, поставщик должен освободить его с помощью функции [**пксепаккетфри**](/windows/win32/api/WdsPxe/nf-wdspxe-pxepacketfree) .

## <a name="enumerate-registered-providers"></a>Перечисление зарегистрированных поставщиков

-   Используйте API для записи поставщиков, которые перечисляют и проверяют другие зарегистрированные поставщики в списке.
-   Функция [**пксежетсерверинфо**](/windows/win32/api/WdsPxe/nf-wdspxe-pxegetserverinfo) возвращает сведения о PXE-сервере. Функция **пксежетсерверинфо** возвращает **логическое** значение, указывающее, включена ли трассировка для сервера. **Значение true** указывает, что трассировка включена.
-   Функция [**пксепровидеренумфирст**](/windows/win32/api/WdsPxe/nf-wdspxe-pxeproviderenumfirst) запускает поставщиков енумератионоф в списке зарегистрированных поставщиков. Функция **пксепровидеренумфирст** запускает перечисление и возвращает адрес маркера, который должен использоваться при вызове функции [**пксепровидеренумнекст**](/windows/win32/api/WdsPxe/nf-wdspxe-pxeproviderenumnext) . Функция **пксепровидеренумнекст** возвращает структуру [**\_ поставщика PXE**](/windows/win32/api/wdspxe/ns-wdspxe-pxe_provider) , содержащую сведения о поставщике. Функция [**пксепровидерфриинфо**](/windows/win32/api/WdsPxe/nf-wdspxe-pxeproviderfreeinfo) освобождает память, выделенную для структуры **\_ поставщика PXE** функцией **пксепровидеренумнекст** . Функция [**пксепровидеренумклосе**](/windows/win32/api/WdsPxe/nf-wdspxe-pxeproviderenumclose) закрывает перечисление поставщиков в списке зарегистрированных поставщиков.

## <a name="handle-service-control-codes"></a>Обработку кодов управления службами

-   При получении сообщения управления службой WDS вызывает обратный вызов [*пксепровидерсервицеконтрол*](pxeproviderservicecontrol.md) .
-   Поставщик может определить функцию обратного вызова [*пксепровидерсервицеконтрол*](pxeproviderservicecontrol.md) для работы с сообщениями управления службами.
-   Зарегистрируйте обратный вызов [*пксепровидерсервицеконтрол*](pxeproviderservicecontrol.md) , вызвав функцию [**пксерегистеркаллбакк**](/windows/win32/api/WdsPxe/nf-wdspxe-pxeregistercallback) с **\_ \_ \_ контролем обратного вызова PXE** во время обработки обратного вызова [*пксепровидеринитиализе*](pxeproviderinitialize.md) .

## <a name="add-trace-entries-to-pxe-log"></a>Добавление записей трассировки в журнал PXE

-   Функция [**пксетраце**](/windows/win32/api/WdsPxe/nf-wdspxe-pxetrace) добавляет запись трассировки в журнал PXE. ВДСПКСЕ предоставляет трассировку, помогающую администраторам в устранении неполадок. Поставщики могут регистрировать записи трассировки с разными уровнями серьезности. Администраторы могут настроить ВДСПКСЕ на запись только тех записей, которые имеют определенный уровень серьезности.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[сведения об API служб развертывания Windows](about-the-windows-deployment-services-api.md)
</dt> <dt>

[Использование API клиента служб развертывания Windows](using-the-windows-deployment-services-client-api.md)
</dt> </dl>

 

 




