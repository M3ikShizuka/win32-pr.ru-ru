---
title: Буферизируемые службы
description: Буферизируемые службы
ms.assetid: 4816ab05-42fc-4c22-b753-8fd153d88c27
keywords:
- файловые операции ввода-вывода мультимедиа, буферизованные службы
- файловый ввод-вывод, буферизованные службы
- входные и выходные данные (ввод-вывод), буферизованные службы
- Ввод-вывод (входные и выходные данные), буферизованные службы
- буферизованный ввод-вывод
- Функция Ммиупен
- внутренний буфер ввода-вывода
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 67f8e7c11dbc90f7090bc8fcee114ebfac79f9bd54d834203f4b8e7bf893f591
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "117989418"
---
# <a name="buffered-services"></a>Буферизируемые службы

Большая часть издержек в файловых операциях ввода-вывода возникает при доступе к устройству мультимедиа. При чтении или записи большого количества мелких блоков информации устройство может потратить много времени на перемещение в физическое место на носителе для каждой операции чтения или записи. В этом случае можно повысить производительность с помощью буферизованных файловых операций ввода-вывода. При буферизованном вводе-выводе диспетчер файлового ввода-вывода обслуживает промежуточный буфер, превышающий количество блоков данных, которые вы читаете или пишете. Он обращается к устройству только в том случае, если буфер должен быть заполнен или записан на диск.

Перед настройкой и использованием буферизованного файлового ввода-вывода необходимо решить, нужно ли, чтобы Файловый диспетчер ввода-вывода или приложение выделили буфер. Проще позволить диспетчеру файлового ввода-вывода выделить буфер. Однако можно позволить приложению выделить буфер, если требуется получить прямой доступ к буферу или открыть файл памяти. Дополнительные сведения об использовании файлов памяти см. в разделе [выполнение операций файлового ввода-вывода в памяти](performing-memory-file-i-o.md). Пример прямого доступа к буферу ввода-вывода см. в разделе [доступ к буферу файлового ввода-вывода](accessing-a-file-i-o-buffer.md) .

Буфер, выделенный диспетчером файлового ввода-вывода, называется внутренним буфером ввода-вывода. Чтобы открыть файл для буферизованного ввода-вывода с помощью внутреннего буфера, укажите \_ флаг АЛЛОКБУФ MMIO при открытии файла с помощью функции [**ммиупен**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioopen) . На следующем рисунке показано начальное состояние буфера файлового ввода-вывода после открытия файла для буферизованной операции чтения. Буферизация прозрачна — вы читаете и ищете, как если бы вы использовали операции ввода-вывода без буферизации. Функция **ммиупен** установила Пчнекст и *пчендреад* , указывающие на начало буфера файлового ввода-вывода.

![Снимок экрана, на котором показаны "Пчендреад" и "Пчнекст", указывающие на начало буфера файлового ввода-вывода.](images/mmio7.gif)

На следующем рисунке показано начальное состояние буфера файлового ввода-вывода после открытия файла для буферизованной операции записи. Функция **ммиупен** установила **пчнекст** , чтобы она указывала на начало буфера файлового ввода-вывода и **пчендврите** , чтобы она указывала на конец буфера.

![Снимок экрана, показывающий "Пчнекст" в начале буфера файлового ввода-вывода и "Пчендврите" в конце.](images/mmio11.gif)

Размер внутреннего буфера ввода-вывода по умолчанию — 8 КБ. Если этот размер недостаточен, можно использовать функцию [**ммиосетбуффер**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiosetbuffer) для изменения размера буфера. Эту функцию также можно использовать для включения буферизации файла, открытого для небуферизованного ввода-вывода, или для предоставления собственного буфера для использования в качестве файла памяти.

Можно принудительно записать содержимое буфера ввода-вывода на диск с помощью функции [**ммиофлуш**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioflush) . Однако при закрытии файла с помощью функции [**ммиоклосе**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioclose) нет необходимости вызывать **ммиофлуш** для записи буфера ввода-вывода — функция **ммиоклосе** автоматически сбрасывает ее. Если закончилось место на диске, **ммиофлуш** может завершиться сбоем, даже если предыдущие вызовы функции [**ммиоврите**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiowrite) были успешными. Аналогично, **ммиоклосе** может завершиться ошибкой, когда записывает буфер ввода-вывода.

Приложения с учетом производительности, такие как потоковая передача данных с компакт-диска в реальном времени, могут оптимизировать производительность файлового ввода-вывода путем прямого доступа к буферу ввода-вывода. Следует быть внимательным, если вы решили это сделать, так как вы обходите некоторые меры защиты и проверку ошибок, предоставляемые диспетчером файлового ввода-вывода.

Диспетчер файлового ввода-вывода мультимедиа использует структуру [**ммиоинфо**](/previous-versions//dd757322(v=vs.85)) для сохранения сведений о состоянии открытого файла. Для чтения и записи буфера ввода-вывода используются три члена этой структуры: **пчнекст**, **пчендреад** и **пчендврите**. Элемент **пчнекст** указывает на следующее место в буфере для чтения или записи. Необходимо увеличить этот элемент при чтении и записи буфера. Элемент **пчендреад** определяет последний допустимый символ, который можно прочитать из буфера. Аналогичным образом, этот член определяет Последнее расположение в буфере, которое можно написать. Точнее, как **пчендреад** , так и **пчендврите** указывают на расположение в памяти, следующее за последними допустимыми данными в буфере. Используйте функции [**ммиожетинфо**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiogetinfo) и [**ммиосетинфо**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiosetinfo) для получения и задания сведений о состоянии буфера файлового ввода-вывода. На следующем рисунке показано состояние буфера ввода-вывода после того, как приложение вызовет **ммиоадванце** во время операции чтения. Функция **ммиоадванце** заполняет буфер и устанавливает указатель **пчендреад** на конец буфера.

![Снимок экрана, показывающий "Пчнекст" в начале буфера файлового ввода-вывода и "Пчендреад" в конце.](images/mmio8.gif)

На следующем рисунке приложение считывает данные из буфера ввода-вывода в расположении, указанном параметром **пчнекст**, и перемещает указатель.

![Снимок экрана, показывающий "Пчнекст" в середине буфера файлового ввода-вывода и "Пчендреад" в конце.](images/mmio9.gif)

Аналогично для операции записи приложение выполняет запись в буфер ввода-вывода и перемещает указатель **пчнекст** , как показано на следующем рисунке.

![Снимок экрана, показывающий "Пчнекст" в середине буфера файлового ввода-вывода и "Пчендврите" в конце.](images/mmio12.gif)

После заполнения буфера приложением вызывается **ммиоадванце** для записи буфера на диск. Функция **ммиоадванце** сбрасывает **пчнекст** , чтобы указывать на начало буфера, как показано на следующем рисунке.

![Снимок экрана, показывающий "Пчнекст" в начале буфера файлового ввода-вывода, буфер в середине E O F и "Пчендврите" в конце буфера.](images/mmio13.gif)

Когда вы дойдете до конца буфера ввода-вывода, необходимо передвинуть буфер, чтобы его заполнить с диска, если выполняется чтение, или записать на диск при записи. Чтобы переместить буфер ввода-вывода, используйте функцию [**ммиоадванце**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioadvance) . Чтобы заполнить буфер ввода-вывода с диска, используйте **ммиоадванце** с \_ флагом MMIO Read. Если в файле осталось недостаточно данных для заполнения буфера, элемент **пчендреад** структуры **ммиоинфо** указывает на расположение, следующее за последним допустимым байтом в буфере. Чтобы сбросить буфер на диск, установите \_ флаг MMIO "грязный" в элементе **DwFlags** структуры **ммиоинфо** , а затем вызовите **ммиоадванце** с \_ флагом записи MMIO.

Например, во время операции чтения функция **ммиоадванце** задает **пчендреад** для указания на конец допустимых данных в буфере, как показано на следующем рисунке.

![Снимок экрана, показывающий "Пчнекст" в начале буфера файлового ввода-вывода, буфер в конце E O F и "Пчендреад" в конце буфера.](images/mmio10.gif)

Аналогичным образом во время операции записи приложение вызывает **ммиоадванце** , чтобы очистить буфер и продвинуть **пчнекст** до конца допустимых данных в буфере, как показано на следующем рисунке.

![изображение буфера файлового ввода-вывода](images/mmio14.gif)

 

 