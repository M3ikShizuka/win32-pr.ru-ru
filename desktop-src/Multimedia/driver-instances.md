---
title: Экземпляры драйверов
description: Экземпляры драйверов
ms.assetid: 93dba9e8-bfb3-4714-9466-cf5c78babcf2
keywords:
- устанавливаемые драйверы, экземпляры
- устанавливаемые драйверы, несколько экземпляров
- несколько экземпляров драйверов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 37148dcb12fbfa2984d4e55424102b5985165d9d
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "103775125"
---
# <a name="driver-instances"></a>Экземпляры драйверов

Windows поддерживает несколько экземпляров устанавливаемого драйвера. Система создает экземпляр драйвера каждый раз при открытии драйвера и уничтожает экземпляр при закрытии драйвера. Экземпляры драйверов особенно полезны для устанавливаемых драйверов, которые поддерживают несколько устройств или могут быть открыты несколькими приложениями или одним приложением несколько раз.

Чтобы помочь драйверу отследить экземпляры, система отправляет обработчик экземпляров драйвера с каждым сообщением драйвера после создания экземпляра. Поскольку этот обработчик уникально идентифицирует экземпляр, устанавливаемые драйверы часто связывают этот обработчик с памятью и другими ресурсами, которые были специально выделены для экземпляра.

При открытии первого экземпляра система отправляет в драйвер в указанном порядке все [**\_ открытые**](drv-open.md) сообщения с помощью [**\_ перегрузки DRV**](drv-load.md), [**DRV \_ Enable**](drv-enable.md)и DRV. Сообщения DRV \_ Load и DRV \_ Enable позволяют уведомить драйвер о том, что он теперь находится в памяти и включен для работы. Сообщение с \_ открытым кодом DRV определяет экземпляр обработчика и может включать сведения о конфигурации для экземпляра. При каждом последующем открытии экземпляра одного и того же драйвера система отправляет только сообщение, открытое в виде DRV \_ .

При обработке \_ сообщения загрузки DRV драйвер, как правило, считывает параметры конфигурации из реестра, настраивает драйвер и соответствующее оборудование и выделяет память для использования всеми экземплярами драйвера. Если драйвер не может завершить настройку или выделить память, он возвращает нуль, чтобы направить систему на немедленное удаление драйвера из памяти и предотвратить отправку последующих сообщений. При обработке сообщения с \_ включенным параметром DRV драйвер подготавливает оборудование для приема и обработки запросов ввода-вывода. Подготовка может включать в себя установку обработчиков прерываний.

При обработке сообщения DRV \_ Open драйвер выделяет память или ресурсы, необходимые данному экземпляру драйвера, а затем возвращает ненулевое значение. Система использует это ненулевое значение в качестве *идентификатора драйвера* в последующих сообщениях драйвера для экземпляра. Драйвер может использовать этот идентификатор для любой цели. Например, некоторые драйверы используют для идентификатора маркер памяти, чтобы получить быстрый доступ к памяти, содержащей сведения о данном экземпляре.

Многие устанавливаемые драйверы обрабатывают второй параметр \_ сообщения DRV Open, предоставляя системе и приложениям возможность отправки дополнительных сведений драйверу при открытии экземпляра. Параметр может быть одиночным значением или адресом структуры, содержащей набор значений. При обработке DRV \_ Open драйвер проверяет параметр, чтобы определить, является ли он значением, и использует заданные значения (если таковые имеются) для завершения создания экземпляра.

Система отправляет сообщение [**\_ закрытия DRV**](drv-close.md) каждый раз при закрытии экземпляра. Обработчик экземпляра, отправленный с сообщением, определяет, какой экземпляр нужно закрыть. Когда последний оставшийся экземпляр закрывается, система отправляет \_ в этом порядке [**\_ Бесплатные**](drv-free.md) сообщения, которые [**\_ отключаются**](drv-disable.md)к Close, DRV и DRV. \_Сообщение о закрытии DRV указывает драйверу закрыть экземпляр, а \_ сообщения, отключенные и DRV, \_ не уведомлят драйвер о том, что он сейчас отключен и будет немедленно освобожден из памяти.

При обработке сообщения о \_ закрытии DRV драйвер, как правило, освобождает память или ресурсы, выделенные для экземпляра. При обработке \_ сообщения об отключении DRV драйвер помещает любое оборудование в неактивное состояние, которое может включать удаление обработчиков прерываний. При обработке сообщения DRV \_ Free драйвер освобождает память или ресурсы, которые все еще выделены.

Устанавливаемые драйверы не обязательно должны поддерживать несколько экземпляров. Драйвер может препятствовать созданию экземпляра, возвращая нулевое значение для открытого сообщения [**DRV \_**](drv-open.md) .

 

 




