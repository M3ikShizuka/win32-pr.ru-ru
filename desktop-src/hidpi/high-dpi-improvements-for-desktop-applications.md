---
title: Масштабирование Mixed-Mode DPI и API с поддержкой DPI
description: Масштабирование Mixed-Mode DPI и API с поддержкой DPI
ms.assetid: 44AC0B29-3283-4801-90F5-3E78CCD87B9F
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 2244ea79d489ae1e20260f72336c15bc64b97de0
ms.sourcegitcommit: 95685061d5b0333bbf9e6ebd208dde8190f97005
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2021
ms.locfileid: "108090102"
---
# <a name="mixed-mode-dpi-scaling-and-dpi-aware-apis"></a>Масштабирование Mixed-Mode DPI и API с поддержкой DPI

## <a name="sub-process-dpi-awareness-support"></a>Поддержка поддержки Sub-Process DPI

[**Сетсреаддпиаваренессконтекст**](/windows/desktop/api/Winuser/nf-winuser-setthreaddpiawarenesscontext) позволяет использовать различные режимы масштабирования DPI в рамках одного процесса. До наступления годовщины Windows 10 система отслеживания DPI в окне была привязана к режиму поддержки DPI в масштабе всего процесса (не учитывает DPI, DPI на уровне системы или Per-Monitor DPI). Но теперь, когда **сетсреаддпиаваренессконтекст**, окна верхнего уровня могут иметь режим поддержки dpi, отличный от режима поддержки dpi в масштабе процесса. Это также влияет на дочерние окна, так как они всегда будут иметь тот же режим поддержки DPI, что и их родительское окно.

Использование **сетсреаддпиаваренессконтекст** позволяет разработчикам решить, где нужно сосредоточиться на разработке при определении поведения для настольных приложений в различных масштабах. Например, основное окно приложения верхнего уровня можно масштабировать на отдельном мониторе, в то время как вторичные окна верхнего уровня можно масштабировать с помощью масштабирования по точечным рисункам операционной системы.

## <a name="the-dpi-awareness-context"></a>Контекст осведомленности о DPI

До уровня доступности **сетсреаддпиаваренессконтекст** сведения о dpi для процесса были определены либо в манифесте двоичного файла приложения, либо посредством вызова [**сетпроцессдпиаваренесс**](/windows/desktop/api/ShellScalingAPI/nf-shellscalingapi-setprocessdpiawareness) во время инициализации процесса. При использовании **сетсреаддпиаваренессконтекст** каждый поток может иметь контекст осведомленности об уровне dpi, который может отличаться от контекста режима поддержки dpi в масштабе процесса. Контекст, осведомленный о DPI в потоке, представлен с типом * * * *, [ \_ \_ осведомленности о dpi](dpi-awareness-context.md) , и ведет себя следующим образом:

-   В любой момент времени в потоке может быть изменен контекст осведомленности о DPI.
-   Любые вызовы API, сделанные после изменения контекста, будут выполняться в соответствующем контексте DPI (и могут быть виртуализированы).
-   При создании окна его поддержка DPI определяется как осведомленность о DPI вызывающего потока в это время.
-   При вызове окна процедуры для окна поток автоматически переключается на контекст осведомленности о DPI, который использовался при создании окна.

Распространенным сценарием использования **сетсреаддпиаваренессконтекст** является следующее: начать с потока, который выполняется с одним контекстом (например, **\_ контекст осведомленности о dpi \_ \_ на \_ монитор \_**), временно переключиться в другой контекст (неосведомленный **\_ \_ контекст \_ о dpi**), создать окно, а затем немедленно переключить контекст потока обратно в предыдущее состояние. Созданное окно будет иметь контекст DPI в **\_ \_ контексте \_ осведомленности о dpi**, в то время как контекст вызывающего потока s будет восстановлен в **\_ контексте осведомленности \_ \_ \_ \_ о мониторинге на монитор** при последующем вызове **сетсреаддпиаваренессконтекст**. В этом сценарии окно, связанное с вызывающим потоком, будет выполняться с контекстом для каждого монитора (и, следовательно, не будет растягиваться операционной системой), тогда как только что созданное окно не будет поддерживать DPI (и, следовательно, будет автоматически растягиваться в наборе отображения на >100% масштабирования).

На рис. 1 показано, как основной поток процесса выполняется **с \_ контекстом осведомленности о dpi \_ \_ на \_ мониторе**, переключается в контекст **\_ осведомленности \_ \_** о несоответствии контекста и создает новое окно. Вновь созданное окно затем выполняется с контекстом, осведомленным об уровне dpi, независимо от того, отправляется ли сообщение в него или когда в него вносятся вызовы API. **\_ \_ \_** Сразу после создания нового окна основной поток восстанавливается до предыдущего контекста в **\_ контексте осведомленности о dpi \_ для \_ каждого \_ монитора**.

![Схема, показывающая осведомленность о dpi на уровне каждого монитора в действии](images/dpi-awareness-context.png)

## <a name="new-dpi-related-apis"></a>Новые API-интерфейсы, связанные с DPI

Помимо поддержки различных режимов определения DPI в рамках одного процесса, **сетсреаддпиаваренессконтекст** предложение, для классических приложений добавлены следующие функции, относящиеся к DPI:<dl> <dd>[Енабленонклиентдпискалинг * * * *](/windows/desktop/api/Winuser/nf-winuser-enablenonclientdpiscaling)<dl> <dt>



> [!Note]  
> Режим поддержки **каждого монитора версии 2** dpi автоматически включает эту функцию, и вызов **енабленонклиентдпискалинг** , следовательно, не требуется в приложениях, использующих его.

 

Вызов **енабленонклиентдпискалинг** из обработчика Window s **WM \_ нккреате** приведет к тому, что неклиентская область окна верхнего уровня автоматически масштабируется для dpi. Если окно верхнего уровня ориентировано на контроль DPI (независимо от того, является ли сам процесс ориентированным на контроль DPI или если окно было создано в рамках потока с поддержкой DPI для каждого монитора), строка заголовка, полосы прокрутки, меню и строки меню этих окон будут масштабироваться при каждом изменении DPI в Window s.
</dt> <dt>

Обратите внимание, что неклиентские области дочернего окна, например неклиентские полосы прокрутки дочернего элемента управления "текст", не будут автоматически масштабироваться при использовании этого API.
</dt> <dt>

> [!Note]  
> **Енабленонклиентдпискалинг** должен вызываться из обработчика **\_ нккреате WM** .

</dt> </dl> </dd> <dd> <b> API-интерфейсы Фордпи </b>

-   Несколько часто используемых интерфейсов API, таких как [**жетсистемметрикс**](/windows/desktop/api/winuser/nf-winuser-getsystemmetrics) , не имеют контекста HWND и поэтому не имеют возможности вычислить соответствующую информацию о dpi для возвращаемых значений. Вызов этих API из потока, который выполняется в другом режиме поддержки DPI или в контексте, может возвращать значения, которые не масштабируются для контекста вызывающего потока. [* * * * Жетсистемметрикфордпи * *](/windows/desktop/api/Winuser/nf-winuser-getsystemmetricsfordpi)* *, * * * * [системпараметерсинфофордпи * *](/windows/desktop/api/Winuser/nf-winuser-systemparametersinfofordpi)* *, и [* * * * аджуствиндовректексфордпи * *](/windows/desktop/api/Winuser/nf-winuser-adjustwindowrectexfordpi) * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
-   **Жетсистемметрикфордпи** и **системпараметерсинфофордпи** будут возвращать значения системной метрики масштабирования DPI и значения системного параметра в соответствии с этим уравнением:

    |                                                                 |
    |-----------------------------------------------------------------|
    | Жетсистемметрикс (...) @ dpi = = Жетсистемметриксфордпи (..., DPI) |

    

     

    Таким образом, при вызове **жетсистемметрикс** (или **системпараметерсинфофордпи**) при выполнении на устройстве с определенным значением dpi на уровне системы будет возвращено то же значение, что и их варианты, учитывающие dpi (**жетсистемметриксфордпи** и **системпараметерсинфофордпи**), с учетом того же значения DPI, что и входные данные.

-   [**Аджуствиндовректексфордпи**](/windows/desktop/api/Winuser/nf-winuser-adjustwindowrectexfordpi) принимает HWND и вычисляет требуемый размер прямоугольника окна с учетом dpi.

</dd> <dd>

</dd> <dd><b><a href="/windows/desktop/api/Winuser/nf-winuser-getdpiforwindow">жетдпифорвиндов</a></b><dl> <dt><b>Жетдпифорвиндов</b> будет возвращать значение dpi, связанное с ПРЕДОСТАВЛЕНным дескриптором HWND. Ответ будет зависеть от режима поддержки DPI для HWND:

| Режим поддержки точек на дюйм для HWND | Возвращаемое значение                                                                                                                                                                                                  |
|----------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Связан                    | 96                                                                                                                                                                                                            |
| Система                     | DPI на уровне системы                                                                                                                                                                                                |
| Per-Monitor                | РАЗРЕШЕНИЕ экрана, в котором в первую очередь размещается связанное окно верхнего уровня <br/> (Если указано дочернее окно, будет возвращено значение DPI соответствующего родительского окна верхнего уровня).<br/> |

</dt> </dl> </dd> <dd><b><a href="/windows/desktop/api/Winuser/nf-winuser-getdpiforsystem">жетдпифорсистем</a></b><dl> <dt>

Вызов **жетдпифорсистем** более эффективен, чем вызов [**GetDC**](/windows/desktop/api/winuser/nf-winuser-getdc) и [**жетдевицекапс**](/windows/desktop/api/wingdi/nf-wingdi-getdevicecaps) для получения dpi системы.
</dt> <dt>

Любой компонент, который может выполняться в приложении, использующем осведомленность о DPI в подпроцессах, не должен рассчитывать на то, что значение DPI системы является статическим во время жизненного цикла процесса. Например, если поток, который выполняется в **\_ контексте осведомленности \_ \_** о том, что контекст неосведомленен о том, запрашивает dpi на уровне системы, ответ будет 96. Тем не менее, если тот же поток переключился на контекст осведомленности о состоянии **\_ \_ \_ системы** и не запрашивает dpi на уровне системы, ответ может отличаться. Чтобы избежать использования кэшированного (и, возможно, устаревшего) значения системного DPI, используйте **жетдпифорсистем** , чтобы получить значение dpi системы относительно режима поддержки dpi вызывающего потока. 
</dt> </dl> </dd> </dl>
