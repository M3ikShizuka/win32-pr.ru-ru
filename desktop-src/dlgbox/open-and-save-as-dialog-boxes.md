---
title: Открытие и сохранение диалоговых окон
description: Диалоговое окно Открыть позволяет пользователю указать диск, каталог и имя файла или набора файлов, которые нужно открыть.
ms.assetid: 5676ca9d-daca-40bf-8881-def2ff841c58
keywords:
- Библиотека общих диалоговых окон
- Общие диалоговые окна
- Диалоговое окно “Открыть”
- диалоговое окно «Сохранить как»
- Настройка диалогового окна «открыть»
- Настройка диалогового окна «Сохранить как»
- Открытые диалоговые окна
- диалоговые окна, сохранить как
ms.topic: article
ms.date: 05/31/2018
ms.custom: project-verbatim
ms.openlocfilehash: 57f1986f950650840ff3acfc9ee19191088e0dcbe099fc4cb8b21690fa0646c0
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119606313"
---
# <a name="open-and-save-as-dialog-boxes"></a>Открытие и сохранение диалоговых окон

> [!NOTE]
> Функция [**GetOpenFilename**](/windows/desktop/api/Commdlg/nf-commdlg-getopenfilenamea) показана в файле, который используется в качестве [примера](https://github.com/microsoft/Windows-classic-samples/tree/master/Samples/Win7Samples/winui/shell/appplatform/fileisinuse).

\[начиная с Windows Vista общие диалоговые окна " **открыть** " и " **сохранить как** " были заменены [диалоговым окном общих элементов](../shell/common-file-dialog.md). Рекомендуется использовать API-интерфейс общего элемента, а не эти диалоговые окна из библиотеки общих диалоговых окон.\]

Диалоговое окно **Открыть** позволяет пользователю указать диск, каталог и имя файла или набора файлов, которые нужно открыть. Вы создаете и отображаете **открытое** диалоговое окно, инициализируя структуру [**OpenFileName**](/windows/win32/api/commdlg/ns-commdlg-openfilenamea) и передавая структуру в функцию [**GetOpenFilename**](/windows/desktop/api/Commdlg/nf-commdlg-getopenfilenamea) .

Диалоговое окно **Сохранить как** позволяет пользователю указать диск, каталог и имя сохраняемого файла. Вы создаете и отображаете диалоговое окно **Сохранить как** , инициализируя структуру [**OpenFileName**](/windows/win32/api/commdlg/ns-commdlg-openfilenamea) и передавая структуру в функцию [**жетсавефиленаме**](/windows/desktop/api/Commdlg/nf-commdlg-getsavefilenamea) .

в диалоговых окнах " **открыть** " и " **сохранить как** " обозревателя представлены функции пользовательского интерфейса, аналогичные проводнику Windows. Однако система по-прежнему поддерживает диалоговые окна **открытия** и **сохранения** старого стиля для приложений, которые должны быть совместимы с пользовательским интерфейсом старого стиля.

В дополнение к различиям в внешнем виде диалоговые окна в стиле обозревателя и старого стиля отличаются использованием пользовательских шаблонов и процедур подключения для настройки диалоговых окон. Однако диалоговые окна в стиле обозревателя и старого стиля имеют одинаковое поведение для большинства основных операций, таких как указание фильтра имен файлов, проверка вводимых пользователем данных и получение имени файла, указанного пользователем. Дополнительные сведения о диалоговых окнах «Обозреватель-стиль» и «старый стиль» см. в разделе [Настройка диалоговых окон «Открыть» и «сохранить как](#open-and-save-as-dialog-box-customization)».

На следующем рисунке показано типичное диалоговое окно « **Открыть** в стиле обозревателя».

![диалоговое окно «Открытие файла»](images/opendialogboxxp.png)

На следующем рисунке показано типичное диалоговое окно « **Сохранение в** стиле обозревателя».

![диалоговое окно «Сохранение файла»](images/saveasdialogboxxp.png)

Если пользователь задает имя файла и нажимает кнопку **ОК** , [**GetOpenFilename**](/windows/desktop/api/Commdlg/nf-commdlg-getopenfilenamea) или [**жетсавефиленаме**](/windows/desktop/api/Commdlg/nf-commdlg-getsavefilenamea) возвращает **значение true**. Буфер, на который указывает член **указанный** структуры [**OpenFileName**](/windows/win32/api/commdlg/ns-commdlg-openfilenamea) , содержит полный путь и имя файла, указанные пользователем.

Если пользователь отменяет диалоговое окно **Открыть** или **Сохранить как** или возникает ошибка, функция возвращает **значение false**. Чтобы определить причину ошибки, вызовите функцию [**коммдлжекстендедеррор**](/windows/desktop/api/Commdlg/nf-commdlg-commdlgextendederror) , чтобы получить расширенное значение ошибки. Если буфер **указанный** слишком мал для получения полного имени, **коммдлжекстендедеррор** возвращает **фнерр \_ буффертусмалл** , а первые 2 байта буфера, на который указывает элемент **указанный** , устанавливаются в целочисленное значение, определяющее размер, необходимый для получения полного имени.

В этом разделе рассматриваются следующие темы.

-   [Имена файлов и каталоги](#file-names-and-directories)
-   [Фильтры](#filters)
-   [Проверка файлов и каталогов](#file-and-directory-validation)
-   [Настройка диалогового окна "открыть и сохранить как"](#open-and-save-as-dialog-box-customization)
-   [Процедуры-обработчики в стиле обозревателя](#explorer-style-hook-procedures)
-   [Пользовательские шаблоны в стиле обозревателя](#explorer-style-custom-templates)
-   [Идентификаторы элементов управления в стиле обозревателя](#explorer-style-control-identifiers)
-   [Настройка диалоговых окон Old-Style](#customizing-old-style-dialog-boxes)

## <a name="file-names-and-directories"></a>Имена файлов и каталоги

Сведения в этом разделе относятся к диалоговым окнам **Открыть** и **Сохранить как** в стиле обозревателя, так и в старом стиле.

Перед вызовом функций [**GetOpenFilename**](/windows/desktop/api/Commdlg/nf-commdlg-getopenfilenamea) или [**жетсавефиленаме**](/windows/desktop/api/Commdlg/nf-commdlg-getsavefilenamea) элемент **указанный** структуры [**OpenFileName**](/windows/win32/api/commdlg/ns-commdlg-openfilenamea) должен указывать на буфер для получения имени файла. Элемент **нмаксфиле** должен указывать размер буфера **указанный** в символах. Для функции ANSI это число байтов, но для функции Юникода это число символов.

Если пользователь задает имя файла и нажимает кнопку **ОК** , диалоговое окно копирует выбранный диск, каталог и имя файла в буфер **указанный** . Функция также задает для элементов **нфилеоффсет** и **нфиликстенсион** смещения (в символах) от начала буфера до имени файла и расширения имени файла соответственно.

Чтобы получить только имя файла и расширение, установите элемент **лпстрфилетитле** , чтобы он указывал на буфер, и задайте для элемента **нмаксфилетитле** размер (в символах) буфера. Кроме того, можно передать буфер **указанный** в вызове функции [**жетфилетитле**](/windows/desktop/api/Commdlg/nf-commdlg-getfiletitlea) , чтобы получить отображаемое имя выбранного файла. Однако обратите внимание, что имя файла, возвращаемое **жетфилетитле** , включает расширение, только если это пользовательская предпочтение для отображения имен файлов.

В диалоговом окне используется текущий каталог для вызывающего процесса в качестве исходного каталога, из которого должны отображаться файлы и каталоги. Используйте функции [**GetCurrentDirectory**](/windows/desktop/api/winbase/nf-winbase-getcurrentdirectory) и [**сеткуррентдиректори**](/windows/desktop/api/winbase/nf-winbase-setcurrentdirectory) для получения и изменения текущего каталога процесса. Чтобы указать другой исходный каталог без изменения текущего каталога, используйте член **лпстринитиалдир** , чтобы указать имя каталога. Диалоговое окно автоматически изменяет текущий каталог, когда пользователь выбирает другой диск или каталог. Чтобы предотвратить изменение текущего каталога в диалоговом окне, установите флаг **ОФН \_ ночанжедир** . Этот флаг не запрещает пользователю изменять каталоги для поиска файла.

Чтобы указать расширение имени файла по умолчанию, используйте элемент **лпстрдефекст** . Если пользователь указывает имя файла, у которого нет расширения, в диалоговом окне добавляется расширение по умолчанию. Если задано расширение по умолчанию и пользователь указывает имя файла с другим расширением, то в диалоговом окне устанавливается флаг **ОФН \_ екстенсиондифферент** .

Чтобы позволить пользователю выбрать более одного файла из каталога, установите флаг **ОФН \_ алловмултиселект** . Для совместимости с более старыми приложениями в диалоговом окне множественный выбор по умолчанию используется пользовательский интерфейс старого стиля. Для вывода диалогового окна «Выбор нескольких вариантов в стиле обозревателя» необходимо также установить **флаг \_ обозревателя ОФН** .

Если пользователь выбирает более одного файла, буфер, на который указывает член **указанный** , возвращает путь к текущему каталогу, за которым следуют имена файлов выбранных файлов. Элемент **нфилеоффсет** является смещением к первому имени файла, а член **нфиликстенсион** не используется. В следующей таблице описывается различие между диалоговыми окнами в стиле обозревателя и старого стиля при возврате нескольких имен файлов.



| Стиль диалогового окна            | Описание                                                                                                                                                                                                               |
|-----------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Диалоговые окна в стиле обозревателя | Строки имени файла и каталога с разделителями **null** разделяются символом **null** после последнего имени файла. Этот формат позволяет диалоговым окнам в стиле обозревателя возвращать длинные имена файлов, содержащие пробелы. |
| Диалоговые окна старого стиля      | Строки имен файлов и каталогов разделяются пробелами. Для имен файлов с пробелами функция использует короткие имена файлов.                                                                                              |



 

Функцию [**FindFirstFile**](/windows/desktop/api/fileapi/nf-fileapi-findfirstfilea) можно использовать для преобразования между длинными и короткими именами файлов.

Если указать **ОФН \_ алловмултиселект** и пользователь выбрал только один файл, то в строке **указанный** не будет разделителя между путем и именем файла.

## <a name="filters"></a>Фильтры

Сведения в этом разделе относятся к диалоговым окнам «обозреватель-стиль» и « **старый стиль»** и « **Сохранить как** ».

Можно указать фильтры имен файлов, чтобы помочь пользователю в ограничении имен файлов, отображаемых в диалоговом окне. Фильтр имен файлов состоит из пары строк, завершающихся нулем, описания и шаблона, Объединенных в другой. В диалоговом окне отображается описание, позволяющее пользователю выбрать используемый фильтр. и использует шаблон для выбора файлов для вывода.

Чтобы указать фильтры, установите элемент **лпстрфилтер** структуры [**OpenFileName**](/windows/win32/api/commdlg/ns-commdlg-openfilenamea) , чтобы он указывал на буфер, содержащий массив пар строк фильтра. За последней строкой в массиве должен следовать дополнительный символ null.

Строка шаблона может представлять собой сочетание допустимых символов имени файла и звездочки ( \* ). Звездочка — это подстановочный знак, который представляет любое сочетание допустимых символов имени файла. В диалоговом окне отображаются только те файлы, которые соответствуют шаблону. Чтобы указать несколько шаблонов для одного описания, необходимо использовать точку с запятой (;) для разделения шаблонов. Обратите внимание, что пробелы в строке шаблона могут привести к непредвиденным результатам.

В следующем фрагменте кода указываются два фильтра. Фильтр с описанием "источник" имеет два шаблона. Если пользователь выбирает этот фильтр, в диалоговом окне отображаются только файлы с. C и. Расширения CXX. Обратите внимание, что в языке программирования C строка, заключенная в двойные кавычки, завершается нулем.


```
OPENFILENAME ofn;       // common dialog box structure

ofn.lpstrFilter = "Source\0*.C;*.CXX\0All\0*.*\0"
ofn.nFilterIndex = 1;
```



Элемент **нфилтериндекс** структуры [**OpenFileName**](/windows/win32/api/commdlg/ns-commdlg-openfilenamea) задает индекс, который указывает, какой фильтр используется в первоначальном диалоговом окне. Первый фильтр в буфере имеет индекс 1, второй 2 и т. д. Если пользователь изменяет фильтр при использовании диалогового окна, для элемента **нфилтериндекс** задается индекс выбранного фильтра в поле Return.

Можно создать настраиваемый фильтр, задав для элемента **лпстркустомфилтер** адрес буфера, содержащего один фильтр, и установив для элемента **нмакскустфилтер** размер буфера в символах или байтах. В диалоговом окне Пользовательский фильтр всегда помещается в начало списка фильтров, а в случае возврата всегда обновляет часть шаблона фильтра с помощью шаблона из фильтра, выбранного пользователем.

Для диалоговых окон в стиле обозревателя расширение по умолчанию может измениться, если пользователь выбирает другой фильтр. Если пользователь выбирает фильтр, первый шаблон которого имеет форму \* .*XXX* (т. е. расширение не содержит подстановочный знак), в диалоговом окне в качестве расширения по умолчанию используется *xxx* . Это происходит только в том случае, если в элементе **лпстрдефекст** структуры [**OpenFileName**](/windows/win32/api/commdlg/ns-commdlg-openfilenamea) указано расширение по умолчанию. Например, если пользователь выбирает «source \\ 0» \* . C; \* . CXX \\ 0 "фильтр, расширение по умолчанию изменяется на" C ". Однако, если фильтр был определен как «Source 0» \\ \* . \* \\ В C 0 "расширение по умолчанию не изменится, так как расширение содержит подстановочный знак.

сообщение уведомления [**CDN \_ инклудеитем**](cdn-includeitem.md) предоставляет другой способ фильтрации имен, отображаемых в диалоговом окне. Чтобы использовать это сообщение, укажите процедуру-обработчик [**офнхукпрок**](/windows/win32/api/commdlg/nc-commdlg-lpofnhookproc) и укажите флаг **ОФН \_ енаблеинклуденотифи** в структуре [**OpenFileName**](/windows/win32/api/commdlg/ns-commdlg-openfilenamea) при создании этого диалогового окна. каждый раз, когда пользователь открывает папку, диалоговое окно отправляет **CDN уведомление \_** в процедуру обработчика для каждого элемента во вновь открытой папке. Возвращаемое значение процедуры-обработчика указывает, должно ли диалоговое окно отображать элемент в списке элементов папки.

## <a name="file-and-directory-validation"></a>Проверка файлов и каталогов

Если не указано иное, сведения в этом разделе применяются к диалоговым окнам **Открыть** и **Сохранить как** в стиле обозревателя, так и в старом стиле.

Диалоговое окно автоматически проверяет имена файлов, введенные пользователем, чтобы гарантировать, что имена содержат только допустимые символы. Чтобы переопределить проверку символа имени файла, установите флаг **ОФН. \_**

Чтобы заставить диалоговое окно подтвердить, что пользователь указал имя существующего файла, установите флаг **ОФН \_ выполнить операцию filemustexist** . Чтобы принудительно выполнить проверку того, что указанный путь существует, установите флаг **ОФН \_ пасмустексист** . Если установлен флаг **ОФН \_ креатепромпт** , то диалоговое окно запрашивает у пользователя разрешение на создание несуществующего файла. Если этот флаг установлен и пользователь выбирает создание нового файла, диалоговое окно закрывается, а функция возвращает указанное имя. В противном случае диалоговое окно остается открытым.

При использовании диалогового окна **Сохранить как** можно направлять диалоговое окно, предлагающее пользователю запросить разрешение на перезапись существующего файла, установив флаг **ОФН \_ овервритепромпт** .

По умолчанию диалоговое окно создает тестовый файл нулевой длины, чтобы определить, можно ли создать новый файл в выбранном каталоге. Чтобы предотвратить создание этого тестового файла, установите флаг **ОФН \_ нотестфилекреате** .

При включении процедуры-обработчика диалоговое окно уведомляет процедуру-обработчик о том, что для имени файла, указанного пользователем, возникает нарушение общего доступа к сети. если задан флаг **офн \_ EXPLORER** , то диалоговое окно отправляет в процедуру обработчика сообщение [**CDN \_ шаревиолатион**](cdn-shareviolation.md) . Если не задать **ОФН \_ Explorer**, диалоговое окно отправляет в процедуру обработчика зарегистрированное [**шаревистринг**](sharevistring.md) сообщение. Чтобы запретить диалоговому окну отправлять уведомления о нарушениях общего доступа, установите флаг **ОФН \_ шареаваре** .

Если пользователь устанавливает флажок только для чтения, то диалоговое окно устанавливает флаг **ОФН \_ ReadOnly** для возврата. Чтобы скрыть флажок **Открыть как только для чтения** , установите флаг **ОФН \_ хидереадонли** . Чтобы диалоговое окно не возвращало имена существующих файлов с атрибутом только для чтения, установите флаг **ОФН \_ нореадонлиретурн** .

Чтобы запретить диалоговому окну отменять ссылки на файлы ссылок, задайте значение **ОФН \_ нодереференцелинкс** . В этом случае диалоговое окно возвращает имя файла ссылки, а не имя файла, на который ссылается файл ссылки.

## <a name="open-and-save-as-dialog-box-customization"></a>Настройка диалогового окна "открыть и сохранить как"

Диалоговое окно **Открыть** или **Сохранить как** можно настроить, предоставив процедуру-обработчик, пользовательский шаблон или и то, и другое. Однако версии диалоговых окон в стиле обозревателя и старого стиля отличаются использованием пользовательских шаблонов и процедур-обработчиков.

Сведения о настройке диалогового окна в стиле обозревателя см. в разделе [процедуры-обработчики](#explorer-style-hook-procedures)в стиле обозревателя, [пользовательские шаблоны в стиле обозревателя](#explorer-style-custom-templates)и [идентификаторы элементов управления в стиле обозревателя](#explorer-style-control-identifiers). Сведения о настройке диалогового окна старого стиля см. в разделе [Настройка диалоговых окон Old-Style](#customizing-old-style-dialog-boxes).

В следующей таблице приведены различия между двумя стилями.



| Настройка                  | Описание                                                                                                                                                                                                                                                                          |
|--------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Процедура обработчика в стиле обозревателя  | Процедура-обработчик получает сообщения уведомления, отправленные из общего диалогового окна, и сообщения для любых дополнительных элементов управления, определенных с помощью шаблона дочернего диалогового окна. Процедура-обработчик не получает сообщения для стандартных элементов управления диалогового окна по умолчанию. |
| Пользовательский шаблон в стиле обозревателя | Система использует пользовательский шаблон для создания дочернего диалогового окна. Шаблон может определять дополнительные элементы управления, а также указывать расположение кластера стандартных элементов управления. Пользовательский шаблон не заменяет шаблон по умолчанию.                                          |
| Процедура обработчика старого стиля       | Процедура-обработчик получает все сообщения, отправленные в диалоговое окно, включая сообщения для стандартных элементов управления и пользовательских элементов управления. Процедура-ловушка также получает зарегистрированные сообщения, отправленные из общего диалогового окна.                                                         |
| Пользовательский шаблон старого стиля      | Пользовательский шаблон заменяет шаблон по умолчанию. Создайте пользовательский шаблон, изменив шаблон по умолчанию, указанный в файле FileOpen. DLG.                                                                                                                                  |



 

Заголовок по умолчанию для диалоговых окон как в стиле обозревателя, так и в старом стиле — "**Открыть**" или "**Сохранить как**". Чтобы изменить заголовок, укажите новый заголовок в элементе **лпстртитле** структуры [**OpenFileName**](/windows/win32/api/commdlg/ns-commdlg-openfilenamea) .

Куст реестра **hKey для \_ текущего \_ пользователя** , содержащийся в разделе, может содержать значения, которые настраивают содержимое диалоговых окон « **Открытие** » и « **Сохранение** » в стиле обозревателя. Эти записи реестра затрагивают только диалоговые окна, отображаемые для пользователя, связанного с кустом реестра.

Чтобы скрыть возможности диалоговых окон « **Открыть** » и « **Сохранить как** » в стиле обозревателя, администратор может задать значения в следующей таблице в этом подразделе:

```
HKEY_CURRENT_USER
   Software
      Microsoft
         Windows
            CurrentVersion
               Policies
                  Comdlg32
```



| Имя значения       | Значение | Значение                                  |
|------------------|-------|------------------------------------------|
| **ноплацесбар**  | 1     | Скрывает панель мест.                    |
| **нофилемру**    | 1     | Скрывает список недавно использованных (MRU) списков. |
| **нобаккбуттон** | 1     | Скрывает кнопку " **назад** ".               |



 

Содержимое панели **мест** определяется содержимым следующего подраздела:

```
HKEY_CURRENT_USER
   Software
      Microsoft
         Windows
            CurrentVersion
               Policies
                  Comdlg32
                     Placesbar
```

В настоящее время в этом ключе может быть только пять записей, а индекс значения или имени — от нуля. Имена записей должны быть Place0, Place1, Place2, Place3 и Place4. Значения записей могут быть значениями **reg \_ DWORD**, **reg \_ SZ** или **reg \_ expand \_ SZ** , которые указывают расположения для включения в панель мест.



| Тип значения                         | Значение                                                                                                   |
|------------------------------------|-----------------------------------------------------------------------------------------------------------|
| **REG \_ DWORD**                     | Значение CSID, идентифицирующее папку. Список значений CSID см. в разделе [**значения CSid**](../shell/csidl.md). |
| **Reg \_ SZ** или **reg \_ expand \_ SZ** | Строка, завершающаяся нулем и указывающая допустимый путь.                                                     |



 

## <a name="explorer-style-hook-procedures"></a>Explorer-Style процедуры-обработчики

Можно настроить диалоговое окно **Открытие** или **Сохранение в** стиле обозревателя, предоставив процедуру-обработчик, пользовательский шаблон или и то, и другое. При предоставлении процедуры-обработчика для диалогового окна в стиле обозревателя система создает диалоговое окно, которое является дочерним по отношению к диалоговому окну по умолчанию. Процедура-обработчик выступает в качестве процедуры диалогового окна для дочернего диалогового окна. Это дочернее диалоговое окно основано на пользовательском шаблоне или в шаблоне по умолчанию, если он не указан. Дополнительные сведения см. в разделе [пользовательские шаблоны в стиле обозревателя](#explorer-style-custom-templates).

Чтобы включить процедуру-обработчик для диалогового окна « **Открыть** » или « **Сохранить как** » в стиле обозревателя, используйте структуру [**OpenFileName**](/windows/win32/api/commdlg/ns-commdlg-openfilenamea) при создании диалогового окна. Задайте флаги **ОФН \_ Енаблехук** и **ОФН \_ Explorer** в элементе **flags** и укажите адрес процедуры-обработчика [**офнхукпрок**](/windows/win32/api/commdlg/nc-commdlg-lpofnhookproc) в элементе **лпфнхук** . При предоставлении процедуры-обработчика и пропущении флага **\_ обозревателя ОФН** необходимо использовать процедуру-обработчик [**офнхукпроколдстиле**](/previous-versions/windows/desktop/legacy/ms646932(v=vs.85)) , и вы получите пользовательский интерфейс старого стиля. Дополнительные сведения см. в разделе [Настройка диалоговых окон Old-Style](#customizing-old-style-dialog-boxes).

При открытии диалогового окна процедура обработчика в стиле обозревателя получает разнообразные сообщения. следующие основные параметры.

-   Сообщение [**WM \_ инитдиалог**](wm-initdialog.md) и другие стандартные сообщения диалогового окна, такие как сообщение цвета элемента управления [**WM \_ ктлколордлг**](wm-ctlcolordlg.md) .
-   Набор сообщений уведомления [**WM \_ Notify**](../controls/wm-notify.md) , указывающий действия, выполняемые пользователем или другим событием диалогового окна.
-   Сообщения для любых дополнительных элементов управления, определенных путем указания дочернего шаблона диалогового окна.

Кроме того, существует набор сообщений, которые можно отправить в диалоговое окно в стиле обозревателя для получения сведений или управления поведением и внешним видом диалогового окна.

При предоставлении процедуры-обработчика для диалогового окна в стиле обозревателя процедура диалогового окна по умолчанию создает дочернее диалоговое окно, когда процедура диалогового окна по умолчанию обрабатывает сообщение [**WM \_ инитдиалог**](wm-initdialog.md) . Процедура-обработчик выступает в качестве процедуры диалогового окна для дочернего диалогового окна. В настоящее время процедура-обработчик получает собственное сообщение **WM \_ инитдиалог** с параметром *lParam* , равным адресу структуры [**OpenFileName**](/windows/win32/api/commdlg/ns-commdlg-openfilenamea) , используемой для инициализации диалогового окна. После того как дочерний диалог завершает обработку своего сообщения **\_ инитдиалог WM** , процедура диалогового окна по умолчанию при необходимости перемещает стандартные элементы управления, чтобы освободить место для любых дополнительных элементов управления дочернего диалогового окна. затем процедура диалогового окна по умолчанию отправляет сообщение уведомления [**CDN \_ инитдоне**](cdn-initdone.md) в процедуру-обработчик.

Процедура-обработчик получает уведомления [**WM \_ Notify**](../controls/wm-notify.md) , указывающие действия, выполняемые пользователем в диалоговом окне. Некоторые из этих сообщений можно использовать для управления поведением диалогового окна. например, процедура-обработчик получает сообщение [**CDN \_ филеок**](cdn-fileok.md) , когда пользователь выбирает имя файла и нажимает кнопку **ок** . В ответ на это сообщение процедура-обработчик может использовать функцию [**SetWindowLong**](/windows/desktop/api/winuser/nf-winuser-setwindowlonga) , чтобы отклонить выбранное имя и принудительно оставить диалоговое окно открытым.

Параметр *lParam* для каждого сообщения [**с \_ уведомлением WM**](../controls/wm-notify.md) — это указатель на структуру [**офнотифи**](/windows/desktop/api/Commdlg/ns-commdlg-ofnotifya) или [**офнотифекс**](/windows/desktop/api/Commdlg/ns-commdlg-ofnotifyexa) , определяющую действие. Элемент **Code** в заголовке этой структуры содержит одно из следующих сообщений уведомления.



| Сообщение                                           | Значение                                                                                                                                                                                                                                                                                        |
|---------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [**CDN \_ филеок**](cdn-fileok.md)                 | Пользователь нащелкнул кнопку **ОК** ; диалоговое окно скоро закроется.                                                                                                                                                                                                                          |
| [**CDN \_ фолдерчанже**](cdn-folderchange.md)     | Пользователь открыл новую папку или каталог.                                                                                                                                                                                                                                                     |
| [**CDN \_ СПРАВКА**](cdn-help.md)                     | Пользователь щелкнул кнопку **Справка** .                                                                                                                                                                                                                                                          |
| [**CDN \_ инклудеитем**](cdn-includeitem.md)       | Определяет, должен ли отображаться элемент. Когда пользователь открывает новую папку или каталог, система отправляет это уведомление для каждого элемента в папке или каталоге. Система отправляет это уведомление только в том случае, если установлен флаг **ОФН \_ енаблеинклуденотифи** .                          |
| [**CDN \_ инитдоне**](cdn-initdone.md)             | Система завершила инициализацию диалогового окна, и диалоговое окно завершило обработку сообщения [**WM \_ инитдиалог**](wm-initdialog.md) . Кроме того, система завершила компоновку элементов управления в общем диалоговом окне, чтобы освободить место для элементов управления дочернего диалогового окна (если оно есть). |
| [**CDN \_ селчанже**](cdn-selchange.md)           | Пользователь выбрал новый файл или папку из списка файлов.                                                                                                                                                                                                                                     |
| [**CDN \_ шаревиолатион**](cdn-shareviolation.md) | В общем диалоговом окне произошло нарушение совместного доступа к файлу, который должен быть возвращен.                                                                                                                                                                                                        |
| [**CDN \_ типечанже**](cdn-typechange.md)         | Пользователь выбрал новый тип файла из списка типов файлов.                                                                                                                                                                                                                                 |



 

Эти [**сообщения WM \_ Notify**](../controls/wm-notify.md) заменяют зарегистрированные сообщения [**филеокстринг**](fileokstring.md), [**лбселчстринг**](lbselchstring.md), [**шаревистринг**](sharevistring.md)и [**хелпмсгстринг**](helpmsgstring.md) , используемые предыдущими версиями диалоговых окон **Открыть** и **Сохранить как** . Однако процедура-ловушка также получает заменяемое сообщение после сообщения **WM \_ Notify** , если обработка **\_ уведомления WM** не использует [**SetWindowLong**](/windows/desktop/api/winuser/nf-winuser-setwindowlonga) для установки ненулевого значения **\_ мсгресулт DWL** .

Чтобы получить сведения о состоянии диалогового окна или управлении поведением и внешним видом диалогового окна, процедура-обработчик может отправить в диалоговое окно следующие сообщения.



| Сообщение                                             | Значение                                                                                                                                                                                                                  |
|-----------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [**CDM. \_ FilePath**](cdm-getfilepath.md)         | Извлекает путь и имя выбранного файла.                                                                                                                                                                   |
| [**CDM \_ жетфолдеридлист**](cdm-getfolderidlist.md) | Извлекает список идентификаторов элементов, соответствующий текущей папке, открытой в этом диалоговом окне. Дополнительные сведения о списках идентификаторов элементов см. в разделе [Введение в пространство имен оболочки](/windows/desktop/shell/namespace-intro). |
| [**CDM \_ GETFOLDERPATH**](cdm-getfolderpath.md)     | Возвращает путь к текущей папке или каталогу для диалогового окна.                                                                                                                                                |
| [**CDMая \_ Спецификация**](cdm-getspec.md)                 | Извлекает имя файла (не включая путь) файла, выбранного в данный момент в диалоговом окне.                                                                                                                       |
| [**CDM \_ хидеконтрол**](cdm-hidecontrol.md)         | Скрывает указанный элемент управления.                                                                                                                                                                                             |
| [**CDM \_ сетконтролтекст**](cdm-setcontroltext.md)   | Задает текст в указанном элементе управления.                                                                                                                                                                                  |
| [**CDM \_ сетдефекст**](cdm-setdefext.md)             | Задает расширение имени файла по умолчанию для диалогового окна.                                                                                                                                                                 |



 

## <a name="explorer-style-custom-templates"></a>Explorer-Style пользовательских шаблонов

Чтобы определить дополнительные элементы управления для диалогового окна **Открытие** или **Сохранение в** стиле обозревателя, используйте структуру [**OpenFileName**](/windows/win32/api/commdlg/ns-commdlg-openfilenamea) , чтобы указать шаблон для дочернего диалогового окна, содержащего дополнительные элементы управления. Если ваш дочерний шаблон диалогового окна является ресурсом в приложении или библиотеке динамической компоновки, установите флаг **ОФН \_ енаблетемплате** в элементе **flags** и используйте элементы **HINSTANCE** и **лптемплатенаме** структуры, чтобы определить имя модуля и ресурса. Если шаблон уже находится в памяти, установите флаг **ОФН \_ енаблетемплатехандле** и используйте элемент **HINSTANCE** , чтобы определить объект памяти, содержащий шаблон. При предоставлении шаблона диалогового окна для диалогового окна в стиле обозревателя необходимо также установить флаг **\_ обозревателя ОФН** . в противном случае система предполагает, что вы предоставляли шаблон замены для диалогового окна старого стиля. Как правило, при предоставлении дополнительных элементов управления необходимо также предоставить [процедуру обработчика в стиле обозревателя](#explorer-style-hook-procedures) для обработки сообщений для новых элементов управления.

Вы можете создать свой дочерний шаблон диалогового окна, как и любой другой шаблон, за исключением того, что необходимо указать стили **WS \_ Child** и **WS \_ клипсиблингс** и указать стили **DS \_ 3DLOOK** и **\_ управления DS** . Для работы системы требуется **стиль \_ дочернего элемента WS** , так как шаблон определяет дочернее диалоговое окно **открытия** или **сохранения** по умолчанию. Стиль **WS \_ клипсиблингс** гарантирует, что дочернее диалоговое окно не будет перерисовываться над любыми элементами управления в диалоговом окне по умолчанию. Стиль **\_ 3DLOOK в DS** гарантирует, что внешний вид элементов управления в дочернем диалоговом окне будет соответствовать элементам управления в диалоговом окне по умолчанию. Стиль **\_ элемента управления DS** гарантирует, что пользователь может использовать вкладку и другие клавиши навигации для перемещения между всеми элементами управления, по умолчанию или пользовательскими, в диалоговом окне настроено.

Чтобы освободить место для новых элементов управления, система раскрывает диалоговое окно по умолчанию по ширине и высоте пользовательского диалогового окна. По умолчанию все элементы управления из пользовательского диалогового окна располагаются под элементами управления в диалоговом окне по умолчанию. Однако можно переопределить это положение по умолчанию, включив Статический элемент управления "текст" в пользовательский шаблон диалогового окна и назначив ему значение идентификатора элемента управления **stc32**. (Это значение определено в файле заголовка Длгс. h.) В этом случае система использует элемент управления в качестве точки ссылки для определения места размещения новых элементов управления. Все новые элементы управления, расположенные выше и слева от элемента управления **stc32** , располагаются в том же размере, что и слева от элементов управления в диалоговом окне по умолчанию. Новые элементы управления, расположенные ниже и справа от элемента управления **stc32** , располагаются ниже и справа от элементов управления по умолчанию. Как правило, каждый новый элемент управления размещается так, чтобы его расположение совпадало с элементами управления по умолчанию, как и в элементе управления **stc32** . Чтобы освободить место для этих новых элементов управления, система добавляет пробелы в левую, правую, нижнюю и верхнюю часть диалогового окна по умолчанию по мере необходимости.

Система требует, чтобы процедура обработчика обрабатывала все сообщения, предназначенные для пользовательского диалогового окна, и, таким образом, отправляет те же сообщения окна процедуре обработки, что и любые другие диалоговые окна. Например, процедура-обработчик принимает сообщения [**\_ команды WM**](/windows/desktop/menurc/wm-command) , когда пользователь щелкает элемент управления "Кнопка" в пользовательском диалоговом окне. Процедура-ловушка отвечает за инициализацию этих элементов управления и получение значений из элементов управления при закрытии диалогового окна. Обратите внимание, что когда процедура-обработчик получает сообщение [**WM \_ инитдиалог**](wm-initdialog.md) , система еще не переместила элементы управления на свои конечные позиции.

Процедура диалогового окна по умолчанию обрабатывает сообщения для всех элементов управления в диалоговом окне по умолчанию, но процедура-обработчик принимает сообщения уведомления для действий пользователя с этими элементами управления, как описано в разделе [процедуры обработчика в стиле обозревателя](#explorer-style-hook-procedures).

## <a name="explorer-style-control-identifiers"></a>Идентификаторы элементов управления Explorer-Style

пакет средств разработки Windows Software Development Kit (SDK) предоставляет шаблон диалогового окна по умолчанию для диалоговых окон старого стиля, но не включает шаблон по умолчанию для диалоговых окон в стиле обозревателя. Это связано с тем, что диалоговые окна в стиле обозревателя позволяют добавлять собственные элементы управления, но не поддерживают изменение шаблона для стандартных элементов управления. Однако в некоторых случаях может потребоваться знать идентификаторы элементов управления, используемые в шаблонах по умолчанию. Например, для сообщений [**CDM \_ Хидеконтрол**](cdm-hidecontrol.md) и [**CDM \_ сетконтролтекст**](cdm-setcontroltext.md) требуется идентификатор элемента управления.

В следующей таблице показаны идентификаторы стандартных элементов управления в диалоговых окнах **Открытие** и **Сохранение** в стиле обозревателя. Идентификаторы — это константы, определенные в Длгс. h и Winuser. h.



| Идентификатор элемента управления | Описание элемента управления                                                                                                                                                                                                                                                                        |
|--------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **chx1**           | Флажок только для чтения                                                                                                                                                                                                                                                                    |
| **cmb1**           | Раскрывающееся поле со списком, в котором отображается список фильтров типов файлов                                                                                                                                                                                                                            |
| **stc2**           | Метка для поля со списком **cmb1**                                                                                                                                                                                                                                                           |
| **cmb2**           | Раскрывающийся список, отображающий текущий диск или папку, который позволяет пользователю выбрать диск или папку для открытия                                                                                                                                                                |
| **stc4**           | Метка для поля со списком **cmb2**                                                                                                                                                                                                                                                           |
| **cmb13**          | Раскрывающийся список, отображающий имя текущего файла, позволяет пользователю ввести имя открываемого файла и выбрать файл, который был открыт или сохранен недавно. Это предназначено для ранее совместимых с обозревателем приложений без обработчика или шаблона диалогового окна. Сравните с **edt1**. |
| **edt1**           | Элемент управления "поле ввода", который отображает имя текущего файла, или позволяет пользователю ввести имя открываемого файла. Сравните с **cmb13**.                                                                                                                                                  |
| **stc3**           | Метка для поля со списком **cmb13** и элемента управления Edit edt1                                                                                                                                                                                                                                |
| **lst1**           | Список, отображающий содержимое текущего диска или папки                                                                                                                                                                                                                         |
| **stc1**           | Метка для списка **lst1**                                                                                                                                                                                                                                                            |
| **IDOK**           | Кнопка « **ОК** » (кнопка «Отправить»)                                                                                                                                                                                                                                                    |
| **IDCANCEL**       | Кнопка **"Отмена"** (кнопка "Отправить")                                                                                                                                                                                                                                                |
| **пшхелп**        | Кнопка « **Справка** » (кнопка «Отправить»)                                                                                                                                                                                                                                                  |



 

## <a name="customizing-old-style-dialog-boxes"></a>Настройка диалоговых окон Old-Style

Можно настроить диалоговое окно **Открытие** или **Сохранение в** старом стиле, предоставив процедуру-обработчик [*офнхукпроколдстиле*](/previous-versions/windows/desktop/legacy/ms646932(v=vs.85)) , которая получает сообщения или уведомления, предназначенные для процедуры диалогового окна по умолчанию. Можно также указать пользовательский шаблон, который будет использоваться вместо шаблона по умолчанию. Процедуры-ловушки и шаблоны, используемые с диалоговыми окнами старого стиля, похожи на те, которые используются в других общих диалоговых окнах. Дополнительные сведения см. в разделе [процедуры-обработчики для общих диалоговых](customizing-common-dialog-boxes.md) окон и [пользовательских шаблонов](customizing-common-dialog-boxes.md).

Чтобы включить процедуру-обработчик для диалогового окна **Открытие** или **Сохранение в** старом стиле, используйте структуру [**OpenFileName**](/windows/win32/api/commdlg/ns-commdlg-openfilenamea) при создании диалогового окна. Установите флаг **ОФН \_ енаблехук** в элементе **flags** и укажите адрес процедуры-обработчика [*офнхукпроколдстиле*](/previous-versions/windows/desktop/legacy/ms646932(v=vs.85)) в элементе **лпфнхук** . Процедура диалогового окна отправляет в процедуру-обработчику сообщение [**WM \_ инитдиалог**](wm-initdialog.md) с параметром *param* , которому задан адрес структуры **OpenFileName** , используемой для инициализации диалогового окна.

Структуру [**OpenFileName**](/windows/win32/api/commdlg/ns-commdlg-openfilenamea) можно использовать для указания пользовательского шаблона для диалогового окна **Открыть** или **Сохранить как** , используемого вместо шаблона по умолчанию. Если пользовательский шаблон является ресурсом в приложении или библиотеке динамической компоновки, установите флаг **ОФН \_ енаблетемплате** в элементе **flags** и используйте элементы **HINSTANCE** и **лптемплатенаме** структуры для обозначения имени модуля и ресурса. Если пользовательский шаблон уже находится в памяти, установите флаг **ОФН \_ енаблетемплатехандле** и используйте элемент **HINSTANCE** , чтобы определить объект памяти, содержащий шаблон. Создайте пользовательский шаблон, изменив шаблон по умолчанию, указанный в файле FileOpen. DLG. Идентификаторы элементов управления, используемые в шаблонах диалоговых окон поиска и замены по умолчанию, определяются в файле Длгс. h.

По умолчанию функции [**GetOpenFilename**](/windows/desktop/api/Commdlg/nf-commdlg-getopenfilenamea) и [**жетсавефиленаме**](/windows/desktop/api/Commdlg/nf-commdlg-getsavefilenamea) отображают диалоговые окна в стиле обозревателя. Если требуется отобразить диалоговое окно старого стиля, необходимо предоставить процедуру-обработчик [**офнхукпроколдстиле**](/previous-versions/windows/desktop/legacy/ms646932(v=vs.85)) и убедиться, что флаг **ОФН \_ Explorer** не установлен в элементе **flags** структуры [**OpenFileName**](/windows/win32/api/commdlg/ns-commdlg-openfilenamea) .

Если установлен флаг **\_ обозревателя ОФН** , система рассматривает процедуру-обработчик или пользовательский шаблон как настройку в стиле обозревателя. Сведения о настройке диалогового окна в стиле обозревателя см. в разделе [пользовательские шаблоны в стиле обозревателя](#explorer-style-custom-templates).

## <a name="see-also"></a>См. также

* [Файл используется в качестве примера](https://github.com/microsoft/Windows-classic-samples/tree/master/Samples/Win7Samples/winui/shell/appplatform/fileisinuse)