---
title: Выполнение и синхронизация списков команд
description: В Microsoft Direct3D 12 режим интерпретации предыдущих версий больше не существует.
ms.assetid: D5013102-2302-4D66-8F59-079C03BA65FD
keywords:
- Список команд
- синхронизация
- выполнение
ms.localizationpriority: high
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b41677ee1bc17fb2a935f157d969352617c0d5c3c15eb38a76225b3a8c71e7f8
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118529144"
---
# <a name="executing-and-synchronizing-command-lists"></a>Выполнение и синхронизация списков команд

В Microsoft Direct3D 12 режим интерпретации предыдущих версий больше не существует. Вместо этого приложения создают списки команд и пакеты, а затем записывают наборы команд GPU. Очереди команд используются для отправки списков команд для выполнения. Эта модель позволяет разработчикам более эффективно контролировать эффективное использование графических процессоров и ЦП.

-   [Общие сведения о очереди команд](#command-queue-overview)
-   [Инициализация очереди команд](#initializing-a-command-queue)
-   [Выполняя списки команд](#executing-command-lists)
-   [Доступ к ресурсам из нескольких командных очередей](#accessing-resources-from-multiple-command-queues)
-   [Синхронизация выполнения списка команд с помощью ограждений очереди команд](#synchronizing-command-list-execution-using-command-queue-fences)
-   [Синхронизация ресурсов, к которым обращаются очереди команд](#synchronizing-resources-accessed-by-command-queues)
-   [Поддержка очереди команд для мозаичных ресурсов](#command-queue-support-for-tiled-resources)
-   [Связанные темы](#related-topics)

## <a name="command-queue-overview"></a>Общие сведения о очереди команд

Командная очередь Direct3D 12 заменяет синхронизацию среды выполнения и драйвера для отправки работы в режиме интерпретации, ранее недоступную разработчику, с интерфейсами API для явного управления параллелизмом, параллелизмом и синхронизацией. Очереди команд предоставляют разработчикам следующие усовершенствования.

-   Позволяет разработчикам избежать случайных неэффективностей, вызванных непредвиденной синхронизацией.
-   Позволяет разработчикам создавать синхронизацию на более высоком уровне, где требуемая синхронизация может быть определена более эффективно и точнее. Это означает, что среда выполнения и графический драйвер будут тратить меньше времени на интерактивное проектирование параллелизма.
-   Делает дорогостоящие операции более явными.

Эти улучшения включают или улучшают следующие сценарии:

-   Повышенный параллелизм. приложения могут использовать более глубокие очереди для фоновых рабочих нагрузок, таких как декодирование видео, если они имеют отдельные очереди для выполнения задач переднего плана.
-   Работа GPU с асинхронным и низким приоритетом. модель очереди команд обеспечивает параллельное выполнение работы GPU с низким приоритетом и атомарных операций, позволяющих одному потоку GPU использовать результаты другого несинхронизированного потока без блокировки.
-   Высокоприоритетная вычислительная работа. Эта схема позволяет выполнять сценарии, требующие прерывания трехмерной отрисовки для выполнения небольшого объема вычислительных операций с высоким приоритетом, чтобы результат можно было получить на ранней стадии для дополнительной обработки ЦП.

## <a name="initializing-a-command-queue"></a>Инициализация очереди команд

Очереди команд можно создать путем вызова [**ID3D12Device:: креатекоммандкуеуе**](/windows/desktop/api/d3d12/nf-d3d12-id3d12device-createcommandqueue). Этот метод принимает [**\_ \_ список команд \_ D3D12**](/windows/desktop/api/d3d12/ne-d3d12-d3d12_command_list_type) , указывающий тип создаваемой очереди, и, следовательно, тип команд, которые могут быть переданы в эту очередь. Помните, что пакеты могут вызываться только из списков прямых команд и не могут быть переданы непосредственно в очередь. Поддерживаются следующие типы очереди:

-   [**\_ \_ Тип списка команд \_ D3D12 \_ Direct**](/windows/desktop/api/d3d12/ne-d3d12-d3d12_command_list_type)
-   [**\_ \_ \_ Вычисление типа списка команд D3D12 \_**](/windows/desktop/api/d3d12/ne-d3d12-d3d12_command_list_type)
-   [**\_ \_ \_ Копирование типа списка команд \_ D3D12**](/windows/desktop/api/d3d12/ne-d3d12-d3d12_command_list_type)

В общем случае прямые очереди и списки команд принимают любые команды, вычисляют очереди и списки команд принимают команды COMPUTE и Copy, а копии очередей и команд принимают только команды Copy.

## <a name="executing-command-lists"></a>Выполняя списки команд

После того как вы записали список команд и извлекли очередь команд по умолчанию или создали новую, вы выполните списки команд, вызвав [**ID3D12CommandQueue:: ексекутекоммандлистс**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-executecommandlists).

Приложения могут отправлять списки команд в любую очередь команд из нескольких потоков. Среда выполнения будет выполнять работу по сериализации этих запросов в порядке их отправки.

Среда выполнения проверит отправленный список команд и удалит вызов [**ексекутекоммандлистс**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-executecommandlists) , если нарушены какие либо ограничения. Вызовы будут удалены по следующим причинам:

-   Указанный список команд — это набор, а не прямой список команд.
-   [**ID3D12GraphicsCommandList:: Close**](/windows/desktop/api/d3d12/nf-d3d12-id3d12graphicscommandlist-close) не был вызван в списке предоставленных команд для завершения записи.
-   [**ID3D12CommandAllocator:: Reset**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandallocator-reset) был вызван для распределителя команд, связанного с списком команд, так как он записан. Дополнительные сведения о распределителях команд см. в разделе [Создание и запись списков команд и пакетов](recording-command-lists-and-bundles.md).
-   Граница очереди команд указывает на то, что предыдущее выполнение списка команд еще не завершено. Границы очереди команд подробно описаны ниже.
-   Состояния запросов "до" и "после", установленные с вызовами [**ID3D12GraphicsCommandList:: бегинкуери**](/windows/desktop/api/d3d12/nf-d3d12-id3d12graphicscommandlist-beginquery) и [**ID3D12GraphicsCommandList:: ендкуери**](/windows/desktop/api/d3d12/nf-d3d12-id3d12graphicscommandlist-endquery), не будут правильно сопоставлены.
-   Состояния "до" и "после" барьеров переключения ресурсов не совпадают должным образом. Дополнительные сведения см. [в статье использование барьеров ресурсов для синхронизации состояний ресурсов](using-resource-barriers-to-synchronize-resource-states-in-direct3d-12.md).

## <a name="accessing-resources-from-multiple-command-queues"></a>Доступ к ресурсам из нескольких командных очередей

Существует несколько правил, установленных средой выполнения, которые ограничивают доступ к ресурсам из нескольких командных очередей. Ниже приведены эти правила.

1. Невозможно одновременно записать ресурс из нескольких командных очередей. Когда ресурс переходит в состояние, записываемый в очередь, он считается монопольно принадлежащим этой очереди и должен переходить в режим чтения или общего состояния (см. [**D3D12_RESOURCE_STATES**](/windows/desktop/api/d3d12/ne-d3d12-d3d12_resource_states)), прежде чем доступ к нему может получить другая очередь.

2. Когда находится в состоянии Read, ресурс может быть считан из нескольких командных очередей одновременно, в том числе между процессами, в зависимости от состояния чтения.

Дополнительные сведения об ограничениях доступа к ресурсам и использовании барьеров ресурсов для синхронизации доступа к ресурсам см. в статье [использование барьеров ресурсов для синхронизации состояний ресурсов](using-resource-barriers-to-synchronize-resource-states-in-direct3d-12.md).

## <a name="synchronizing-command-list-execution-using-command-queue-fences"></a>Синхронизация выполнения списка команд с помощью ограждений очереди команд

Поддержка нескольких очередей параллельных команд в Direct3D 12 обеспечивает более гибкое и управляемое определение приоритетов асинхронной работы на GPU. Такая схема также означает, что приложения должны явно управлять синхронизацией работы, особенно если списки команд в одной очереди зависят от ресурсов, на которые осуществляется другая очередь команд. Некоторые примеры включают ожидание завершения операции в очереди вычислений, чтобы результат можно было использовать для операции отрисовки в трехмерной очереди, и ожидание завершения трехмерной операции, чтобы операция в очереди вычислений могла получить доступ к ресурсу для записи. Чтобы обеспечить синхронизацию работы между очередями, Direct3D 12 использует концепцию ограждений, которые представлены в API интерфейсом [**ID3D12Fence**](/windows/desktop/api/d3d12/nn-d3d12-id3d12fence) .

Ограждение — это целое число, представляющее текущую обрабатываемую единицу работы. Когда приложение перемещает ограждение, вызывая [**ID3D12CommandQueue:: Signal**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-signal), целое число обновляется. Приложения могут проверить значение ограждения и определить, была ли выполнена работающая единица, чтобы решить, можно запустить последующую операцию.

## <a name="synchronizing-resources-accessed-by-command-queues"></a>Синхронизация ресурсов, к которым обращаются очереди команд

В Direct3D 12 Синхронизация состояния некоторых ресурсов реализуется с помощью барьеров ресурсов. В каждом барьере ресурсов приложение объявляет состояния ресурса до и после. Распространенный пример: ресурс для перехода между представлением ресурсов шейдера в представление целевого объекта прорисовки. Для большей части эти барьеры ресурсов управляются в списках команд. Если отладочные слои включены, система принудительно применяет все состояния до и после всех соответствующих ресурсов, гарантируя, что ресурс находится в правильном состоянии для определенной операции при переходе барьера.

Дополнительные сведения о синхронизации состояния ресурсов см. в статье [использование барьеров ресурсов для синхронизации состояний ресурсов](using-resource-barriers-to-synchronize-resource-states-in-direct3d-12.md).

## <a name="command-queue-support-for-tiled-resources"></a>Поддержка очереди команд для мозаичных ресурсов

Методы управления мозаичными ресурсами, которые были доступны через интерфейс [**ID3D11DeviceContext2**](/windows/desktop/api/d3d11_2/nn-d3d11_2-id3d11devicecontext2) в Direct3D 11, предоставляются интерфейсом [**ID3D12CommandQueue**](/windows/desktop/api/d3d12/nn-d3d12-id3d12commandqueue) в Direct3D 12. Эти способы включают перечисленные ниже.



| Метод                                                              | Описание                                                                                              |
|---------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------|
| [**CopyTileMappings**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-copytilemappings)     | Копирует сопоставления из исходного мозаичного ресурса в целевой мозаичный ресурс.<br/>                 |
| [**UpdateTileMappings**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-updatetilemappings) | Обновляет сопоставления расположений плиток в мозаичных ресурсах в местах памяти в куче ресурсов.<br/> |



 

Дополнительные сведения об использовании мозаичных ресурсов в приложениях Direct3D 12 см. в разделе [Direct3D11 мозаичные ресурсы](/windows/desktop/direct3d11/tiled-resources).

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Отправка работы в Direct3D 12](command-queues-and-command-lists.md)
</dt> </dl>

 

