---
title: Использование НАПРАВЛЯТЬ для диагностики ошибок GPU
description: Устройство удалило Расширенные данные (НАПРАВЛЯТЬ) — это развивающийся набор диагностических функций, позволяющих определить причину непредвиденных ошибок при удалении устройства.
ms.custom: 19H1
ms.localizationpriority: high
ms.topic: article
ms.date: 04/19/2019
ms.openlocfilehash: bbc754239210899e804d41a294e8c9f47967fb25
ms.sourcegitcommit: 780d4b1601c45658ef0b799b80d13f45a53d808d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/26/2020
ms.locfileid: "104548955"
---
# <a name="use-dred-to-diagnose-gpu-faults"></a>Использование НАПРАВЛЯТЬ для диагностики ошибок GPU
НАПРАВЛЯТЬ означает, что устройство удалило Расширенные данные. НАПРАВЛЯТЬ — это развивающийся набор функций диагностики, позволяющий определить причину непредвиденных ошибок при удалении устройства. На оборудовании, которое поддерживает необходимые функции (как определено ниже), НАПРАВЛЯТЬ предоставляет автоматические панели навигации, а также отчеты о сбоях страниц GPU.

## <a name="auto-breadcrumbs"></a>Автоматические строки перехода
Чтобы задать сцену для автоматической адресной строки, сначала следует упомянуть о разнообразных возможностях. В то же время, как [Обнаружение и восстановление времени ожидания (ТДР)](/windows-hardware/drivers/display/timeout-detection-and-recovery), можно использовать [метод ID3D12GraphicsCommandList2:: вритебуффериммедиате](/windows/desktop/api/d3d12/nf-d3d12-id3d12graphicscommandlist2-writebufferimmediate) , чтобы поместить в поток команд GPU *иерархическую* последовательность для отслеживания хода выполнения GPU.

Это разумный подход, если вы хотите создать пользовательскую реализацию с низкими затратами. Но в нем могут отсутствовать некоторые универсальности стандартизированного решения, такие как расширения отладчика, или отчеты с помощью [отчеты об ошибках Windows (WER)](/windows/desktop/wer/windows-error-reporting) (также известной как Watson).

Таким образом, автоматическая иерархия НАПРАВЛЯТЬ вызывает **вритебуффериммедиате** для размещения счетчиков хода выполнения в поток команд GPU. НАПРАВЛЯТЬ вставляет навигатор после каждой операции *подготовки к просмотру*, что &mdash; означает каждую операцию, которая приводит к работе GPU (например, **прорисовка**, **Отправка**, **копирование**, **разрешение** и др.). Если устройство удаляется в середине рабочей нагрузки GPU, то значение иерархического НАПРАВЛЯТЬ по сути является коллекцией операций рендеринга, которые были завершены до возникновения ошибки.

Буфер кольцевого буфера журнала содержит до 64KiB операций в указанном списке команд. Если в списке команд содержится более 65536 операций, то сначала сохраняются только последние операции 64KiB &mdash; . Тем не менее, значение счетчика навигатор по мере необходимости будет равно `UINT_MAX` . Поэтому Ластопиндекс = (Бреадкрумбкаунт-1) %65536.

НАПРАВЛЯТЬ 1,0 впервые была доступна в Windows 10, версия 1809 (обновление Windows 10 октября 2018), и она обладает элементарными автонавигаторами. Однако для него не было интерфейсов API, и единственным способом включения направлять 1,0 было использование **центра обратной связи** для записи ТДР воспроизведения (воспроизвести) для **приложений & игры** \> **производительность и совместимость** игр. Основная цель НАПРАВЛЯТЬ 1,0 — помочь избежать сбоев игр с помощью отзывов клиентов.
### <a name="caveats"></a>Предупреждения
- Так как GPU сильно конвейерен, нет никакой гарантии, что счетчик навигаторов указывает на точную операцию, которая завершилась ошибкой. На самом деле, на некоторых отложенных устройствах отрисовки на основе плиток можно сделать так, чтобы счетчик иерархии был полным ресурсом или барьером неупорядоченного представления доступа (UAV), который находится за ходом выполнения фактического GPU.
- Драйвер экрана может изменять порядок команд, предварительно выполняя выборку из памяти ресурса, прежде чем выполнять команду или очищать кэшированную память после завершения команды. Любой из них может вызвать ошибку GPU. В таких случаях счетчики автоматической иерархии могут оказаться менее полезными или неверно.
### <a name="performance"></a>Производительность
Несмотря на то, что автоматические переходы не изменяются, они не освобождаются. В измерении "стандартные измерения" показано снижение производительности в 2-5% на типичном ядре игровой игры на Direct3D 12. По этой причине по умолчанию автоматическая строка навигации отключена.
### <a name="hardware-requirements"></a>Требования к оборудованию
Поскольку значения счетчика навигации должны сохраняться после удаления устройства, ресурс, содержащий строки навигации, должен существовать в системной памяти и должен сохраняться в случае удаления устройства. Это означает, что драйверу экрана требуется поддержка [**D3D12_FEATURE_EXISTING_HEAPS**](/windows/desktop/api/d3d12/ne-d3d12-d3d12_feature). К счастью, это так для большинства видеодрайверов Direct3D 12 в Windows 10, версия 1903.
## <a name="gpu-page-fault-reporting"></a>Отчеты о сбоях страниц GPU
Новая функция для НАПРАВЛЯТЬ 1,1 — НАПРАВЛЯТЬ отчеты о сбоях страниц GPU. Ошибка страницы GPU обычно возникает в одном из этих условий.

1. Приложение по ошибке выполняет работу на GPU, который ссылается на удаленный объект. Это одна из основных причин непредвиденного удаления устройства.
2. Приложение по ошибке выполняет работу на GPU, который обращается к удаленному ресурсу, или к нерезидентной плитке.
3. Шейдер ссылается на неинициализированный или устаревший дескриптор.
3. Индексы шейдера выходят за границы корневой привязки.

НАПРАВЛЯТЬ пытается устранить некоторые из этих сценариев, сообщая имена и типы существующих или недавно освобожденных объектов API, которые соответствуют виртуальному адресу (ва) ошибки страницы, о которой сообщили GPU.

### <a name="caveat"></a>Пояснение
Не все GPU поддерживают ошибки страниц (хотя и многие из них). Некоторые GPU отвечают на ошибки памяти путем записи битовых блоков. чтение смоделированных данных (например, нулей); или просто зависает. К сожалению, в случаях, когда GPU не зависает, [Обнаружение и восстановление времени ожидания (ТДР)](/windows-hardware/drivers/display/timeout-detection-and-recovery) может произойти позже в канале, что еще больше затрудняет обнаружение основной причины.

### <a name="performance"></a>Производительность
Среда выполнения Direct3D 12 должна активно проявлять коллекцию существующих и недавно удаленных объектов API, индексируемых по виртуальному адресу (ва). Это увеличивает нагрузку на системную память и создает небольшое снижение производительности при создании и уничтожении объектов. По этой причине это поведение отключено по умолчанию.

### <a name="hardware-requirements"></a>Требования к оборудованию
Графический процессор, который не поддерживает ошибки страниц, по-прежнему может воспользоваться функцией автоматической адресной строки.

## <a name="setting-up-dred-in-code"></a>Настройка НАПРАВЛЯТЬ в коде
Параметры НАПРАВЛЯТЬ являются глобальными для процесса, и их необходимо настроить перед созданием устройства Direct3D 12. Для этого вызовите функцию [**D3D12GetDebugInterface**](/windows/desktop/api/d3d12/nf-d3d12-d3d12getdebuginterface) , чтобы получить [**ID3D12DeviceRemovedExtendedDataSettings**](/windows/desktop/api/d3d12/nn-d3d12-id3d12deviceremovedextendeddatasettings).

```cpp
CComPtr<ID3D12DeviceRemovedExtendedDataSettings> pDredSettings;
VERIFY_SUCCEEDED(D3D12GetDebugInterface(IID_PPV_ARGS(&pDredSettings)));

// Turn on auto-breadcrumbs and page fault reporting.
pDredSettings->SetAutoBreadcrumbsEnablement(D3D12_DRED_ENABLEMENT_FORCED_ON);
pDredSettings->SetPageFaultEnablement(D3D12_DRED_ENABLEMENT_FORCED_ON);
```

> [!NOTE]
> Изменения параметров НАПРАВЛЯТЬ не влияют на уже созданные устройства. Но последующие вызовы [**D3D12CreateDevice**](/windows/desktop/api/d3d12/nf-d3d12-d3d12createdevice) используют самые последние параметры направлять.

## <a name="accessing-dred-data-in-code"></a>Доступ к данным НАПРАВЛЯТЬ в коде
После обнаружения удаления устройства (например, **Present** возвращает [**DXGI_ERROR_DEVICE_REMOVED**](/windows/desktop/com/com-error-codes-10)) используйте методы интерфейса [**ID3D12DEVICEREMOVEDEXTENDEDDATA**](/windows/desktop/api/d3d12/nn-d3d12-id3d12deviceremovedextendeddata) для доступа к данным направлять для удаленного устройства.

Чтобы получить интерфейс **ID3D12DeviceRemovedExtendedData** , вызовите метод [QueryInterface](/windows/desktop/api/unknwn/nf-unknwn-iunknown-queryinterface(refiid_void)) в интерфейсе [ID3D12Device](/windows/win32/api/d3d12/nn-d3d12-id3d12device) (или производном), передав идентификатор интерфейса (IID) **ID3D12DeviceRemovedExtendedData**.

```cpp
void MyDeviceRemovedHandler(ID3D12Device * pDevice)
{
    CComPtr<ID3D12DeviceRemovedExtendedData> pDred;
    VERIFY_SUCCEEDED(pDevice->QueryInterface(IID_PPV_ARGS(&pDred)));
    D3D12_DRED_AUTO_BREADCRUMBS_OUTPUT DredAutoBreadcrumbsOutput;
    D3D12_DRED_PAGE_FAULT_OUTPUT DredPageFaultOutput;
    VERIFY_SUCCEEDED(pDred->GetAutoBreadcrumbsOutput(&DredAutoBreadcrumbsOutput));
    VERIFY_SUCCEEDED(pDred->GetPageFaultAllocationOutput(&DredPageFaultOutput));
    // Custom processing of DRED data can be done here.
    // Produce telemetry...
    // Log information to console...
    // break into a debugger...
}
```

## <a name="debugger-access-to-dred"></a>Доступ отладчика к НАПРАВЛЯТЬ
Отладчики имеют доступ к данным НАПРАВЛЯТЬ через **d3d12!** Экспорт данных D3D12DeviceRemovedExtendedData.

## <a name="dred-telemetry"></a>НАПРАВЛЯТЬ телеметрии
Приложение может использовать API НАПРАВЛЯТЬ для управления функциями НАПРАВЛЯТЬ и сбора данных телеметрии для облегчения анализа проблем. Это дает вам более широкие возможности для перехвата этих Тдрс.

Начиная с Windows 10 версии 1903, все события, удаленные в пользовательском режиме, передаются в [отчеты об ошибках Windows (WER)](/windows/desktop/wer/windows-error-reporting), также известном как Watson. Если конкретное сочетание приложения, GPU и видеодрайвера создает достаточное количество событий, удаленных устройством, возможно, НАПРАВЛЯТЬ будет временно включен для клиентов, запускающих то же приложение в аналогичной конфигурации.
