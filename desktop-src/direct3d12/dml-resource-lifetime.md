---
title: Время существования и синхронизация ресурсов
description: Чтобы избежать неопределенного поведения, приложение Директмл должно правильно управлять временем существования объектов и синхронизацией между ЦП и GPU.
ms.custom: Windows 10 May 2019 Update
ms.localizationpriority: high
ms.topic: article
ms.date: 04/19/2019
ms.openlocfilehash: 6e8ab30c5c87c135ef3bdac0c1bc2a3d64040787
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "74104339"
---
# <a name="resource-lifetime-and-synchronization"></a>Время существования и синхронизация ресурсов

Как и в Direct3D 12, приложение Директмл должно обеспечить правильное управление временем существования объектов и синхронизацией между ЦП и ГРАФИЧЕСКИм процессором (чтобы избежать неопределенного поведения). Директмл использует идентичную модель времени существования ресурсов для Direct3D 12.

- Зависимости времени существования между двумя объектами ЦП обслуживаются Директмл с помощью строгих счетчиков ссылок. Ваше приложение не вручную управлять зависимостями времени существования ЦП. Например, все дочерние устройства содержат строгую ссылку на родительское устройство.
- Зависимости времени существования между объектами GPU &mdash; или зависимостями, охватывающими ЦП и GPU, &mdash; не управляются автоматически. Ответственность за то, чтобы ресурсы GPU работали как минимум до тех пор, пока вся работа, использующая этот ресурс, не завершится выполнением на GPU.

## <a name="directml-devices"></a>Устройства Директмл

Устройство Директмл является потокобезопасным объектом фабрики без отслеживания состояния. Каждое дочернее устройство (см. [**идмлдевицечилд**](/windows/desktop/api/directml/nn-directml-idmldevicechild)) содержит строгую ссылку на родительское устройство директмл (см. [**идмлдевице**](/windows/desktop/api/directml/nn-directml-idmldevice)). Это означает, что вы всегда можете получить родительский интерфейс устройства из любого дочернего интерфейса устройства.

Устройство Директмл, в свою очередь, содержит строгую ссылку на устройство Direct3D 12, которое использовалось для его создания (см. раздел [**ID3D12Device**](/windows/desktop/api/d3d12/nn-d3d12-id3d12device)и производные интерфейсы).

Так как устройство Директмл не имеет состояния, оно является неявно потокобезопасным. Вы можете вызывать методы на устройстве Директмл из нескольких потоков одновременно, не требуя внешней синхронизации.

Однако, в отличие от устройства Direct3D 12, устройство Директмл не является одноэлементным объектом. Вы можете бесплатно создавать столько Директмл устройств. Однако вы не можете смешивать и сопоставлять дочерние устройства, принадлежащие разным устройствам. Например, [**идмлбиндингтабле**](/windows/desktop/api/directml/nn-directml-idmlbindingtable) и [**идмлкомпиледоператор**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator) — это два типа дочерних элементов устройства (оба интерфейса прямо или косвенно наследуются от **идмлдевицечилд**). И вы не можете использовать таблицу привязки (**идмлбиндингтабле**) для привязки оператора (**идмлкомпиледоператор**), если оператор и таблица привязки относятся к разным экземплярам устройства директмл.

Так как устройство Директмл не является singleton, удаление устройства происходит отдельно для каждого устройства, а не как событие на уровне процесса, как для устройства Direct3D 12. Дополнительные сведения см. [в разделе Обработка ошибок и удаление устройств в директмл](dml-errors.md).

## <a name="lifetime-requirements-of-gpu-resources"></a>Требования к времени существования ресурсов GPU

Как и Direct3D 12, Директмл не выполняет автоматическую синхронизацию между ЦП и GPU; Кроме того, не будет автоматически поддерживать ресурсы, пока они используются графическим процессором. Вместо этого они являются обязанностями вашего приложения.

При выполнении списка команд, содержащего диспетчеризации Директмл, приложение должно обеспечить активность ресурсов GPU до тех пор, пока вся работа, использующая эти ресурсы, не завершится выполнением на GPU.

В случае с [**идмлкоммандрекордер:: рекорддиспатч**](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch) для оператора директмл, который включает следующие объекты:

- [**Идмлкомпиледоператор**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator) выполняется (или [**идмлоператоринитиализер**](/windows/desktop/api/directml/nn-directml-idmloperatorinitializer) , если выполняется инициализация оператора).
- **Идмлкомпиледоператор** , который используется для привязки оператора к таблице привязки.
- Объекты [**ID3D12Resource**](/windows/desktop/api/d3d12/nn-d3d12-id3d12resource) , привязанные как входные и выходные данные оператора.
- Объекты **ID3D12Resource** , привязанные как постоянные и временные ресурсы, если это применимо.
- [**ID3D12CommandAllocator**](/windows/desktop/api/d3d12/nn-d3d12-id3d12commandallocator) создает резервную копию списка команд.

Не все интерфейсы Директмл представляют ресурсы GPU. Например, таблицу привязки не нужно хранить в активном состоянии, пока все диспетчеризации, использующие ее, *не* завершили выполнение на GPU. Это обусловлено тем, что сама таблица привязки не владеет ресурсами GPU. Напротив, куча дескрипторов делает. Таким образом, базовая *куча дескрипторов* — это объект, который должен оставаться активным до завершения выполнения, а не саму таблицу привязки.

Аналогичная концепция существует в Direct3D 12. *Распределитель* команд должен оставаться активным до тех пор, пока все выполнения, использующие его, не будут завершены на GPU. так как он владеет памятью GPU. Однако *список* команд не владеет памятью GPU, поэтому его можно сбросить или освободить сразу же после отправки для выполнения.

В Директмл скомпилированные операторы ([**идмлкомпиледоператор**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator)) и инициализаторы операторов ([**идмлоператоринитиализер**](/windows/desktop/api/directml/nn-directml-idmloperatorinitializer)) напрямую являются ресурсами GPU, поэтому они должны оставаться в активном состоянии до тех пор, пока все диспетчеризации, использующие их, не завершат выполнение на GPU. Кроме того, все используемые ресурсы Direct3D 12 (распределителя команд, кучи дескрипторов, буферы и т. д.) также должны храниться в активном приложении.

Если вы преждевременно выпустили объект, когда он по-прежнему используется GPU, результат является неопределенным поведением, что может вызвать удаление устройства или другие ошибки.

## <a name="cpu-and-gpu-synchronization"></a>Синхронизация ЦП и GPU

Директмл сам по себе не отправляет никаких операций для выполнения на GPU. Вместо этого метод [ **идмлкоммандрекордер:: рекорддиспатч**](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch) *записывает* данные об отправке этой работы в список команд для последующего выполнения. Приложение должно закрыться и отправить список команд для выполнения, вызвав [**ID3D12CommandQueue:: ексекутекоммандлистс**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-executecommandlists), как и любой список команд Direct3D 12.

Поскольку Директмл сам по себе не отправляет никаких операций на выполнение на GPU, он также не создает никаких ограждений и не выполняет синхронизацию ЦП и GPU от вашего имени. Приложение обязано использовать соответствующие примитивы Direct3D 12 для ожидания выполнения отправленной работы на GPU, если это необходимо. Дополнительные сведения см. в разделе [**ID3D12Fence**](/windows/desktop/api/d3d12/nn-d3d12-id3d12fence) and [**ID3D12CommandQueue:: Signal**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-signal).

## <a name="see-also"></a>См. также раздел

* [Исполнение и синхронизация списков команд](/windows/desktop/direct3d12/executing-and-synchronizing-command-lists)
* [Обработка ошибок и удаление устройств в Директмл](dml-errors.md)