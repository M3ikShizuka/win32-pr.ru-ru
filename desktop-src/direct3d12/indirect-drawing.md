---
title: Косвенная прорисовка
description: Непрямая прорисовка позволяет перемещаться на несколько сцен из ЦП в GPU, что может повысить производительность. Буфер команд может создаваться ЦП или GPU.
ms.assetid: F8D6C88A-101E-4F66-999F-43206F6527B6
ms.localizationpriority: high
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6fa474a469d5789d4b31830400d981ea771db2e8
ms.sourcegitcommit: b9a7a48e52219bf8d33e6b8171fc9f8b52151e92
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/21/2021
ms.locfileid: "112421882"
---
# <a name="indirect-drawing"></a>Косвенная прорисовка

Непрямая прорисовка позволяет перемещаться на несколько сцен из ЦП в GPU, что может повысить производительность. Буфер команд может создаваться ЦП или GPU.

-   [Сигнатуры команд](#command-signatures)
-   [Непрямые структуры буфера аргументов](#indirect-argument-buffer-structures)
-   [Создание подписи команды](#command-signature-creation)
    -   [Нет изменений аргументов](#no-argument-changes)
    -   [Корневые константы и буферы вершин](#root-constants-and-vertex-buffers)
-   [Связанные темы](#related-topics)

## <a name="command-signatures"></a>Сигнатуры команд

Объект сигнатуры команды ([**ID3D12CommandSignature**](/windows/win32/api/d3d12/nn-d3d12-id3d12commandsignature)) позволяет приложениям указывать косвенное рисование, в частности, при указании следующих параметров:

-   Формат буфера непрямого аргумента.
-   Тип команды, которая будет использоваться (из методов [**ID3D12GraphicsCommandList**](/windows/desktop/api/d3d12/nn-d3d12-id3d12graphicscommandlist) [**дравинстанцед**](/windows/desktop/api/d3d12/nf-d3d12-id3d12graphicscommandlist-drawinstanced), [**дравиндексединстанцед**](/windows/desktop/api/d3d12/nf-d3d12-id3d12graphicscommandlist-drawindexedinstanced)или [**Dispatch**](/windows/desktop/api/d3d12/nf-d3d12-id3d12graphicscommandlist-dispatch)).
-   Набор привязок ресурсов, которые будут изменять вызов по команде и набор, который будет унаследован.

При запуске приложение создает небольшой набор **сигнатур команд**. Во время выполнения приложение заполняет буфер с помощью команд (по своему усмотрению, что выбирает разработчик приложения). Команды могут содержать состояние, заданное для представлений буфера вершин, представления буферного буфера, корневых и корневых дескрипторов (необработанные или структурированные SRV/UAV/КБВС). Эти макеты аргументов не относятся к оборудованию, поэтому приложения могут создавать буферы напрямую. Сигнатура команды наследует оставшееся состояние из списка команд. Затем приложение вызывает [**ексекутеиндирект**](/windows/desktop/api/d3d12/nf-d3d12-id3d12graphicscommandlist-executeindirect) , чтобы сообщить GPU, что содержимое буфера непрямого аргумента интерпретируется в соответствии с форматом, определенным определенной сигнатурой команды.

Если сигнатура команды изменяет любые корневые аргументы, она сохраняется в сигнатуре команды в качестве подмножества корневой подписи.

Обратите внимание, что при завершении выполнения не происходит утечки состояния сигнатуры команды в список команд.

Например, предположим, что разработчику приложения требуется уникальная корневая константа, указанная для индивидуального вызова Draw в буфере непрямого аргумента. Приложение создаст сигнатуру команды, которая позволяет буферу аргументов косвенно указать следующие параметры для каждого вызова Draw:

-   Значение одной корневой константы.
-   Аргументы рисования (число вершин, число экземпляров и т. д.).

Буфер непрямого аргумента, созданный приложением, будет содержать массив записей фиксированного размера. Каждая структура соответствует одному вызову Draw. Каждая структура содержит аргументы рисования и значение корневой константы. Число вызовов Draw указывается в отдельном буфере, видимом для GPU.

Пример буфера команд, создаваемого приложением, выглядит следующим образом:

![формат буфера команд](images/indirect-drawing-command-buffer.png)

## <a name="indirect-argument-buffer-structures"></a>Непрямые структуры буфера аргументов

Следующие структуры определяют, как конкретные аргументы появляются в буфере непрямого аргумента. Эти структуры не отображаются ни в одном API D3D12. Приложения используют эти определения при записи в буфер непрямого аргумента (с ЦП или GPU):

-   [**\_Аргументы рисования \_ D3D12**](/windows/desktop/api/d3d12/ns-d3d12-d3d12_draw_arguments)
-   [**D3D12 \_ Рисование \_ индексированных \_ аргументов**](/windows/desktop/api/d3d12/ns-d3d12-d3d12_draw_indexed_arguments)
-   [**\_Аргументы ДИСПЕТЧЕРИЗАЦИИ \_ D3D12**](/windows/desktop/api/d3d12/ns-d3d12-d3d12_dispatch_arguments)
-   [**\_ \_ Представление буфера вершин \_ D3D12**](/windows/desktop/api/d3d12/ns-d3d12-d3d12_vertex_buffer_view)
-   [**\_ \_ Представление буфера D3D12 \_ индекса**](/windows/desktop/api/d3d12/ns-d3d12-d3d12_index_buffer_view)
-   \_ \_ Виртуальный адрес GPU D3D12 \_ (TYPEDEF, синоним UINT64).
-   [**\_ \_ Представление буфера констант \_ D3D12**](/windows/desktop/api/d3d12/ns-d3d12-d3d12_constant_buffer_view_desc)

## <a name="command-signature-creation"></a>Создание подписи команды

Чтобы создать сигнатуру команды, используйте следующие элементы API:

-   [**ID3D12Device:: креатекоммандсигнатуре**](/windows/desktop/api/d3d12/nf-d3d12-id3d12device-createcommandsignature) (выводит [**ID3D12CommandSignature**](/windows/win32/api/d3d12/nn-d3d12-id3d12commandsignature))
-   [**\_Тип непрямого \_ АРГУМЕНТа D3D12 \_**](/windows/desktop/api/d3d12/ne-d3d12-d3d12_indirect_argument_type)
-   [**D3D12 \_ непрямого \_ аргумента \_ DESC**](/windows/desktop/api/d3d12/ns-d3d12-d3d12_indirect_argument_desc)
-   [**\_ \_ DESC сигнатуры команды D3D12 \_**](/windows/desktop/api/d3d12/ns-d3d12-d3d12_command_signature_desc)

Порядок аргументов в непрямом буфере аргумента определяется в точном соответствии с порядком аргументов, указанных в параметре *паргументс* в описании [**\_ \_ сигнатуры \_ команды D3D12**](/windows/desktop/api/d3d12/ns-d3d12-d3d12_command_signature_desc). Все аргументы для одной операции рисования (графического)/диспатч (COMPUTE) в буфере непрямого аргумента тесно упакованы. Однако приложениям разрешено указывать произвольный шаг байта между командами рисования и диспетчеризации в буфере непрямого аргумента.

Корневая подпись должна быть указана только в том случае, если сигнатура команды изменяет один из корневых аргументов.

Для корневого каталога SRV/UAV/CBV размер приложения задается в байтах. Отладочный слой будет проверять следующие ограничения на адрес:

-   CBV — адрес должен быть кратным 256 байт.
-   Необработанный SRV/UAV — адрес должен быть кратен 4 байтам.
-   Структурированный SRV/UAV — адрес должен быть кратен шагу байт структуры (объявленному в шейдере).

Данная сигнатура команды является сигнатурой команды Draw или COMPUTE. Если сигнатура команды содержит операцию рисования, то она является графической сигнатурой команды. В противном случае сигнатура команды должна содержать операцию диспетчеризации и является сигнатурой команды вычислений.

В следующих разделах приведены примеры сигнатур команд.

### <a name="no-argument-changes"></a>Нет изменений аргументов

В этом примере буфер непрямого аргумента, созданный приложением, содержит массив из 36-байтовых структур. Каждая структура содержит только пять параметров, переданных в [**дравиндексединстанцед**](/windows/desktop/api/d3d12/nf-d3d12-id3d12graphicscommandlist-drawindexedinstanced) (и заполнение).

Ниже приведен код для создания описания сигнатуры команды.

``` syntax
D3D12_INDIRECT_ARGUMENT_DESC Args[1];
Args[0].Type = D3D12_INDIRECT_ARGUMENT_TYPE_DRAW_INDEXED;

D3D12_COMMAND_SIGNATURE_DESC ProgramDesc;
ProgramDesc.ByteStride = 36;
ProgramDesc.NumArgumentDescs = 1;
ProgramDesc.pArguments = Args;
```

Макет одной структуры внутри непрямого буфера аргумента:



| Байты | Описание           |
|-------|-----------------------|
| 0:3   | индекскаунтперинстанце |
| 4:7   | InstanceCount         |
| 8:11  | стартиндекслокатион    |
| 12:15 | басевертекслокатион    |
| 16:19 | стартинстанцелокатион |
| 20:35 | Заполнение               |



 

### <a name="root-constants-and-vertex-buffers"></a>Корневые константы и буферы вершин

В этом примере каждая структура в непрямом буфере аргумента изменяет две корневые константы, изменяет одну привязку буфера вершин и выполняет одну операцию рисования неиндексированных операций. Между структурами отсутствует заполнение.

Код для создания описания сигнатуры команды:

``` syntax
D3D12_INDIRECT_ARGUMENT_DESC Args[4];
Args[0].Type = D3D12_INDIRECT_ARGUMENT_TYPE_CONSTANT;
Args[0].Constant.RootParameterIndex = 2;
Args[0].Constant.DestOffsetIn32BitValues = 0;
Args[0].Constant.Num32BitValuesToSet = 1;

Args[1].Type = D3D12_INDIRECT_ARGUMENT_TYPE_CONSTANT;
Args[1].Constant.RootParameterIndex = 6;
Args[1].Constant.DestOffsetIn32BitValues = 0;
Args[1].Constant.Num32BitValuesToSet = 1;

Args[2].Type = D3D12_INDIRECT_ARGUMENT_TYPE_VERTEX_BUFFER_VIEW;
Args[2].VertexBuffer.Slot = 3;

Args[3].Type = D3D12_INDIRECT_ARGUMENT_TYPE_DRAW;

D3D12_COMMAND_SIGNATURE_DESC ProgramDesc;
ProgramDesc.ByteStride = 40;
ProgramDesc.NumArgumentDescs = 4;
ProgramDesc.pArguments = Args;
```

Макет одной структуры внутри непрямого аргумента имеет следующий вид:



| Байты | Описание                               |
|-------|-------------------------------------------|
| 0:3   | Данные для индекса корневого параметра 2           |
| 4:7   | Данные для индекса корневого параметра 6           |
| 8:15  | Виртуальный адрес VB в слоте 3 (64-разрядный)  |
| 16:19 | Размер VB                                   |
| 20:23 | Шаг VB                                 |
| 24:27 | вертекскаунтперинстанце                    |
| 28:31 | InstanceCount                             |
| 32:35 | стартвертекслокатион                       |
| 36:39 | стартинстанцелокатион                     |



 

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Учебные видеоматериалы по DirectX для расширенного обучения: выполнение непрямого и асинхронного отбора GPU](https://www.youtube.com/watch?v=fKD-VKJeeds)
</dt> <dt>

[Косвенное применение изображения и GPU: пошаговое руководство по коду](indirect-drawing-and-gpu-culling-.md)
</dt> <dt>

[Отрисовка](rendering.md)
</dt> </dl>

 

 
