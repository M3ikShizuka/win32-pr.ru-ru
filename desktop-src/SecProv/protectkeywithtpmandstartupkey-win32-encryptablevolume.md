---
description: Если доверенный платформенный модуль (TPM) (TPM) доступен, этот метод обеспечивает защиту ключа шифрования тома, расширенного внешним ключом.
ms.assetid: 58bc2de7-645f-4049-949c-975062f8c8ce
title: Метод Протекткэйвистпмандстартупкэй класса Win32_EncryptableVolume
ms.topic: reference
ms.date: 05/31/2018
topic_type:
- APIRef
- kbSyntax
api_name:
- Win32_EncryptableVolume.ProtectKeyWithTPMAndStartupKey
api_type:
- COM
api_location:
- Root\CIMV2\Security\MicrosoftVolumeEncryption
ms.openlocfilehash: 2a15d001f3a92db2e9cb47cd319bbae4ab05ba9bf86b2105f30872159b237718
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119667134"
---
# <a name="protectkeywithtpmandstartupkey-method-of-the-win32_encryptablevolume-class"></a>Метод Протекткэйвистпмандстартупкэй \_ класса Win32 енкриптаблеволуме

Метод **протекткэйвистпмандстартупкэй** класса [**Win32 \_ енкриптаблеволуме**](win32-encryptablevolume.md) защищает ключ шифрования тома с помощью аппаратного обеспечения безопасности доверенный платформенный модуль (TPM) (доверенного платформенного модуля) на компьютере (при его наличии), дополненного внешним ключом, который должен быть представлен для компьютера при запуске.

Обе проверки TPM и вход USB-устройства памяти, содержащие внешний ключ, необходимы для доступа к ключу шифрования тома и разблокировки содержимого тома. Используйте метод [**савикстерналкэйтофиле**](saveexternalkeytofile-win32-encryptablevolume.md) , чтобы сохранить этот внешний ключ в файл на USB-устройстве для использования в качестве ключа запуска.

Этот метод применим только к тому, который содержит текущую операционную систему.

Для тома создается предохранитель ключа с типом "TPM и ключ запуска", если он еще не существует.

## <a name="syntax"></a>Синтаксис


```mof
uint32 ProtectKeyWithTPMAndStartupKey(
  [in, optional] string FriendlyName,
  [in, optional] uint8  PlatformValidationProfile[],
  [in, optional] uint8  ExternalKey[],
  [out]          string VolumeKeyProtectorID
);
```



## <a name="parameters"></a>Параметры

<dl> <dt>

*FriendlyName* \[ в необязательное\]
</dt> <dd>

Тип: **строка**

Назначенный пользователем строковый идентификатор для предохранителя ключа. Если этот параметр не указан, используется пустое значение.

</dd> <dt>

*Платформвалидатионпрофиле* \[ в необязательное\]
</dt> <dd>

Тип: **Uint8 \[ \]**

Массив целых чисел, указывающий, как оборудование безопасности доверенный платформенный модуль (TPM) компьютера (TPM) защищает ключ шифрования тома диска.

Профиль проверки платформы состоит из набора индексов реестра конфигурации платформы (PCR) в диапазоне от 0 до 23 включительно. Значения Repeat в параметре не учитываются. Каждый индекс PCR связан со службами, которые выполняются при запуске операционной системы. При каждом запуске компьютера доверенный платформенный модуль проверит, не изменились ли службы, указанные в профиле проверки платформы. Если какая-либо из этих служб изменилась, когда шифрование диска BitLocker (BDE) остается включенной, доверенный платформенный модуль не будет освобождать ключ шифрования для разблокировки тома диска, и компьютер будет переведен в режим восстановления.

Если этот параметр задан, а соответствующий параметр групповая политика включен, он должен соответствовать параметру групповая политика.

Если этот параметр не указан, используется значение по умолчанию, равное 0, 2, 4, 5, 8, 9, 10 и 11. Профиль проверки платформы по умолчанию защищает ключ шифрования от изменений в следующих элементах:

-   Основной корень доверия измерения (КРТМ)
-   BIOS
-   Расширения платформы (PCR 0)
-   Код варианта ПЗУ (PCR 2)
-   Код основной загрузочной записи (PCR 4)
-   Таблица разделов основной загрузочной записи (PCR 5)
-   Загрузочный сектор NTFS (PCR 8)
-   Загрузочный блок NTFS (PCR 9)
-   Диспетчер загрузки (PCR 10)
-   Контроль доступа BitLocker (PCR 11)

Для обеспечения безопасности компьютера рекомендуется использовать профиль по умолчанию. Для дополнительной защиты от изменений в конфигурации с ранним запуском используйте профиль PCRs 0, 1, 2, 3, 4, 5, 8, 9, 10, 11. Компьютеры на основе Единый интерфейс EFI (UEFI) по умолчанию не используют PCR 5.

Изменение профиля по умолчанию влияет на безопасность и управляемость компьютера. Чувствительность BitLocker к изменениям платформы (вредоносных или полномочных) увеличивается или уменьшается в зависимости от включения или исключения, соответственно, для PCRs. Чтобы включить защиту BitLocker, профиль проверки платформы должен включать PCR 11.



| Значение                                                                         | Значение                                                                            |
|-------------------------------------------------------------------------------|------------------------------------------------------------------------------------|
| <dl> <dt>0</dt> </dl>  | Корневой корень доверия измерений (КРТМ), BIOS и расширений платформы<br/> |
| <dl> <dt>1</dt> </dl>  | Конфигурация и данные платформы и материнской платы<br/>                         |
| <dl> <dt>2</dt> </dl>  | Код варианта ПЗУ<br/>                                                         |
| <dl> <dt>3</dt> </dl>  | Конфигурация и данные с поддержкой ПЗУ<br/>                                       |
| <dl> <dt>4</dt> </dl>  | Код основной загрузочной записи (MBR)<br/>                                           |
| <dl> <dt>5</dt> </dl>  | Таблица разделов основной загрузочной записи (MBR)<br/>                                |
| <dl> <dt>6</dt> </dl>  | События смены состояния и пробуждения<br/>                                        |
| <dl> <dt>7</dt> </dl>  | Manufacturer-Specific компьютера<br/>                                          |
| <dl> <dt>8</dt> </dl>  | Загрузочный сектор NTFS<br/>                                                        |
| <dl> <dt>9</dt> </dl>  | Загрузочный блок NTFS<br/>                                                         |
| <dl> <dt>10</dt> </dl> | Диспетчер загрузки<br/>                                                            |
| <dl> <dt>11</dt> </dl> | Контроль доступа BitLocker<br/>                                                |
| <dl> <dt>12</dt> </dl> | Определено для использования статической операционной системой<br/>                          |
| <dl> <dt>13</dt> </dl> | Определено для использования статической операционной системой<br/>                          |
| <dl> <dt>14</dt> </dl> | Определено для использования статической операционной системой<br/>                          |
| <dl> <dt>15</dt> </dl> | Определено для использования статической операционной системой<br/>                          |
| <dl> <dt>16</dt> </dl> | Используется для отладки<br/>                                                      |
| <dl> <dt>17</dt> </dl> | Динамический КРТМ<br/>                                                            |
| <dl> <dt>стр</dt> </dl> | Определенная платформа<br/>                                                        |
| <dl> <dt>19</dt> </dl> | Используется доверенной операционной системой<br/>                                      |
| <dl> <dt>20</dt> </dl> | Используется доверенной операционной системой<br/>                                      |
| <dl> <dt>открыт</dt> </dl> | Используется доверенной операционной системой<br/>                                      |
| <dl> <dt>22</dt> </dl> | Используется доверенной операционной системой<br/>                                      |
| <dl> <dt>23</dt> </dl> | Поддержка приложений<br/>                                                     |



 

</dd> <dt>

*Екстерналкэй* \[ в необязательное\]
</dt> <dd>

Тип: **Uint8 \[ \]**

Массив байтов, указывающий 256-разрядный внешний ключ, используемый для разблокировки тома при запуске компьютера.

Если внешний ключ не указан, он создается случайным образом. Используйте метод [**жеткэйпротекторекстерналкэй**](getkeyprotectorexternalkey-win32-encryptablevolume.md) для получения созданного случайным образом ключа.

</dd> <dt>

*Волумекэйпротекторид* \[ заполняет\]
</dt> <dd>

Тип: **строка**

Строка, которая представляет собой уникальный идентификатор, связанный с созданным предохранителем ключа, который можно использовать для управления предохранителем ключа.

Если диск поддерживает аппаратное шифрование, а BitLocker не использует нестандартное владение, для строки идентификатора задается значение "BitLocker", а предохранитель ключа записывается в метаданные диапазона.

</dd> </dl>

## <a name="return-value"></a>Возвращаемое значение

Тип: **UInt32**

При сбое этот метод возвращает один из следующих кодов или другой код ошибки.



| Возвращаемый код и значение                                                                                                                                                                         | Описание                                                                                                                                                                                                                                                            |
|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <dl> <dt>**С \_ ОК**</dt> <dt>0 (0x0)</dt> </dl>                                         | Метод успешно выполнен.<br/>                                                                                                                                                                                                                                  |
| <dl> <dt>**ФВЕ \_ E с \_ заблокированным \_ томом**</dt> <dt>2150694912 (0x80310000)</dt> </dl>        | Том заблокирован.<br/>                                                                                                                                                                                                                                       |
| <dl> <dt>**TBS \_ \_Служба E \_ не \_ работает**</dt> <dt>2150121480 (0x80284008)</dt> </dl> | На этом компьютере не найден совместимый доверенный платформенный модуль.<br/>                                                                                                                                                                                                                |
| <dl> <dt>**ФВЕ \_ E \_ внешний \_ том**</dt> <dt>2150694947 (0x80310023)</dt> </dl>       | Доверенный платформенный модуль не может защитить ключ шифрования тома, так как этот том не содержит текущую операционную систему.<br/>                                                                                                                               |
| <dl> <dt>**Д \_ INVALIDARG**</dt> <dt>2147942487 (0x80070057)</dt> </dl>                 | Параметр *платформвалидатионпрофиле* предоставляется, но его значения не находятся в известном диапазоне или не соответствуют текущему параметру групповая политика.<br/> Параметр *екстерналкэй* предоставляется, но не является массивом размера 32.<br/> |
| <dl> <dt>**ФВЕ \_ E \_ загрузочная \_ кддвд**</dt> <dt>2150694960 (0x80310030)</dt> </dl>       | На этом компьютере находится загрузочный компакт-диск или DVD-диск. Удалите компакт-диск или диск DVD и перезагрузите компьютер.<br/>                                                                                                                                                                    |
| <dl> <dt>**ФВЕ \_ Средство \_ защиты E \_ существует**</dt> <dt>2150694961 (0x80310031)</dt> </dl>     | Предохранитель ключа этого типа уже существует.<br/>                                                                                                                                                                                                                |



 

## <a name="security-considerations"></a>Соображения безопасности

Для обеспечения безопасности компьютера рекомендуется использовать профиль по умолчанию. Для дополнительной защиты от изменений кода раннего запуска используйте профиль PCRs 0, 2, 4, 5, 8, 9, 10 и 11. Для дополнительной защиты от изменений в конфигурации с ранним запуском используйте профиль PCRs 0, 1, 2, 3, 4, 5, 8, 9, 10, 11.

Изменение профиля по умолчанию влияет на безопасность или удобство использования компьютера.

## <a name="remarks"></a>Remarks

В любой момент времени может существовать не более одного предохранителя ключа типа "TPM и ключ запуска" для тома. Если вы хотите изменить отображаемое имя или профиль проверки платформы, используемый существующим предохранителем ключа "TPM и ключ запуска", необходимо сначала удалить существующий предохранитель ключа, а затем вызвать **протекткэйвистпмандстартупкэй** , чтобы создать новый. Необходимо указать дополнительные предохранители ключа, чтобы разблокировать том в сценариях восстановления, где невозможно получить доступ к ключу шифрования тома. Например, если доверенный платформенный модуль не может успешно проверить профиль проверки платформы или если USB-память, содержащая внешний ключ, потеряна.

Используйте [**протекткэйвисекстерналкэй**](protectkeywithexternalkey-win32-encryptablevolume.md) или [**протекткэйвиснумерикалпассворд**](protectkeywithnumericalpassword-win32-encryptablevolume.md) , чтобы создать один или несколько предохранителей ключа для восстановления тома, заблокированного иным образом.

Хотя возможно наличие предохранителя ключа типа "TPM" и другого типа "TPM и ключ запуска", наличие типа предохранителя ключа "TPM" отрицательно влияет на влияние других предохранителей ключей на основе TPM.

файлы MOF-файл (MOF) содержат определения для классов инструментарий управления Windows (WMI) (WMI). MOF-файлы не устанавливаются в составе Windows SDK. Они устанавливаются на сервере при добавлении связанной роли с помощью диспетчер сервера. Дополнительные сведения о файлах MOF см. в разделе [MOF-файл (MOF)](../wmisdk/managed-object-format--mof-.md).

## <a name="requirements"></a>Requirements (Требования)



| Требование | Значение |
|-------------------------------------|---------------------------------------------------------------------------------------------------------|
| Минимальная версия клиента<br/> | Windows vista Enterprise, \[ только для настольных приложений Windows vista Ultimate\]<br/>                       |
| Минимальная версия сервера<br/> | Windows Только для \[ настольных приложений сервера 2008\]<br/>                                                    |
| Пространство имен<br/>                | Корневой \\ CIMV2 \\ безопасности \\ микрософтволуминкриптион<br/>                                             |
| MOF<br/>                      | <dl> <dt>Win32 \_ енкриптаблеволуме. mof</dt> </dl> |



## <a name="see-also"></a>См. также

<dl> <dt>

[**\_Енкриптаблеволуме Win32**](win32-encryptablevolume.md)
</dt> <dt>

[**\_TPM Win32**](win32-tpm.md)
</dt> </dl>

 

 
