---
description: Защищает ключ шифрования тома, используя доверенный платформенный модуль (TPM) (доверенный платформенный модуль) на компьютере (если он доступен), дополненный пользовательским идентификационным номером (PIN) и внешним ключом, который должен быть представлен компьютеру при запуске.
ms.assetid: 8991c22c-1e36-415e-a82b-c5ddf9c3b24a
title: Метод Протекткэйвистпмандпинандстартупкэй класса Win32_EncryptableVolume
ms.topic: reference
ms.date: 05/31/2018
topic_type:
- APIRef
- kbSyntax
api_name:
- Win32_EncryptableVolume.ProtectKeyWithTPMAndPINAndStartupKey
api_type:
- COM
api_location:
- Root\CIMV2\Security\MicrosoftVolumeEncryption
ms.openlocfilehash: c4a77c0e5687319bbea438127ce9c30b27ff3122f42359237df5d4cd158b1393
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119004352"
---
# <a name="protectkeywithtpmandpinandstartupkey-method-of-the-win32_encryptablevolume-class"></a>Метод Протекткэйвистпмандпинандстартупкэй \_ класса Win32 енкриптаблеволуме

Метод **протекткэйвистпмандпинандстартупкэй** класса [**Win32 \_ енкриптаблеволуме**](win32-encryptablevolume.md) защищает ключ шифрования тома, используя доверенный платформенный модуль (TPM) (доверенный платформенный модуль) на компьютере (если он доступен), дополненный пользовательским идентификационным номером (PIN) и внешним ключом, который должен быть представлен компьютеру при запуске.

Для разблокировки зашифрованного содержимого тома необходимы три фактора проверки подлинности:

1.  Проверка с помощью TPM
2.  Ввод ПИН-кода с 4 до 20 цифр или, если включена групповая политика "разрешить Расширенные ПИН для запуска", от 4 до 20 букв, символов, пробелов или чисел
3.  Входные данные USB-накопителя, содержащего внешний ключ

Используйте метод [**савикстерналкэйтофиле**](saveexternalkeytofile-win32-encryptablevolume.md) , чтобы сохранить этот внешний ключ в файл на USB-устройстве для использования в качестве ключа запуска. Этот метод применяется только к тому операционной системы. Создается предохранитель ключа типа "TPM и ПИН-код и ключ запуска".

## <a name="syntax"></a>Синтаксис


```mof
uint32 ProtectKeyWithTPMAndPINAndStartupKey(
  [in, optional] string FriendlyName,
  [in, optional] uint8  PlatformValidationProfile,
  [in]           string PIN,
  [in, optional] uint8  ExternalKey[],
  [out]          string VolumeKeyProtectorID
);
```



## <a name="parameters"></a>Параметры

<dl> <dt>

*FriendlyName* \[ в необязательное\]
</dt> <dd>

Тип: **строка**

Строка, которая помечает этот предохранитель ключа. Если этот параметр не указан, используется пустое значение.

</dd> <dt>

*Платформвалидатионпрофиле* \[ в необязательное\]
</dt> <dd>

Тип: **Uint8**

Массив целых чисел, указывающий, как доверенный платформенный модуль компьютера защищает ключ шифрования тома. Профиль проверки платформы состоит из набора индексов реестра конфигурации платформы (PCR) в диапазоне от 0 до 23 включительно. Значения Repeat в параметре не учитываются. Каждый индекс PCR связан со службами, которые выполняются при запуске операционной системы. При каждом запуске компьютера доверенный платформенный модуль проверит, не изменились ли службы, указанные в профиле проверки платформы. Если любая из этих служб изменится, а защита BitLocker остается включенной, доверенный платформенный модуль не будет освобождать ключ шифрования для разблокировки тома, и компьютер будет переведен в режим восстановления.

Если этот параметр не указан, используются индексы по умолчанию 0, 2, 4, 5, 8, 9, 10 и 11. Профиль проверки платформы по умолчанию защищает ключ шифрования от изменений в основном корне доверия измерений (КРТМ). BIOS и расширения платформы (PCR 0), код варианта ПЗУ (PCR 2), код основной загрузочной записи (PCR 4), таблица разделов основной загрузочной записи (PCR 5), загрузочный сектор NTFS (PCR 8), загрузочный блок NTFS (PCR 9),  Диспетчер загрузки (PCR 10) и контроль доступа BitLocker (PCR 11). Компьютеры на основе Единый интерфейс EFI (UEFI) по умолчанию не используют PCR 5.

Рекомендуется использовать профиль проверки платформы по умолчанию. Для дополнительной защиты от изменений в конфигурации с ранним запуском используйте профиль PCRs 0, 1, 2, 3, 4, 5, 8, 9, 10, 11.

Изменение профиля по умолчанию влияет на безопасность и управляемость компьютера. Чувствительность BitLocker к изменениям платформы (вредоносных или полномочных) увеличивается или уменьшается в зависимости от включения или исключения, соответственно, для PCRs. Чтобы включить защиту BitLocker, профиль проверки платформы должен включать PCR 11.



| Значение                                                                         | Значение                                                                            |
|-------------------------------------------------------------------------------|------------------------------------------------------------------------------------|
| <dl> <dt>0</dt> </dl>  | Корневой корень доверия измерений (КРТМ), BIOS и расширений платформы<br/> |
| <dl> <dt>1</dt> </dl>  | Конфигурация и данные платформы и материнской платы<br/>                         |
| <dl> <dt>2</dt> </dl>  | Код варианта ПЗУ<br/>                                                         |
| <dl> <dt>3</dt> </dl>  | Конфигурация и данные с поддержкой ПЗУ<br/>                                       |
| <dl> <dt>4</dt> </dl>  | Код основной загрузочной записи (MBR)<br/>                                           |
| <dl> <dt>5</dt> </dl>  | Таблица разделов основной загрузочной записи (MBR)<br/>                                |
| <dl> <dt>6</dt> </dl>  | События смены состояния и пробуждения<br/>                                        |
| <dl> <dt>7</dt> </dl>  | Manufacturer-Specific компьютера<br/>                                          |
| <dl> <dt>8</dt> </dl>  | Загрузочный сектор NTFS<br/>                                                        |
| <dl> <dt>9</dt> </dl>  | Загрузочный блок NTFS<br/>                                                         |
| <dl> <dt>10</dt> </dl> | Диспетчер загрузки<br/>                                                            |
| <dl> <dt>11</dt> </dl> | Контроль доступа BitLocker<br/>                                                |
| <dl> <dt>12</dt> </dl> | Определено для использования статической операционной системой<br/>                          |
| <dl> <dt>13</dt> </dl> | Определено для использования статической операционной системой<br/>                          |
| <dl> <dt>14</dt> </dl> | Определено для использования статической операционной системой<br/>                          |
| <dl> <dt>15</dt> </dl> | Определено для использования статической операционной системой<br/>                          |
| <dl> <dt>16</dt> </dl> | Используется для отладки<br/>                                                      |
| <dl> <dt>17</dt> </dl> | Динамический КРТМ<br/>                                                            |
| <dl> <dt>стр</dt> </dl> | Определенная платформа<br/>                                                        |
| <dl> <dt>19</dt> </dl> | Используется доверенной операционной системой<br/>                                      |
| <dl> <dt>20</dt> </dl> | Используется доверенной операционной системой<br/>                                      |
| <dl> <dt>открыт</dt> </dl> | Используется доверенной операционной системой<br/>                                      |
| <dl> <dt>22</dt> </dl> | Используется доверенной операционной системой<br/>                                      |
| <dl> <dt>23</dt> </dl> | Поддержка приложений<br/>                                                     |



 

</dd> <dt>

*Закрепить* \[ окне\]
</dt> <dd>

Тип: **строка**

Содержит 4 – 20-значный персональный идентификационный номер (ПИН-код) или, если включена групповая политика "разрешить Расширенные ПИН-коды для запуска", 4 и 20 букв, символов, пробелов или чисел. Эта строка должна быть предоставлена компьютеру при запуске.

</dd> <dt>

*Екстерналкэй* \[ в необязательное\]
</dt> <dd>

Тип: **Uint8 \[ \]**

Массив байтов, указывающий 256-разрядный внешний ключ, используемый для разблокировки тома при запуске компьютера. Оставьте этот параметр пустым, чтобы создать внешний ключ случайным образом. Используйте метод [**жеткэйпротекторекстерналкэй**](getkeyprotectorexternalkey-win32-encryptablevolume.md) для получения созданного случайным образом ключа.

</dd> <dt>

*Волумекэйпротекторид* \[ заполняет\]
</dt> <dd>

Тип: **строка**

Обновленный уникальный идентификатор строки, используемый для управления предохранителем ключа зашифрованного тома.

Если диск поддерживает аппаратное шифрование, а BitLocker не использует нестандартное владение, для строки идентификатора задается значение "BitLocker", а предохранитель ключа записывается в метаданные диапазона.

</dd> </dl>

## <a name="return-value"></a>Возвращаемое значение

Тип: **UInt32**

При сбое этот метод возвращает один из следующих кодов или другой код ошибки.



| Возвращаемый код и значение                                                                                                                                                                                | Описание                                                                                                                                                                                                                                                                       |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <dl> <dt>**С \_ ОК**</dt> <dt>0 (0x0)</dt> </dl>                                                | Метод успешно выполнен.<br/>                                                                                                                                                                                                                                             |
| <dl> <dt>**Д \_ INVALIDARG**</dt> <dt>2147942487 (0x80070057)</dt> </dl>                        | Параметр *платформвалидатионпрофиле* предоставляется, но его значения не находятся в известном диапазоне или не соответствуют параметрам групповая политика, действующим в данный момент.<br/> Параметр *екстерналкэй* предоставляется, но не является массивом размера 32.<br/> |
| <dl> <dt>**ФВЕ \_ E \_ загрузочная \_ кддвд**</dt> <dt>2150694960 (0x80310030)</dt> </dl>              | На этом компьютере находится загрузочный компакт-диск или DVD-диск. Удалите компакт-диск или диск DVD и перезагрузите компьютер.<br/>                                                                                                                                                                               |
| <dl> <dt>**ФВЕ \_ E \_ внешний \_ том**</dt> <dt>2150694947 (0x80310023)</dt> </dl>              | Доверенный платформенный модуль не может защитить ключ шифрования тома, так как этот том не содержит текущую операционную систему.<br/>                                                                                                                                          |
| <dl> <dt>**ФВЕ \_ E \_ Недопустимый \_ ПИН-код \_**</dt> <dt>2150695066 (0x8031009A)</dt> </dl>          | Параметр *невпин* содержит недопустимые символы. При отключении групповая политика "разрешить Расширенные ПИН-коды для запуска" поддерживаются только цифры.<br/>                                                                                                        |
| <dl> <dt>**ФВЕ \_ E с \_ заблокированным \_ томом**</dt> <dt>2150694912 (0x80310000)</dt> </dl>               | Том заблокирован.<br/>                                                                                                                                                                                                                                                  |
| <dl> <dt>**ФВЕ \_ E \_ Policy \_ Недопустимая \_ \_ длина ПИН-кода**</dt> <dt>2150695016 (0x80310068)</dt> </dl> | Предоставленный параметр *невпин* имеет длину более 20 символов, короче 4 символов, или короче минимальной длины, указанной групповая политика.<br/>                                                                                                          |
| <dl> <dt>**ФВЕ \_ Средство \_ защиты E \_ существует**</dt> <dt>2150694961 (0x80310031)</dt> </dl>            | Предохранитель ключа этого типа уже существует.<br/>                                                                                                                                                                                                                           |
| <dl> <dt>**TBS \_ \_Служба E \_ не \_ работает**</dt> <dt>2150121480 (0x80284008)</dt> </dl>        | На этом компьютере не найден совместимый доверенный платформенный модуль.<br/>                                                                                                                                                                                                                           |



 

## <a name="remarks"></a>Remarks

В любой момент времени может существовать не более одного предохранителя ключа с типом "TPM и ПИН-код и ключ запуска" для тома. Если вы хотите изменить отображаемое имя или профиль проверки платформы, используемый с предохранителем ключа TPM, ПИН-кода и ключа запуска, необходимо сначала удалить существующий предохранитель ключа, а затем вызвать **протекткэйвистпмандпинандстартупкэй** , чтобы создать новый.

Необходимо указать дополнительные предохранители ключа, чтобы разблокировать том в сценариях восстановления, где невозможно получить доступ к ключу шифрования тома. Например, если доверенный платформенный модуль не может успешно проверить профиль проверки платформы или при потере ПИН-кода. Используйте [**протекткэйвисекстерналкэй**](protectkeywithexternalkey-win32-encryptablevolume.md) или [**протекткэйвиснумерикалпассворд**](protectkeywithnumericalpassword-win32-encryptablevolume.md) , чтобы создать один или несколько предохранителей ключа для восстановления тома, заблокированного иным образом.

Хотя возможно наличие предохранителя ключа типа "TPM" и другого типа "TPM, ПИН-код и ключ запуска", наличие типа предохранителя ключа "TPM" негативно влияет на влияние других предохранителей ключей на основе доверенного платформенного модуля.

файлы MOF-файл (MOF) содержат определения для классов инструментарий управления Windows (WMI) (WMI). MOF-файлы не устанавливаются в составе Windows SDK. Они устанавливаются на сервере при добавлении связанной роли с помощью диспетчер сервера. Дополнительные сведения о файлах MOF см. в разделе [MOF-файл (MOF)](../wmisdk/managed-object-format--mof-.md).

## <a name="requirements"></a>Требования



| Требование | Значение |
|-------------------------------------|---------------------------------------------------------------------------------------------------------|
| Минимальная версия клиента<br/> | Windows vista Enterprise с пакетом обновления 1 (sp1), Windows Vista Ultimate с пакетом обновления 1 (sp1) \[\]<br/>     |
| Минимальная версия сервера<br/> | Windows Только для \[ настольных приложений сервера 2008\]<br/>                                                    |
| Пространство имен<br/>                | Корневой \\ CIMV2 \\ безопасности \\ микрософтволуминкриптион<br/>                                             |
| MOF<br/>                      | <dl> <dt>Win32 \_ енкриптаблеволуме. mof</dt> </dl> |



## <a name="see-also"></a>См. также раздел

<dl> <dt>

[**\_Енкриптаблеволуме Win32**](win32-encryptablevolume.md)
</dt> </dl>

 

 
