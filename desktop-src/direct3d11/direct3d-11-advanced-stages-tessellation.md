---
title: Этапы тесселяции
description: Среда выполнения Direct3D 11 поддерживает три новых этапа, реализующих тесселяцию, которая преобразует поверхности подразделений с низким уровнем детализации в примитивы более высокого уровня для GPU.
ms.assetid: 4ad2fd3e-6e1a-4326-8469-3198acf931dc
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 52d272ad1db53c6e70a856255c1826f4867f069897b42da0219cd334d48226d5
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118099236"
---
# <a name="tessellation-stages"></a>Этапы тесселяции

Среда выполнения Direct3D 11 поддерживает три новых этапа, реализующих тесселяцию, которая преобразует поверхности подразделений с низким уровнем детализации в примитивы более высокого уровня для GPU. Тесселяции разбивает на плитки поверхности старшего порядка на структуры, подходящие для прорисовки.

Реализуя тесселяцию на аппаратном оборудовании, графический конвейер может оценить модели низкой детализации (с малым числом полигоном) и прорисовать их более детально. Хоть выполнение тесселяции возможно и программными методами, аппаратная тесселяция может дать огромное число визуальных деталей (включая поддержку карт смещения) без добавления визуальных деталей к размерам моделей и парализации частот обновления.

-   [Преимущества тесселяции](#tessellation-benefits)
-   [Новые этапы конвейера](#new-pipeline-stages)
    -   [Поверхности — этап шейдера](#hull-shader-stage)
    -   [Стадия тесселяции](#tessellator-stage)
    -   [Этап шейдера домена](#domain-shader-stage)
-   [API для инициализации этапов тесселяции](#apis-for-initializing-tessellation-stages)
-   [Как:](#how-tos)
-   [Связанные темы](#related-topics)

## <a name="tessellation-benefits"></a>Преимущества тесселяции

Тесселяции

-   Экономит много памяти и пропускной способности, что позволяет приложению визуализировать более детализированные поверхности из моделей с низким разрешением. Методика тесселяции, реализованная в конвейере Direct3D 11, также поддерживает сопоставление смещения, что может привести к привлекательным объемам сведений о поверхности.
-   Поддерживает масштабируемые методы отрисовки, такие как непрерывные или Просмотр зависимых уровней детализации, которые можно рассчитывать на лету.
-   Повышает производительность, выполняя ресурсоемкие вычисления с более низкой частотой (выполняя вычисления в модели с более низким уровнем детализации). Сюда могут входить расчеты смешения с применением форм наложения и морфинговые цели для реалистичной анимации или физических расчетов для обнаружения столкновений или эмуляции динамики мягких тел.

Конвейер Direct3D 11 реализует тесселяцию в аппаратном обеспечении, что позволяет загружать работу с ЦП на GPU. Это может дать очень существенный прирост производительности, если в приложение реализуется большое число морфинговых целей и/или более сложные модели деформации/скиннинга. Чтобы получить доступ к новым функциям тесселяции, необходимо изучить некоторые новые этапы конвейера.

## <a name="new-pipeline-stages"></a>Новые этапы конвейера

В ходе тесселяции задействуется GPU для расчета более подробной поверхности из поверхности, составленной из преобразований четырехугольников, треугольников и изолиний. Для аппроксимации поверхности высокого порядка, каждое преобразование подразделяется на треугольники, точки и линии согласно факторам тесселяции. Конвейер Direct3D 11 реализует тесселяцию, используя три новых этапа конвейера:

-   [Поверхности-Shader Stage](#hull-shader-stage) — программируемый этап шейдера, который создает геометрический набор исправлений (и константы исправлений), соответствующий каждому выходному исправлению (Quad, треугольник или линия).
-   [Стадия тесселяции](#tessellator-stage) . этап конвейера фиксированной функции, который создает шаблон выборки для домена, который представляет собой исправление геометрии, и создает набор объектов меньшего размера (треугольники, точки или линии), соединяющий эти образцы.
-   [Этап шейдера домена](#domain-shader-stage) — программируемый этап шейдера, который вычисляет расположение вершины, соответствующее образцу каждого домена.

На следующей схеме показаны новые этапы конвейера Direct3D 11.

![схема конвейера direct3d 11, с выделенными этапами шейдера поверхности, тесселятора и шейдера доменов](images/d3d11-pipeline-stages-tessellation.png)

На следующей схеме показано выполнение этапов тесселяции. Выполнение начинается с меньшей поверхности с низкой степенью детализации. Далее рассматривается входное преобразование с соответствующим преобразованием геометрии, выборками домена и треугольниками, которые соединяют эти выборки. Наконец выделяются вершины, которые соответствуют этим выборкам.

![схема выполнения тесселяции](images/tess-prog.png)

### <a name="hull-shader-stage"></a>Стадия Hull-Shader

Шейдер поверхности, который вызывается один раз для каждого исправления — преобразует входные точки управления, которые определяют поверхность низкого порядка в контрольных точках, составляющих исправление. Он также выполняет некоторые вычисления с исправлениями для предоставления данных для этапа тесселяции и этапа домена. На самом простом уровне черного ящика этап поверхности-Shader будет выглядеть примерно так, как на следующей диаграмме.

![схема этапа шейдера поверхностей](images/d3d11-hull-shader.png)

Шейдер поверхности реализуется с помощью функции HLSL и имеет следующие свойства.

-   Вход шейдера находится в диапазоне от 1 до 32 контрольных точек.
-   Шейдер выводит от 1 до 32 контрольных точек независимо от количества факторов тесселяции. Выходные контрольные точки шейдера поверхностей могут использоваться на этапе шейдера доменов. Данные констант исправлений можно использовать в шейдере доменов. факторы тесселяции могут быть использованы шейдером доменов и стадией тесселяции.
-   Факторы тесселяции определяют, на сколько частей делить каждый участок.
-   Шейдер объявляет состояние, требуемое для этапа тесселяции. Сюда входят такие сведения, как число контрольных точек, тип поверхности участка и тип секционирования при тесселяции. Эти сведения появляются в виде объявлений, как правило, в начале кода шейдера.
-   Если на этапе поверхности-шейдера для каждого фактора тесселяции ребра задается значение = 0 или NaN, исправление будет исправлено. В результате, этап тесселяции может выполняться или не выполняться, шейдер доменов не будет выполняться, а для указанного участка не будет выдано видимых выходных данных.

На более глубоком уровне поверхности-шейдер на самом деле работает в два этапа: этап контрольной точки и фаза исправления — постоянной, которые выполняются параллельно с оборудованием. Компилятор HLSL извлекает параллелизм в шейдере поверхностей и кодирует его в байт-код, управляющий оборудованием.

-   Этап контрольных точек выполняется единожды для каждой контрольной точки. При этом считываются контрольные точки для участка и создается одна выходная контрольная точка (определенная ControlPointID).
-   Этап констант участков выполняется единожды для каждого участка. При этом создаются факторы тесселяции ребер и другие константы отдельных участков. Внутри системы может одновременно выполняться множество этапов констант участков. Этап констант участков есть доступ только для чтения ко всем входным и выходным контрольным точкам.

Ниже приведен пример шейдера поверхности:


```
[patchsize(12)]
[patchconstantfunc(MyPatchConstantFunc)]
MyOutPoint main(uint Id : SV_ControlPointID,
     InputPatch<MyInPoint, 12> InPts)
{
     MyOutPoint result;
     
     ...
     
     result = TransformControlPoint( InPts[Id] );

     return result;
}
```



Пример создания шейдера поверхности см. [в разделе как создать поверхности шейдер](direct3d-11-advanced-stages-hull-shader-create.md).

### <a name="tessellator-stage"></a>Стадия тесселяции

Тесселяция — это этап с фиксированной функцией, инициализированный путем привязки шейдера поверхности к конвейеру (см. раздел [как инициализировать этап тесселяции](direct3d-11-advanced-stages-tessellator-initialize.md)). Назначение этапа тесселятора подразделить домен (четырехугольник, треугольник или линию ) на большое число меньших объектов (треугольников, точек или линий). Тесселятор разбивает канонический домен в нормализованной (ноль к единице) системе координат. Например, домен четырехугольника тесселируется в единичный квадрат.

Тесселяция выполняется единожды для каждого участка с использованием факторов тесселяции (указывают тщательность тесселяции домена) и типа секционирования (указывает алгоритм разделения участка на части), переданных с предыдущего этапа шейдера поверхностей. Тесселяция выводит координаты uv (дополнительно — w) и топологию поверхности для этапа шейдера доменов.

На внутреннем уровне тесселяция работает в два этапа:

-   В ходе первой фазы обрабатываются факторы тесселяции, устраняются ошибки округления, обрабатываются очень маленькие факторы, уменьшаются и объединяются факторы, при этом применяется 32-разрядная арифметика с плавающей запятой.
-   На второй фазе формируются списки точек или топологи на основе выбранного типа секционирования. Это основная задача этапа тесселятора, где применяются 16-разрядные дроби с арифметикой фиксированной точки. Арифметику фиксированной точки можно ускорить аппаратно с сохранением допустимый точности. Например, для преобразования шириной 64 метра такая точность позволяет размещать точки с разрешением в 2 мм.



| Тип секционирования | Диапазон                       |
|----------------------|-----------------------------|
| нечетные доли \_      | \[1... 63\]                  |
| частичное \_ четное     | Диапазон Тессфактор: \[ 2.. 64\] |
| Целое число              | Диапазон Тессфактор: \[ 1.. 64\] |
| pow2                 | Диапазон Тессфактор: \[ 1.. 64\] |



 

### <a name="domain-shader-stage"></a>Стадия Domain-Shader

Шейдер домена вычисляет позицию вершины разделенной точки в выходном исправлении. Шейдер домена выполняется один раз для выходной точки тесселяции и имеет доступ только для чтения к выводу UV-координат, выходное исправление поверхности шейдеров и константы выходного исправления поверхности Shader, как показано на следующей схеме.

![схема этапа шейдера доменов](images/d3d11-domain-shader.png)

Ниже перечислены свойства шейдера доменов.

-   Шейдер домена вызывается один раз для каждой координаты вывода на этапе тесселяции.
-   Шейдер домена использует контрольные точки вывода из этапа поверхности-шейдера.
-   Шейдер домена выводит расположение вершины.
-   Входными данными являются выходные данные шейдера поверхности, включая контрольные точки, постоянные данные исправления и факторы тесселяции. Факторы тесселяции могут включать значения, используемые тесселяции фиксированных функций, а также необработанные значения (например, до округления по целочисленной тесселяции), что упрощает геотрансформация, например.

После завершения работы шейдера доменов тесселяция завершается, и данные конвейера переходит к следующему этапу конвейера (шейдер геометрии, шейдер пикселей и т. д.). Шейдер геометрии, ожидающий примитивы со смежностью (например, 6 вершин на треугольник), недействителен при активной тесселяции (это приводит к неопределенному поведению, о чем будет сообщать уровень отладки).

Ниже приведен пример шейдера домена.


```
void main( out    MyDSOutput result, 
           float2 myInputUV : SV_DomainPoint, 
           MyDSInput DSInputs,
           OutputPatch<MyOutPoint, 12> ControlPts, 
           MyTessFactors tessFactors)
{
     ...

     result.Position = EvaluateSurfaceUV(ControlPoints, myInputUV);
}
```



## <a name="apis-for-initializing-tessellation-stages"></a>API для инициализации этапов тесселяции

Тесселяция реализуется с помощью двух новых стадий программируемого шейдера: шейдера поверхности и шейдера доменов. Эти новые этапы шейдера запрограммированы с помощью кода HLSL, определенного в модели шейдера 5. Новые цели шейдера: HS \_ 5 \_ 0 и DS \_ 5 \_ 0. Как и все программируемые этапы шейдера, код для оборудования извлекается из скомпилированных шейдеров, переданных в среду выполнения, когда шейдеры привязаны к конвейеру с помощью таких интерфейсов API, как [**дссетшадер**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-dssetshader) и [**хссетшадер**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-hssetshader). Но сначала шейдер необходимо создать с помощью интерфейсов API, таких как [**креатехуллшадер**](/windows/desktop/api/D3D11/nf-d3d11-id3d11device-createhullshader) и [**креатедомаиншадер**](/windows/desktop/api/D3D11/nf-d3d11-id3d11device-createdomainshader).

Включите тесселяцию, создав шейдер поверхности и привязав его к этапу шейдера поверхности (это автоматически настраивает этап тесселятора). Для формирования финальных позиций вершин из тесселированных преобразований также понадобится создать шейдер доменов и привязать его к этапу шейдера доменов. После включения тесселяции входные данные на этапе ассемблерного ввода должны быть данными исправлений. Это значит, что топология входного ассемблера должна представлять собой топологию постоянного исправления из [**D3D11- \_ примитивной \_ топологии**](/previous-versions/windows/desktop/legacy/ff476189(v=vs.85)) , установленной с [**иасетпримитиветопологи**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-iasetprimitivetopology).

Чтобы отключить тесселяцию, установите для шейдера поверхности и шейдера доменов значение **NULL**. Ни стадия с геометрическим шейдером, ни стадия потокового вывода не могут считывать контрольные точки вывода поверхности или данные исправлений.

-   Новые топологии для этапа входного ассемблера, которые являются расширениями для этого перечисления.

    ```
    enum D3D11_PRIMITIVE_TOPOLOGY
    ```

    

    Топология задается на этапе входного ассемблера с помощью [ **иасетпримитиветопологи**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-iasetprimitivetopology)

-   Разумеется, для новых программируемых стадий шейдера требуется задать другое состояние, чтобы привязать константные буферы, примеры и ресурсы шейдера к соответствующим этапам конвейера. Эти новые методы ID3D11Device реализуются для установки этого состояния.
    -   [**дсжетконстантбуфферс**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-dsgetconstantbuffers)
    -   [**дсжетсамплерс**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-dsgetsamplers)
    -   [**дсжетшадер**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-dsgetshader)
    -   [**дсжетшадерресаурцес**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-dsgetshaderresources)
    -   [**дссетконстантбуфферс**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-dssetconstantbuffers)
    -   [**дссетсамплерс**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-dssetsamplers)
    -   [**дссетшадер**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-dssetshader)
    -   [**дссетшадерресаурцес**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-dssetshaderresources)
    -   [**хсжетконстантбуфферс**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-hsgetconstantbuffers)
    -   [**хсжетшадерресаурцес**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-hsgetshaderresources)
    -   [**хсжетсамплерс**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-hsgetsamplers)
    -   [**хсжетшадер**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-hsgetshader)
    -   [**хссетконстантбуфферс**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-hssetconstantbuffers)
    -   [**хссетсамплерс**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-hssetsamplers)
    -   [**хссетшадер**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-hssetshader)
    -   [**хссетшадерресаурцес**](/windows/desktop/api/D3D11/nf-d3d11-id3d11devicecontext-hssetshaderresources)

## <a name="how-tos"></a>Как:

Документация также содержит примеры инициализации этапов тесселяции.



| Элемент                                                                                                                                                                                                                                                                                           | Описание                                   |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|
| <span id="How_To__Create_a_Hull_Shader"></span><span id="how_to__create_a_hull_shader"></span><span id="HOW_TO__CREATE_A_HULL_SHADER"></span>[Руководство. Создание шейдера поверхности](direct3d-11-advanced-stages-hull-shader-create.md)<br/>                                                     | Создайте шейдер поверхности.<br/>              |
| <span id="How_To__Design_a_Hull_Shader"></span><span id="how_to__design_a_hull_shader"></span><span id="HOW_TO__DESIGN_A_HULL_SHADER"></span>[Руководство. Проектирование шейдера поверхности](direct3d-11-advanced-stages-hull-shader-design.md)<br/>                                                     | Создайте шейдер поверхности.<br/>              |
| <span id="How_To__Initialize_the_Tessellator_Stage"></span><span id="how_to__initialize_the_tessellator_stage"></span><span id="HOW_TO__INITIALIZE_THE_TESSELLATOR_STAGE"></span>[Поэтапное руководство. Инициализация этапа тесселяции](direct3d-11-advanced-stages-tessellator-initialize.md)<br/> | Инициализация этапа тесселяции.<br/> |
| <span id="How_To__Create_a_Domain_Shader"></span><span id="how_to__create_a_domain_shader"></span><span id="HOW_TO__CREATE_A_DOMAIN_SHADER"></span>[Как создать Шейдер доменов](direct3d-11-advanced-stages-domain-shader-create.md)<br/>                                           | Создайте шейдер домена.<br/>            |
| <span id="How_To__Design_a_Domain_Shader"></span><span id="how_to__design_a_domain_shader"></span><span id="HOW_TO__DESIGN_A_DOMAIN_SHADER"></span>[Руководство. Проектирование шейдера доменов](direct3d-11-advanced-stages-domain-shader-design.md)<br/>                                           | Создайте шейдер домена.<br/>            |



 

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Графический конвейер](overviews-direct3d-11-graphics-pipeline.md)
</dt> </dl>

 

