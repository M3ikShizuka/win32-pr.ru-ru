---
title: Включение ускорения видео DirectX
description: Включение ускорения видео DirectX
ms.assetid: 5cb2f564-88e3-4b60-bde3-6ccf69c97c48
keywords:
- Windows Media Format SDK, включение ДКСВА
- Windows Media Format SDK, ускорение видео DirectX (ДКСВА)
- Windows Media Format SDK, ускорение видео
- Расширенный системный формат (ASF), включение ДКСВА
- ASF (Расширенный системный формат), включение ДКСВА
- Расширенный формат систем (ASF), ускорение видео DirectX (ДКСВА)
- ASF (Расширенный системный формат), ускорение видео DirectX (ДКСВА)
- Расширенный системный формат (ASF), ускорение видео
- ASF (Расширенный системный формат), ускорение видео
- Ускорение видео DirectX (ДКСВА), включение
- ДКСВА (ускорение видео DirectX), включение
- Ускорение видео DirectX (ДКСВА), порядок операций
- ДКСВА (ускорение видео DirectX), порядок операций
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 896147fe11b4b7f5fb91d8dc288e616b643bd5ce
ms.sourcegitcommit: 48d1c892045445bcbd0f22bafa2fd3861ffaa6e7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/19/2020
ms.locfileid: "104412487"
---
# <a name="enabling-directx-video-acceleration"></a>Включение ускорения видео DirectX

В этом разделе описано, как включить ускорение видео Microsoft® DirectX® при воспроизведении потокового содержимого в пользовательском проигрывателе.

## <a name="background"></a>Историческая справка

DirectX-ускорение видео (DirectX ва) — это спецификация API для аппаратного ускорения операций декодирования. Он позволяет программным декодерам разгружать определенные ресурсоемкие операции на графическую карту для обработки. Для конечных пользователей это может быть высокоскоростным видео, например воспроизведением полноэкранных DVD-дисков на старых компьютерах, оснащенных графическими картами, совместимыми с DirectX.

Начиная с Windows Media Format SDK серии 9, фильтр оболочки DMO поддерживает DirectX ва. Это означает, что для локального воспроизведения приложения могут использовать фильтр чтения WM ASF для воспроизведения содержимого на основе Windows Media и аппаратное ускорение DirectX, которое будет вызываться автоматически, если графическая карта поддерживает ее. Однако фильтр чтения WM ASF не поддерживает воспроизведение потокового содержимого. Таким образом, если требуется поддержка DirectX ва при воспроизведении потокового содержимого в пользовательском проигрывателе, необходимо использовать альтернативный механизм, который используется проигрывателем Windows Media, начиная с серии Windows Media 9.

Поскольку проигрыватель Windows Media был разработан до разработки фильтров КАСФ, проигрыватель Windows Media имеет собственный фильтр исходного кода на основе пакета SDK Windows Media Format для воспроизведения содержимого на основе Windows Media. Фильтр источников данных WMP Windows Media позволяет передавать распакованные данные непосредственно в модули подготовки аудио и видео. Модуль чтения WM ASF, напротив, предоставляет сжатое содержимое, переданное в объекты мультимедиа DirectX декодера Windows Media (дмос), размещенные внутри оболочки DMO. На следующих диаграммах показаны различия между модулем чтения WM ASF и фильтром источника проигрывателя Windows Media.

![несжатые образцы вывода выходных данных фильтра источника](images/wmp-dxva-graph.png)

![результаты сжатых выборок фильтра источника касф](images/qasf-dxva-graph.png)

Чтобы включить DirectX для потокового содержимого, необходимо создать настраиваемый фильтр исходного кода, подобный показанному на верхней диаграмме. По сути, этот фильтр будет использовать пакет SDK Windows Media Format для создания экземпляра объекта чтения WM, распаковки образцов и отправки их вверх по выходным креплениям. В этом обсуждении предполагается, что фильтр источника уже создан и теперь готов к реализации поддержки DirectX.

Чтобы включить DirectX ва, основная задача фильтра источника заключается в предоставлении модуля подготовки отчетов и декодера WMV с интерфейсами, необходимыми для согласования подключения DirectX. Фильтр источника не участвует в этих согласованиях. После запуска потоковой передачи единственной задачей, связанной с DirectX, которая может выполнять фильтр источника, является изменение меток времени в видеороликах до того, как декодер WMV доставляет их в модуль подготовки видео. Основной причиной этого является предоставление настраиваемого элемента управления временной шкалой, помимо того, что включает стандартные интерфейсы® DirectShow.

Для обеспечения необходимого взаимодействия между пакетом SDK Windows Media Format, фильтром исходного кода проигрывателя, драйвером DMO видеодекодера Windows Media, а также микшером наложения и модулем подготовки видео для микширования определяются три интерфейса. Эти интерфейсы описаны в следующей таблице.



| Интерфейс                                                        | Описание                                                                                                                                                                                        |
|------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [**ивмкодекамвидеоакцелератор**](/previous-versions/windows/desktop/api/wmdxva/nn-wmdxva-iwmcodecamvideoaccelerator) | Предоставляется драйвером DMO декодера Windows Media и вызывается фильтром источника проигрывателя мультимедиа для настройки различных подключений, необходимых для включения DirectX-поддержки при декодировании видеосодержимого Windows Media. |
| [**ивмплайертиместамфук**](/previous-versions/windows/desktop/api/wmdxva/nn-wmdxva-iwmplayertimestamphook)         | Реализовано в исходном фильтре проигрывателя. Он позволяет фильтру изменять метки времени в видеороликах перед их доставкой.                                                 |
| [**ивмреадеракцелератор**](/previous-versions/windows/desktop/api/wmsdkidl/nn-wmsdkidl-iwmreaderaccelerator)             | Реализуется для объекта модуля чтения WM. Он вызывается фильтром источника проигрывателя для получения интерфейсов из декодера DMO.                                                                             |



 

## <a name="order-of-operations-in-directx-vaenabled-playback"></a>Порядок операций в DirectX с поддержкой воспроизведения

В этом разделе описывается общий порядок операций во время выполнения для проигрывателя с поддержкой DirectX и его фильтра источников. В этом разделе рассматриваются следующие компоненты:

-   Сторонний проигрыватель мультимедиа, называемый проигрывателем.
-   Настраиваемый фильтр источника, созданный проигрывателем, который использует пакет SDK Windows Media Format для распаковки содержимого на основе Windows Media.
-   Закрепление вывода видео в исходном фильтре проигрывателя, называемое выходным закреплением.
-   Граф фильтра воспроизведения видео DirectShow, называемый графом.
-   Модуль подготовки видео с микшированием, называемый VMR.
-   Объект асинхронного модуля чтения пакета SDK Windows Media Format, называемый модулем чтения.
-   Объект мультимедиа DirectX декодера Windows Media, называемый декодером DMO.

Порядок операций выглядит следующим образом:

1.  Проигрыватель создает экземпляры исходного фильтра и объекта Reader. Читатель создает видеодекодер DMO и задает для него (сжатый) тип входных данных. Это должно произойти до того, как проигрыватель попытается настроить граф воспроизведения видео, так как пакет SDK и декодер DMO должны быть вовлечены в процесс согласования с графом, а объекты DMO должны иметь формат входных данных на шаге 9.
2.  Проигрыватель вызывает **играфбуилдер:: Render**, предоставляя ему выходной ПИН-код фильтра источника видео. На этом этапе диспетчер графа фильтров DirectShow пытается подключить VMR к фильтру источника видео проигрывателя.
3.  Диспетчер графов фильтров вызывает **Ипин:: Connect** по выходному контакту фильтра источника видео проигрывателя.

Шаги с 4 по 10 происходят в **Ипин:: Connect**.

1.  Фильтр источника получает интерфейс **ивмкодекамвидеоакцелератор** из метода **Ивмреадеракцелератор:: жеткодеЦинтерфаце** средства чтения. Если кодек не поддерживает DirectX ва, вызов **жеткодеЦинтерфаце** может завершиться ошибкой. В этом случае согласование выполняется обычным образом без поддержки DirectX.
2.  Фильтр источника передает указатель **иамвидеоакцелератор** из ПИН-кода, переданного в **Connect** к декодеру DMO через **ивмкодекамвидеоакцелератор:: сетакцелераторинтерфаце**.
3.  Затем фильтр источника делегирует оставшуюся часть операции **Ипин::** Connect методу **Кбасеаутпутпин:: Connect** . Перечисление форматов с помощью пакета SDK продолжается, как и сегодня. Если кодек поддерживает DirectX ва для подключенного содержимого, то в коде DMO сначала отображаются подтипы DirectX ва, до того как поддерживаются типы YUV и RGB. Если доступна поддержка DirectX ва, то шаги с 7 по 11 попытаются выполнить в контексте подтипа DirectX ва. В следующем фрагменте кода показано, как можно опознать мультимедийный подтип носителя DirectX.
    ```C++
    bool IsDXVASubtype( AM_MEDIA_TYPE * pmt )
    {
        // All DXVA types have the same last 3 DWORDs.
        // guidDXVA is the base GUID for all DXVA subtypes.

        GUID guidDXVA = { 0x00000000, 0xa0c7, 0x11d3, { 0xb9,0x84,0x00,0xc0,0x4f,0x2e,0x73,0xc5 } };

        unsigned long const * plguid;
        unsigned long const * plguidDXVA;
        plguid = (unsigned long const *)&pmt->subtype;
        plguidDXVA = (unsigned long *)&guidDXVA;

        if( ( plguid[1] == plguidDXVA[1] ) &&
            ( plguid[2] == plguidDXVA[2] ) &&
            ( plguid[3] == plguidDXVA[3] ) )
        {
            return true;
        }

        return false;
    }
    
    ```

    

4.  Реализация **кбасеаутпутпин:: Connect** вызывает **Ипин:: комплетеконнект** во время шага 3. Если подтипы DirectX ва рассматриваются, выполняется согласование DirectX. Выходной ПИН-код вызывает **ивмкодекамвидеоакцелератор:: неготиатеконнектион**, передавая ему текущий тип выходного носителя.
5.  Декодер DMO выполняет необходимое согласование с VMR через интерфейс **иамвидеоакцелератор** и возвращает идентификатор GUID подтипа видео, для которого согласованы два. Закрепление вывода делегирует все вызовы **иамвидеоакцелераторнотифи** , полученные во время этого процесса, в интерфейс **ИАМВИДЕОАКЦЕЛЕРАТОРНОТИФИ** декодера DMO, который также можно получить с помощью метода **ивмреадеракцелератор:: жеткодеЦинтерфаце** .
6.  Если **неготиатеконнектион** , то выходной ПИН-код вызывает **Ивмкодекамвидеоакцелератор:: сетплайернотифи** с интерфейсом **ивмплайертиместамфук** . Этот обработчик позволяет исходному фильтру обновлять отметки времени в примерах перед их передачей в модуль подготовки отчетов.
7.  Фильтр источника вызывает **ивмреадеракцелератор:: notify** с согласованным типом носителя. Это позволяет модулю чтения обновлять свои внутренние переменные и фиксировать в DirectX ва. Это Последнее место, в котором кодек или модуль чтения могут завершиться ошибкой. Если какой либо из указанных выше шагов завершится ошибкой, фильтр источника должен вернуться к шагу 3 и попробовать следующий тип, перечисленный модулем чтения.
8.  Начинается воспроизведение. Модуль чтения пропускает выходные буферы из декодера DMO, если тип выходных данных соединения — DirectX ва.
9.  Когда происходит **Ипин::D** , фильтр источника вызывает **Ивмкодекамвидеоакцелератор:: Сетакцелераторинтерфаце** со **значением NULL**. Это нарушает подключение DirectX о связи между кодеком и модулем подготовки.

## <a name="related-topics"></a>См. также

<dl> <dt>

[**Чтение файлов ASF**](reading-asf-files.md)
</dt> </dl>

 

 




