---
title: Обработка событий приобретения лицензий
description: Обработка событий приобретения лицензий
ms.assetid: e118bf09-1fa6-41b6-a6bb-3e8cb6097994
keywords:
- Пакет SDK для Windows Media Format, обработка событий приобретения лицензий
- Пакет SDK для Windows Media Format, события приобретения лицензий
- Расширенный системный формат (ASF), обработка событий приобретения лицензий
- ASF (Расширенный системный формат), обработка событий приобретения лицензий
- Расширенный формат систем (ASF), события приобретения лицензий
- ASF (Расширенный системный формат), события приобретения лицензий
- Управление цифровыми правами (DRM), обработка событий приобретения лицензий
- DRM (Управление цифровыми правами), обработка событий приобретения лицензий
- Управление цифровыми правами (DRM), события приобретения лицензий
- DRM (Управление цифровыми правами), события приобретения лицензий
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d5e31fd5b108f41d5b0925918fdf1c83764bcf7e
ms.sourcegitcommit: 48d1c892045445bcbd0f22bafa2fd3861ffaa6e7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/19/2020
ms.locfileid: "104412525"
---
# <a name="handling-license-acquisition-events"></a>Обработка событий приобретения лицензий

Приложение чтения с поддержкой DRM, в методе обратного вызова [**ивмстатускаллбакк:: OnStatus**](/previous-versions/windows/desktop/api/Wmsdkidl/nf-wmsdkidl-iwmstatuscallback-onstatus) , обрабатывает следующие четыре события, связанные с процессом получения лицензии:

-   **\_ \_ состояние подписи LICENSEURL \_ ВМТ**
-   **ВМТ \_ без \_ прав**
-   **ВМТ \_ без \_ прав \_**
-   **ВМТ \_ получить \_ лицензию**

**\_ \_ состояние подписи LICENSEURL \_ ВМТ**

Когда компонент DRM обнаруживает содержимое, защищенное DRM версии 7, сначала выполняется поиск действительной лицензии на локальную систему. Если он не существует, он оценивает URL-адрес приобретения лицензии в заголовке DRM файла и отправляет событие **\_ \_ \_ состояния подписи ВМТ LICENSEURL** с параметром *pValue* , имеющим одно из [**значений \_ \_ доверия ВМТ дрмла**](/previous-versions/windows/desktop/api/wmsdkidl/ne-wmsdkidl-wmt_drmla_trust) , указывая, является ли URL-адрес доверенным, недоверенным или незаконным. Если URL-адрес не является доверенным, приложение должно предупредить пользователя. Если URL-адрес был изменен, файл следует считать поврежденным, а приложение не должно переходить по URL-адресу без выдачи строгого предупреждения пользователю.

**ВМТ \_ без \_ прав**

Событие **ВМТ \_ No \_ Rights** отправляется только для содержимого DRM версии 1. Это означает, что лицензия должна быть получена не в автоматическом режиме. Иными словами, пользователь должен переходить на веб-страницу, чтобы получить лицензию. URL-адрес страницы извлекается в виде строки расширенных символов, заканчивающихся нулем, из параметра *pValue* в методе **OnStatus** .

При необходимости приложение может упростить переход на веб-страницу пользователя, открыв Internet Explorer в отдельном процессе или в другом месте, разместив элемент управления веб-браузера. Однако это не является обязательным. По крайней мере, приложение может просто отобразить URL-адрес пользователя в окне сообщения и предложить ему вставить его в адресную строку Internet Explorer. В примере Audioplayer показана правильная обработка события **ВМТ \_ No \_ Rights** , включая форматирование строки URL-адреса и использование метода **CreateProcess** для открытия Internet Explorer и перехода по указанному URL-адресу.

Так как приложение не может узнать, когда была получена лицензия DRM версии 1, пользователю будет предпринята попытка открыть файл еще раз после получения лицензии.

Этот же процесс приобретения лицензий с неавтоматической лицензией также можно использовать для лицензий версии 7, но в этом случае приложение может сначала вызвать [**ивмдрмреадер:: мониторлиценсеаккуиситион**](/previous-versions/windows/desktop/api/Wmsdkidl/nf-wmsdkidl-iwmdrmreader-monitorlicenseacquisition). Этот метод приведет к многократной проверке локального хранилища лицензий до тех пор, пока не будет найдена лицензия для нового файла. На этом этапе приложение получит событие **\_ \_ лицензии ВМТ** . Для всех лицензий версии 7 рекомендуется, чтобы приложения предоставляющих пользователям возможность получать лицензии автоматически или без уведомления.

**ВМТ \_ без \_ прав \_**

Событие **\_ \_ \_ ex ВМТ без прав** указывает на то, что содержимое защищено с помощью DRM версии 7, поэтому процесс приобретения лицензий может выполняться либо без уведомления, либо без вмешательства пользователя. Как правило, для конечных пользователей удобнее использовать автоматическое получение лицензий, хотя некоторые пользователи предпочитают получать все лицензии без вмешательства пользователя. Когда при получении лицензии пользователь должен отправить оплату или персональные данные, этот процесс всегда следует выполнять без уведомления. Неавтоматическое получение лицензий описано выше в разделе **ВМТ \_ No \_ Rights** . Автоматическое приобретение продолжается следующим образом:

1.  Приведите параметр *pValue* к структуре [**\_ данных для \_ получения \_ лицензии WM**](wm-get-license-data.md) и сохраните структуру в том случае, если она понадобится позже для приобретения лицензий без участия пользователя.
2.  Вызовите **QueryInterface** для объекта Reader, чтобы получить интерфейс [**ивмдрмреадер**](/previous-versions/windows/desktop/api/wmsdkidl/nn-wmsdkidl-iwmdrmreader) .
3.  Вызовите [**ивмдрмреадер:: AcquireLicense**](/previous-versions/windows/desktop/api/Wmsdkidl/nf-wmsdkidl-iwmdrmreader-acquirelicense) и укажите 0x1 в параметре *dwFlags* , чтобы указать на автоматическое получение языка. Это асинхронный вызов, который возвращает немедленно.
4.  Дождитесь события **ВМТ \_ получения \_ лицензии** .

**ВМТ \_ получить \_ лицензию**

Событие **ВМТ \_ получения \_ лицензии** отправляется после завершения процесса получения лицензии для лицензии DRM версии 7. [**Ивмдрмреадер:: AcquireLicense**](/previous-versions/windows/desktop/api/Wmsdkidl/nf-wmsdkidl-iwmdrmreader-acquirelicense) вызывает отправку этого события для автоматического получения сообщений, а [**мониторлиценсеаккуиситион**](/previous-versions/windows/desktop/api/Wmsdkidl/nf-wmsdkidl-iwmdrmreader-monitorlicenseacquisition) приводит к его отправке для неавтоматических приобретений. В обработчике событий приведите параметр *pValue* к указателю на [**структуру \_ \_ \_ данных для получения лицензии WM**](wm-get-license-data.md) и изучите элемент **HR** , чтобы определить, успешно ли получена лицензия. Если **HR** равен NS \_ E \_ DRM \_ без \_ прав, это означает, что лицензия должна быть получена без уведомления. Приложения должны позволять пользователям отменять процесс приобретения лицензий в любое время. Это делается путем вызова [**ивмдрмреадер:: канцеллиценсеаккуиситион**](/previous-versions/windows/desktop/api/Wmsdkidl/nf-wmsdkidl-iwmdrmreader-cancellicenseacquisition). При вызове этого метода будет отправлено событие **ВМТ \_ получения \_ лицензии** со значением **HRESULT** , \_ \_ полученным в результате \_ отмены запроса DRM S \_ .

Если **HR** имеет значение \_ \_ \_ получена лицензия DRM NS, то лицензия была получена, \_ и приложение может попытаться воспроизвести файл или скопировать его на устройство или выполнить любое действие, для которого ему были запрошены права.

В Windows XP появился новый код ошибки: нотаккуиред лицензия на NS \_ E \_ DRM \_ \_ . Этот код ошибки генерируется всякий раз, когда компоненты среды выполнения Windows Media в Windows XP не могут получить лицензию во время неудачного или неавтоматического получения лицензии. На других платформах \_ \_ \_ \_ сообщение об ошибке хранилища лицензий NS E DRM \_ обычно возвращается при сбое приобретения лицензии. Новый код ошибки предназначен для различения сбоев при получении лицензий от других условий сбоя, когда \_ \_ \_ \_ \_ создается сообщение об ошибке хранилища лицензий управления цифровыми правами (DRM).

Рекомендуемый способ устранения этих ошибок при возвращении после нежелательной попытки приобретения лицензии показан в следующем фрагменте кода:


```C++
if( hrStatus == NS_E_DRM_LICENSE_NOTACQUIRED || 
    hrStatus == NS_E_DRM_LICENSE_STORE_ERROR )
{
  // Attempt non-silent license acquisition.
}
else if( hrStatus == NS_E_DRM_NEEDS_INDIVIDUALIZATION )
{
  // Individualize and then retry.
}
else if( FAILED(hrStatus) )
{
  // Display a helpful error message.
}
else
{
  // Success. Play content.
}
```



> [!Note]  
> DRM не поддерживает версию этого пакета SDK на базе x64.

 

## <a name="related-topics"></a>См. также

<dl> <dt>

[**Чтение защищенных файлов**](reading-protected-files.md)
</dt> </dl>

 

 




