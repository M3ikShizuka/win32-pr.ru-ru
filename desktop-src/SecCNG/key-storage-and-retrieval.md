---
description: CNG предоставляет модель для хранения закрытых ключей, которая позволяет адаптироваться к текущим и будущим потребностям создания приложений, использующих криптографические функции, такие как шифрование с открытым или закрытым ключом, а также требования к хранению материала ключа.
ms.assetid: 95e5750f-fdc5-41f3-a4ce-9593a7081e95
title: ключевые служба хранилища и извлечение
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e81b2100f005f0ff293e34a3f4c0a7460b7a4d4e9c2b15fbe0b3577b5e52394a
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118907693"
---
# <a name="key-storage-and-retrieval"></a>ключевые служба хранилища и извлечение

-   [архитектура основных служба хранилища](#key-storage-architecture)
-   [Типы ключей](#key-types)
-   [Поддерживаемые алгоритмы](#supported-algorithms)
-   [Ключевые каталоги и файлы](#key-directories-and-files)

## <a name="key-storage-architecture"></a>архитектура основных служба хранилища

CNG предоставляет модель для хранения закрытых ключей, которая позволяет адаптироваться к текущим и будущим потребностям создания приложений, использующих криптографические функции, такие как шифрование с открытым или закрытым ключом, а также требования к хранению материала ключа. Основной подпрограммы в этой модели является маршрутизатор хранилища ключей и реализован в Ncrypt.dll. Приложение обращается к поставщикам хранилища ключей (KSP) в системе через маршрутизатор хранилища ключей, который скрывает сведения, такие как изоляция ключей, от приложения и самого поставщика хранилища. На следующем рисунке показана структура и функция архитектуры изоляции ключей CNG.

![поставщик хранилища ключей CNG](images/cng-key-storage-provider.png)

Чтобы обеспечить соответствие требованиям общих критериев (CC), долгосрочные ключи должны быть изолированы, чтобы они никогда не присутствовали в процессе приложения. в настоящее время CNG поддерживает хранение асимметричных закрытых ключей с помощью KSP программного обеспечения майкрософт, который входит в состав Windows Server 2008 и Windows Vista и устанавливается по умолчанию.

изоляция ключей включена по умолчанию в Windows Server 2008 и Windows Vista. Функция изоляции ключей недоступна на платформах, предшествовавших этих. Кроме того, сторонние KSP не загружаются в службу изоляции ключей (LSA Process). В службу изоляции ключей загружается только KSP Майкрософт.

Процесс LSA используется в качестве изоляции ключей для повышения производительности. Все права доступа к закрытым ключам проходят через маршрутизатор хранилища ключей, который предоставляет исчерпывающий набор функций для управления и использования закрытых ключей.

CNG сохраняет открытую часть хранимого ключа отдельно от закрытой части. Открытая часть пары ключей также поддерживается в службе изоляции ключей и доступна с помощью локального удаленного вызова процедур (ЛРПК). Маршрутизатор хранилища ключей использует ЛРПК при вызове процесса изоляции ключей. Все права доступа к закрытым ключам проходят через маршрутизатор закрытого ключа и проходят аудит с помощью CNG.

Как описано выше, можно поддерживать широкий спектр устройств хранения оборудования. В каждом случае интерфейс для всех этих устройств хранения идентичен. Она включает функции для выполнения различных операций с закрытым ключом, а также функции, относящиеся к хранению и управлению ключами.

CNG предоставляет набор интерфейсов API, которые используются для создания, хранения и извлечения криптографических ключей. список этих api-интерфейсов см. в разделе [CNG Key служба хранилища functions](cng-key-storage-functions.md).

## <a name="key-types"></a>Типы ключей

CNG поддерживает следующие типы ключей:

-   Diffie-Hellman открытые и закрытые ключи.
-   Открытый и закрытый ключи алгоритма цифровых подписей (DSA, FIPS 186-2).
-   \#Открытые и закрытые ключи RSA (PKCS 1).
-   Несколько устаревших открытых и закрытых ключей CryptoAPI.
-   Открытые и закрытые ключи шифрования на основе эллиптических кривых.

## <a name="supported-algorithms"></a>Поддерживаемые алгоритмы

CNG поддерживает следующие алгоритмы ключей.

| Алгоритм | Длина ключа или хэша (бит)             |
|-----------|------------------------------------|
| RSA       | от 512 до 16384, с шагом в 64 бит |
| ХЕЛМАНА        | от 512 до 16384, с шагом в 64 бит |
| DSA       | от 512 до 1024, с шагом в 64 бит  |
| ECDSA     | P-256, P-384, P-521 (NIST)  |
| ECDH      | P-256, P-384, P-521 (NIST)  |
| MD2       | 128                                |
| MD4       | 128                                |
| MD5       | 128                                |
| SHA-1     | 160                                |
| SHA-256   | 256                                |
| SHA-384   | 384                                |
| SHA-512   | 512                                |



 

## <a name="key-directories-and-files"></a>Ключевые каталоги и файлы

В службах Microsoft Legacy CryptoAPI CSP хранятся закрытые ключи в следующих каталогах.

| Тип ключа                | Каталоги                                                                                                                                                 |
|-------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Частный пользователь            | % APPDATA% \\ \\ \\ \\ *идентификатор безопасности пользователя* Microsoft Crypto RSA\\<br/>% APPDATA% \\ \\ \\ \\ *идентификатор безопасности пользователя* Microsoft Crypto DSS\\<br/>                                                   |
| Частная локальная система    | % ALLUSERSPROFILE% \\ Application Data \\ \\ \\ RSA \\ S-1-5-18\\<br/>% ALLUSERSPROFILE% \\ данных приложений \\ Microsoft \\ Crypto \\ DSS \\ S — 1-5-18\\<br/>   |
| Частная локальная служба   | % ALLUSERSPROFILE% \\ Application Data \\ \\ \\ RSA \\ S-1-5-19\\<br/>% ALLUSERSPROFILE% \\ данных приложений \\ Microsoft \\ Crypto \\ DSS \\ S — 1-5-19\\<br/>   |
| Частная сетевая служба | % ALLUSERSPROFILE% \\ Application Data \\ \\ \\ RSA \\ S-1-5-20\\<br/>% ALLUSERSPROFILE% \\ данных приложений \\ Microsoft \\ Crypto \\ DSS \\ S — 1-5-20\\<br/>   |
| Общий закрытый          | % ALLUSERSPROFILE% \\ данных приложений \\ Microsoft \\ Crypto \\ RSA \\ MachineKeys<br/>% ALLUSERSPROFILE% \\ данных приложений \\ Microsoft \\ Crypto \\ DSS \\ MachineKeys<br/> |



 

CNG хранит закрытые ключи в следующих каталогах.

| Тип ключа                | Каталог                                                          |
|-------------------------|--------------------------------------------------------------------|
| Частный пользователь            | % APPDATA% \\ \\ криптографические \\ ключи Майкрософт                                 |
| Частная локальная система    | % ALLUSERSPROFILE% \\ Application Data \\ Майкрософт \\ \\ системкэйс |
| Частная локальная служба   | % WINDIR% \\ сервицепрофилес \\ LocalService                            |
| Частная сетевая служба | % WINDIR% \\ сервицепрофилес \\ NetworkService                          |
| Общий закрытый          | % ALLUSERSPROFILE% \\ Application Data \\ \\ ключи шифрования \\ Майкрософт       |



 

Ниже приведены некоторые различия между контейнерами CryptoAPI и CNG.

-   CNG использует разные имена файлов ключей по сравнению с файлами ключей, созданными Rsaenh.dll и Dssenh.dll устаревших CSP. Устаревшие файлы ключей также имеют расширение. key, но файлы ключей CNG не имеют расширения. key.
-   CNG полностью поддерживает имена контейнеров ключей Юникода. CNG использует хэш имени контейнера в Юникоде, тогда как CryptoAPI использует хэш имени контейнера в формате ANSI.
-   CNG является более гибкой с точки зрения пар ключей RSA. Например, CNG поддерживает общедоступные экспоненты размером более 32 бит и поддерживает ключи, в которых p и q имеют разную длину.
-   В CryptoAPI файл контейнера ключей хранится в каталоге, имя которого является текстовым эквивалентом идентификатора безопасности пользователя. Это больше не так в CNG, что устраняет трудности при перемещении пользователей из одного домена в другой без потери их закрытых ключей.
-   Имя поставщика хранилища CNG и имена ключей ограничены **максимальным числом \_** символов Юникода. Имя поставщика службы CryptoAPI и имена ключей ограничены **максимальным числом \_** символов ANSI.
-   CNG предлагает возможности определяемых пользователем ключевых свойств. Пользователи могут создавать и связывать пользовательские свойства с ключами и хранить их с постоянными ключами.

При сохранении ключа CNG может создать два файла. Первый файл содержит закрытый ключ в новом формате CNG и всегда создается. Этот файл не может использоваться устаревшими CSP CryptoAPI. Второй файл содержит тот же закрытый ключ в старом контейнере ключей CryptoAPI. Второй файл соответствует формату и расположению, используемому Rsaenh.dll. Создание второго файла происходит только в том случае, если при вызове функции [**нкриптфинализекэй**](/windows/desktop/api/Ncrypt/nf-ncrypt-ncryptfinalizekey) для завершения ключа RSA был задан флаг **NCRYPT \_ записи \_ в флаг \_ \_ \_ \_ отметки хранилища прежних версий** . Эта функция не поддерживается для ключей DSA и DH.

Когда приложение пытается открыть существующий постоянный ключ, CNG сначала пытается открыть собственный файл CNG. Если этот файл не существует, CNG пытается нахождение совпадающего ключа в устаревшем контейнере ключей CryptoAPI.

при перемещении или копировании ключей CryptoAPI с исходного компьютера на целевой компьютер с помощью средство миграции пользовательской среды Windows (USMT) CNG не сможет получить доступ к ключам на целевом компьютере. Для доступа к таким переносимым ключам необходимо использовать интерфейс CryptoAPI.

 

 




